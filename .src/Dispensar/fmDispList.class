' Gambas class file

Private $xStatus As String
Private $FieldList As String[]
Private $rData1 As Result
Private $aMyFields1 As String[]

Private $rData2 As Result
Private $aMyFields2 As String[]
Private $encid As String

Private $RestrictType As String
Private $RestrictList As String[]

Private $HiCappingVar As Collection
Private $HiCapAPIView As Variant[]

Public Sub _new(xStatus As String)

  Dim xoption As String
  Dim xregimen As String

  $xStatus = xStatus

  $RestrictType = modGlobalSetting.ShowSettingFromDB("IPClinic/MedOrderVisibility")
  $RestrictList = modGlobalSetting.GetDBTableList("IPClinic/MedOrderVisibility")
  If modHelpVariable.$LogInCategory = "Clinician" Then
    rbinpat.Value = True
    WebContainer5.Enabled = False
  Else
    ShowInputForm()
  Endif
  modSettings.ShowCheckBox(chkprintlabel, "DispensingList/PrintLabel")
  ShowDepartList()
  cmbdepart.Text = ""
  dtselected.Value = Now()

  xregimen = modSettings.ShowSettingFromFIle("ShowRegimen/DispensingList")
  If xregimen = "Yes" Then
    chkregimen.Value = True
  Else If xregimen = "No" Then
    chkregimen.Value = False
  Endif
  xoption = modSettings.ShowSettingFromFIle("EntrySetting/Pharmacy_DateSelect")
  If xoption = "Yes" Then
    chkdate.Value = True
  Else If xoption = "No" Then
    chkdate.Value = False
  Endif
  rbencid.Value = True
  chkselall.Value = True

  DateSelectionSett()
  If $xStatus = "Requested" Then
    rbencid.Value = True
    rbencid.Enabled = False
    rbinvoice.Enabled = False
  Else If $xStatus = "Dispensed" Then
    mnuremove.Visible = False
  Endif
  txtsearch.SetFocus

End

Public Sub chkdate_Click()

  modSettings.EnterCheckSetting(chkdate, "EntrySetting/Pharmacy_DateSelect")
  DateSelectionSett()

End

Private Sub DateSelectionSett()

  If chkdate.Value = True Then
    Panel13.Enabled = True
  Else
    Panel13.Enabled = False
  Endif

End

Private Sub ShowInputForm()

  Dim xx As String

  xx = modSettings.ShowSettingFromFIle("DispensingList/Department")
  If xx = "InPatient" Then
    rbinpat.Value = True
  Else If xx = "Discharged" Then
    rbexited.Value = True
  Else
    rboutpat.Value = True
  Endif

End

Private Sub ShowDepartList()

  If modBasic.$FixedDepartment Then
    cmbdepart.Text = modBasic.$FixedDepartment
    If modBasic.$LockToOwnDepart = "Yes" Then
      cmbdepart.Enabled = False
    Endif
  Else
    If rboutpat.Value = True Then
      cmbdepart.List = modGeneral.GetDepartmentsForOPDBoth()
      cmbdepart.Text = ""
    Else If rbinpat.Value = True Then
      cmbdepart.List = modGeneral.GetDepartmentAllList("Patient Ward")
    Else If rbexited.Value = True Then
      cmbdepart.List = modGeneral.GetDepartmentAllList("Patient Ward")
    Endif
  Endif

End

Public Sub rboutpat_Click()

  modSettings.SaveSettingsToFile("DispensingList/Department", "OutPatient")
  ShowDepartList()

End

Public Sub rbinpat_Click()

  modSettings.SaveSettingsToFile("DispensingList/Department", "InPatient")
  ShowDepartList()

End

Public Sub rbexited_Click()

  modSettings.SaveSettingsToFile("DispensingList/Department", "Discharged")
  ShowDepartList()

End

Public Sub btnrefresh_Click()

  GridView2.Clear()
  GridView1.Clear()
  If rbencid.Value = True Then
    FillEncList("")
  Else If rbinvoice.Value = True Then
    FillInvoiceList("")
  Endif

End

Public Sub btnseartext_Click()

  Dim enc As String
  Dim xinv As String

  txtindex.Text = ""
  If rbencid.Value = True Then
    If chkpatno.Value = True Then
      enc = modPatient.GetLastEncoutnerFromPatNo(Trim(txtsearch.Text))
    Else
      enc = Trim(txtsearch.Text)
    Endif
    If enc Then
      FillEncList(Trim(enc))
      txtindex.Text = Trim(enc)
      $encid = Trim(enc)
      GetPatientProfile($encid)
      FillDispenstable(txtindex.Text)
    Endif
  Else If rbinvoice.Value = True Then
    xinv = Trim(txtsearch.Text)
    If xinv Then
      FillInvoiceList(Trim(xinv))
      txtindex.Text = Trim(xinv)
      $encid = modNonMedical.GetEncounterFromBillNo(Trim(xinv))
      GetPatientProfile($encid)
      FillDispenstable(txtindex.Text)
    Endif
  Endif

End

Private Sub FillEncList(xencid As String)

  Dim xstate As Boolean
  Dim xsql As String
  Dim strItem As String[] = ["Discharged", "LAMA", "Death", "Refer", "Absconder"]
  Dim i As Integer

  For i = 0 To strItem.Count - 1
    strItem[i] = "'" & strItem[i] & "'"
  Next

  If $xStatus = "Dispensed" Then
    xstate = True
  Else If $xStatus = "Requested" Then
    xstate = False
  Endif
  If cmbdepart.Text Then
    If rboutpat.Value = True Then
      xsql = db.Subst(" and fldencounterval in(select fldencounterval from tblencounter where fldcurrlocat like &1)", cmbdepart.Text)
    Else If rbinpat.Value = True Then
      xsql = db.Subst(" and fldencounterval in(select fldencounterval from tblencounter where fldcurrlocat in(select fldbed from tbldepartmentbed where flddept like &1))", cmbdepart.Text)
    Else If rbexited.Value = True Then
      xsql = db.Subst(" and fldencounterval in(select fldencounterval from tblencounter where fldcurrlocat in(select fldbed from tbldepartmentbed where flddept like &1))", cmbdepart.Text)
    Endif
  Else
    xsql = ""
  Endif

  $FieldList = ["fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval"]
  If chkdate.Value = True Then
    If Not xencid Then
      If rboutpat.Value = True Then
        $rData1 = modDatabase.$myConn.Exec("select " & $FieldList.Join(",") & " from tblpatdosing where flditemtype like &1 and fldlevel=&2 and fldcurval=&3 and fldstatus=&4 and fldqtydisp>&5 and fldtime_order>=&6 and fldtime_order<=&7 and fldsave_order=&8" & xsql & " GROUP BY fldencounterval", "%", "Requested", "Continue", "Registered", 0, modDate.StartSqlDate(dtselected.Value), modDate.EndSqlDate(DateAdd(dtselected.Value, gb.Day, txtdtrange.Value)), xstate)                                          ''
      Else If rbinpat.Value = True Then
        $rData1 = modDatabase.$myConn.Exec("select " & $FieldList.Join(",") & " from tblpatdosing where flditemtype like &1 and fldlevel=&2 and fldcurval=&3 and fldstatus=&4 and fldqtydisp>&5 and fldtime_order>=&6 and fldtime_order<=&7 and fldsave_order=&8" & xsql & " GROUP BY fldencounterval", "%", "Requested", "Continue", "Admitted", 0, modDate.StartSqlDate(dtselected.Value), modDate.EndSqlDate(DateAdd(dtselected.Value, gb.Day, txtdtrange.Value)), xstate)                                          ''
      Else If rbexited.Value = True Then
        $rData1 = modDatabase.$myConn.Exec("select " & $FieldList.Join(",") & " from tblpatdosing where flditemtype like &1 and fldlevel=&2 and fldcurval=&3 and fldstatus in(" & strItem.Join(",") & ") and fldqtydisp>&5 and fldtime_order>=&6 and fldtime_order<=&7 and fldsave_order=&8" & xsql & " GROUP BY fldencounterval", "%", "Requested", "Continue", "Admitted", 0, modDate.StartSqlDate(dtselected.Value), modDate.EndSqlDate(DateAdd(dtselected.Value, gb.Day, txtdtrange.Value)), xstate)
      Endif
    Else
      $rData1 = modDatabase.$myConn.Exec("select " & $FieldList.Join(",") & " from tblpatdosing where flditemtype like &1 and fldlevel=&2 and fldencounterval like &3 and fldcurval=&4 and fldqtydisp>&5 and fldtime_order>=&6 and fldtime_order<=&7 and fldsave_order=&8 GROUP BY fldencounterval", "%", "Requested", xencid, "Continue", 0, modDate.StartSqlDate(dtselected.Value), modDate.EndSqlDate(DateAdd(dtselected.Value, gb.Day, txtdtrange.Value)), xstate)                                          ''
    Endif
  Else
    If modBasic.$SQLDateRange = "Disable" Then
      If Not xencid Then
        If rboutpat.Value = True Then
          $rData1 = modDatabase.$myConn.Exec("select " & $FieldList.Join(",") & " from tblpatdosing where flditemtype like &1 and fldlevel=&2 and fldcurval=&3 and fldstatus=&4 and fldqtydisp>&5 and fldsave_order=&6" & xsql & " GROUP BY fldencounterval", "%", "Requested", "Continue", "Registered", 0, xstate)                                          ''
        Else If rbinpat.Value = True Then
          $rData1 = modDatabase.$myConn.Exec("select " & $FieldList.Join(",") & " from tblpatdosing where flditemtype like &1 and fldlevel=&2 and fldcurval=&3 and fldstatus=&4 and fldqtydisp>&5 and fldsave_order=&6" & xsql & " GROUP BY fldencounterval", "%", "Requested", "Continue", "Admitted", 0, xstate)                                          ''
        Else If rbexited.Value = True Then
          $rData1 = modDatabase.$myConn.Exec("select " & $FieldList.Join(",") & " from tblpatdosing where flditemtype like &1 and fldlevel=&2 and fldcurval=&3 and fldstatus in(" & strItem.Join(",") & ") and fldqtydisp>&5 and fldsave_order=&6" & xsql & " GROUP BY fldencounterval", "%", "Requested", "Continue", "Admitted", 0, xstate)
        Endif
      Else
        $rData1 = modDatabase.$myConn.Exec("select " & $FieldList.Join(",") & " from tblpatdosing where flditemtype like &1 and fldlevel=&2 and fldencounterval like &3 and fldcurval=&4 and fldqtydisp>&5 and fldsave_order=&6 GROUP BY fldencounterval", "%", "Requested", xencid, "Continue", 0, xstate)                                          ''
      Endif
    Else
      If Not xencid Then
        If rboutpat.Value = True Then
          $rData1 = modDatabase.$myConn.Exec("select " & $FieldList.Join(",") & " from tblpatdosing where flditemtype like &1 and fldlevel=&2 and fldcurval=&3 and fldstatus=&4 and fldqtydisp>&5 and fldtime_order>=&6 and fldtime_order<=&7 and fldsave_order=&8" & xsql & " GROUP BY fldencounterval", "%", "Requested", "Continue", "Registered", 0, modDate.StartSqlDate(DateAdd(dtselected.Value, gb.Day, 0 - 365)), modDate.EndSqlDate(dtselected.Value), xstate)                                          ''
        Else If rbinpat.Value = True Then
          $rData1 = modDatabase.$myConn.Exec("select " & $FieldList.Join(",") & " from tblpatdosing where flditemtype like &1 and fldlevel=&2 and fldcurval=&3 and fldstatus=&4 and fldqtydisp>&5 and fldtime_order>=&6 and fldtime_order<=&7 and fldsave_order=&8" & xsql & " GROUP BY fldencounterval", "%", "Requested", "Continue", "Admitted", 0, modDate.StartSqlDate(DateAdd(dtselected.Value, gb.Day, 0 - 365)), modDate.EndSqlDate(dtselected.Value), xstate)                                          ''
        Else If rbexited.Value = True Then
          $rData1 = modDatabase.$myConn.Exec("select " & $FieldList.Join(",") & " from tblpatdosing where flditemtype like &1 and fldlevel=&2 and fldcurval=&3 and fldstatus in(" & strItem.Join(",") & ") and fldqtydisp>&5 and fldtime_order>=&6 and fldtime_order<=&7 and fldsave_order=&8" & xsql & " GROUP BY fldencounterval", "%", "Requested", "Continue", "Admitted", 0, modDate.StartSqlDate(DateAdd(dtselected.Value, gb.Day, 0 - 365)), modDate.EndSqlDate(dtselected.Value), xstate)
        Endif
      Else
        $rData1 = modDatabase.$myConn.Exec("select " & $FieldList.Join(",") & " from tblpatdosing where flditemtype like &1 and fldlevel=&2 and fldencounterval like &3 and fldcurval=&4 and fldqtydisp>&5 and fldtime_order>=&6 and fldtime_order<=&7 and fldsave_order=&8 GROUP BY fldencounterval", "%", "Requested", xencid, "Continue", 0, modDate.StartSqlDate(DateAdd(dtselected.Value, gb.Day, 0 - 365)), modDate.EndSqlDate(dtselected.Value), xstate)                                          ''
      Endif
    Endif
  Endif

  $aMyFields1 = New String[]
  modGridView.ReadSmallData(GridView1, $rData1, $aMyFields1)

  With GridView1
    .Columns[0].Width = CStr(100 * modBasic.$AppWidthRatio) & "px"
    .Columns[1].Width = CStr(125 * modBasic.$AppWidthRatio) & "px"
    .Columns[2].Width = CStr(175 * modBasic.$AppWidthRatio) & "px"
    .Columns[3].Hidden = True

    .Columns[0].Text = "Location"
    .Columns[1].Text = "Encounter"
    .Columns[2].Text = "Patient Name"
  End With

End

Private Sub FillInvoiceList(invno As String)

  Dim xstate As Boolean
  Dim xsql As String
  Dim strItem As String[] = ["Discharged", "LAMA", "Death", "Refer", "Absconder"]
  Dim i As Integer

  For i = 0 To strItem.Count - 1
    strItem[i] = "'" & strItem[i] & "'"
  Next

  If $xStatus = "Dispensed" Then
    xstate = True
  Else If $xStatus = "Requested" Then
    xstate = False
  Endif

  If cmbdepart.Text Then
    If rboutpat.Value = True Then
      xsql = db.Subst(" and tblpatdosing.fldencounterval in(select fldencounterval from tblencounter where fldcurrlocat like &1)", cmbdepart.Text)
    Else If rbinpat.Value = True Then
      xsql = db.Subst(" and tblpatdosing.fldencounterval in(select fldencounterval from tblencounter where fldcurrlocat in(select fldbed from tbldepartmentbed where flddept like &1))", cmbdepart.Text)
    Else If rbexited.Value = True Then
      xsql = db.Subst(" and tblpatdosing.fldencounterval in(select fldencounterval from tblencounter where fldcurrlocat in(select fldbed from tbldepartmentbed where flddept like &1))", cmbdepart.Text)
    Endif
  Else
    xsql = ""
  Endif

  $FieldList = ["tblpatdosing.fldencounterval", "tblpatbilling.fldbillno", "tblpatdosing.fldencounterval", "tblpatdosing.fldencounterval"]
  If chkdate.Value = True Then
    If Not invno Then
      If rboutpat.Value = True Then
        $rData1 = modDatabase.$myConn.Exec("select " & $FieldList.Join(",") & " from tblpatdosing inner join tblpatbilling on tblpatdosing.fldid=tblpatbilling.fldparent where tblpatdosing.flditemtype like &1 and tblpatbilling.fldbillno like &1 and tblpatdosing.fldlevel=&2 and tblpatdosing.fldcurval=&3 and tblpatdosing.fldstatus=&4 and tblpatdosing.fldqtydisp>&5 and tblpatdosing.fldtime_order>=&6 and tblpatdosing.fldtime_order<=&7 and tblpatdosing.fldsave_order=&8" & xsql & " GROUP BY tblpatbilling.fldbillno", "%", "Requested", "Continue", "Registered", 0, modDate.StartSqlDate(dtselected.Value), modDate.EndSqlDate(DateAdd(dtselected.Value, gb.Day, txtdtrange.Value)), xstate)                                          ''
      Else If rbinpat.Value = True Then
        $rData1 = modDatabase.$myConn.Exec("select " & $FieldList.Join(",") & " from tblpatdosing inner join tblpatbilling on tblpatdosing.fldid=tblpatbilling.fldparent where tblpatdosing.flditemtype like &1 and tblpatbilling.fldbillno like &1 and tblpatdosing.fldlevel=&2 and tblpatdosing.fldcurval=&3 and tblpatdosing.fldstatus=&4 and tblpatdosing.fldqtydisp>&5 and tblpatdosing.fldtime_order>=&6 and tblpatdosing.fldtime_order<=&7 and tblpatdosing.fldsave_order=&8" & xsql & " GROUP BY tblpatbilling.fldbillno", "%", "Requested", "Continue", "Admitted", 0, modDate.StartSqlDate(dtselected.Value), modDate.EndSqlDate(DateAdd(dtselected.Value, gb.Day, txtdtrange.Value)), xstate)                                          ''
      Else If rbexited.Value = True Then
        $rData1 = modDatabase.$myConn.Exec("select " & $FieldList.Join(",") & " from tblpatdosing inner join tblpatbilling on tblpatdosing.fldid=tblpatbilling.fldparent where tblpatdosing.flditemtype like &1 and tblpatbilling.fldbillno like &1 and tblpatdosing.fldlevel=&2 and tblpatdosing.fldcurval=&3 and tblpatdosing.fldstatus in(" & strItem.Join(",") & ") and tblpatdosing.fldqtydisp>&5 and tblpatdosing.fldtime_order>=&6 and tblpatdosing.fldtime_order<=&7 and tblpatdosing.fldsave_order=&8" & xsql & " GROUP BY tblpatbilling.fldbillno", "%", "Requested", "Continue", "Admitted", 0, modDate.StartSqlDate(dtselected.Value), modDate.EndSqlDate(DateAdd(dtselected.Value, gb.Day, txtdtrange.Value)), xstate)
      Endif
    Else
      $rData1 = modDatabase.$myConn.Exec("select " & $FieldList.Join(",") & " from tblpatdosing inner join tblpatbilling on tblpatdosing.fldid=tblpatbilling.fldparent where tblpatdosing.flditemtype like &1 and tblpatbilling.fldbillno like &1 and tblpatdosing.fldlevel=&2 and tblpatbilling.fldbillno like &3 and tblpatdosing.fldcurval=&4 and tblpatdosing.fldqtydisp>&5 and tblpatdosing.fldtime_order>=&6 and tblpatdosing.fldtime_order<=&7 and tblpatdosing.fldsave_order=&8 GROUP BY tblpatbilling.fldbillno", "%", "Requested", invno, "Continue", 0, modDate.StartSqlDate(dtselected.Value), modDate.EndSqlDate(DateAdd(dtselected.Value, gb.Day, txtdtrange.Value)), xstate)                                          ''
    Endif
  Else
    If modBasic.$SQLDateRange = "Disable" Then
      If Not invno Then
        If rboutpat.Value = True Then
          $rData1 = modDatabase.$myConn.Exec("select " & $FieldList.Join(",") & " from tblpatdosing inner join tblpatbilling on tblpatdosing.fldid=tblpatbilling.fldparent where tblpatdosing.flditemtype like &1 and tblpatbilling.fldbillno like &1 and tblpatbilling.fldbillno like &1 and tblpatdosing.fldlevel=&2 and tblpatdosing.fldcurval=&3 and tblpatdosing.fldstatus=&4 and tblpatdosing.fldqtydisp>&5 and tblpatdosing.fldsave_order=&6" & xsql & " GROUP BY tblpatbilling.fldbillno", "%", "Requested", "Continue", "Registered", 0, xstate)                                          ''
        Else If rbinpat.Value = True Then
          $rData1 = modDatabase.$myConn.Exec("select " & $FieldList.Join(",") & " from tblpatdosing inner join tblpatbilling on tblpatdosing.fldid=tblpatbilling.fldparent where tblpatdosing.flditemtype like &1 and tblpatbilling.fldbillno like &1 and tblpatbilling.fldbillno like &1 and tblpatdosing.fldlevel=&2 and tblpatdosing.fldcurval=&3 and tblpatdosing.fldstatus=&4 and tblpatdosing.fldqtydisp>&5 and tblpatdosing.fldsave_order=&6" & xsql & " GROUP BY tblpatbilling.fldbillno", "%", "Requested", "Continue", "Admitted", 0, xstate)                                          ''
        Else If rbexited.Value = True Then
          $rData1 = modDatabase.$myConn.Exec("select " & $FieldList.Join(",") & " from tblpatdosing inner join tblpatbilling on tblpatdosing.fldid=tblpatbilling.fldparent where tblpatdosing.flditemtype like &1 and tblpatbilling.fldbillno like &1 and tblpatbilling.fldbillno like &1 and tblpatdosing.fldlevel=&2 and tblpatdosing.fldcurval=&3 and tblpatdosing.fldstatus in(" & strItem.Join(",") & ") and tblpatdosing.fldqtydisp>&5 and tblpatdosing.fldsave_order=&6" & xsql & " GROUP BY tblpatbilling.fldbillno", "%", "Requested", "Continue", "Admitted", 0, xstate)
        Endif
      Else
        $rData1 = modDatabase.$myConn.Exec("select " & $FieldList.Join(",") & " from tblpatdosing inner join tblpatbilling on tblpatdosing.fldid=tblpatbilling.fldparent where tblpatdosing.flditemtype like &1 and tblpatbilling.fldbillno like &1 and tblpatbilling.fldbillno like &1 and tblpatdosing.fldlevel=&2 and tblpatbilling.fldbillno like &3 and tblpatdosing.fldcurval=&4 and tblpatdosing.fldqtydisp>&5 and tblpatdosing.fldsave_order=&6 GROUP BY tblpatbilling.fldbillno", "%", "Requested", invno, "Continue", 0, xstate)                                          ''
      Endif
    Else
      If Not invno Then
        If rboutpat.Value = True Then
          $rData1 = modDatabase.$myConn.Exec("select " & $FieldList.Join(",") & " from tblpatdosing inner join tblpatbilling on tblpatdosing.fldid=tblpatbilling.fldparent where tblpatdosing.flditemtype like &1 and tblpatbilling.fldbillno like &1 and tblpatdosing.fldlevel=&2 and tblpatdosing.fldcurval=&3 and tblpatdosing.fldstatus=&4 and tblpatdosing.fldqtydisp>&5 and tblpatdosing.fldtime_order>=&6 and tblpatdosing.fldtime_order<=&7 and tblpatdosing.fldsave_order=&8" & xsql & " GROUP BY tblpatbilling.fldbillno", "%", "Requested", "Continue", "Registered", 0, modDate.StartSqlDate(DateAdd(dtselected.Value, gb.Day, 0 - 365)), modDate.EndSqlDate(dtselected.Value), xstate)                                          ''
        Else If rbinpat.Value = True Then
          $rData1 = modDatabase.$myConn.Exec("select " & $FieldList.Join(",") & " from tblpatdosing inner join tblpatbilling on tblpatdosing.fldid=tblpatbilling.fldparent where tblpatdosing.flditemtype like &1 and tblpatbilling.fldbillno like &1 and tblpatdosing.fldlevel=&2 and tblpatdosing.fldcurval=&3 and tblpatdosing.fldstatus=&4 and tblpatdosing.fldqtydisp>&5 and tblpatdosing.fldtime_order>=&6 and tblpatdosing.fldtime_order<=&7 and tblpatdosing.fldsave_order=&8" & xsql & " GROUP BY tblpatbilling.fldbillno", "%", "Requested", "Continue", "Admitted", 0, modDate.StartSqlDate(DateAdd(dtselected.Value, gb.Day, 0 - 365)), modDate.EndSqlDate(dtselected.Value), xstate)                                          ''
        Else If rbexited.Value = True Then
          $rData1 = modDatabase.$myConn.Exec("select " & $FieldList.Join(",") & " from tblpatdosing inner join tblpatbilling on tblpatdosing.fldid=tblpatbilling.fldparent where tblpatdosing.flditemtype like &1 and tblpatbilling.fldbillno like &1 and tblpatdosing.fldlevel=&2 and tblpatdosing.fldcurval=&3 and tblpatdosing.fldstatus in(" & strItem.Join(",") & ") and tblpatdosing.fldqtydisp>&5 and tblpatdosing.fldtime_order>=&6 and tblpatdosing.fldtime_order<=&7 and tblpatdosing.fldsave_order=&8" & xsql & " GROUP BY tblpatbilling.fldbillno", "%", "Requested", "Continue", "Admitted", 0, modDate.StartSqlDate(DateAdd(dtselected.Value, gb.Day, 0 - 365)), modDate.EndSqlDate(dtselected.Value), xstate)
        Endif
      Else
        $rData1 = modDatabase.$myConn.Exec("select " & $FieldList.Join(",") & " from tblpatdosing inner join tblpatbilling on tblpatdosing.fldid=tblpatbilling.fldparent where tblpatdosing.flditemtype like &1 and tblpatbilling.fldbillno like &1 and tblpatdosing.fldlevel=&2 and tblpatbilling.fldbillno like &3 and tblpatdosing.fldcurval=&4 and tblpatdosing.fldqtydisp>&5 and tblpatdosing.fldtime_order>=&6 and tblpatdosing.fldtime_order<=&7 and tblpatdosing.fldsave_order=&8 GROUP BY tblpatbilling.fldbillno", "%", "Requested", invno, "Continue", 0, modDate.StartSqlDate(DateAdd(dtselected.Value, gb.Day, 0 - 365)), modDate.EndSqlDate(dtselected.Value), xstate)                                          ''
      Endif
    Endif
  Endif
  $aMyFields1 = New String[]
  modGridView.ReadSmallData(GridView1, $rData1, $aMyFields1)

  With GridView1
    .Columns[0].Width = CStr(100 * modBasic.$AppWidthRatio) & "px"
    .Columns[1].Width = CStr(125 * modBasic.$AppWidthRatio) & "px"
    .Columns[2].Width = CStr(175 * modBasic.$AppWidthRatio) & "px"
    .Columns[3].Hidden = True

    .Columns[0].Text = "Location"
    .Columns[1].Text = "Invoice"
    .Columns[2].Text = "Patient Name"
  End With

End

Public Sub GridView1_Data(Row As Integer, Column As Integer, Data As WebTableData)

  $rData1.MoveTo(Row)
  modGridView.GridViewDecoration(Data, Row)
  If Column = 0 Then
    Data.Text = modPatient.GetPatientLocation($rData1[$aMyFields1[Column]])
  Else If Column = 2 Then
    Data.Text = modPatient.GetPatientNameByEnc($rData1[$aMyFields1[Column]])
  Else
    Data.Text = $rData1[$aMyFields1[Column]]
  Endif

End

Public Sub GridView1_Select()

  txtindex.Text = ""
  If GridView1.Selection.Count Then
    $rData1.MoveTo(GridView1.Selection[0])
    GridView2.Clear()
    txtindex.Text = $rData1[$aMyFields1[1]]  'GridView1[GridView1.Row, 1].Text
    $encid = $rData1[$aMyFields1[3]]  'GridView1[GridView1.Row, 3].Text
    GetPatientProfile($encid)
    FillDispenstable(txtindex.Text)
    $HiCappingVar = New Collection
  Endif

End

Private Sub GetPatientProfile(encid As String)

  txtpatientname.Text = modPatient.GetPatientNameByEnc(encid)
  txtstatus.Text = modPatient.CurrentAdmissionStatus(encid)
  txtagesex.Text = modPatient.GetPatientAgeString(encid, Now()) & "/" & modPatient.GetPatientAddressByEnc(encid)
  txtpatientcontact.Text = modPatient.GetPatientLocation(encid)
  txtnhsi.Text = modPatient.GetPatientExtCOdebyEnc(encid)

End

Private Function ExecuteQuery(encid As String) As Result

  Dim xstate As Boolean
  Dim res As Result
  Dim xrestr As String
  Dim xList As String[]
  Dim i As Integer

  Dim xsql As String
  Dim strItem As String[] = ["Discharged", "LAMA", "Death", "Refer", "Absconder"]
  Dim j As Integer

  For j = 0 To strItem.Count - 1
    strItem[j] = "'" & strItem[j] & "'"
  Next

  If $xStatus = "Dispensed" Then
    xstate = True
  Else If $xStatus = "Requested" Then
    xstate = False
  Endif

  If txtstatus.Text = "Admitted" Then
    If $RestrictType And If $RestrictList.Count Then
      xList = $RestrictList.Copy()
      For i = 0 To xList.Count - 1
        xList[i] = "'" & xList[i] & "'"
      Next
      If $RestrictType = "Allow" Then
        xrestr = " and flditem IN(" & xList.Join(",") & ")"
      Else If $RestrictType = "Prevent" Then
        xrestr = " and flditem NOT IN(" & xList.Join(",") & ")"
      Endif
    Else
      xrestr = ""
    Endif
  Else
    xrestr = ""
  Endif

  If cmbdepart.Text Then
    If rboutpat.Value = True Then
      xsql = db.Subst(" and fldencounterval in(select fldencounterval from tblencounter where fldcurrlocat like &1)", cmbdepart.Text)
    Else If rbinpat.Value = True Then
      xsql = db.Subst(" and fldencounterval in(select fldencounterval from tblencounter where fldcurrlocat in(select fldbed from tbldepartmentbed where flddept like &1))", cmbdepart.Text)
    Else If rbexited.Value = True Then
      xsql = db.Subst(" and fldencounterval in(select fldencounterval from tblencounter where fldcurrlocat in(select fldbed from tbldepartmentbed where flddept like &1))", cmbdepart.Text)
    Endif
  Else
    xsql = ""
  Endif

  If rbencid.Value = True Then
    If chkdate.Value = True Then
      If rboutpat.Value = True Then
        res = modDatabase.$myConn.Exec("select fldid,fldtime_order,fldroute,flditem,fldqtydisp,flddose,fldfreq,flddays,fldlabel,flddirection,fldcomp_order,fldencounterval,flditemtype,fldfixname,fldfixrate,fldtaxper,flddiscper,fldbillingmode,flddisctype,fldacledger,fldbilltype,fldcashincredit from tblpatdosing where fldencounterval=&1 and fldlevel=&2 and flditemtype like &3 and fldcurval=&4 and fldqtydisp>&5 and fldtime_order>=&6 and fldtime_order<=&7 and fldstatus=&8 and fldsave_order=&9" & xrestr & xsql, encid, "Requested", "%", "Continue", 0, modDate.StartSqlDate(dtselected.Value), modDate.EndSqlDate(DateAdd(dtselected.Value, gb.Day, txtdtrange.Value)), "Registered", xstate)
      Else If rbinpat.Value = True Then
        res = modDatabase.$myConn.Exec("select fldid,fldtime_order,fldroute,flditem,fldqtydisp,flddose,fldfreq,flddays,fldlabel,flddirection,fldcomp_order,fldencounterval,flditemtype,fldfixname,fldfixrate,fldtaxper,flddiscper,fldbillingmode,flddisctype,fldacledger,fldbilltype,fldcashincredit from tblpatdosing where fldencounterval=&1 and fldlevel=&2 and flditemtype like &3 and fldcurval=&4 and fldqtydisp>&5 and fldtime_order>=&6 and fldtime_order<=&7 and fldstatus=&8 and fldsave_order=&9" & xrestr & xsql, encid, "Requested", "%", "Continue", 0, modDate.StartSqlDate(dtselected.Value), modDate.EndSqlDate(DateAdd(dtselected.Value, gb.Day, txtdtrange.Value)), "Admitted", xstate)
      Else If rbexited.Value = True Then
        res = modDatabase.$myConn.Exec("select fldid,fldtime_order,fldroute,flditem,fldqtydisp,flddose,fldfreq,flddays,fldlabel,flddirection,fldcomp_order,fldencounterval,flditemtype,fldfixname,fldfixrate,fldtaxper,flddiscper,fldbillingmode,flddisctype,fldacledger,fldbilltype,fldcashincredit from tblpatdosing where fldencounterval=&1 and fldlevel=&2 and flditemtype like &3 and fldcurval=&4 and fldqtydisp>&5 and fldtime_order>=&6 and fldtime_order<=&7 and fldstatus in(" & strItem.Join(",") & ") and fldsave_order=&9" & xrestr & xsql, encid, "Requested", "%", "Continue", 0, modDate.StartSqlDate(dtselected.Value), modDate.EndSqlDate(DateAdd(dtselected.Value, gb.Day, txtdtrange.Value)), "Admitted", xstate)
      Endif
    Else
      If rboutpat.Value = True Then
        res = modDatabase.$myConn.Exec("select fldid,fldtime_order,fldroute,flditem,fldqtydisp,flddose,fldfreq,flddays,fldlabel,flddirection,fldcomp_order,fldencounterval,flditemtype,fldfixname,fldfixrate,fldtaxper,flddiscper,fldbillingmode,flddisctype,fldacledger,fldbilltype,fldcashincredit from tblpatdosing where fldencounterval=&1 and fldlevel=&2 and flditemtype like &3 and fldcurval=&4 and fldqtydisp>&5 and fldstatus=&6 and fldsave_order=&7" & xrestr & xsql, encid, "Requested", "%", "Continue", 0, "Registered", xstate)
      Else If rbinpat.Value = True Then
        res = modDatabase.$myConn.Exec("select fldid,fldtime_order,fldroute,flditem,fldqtydisp,flddose,fldfreq,flddays,fldlabel,flddirection,fldcomp_order,fldencounterval,flditemtype,fldfixname,fldfixrate,fldtaxper,flddiscper,fldbillingmode,flddisctype,fldacledger,fldbilltype,fldcashincredit from tblpatdosing where fldencounterval=&1 and fldlevel=&2 and flditemtype like &3 and fldcurval=&4 and fldqtydisp>&5 and fldstatus=&6 and fldsave_order=&7" & xrestr & xsql, encid, "Requested", "%", "Continue", 0, "Admitted", xstate)
      Else If rbexited.Value = True Then
        res = modDatabase.$myConn.Exec("select fldid,fldtime_order,fldroute,flditem,fldqtydisp,flddose,fldfreq,flddays,fldlabel,flddirection,fldcomp_order,fldencounterval,flditemtype,fldfixname,fldfixrate,fldtaxper,flddiscper,fldbillingmode,flddisctype,fldacledger,fldbilltype,fldcashincredit from tblpatdosing where fldencounterval=&1 and fldlevel=&2 and flditemtype like &3 and fldcurval=&4 and fldqtydisp>&5 and fldstatus in(" & strItem.Join(",") & ") and fldsave_order=&7" & xrestr & xsql, encid, "Requested", "%", "Continue", 0, "Admitted", xstate)
      Endif
    Endif

  Else If rbinvoice.Value = True Then
    If chkdate.Value = True Then
      If rboutpat.Value = True Then
        res = modDatabase.$myConn.Exec("select fldid,fldtime_order,fldroute,flditem,fldqtydisp,flddose,fldfreq,flddays,fldlabel,flddirection,fldcomp_order,fldencounterval,flditemtype,fldfixname,fldfixrate,fldtaxper,flddiscper,fldbillingmode,flddisctype,fldacledger,fldbilltype,fldcashincredit from tblpatdosing where fldid in(select fldparent from tblpatbilling where fldbillno=&1) and fldlevel=&2 and flditemtype like &3 and fldcurval=&4 and fldqtydisp>&5 and fldtime_order>=&6 and fldtime_order<=&7 and fldstatus=&8 and fldsave_order=&9" & xrestr & xsql, encid, "Requested", "%", "Continue", 0, modDate.StartSqlDate(dtselected.Value), modDate.EndSqlDate(DateAdd(dtselected.Value, gb.Day, txtdtrange.Value)), "Registered", xstate)
      Else If rbinpat.Value = True Then
        res = modDatabase.$myConn.Exec("select fldid,fldtime_order,fldroute,flditem,fldqtydisp,flddose,fldfreq,flddays,fldlabel,flddirection,fldcomp_order,fldencounterval,flditemtype,fldfixname,fldfixrate,fldtaxper,flddiscper,fldbillingmode,flddisctype,fldacledger,fldbilltype,fldcashincredit from tblpatdosing where fldid in(select fldparent from tblpatbilling where fldbillno=&1) and fldlevel=&2 and flditemtype like &3 and fldcurval=&4 and fldqtydisp>&5 and fldtime_order>=&6 and fldtime_order<=&7 and fldstatus=&8 and fldsave_order=&9" & xrestr & xsql, encid, "Requested", "%", "Continue", 0, modDate.StartSqlDate(dtselected.Value), modDate.EndSqlDate(DateAdd(dtselected.Value, gb.Day, txtdtrange.Value)), "Admitted", xstate)
      Else If rbexited.Value = True Then
        res = modDatabase.$myConn.Exec("select fldid,fldtime_order,fldroute,flditem,fldqtydisp,flddose,fldfreq,flddays,fldlabel,flddirection,fldcomp_order,fldencounterval,flditemtype,fldfixname,fldfixrate,fldtaxper,flddiscper,fldbillingmode,flddisctype,fldacledger,fldbilltype,fldcashincredit from tblpatdosing where fldid in(select fldparent from tblpatbilling where fldbillno=&1) and fldlevel=&2 and flditemtype like &3 and fldcurval=&4 and fldqtydisp>&5 and fldtime_order>=&6 and fldtime_order<=&7 and fldstatus in(" & strItem.Join(",") & ") and fldsave_order=&9" & xrestr & xsql, encid, "Requested", "%", "Continue", 0, modDate.StartSqlDate(dtselected.Value), modDate.EndSqlDate(DateAdd(dtselected.Value, gb.Day, txtdtrange.Value)), "Admitted", xstate)
      Endif
    Else
      If rboutpat.Value = True Then
        res = modDatabase.$myConn.Exec("select fldid,fldtime_order,fldroute,flditem,fldqtydisp,flddose,fldfreq,flddays,fldlabel,flddirection,fldcomp_order,fldencounterval,flditemtype,fldfixname,fldfixrate,fldtaxper,flddiscper,fldbillingmode,flddisctype,fldacledger,fldbilltype,fldcashincredit from tblpatdosing where fldid in(select fldparent from tblpatbilling where fldbillno=&1) and fldlevel=&2 and flditemtype like &3 and fldcurval=&4 and fldqtydisp>&5 and fldstatus=&6 and fldsave_order=&7" & xrestr & xsql, encid, "Requested", "%", "Continue", 0, "Registered", xstate)
      Else If rbinpat.Value = True Then
        res = modDatabase.$myConn.Exec("select fldid,fldtime_order,fldroute,flditem,fldqtydisp,flddose,fldfreq,flddays,fldlabel,flddirection,fldcomp_order,fldencounterval,flditemtype,fldfixname,fldfixrate,fldtaxper,flddiscper,fldbillingmode,flddisctype,fldacledger,fldbilltype,fldcashincredit from tblpatdosing where fldid in(select fldparent from tblpatbilling where fldbillno=&1) and fldlevel=&2 and flditemtype like &3 and fldcurval=&4 and fldqtydisp>&5 and fldstatus=&6 and fldsave_order=&7" & xrestr & xsql, encid, "Requested", "%", "Continue", 0, "Admitted", xstate)
      Else If rbexited.Value = True Then
        res = modDatabase.$myConn.Exec("select fldid,fldtime_order,fldroute,flditem,fldqtydisp,flddose,fldfreq,flddays,fldlabel,flddirection,fldcomp_order,fldencounterval,flditemtype,fldfixname,fldfixrate,fldtaxper,flddiscper,fldbillingmode,flddisctype,fldacledger,fldbilltype,fldcashincredit from tblpatdosing where fldid in(select fldparent from tblpatbilling where fldbillno=&1) and fldlevel=&2 and flditemtype like &3 and fldcurval=&4 and fldqtydisp>&5 and fldstatus in(" & strItem.Join(",") & ") and fldsave_order=&7" & xrestr & xsql, encid, "Requested", "%", "Continue", 0, "Admitted", xstate)
      Endif
    Endif

  Endif

  Return res

End

Private Sub FillDispenstable(encid As String)

  $rData2 = ExecuteQuery(encid)
  $aMyFields2 = New String[]
  modGridView.ReadSmallData(GridView2, $rData2, $aMyFields2)

  With GridView2
    .Columns[0].Hidden = True
    .Columns[1].Width = CStr(100 * modBasic.$AppWidthRatio) & "px"
    .Columns[2].Width = CStr(75 * modBasic.$AppWidthRatio) & "px"
    .Columns[3].Width = CStr(250 * modBasic.$AppWidthRatio) & "px"
    .Columns[4].Width = CStr(75 * modBasic.$AppWidthRatio) & "px"
    If chkregimen.Value = True Then
      .Columns[5].Width = CStr(75 * modBasic.$AppWidthRatio) & "px"
      .Columns[6].Width = CStr(50 * modBasic.$AppWidthRatio) & "px"
      .Columns[7].Width = CStr(50 * modBasic.$AppWidthRatio) & "px"
      .Columns[8].Width = CStr(25 * modBasic.$AppWidthRatio) & "px"
    Else
      .Columns[5].Hidden = True
      .Columns[6].Hidden = True
      .Columns[7].Hidden = True
      .Columns[8].Hidden = True
    Endif

    .Columns[9].Width = CStr(200 * modBasic.$AppWidthRatio) & "px"
    .Columns[10].Width = CStr(100 * modBasic.$AppWidthRatio) & "px"
    .Columns[11].Hidden = True
    .Columns[12].Hidden = True

    .Columns[13].Hidden = True
    .Columns[14].Hidden = True
    .Columns[15].Hidden = True
    .Columns[16].Hidden = True
    .Columns[17].Hidden = True
    .Columns[18].Hidden = True
    .Columns[19].Hidden = True
    .Columns[20].Hidden = True
    .Columns[21].Hidden = True

    .Columns[1].Text = "DateTime"
    .Columns[2].Text = "Route"
    .Columns[3].Text = "Particulars"
    .Columns[4].Text = "QTY"
    If chkregimen.Value = True Then
      .Columns[5].Text = "Dose"
      .Columns[6].Text = "Freq"
      .Columns[7].Text = "Day"
    Endif
    .Columns[9].Text = "Direction"
    .Columns[10].Text = "Sender"
  End With

End

Public Sub GridView2_Data(Row As Integer, Column As Integer, Data As WebTableData)

  $rData2.MoveTo(Row)
  modGridView.GridViewDecoration(Data, Row)
  If Column = 1 Then
    Data.Text = modReportVar.GetDateTimeReport($rData2[$aMyFields2[Column]], gb.GeneralDate)
  Else If Column = 8 Then
    If $rData2[$aMyFields2[Column]] = True Then
      btncheckicon.Image = "icons/checked.png"
    Else
      btncheckicon.Image = "icons/unchecked.png"
    Endif
    Data.Control = btncheckicon
  Else If Column = 10 Then
    Data.Text = modGeneral.GetCompNameFromCompID($rData2[$aMyFields2[Column]])
  Else
    Data.Text = $rData2[$aMyFields2[Column]]
  Endif

End

Public Sub mnuselall_Click()

  Dim res As Result

  If GridView2.Selection.Count Then
    $rData2.MoveTo(GridView2.Selection[0])
    If $rData2["flditemtype"] = "Medicines" Then
      If $rData2["fldqtydisp"] And If $rData2["flddose"] And If $rData2["fldfreq"] Then
        res = modDatabase.$myConn.Edit("tblpatdosing", "fldid=&1", $rData2["fldid"])
        res["fldlabel"] = True
        res.Update
        FillDispenstable(txtindex.Text)
      Endif
    Endif
  Endif

End

Public Sub mnudselal_Click()

  Dim res As Result

  If GridView2.Selection.Count Then
    $rData2.MoveTo(GridView2.Selection[0])
    If $rData2["flditemtype"] = "Medicines" Then
      If $rData2["fldqtydisp"] And If $rData2["flddose"] And If $rData2["fldfreq"] Then
        res = modDatabase.$myConn.Edit("tblpatdosing", "fldid=&1", $rData2["fldid"])
        res["fldlabel"] = False
        res.Update
        FillDispenstable(txtindex.Text)
      Endif
    Endif
  Endif

End

Public Sub txtmeddose_Click()

  Dim xval As Float
  Dim anum As Float

  If GridView2.Selection.Count Then
    $rData2.MoveTo(GridView2.Selection[0])

    If $rData2["flditemtype"] = "Medicines" Then
      If $rData2["flddose"] Then
        anum = $rData2["flddose"]
      Else
        anum = 0
      Endif
      xval = InputValue($rData2["flditem"], ("Alter Unit Dose"), anum)
      modPharmSub.UpdateDoseBefDispensing($rData2["fldid"], xval)
      FillDispenstable(txtindex.Text)
    Endif

  Endif

End

Public Sub btnmedfreq_Click()

  Dim yval As String

  If GridView2.Selection.Count Then
    $rData2.MoveTo(GridView2.Selection[0])

    If $rData2["flditemtype"] = "Medicines" Then
      yval = InputCombo($rData2["flditem"], ("Alter Frequency"), modMedicine.FrequencyCombo(), $rData2["fldfreq"], True)
      modPharmSub.UpdateFreqBefDispensing($rData2["fldid"], yval)
      FillDispenstable(txtindex.Text)
    Endif

  Endif

End

Public Sub btnmeddays_Click()

  Dim xval As Float
  Dim anum As Float

  If GridView2.Selection.Count Then
    $rData2.MoveTo(GridView2.Selection[0])

    If $rData2["flditemtype"] = "Medicines" Then
      If $rData2["flddays"] Then
        anum = $rData2["flddays"]
      Else
        anum = 0
      Endif
      xval = InputValue($rData2["flditem"], ("Alter Duration"), anum)
      modPharmSub.UpdateDaysBefDispensing($rData2["fldid"], xval)
      FillDispenstable(txtindex.Text)
    Endif

  Endif

End

Public Sub btndispqty_Click()

  Dim xval As Float

  If GridView2.Selection.Count Then
    $rData2.MoveTo(GridView2.Selection[0])

    If $xStatus = "Requested" Then
      xval = InputValue($rData2["flditem"], ("Alter Quantity"), $rData2["fldqtydisp"])
      If xval > 0 Then
        modPharmSub.UpdateQTYBefDispensing($rData2["fldid"], xval)
        FillDispenstable(txtindex.Text)
      Endif
    Endif
  Endif

End

Public Sub btnadvice_Click()

  Dim yval As String

  If GridView2.Selection.Count Then
    $rData2.MoveTo(GridView2.Selection[0])

    yval = InputBox($rData2["flditem"], ("Alter Direction"), $rData2["flddirection"])
    If yval Then
      modPharmSub.UpdateAdviceBefDispensing($rData2["fldid"], yval)
      FillDispenstable(txtindex.Text)
    Endif

  Endif

End

Public Sub chkprintlabel_Click()

  modSettings.EnterCheckSetting(chkprintlabel, "DispensingList/PrintLabel")

End

Public Sub mnuremove_Click()

  If GridView2.Selection.Count Then
    $rData2.MoveTo(GridView2.Selection[0])
    modDatabase.$myConn.Delete("tblpatdosing", "fldid=&1 and fldsave_order=&2", $rData2["fldid"], False)
    FillDispenstable(txtindex.Text)
  Endif

End

Public Sub btnclaerall_Click()

  If $xStatus = "Dispensed" Then
    COnfirmDispensing()
  Else If $xStatus = "Requested" Then
    PharmacySave()
    FillDispenstable(txtindex.Text)
  Endif

End

Private Sub COnfirmDispensing()

  Dim res As Result
  Dim xgo As Boolean

  If $rData2.Count Then
    For Each $rData2
      xgo = False
      If chkselall.Value = True Then
        xgo = True
      Else If chkselall.Value = False Then
        If GridView2.IsSelected($rData2.Index) = True Then
          xgo = True
        Endif
      Endif
      If xgo = True Then
        res = modDatabase.$myConn.Edit("tblpatdosing", "fldid=&1", $rData2["fldid"])
        res["fldlevel"] = "Dispensed"
        res["flduserid_disp"] = modBasic.$lbluser
        res["fldtime_disp"] = Now()
        res["fldcomp_disp"] = modBasic.$compID
        res["xyz"] = False
        res.Update()
      Endif
    Next
    FillDispenstable(txtindex.Text)
    Me.Exec(Subst("Toastify({text: '&1', duration: &2}).showToast()", "Information saved", modBasic.$BalloonDelay))
  Endif

End

Public Sub btnlabelall_Click()

  Dim hClabel As CLabelSize

  If $rData2.Count Then
    For Each $rData2
      If $rData2["flditemtype"] = "Medicines" Then
        hClabel = New CLabelSize($rData2["fldid"], "Outpatient")
        ' modPrint.PrintPopUp(CStr(GridView2[Row, 0].Text), hClabel.LabelPath(), "LabelSize")
      Endif
    Next
  Endif

End

Public Sub btncounsel_Click()

  Dim doslst As Long[]
  Dim xPath As String

  If $rData2.Count Then
    doslst = New Long[]
    For Each $rData2
      If $rData2["flditemtype"] = "Medicines" Then
        doslst.Add($rData2["fldid"])
      Endif
    Next

    xPath = modCHTMLPatient.ShowCounselingReport($encid, doslst)
    modControlSub.OpenHTMLPreview($encid, xPath, "ReportSize")
  Endif

End

Public Sub btnreview_Click()

  Dim opt As Long[]
  Dim cForm As CMedError

  If $rData2.Count Then
    opt = New Long[]
    For Each $rData2
      If $rData2["flditemtype"] = "Medicines" Then
        opt.Add($rData2["fldid"])
      Endif
    Next
    cForm = New CMedError
    cForm.ShowMedicationReviewMultipleDosID($encid, opt, "Report")
  Endif

End

Public Sub btnpatinfo_Click()

  Dim hCls As CReportCustom

  If $encid Then
    If modSettings.ShowSettingFromFIle("Diagnostic Help/Name") Then
      hCls = New CReportCustom($encid, "Diagnostic Help", "ReportSize", MMain.$defUnit)
      hCls.Preview()
    Endif
  Endif

End

''-------- Save Request --------------------
Private Sub PharmacySave()

  Dim res1 As Result
  Dim xgo As Boolean
  Dim tax As Float
  Dim disc As Float
  Dim xrate As Float
  Dim xtot As Float
  Dim xitem As String

  Dim res2 As Result
  Dim sql2 As String

  Dim qtynew As Float
  Dim sList As Long[]
  Dim xerr As String
  Dim xallow As Boolean
  Dim xCshCrd As Float
  Dim xfixcode As String

  xerr = ""
  If $encid Then
    sList = New Long[]

    res1 = $rData2
    If res1.Available = True Then

      For Each res1
        xgo = False
        If chkselall.Value = True Then
          xgo = True
        Else If chkselall.Value = False Then
          If GridView2.IsSelected(res1.Index) = True Then
            xgo = True
          Endif
        Endif
        If xgo = True Then
          'get tax and discount percentages
          If res1["fldtaxper"] Then
            tax = res1["fldtaxper"]
          Else
            tax = 0
          Endif
          If res1["flddiscper"] Then
            disc = res1["flddiscper"]
          Else
            disc = 0
          Endif
          If res1["fldcashincredit"] Then
            xCshCrd = res1["fldcashincredit"]
          Else
            xCshCrd = 0
          Endif

          If res1["fldfixrate"] Then
            xrate = res1["fldfixrate"]
          Else
            xrate = modStock.GetCurrentSellingPrice(res1["flditem"], modBasic.$compID)
          Endif

          ' xallow = modNonMedical.AllowPharmProceedPreBill($encid, res1["flddisctype"], res1["fldqtydisp"], xrate, res1["flddiscper"], res1["fldbilltype"], xCshCrd, res1["fldroute"], res1["flditem"])
          xallow = False
          If modBasic.$AutoBillPharmacy = "Standard" Then
            xtot = modNonMedical.GetCashBillAmount(xrate, res1["fldqtydisp"], res1["fldbilltype"], disc, tax, xCshCrd)
            If modNonMedical.AllowPreCheckDeposit($encid, "Pharmacy", res1["flditem"], xtot, res1["fldbilltype"]) = True Then
              xallow = True
            Endif
          Else If modBasic.$AutoBillPharmacy = "Full" Then
            xtot = modNonMedical.GetCashBillAmount(xrate, res1["fldqtydisp"], res1["fldbilltype"], disc, tax, xCshCrd)
            If modNonMedical.AllowPreEntryWithDeposit($encid, "Pharmacy", res1["flditem"], xtot, res1["fldbilltype"]) = True Then
              xallow = True
            Endif
          Else
            If modBasic.$AutoBillSaveZero = "Yes" And If xrate = 0 Then
              xallow = True
            Else If modBasic.$AutoBillSaveZero = "Yes" And If res1["flddiscper"] = 100 Then
              xallow = True
            Else If modBasic.$AutoBillSaveFullCredit = "Yes" And If res1["fldbilltype"] = "Credit" And If xCshCrd = 0 Then
              xallow = True
            Endif
          Endif
          If xallow = True Then

            If modNonMedical.GetFixedReferenceScheme(res1["flddisctype"]) = "Claim Code" Then
              GetHImedicineCappingVar($encid, res1["flddisctype"], txtnhsi.Text)
            Endif
            xfixcode = modNonMedical.GetBillItemHIAbbv(res1["fldfixname"], res1["flditemtype"])
            If GetHICapGo($encid, xfixcode, res1["fldfixname"], res1["fldqtydisp"], res1["flddisctype"]) = True Then
              If xfixcode And If $HiCappingVar.Exist(xfixcode) Then
                $HiCappingVar[xfixcode] = $HiCappingVar[xfixcode] - res1["fldqtydisp"]
              Endif

              qtynew = res1["fldqtydisp"]
              modDatabase.$myConn.Begin
              While qtynew > 0
                'get stockno, rate and quantity based on expiry check
                If modBasic.$SkipExpiry = "ExpireOnUse" Then
                  sql2 = "select fldstockno,fldqty from tblentry where fldstockid=&1 and fldcomp=&2 and fldstatus=&3 and fldexpiry>&4 and fldqty>&5"
                  res2 = modDatabase.$myConn.Exec(sql2, res1["flditem"], modBasic.$compID, 1, DateAdd(modDate.StartSqlDate(Now()), gb.Day, CInt(res1["flddays"])), 0)
                Else If modBasic.$SkipExpiry = "Expired" Then
                  sql2 = "select fldstockno,fldqty from tblentry where fldstockid=&1 and fldcomp=&2 and fldstatus=&3 and fldexpiry>&4 and fldqty>&5"
                  res2 = modDatabase.$myConn.Exec(sql2, res1["flditem"], modBasic.$compID, 1, modDate.StartSqlDate(Now()), 0)
                Else
                  sql2 = "select fldstockno,fldqty from tblentry where fldstockid=&1 and fldcomp=&2 and fldstatus=&3 and fldqty>&4"
                  res2 = modDatabase.$myConn.Exec(sql2, res1["flditem"], modBasic.$compID, 1, 0)
                Endif
                If res2.Available Then
                  res2.MoveFirst

                  xitem = res1["flditem"]
                  If res1["fldfixname"] Then
                    xitem = res1["fldfixname"]
                    If res1["fldfixrate"] Then
                      xrate = res1["fldfixrate"]
                    Else
                      xrate = 0
                    Endif
                  Else
                    xrate = modStock.GetSellingPriceByStockNo(res2["fldstockno"], res1["fldbillingmode"])
                  Endif

                  If qtynew <= res2["fldqty"] Then
                    If modBasic.$AutoBillUseOwn = "Disable" Then
                    Else
                      modBillings.InsertBlankBillItemNewApp($encid, res1["fldbilltype"], res1["fldbillingmode"], res1["flddisctype"], res1["fldacledger"], res1["flditemtype"], res2["fldstockno"], xitem, xrate, qtynew, tax, disc, xCshCrd, "Done", res1["fldid"], True, False, modBasic.$compID)
                    Endif
                    modStockSub.AddToExistEntry(res2["fldstockno"], (0 - qtynew), modBasic.$compID)
                    qtynew = 0
                  Else If qtynew > res2["fldqty"] Then
                    If modBasic.$AutoBillUseOwn = "Disable" Then
                    Else
                      modBillings.InsertBlankBillItemNewApp($encid, res1["fldbilltype"], res1["fldbillingmode"], res1["flddisctype"], res1["fldacledger"], res1["flditemtype"], res2["fldstockno"], xitem, xrate, res2["fldqty"], tax, disc, xCshCrd, "Done", res1["fldid"], True, False, modBasic.$compID)
                    Endif
                    modStockSub.AddToExistEntry(res2["fldstockno"], (0 - res2["fldqty"]), modBasic.$compID)
                    qtynew = qtynew - res2["fldqty"]
                  Endif
                  Wait
                  If res1["flddose"] And If res1["fldfreq"] And If res1["flddays"] And If res1["fldqtydisp"] Then
                    If res1["fldlabel"] = True Then
                      sList.Add(res1["fldid"])
                    Endif
                  Endif
                Else
                  Break
                Endif
                BlinkOnSave(res2["fldstockno"])
              Wend
              If res1["fldqtydisp"] > qtynew Then
                If qtynew > 0 Then
                  modPharmSub.DuplicateRecordWithQTY(res1["fldid"], qtynew)
                  modPharmSub.UpdateQTYBefDispensing(res1["fldid"], res1["fldqtydisp"] - qtynew)
                Endif
                modPharmSub.UpdateDispensing(res1["fldid"], True)
              Endif
              modDatabase.$myConn.Commit

            Else
              xerr = xerr & "Cap Limit exceeded for " & res1["fldfixname"] & gb.NewLine
            Endif
          Else
            xerr = xerr & res1["fldfixname"] & gb.NewLine
          Endif
        Endif
      Next

      If xerr Then
        Message.Warning("<b>Over Set Discount/Credit Limit:</b>" & gb.NewLine & xerr, "OK")
      Endif

    Endif

    modPharmSub.PrintLabelSelList(sList, "Inpatient")
  Endif

Catch
  modDatabase.$myConn.Rollback
  modHelpVariable.CreateErrorReport()

End

Private Sub GetHImedicineCappingVar(encid As String, sPackage As String, xNHSI As String)

  Dim hForm As CimisAPICap

  If sPackage = modBasic.$HIPackage Or If sPackage = modBasic.$HIPackageER Then
    If modBasic.$IMISValidateURL Then

      If modClaim.GetChronicClaimStatus(encid) = True Then
        If $HiCappingVar.Count Then
          $HiCappingVar.Clear()
        Endif
      Else
        If Not $HiCappingVar.Count Then
          hForm = New CimisAPICap(xNHSI)
          $HiCappingVar = hForm.GetMedicineLimits()
          $HiCapAPIView = hForm.GetCapValidationItems()
        Endif
      Endif

    Endif
  Endif

End

Private Function GetHICapGo(encid As String, sFixCode As String, sFixItem As String, sQty As Float, sDiscType As String) As Boolean

  Dim xgo As Boolean
  Dim xmax As Float

  xgo = True
  If sFixCode Then
    If $HiCappingVar.Exist(sFixCode) Then

      If Not $HiCappingVar[sFixCode] Then
        xgo = False
      Else
        xmax = $HiCappingVar[sFixCode] - modNonMedical.GetPatientItemSavedSalesPackage(encid, sFixItem, sDiscType)
        If xmax < sQty Then
          xgo = False
        Endif
      Endif

    Endif
  Endif

  Return xgo

End

Private Sub BlinkOnSave(stockno As Integer)

  If modBasic.$ShowStorage = "OnSave" Then
    modDevice.SendDataToSerialPort(modStock.GetStorageCodeFromStockNo(stockno))
  Endif

End

Public Sub btnlist_Click()

  GenerateList()

End

Private Sub GenerateList()

  Dim $BillingReport As CReportHTML
  Dim asx As New String[0]
  Dim xtitle As String
  Dim Row As Integer

  If rbencid.Value = True Then
    xtitle = "Encounter"
  Else If rbinvoice.Value = True Then
    xtitle = "Invoice"
  Endif
  $BillingReport = New CReportHTML([("SNo"), ("Location"), xtitle, ("Patient Name"), ("Medicines")], "", "")
  $BillingReport.UserData.Add("Location: " & cmbdepart.Text, "PARAM1")
  $BillingReport.UserData.Add(modReportVar.GetDateTimeReport(Now(), gb.GeneralDate), "PARAM2")

  For Row = 0 To GridView1.Count - 1
    $rData1.MoveTo(Row)
    With asx
      .Add(CStr(Row + 1))
      .Add(modPatient.GetPatientLocation($rData1[$FieldList[0]]))
      .Add($rData1[$FieldList[1]])
      .Add(modPatient.GetPatientNameByEnc($rData1[$FieldList[2]]))
      .Add(modString.TextToHTML(GetMedicineListEncid($rData1[$FieldList[3]]).Join(gb.NewLine)))
    End With
    $BillingReport.Add(asx)
    asx.Clear()
  Next

  modControlSub.OpenHTMLPreview("", $BillingReport.NewHTMLPath(), "ReportSize")

End

Private Function GetMedicineListEncid(encid As String) As String[]

  Dim res As Result
  Dim xxx As String[]

  xxx = New String[]
  res = ExecuteQuery(encid)
  If res.Available Then
    For Each res
      If chkregimen.Value = True Then
        xxx.Add(res["fldroute"] & " " & res["flditem"] & " " & res["flddose"] & "X" & res["fldfreq"] & "X" & res["flddays"] & " QTY: " & res["fldqtydisp"])
      Else
        xxx.Add(res["fldroute"] & " " & res["flditem"] & " QTY: " & res["fldqtydisp"])
      Endif
    Next
  Endif

  Return xxx

End

Public Sub btnsumall_Click()

  ShowSummary()

End

Private Sub ShowSummary()

  Dim $BillingReport As CReportHTML
  Dim asx As New String[0]
  Dim Row As Integer
  Dim sColl As Collection
  Dim xkey As String
  Dim i As Integer

  $BillingReport = New CReportHTML([("SNo"), ("PARTICULARS"), ("QUANTITY")], "", "")
  $BillingReport.UserData.Add("Location: " & cmbdepart.Text, "PARAM1")
  $BillingReport.UserData.Add(modReportVar.GetDateTimeReport(Now(), gb.GeneralDate), "PARAM2")

  sColl = New Collection
  For Row = 0 To GridView1.Count - 1
    $rData1.MoveTo(Row)
    GetMedicineSummaryEncid($rData1[$FieldList[3]], sColl)
  Next

  i = 1
  For Each xkey In sColl.Keys.Sort()
    With asx
      .Add(CStr(i))
      .Add(xkey)
      .Add(sColl[xkey])
    End With
    $BillingReport.Add(asx)
    asx.Clear()
    i = i + 1
  Next

  modControlSub.OpenHTMLPreview("", $BillingReport.NewHTMLPath(), "ReportSize")

End

Private Function GetMedicineSummaryEncid(encid As String, sColl As Collection) As Collection

  Dim res As Result

  res = ExecuteQuery(encid)
  If res.Available Then
    For Each res
      If res["fldqtydisp"] Then
        If sColl.Exist(res["fldroute"] & Space(1) & res["flditem"]) Then
          sColl[res["fldroute"] & Space(1) & res["flditem"]] = sColl[res["fldroute"] & Space(1) & res["flditem"]] + res["fldqtydisp"]
        Else
          sColl.Add(res["fldqtydisp"], res["fldroute"] & Space(1) & res["flditem"])
        Endif
      Endif
    Next
  Endif

  Return sColl

End

Public Sub btnexpogrid_Click()

  Dim xPath As String

  If $encid Then
    xPath = modCHTMLPatient.ShowMedicationOrder($encid)
    modControlSub.OpenHTMLPreview($encid, xPath, "ReportSize")
  Endif

End

Public Sub chkregimen_Click()

  If chkregimen.Value = True Then
    modSettings.SaveSettingsToFile("ShowRegimen/DispensingList", "Yes")
  Else If chkregimen.Value = False Then
    modSettings.SaveSettingsToFile("ShowRegimen/DispensingList", "No")
  Endif

End
