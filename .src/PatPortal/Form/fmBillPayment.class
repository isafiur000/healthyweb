' Gambas class file

Private $encid As String

Private $billAllow As Boolean
Private $rData As Result
Private $aMyFields As String[]

Public Sub _new(encid As String)

  $encid = encid

  If modNonMedical.GetFinanceClearance($encid) = True Then
    $billAllow = False
  Else
    $billAllow = True
  Endif

  If $billAllow = True Then
    SHowRequestedBilling()
  Endif

End

Private Sub SHowRequestedBilling()

  Dim sql As String
  Dim xitem As Float
  Dim xx As Float
  Dim disc As Float
  Dim tax As Float
  Dim xCashCrd As Float

  sql = "select fldid,fldordtime,flditemtype,flditemno,flditemname,flditemrate,flditemqty,flddiscper,fldtaxper,fldditemamt,fldtaxamt,flddiscamt,fldbillingmode,fldsample,fldreason,fldbilltype,flddisctype,fldacledger,fldpayto,fldrefer,fldcashincredit from tblpatbilling where fldencounterval=&1 and fldsave=&2 and fldprint=&3 and fldordcomp like &4 and fldstatus=&5 and flditemqty>&6 ORDER BY fldid DESC"
  $rData = modDatabase.$myConn.Exec(sql, $encid, False, False, "%", "Punched", 0)
  $aMyFields = New String[]
  modGridView.ReadSmallData(GridView1, $rData, $aMyFields)

  xitem = 0
  tax = 0
  disc = 0
  xx = 0
  xCashCrd = 0
  For Each $rData
    xitem = xitem + $rData["flditemrate"] * $rData["flditemqty"]
    tax = tax + $rData["fldtaxamt"]
    disc = disc + $rData["flddiscamt"]
    xx = xx + $rData["fldditemamt"]
    If $rData["fldbilltype"] = "Cash" Then
      xCashCrd = xCashCrd + $rData["fldditemamt"]
    Else If $rData["fldbilltype"] = "Credit" Then
      If $rData["fldcashincredit"] Then
        xCashCrd = xCashCrd + ($rData["fldcashincredit"] / 100) * $rData["fldditemamt"]
      Endif
    Endif
  Next
  txtsubtotalnew.Value = Round(xitem, -2)
  txtdiscnew.Value = Round(disc, -2)
  txtnetotalnew.Value = Round(xx, -2)
  txtpaynew.Value = Round(xCashCrd, -2)

  With GridView1
    .Columns[1].Text = "DateTime"
    .Columns[4].Text = "Particulars"
    .Columns[5].Text = "Rate"
    .Columns[6].Text = "QTY"
    .Columns[7].Text = "Disc%"
    .Columns[8].Text = "Tax%"
    .Columns[9].Text = "Total"
    .Columns[15].Text = "Mode"
    .Columns[16].Text = "Package"
    .Columns[17].Text = "Account"
    .Columns[20].Text = "Cash%"

    .Columns[0].Hidden = True
    .Columns[1].Width = CStr(150 * modBasic.$AppWidthRatio) & "px"
    .Columns[2].Hidden = True
    .Columns[3].Hidden = True
    .Columns[4].Width = CStr(300 * modBasic.$AppWidthRatio) & "px"
    .Columns[5].Width = CStr(75 * modBasic.$AppWidthRatio) & "px"
    .Columns[6].Width = CStr(50 * modBasic.$AppWidthRatio) & "px"
    .Columns[7].Width = CStr(50 * modBasic.$AppWidthRatio) & "px"
    .Columns[8].Width = CStr(50 * modBasic.$AppWidthRatio) & "px"
    .Columns[9].Width = CStr(100 * modBasic.$AppWidthRatio) & "px"
    .Columns[10].Hidden = True
    .Columns[11].Hidden = True
    .Columns[12].Hidden = True
    .Columns[13].Hidden = True
    .Columns[14].Hidden = True
    .Columns[15].Width = CStr(75 * modBasic.$AppWidthRatio) & "px"
    .Columns[16].Width = CStr(125 * modBasic.$AppWidthRatio) & "px"
    .Columns[17].Width = CStr(125 * modBasic.$AppWidthRatio) & "px"
    .Columns[18].Hidden = True
    .Columns[19].Hidden = True
    .Columns[20].Width = CStr(50 * modBasic.$AppWidthRatio) & "px"
  End With

End

Public Sub GridView1_Data(Row As Integer, Column As Integer, Data As WebTableData)

  $rData.MoveTo(Row)
  modGridView.GridViewDecoration(Data, Row)
  If Column = 1 Then
    Data.Text = modReportVar.GetDateTimeReport($rData[$aMyFields[Column]], gb.GeneralDate)
  Else If Column = 18 Then
    Data.Text = modGeneral.GetUserFullName($rData[$aMyFields[Column]])
  Else If Column = 19 Then
    Data.Text = modGeneral.GetUserFullName($rData[$aMyFields[Column]])
  Else
    Data.Text = $rData[$aMyFields[Column]]
  Endif

End

''================== Payment ===========
' Public Sub btnpayment_Click()
'
'   Dim sql As String
'   Dim res As Result
'
'   Dim $billno As String
'   Dim xamt As Float
'
'   Dim xpay As String
'   Dim xIdList As String[]
'   Dim xtot As Float
'
'   xamt = txttotal.Value - txtpaid.Value
'   $billno = "WEB-" & CStr(modBillLock.CurrentWebPayment())
'   If $billno Then
'     If xamt Then
'
'       sql = "select fldid from tblpatbilling where fldencounterval=&1 and fldsave=&2 and fldprint=&3 and fldordcomp like &4 and fldstatus=&5 and flditemqty>&6 and fldextracol IS NULL"
'       res = modDatabase.$myConn.Exec(sql, $encid, False, False, modBasic.$compID, "Requested", 0)
'       xIdList = New String[]
'       If res.Available Then
'         For Each res
'           xIdList.Add(CStr(res["fldid"]))
'         Next
'       Endif
'
'       modDatabase.$myConn.Begin
'       xpay = WebPayment($encid, $billno, xIdList.Join(";"), $FileID, xamt)
'       xtot = modNonMedical.GetWebPaidAmt($billno, $encid)
'       If xtot Then
'         UpdateWithBill($billno)
'         modDatabase.$myConn.Commit
'       Else
'         modDatabase.$myConn.Rollback
'       Endif
'
'     Else
'       modDatabase.$myConn.Begin
'       UpdateWithBill($billno)
'       modDatabase.$myConn.Commit
'
'     Endif
'   Endif
'   SHowRequestedBilling()
'
' Catch
'   modDatabase.$myConn.Rollback
'   modHelpVariable.CreateErrorReport()
'
' End
'
' Private Sub UpdateWithBill(sBillNo As String)
'
'   Dim sql As String
'   Dim res As Result
'   Dim res1 As Result
'
'   sql = "select fldid from tblpatbilling where fldencounterval=&1 and fldsave=&2 and fldprint=&3 and fldordcomp like &4 and fldstatus=&5 and flditemqty>&6 and fldextracol IS NULL"
'   res = modDatabase.$myConn.Exec(sql, $encid, False, False, modBasic.$compID, "Requested", 0)
'   If res.Available Then
'     For Each res
'       res1 = modDatabase.$myConn.Edit("tblpatbilling", "fldid=&1", res["fldid"])
'       res1["fldextracol"] = sBillNo
'       res1.Update
'     Next
'   Endif
'
' End
