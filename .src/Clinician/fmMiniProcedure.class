' Gambas class file

Private $encid As String
Private $BillMode As String
Private $sPackage As String
Private $xFinClear As Boolean
Private $PatientNum As String
Private $xNHISCode As String

Private $rData4 As Result
Private $aMyFields4 As String[]
Private $rData1 As Result
Private $aMyFields1 As String[]
Private $rData3 As Result
Private $aMyFields3 As String[]

Public Sub _new(encid As String, DiscType As String)

  Dim xstatus As String
  Dim accLst As String[]

  $encid = encid
  $sPackage = DiscType
  modGeneralMain.GetOpenModalForm(Me)

  accLst = modBasic.$BillDiscountCash
  If accLst.Count = 0 Then
    accLst.Add($sPackage)
  Endif
  cmbdisctype.List = accLst
  cmbdisctype.Text = $sPackage

  txtpatientname.Text = modPatient.GetPatientNameByEnc($encid)
  $PatientNum = modPatient.GetPatientNoByEnc($encid)
  $xNHISCode = modPatient.GetPatientExtCOdebyEnc($encid)
  ShowBillingParam($sPackage)
  ' $BillMode = modNonMedical.GetDiscBindBillMode($sPackage)
  ' If Not $BillMode Then
  '   $BillMode = modpatient.GetPatBillingMode($encid)
  ' Endif

  cmbsection.List = modControlSub.GetDirectFillresultNoNull(modDatabase.$myConn.Exec("select distinct(fldreport) as col from tblservicecost where flditemtype=&1", "Procedures"))
  cmbsection.Add("All Sections")
  cmbsection.Text = "All Sections"
  xstatus = modPatient.CurrentAdmissionStatus($encid)
  txtlocation.Text = modPatient.GetLocationSetting($encid, xstatus)
  $xFinClear = modNonMedical.GetFinanceClearance($encid)

  btnrefer.Tag = modBillings.GetReferralUserSetting("Procedure", $encid)
  If btnrefer.Tag Then
    btnrefer.Text = modGeneral.GetUserFullName(btnrefer.Tag)
  Endif
  If modBasic.$ReferralLockEntry = "Yes" Then
    btnrefer.Enabled = False
  Endif

  rbminor.Value = True
  FillComboList()
  Unpaidtable()

  If $xFinClear = True Then
    btnsave.Enabled = False
  Endif
  If modBasic.$TabletModeEnable = "Yes" Then
  Else
    txtsearch.SetFocus
  Endif

End

Public Sub TabPanel1_Click()

  If TabPanel1.Index = 1 Then
    SHowSavedGrid()
  Else If TabPanel1.Index = 2 Then
    CompleteGrid()
  Endif

End

Private Sub ShowBillingParam(sPack As String)

  Dim resx As Result

  txtreference.Text = ""
  txtreference.Tag = ""
  resx = modDatabase.$myConn.Exec("select fldmode,fldbillingmode,fldacledger,fldbilltype,fldreference,fldlimit,fldlockstate from tbldiscount where fldtype=&1", sPack)
  If resx.Available Then
    ''billingmode
    If resx["fldbillingmode"] Then
      $BillMode = resx["fldbillingmode"]
    Else
      $BillMode = modpatient.GetPatBillingMode($encid)
    Endif
    ''claim code button
    If resx["fldreference"] Then
      If resx["fldreference"] = "Claim Code" Then
        txtreference.Text = modClaim.GetClaimCidePatient($encid, modNonMedical.GetLastCLaimType($encid))
        If txtreference.Text Then
          txtreference.Tag = modClaim.GetHIClaimState(txtreference.Text)
        Endif
      Endif
    Endif
    ' ''limit
    ' If resx["fldlimit"] = "PatientCreditAMT" Then
    '   txtcreditlimit.Value = modNonMedical.ShowCreditLimitEnc(Trim(txtencid.Text))
    ' Else If resx["fldlimit"] = "PatientDiscount" Then
    '   txtcreditlimit.Value = modNonMedical.GetPatCharityLimit(Trim(txtencid.Text))
    ' Endif
  Endif

End

Public Sub btnscheme_Click()

  If cmbdisctype.Text Then
    ShowBillingParam(cmbdisctype.Text)
    ' $BillMode = modNonMedical.GetDiscBindBillMode(cmbdisctype.Text)
    ' If Not $BillMode Then
    '   $BillMode = modpatient.GetPatBillingMode($encid)
    ' Endif
    FillComboList()
  Endif

End

Public Sub btnselectuser_Click()

  Dim xMedUser As String[]

  xMedUser = MedicalSelectedValue(("Select Payable User"), modBasic.$PayUserList)
  If xMedUser And If xMedUser.Count Then
    btnrefer.Tag = xMedUser[0]
    btnrefer.Text = xMedUser[1]
  Else
    btnrefer.Tag = ""
    btnrefer.Text = ""
  Endif

End

Public Sub btnrefer_Change()

  If btnrefer.Text = "" Then
    btnrefer.Tag = ""
  Endif

End

Private Function GetProcedType() As String

  Dim xtype As String

  If rbminor.Value = True Then
    xtype = "Minor"
  Else If rbextra.Value = True Then
    xtype = "Extra"
  Else If rbplaster.Value = True
    xtype = "Plaster"
  Endif

  Return xtype

End

Public Sub rbminor_Click()

  FillComboList()

End

Public Sub rbextra_Click()

  FillComboList()

End

Public Sub rbplaster_Click()

  FillComboList()

End

Public Sub txtsearch_Change()

  FillComboList()

End

Public Sub cmbsection_Click()

  FillComboList()

End

Private Sub FillComboList()

  Dim sql As String
  Dim res As Result
  Dim xsearch As String
  Dim xsect As String

  If cmbsection.Text = "All Sections" Then
    xsect = ""
  Else
    xsect = db.Subst(" and fldreport=&1", cmbsection.Text)
  Endif

  If Len(txtsearch.Text) Then
    If chkleftmain.Value = True Then
      xsearch = "%" & LCase(txtsearch.Text) & "%"
    Else
      xsearch = LCase(txtsearch.Text) & "%"
    Endif
    sql = "select flditemname as col from tblservicecost where flditemtype=&1 and (fldgroup like &2 or fldgroup=&4) and fldstatus=&3 and fldtarget like &5 and lower(flditemname) like &6" & xsect
  Else
    sql = "select flditemname as col from tblservicecost where flditemtype=&1 and (fldgroup like &2 or fldgroup=&4) and fldstatus=&3 and fldtarget like &5" & xsect
  Endif
  res = modDatabase.$myConn.Exec(sql, "Procedures", $BillMode, "Active", "%", GetProcedType(), xsearch)
  cmbprocedure.List = modControlSub.GetDirectFillresult(res)

End

Public Sub cmbprocedure_Select()

  Dim xdate As Date

  If cmbprocedure.Text Then
    xdate = modBillings.CheckLastSalesItemDate(cmbprocedure.Text, $PatientNum, $xNHISCode, cmbdisctype.Text)
    If xdate Then
      txtlastsaledate.Text = modReportVar.GetDateTimeReport(xdate, gb.MediumDate)
      If DateDiff(xdate, Now(), gb.Month) <= 3 Then
        txtlastsaledate.Foreground = Color.Red
      Else
        txtlastsaledate.Foreground = Color.Default
      Endif
    Else
      txtlastsaledate.Text = ""
      txtlastsaledate.Foreground = Color.Default
    Endif
  Endif

End

Public Sub btnsubOK_Click()

  If $encid And If cmbprocedure.Text Then
    If modMisc.AllowDiagnoBilling($encid) = True Then
      If modNonMedical.AllowEntryWithDeposit($encid, "Procedure") = True Then

        If modBasic.$AutoBillProcedure = "Standard" Or If modBasic.$AutoBillProcedure = "Full" Or If modBasic.$AutoBillProcedure = "Partial" Then
          If chknextvisit.Value = True Then
            modBillings.GetAutoBillingEntry($encid, cmbdisctype.Text, "Procedure", cmbprocedure.Text, 1, "Planned", 0, False, False, "", btnrefer.Tag, GetProcedType())
          Else
            modBillings.GetAutoBillingEntry($encid, cmbdisctype.Text, "Procedure", cmbprocedure.Text, 1, "Punched", 0, False, False, "", btnrefer.Tag, GetProcedType())
          Endif
          Unpaidtable()
        Endif
        Me.Exec(Subst("Toastify({text: '&1', duration: &2}).showToast()", "Information saved", modBasic.$BalloonDelay))

      Endif
    Else
      Message.Warning("Diagnosis not provided", ("OK"))
    Endif
  Endif

End

Public Sub Unpaidtable()

  Dim sql As String

  sql = "select fldid,fldordtime,flditemname,fldstatus,fldid,fldreason from tblpatbilling where fldencounterval=&1 and flditemtype=&2 and fldsave=&3 and (fldstatus=&4 or fldstatus=&5) and fldordcomp=&6 and (fldtarget=&7 or fldtarget=&8 or fldtarget=&9) and (flditemqty-fldretqty)>&{10}"
  $rData4 = modDatabase.$myConn.Exec(sql, $encid, "Procedures", False, "Punched", "Planned", modBasic.$compID, "Minor", "Extra", "Plaster", 0)
  $aMyFields4 = New String[]
  modGridView.ReadSmallData(GridView4, $rData4, $aMyFields4)

  With GridView4
    .Columns[0].Hidden = True
    .Columns[1].Width = CStr(150 * modBasic.$AppWidthRatio) & "px"
    .Columns[2].Width = CStr(275 * modBasic.$AppWidthRatio) & "px"
    .Columns[3].Width = CStr(75 * modBasic.$AppWidthRatio) & "px"
    .Columns[4].Hidden = True
    .Columns[5].Hidden = True

    .Columns[1].Text = "DateTime"
    .Columns[2].Text = "Procedure"
    .Columns[3].Text = "Status"
  End With

End

Public Sub GridView4_Data(Row As Integer, Column As Integer, Data As WebTableData)

  $rData4.MoveTo(Row)
  modGridView.GridViewDecoration(Data, Row)
  If Column = 1 Then
    Data.Text = modReportVar.GetDateTimeReport($rData4[$aMyFields4[Column]], gb.GeneralDate)
  Else
    Data.Text = $rData4[$aMyFields4[Column]]
  Endif

End

Public Sub btnbilldel_Click()

  If GridView4.Selection.Count Then
    If Message.Question(("Are you sure?"), ("No"), ("Yes")) = 2 Then
      $rData4.MoveTo(GridView4.Selection[0])
      modDatabase.$myConn.Delete("tblpatbilling", "fldid=&1 and fldsave=&2", $rData4["fldid"], False)
      Unpaidtable()
    Endif
  Endif

End

Public Sub btncomment_Click()

  Dim xx As String
  Dim res As Result

  If GridView4.Selection.Count Then
    $rData4.MoveTo(GridView4.Selection[0])
    xx = GetTextArea($rData4["flditemname"], $rData4["fldreason"])
    If xx Then
      res = modDatabase.$myConn.Edit("tblpatbilling", "fldid=&1", $rData4["fldid"])
      res["fldreason"] = xx
      res["xyz"] = False
      res.Update
      Unpaidtable()
    Endif
  Endif

End

Public Sub btnsave_Click()

  Dim res As Result
  Dim xadv As String

  res = modDatabase.$myConn.Edit("tblpatbilling", "fldencounterval=&1 and flditemtype=&2 and fldsave=&3 and fldstatus=&4 and fldordcomp=&5 and (fldtarget=&6 or fldtarget=&7 or fldtarget=&8)", $encid, "Procedures", False, "Punched", modBasic.$compID, "Minor", "Extra", "Plaster")                 ''
  If res.Available Then
    If modBasic.$AutoBillAdvReceipt = "Enable" Then
      xadv = modBillLock.AdvanceReceiptString("Advance Receipt")
    Else
      xadv = ""
    Endif

    For Each res

      If modBasic.$AutoBillProcedure = "Standard" Then
        If modNonMedical.AllowPreCheckDeposit($encid, res["fldditemamt"], res["fldbilltype"]) = True Then
          SavePartialEntry(res, xadv)
        Endif
      Else If modBasic.$AutoBillProcedure = "Full" Then
        If modNonMedical.AllowPreEntryWithDeposit($encid, "Procedure", res["fldditemamt"], res["fldbilltype"]) = True Then
          SavePartialEntry(res, xadv)
        Endif
      Else
        If modBasic.$AutoBillSaveZero = "Yes" And If res["flditemrate"] = 0 Then
          SavePartialEntry(res, xadv)
        Else If modBasic.$AutoBillSaveZero = "Yes" And If res["flddiscper"] = 100 Then
          SavePartialEntry(res, xadv)
        Else If modBasic.$AutoBillSaveFullCredit = "Yes" And If res["fldbilltype"] = "Credit" And If res["fldcashincredit"] = 0 Then
          SavePartialEntry(res, xadv)
        Endif
      Endif

    Next
  Endif

  SHowSavedGrid()
  Unpaidtable()

End

Private Sub SavePartialEntry(res As Result, Optional advReceipt As String)

  Dim xdate As Date
  Dim xcapday As Integer
  Dim xgo As Boolean

  xgo = True
  If txtreference.Tag = "Consultation" Or If txtreference.Tag = "Patient Ward" Then
    xdate = modBillings.CheckLastSalesItemDate(res["flditemname"], $PatientNum, $xNHISCode, res["flddisctype"])
    If xdate Then
      xcapday = modNonMedical.GetCappingDayFromItemName(res["flditemname"])
      If xcapday Then
        If DateDiff(xdate, Now(), gb.Day) <= xcapday Then
          xgo = False
        Endif
      Endif
    Endif
  Endif
  If xgo = True Then
    res["fldstatus"] = "Done"
    If advReceipt Then
      res["fldextracol"] = advReceipt
    Endif
    res["fldsave"] = True
    res["flduserid"] = modBasic.$lbluser
    res["fldtime"] = Now()
    res["fldcomp"] = modBasic.$compID
    res["xyz"] = False
    res.Update()
  Endif

End

''====================== Paid ===================================
Private Sub SHowSavedGrid()

  Dim sql As String

  sql = "select fldid,fldtime,flditemname,fldrefer,fldbillno,fldreason from tblpatbilling where fldencounterval=&1 and flditemtype=&2 and fldsave=&3 and (fldstatus=&4 or fldstatus=&5) and fldsample=&6 and (fldtarget=&7 or fldtarget=&8 or fldtarget=&9) and (flditemqty-fldretqty)>&{10} and fldid NOT IN(select fldgroupid from tblpatgeneral where fldencounterval=&1)"
  $rData1 = modDatabase.$myConn.Exec(sql, $encid, "Procedures", True, "Done", "Cleared", "Waiting", "Minor", "Extra", "Plaster", 0)
  $aMyFields1 = New String[]
  modGridView.ReadSmallData(GridView2, $rData1, $aMyFields1)

  With GridView2
    .Columns[0].Hidden = True
    .Columns[1].Width = CStr(150 * modBasic.$AppWidthRatio) & "px"
    .Columns[2].Width = CStr(325 * modBasic.$AppWidthRatio) & "px"
    .Columns[3].Width = CStr(125 * modBasic.$AppWidthRatio) & "px"
    .Columns[4].Width = CStr(150 * modBasic.$AppWidthRatio) & "px"
    .Columns[5].Width = CStr(200 * modBasic.$AppWidthRatio) & "px"

    .Columns[1].Text = "DateTime"
    .Columns[2].Text = "Procedure"
    .Columns[3].Text = "ReferBy"
    .Columns[4].Text = "Invoice"
    .Columns[5].Text = "Comment"
  End With

End

Public Sub GridView2_Data(Row As Integer, Column As Integer, Data As WebTableData)

  $rData1.MoveTo(Row)
  modGridView.GridViewDecoration(Data, Row)
  If Column = 1 Then
    Data.Text = modReportVar.GetDateTimeReport($rData1[$aMyFields1[Column]], gb.GeneralDate)
  Else If Column = 3 Then
    Data.Text = modGeneral.GetUserFullName($rData1[$aMyFields1[Column]])
  Else
    Data.Text = $rData1[$aMyFields1[Column]]
  Endif

End

Public Sub GridView2_Select()

  If GridView2.Selection.Count Then
    $rData1.MoveTo(GridView2.Selection[0])
    txtprocindex.Value = $rData1["fldid"]
    lblproced.Text = $rData1["flditemname"]
  Endif

End

Public Sub btnsavesumm_Click()

  If txtprocindex.Value And If txtsummary.RichText Then
    modPatientGeneral.AddProcedureData($encid, txtprocindex.Value, "Minor Procedures", lblproced.Text, "Done", $BillMode, Now(), "Cleared", txtsummary.RichText)
    SHowSavedGrid()
    CompleteGrid()
    Me.Exec(Subst("Toastify({text: '&1', duration: &2}).showToast()", "Information saved", modBasic.$BalloonDelay))
  Endif

End

' Public Sub btnsave_Click()
'
'   Dim res As Result
'   Dim res1 As Result
'
'   Dim xrefer As String
'   Dim xpayble As String
'
'   If btnrefer.Tag Then
'     xrefer = btnrefer.Tag
'   Else
'     xrefer = modBillings.GetReferralUserSetting("Procedure", $encid)
'   Endif
'   xpayble = modBillings.GetPayableUserSetting("Procedure", $encid)
'
'   res = modDatabase.$myConn.Exec("select fldid,fldencounterval,fldgroupid,fldnewdate,flditem,fldreportquali,flddetail,fldtime from tblpatgeneral where fldencounterval=&1 and fldinput=&2 and fldsave=&3 and fldcomp=&4 and fldreportquali=&5 and fldstatus=&6", $encid, "Minor Procedures", False, modBasic.$compID, "Done", "Waiting")                                      ''
'   If res.Available = True Then
'
'     modDatabase.$myConn.Begin
'     For Each res
'       If modBasic.$AutoBillProcedure Then
'         If modBasic.$AutoBillProcedure = "Standard" Then
'           modBillings.GetAutoBillingEntry($encid, cmbdisctype.Text, "Procedure", res["flditem"], 1, "Done", res["fldid"], True, False, xpayble, xrefer)
'         Else If modBasic.$AutoBillProcedure = "Full" Then
'           modBillings.GetAutoBillingEntry($encid, cmbdisctype.Text, "Procedure", res["flditem"], 1, "Done", res["fldid"], True, False, xpayble, xrefer)                          ''
'         Else If modBasic.$AutoBillProcedure = "Partial" Then
'           modBillings.GetAutoBillingEntry($encid, cmbdisctype.Text, "Procedure", res["flditem"], 1, "Punched", res["fldid"], False, False, xpayble, xrefer)
'         Endif
'       Endif
'       res1 = modDatabase.$myConn.Edit("tblpatgeneral", "fldid=&1", res["fldid"])
'       res1["fldstatus"] = "Cleared"
'       res1["fldsave"] = True
'       res1["flduserid"] = modBasic.$lbluser
'       res1["flduptime"] = Now()
'       res1["fldcomp"] = modBasic.$compID
'       res1["xyz"] = False
'       res1.Update()
'     Next
'     modDatabase.$myConn.Commit
'     FillLabtable()
'     CompleteGrid()
'
'     Balloon.Info(("Information saved"), btnsave)
'     Balloon.Delay = modBasic.$BalloonDelay
'   Endif
'
' Catch
'   modDatabase.$myConn.Rollback
'   modHelpVariable.CreateErrorReport()
'
' End

Public Sub btnsummary_Click()

  txtsummary.RichText = txtsummary.RichText & modCloudAI.GetPatCloudAIResponse($encid, txtsummary.Text)

End

Public Sub dctsummary_Click()

  If lblproced.Text Then
    txtsummary.RichText = txtsummary.RichText & Space(1) & modFillContainer.GetExtraTextArea(lblproced.Text, txtsummary.Text)
  Endif

End

Public Sub btntemplsumm_Click()

  If lblproced.Text Then
    txtsummary.RichText = txtsummary.RichText & DictionaryVIew(lblproced.Text)
  Endif

End

''========================= completed ===========================================
Private Sub CompleteGrid()

  Dim sql As String

  sql = "select fldid,fldtime,fldencounterval,flditem,fldreportquali,flduserid,fldcomp from tblpatgeneral where fldencounterval=&1 and fldinput=&2 and fldsave=&3 and fldreportquali=&4 and fldstatus=&5"                                             ''
  $rData3 = modDatabase.$myConn.Exec(sql, $encid, "Minor Procedures", False, "Done", "Cleared")
  $aMyFields3 = New String[]
  modGridView.ReadSmallData(GridView3, $rData3, $aMyFields3)

  With GridView3
    .Columns[0].Hidden = True
    .Columns[1].Width = CStr(150 * modBasic.$AppWidthRatio) & "px"
    .Columns[2].Hidden = True
    .Columns[3].Width = CStr(375 * modBasic.$AppWidthRatio) & "px"
    .Columns[4].Width = CStr(100 * modBasic.$AppWidthRatio) & "px"
    .Columns[5].Width = CStr(125 * modBasic.$AppWidthRatio) & "px"
    .Columns[6].Width = CStr(100 * modBasic.$AppWidthRatio) & "px"

    .Columns[1].Text = "DateTime"
    .Columns[3].Text = "Procedure"
    .Columns[4].Text = "Status"
    .Columns[5].Text = "User"
    .Columns[6].Text = "Location"
  End With

End

Public Sub GridView3_Data(Row As Integer, Column As Integer, Data As WebTableData)

  $rData3.MoveTo(Row)
  modGridView.GridViewDecoration(Data, Row)
  If Column = 1 Then
    Data.Text = modReportVar.GetDateTimeReport($rData3[$aMyFields3[Column]], gb.GeneralDate)
  Else
    Data.Text = $rData3[$aMyFields3[Column]]
  Endif

End

Public Sub btnclose_Click()

  Me.Close()

End
