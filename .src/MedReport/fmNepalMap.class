' Gambas class file

Private $rData1 As Result
Private $aMyFields1 As String[]
Private $locatMode As String
Private $HFType As String = "Hospital"

Private ServList As String[] = ["Consultation", "Admission", "Discharge", "Referred", "Death", "Delivery", "Laboratory", "Radiology", "Examination", "Major Procedures"]
Private $hospList As String[]
Private xconsultColl As Collection
Private xdeliveryColl As Collection
Private xlaboraColl As Collection
Private xradioColl As Collection
Private xexaminatColl As Collection
Private xmajprocedColl As Collection
Private xadmissionColl As Collection
Private xdischargeColl As Collection
Private xreferColl As Collection
Private xdeathColl As Collection

Public Sub _new()

  cmblocation.List = ["Hospital", "Municipality", "Category", "District", "Province"]
  $locatMode = "Hospital"
  rbsummary.Value = True
  SetLocations()

End

Public Sub mnuformat_Click()

  Dim aList As String[] = ["Hospital", "Municipality", "Category", "District", "Province"]
  Dim xx As String

  xx = InputCombo("Select Row Format", "Row Format", aList, "Hospital", True)
  If xx Then
    $locatMode = xx
  Else
    $locatMode = "Hospital"
  Endif
  SetLocations()

End

Private Sub SetLocations()

  If modBasic.$HospCode Then
    If modDataRepo.$RepositoryMode = "Hospital" Then
    Else
      If cmbvalue.Text Then
        $hospList = modDataRepo.GetRepoValueListSelectedType($locatMode, modBasic.$HospCode, $HFType, cmblocation.Text, cmbvalue.Text)
      Else
        $hospList = modDataRepo.GetRepoValueListSelectedType($locatMode, modBasic.$HospCode, $HFType)
      Endif
    Endif
  Else
    If cmbvalue.Text Then
      $hospList = modDataRepo.GetRepoValueListType($locatMode, $HFType, cmblocation.Text, cmbvalue.Text)
    Else
      $hospList = modDataRepo.GetRepoValueListType($locatMode, $HFType)
    Endif
  Endif

End

Public Sub cmblocation_Click()

  If cmbvalue.List.Count Then
    cmbvalue.List.Clear()
  Endif
  cmbvalue.Text = ""
  If modBasic.$HospCode Then
    If modDataRepo.$RepositoryMode = "Hospital" Then
    Else
      cmbvalue.List = modDataRepo.GetRepoValueListSelectedType(cmblocation.Text, modBasic.$HospCode, $HFType)
    Endif
  Else
    cmbvalue.List = modDataRepo.GetRepoValueListType(cmblocation.Text, $HFType)
  Endif
  SetLocations()

End

Private Sub ShowAllGrids()

  LoadSummaryData()
  LoadSurveillanceData()

End

Public Sub dtnepfir_Click()

  Dim xx As String

  xx = BSDateFormat(("Enter BS Date in yyyy/mm/dd format"), ("Date Converter"), modDate.ConvertToLocaldate(dtfir.Value))
  If xx Then
    dtfir.Value = modDate.ConvertToEnglishdate(xx)
  Endif

End

Public Sub dtneplast_Click()

  Dim xx As String

  xx = BSDateFormat(("Enter BS Date in yyyy/mm/dd format"), ("Date Converter"), modDate.ConvertToLocaldate(dtlast.Value))
  If xx Then
    dtlast.Value = modDate.ConvertToEnglishdate(xx)
  Endif

End

Public Sub btnfiscal_Click()

  Dim res As Result
  Dim xyear As String

  GetNormalButtons()
  xyear = InputCombo("Select Fiscal Year Range", "Select Year", modBasic.$FiscalYearList, "", True)
  If xyear Then
    res = modDatabase.$myConn.Exec("select fldfrom,fldend from tblfiscalid where fldlabel=&1", xyear)
    If res.Available Then
      res.MoveFirst
      dtfir.Value = res["fldfrom"]
      dtlast.Value = res["fldend"]
    Endif
  Endif

End

''--------------- Get Data -----------
Public Sub btnshow_Click()

  SetLocations()
  ShowAllGrids()

End

Public Sub btntoday_Click()

  GetNormalButtons()
  dtfir.Value = modDate.StartSqlDate(Now())
  dtlast.Value = modDate.EndSqlDate(Now())
  SetLocations()
  ShowAllGrids()
  btntoday.Background = Color.LightGray

End

Public Sub btnyesterday_Click()

  GetNormalButtons()
  dtfir.Value = modDate.StartSqlDate(DateAdd(Now(), gb.Day, -1))
  dtlast.Value = modDate.EndSqlDate(DateAdd(Now(), gb.Day, -1))
  SetLocations()
  ShowAllGrids()
  btnyesterday.Background = Color.LightGray

End

Public Sub btnthismonth_Click()

  GetNormalButtons()
  If modBasic.$DateFormat = "BS Date" Then
    dtfir.Value = modDate.StartSqlMonthBS(Now())
    dtlast.Value = modDate.EndSqlMonthBS(Now())
  Else
    dtfir.Value = modDate.StartSqlMonth(Now())
    dtlast.Value = modDate.EndSqlMonth(Now())
  Endif
  SetLocations()
  ShowAllGrids()
  btnthismonth.Background = Color.LightGray

End

Public Sub btnlastmonth_Click()

  GetNormalButtons()
  If modBasic.$DateFormat = "BS Date" Then
    dtfir.Value = modDate.StartSqlMonthBS(DateAdd(Now(), gb.Month, -1))
    dtlast.Value = modDate.EndSqlMonthBS(DateAdd(Now(), gb.Month, -1))
  Else
    dtfir.Value = modDate.StartSqlMonth(DateAdd(Now(), gb.Month, -1))
    dtlast.Value = modDate.EndSqlMonth(DateAdd(Now(), gb.Month, -1))
  Endif
  SetLocations()
  ShowAllGrids()
  btnlastmonth.Background = Color.LightGray

End

Public Sub btnthisyear_Click()

  GetNormalButtons()
  If modBasic.$DateFormat = "BS Date" Then
    dtfir.Value = modDate.StartSqlYearBS(Now())
    dtlast.Value = modDate.EndSqlYearBS(Now())
  Else
    dtfir.Value = modDate.StartSqlYear(Now())
    dtlast.Value = modDate.EndSqlYear(Now())
  Endif
  SetLocations()
  ShowAllGrids()
  btnthisyear.Background = Color.LightGray

End

Public Sub btnlastyear_Click()

  GetNormalButtons()
  If modBasic.$DateFormat = "BS Date" Then
    dtfir.Value = modDate.StartSqlYearBS(DateAdd(Now(), gb.Year, -1))
    dtlast.Value = modDate.EndSqlYearBS(DateAdd(Now(), gb.Year, -1))
  Else
    dtfir.Value = modDate.StartSqlYear(DateAdd(Now(), gb.Year, -1))
    dtlast.Value = modDate.EndSqlYear(DateAdd(Now(), gb.Year, -1))
  Endif
  SetLocations()
  ShowAllGrids()
  btnlastyear.Background = Color.LightGray

End

Private Sub GetNormalButtons()

  btntoday.Background = Color.Default
  btnyesterday.Background = Color.Default
  btnthismonth.Background = Color.Default
  btnlastmonth.Background = Color.Default
  btnthisyear.Background = Color.Default
  btnlastyear.Background = Color.Default

End

''=============================== SUMMARY ===========================
Private Function GetCollectionData(res As Result) As Collection

  Dim xcoll As Collection

  xcoll = New Collection
  If res.Available Then
    For Each res

      If $locatMode = "Municipality" Then
        If res["tblhospitals.fldpality"] Then
          xcoll.Add(res["xtotal"], res["tblhospitals.fldpality"])
        Endif
      Else If $locatMode = "Category" Then
        If res["tblhospitals.fldcategory"] Then
          xcoll.Add(res["xtotal"], res["tblhospitals.fldcategory"])
        Endif
      Else If $locatMode = "District" Then
        If res["tblhospitals.flddistrict"] Then
          xcoll.Add(res["xtotal"], res["tblhospitals.flddistrict"])
        Endif
      Else If $locatMode = "Province" Then
        If res["tblhospitals.fldprovince"] Then
          xcoll.Add(res["xtotal"], res["tblhospitals.fldprovince"])
        Endif
      Else
        If res["fldhospcode"] Then
          xcoll.Add(res["xtotal"], res["fldhospcode"])
        Endif
      Endif
    Next
  Endif
  Return xcoll

End

Private Function GetTotalArray(sColl As Collection) As Integer

  Dim sKey As Integer
  Dim xtot As Integer

  xtot = 0
  For Each sKey In sColl
    If $hospList.Exist(sColl.Key) Then
      xtot = xtot + sKey
    Endif
  Next

  Return xtot

End

Private Function RepoString(sTable As String) As String

  Dim xRepostr As String

  If modBasic.$HospCode Then
    If $locatMode = "Hospital" Then
      xRepostr = modDataRepo.GetRepoLastStr(sTable)
    Else
      If modDataRepo.$RepositoryMode = "Category" Then
        xRepostr = db.Subst(" and tblhospitals.fldcategory like &1", modBasic.$HospCode)
      Else If modDataRepo.$RepositoryMode = "District" Then
        xRepostr = db.Subst(" and tblhospitals.flddistrict like &1", modBasic.$HospCode)
      Else If modDataRepo.$RepositoryMode = "Province" Then
        xRepostr = db.Subst(" and tblhospitals.fldprovince like &1", modBasic.$HospCode)
      Else If modDataRepo.$RepositoryMode = "Municipality" Then
        xRepostr = db.Subst(" and tblhospitals.fldpality like &1", modBasic.$HospCode)
      Else
        xRepostr = db.Subst(" and tblhospitals.fldhospcode like &1", modBasic.$HospCode)
      Endif
    Endif
  Else
    xRepostr = ""
  Endif

  Return xRepostr

End

Private Sub LoadSummaryData()

  Dim i As Integer
  Dim xstr As String
  Dim hospTyp As String

  If cmbvalue.Text Then
    If cmblocation.Text = "Category" Then
      xstr = db.Subst(" and tblhospitals.fldcategory like &1", cmbvalue.Text)
    Else If cmblocation.Text = "District" Then
      xstr = db.Subst(" and tblhospitals.flddistrict like &1", cmbvalue.Text)
    Else If cmblocation.Text = "Province" Then
      xstr = db.Subst(" and tblhospitals.fldprovince like &1", cmbvalue.Text)
    Else If cmblocation.Text = "Municipality" Then
      xstr = db.Subst(" and tblhospitals.fldpality like &1", cmbvalue.Text)
    Else
      xstr = db.Subst(" and tblhospitals.fldhospcode like &1", cmbvalue.Text)
    Endif
  Else
    xstr = ""
  Endif
  hospTyp = db.Subst(" and tblhospitals.fldcategory=&1", $HFType)

  If $locatMode = "Municipality" Then
    xconsultColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldpality,COUNT(tblconsult.fldencounterval) as xtotal from tblconsult inner join tblhospitals on tblconsult.fldhospcode=tblhospitals.fldhospcode where tblconsult.fldconsulttime>=&1 and tblconsult.fldconsulttime<=&2" & hospTyp & RepoString("tblconsult") & xstr & " GROUP BY tblhospitals.fldpality", dtfir.Value, dtlast.Value))                    ''
    xadmissionColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldpality,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3" & hospTyp & RepoString("tblpatientdate") & xstr & " GROUP BY tblhospitals.fldpality", dtfir.Value, dtlast.Value, "Admitted"))
    xdischargeColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldpality,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3" & hospTyp & RepoString("tblpatientdate") & xstr & " GROUP BY tblhospitals.fldpality", dtfir.Value, dtlast.Value, "Discharged"))
    xreferColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldpality,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3" & hospTyp & RepoString("tblpatientdate") & xstr & " GROUP BY tblhospitals.fldpality", dtfir.Value, dtlast.Value, "Refer"))
    xdeathColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldpality,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3" & hospTyp & RepoString("tblpatientdate") & xstr & " GROUP BY tblhospitals.fldpality", dtfir.Value, dtlast.Value, "Death"))
    xdeliveryColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldpality,COUNT(tblconfinement.fldencounterval) as xtotal from tblconfinement inner join tblhospitals on tblconfinement.fldhospcode=tblhospitals.fldhospcode where tblconfinement.flddeltime>=&1 and tblconfinement.flddeltime<=&2" & hospTyp & RepoString("tblconfinement") & xstr & " GROUP BY tblhospitals.fldpality", dtfir.Value, dtlast.Value))
    xlaboraColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldpality,COUNT(tblpatlabtest.fldencounterval) as xtotal from tblpatlabtest inner join tblhospitals on tblpatlabtest.fldhospcode=tblhospitals.fldhospcode where tblpatlabtest.fldtime_report>=&1 and tblpatlabtest.fldtime_report<=&2" & hospTyp & RepoString("tblpatlabtest") & xstr & " GROUP BY tblhospitals.fldpality", dtfir.Value, dtlast.Value))
    xradioColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldpality,COUNT(tblpatradiotest.fldencounterval) as xtotal from tblpatradiotest inner join tblhospitals on tblpatradiotest.fldhospcode=tblhospitals.fldhospcode where tblpatradiotest.fldtime_report>=&1 and tblpatradiotest.fldtime_report<=&2" & hospTyp & RepoString("tblpatradiotest") & xstr & " GROUP BY tblhospitals.fldpality", dtfir.Value, dtlast.Value))
    xexaminatColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldpality,COUNT(tblpatientexam.fldencounterval) as xtotal from tblpatientexam inner join tblhospitals on tblpatientexam.fldhospcode=tblhospitals.fldhospcode where tblpatientexam.fldtime>=&1 and tblpatientexam.fldtime<=&2" & hospTyp & RepoString("tblpatientexam") & xstr & " GROUP BY tblhospitals.fldpality", dtfir.Value, dtlast.Value))
    xmajprocedColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldpality,COUNT(tblpatgeneral.fldencounterval) as xtotal from tblpatgeneral inner join tblhospitals on tblpatgeneral.fldhospcode=tblhospitals.fldhospcode where tblpatgeneral.fldtime>=&1 and tblpatgeneral.fldtime<=&2 and tblpatgeneral.fldinput=&3" & hospTyp & RepoString("tblpatgeneral") & xstr & " GROUP BY tblhospitals.fldpality", dtfir.Value, dtlast.Value, "Procedures"))

  Else If $locatMode = "Category" Then
    xconsultColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldcategory,COUNT(tblconsult.fldencounterval) as xtotal from tblconsult inner join tblhospitals on tblconsult.fldhospcode=tblhospitals.fldhospcode where tblconsult.fldconsulttime>=&1 and tblconsult.fldconsulttime<=&2" & hospTyp & RepoString("tblconsult") & xstr & " GROUP BY tblhospitals.fldcategory", dtfir.Value, dtlast.Value))                    ''
    xadmissionColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldcategory,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3" & hospTyp & RepoString("tblpatientdate") & xstr & " GROUP BY tblhospitals.fldcategory", dtfir.Value, dtlast.Value, "Admitted"))
    xdischargeColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldcategory,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3" & hospTyp & RepoString("tblpatientdate") & xstr & " GROUP BY tblhospitals.fldcategory", dtfir.Value, dtlast.Value, "Discharged"))
    xreferColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldcategory,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3" & hospTyp & RepoString("tblpatientdate") & xstr & " GROUP BY tblhospitals.fldcategory", dtfir.Value, dtlast.Value, "Refer"))
    xdeathColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldcategory,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3" & hospTyp & RepoString("tblpatientdate") & xstr & " GROUP BY tblhospitals.fldcategory", dtfir.Value, dtlast.Value, "Death"))
    xdeliveryColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldcategory,COUNT(tblconfinement.fldencounterval) as xtotal from tblconfinement inner join tblhospitals on tblconfinement.fldhospcode=tblhospitals.fldhospcode where tblconfinement.flddeltime>=&1 and tblconfinement.flddeltime<=&2" & hospTyp & RepoString("tblconfinement") & xstr & " GROUP BY tblhospitals.fldcategory", dtfir.Value, dtlast.Value))
    xlaboraColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldcategory,COUNT(tblpatlabtest.fldencounterval) as xtotal from tblpatlabtest inner join tblhospitals on tblpatlabtest.fldhospcode=tblhospitals.fldhospcode where tblpatlabtest.fldtime_report>=&1 and tblpatlabtest.fldtime_report<=&2" & hospTyp & RepoString("tblpatlabtest") & xstr & " GROUP BY tblhospitals.fldcategory", dtfir.Value, dtlast.Value))
    xradioColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldcategory,COUNT(tblpatradiotest.fldencounterval) as xtotal from tblpatradiotest inner join tblhospitals on tblpatradiotest.fldhospcode=tblhospitals.fldhospcode where tblpatradiotest.fldtime_report>=&1 and tblpatradiotest.fldtime_report<=&2" & hospTyp & RepoString("tblpatradiotest") & xstr & " GROUP BY tblhospitals.fldcategory", dtfir.Value, dtlast.Value))
    xexaminatColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldcategory,COUNT(tblpatientexam.fldencounterval) as xtotal from tblpatientexam inner join tblhospitals on tblpatientexam.fldhospcode=tblhospitals.fldhospcode where tblpatientexam.fldtime>=&1 and tblpatientexam.fldtime<=&2" & hospTyp & RepoString("tblpatientexam") & xstr & " GROUP BY tblhospitals.fldcategory", dtfir.Value, dtlast.Value))
    xmajprocedColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldcategory,COUNT(tblpatgeneral.fldencounterval) as xtotal from tblpatgeneral inner join tblhospitals on tblpatgeneral.fldhospcode=tblhospitals.fldhospcode where tblpatgeneral.fldtime>=&1 and tblpatgeneral.fldtime<=&2 and tblpatgeneral.fldinput=&3" & hospTyp & RepoString("tblpatgeneral") & xstr & " GROUP BY tblhospitals.fldcategory", dtfir.Value, dtlast.Value, "Procedures"))

  Else If $locatMode = "District" Then
    xconsultColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.flddistrict,COUNT(tblconsult.fldencounterval) as xtotal from tblconsult inner join tblhospitals on tblconsult.fldhospcode=tblhospitals.fldhospcode where tblconsult.fldconsulttime>=&1 and tblconsult.fldconsulttime<=&2" & hospTyp & RepoString("tblconsult") & xstr & " GROUP BY tblhospitals.flddistrict", dtfir.Value, dtlast.Value))                    ''
    xadmissionColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.flddistrict,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3" & hospTyp & RepoString("tblpatientdate") & xstr & " GROUP BY tblhospitals.flddistrict", dtfir.Value, dtlast.Value, "Admitted"))
    xdischargeColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.flddistrict,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3" & hospTyp & RepoString("tblpatientdate") & xstr & " GROUP BY tblhospitals.flddistrict", dtfir.Value, dtlast.Value, "Discharged"))
    xreferColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.flddistrict,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3" & hospTyp & RepoString("tblpatientdate") & xstr & " GROUP BY tblhospitals.flddistrict", dtfir.Value, dtlast.Value, "Refer"))
    xdeathColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.flddistrict,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3" & hospTyp & RepoString("tblpatientdate") & xstr & " GROUP BY tblhospitals.flddistrict", dtfir.Value, dtlast.Value, "Death"))
    xdeliveryColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.flddistrict,COUNT(tblconfinement.fldencounterval) as xtotal from tblconfinement inner join tblhospitals on tblconfinement.fldhospcode=tblhospitals.fldhospcode where tblconfinement.flddeltime>=&1 and tblconfinement.flddeltime<=&2" & hospTyp & RepoString("tblconfinement") & xstr & " GROUP BY tblhospitals.flddistrict", dtfir.Value, dtlast.Value))
    xlaboraColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.flddistrict,COUNT(tblpatlabtest.fldencounterval) as xtotal from tblpatlabtest inner join tblhospitals on tblpatlabtest.fldhospcode=tblhospitals.fldhospcode where tblpatlabtest.fldtime_report>=&1 and tblpatlabtest.fldtime_report<=&2" & hospTyp & RepoString("tblpatlabtest") & xstr & " GROUP BY tblhospitals.flddistrict", dtfir.Value, dtlast.Value))
    xradioColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.flddistrict,COUNT(tblpatradiotest.fldencounterval) as xtotal from tblpatradiotest inner join tblhospitals on tblpatradiotest.fldhospcode=tblhospitals.fldhospcode where tblpatradiotest.fldtime_report>=&1 and tblpatradiotest.fldtime_report<=&2" & hospTyp & RepoString("tblpatradiotest") & xstr & " GROUP BY tblhospitals.flddistrict", dtfir.Value, dtlast.Value))
    xexaminatColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.flddistrict,COUNT(tblpatientexam.fldencounterval) as xtotal from tblpatientexam inner join tblhospitals on tblpatientexam.fldhospcode=tblhospitals.fldhospcode where tblpatientexam.fldtime>=&1 and tblpatientexam.fldtime<=&2" & hospTyp & RepoString("tblpatientexam") & xstr & " GROUP BY tblhospitals.flddistrict", dtfir.Value, dtlast.Value))
    xmajprocedColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.flddistrict,COUNT(tblpatgeneral.fldencounterval) as xtotal from tblpatgeneral inner join tblhospitals on tblpatgeneral.fldhospcode=tblhospitals.fldhospcode where tblpatgeneral.fldtime>=&1 and tblpatgeneral.fldtime<=&2 and tblpatgeneral.fldinput=&3" & hospTyp & RepoString("tblpatgeneral") & xstr & " GROUP BY tblhospitals.flddistrict", dtfir.Value, dtlast.Value, "Procedures"))

  Else If $locatMode = "Province" Then
    xconsultColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldprovince,COUNT(tblconsult.fldencounterval) as xtotal from tblconsult inner join tblhospitals on tblconsult.fldhospcode=tblhospitals.fldhospcode where tblconsult.fldconsulttime>=&1 and tblconsult.fldconsulttime<=&2" & hospTyp & RepoString("tblconsult") & xstr & " GROUP BY tblhospitals.fldprovince", dtfir.Value, dtlast.Value))                    ''
    xadmissionColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldprovince,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3" & hospTyp & RepoString("tblpatientdate") & xstr & " GROUP BY tblhospitals.fldprovince", dtfir.Value, dtlast.Value, "Admitted"))
    xdischargeColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldprovince,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3" & hospTyp & RepoString("tblpatientdate") & xstr & " GROUP BY tblhospitals.fldprovince", dtfir.Value, dtlast.Value, "Discharged"))
    xreferColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldprovince,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3" & hospTyp & RepoString("tblpatientdate") & xstr & " GROUP BY tblhospitals.fldprovince", dtfir.Value, dtlast.Value, "Refer"))
    xdeathColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldprovince,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3" & hospTyp & RepoString("tblpatientdate") & xstr & " GROUP BY tblhospitals.fldprovince", dtfir.Value, dtlast.Value, "Death"))
    xdeliveryColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldprovince,COUNT(tblconfinement.fldencounterval) as xtotal from tblconfinement inner join tblhospitals on tblconfinement.fldhospcode=tblhospitals.fldhospcode where tblconfinement.flddeltime>=&1 and tblconfinement.flddeltime<=&2" & hospTyp & RepoString("tblconfinement") & xstr & " GROUP BY tblhospitals.fldprovince", dtfir.Value, dtlast.Value))
    xlaboraColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldprovince,COUNT(tblpatlabtest.fldencounterval) as xtotal from tblpatlabtest inner join tblhospitals on tblpatlabtest.fldhospcode=tblhospitals.fldhospcode where tblpatlabtest.fldtime_report>=&1 and tblpatlabtest.fldtime_report<=&2" & hospTyp & RepoString("tblpatlabtest") & xstr & " GROUP BY tblhospitals.fldprovince", dtfir.Value, dtlast.Value))
    xradioColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldprovince,COUNT(tblpatradiotest.fldencounterval) as xtotal from tblpatradiotest inner join tblhospitals on tblpatradiotest.fldhospcode=tblhospitals.fldhospcode where tblpatradiotest.fldtime_report>=&1 and tblpatradiotest.fldtime_report<=&2" & hospTyp & RepoString("tblpatradiotest") & xstr & " GROUP BY tblhospitals.fldprovince", dtfir.Value, dtlast.Value))
    xexaminatColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldprovince,COUNT(tblpatientexam.fldencounterval) as xtotal from tblpatientexam inner join tblhospitals on tblpatientexam.fldhospcode=tblhospitals.fldhospcode where tblpatientexam.fldtime>=&1 and tblpatientexam.fldtime<=&2" & hospTyp & RepoString("tblpatientexam") & xstr & " GROUP BY tblhospitals.fldprovince", dtfir.Value, dtlast.Value))
    xmajprocedColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldprovince,COUNT(tblpatgeneral.fldencounterval) as xtotal from tblpatgeneral inner join tblhospitals on tblpatgeneral.fldhospcode=tblhospitals.fldhospcode where tblpatgeneral.fldtime>=&1 and tblpatgeneral.fldtime<=&2 and tblpatgeneral.fldinput=&3" & hospTyp & RepoString("tblpatgeneral") & xstr & " GROUP BY tblhospitals.fldprovince", dtfir.Value, dtlast.Value, "Procedures"))

  Else
    xconsultColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldhospcode,COUNT(tblconsult.fldencounterval) as xtotal from tblconsult inner join tblhospitals on tblconsult.fldhospcode=tblhospitals.fldhospcode where tblconsult.fldconsulttime>=&1 and tblconsult.fldconsulttime<=&2" & hospTyp & RepoString("tblconsult") & xstr & " GROUP BY tblhospitals.fldhospcode", dtfir.Value, dtlast.Value))                    ''
    xadmissionColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldhospcode,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3" & hospTyp & RepoString("tblpatientdate") & xstr & " GROUP BY tblhospitals.fldhospcode", dtfir.Value, dtlast.Value, "Admitted"))
    xdischargeColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldhospcode,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3" & hospTyp & RepoString("tblpatientdate") & xstr & " GROUP BY tblhospitals.fldhospcode", dtfir.Value, dtlast.Value, "Discharged"))
    xreferColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldhospcode,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3" & hospTyp & RepoString("tblpatientdate") & xstr & " GROUP BY tblhospitals.fldhospcode", dtfir.Value, dtlast.Value, "Refer"))
    xdeathColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldhospcode,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3" & hospTyp & RepoString("tblpatientdate") & xstr & " GROUP BY tblhospitals.fldhospcode", dtfir.Value, dtlast.Value, "Death"))
    xdeliveryColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldhospcode,COUNT(tblconfinement.fldencounterval) as xtotal from tblconfinement inner join tblhospitals on tblconfinement.fldhospcode=tblhospitals.fldhospcode where tblconfinement.flddeltime>=&1 and tblconfinement.flddeltime<=&2" & hospTyp & RepoString("tblconfinement") & xstr & " GROUP BY tblhospitals.fldhospcode", dtfir.Value, dtlast.Value))
    xlaboraColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldhospcode,COUNT(tblpatlabtest.fldencounterval) as xtotal from tblpatlabtest inner join tblhospitals on tblpatlabtest.fldhospcode=tblhospitals.fldhospcode where tblpatlabtest.fldtime_report>=&1 and tblpatlabtest.fldtime_report<=&2" & hospTyp & RepoString("tblpatlabtest") & xstr & " GROUP BY tblhospitals.fldhospcode", dtfir.Value, dtlast.Value))
    xradioColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldhospcode,COUNT(tblpatradiotest.fldencounterval) as xtotal from tblpatradiotest inner join tblhospitals on tblpatradiotest.fldhospcode=tblhospitals.fldhospcode where tblpatradiotest.fldtime_report>=&1 and tblpatradiotest.fldtime_report<=&2" & hospTyp & RepoString("tblpatradiotest") & xstr & " GROUP BY tblhospitals.fldhospcode", dtfir.Value, dtlast.Value))
    xexaminatColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldhospcode,COUNT(tblpatientexam.fldencounterval) as xtotal from tblpatientexam inner join tblhospitals on tblpatientexam.fldhospcode=tblhospitals.fldhospcode where tblpatientexam.fldtime>=&1 and tblpatientexam.fldtime<=&2" & hospTyp & RepoString("tblpatientexam") & xstr & " GROUP BY tblhospitals.fldhospcode", dtfir.Value, dtlast.Value))
    xmajprocedColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldhospcode,COUNT(tblpatgeneral.fldencounterval) as xtotal from tblpatgeneral inner join tblhospitals on tblpatgeneral.fldhospcode=tblhospitals.fldhospcode where tblpatgeneral.fldtime>=&1 and tblpatgeneral.fldtime<=&2 and tblpatgeneral.fldinput=&3" & hospTyp & RepoString("tblpatgeneral") & xstr & " GROUP BY tblhospitals.fldhospcode", dtfir.Value, dtlast.Value, "Procedures"))

  Endif

  GridView1.Clear()
  GridView1.Columns.Count = 11
  GridView1.Count = $hospList.Count + 1

  With GridView1
    .Columns[0].Width = CStr(200 * modBasic.$AppWidthRatio) & "px"
    .Columns[0].Text = "Variable"
    For i = 1 To 10
      .Columns[i].Width = CStr(75 * modBasic.$AppWidthRatio) & "px"
      .Columns[i].Text = ServList[i - 1]
    Next
  End With

End

Public Sub GridView1_Data(Row As Integer, Column As Integer, Data As WebTableData)

  modGridView.GridViewDecoration(Data, Row)
  If Row = $hospList.Count Then
    If Column = 0 Then
      Data.Html = "<b>" & "TOTAL" & "</b>"
    Else If Column = 1 Then
      Data.Html = "<b>" & GetTotalArray(xconsultColl) & "</b>"
    Else If Column = 2 Then
      Data.Html = "<b>" & GetTotalArray(xadmissionColl) & "</b>"
    Else If Column = 3 Then
      Data.Html = "<b>" & GetTotalArray(xdischargeColl) & "</b>"
    Else If Column = 4 Then
      Data.Html = "<b>" & GetTotalArray(xreferColl) & "</b>"
    Else If Column = 5 Then
      Data.Html = "<b>" & GetTotalArray(xdeathColl) & "</b>"
    Else If Column = 6 Then
      Data.Html = "<b>" & GetTotalArray(xdeliveryColl) & "</b>"
    Else If Column = 7 Then
      Data.Html = "<b>" & GetTotalArray(xlaboraColl) & "</b>"
    Else If Column = 8 Then
      Data.Html = "<b>" & GetTotalArray(xradioColl) & "</b>"
    Else If Column = 9 Then
      Data.Html = "<b>" & GetTotalArray(xexaminatColl) & "</b>"
    Else If Column = 10 Then
      Data.Html = "<b>" & GetTotalArray(xmajprocedColl) & "</b>"
    Endif

  Else
    If Column = 0 Then
      If $locatMode = "Hospital" Then
        Data.Text = modDataRepo.GetHospitaltName($hospList[Row])
      Else
        Data.Text = $hospList[Row]
      Endif
    Else If Column = 1 Then
      Data.Text = xconsultColl[$hospList[Row]]
    Else If Column = 2 Then
      Data.Text = xadmissionColl[$hospList[Row]]
    Else If Column = 3 Then
      Data.Text = xdischargeColl[$hospList[Row]]
    Else If Column = 4 Then
      Data.Text = xreferColl[$hospList[Row]]
    Else If Column = 5 Then
      Data.Text = xdeathColl[$hospList[Row]]
    Else If Column = 6 Then
      Data.Text = xdeliveryColl[$hospList[Row]]
    Else If Column = 7 Then
      Data.Text = xlaboraColl[$hospList[Row]]
    Else If Column = 8 Then
      Data.Text = xradioColl[$hospList[Row]]
    Else If Column = 9 Then
      Data.Text = xexaminatColl[$hospList[Row]]
    Else If Column = 10 Then
      Data.Text = xmajprocedColl[$hospList[Row]]
    Endif

  Endif

End

''----------------------- surveillance ---------------------------
Private Sub LoadSurveillanceData()

  Dim xhospfld As String
  Dim xFldList As String[]
  Dim sql As String

  xhospfld = modDataRepo.HospitalField()
  xFldList = ["fldid", "fldtime", "fldencounterval", "fldencounterval", modDataRepo.SerialField(), "fldencounterval", "fldencounterval", "fldcodenew", "fldcode", xhospfld]

  sql = "select " & xFldList.Join(",") & " from tblpatfindings where fldtime>=&1 and fldtime<=&2 and (fldtype=&3 or fldtype=&4) and fldsave=&5 and fldcodenew in(select fldcodenew from tblsurveillance) ORDER BY fldtime DESC"
  $rData1 = modDatabase.$syConn.Exec(sql, dtfir.Value, dtlast.Value, "Provisional Diagnosis", "Final Diagnosis", True)
  $aMyFields1 = New String[]
  modGridView.ReadSmallData(GridView2, $rData1, $aMyFields1)
  With GridView2
    .Columns[0].Hidden = True
    .Columns[1].Width = CStr(150 * modBasic.$AppWidthRatio) & "px"
    .Columns[2].Width = CStr(125 * modBasic.$AppWidthRatio) & "px"
    .Columns[3].Width = CStr(175 * modBasic.$AppWidthRatio) & "px"
    .Columns[4].Width = CStr(125 * modBasic.$AppWidthRatio) & "px"
    .Columns[5].Width = CStr(150 * modBasic.$AppWidthRatio) & "px"
    .Columns[6].Width = CStr(125 * modBasic.$AppWidthRatio) & "px"
    .Columns[7].Width = CStr(75 * modBasic.$AppWidthRatio) & "px"
    .Columns[8].Width = CStr(250 * modBasic.$AppWidthRatio) & "px"

    .Columns[1].Text = "Date"
    .Columns[2].Text = "EncID"
    .Columns[3].Text = "Name"
    .Columns[4].Text = "Age/Sex"
    .Columns[5].Text = "Address"
    .Columns[6].Text = "PatientNo"
    .Columns[7].Text = "Code"
    .Columns[8].Text = "Observation"
  End With

End

Public Sub GridView2_Data(Row As Integer, Column As Integer, Data As WebTableData)

  $rData1.MoveTo(Row)
  modGridView.GridViewDecoration(Data, Row)
  If Column = 1 Then
    Data.Text = modReportVar.GetDateTimeReport($rData1[$aMyFields1[Column]], gb.GeneralDate)
  Else If Column = 3 Then
    Data.Text = modPatient.GetPatientNameByEnc($rData1[$aMyFields1[Column]], modDatabase.$syConn)
  Else If Column = 4 Then
    Data.Text = modMedReports.GetPatientPastAgeString("tblpatfindings", $rData1[$aMyFields1[Column]]) & "/" & modPatient.GetPatientSex($rData1[$aMyFields1[Column]], modDatabase.$syConn)
  Else If Column = 5 Then
    Data.Text = modPatient.GetPatientAddressByEnc($rData1[$aMyFields1[Column]], modDatabase.$syConn)
  Else If Column = 6 Then
    Data.Text = modPatient.GetPatientNoByEnc($rData1[$aMyFields1[Column]])
  Else If Column = 9 Then
    Data.Text = modDataRepo.GetHospitalTextLabel($rData1[$aMyFields1[Column]])
  Else
    Data.Text = $rData1[$aMyFields1[Column]]
  Endif

End

Public Sub btnshowtable_Click()

  If GridView2.Selection.Count Then
    $rData1.MoveTo(GridView2.Selection[0])
    If modPatientSub.AllowEncIDHistory($rData1["fldencounterval"], modDatabase.$syConn) = True Then
      modPatReports.GetSelectedPatientValues($rData1["fldencounterval"], MMain.$defUnit)
    Endif
  Endif

End

Public Sub btnshowmap_Click()

  Dim res As Result
  Dim hForm As FRequest
  Dim xpatno As String

  If GridView2.Selection.Count Then
    $rData1.MoveTo(GridView2.Selection[0])
    If modPatientSub.AllowEncIDHistory($rData1["fldencounterval"], modDatabase.$syConn) = True Then
      xpatno = modPatient.GetPatientNoByEnc($rData1["fldencounterval"])
      If MMain.$RepoReportMode = True Then
        res = modDatabase.$syConn.Exec("select fldencounterval,fldregdate,fldadmission,fldcurrlocat,flduserid,flddisctype,fldhospcode from tblencounter where fldpatientval=&1 ORDER BY fldregdate", xpatno)
      Else
        res = modDatabase.$syConn.Exec("select fldencounterval,fldregdate,fldadmission,fldcurrlocat,flduserid,flddisctype from tblencounter where fldpatientval=&1 ORDER BY fldregdate", xpatno)
      Endif
      hForm = New FRequest(res, "Patient Encounters", "PatientEncounters", False)
      hForm.ShowModal
    Endif
  Endif

End

''------------------ Charts ----------------------
Private Function ChartRepositoryWithHosp(sType As String, sMode As String, sValue As String) As Result

  Dim res As Result

  Select sType
    Case "Consultation"
      res = modDatabase.$syConn.Exec("select COUNT(fldencounterval) as xtotal,DATE(fldconsulttime) as xdate from tblconsult where fldconsulttime>=&1 and fldconsulttime<=&2" & modDataRepo.GetWhereStringRepo(sMode, sValue) & " GROUP BY DATE(tblconsult.fldconsulttime)", dtfir.Value, dtlast.Value)
    Case "Admission"
      res = modDatabase.$syConn.Exec("select COUNT(fldencounterval) as xtotal,DATE(fldtime) as xdate from tblpatientdate where fldtime>=&1 and fldtime<=&2 and fldhead=&3" & modDataRepo.GetWhereStringRepo(sMode, sValue) & " GROUP BY DATE(tblpatientdate.fldtime)", dtfir.Value, dtlast.Value, "Admitted")
    Case "Discharge"
      res = modDatabase.$syConn.Exec("select COUNT(fldencounterval) as xtotal,DATE(fldtime) as xdate from tblpatientdate where fldtime>=&1 and fldtime<=&2 and fldhead=&3" & modDataRepo.GetWhereStringRepo(sMode, sValue) & " GROUP BY DATE(tblpatientdate.fldtime)", dtfir.Value, dtlast.Value, "Discharged")
    Case "Referred"
      res = modDatabase.$syConn.Exec("select COUNT(fldencounterval) as xtotal,DATE(fldtime) as xdate from tblpatientdate where fldtime>=&1 and fldtime<=&2 and fldhead=&3" & modDataRepo.GetWhereStringRepo(sMode, sValue) & " GROUP BY DATE(tblpatientdate.fldtime)", dtfir.Value, dtlast.Value, "Refer")
    Case "Death"
      res = modDatabase.$syConn.Exec("select COUNT(fldencounterval) as xtotal,DATE(fldtime) as xdate from tblpatientdate where fldtime>=&1 and fldtime<=&2 and fldhead=&3" & modDataRepo.GetWhereStringRepo(sMode, sValue) & " GROUP BY DATE(tblpatientdate.fldtime)", dtfir.Value, dtlast.Value, "Death")
    Case "Delivery"
      res = modDatabase.$syConn.Exec("select COUNT(fldencounterval) as xtotal,DATE(flddeltime) as xdate from tblconfinement where flddeltime>=&1 and flddeltime<=&2" & modDataRepo.GetWhereStringRepo(sMode, sValue) & " GROUP BY DATE(tblconfinement.flddeltime)", dtfir.Value, dtlast.Value)
    Case "Laboratory"
      res = modDatabase.$syConn.Exec("select COUNT(fldencounterval) as xtotal,DATE(fldtime_report) as xdate from tblpatlabtest where fldtime_report>=&1 and fldtime_report<=&2" & modDataRepo.GetWhereStringRepo(sMode, sValue) & " GROUP BY DATE(tblpatlabtest.fldtime_report)", dtfir.Value, dtlast.Value)
    Case "Radiology"
      res = modDatabase.$syConn.Exec("select COUNT(fldencounterval) as xtotal,DATE(fldtime_report) as xdate from tblpatradiotest where fldtime_report>=&1 and fldtime_report<=&2" & modDataRepo.GetWhereStringRepo(sMode, sValue) & " GROUP BY DATE(tblpatradiotest.fldtime_report)", dtfir.Value, dtlast.Value)
    Case "Examination"
      res = modDatabase.$syConn.Exec("select COUNT(fldencounterval) as xtotal,DATE(fldtime) as xdate from tblpatientexam where fldtime>=&1 and fldtime<=&2" & modDataRepo.GetWhereStringRepo(sMode, sValue) & " GROUP BY DATE(tblpatientexam.fldtime)", dtfir.Value, dtlast.Value)
    Case "Major Procedures"
      res = modDatabase.$syConn.Exec("select COUNT(fldencounterval) as xtotal,DATE(fldtime) as xdate from tblpatgeneral where fldtime>=&1 and fldtime<=&2 and fldinput=&3" & modDataRepo.GetWhereStringRepo(sMode, sValue) & " GROUP BY DATE(tblpatgeneral.fldtime)", dtfir.Value, dtlast.Value, "Procedures")
  End Select

  Return res

End

Private Function ChartRepositoryAllHosp(sType As String) As Result

  Dim res As Result

  Select sType
    Case "Consultation"
      res = modDatabase.$syConn.Exec("select COUNT(fldencounterval) as xtotal,DATE(fldconsulttime) as xdate from tblconsult where fldconsulttime>=&1 and fldconsulttime<=&2 GROUP BY DATE(tblconsult.fldconsulttime)", dtfir.Value, dtlast.Value)
    Case "Admission"
      res = modDatabase.$syConn.Exec("select COUNT(fldencounterval) as xtotal,DATE(fldtime) as xdate from tblpatientdate where fldtime>=&1 and fldtime<=&2 and fldhead=&3 GROUP BY DATE(tblpatientdate.fldtime)", dtfir.Value, dtlast.Value, "Admitted")
    Case "Discharge"
      res = modDatabase.$syConn.Exec("select COUNT(fldencounterval) as xtotal,DATE(fldtime) as xdate from tblpatientdate where fldtime>=&1 and fldtime<=&2 and fldhead=&3 GROUP BY DATE(tblpatientdate.fldtime)", dtfir.Value, dtlast.Value, "Discharged")
    Case "Referred"
      res = modDatabase.$syConn.Exec("select COUNT(fldencounterval) as xtotal,DATE(fldtime) as xdate from tblpatientdate where fldtime>=&1 and fldtime<=&2 and fldhead=&3 GROUP BY DATE(tblpatientdate.fldtime)", dtfir.Value, dtlast.Value, "Refer")
    Case "Death"
      res = modDatabase.$syConn.Exec("select COUNT(fldencounterval) as xtotal,DATE(fldtime) as xdate from tblpatientdate where fldtime>=&1 and fldtime<=&2 and fldhead=&3 GROUP BY DATE(tblpatientdate.fldtime)", dtfir.Value, dtlast.Value, "Death")
    Case "Delivery"
      res = modDatabase.$syConn.Exec("select COUNT(fldencounterval) as xtotal,DATE(flddeltime) as xdate from tblconfinement where flddeltime>=&1 and flddeltime<=&2 GROUP BY DATE(tblconfinement.flddeltime)", dtfir.Value, dtlast.Value)
    Case "Laboratory"
      res = modDatabase.$syConn.Exec("select COUNT(fldencounterval) as xtotal,DATE(fldtime_report) as xdate from tblpatlabtest where fldtime_report>=&1 and fldtime_report<=&2 GROUP BY DATE(tblpatlabtest.fldtime_report)", dtfir.Value, dtlast.Value)
    Case "Radiology"
      res = modDatabase.$syConn.Exec("select COUNT(fldencounterval) as xtotal,DATE(fldtime_report) as xdate from tblpatradiotest where fldtime_report>=&1 and fldtime_report<=&2 GROUP BY DATE(tblpatradiotest.fldtime_report)", dtfir.Value, dtlast.Value)
    Case "Examination"
      res = modDatabase.$syConn.Exec("select COUNT(fldencounterval) as xtotal,DATE(fldtime) as xdate from tblpatientexam where fldtime>=&1 and fldtime<=&2 GROUP BY DATE(tblpatientexam.fldtime)", dtfir.Value, dtlast.Value)
    Case "Major Procedures"
      res = modDatabase.$syConn.Exec("select COUNT(fldencounterval) as xtotal,DATE(fldtime) as xdate from tblpatgeneral where fldtime>=&1 and fldtime<=&2 and fldinput=&3 GROUP BY DATE(tblpatgeneral.fldtime)", dtfir.Value, dtlast.Value, "Procedures")
  End Select

  Return res

End

Private Sub SHowChartCanvas(sType As String)

  Dim res As Result
  Dim xValues As Variant[]
  Dim yValues As Variant[]
  Dim xChart As Collection
  Dim sPath As String

  Dim xWebCanv As WebCanvas

  xValues = New Variant[]
  yValues = New Variant[]
  If modBasic.$HospCode Then
    If modDataRepo.$RepositoryMode = "Hospital" Then
    Else
      res = ChartRepositoryWithHosp(sType, $locatMode, modBasic.$HospCode)
    Endif
  Else
    res = ChartRepositoryAllHosp(sType)
  Endif
  If res And If res.Available Then
    For Each res
      xValues.Add(Format(res["xdate"], "dd-mm-yy"))
      yValues.Add(res["xtotal"])
    Next
    xChart = modChartJS.GetHTMLChartScript("line", sType, xValues, yValues)

    If WebContainer7.Children.Count Then
      WebContainer7.DeleteChildren()
    Endif
    xWebCanv = New WebCanvas(WebContainer7)
    xWebCanv.Expand = True
    sPath = "new Chart(\"" & xWebCanv.Name & "\", " & JSON.Encode(xChart) & ")"
    Me.Exec(sPath)
  Endif

End

Public Sub btnconsult_Click()

  If rbsummary.Value = True Then
    SHowChartCanvas("Consultation")
  Else If rbseparate.Value = True Then

  Endif

End

Public Sub btnadmission_Click()

  If rbsummary.Value = True Then
    SHowChartCanvas("Admission")
  Else If rbseparate.Value = True Then

  Endif

End

Public Sub btndischarge_Click()

  If rbsummary.Value = True Then
    SHowChartCanvas("Discharge")
  Else If rbseparate.Value = True Then

  Endif

End

Public Sub btnreferred_Click()

  If rbsummary.Value = True Then
    SHowChartCanvas("Referred")
  Else If rbseparate.Value = True Then

  Endif

End

Public Sub btndeath_Click()

  If rbsummary.Value = True Then
    SHowChartCanvas("Death")
  Else If rbseparate.Value = True Then

  Endif

End

Public Sub btndelivery_Click()

  If rbsummary.Value = True Then
    SHowChartCanvas("Delivery")
  Else If rbseparate.Value = True Then

  Endif

End

Public Sub btnlab_Click()

  If rbsummary.Value = True Then
    SHowChartCanvas("Laboratory")
  Else If rbseparate.Value = True Then

  Endif

End

Public Sub btnradio_Click()

  If rbsummary.Value = True Then
    SHowChartCanvas("Radiology")
  Else If rbseparate.Value = True Then

  Endif

End

Public Sub btnexams_Click()

  If rbsummary.Value = True Then
    SHowChartCanvas("Examination")
  Else If rbseparate.Value = True Then

  Endif

End

Public Sub btnprocedure_Click()

  If rbsummary.Value = True Then
    SHowChartCanvas("Major Procedures")
  Else If rbseparate.Value = True Then

  Endif

End

Public Sub btnexportgrid_Click()

  modCHTMLReport.ExportGridToHTML(GridView1, "Summary Statistics", modReportVar.GetDateTimeReport(Now(), gb.GeneralDate))

End

Public Sub btnexportsurv_Click()

  modCHTMLReport.ExportGridToHTML(GridView2, "Surveillance Statistics", modReportVar.GetDateTimeReport(Now(), gb.GeneralDate))

End
