' Gambas class file

Private $rData As Result
Private $aMyFields As String[]
Private $encid As String
Private $sType As String
Private $ExamsVar As Variant[]
Private $ItemList As String[]

Private $optionType As String
Private $sysConst As String
Private $dataType As String
Private $optionList As String[]

Public Sub _new(sType As String, encid As String)

  $encid = encid
  $sType = sType
  modGeneralMain.GetOpenModalForm(Me)
  Me.Title = $sType

  modBasic.LoadClinicalChartSetting()
  txtpatientname.Text = modPatient.GetPatientNameByEnc($encid)
  txtcolor.Background = modPatient.GetPatientColorStatic($encid)
  $ExamsVar = GetSelectExamVariant($sType)
  $ItemList = modString.GetListFromVariant($ExamsVar, "fldexamid", True)
  ListBox1.List = $ItemList
  ShowExamGrid()

End

Private Function GetSelectExamVariant(sCategory As String) As Variant[]

  Dim sColl As Collection
  Dim aVar As Variant[]

  aVar = New Variant[]
  For Each sColl In modTableCache.$ExaminationCompVar
    If sColl["fldcategory"] = sCategory Then
      aVar.Add(sColl)
    Endif
  Next

  Return aVar

End

Public Sub ListBox1_Select()

  If ListBox1.Text Then
    ShowTriageExamEntry()
  Endif

End

Private Sub ShowTriageExamEntry()

  Dim xlimit As Float[]
  Dim sColl As Collection
  Dim res As Result

  txtexamval.Value = 0
  txtexamval.Tag = ""
  txtquali.Clear
  txtquali.Text = ""

  $optionType = ""
  $sysConst = ""
  $dataType = ""
  $optionList = New String[]

  lblexamname.Text = ListBox1.Text
  For Each sColl In $ExamsVar
    If sColl["fldexamid"] = lblexamname.Text Then
      $dataType = sColl["fldtype"]
      $sysConst = sColl["fldsysconst"]
      $optionType = sColl["fldtanswertype"]
      If sColl["fldoptionlist"] Then
        $optionList = JSON.Decode(sColl["fldoptionlist"])
      Else
        If sColl["fldtanswertype"] = "Dichotomous" Then
          $optionList = ["No", "Yes"]
        Endif
      Endif

      If $sysConst Then
        res = modDatabase.$myConn.Exec("select fldexamid,fldtype,fldoption,fldsysconst,fldcritical from tblexam where fldsysconst=&1", $sysConst)
        If res.Available Then
          res.MoveFirst
          $dataType = res["fldtype"]
          $optionType = res["fldoption"]
          Select res["fldoption"]
            Case "Clinical Scale"
              $optionList = modAllExam.GetCLinicalScaleOptions("Exam", res["fldexamid"])
            Case Else
              $optionList = modAllExam.SelectExamOptionList("Exam", res["fldexamid"])
          End Select
        Endif
      Endif

      Break
    Endif
  Next

  If $dataType = "Quantitative" Then
    txtexamval.Enabled = True
    txtexamval.Visible = True
    lblunit.Visible = True
    txtquali.Enabled = False
    txtquali.Visible = False
    xlimit = modClinic.GetRangeQuantiExamSys($sysConst, $encid)
    txtmin.Value = xlimit[0]
    txtmax.Value = xlimit[1]
    lblunit.Text = modClinic.GetExamUnit(ListBox1.Text, $encid)

  Else If $dataType = "Qualitative" Then
    txtexamval.Enabled = False
    txtexamval.Visible = False
    lblunit.Visible = False
    txtquali.Enabled = True
    txtquali.Visible = True
    ShowDetails()
  Endif

End

Private Sub ShowDetails()

  Dim sVal As String[]

  If Not txtquali.Text Then
    If lblexamname.Text Then

      Select $optionType
        Case "Single Selection"
          txtquali.List = $optionList

        Case "Dichotomous"
          txtquali.List = $optionList
          If Not $optionList.Count Then
            txtquali.List = ["Yes", "No"]
          Endif

        Case "Clinical Scale"
          sVal = SubChoose($optionList, "Clinical Scale", lblexamname.Text)
          If sVal Then
            txtexamval.Value = CFloat(sVal[0])
            txtquali.Text = sVal[1]
            txtexamval.Visible = True
            txtquali.Visible = False
          Endif

        Case Else
          If modBasic.$DisplayQualiArea = "Yes" Then
            txtquali.Text = GetTextArea(lblexamname.Text, "")
          Endif

      End Select

    Endif
  Endif

End

Public Sub btnsave_Click()

  If lblexamname.Text Then
    If $dataType = "Quantitative" Then
      If txtmin.Value = 0 And If txtmax.Value = 0 Then
        chkabnormal.Value = False
      Else
        If txtexamval.Value < txtmin.Value Or If txtexamval.Value > txtmax.Value Then
          chkabnormal.Value = True
        Else
          chkabnormal.Value = False
        Endif
      Endif
      modClinSub.AddQuantiData($encid, "", lblexamname.Text, $optionType, txtexamval.Value, chkabnormal.Value, $sType, $sysConst)

    Else If $dataType = "Qualitative" Then
      If txtquali.Text Then
        modClinSub.AddClinicExam($encid, "", lblexamname.Text, $optionType, txtquali.Text, txtexamval.Value, chkabnormal.Value, $sType, $sysConst, "Regular")
      Endif
    Endif
    ShowExamGrid()
    txtquali.Clear()
    txtquali.Text = ""
    txtexamval.Value = 0
    txtexamval.Tag = ""

  Endif

End

Private Sub ShowExamGrid()

  $rData = modDatabase.$myConn.Exec("select fldid,fldid,fldtime,fldtype,fldhead,fldabnormal,fldid,fldsave,fldsysconst,fldoption from tblpatientexam where fldencounterval=&1 and fldsave=&2 and fldinput=&3", $encid, True, $sType)                                                                                 ''
  $aMyFields = New String[]
  modGridView.ReadSmallData(GridView1, $rData, $aMyFields)

  With GridView1
    .Columns[0].Hidden = True
    .Columns[1].Width = CStr(25 * modBasic.$AppWidthRatio) & "px"
    .Columns[2].Width = CStr(125 * modBasic.$AppWidthRatio) & "px"
    .Columns[3].Hidden = True
    .Columns[4].Width = CStr(200 * modBasic.$AppWidthRatio) & "px"
    .Columns[5].Width = CStr(25 * modBasic.$AppWidthRatio) & "px"
    .Columns[6].Width = CStr(150 * modBasic.$AppWidthRatio) & "px"
    .Columns[7].Hidden = True
    .Columns[8].Hidden = True
    .Columns[9].Hidden = True

    .Columns[2].Text = "DateTime"
    .Columns[4].Text = "Examination"
    .Columns[6].Text = "Observation"
  End With

End

Public Sub GridView1_Data(Row As Integer, Column As Integer, Data As WebTableData)

  $rData.MoveTo(Row)
  modGridView.GridViewDecoration(Data, Row)
  If Column = 5 Then
    Data.Html = modString.GetImageForHTMLGrid(modMisc.GetGridIcon($rData[$aMyFields[Column]]), "75%", "75%")
    Data.Text = ""
  Else If Column = 6 Then
    Data.Html = modClinic.GetExamValueString($encid, $rData[$aMyFields[Column]], False)
  Else If Column = 2 Then
    Data.Text = modReportVar.GetDateTimeReport($rData[$aMyFields[Column]], gb.GeneralDate)
  Else If Column = 1 Then
    Data.Background = modPathoSub.GetPatientColorByTriage($rData[$aMyFields[Column]])
    Data.Text = ""
  Else
    Data.Text = $rData[$aMyFields[Column]]
  Endif

End

Public Sub btnfindcomponent_Click()

  Dim xquantival As Variant[]
  Dim yqualival As Variant[]
  Dim xlimit As Float[]

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    If $rData["fldtype"] = "Quantitative" Then
      xlimit = modClinic.GetRangeQuantiExamSys($rData["fldsysconst"], $encid)
      xquantival = GetQuantiValues("Exam", $encid, $rData["fldhead"], xlimit[0], xlimit[1], modClinic.GetExamValueByID($rData["fldid"]))                                       '
      If xquantival Then
        modClinSub.UpdateQuantiData($rData["fldid"], xquantival[0], xquantival[1])
      Endif
    Else If $rData["fldtype"] = "Qualitative" Then
      If $rData["fldoption"] = "Clinical Scale" Then
        yqualival = modExamOption.GetClinScalePopUp("Exam", modFixClinic.GetExamIDFromSysConst($rData["fldsysconst"]))
        If yqualival Then
          modClinSub.UpdateQualiQuantiData($rData["fldid"], yqualival[1], CFloat(yqualival[0]), False)
        Endif
      Else
        yqualival = GetQualiValues($rData["fldhead"], modClinic.GetExamValueString($encid, $rData["fldid"], False), "Exam")
        If yqualival Then                                  '
          modClinSub.UpdateQualiData($rData["fldid"], yqualival[0], yqualival[1], yqualival[2])
        Endif
      Endif
    Endif
    ShowExamGrid()
  Endif

End

Public Sub btnfindflag_Click()

  Dim xx As String

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xx = InputCombo("Select Flag for the observation", "Change Flag", ["Normal", "Abnormal"], modMisc.GetIconValue($rData["fldabnormal"]), True)
    If xx Then
      modClinSub.UpdateExamFlag($rData["fldid"], xx)
      ShowExamGrid()
    Endif
  Endif

End

Public Sub mnudel_Click()

  Dim res As Result

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    If Message.Question(("Are you sure?"), ("No"), ("Yes")) = 2 Then
      res = modDatabase.$myConn.Edit("tblpatientexam", "fldid=&1", $rData["fldid"])
      If modGeneral.AllowClinicalEdit(res["flduserid"]) = True Then
        res["fldsave"] = False
        res["flduserid"] = modBasic.$lbluser
        res.Update
        ShowExamGrid()
      Else
        Message.Warning("Authorization with " & res["flduserid"], ("OK"))
      Endif
    Endif
  Endif

End

Public Sub btnclose_Click()

  Me.Close()

End
