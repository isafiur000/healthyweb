' Gambas class file

Private $encid As String
Private $rPlanRes As Result
Private $aPlanFields As String[]
Private $sDate As Date

Public Sub _new(encid As String)

  Dim xstatus As String

  $encid = encid
  modGeneralMain.GetOpenModalForm(Me)

  txtpatientname.Text = modPatient.GetPatientNameByEnc($encid)
  txtgender.Text = modPatient.GetPatientAgeString($encid, Now()) & "/" & modPatient.GetPatientSex($encid)

  xstatus = modPatient.CurrentAdmissionStatus($encid)
  txtlocation.Text = modPatient.GetLocationSetting($encid, xstatus)
  $sDate = Now()
  lbldtplan.Text = modPatient.GetDayDiffAdmission($encid, $sDate)
  ShowProblemList()

End

Public Sub btnplanshow_Click()

  If $encid Then
    $sDate = GetDateValue("Select Date", "Planning Date", Now())
    If $sDate Then
      lbldtplan.Text = modPatient.GetDayDiffAdmission($encid, $sDate)
      ShowProblemList()
    Endif
  Endif

End

Private Sub ShowProblemList()

  Dim sql As String

  sql = "select fldid,fldproblem from tblpatplanning where fldencounterval=&1 and fldplancategory=&2 and fldtime>=&3 and fldtime<=&4"
  $rPlanRes = modDatabase.$myConn.Exec(sql, $encid, "Clinician Plan", modDate.StartSqlDate($sDate), modDate.EndSqlDate($sDate))
  $aPlanFields = New String[]
  modGridView.ReadSmallData(grdplan, $rPlanRes, $aPlanFields)

  grdplan.Columns[0].Hidden = True
  ' grdplan.Columns[1].Width = 220 * modBasic.$AppWidthRatio

End

Public Sub grdplan_Data(Row As Integer, Column As Integer, Data As WebTableData)

  $rPlanRes.MoveTo(Row)
  modGridView.GridViewDecoration(Data, Row)
  Data.Text = $rPlanRes[$aPlanFields[Column]]

End

Public Sub grdplan_Select()

  ShowPlanningList()

End

Private Sub ShowPlanningList()

  Dim sql As String
  Dim res As Result

  If grdplan.Selection.Count Then
    $rPlanRes.MoveTo(grdplan.Selection[0])
    sql = "select fldid,fldproblem,fldsubjective,fldobjective,fldassess,fldplan from tblpatplanning where fldid=&1"
    res = modDatabase.$myConn.Exec(sql, $rPlanRes["fldid"])
    If res.Available Then
      txtplanid.Value = res!fldid
      txtproblem.Text = res!fldproblem
      txtsubject.RichText = res!fldsubjective
      txtobject.RichText = res!fldobjective
      txtmanage.RichText = res!fldassess
      txtplan.RichText = res!fldplan
    Endif
  Endif

End

' Public Sub dctplansubj_Click()
'
'   Dim xx As String
'
'   xx = GetRichTextArea("Subjective Parameters", txtsubject.RichText)
'   If xx Then
'     txtsubject.RichText = xx
'   Endif
'
' End
'
' Public Sub btntemplplansubj_Click()
'
'   txtsubject.RichText = txtsubject.RichText & DictionaryVIew(modBasic.$dictadvPath)
'
' End
'
' Public Sub dctplanobj_Click()
'
'   Dim xx As String
'
'   xx = GetRichTextArea("Objective Parameters", txtobject.RichText)
'   If xx Then
'     txtobject.RichText = xx
'   Endif
'
' End
'
' Public Sub btntemplplanobj_Click()
'
'   txtobject.RichText = txtobject.RichText & DictionaryVIew(modBasic.$dictadvPath)
'
' End
'
' Public Sub dctplanasses_Click()
'
'   Dim xx As String
'
'   xx = GetRichTextArea("Therpeutic Assessment", txtmanage.RichText)
'   If xx Then
'     txtmanage.RichText = xx
'   Endif
'
' End
'
' Public Sub btntemplplanasses_Click()
'
'   txtmanage.RichText = txtmanage.RichText & DictionaryVIew(modBasic.$dictadvPath)
'
' End
'
' Public Sub dctplanplan_Click()
'
'   Dim xx As String
'
'   xx = GetRichTextArea("Therapeutic Planning", txtplan.RichText)
'   If xx Then
'     txtplan.RichText = xx
'   Endif
'
' End
'
' Public Sub btntemplplanplan_Click()
'
'   txtplan.RichText = txtplan.RichText & DictionaryVIew(modBasic.$dictadvPath)
'
' End

Public Sub btnplanadd_Click()

  Dim res As Result
  Dim xIntVal As String

  If $encid Then
    If txtproblem.Text Then
      res = modDatabase.$myConn.Create("tblpatplanning")
      res["fldencounterval"] = $encid
      res["fldplancategory"] = "Clinician Plan"
      res["fldproblem"] = txtproblem.Text
      res["fldsubjective"] = ""
      res["fldobjective"] = ""
      res["fldassess"] = ""
      res["fldplan"] = ""
      res["flduserid"] = modBasic.$lbluser
      res["fldtime"] = Now()
      res["fldcomp"] = modBasic.$compID
      res["fldsave"] = True
      res["flduptime"] = ""
      res["xyz"] = False
      If MMain.$WebEntry = True Then
        xIntVal = modString.GetDateString(Now())
        res["fldid"] = CLong(xIntVal)
        res["fldrepoid"] = modMisc.GetWebIndexStr(xIntVal)
        res["fldrepodate"] = Now()
        res["fldrepomac"] = CGI["REMOTE_ADDR"] & ":" & CGI["REMOTE_PORT"]
        res["fldhospcode"] = modBasic.$HospCode
      Endif
      res.Update()
      ShowProblemList()
      Me.Exec(Subst("Toastify({text: '&1', duration: &2}).showToast()", "Information saved", modBasic.$BalloonDelay))
    Endif
  Endif

End

Public Sub btnaddsubject_Click()

  Dim res As Result

  If txtplanid.Value Then
    If txtproblem.Text Then
      res = modDatabase.$myConn.Edit("tblpatplanning", "fldid=&1", txtplanid.Value)
      If modGeneral.AllowClinicalEdit(res["flduserid"]) = True Then
        res["fldsubjective"] = txtsubject.RichText
        res["flduserid"] = modBasic.$lbluser
        res["flduptime"] = Now()
        res["fldcomp"] = modBasic.$compID
        res["xyz"] = False
        res.Update()
        ShowProblemList()
        Me.Exec(Subst("Toastify({text: '&1', duration: &2}).showToast()", "Information saved", modBasic.$BalloonDelay))
      Else
        Message.Warning("Authorization with " & res["flduserid"], ("OK"))
      Endif
    Endif
  Endif
  'don't catch error

End

Public Sub btnaddobject_Click()

  Dim res As Result

  If txtplanid.Value Then
    If txtproblem.Text Then
      res = modDatabase.$myConn.Edit("tblpatplanning", "fldid=&1", txtplanid.Value)
      If modGeneral.AllowClinicalEdit(res["flduserid"]) = True Then
        res["fldobjective"] = txtobject.RichText
        res["flduserid"] = modBasic.$lbluser
        res["flduptime"] = Now()
        res["fldcomp"] = modBasic.$compID
        res["xyz"] = False
        res.Update()
        ShowProblemList()
        Me.Exec(Subst("Toastify({text: '&1', duration: &2}).showToast()", "Information saved", modBasic.$BalloonDelay))
      Else
        Message.Warning("Authorization with " & res["flduserid"], ("OK"))
      Endif
    Endif
  Endif
  'don't catch error

End

Public Sub btnaddassess_Click()

  Dim res As Result

  If txtplanid.Value Then
    If txtproblem.Text Then
      res = modDatabase.$myConn.Edit("tblpatplanning", "fldid=&1", txtplanid.Value)
      If modGeneral.AllowClinicalEdit(res["flduserid"]) = True Then
        res["fldassess"] = txtmanage.RichText
        res["flduserid"] = modBasic.$lbluser
        res["flduptime"] = Now()
        res["fldcomp"] = modBasic.$compID
        res["xyz"] = False
        res.Update()
        ShowProblemList()
        Me.Exec(Subst("Toastify({text: '&1', duration: &2}).showToast()", "Information saved", modBasic.$BalloonDelay))
      Else
        Message.Warning("Authorization with " & res["flduserid"], ("OK"))
      Endif
    Endif
  Endif
  'don't catch error

End

Public Sub btnaddplan_Click()

  Dim res As Result

  If txtplanid.Value Then
    If txtproblem.Text Then
      res = modDatabase.$myConn.Edit("tblpatplanning", "fldid=&1", txtplanid.Value)
      If modGeneral.AllowClinicalEdit(res["flduserid"]) = True Then
        res["fldplan"] = txtplan.RichText
        res["flduserid"] = modBasic.$lbluser
        res["flduptime"] = Now()
        res["fldcomp"] = modBasic.$compID
        res["xyz"] = False
        res.Update()
        ShowProblemList()
        Me.Exec(Subst("Toastify({text: '&1', duration: &2}).showToast()", "Information saved", modBasic.$BalloonDelay))
      Else
        Message.Warning("Authorization with " & res["flduserid"], ("OK"))
      Endif
    Endif
  Endif
  'don't catch error

End

Public Sub btnclose_Click()

  Me.Close()

End

''----------------- pen
Public Sub btnpansubj_Click()

  txtsubject.RichText = txtsubject.RichText & Space(1) & modFillContainer.GetExtraTextArea("Subjective", txtsubject.Text)

End

Public Sub btnpanobject_Click()

  txtobject.RichText = txtobject.RichText & Space(1) & modFillContainer.GetExtraTextArea("Objective", txtobject.Text)

End

Public Sub btnpanassess_Click()

  txtmanage.RichText = txtmanage.RichText & Space(1) & modFillContainer.GetExtraTextArea("Assessment", txtmanage.Text)

End

Public Sub btnpanplan_Click()

  txtplan.RichText = txtplan.RichText & Space(1) & modFillContainer.GetExtraTextArea("Planning", txtplan.Text)

End

''------------- attach
Public Sub btnattsubj_Click()

  txtsubject.RichText = txtsubject.RichText & DictionaryVIew(modBasic.$dictadvPath)

End

Public Sub btnattobject_Click()

  txtobject.RichText = txtobject.RichText & DictionaryVIew(modBasic.$dictadvPath)

End

Public Sub btnattassess_Click()

  txtmanage.RichText = txtmanage.RichText & DictionaryVIew(modBasic.$dictadvPath)

End

Public Sub btnattplan_Click()

  txtplan.RichText = txtplan.RichText & DictionaryVIew(modBasic.$dictadvPath)

End

''---------------exec
Public Sub btnexecsubj_Click()

  txtsubject.RichText = txtsubject.RichText & modString.TextToHTML(modCloudAI.GetPatCloudAIResponse($encid, txtsubject.Text))

End

Public Sub btnexecobject_Click()

  txtobject.RichText = txtobject.RichText & modString.TextToHTML(modCloudAI.GetPatCloudAIResponse($encid, txtobject.Text))

End

Public Sub btnexecassess_Click()

  txtmanage.RichText = txtmanage.RichText & modString.TextToHTML(modCloudAI.GetPatCloudAIResponse($encid, txtmanage.Text))

End

Public Sub btnexecplan_Click()

  txtplan.RichText = txtplan.RichText & modString.TextToHTML(modCloudAI.GetPatCloudAIResponse($encid, txtplan.Text))

End
