' Gambas class file

Private $structExamList As String[]
Private $UserRestrict As String[]
Private $ClinicianLst As String[]

Private $rData As Result
Private $aMyFields As String[]
Private $SSQLFields As String[]
Private $ColCount As Integer
Private $newColumn As String[]
Private $RepoStr As String

Public Sub _new()

  If MMain.$WebReport = "Multiple" Then
    WebContainer1.Visible = False
    WebContainer16.Visible = False
    mnusaummary.Visible = False
    btntriage.Visible = False
    WebProgressBar1.Visible = False
    If modBasic.$HospCode Then
      cmblocation.Text = modDataRepo.$RepositoryMode
      cmbvalue.Text = modBasic.$HospCode
      cmblocation.Enabled = False
      cmbvalue.Enabled = False
    Else
      cmblocation.List = ["Hospital", "Municipality", "Category", "District", "Province"]
    Endif
  Else
    lbllocation.Visible = False
    cmblocation.Visible = False
    lblvalue.Visible = False
    cmbvalue.Visible = False
  Endif

  Select modHelpVariable.$LogInCategory
    Case "Research"
      mnudata.Visible = True
      mnuhistoryall.Visible = True
      mnuarchive.Visible = True
      mnucustreport.Visible = True
    Case "Clinician"
      mnudata.Visible = True
      mnuhistoryall.Visible = True
      mnuarchive.Visible = True
      mnucustreport.Visible = True
      mnuservice.Visible = True
      mnucustchartall.Visible = True
      mnugoto.Visible = True
  End Select

  $UserRestrict = modBasic.$ClinicDisableCompo
  $ClinicianLst = modGeneral.GetClinicianCodeList()
  If modBasic.$ClinDepartFormat = "Service" Then
    cmbdept.List = modBasic.$IPDServDepartments
  Else
    cmbdept.List = modBasic.$IPDDepartmentsAll
  Endif
  cmbdept.Add("Unallocated")
  cmbdept.Add("Waiting")
  cmbdept.Add("Free Beds")
  cmbdept.Add("All")
  If modHelpVariable.$LogInCategory = "Clinician" Then
    GetComboItemList()
    WebContainer1.Visible = True
    WebContainer16.Visible = True
  Endif
  If modBasic.$FixedDepartment Then
    cmbdept.Text = modBasic.$FixedDepartment
    If modBasic.$LockToOwnDepart = "Yes" Then
      cmbdept.Enabled = False
    Endif
  Else
    cmbdept.Text = modSettings.ShowSettingFromFIle("IPClinic/DefaultDepart")
  Endif

  modSettings.ShowCheckBox(chkshowdepart, "BedOccupancy/ShowParameters")
  modSettings.ShowCheckBox(chkshowstatus, "BedOccupancy/ShowStatusIcons")

  If modHelpVariable.$LogInCategory = "Cashier" Then
    btnautoround.Visible = True
    btnautobill.Visible = True
    If modGlobalSetting.ShowSettingFromDB("AutoServiceBilling/BedCharge") = "Yes" Then
      ActivateAutoBilling()
    Endif
    If modGlobalSetting.ShowSettingFromDB("AutoServiceBilling/RoundCharge") = "Yes" Then
      ActivateAutoRound()
    Endif
  Endif

  $structExamList = modMedicine.FillClinicalSubClass("Physician Examinations")
  FillCustomMenu()
  FillCustomFormMenu()
  FillExamMenu()

  SHowSelectOption()
  rbmetric.Value = True
  rblocat.Value = True
  WebProgressBar1.Value = 0
  If cmbdept.Text Then
    btnrefresh_Click()
  Endif
  If modBasic.$TabletModeEnable = "Yes" Then
  Else
    cmbdept.SetFocus
  Endif

End

Public Sub cmblocation_Click()

  cmbvalue.Clear()
  If cmblocation.Text Then
    cmbvalue.List = modDataRepo.GetRepoValueListType(cmblocation.Text)
  Endif

End

Public Sub ToolButton1_Click()

  Dim xcol As String

  xcol = InputColor("Triage", ToolButton1.Background)
  If xcol = CStr(Color.White) Then
    ToolButton1.Background = Color.White
  Else
    If xcol Then
      ToolButton1.Background = CInt(xcol)
    Endif
  Endif

End

Public Sub rbselect_Click()

  modSettings.SaveSettingsToFile("BedOccupancy/Default", "Selected")

End

Public Sub rball_Click()

  modSettings.SaveSettingsToFile("BedOccupancy/Default", "All")

End

Private Function LabUnitForm() As String

  Dim xx As String

  If rbsi.Value = True Then
    xx = "SI"
  Else
    xx = "Metric"
  Endif
  Return xx

End

Private Sub SHowSelectOption()

  Dim def As String

  def = modSettings.ShowSettingFromFIle("BedOccupancy/Default")
  If def Then
    If def = "All" Then
      rball.Value = True
    Else
      rbselect.Value = True
    Endif
  Else
    rbselect.Value = True
  Endif

End

' Public Sub cmbdefform_KeyRelease()
'
'   modFillContainer.AutoFillComboBox(cmbdefform)
'   modFillContainer.RestrictComboToContent(cmbdefform)
'
' End

' Public Sub btnrefresh_KeyRelease()
'
'   If Key.Code = Key.Return Or If Key.Code = Key.Enter Or If Key.Code = Key.AltKey Then
'     btnrefresh_Click()
'   Endif
'
' End

Private Function GetFieldsList()

  Dim xhospfld As String

  xhospfld = modDataRepo.HospitalField()
  If cmbdept.Text = "Unallocated" Then
    $SSQLFields = ["fldencounterval", "fldcurrlocat", "fldcurrlocat", "fldcurrlocat", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval"]
  Else If cmbdept.Text = "Waiting" Then
    $SSQLFields = ["fldencounterval", "fldconsultname", "fldconsultname", "fldconsultname", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval"]
  Else If cmbdept.Text = "Free Beds" Then
    $SSQLFields = ["fldfreedate", "fldoxyport", "fldventilator", "fldbed", "fldencounterval", "fldencounterval", "flddept", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldstatus"]
  Else
    $SSQLFields = ["fldencounterval", "fldoxyport", "fldventilator", "fldbed", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldstatus"]
  Endif
  If xhospfld Then
    $SSQLFields.Add(xhospfld)
  Endif

End

Private Function GetSQLColumns() As String[]

  Dim xFldList As String[]
  Dim i As Integer
  Dim j As Integer

  GetFieldsList()
  modCustPatient.FillNewCOlumnCollection(Me.Tag)
  $newColumn = modCustPatient.CustomNewColumnsTitle(Me.Tag)
  xFldList = $SSQLFields.Copy()
  If $newColumn.Count Then
    For i = 0 To $newColumn.Count - 1
      xFldList.Add("fldencounterval")
    Next
  Endif

  Select cmbdept.Text
    Case "Unallocated", "Waiting", "Free Beds", "All"
    Case Else
      For j = 0 To xFldList.Count - 1
        xFldList[j] = "tbldepartmentbed." & xFldList[j]
      Next
  End Select

  Return xFldList

End

Private Function ExecuteQuery(xFldList As String[]) As Result

  Dim res As Result
  Dim sql As String
  Dim xencid As String
  Dim xcolor As String

  Dim xorder As String
  Dim xunion As String

  If ToolButton1.Background = Color.White Then
    xcolor = ""
  Else
    xcolor = " and tbldepartmentbed.fldencounterval in(select fldencounterval from tblencounter where " & db.Subst("fldheight=&1)", CStr(ToolButton1.Background))
  Endif

  If Len(txtbed.Text) Then
    xencid = db.Subst(" and lower(tbldepartmentbed.fldbed) like &1", LCase(Trim(txtbed.Text)))
  Else
    xencid = ""
  Endif

  $RepoStr = modDataRepo.GetWhereStringRepo(cmblocation.Text, cmbvalue.Text, "tbldepartmentbed")
  If cmbdept.Text = "All" Then
    sql = "select " & xFldList.Join(",") & " from tbldepartmentbed where fldencounterval like &1" & xencid & xcolor & $RepoStr & " ORDER BY fldbed ASC"                       ''
    res = modDatabase.$myConn.Exec(sql, "%")
  Else If cmbdept.Text = "Unallocated" Then
    sql = "select " & xFldList.Join(",") & " from tblencounter where fldadmission=&1 and (fldcurrlocat IS NULL or fldcurrlocat NOT IN(select fldbed from tbldepartmentbed))" & xencid & $RepoStr
    res = modDatabase.$myConn.Exec(sql, "Admitted")
  Else If cmbdept.Text = "Waiting" Then
    sql = "select " & xFldList.Join(",") & " from tblconsult where fldoutcome=&1 and fldconsulttime>=&2 and fldconsulttime<=&3 and fldencounterval in(select fldencounterval from tblencounter where fldadmitbed IS NULL)" & xencid & $RepoStr
    res = modDatabase.$myConn.Exec(sql, "Admission", modDate.StartSqlDate(DateAdd(Now(), gb.Day, -7)), modDate.EndSqlDate(Now()))
  Else If cmbdept.Text = "Free Beds" Then
    sql = "select " & xFldList.Join(",") & " from tbldepartmentbed where (fldstatus IS NULL or fldstatus=&1) and fldencounterval IS NULL" & $RepoStr & " ORDER BY fldbed ASC"                       ''
    res = modDatabase.$myConn.Exec(sql, "Active")
  Else
    If rblocat.Value = True Then
      xunion = ""
      xorder = " ORDER BY fldbed ASC"
    Else If rbtriage.Value = True Then
      xunion = " inner join tblencounter on tbldepartmentbed.fldencounterval=tblencounter.fldencounterval"
      xorder = " ORDER BY FIELD(tblencounter.fldheight, '0', '65280', '16776960', '16711680') DESC"
    Endif

    If rball.Value = True Then
      If modBasic.$ClinDepartFormat = "Service" Then
        sql = "select " & xFldList.Join(",") & " from tbldepartmentbed" & xunion & " where (tbldepartmentbed.fldservice=&1 or tbldepartmentbed.fldaddservice=&1) and (tbldepartmentbed.fldstatus IS NULL or tbldepartmentbed.fldstatus<>&2)" & xencid & xcolor & $RepoStr & xorder                       ''
      Else
        sql = "select " & xFldList.Join(",") & " from tbldepartmentbed" & xunion & " where tbldepartmentbed.flddept=&1 and (tbldepartmentbed.fldstatus IS NULL or tbldepartmentbed.fldstatus<>&2)" & xencid & xcolor & $RepoStr & xorder                       ''
      Endif
      res = modDatabase.$myConn.Exec(sql, cmbdept.Text, "Inactive")
    Else
      If modBasic.$ClinDepartFormat = "Service" Then
        sql = "select " & xFldList.Join(",") & " from tbldepartmentbed" & xunion & " where tbldepartmentbed.fldencounterval like &1 and (tbldepartmentbed.fldservice=&2 or tbldepartmentbed.fldaddservice=&2)" & xencid & xcolor & $RepoStr & xorder
      Else
        sql = "select " & xFldList.Join(",") & " from tbldepartmentbed" & xunion & " where tbldepartmentbed.fldencounterval like &1 and tbldepartmentbed.flddept=&2" & xencid & xcolor & $RepoStr & xorder                       ''
      Endif
      res = modDatabase.$myConn.Exec(sql, "%", cmbdept.Text)
    Endif
  Endif
  Return res

End

Private Function GetGridViewValue(Column As Integer, xVariable As Variant) As Variant

  Dim xxx As Variant
  Dim i As Integer

  If Column = 5 Then
    xxx = modPatient.GetPatientNameByEnc(xVariable, modDatabase.$syConn) & "<br>" & "<small>" & modPatient.ShowDiscountCategEnc(xVariable) & "</small>"
  Else If Column = 6 Then
    If cmbdept.Text = "Free Beds" Then
      xxx = xVariable
    Else
      xxx = modPatient.GetPatientAgeString(xVariable, Now()) & modString.HTMLBlankSpace(1) & modPatient.GetPatientSex(xVariable, modDatabase.$syConn) & "<br>" & "<small>" & modReportVar.GetDateTimeReport(modPatient.GetAdmissionDate(xVariable), gb.GeneralDate) & "</small>"                           ''
    Endif
  Else If Column = 8 Then
    xxx = modPatient.PatientDiagnoCurrentList(xVariable).Join(gb.NewLine)
  Else If Column = 9 Then
    If chkshowdepart.Value = True Then
      xxx = modGeneral.GetUserFullName(modPatient.GetAttendingConsultant(xVariable))
    Else
      xxx = ""
    Endif
  Else If Column = 10 Then
    If chkshowdepart.Value = True Then
      xxx = GetPatientIndexing(xVariable)
    Else
      xxx = ""
    Endif

  Else If Column = 11 Then
    If chkshowstatus.Value = True Then
      xxx = GetClinStatusIcon(modClinSub.GetMedicineClinStaus(xVariable))
    Else
      xxx = ""
    Endif
  Else If Column = 12 Then
    If chkshowstatus.Value = True Then
      xxx = GetClinStatusIcon(modClinSub.GetLabClinStaus(xVariable))
    Else
      xxx = ""
    Endif
  Else If Column = 13 Then
    If chkshowstatus.Value = True Then
      xxx = GetClinStatusIcon(modClinSub.GetRadioClinStaus(xVariable))
    Else
      xxx = ""
    Endif
  Else If Column = 14 Then
    If chkshowstatus.Value = True Then
      xxx = GetClinStatusIcon(modClinSub.GetEquipClinStaus(xVariable))
    Else
      xxx = ""
    Endif
  Else If Column = 15 Then
    If chkshowstatus.Value = True Then
      xxx = GetClinStatusIcon(modClinSub.GetFluidsClinStaus(xVariable))
    Else
      xxx = ""
    Endif
  Else If Column = 16 Then
    If chkshowstatus.Value = True Then
      xxx = GetClinStatusIcon(modClinSub.GetDeviceClinStaus(xVariable))
    Else
      xxx = ""
    Endif

  Else
    xxx = xVariable
  Endif

  If $newColumn.Count Then
    For i = 0 To $newColumn.Count - 1
      If Column = $ColCount + i Then
        xxx = modCustPatient.NewColValue(Me.Tag, $newColumn[i], xVariable)
      Endif
    Next
  Endif

  Return xxx

End

Private Function GetClinStatusIcon(sVal As Integer) As String

  Dim xicon As String

  If sVal = 0 Then
    xicon = "/" &/ Application.Root &/ "icons/null.svg"
  Else If sVal = 1 Then
    xicon = "/" &/ Application.Root &/ "icons/coll5.png"
  Else If sVal = 2 Then
    xicon = "/" &/ Application.Root &/ "icons/coll6.png"
  Else If sVal = 3 Then
    xicon = "/" &/ Application.Root &/ "icons/coll4.png"
  Endif

  Return xicon

End

Private Function GetPatientIndexing(encid As String) As String

  Dim xfile As String
  Dim xipno As String
  Dim xxx As String[]

  xxx = New String[]
  xfile = modPatient.GetPatientFileByEnc(encid)
  xipno = modPatient.GetHMISAdmissionNo(encid)
  If xfile Then
    xxx.Add("<small><b>File : </b>" & xfile & "</small>")
  Endif
  If xipno Then
    xxx.Add("<small><b>IPNo : </b>" & xipno & "</small>")
  Endif

  Return xxx.Join("<br>")

End

Public Sub mnusearchconsult_Click()

  Dim xname As String
  Dim sql As String
  Dim xFldList As String[]

  xname = InputBox(("Search Consultant UserID"), "Search", "")
  If xname Then
    cmbdept.Text = "All"
    xFldList = GetSQLColumns()
    sql = "select " & xFldList.Join(",") & " from tbldepartmentbed where fldencounterval in(select fldencounterval from tblencounter where flduserid=&1)"
    $rData = modDatabase.$myConn.Exec(sql, xname)
    ResizeGrid()
  Endif

End

Public Sub mnusearchname_Click()

  Dim xname As String[]
  Dim sql As String
  Dim xFldList As String[]

  xname = InputDoubleText(("Search Patient Name"), ["First Name", "SurName"], ["%", "%"], modBasic.$SurNameList)
  If xname Then
    cmbdept.Text = "All"
    xFldList = GetSQLColumns()
    sql = "select " & xFldList.Join(",") & " from tbldepartmentbed where fldencounterval in(select fldencounterval from tblencounter where fldpatientval in(select fldpatientval from tblpatientinfo where lower(fldptnamefir) like &1 and lower(fldptnamelast) like &2))"
    $rData = modDatabase.$myConn.Exec(sql, LCase(xname[0]), LCase(xname[1]))
    ResizeGrid()
  Endif

End

Public Sub btnrefresh_Click()

  If cmbdept.Text Then
    FillBedGrid()
    modSettings.SaveSettingsToFile("IPClinic/DefaultDepart", cmbdept.Text)
    ShowOccupancy()
    ' GridView1.SetFocus
  Endif

End

Private Sub ShowOccupancy()

  Dim bedcount As Integer

  If modBasic.$ClinDepartFormat = "Service" Then
    bedcount = modGeneral.GetWardBedServiceCount(cmbdept.Text)
  Else
    bedcount = modGeneral.GetWardBedCount(cmbdept.Text)
  Endif
  If bedcount Then
    WebProgressBar1.Value = $rData.Count / bedcount
  Else
    WebProgressBar1.Value = 0
  Endif

End

Private Sub FillBedGrid()

  Dim xFldList As String[]

  xFldList = GetSQLColumns()
  $rData = ExecuteQuery(xFldList)
  ResizeGrid()

End

Private Sub ResizeGrid()

  Dim i As Integer

  Dim xvismode As String
  Dim noCols As Integer[]
  Dim Column As Integer

  $aMyFields = New String[]
  modGridView.ReadSmallData(GridView1, $rData, $aMyFields)
  $ColCount = $SSQLFields.Count

  With GridView1
    .Columns[0].Width = CStr(10 * modBasic.$AppWidthRatio) & "px"
    If chkshowdepart.Value = True Then
      .Columns[1].Hidden = False
      .Columns[2].Hidden = False
      .Columns[1].Width = CStr(35 * modBasic.$AppWidthRatio) & "px"
      .Columns[2].Width = CStr(35 * modBasic.$AppWidthRatio) & "px"
    Else
      .Columns[1].Hidden = True
      .Columns[2].Hidden = True
    Endif
    .Columns[3].Width = CStr(125 * modBasic.$AppWidthRatio) & "px"
    .Columns[4].Width = CStr(115 * modBasic.$AppWidthRatio) & "px"
    .Columns[5].Width = CStr(200 * modBasic.$AppWidthRatio) & "px"
    .Columns[6].Width = CStr(125 * modBasic.$AppWidthRatio) & "px"
    .Columns[7].Hidden = True
    .Columns[8].Width = CStr(200 * modBasic.$AppWidthRatio) & "px"
    If chkshowdepart.Value = True Then
      .Columns[9].Hidden = False
      .Columns[10].Hidden = False
      .Columns[9].Width = CStr(125 * modBasic.$AppWidthRatio) & "px"
      .Columns[10].Width = CStr(125 * modBasic.$AppWidthRatio) & "px"
    Else
      .Columns[9].Hidden = True
      .Columns[10].Hidden = True
    Endif
    If chkshowstatus.Value = True Then
      .Columns[11].Hidden = False
      .Columns[12].Hidden = False
      .Columns[13].Hidden = False
      .Columns[14].Hidden = False
      .Columns[15].Hidden = False
      .Columns[16].Hidden = False
      .Columns[11].Width = CStr(40 * modBasic.$AppWidthRatio) & "px"
      .Columns[12].Width = CStr(40 * modBasic.$AppWidthRatio) & "px"
      .Columns[13].Width = CStr(40 * modBasic.$AppWidthRatio) & "px"
      .Columns[14].Width = CStr(40 * modBasic.$AppWidthRatio) & "px"
      .Columns[15].Width = CStr(40 * modBasic.$AppWidthRatio) & "px"
      .Columns[16].Width = CStr(40 * modBasic.$AppWidthRatio) & "px"
    Else
      .Columns[11].Hidden = True
      .Columns[12].Hidden = True
      .Columns[13].Hidden = True
      .Columns[14].Hidden = True
      .Columns[15].Hidden = True
      .Columns[16].Hidden = True
    Endif
    If cmbdept.Text = "Unallocated" Then
      .Columns[17].Hidden = True
    Else
      .Columns[17].Width = CStr(100 * modBasic.$AppWidthRatio) & "px"
    Endif

    .Columns[3].Text = "Bed"
    .Columns[4].Text = "EncID"
    .Columns[5].Text = "Name"
    If cmbdept.Text = "Free Beds" Then
      .Columns[6].Text = "Department"
    Else
      .Columns[6].Text = "Age/Sex"
    Endif
    .Columns[8].Text = "Diagnosis"
    If chkshowdepart.Value = True Then
      .Columns[9].Text = "Consultant"
      .Columns[10].Text = "Indexing"
    Endif

    If chkshowstatus.Value = True Then
      .Columns[11].Text = "Drugs"
      .Columns[12].Text = "Labs"
      .Columns[13].Text = "Radio"
      .Columns[14].Text = "Equip"
      .Columns[15].Text = "Fluid"
      .Columns[16].Text = "Device"
    Endif

    If $newColumn.Count Then
      For i = 0 To $newColumn.Count - 1
        .Columns[$ColCount + i].Text = $newColumn[i]
        .Columns[$ColCount + i].Width = CStr(150 * modBasic.$AppWidthRatio) & "px"
      Next
    Endif
  End With

  xvismode = modSettings.ShowSettingFromFIle("ReportColumnVisibility/VisibilityMode")
  If xvismode = "Yes" Then
    noCols = modCHTMLReport.HideColumnExport()
    For Column = 0 To GridView1.Columns.Count - 1
      If noCols.Exist(Column) = True Then
        GridView1.Columns[Column].Hidden = True
      Endif
    Next
  Endif

End

Public Sub GridView1_Data(Row As Integer, Column As Integer, Data As WebTableData)

  $rData.MoveTo(Row)
  modGridView.GridViewDecoration(Data, Row)
  If Column = 0 Then
    Data.Text = ""
    If cmbdept.Text = "Free Beds" Then
      Data.Background = ShowFreeColor($rData[$aMyFields[Column]])
    Else
      Data.Background = modPatient.GetPatientColor($rData[$aMyFields[Column]])
    Endif
  Else If Column = 1 Then
    If chkshowdepart.Value = True Then
      Data.Html = modString.GetImageForHTMLGrid(GetOxygenIcon($rData[$aMyFields[Column]]), CStr(25 * modBasic.$AppWidthRatio) & "px", "auto")
    Endif
    Data.Text = ""
  Else If Column = 2 Then
    If chkshowdepart.Value = True Then
      Data.Html = modString.GetImageForHTMLGrid(GetVentilatorIcon($rData[$aMyFields[Column]]), CStr(25 * modBasic.$AppWidthRatio) & "px", "auto")
    Endif
    Data.Text = ""
  Else If Column = 5 Then
    Data.Html = GetGridViewValue(Column, $rData[$aMyFields[Column]])
  Else If Column = 6 Then
    Data.Html = GetGridViewValue(Column, $rData[$aMyFields[Column]])
  Else If Column = 8 Then
    Data.Text = GetGridViewValue(Column, $rData[$aMyFields[Column]])
  Else If Column = 9 Then
    Data.Text = GetGridViewValue(Column, $rData[$aMyFields[Column]])
  Else If Column = 10 Then
    Data.Html = GetGridViewValue(Column, $rData[$aMyFields[Column]])

  Else If Column = 11 Then
    If chkshowstatus.Value = True Then
      Data.Html = modString.GetImageForHTMLGrid(GetGridViewValue(Column, $rData[$aMyFields[Column]]), "auto", "auto")
      Data.Text = ""
    Endif
  Else If Column = 12 Then
    If chkshowstatus.Value = True Then
      Data.Html = modString.GetImageForHTMLGrid(GetGridViewValue(Column, $rData[$aMyFields[Column]]), "auto", "auto")
      Data.Text = ""
    Endif
  Else If Column = 13 Then
    If chkshowstatus.Value = True Then
      Data.Html = modString.GetImageForHTMLGrid(GetGridViewValue(Column, $rData[$aMyFields[Column]]), "auto", "auto")
      Data.Text = ""
    Endif
  Else If Column = 14 Then
    If chkshowstatus.Value = True Then
      Data.Html = modString.GetImageForHTMLGrid(GetGridViewValue(Column, $rData[$aMyFields[Column]]), "auto", "auto")
      Data.Text = ""
    Endif
  Else If Column = 15 Then
    If chkshowstatus.Value = True Then
      Data.Html = modString.GetImageForHTMLGrid(GetGridViewValue(Column, $rData[$aMyFields[Column]]), "auto", "auto")
      Data.Text = ""
    Endif
  Else If Column = 16 Then
    If chkshowstatus.Value = True Then
      Data.Html = modString.GetImageForHTMLGrid(GetGridViewValue(Column, $rData[$aMyFields[Column]]), "auto", "auto")
      Data.Text = ""
    Endif

  Else
    If Column > $SSQLFields.Count - 1 Then
      Data.Html = modString.TextToHTML(GetGridViewValue(Column, $rData[$aMyFields[Column]]))
    Else
      Data.Text = GetGridViewValue(Column, $rData[$aMyFields[Column]])
    Endif
  Endif

End

Private Function ShowFreeColor(sDischarge As Variant) As Integer

  Dim xx As String

  If modBasic.$ClinBedHoldTime Then
    If sDischarge And If TypeOf(sDischarge) = gb.Date Then
      If DateDiff(sDischarge, Now(), gb.Hour) <= modBasic.$ClinBedHoldTime Then
        xx = Color.Red
      Else
        xx = Color.White
      Endif
    Else
      xx = Color.White
    Endif
  Else
    xx = Color.White
  Endif
  Return xx

End

Public Sub GridView1_Select()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    SHowPatIndicators($rData["fldencounterval"])
  Endif

End

' Public Sub GridView1_KeyRelease()
'
'   If Key.Code = Key.Return Or If Key.Code = Key.Enter Or If Key.Code = Key.AltKey Then
'     If modHelpVariable.$LogInCategory = "Clinician" Then
'       OpenPatientForms()
'     Endif
'   Endif
'
' End

' Public Sub cmbdept_KeyRelease()
'
'   modFillContainer.AutoFillComboBox(cmbdept)
'   modFillContainer.RestrictComboToContent(cmbdept)
'
' End

''================= REPORTS ==========================
Public Sub mnunutrition_Click()

  Dim xPath As String
  Dim encList As String[]

  Dim xdate As Date

  encList = New String[]
  For Each $rData
    encList.Add($rData["fldencounterval"])
  Next
  If encList Then
    xdate = GetDateValue("Select Date", "Nutrition Report", Now())
    If xdate Then
      If modBasic.$ClinDietApprove = "Disable" Then
        xPath = modCHTMLPatSummary.GetPlannedFoodReport(xdate, encList, cmbdept.Text, "Planned", "Mixture Name")
      Else
        xPath = modCHTMLPatSummary.GetPlannedFoodReport(xdate, encList, cmbdept.Text, "Continue", "Mixture Name")
      Endif
      modControlSub.OpenHTMLPreview("", xPath, "ReportSize")
    Endif
  Endif

End

Public Sub mnuprogress_Click()

  Dim xPath As String
  Dim encList As String[]

  encList = New String[]
  For Each $rData
    encList.Add($rData["fldencounterval"])
  Next
  If encList Then
    xPath = modCHTMLPatSummary.GetHandOverReport(encList, cmbdept.Text)
    modControlSub.OpenHTMLPreview("", xPath, "ReportSize")
  Endif

End

Public Sub mnunoteall_Click()

  Dim xPath As String
  Dim encList As String[]

  encList = New String[]
  For Each $rData
    encList.Add($rData["fldencounterval"])
  Next
  If encList Then
    xPath = modCHTMLPatSummary.GetClinicalNotesReport(encList, cmbdept.Text)
    modControlSub.OpenHTMLPreview("", xPath, "ReportSize")
  Endif

End

Public Sub mnuvitalall_Click()

  Dim xPath As String
  Dim encList As String[]

  encList = New String[]
  For Each $rData
    encList.Add($rData["fldencounterval"])
  Next
  If encList Then
    xPath = modCHTMLPatSummary.GetVitalValReport(encList, cmbdept.Text)
    modControlSub.OpenHTMLPreview("", xPath, "ReportSize")
  Endif

End

''---------------- Reports ------------------
Public Sub btnexpo_Click()

  Dim xHeader As String[]
  Dim xhide As Integer[]
  Dim Column As Integer
  Dim xCollRow As Collection
  Dim xColum As Integer

  Dim $hGridExportTable As CExportResult
  Dim xparam1 As String
  Dim xparam2 As String
  Dim encColumn As Integer

  Dim xFldList As String[]

  xHeader = New String[]
  xhide = New Integer[]
  For Column = 0 To GridView1.Columns.Count - 1
    xHeader.Add(GridView1.Columns[Column].Text)
    If GridView1.Columns[Column].Hidden = True Then
      xhide.Add(Column)
    Endif
  Next
  xparam1 = cmbdept.Text
  xparam2 = modReportVar.GetDateTimeReport(Now(), gb.GeneralDate)
  encColumn = 1
  $hGridExportTable = New CExportResult(Me.Tag, xHeader, xhide, xparam1, xparam2, encColumn)

  xFldList = GetSQLColumns()

  For Each $rData
    xCollRow = New Collection
    For xColum = 0 To xFldList.Count - 1
      xCollRow.Add(GetGridViewValue(xColum, $rData[xFldList[xColum]]), CStr(xColum))
    Next
    $hGridExportTable.Add($rData.Index, xCollRow)
  Next

  modControlSub.DisplayReportExport($hGridExportTable.HTMLPath())

End

Public Sub mnudashboard_Click()

  Dim xPath As String
  Dim xdate As Date[]
  Dim xval As String

  If cmbdept.Text Then
    xdate = DoubleDates("Select Dates", "IP Summary", [Now(), Now()])
    If xdate Then
      If cmbdept.Text = "All" Then
        xval = "%"
      Else
        xval = cmbdept.Text
      Endif
      xPath = modCHTMLDate.GetIPEventsReport(modDatabase.$syConn, xdate[0], xdate[1], xval, cmblocation.Text, cmbvalue.Text)
      modControlSub.DisplayReportExport(xPath)
    Endif
  Endif

End

Public Sub mnusummall_Click()

  Dim xPath As String
  Dim xdate As Date[]

  xdate = DoubleDates("Select Dates", "IP Summary", [Now(), Now()])
  If xdate Then
    xPath = modCHTMLDate.GetIPEventsSummary(modDatabase.$syConn, xdate[0], xdate[1], modBasic.$IPDDepartmentsAll, cmblocation.Text, cmbvalue.Text)
    modControlSub.OpenHTMLPreview("", xPath, "ReportSize")
  Endif

End

Public Sub mnutoday_Click()

  Dim xPath As String
  Dim xval As String

  If cmbdept.Text Then
    If cmbdept.Text = "All" Then
      xval = "%"
    Else
      xval = cmbdept.Text
    Endif
    xPath = modCHTMLDate.GetIPEventsReport(modDatabase.$syConn, Now(), Now(), xval, cmblocation.Text, cmbvalue.Text)
    modControlSub.DisplayReportExport(xPath)
  Endif

End

Public Sub mnucurdepart_Click()

  Dim xPath As String

  Message.Info(("Generating Report ...."), ("OK"))
  xPath = modCHTMLPatSummary.ShowBedOccupancyReport("Current", cmbdept.Text)
  modControlSub.OpenHTMLPreview("", xPath, "ReportSize")

End

Public Sub mnudeptwise_Click()

  Dim xPath As String

  Message.Info(("Generating Report ...."), ("OK"))
  xPath = modCHTMLPatSummary.ShowWardOccupancyReport("Current")
  modControlSub.OpenHTMLPreview("", xPath, "ReportSize")

End

Public Sub mnudeptout_Click()

  Dim xPath As String

  Message.Info(("Generating Report ...."), ("OK"))
  xPath = modCHTMLPatSummary.ShowWardOccupancyReport("Outstanding")
  modControlSub.OpenHTMLPreview("", xPath, "ReportSize")

End

Public Sub mnucurconsult_Click()

  Dim xPath As String

  Message.Info(("Generating Report ...."), ("OK"))
  xPath = modCHTMLPatSummary.ShowBedOccupConsultReport("Current", cmbdept.Text)
  modControlSub.OpenHTMLPreview("", xPath, "ReportSize")

End

Public Sub mnuconsultwise_Click()

  Dim xPath As String

  Message.Info(("Generating Report ...."), ("OK"))
  xPath = modCHTMLPatSummary.ShowWardOccupConsultReport("Current")
  modControlSub.OpenHTMLPreview("", xPath, "ReportSize")

End

Public Sub mnuconsultout_Click()

  Dim xPath As String

  Message.Info(("Generating Report ...."), ("OK"))
  xPath = modCHTMLPatSummary.ShowWardOccupConsultReport("Outstanding")
  modControlSub.OpenHTMLPreview("", xPath, "ReportSize")

End

Public Sub mnucurpackage_Click()

  Dim xPath As String

  Message.Info(("Generating Report ...."), ("OK"))
  xPath = modCHTMLPatSummary.ShowBedOccupPackageDetail("Current", cmbdept.Text)
  modControlSub.OpenHTMLPreview("", xPath, "ReportSize")

End

Public Sub mnupackwise_Click()

  Dim xPath As String

  Message.Info(("Generating Report ...."), ("OK"))
  xPath = modCHTMLPatSummary.ShowWardOccupPackageDetail("Current")
  modControlSub.OpenHTMLPreview("", xPath, "ReportSize")

End

Public Sub mnupackout_Click()

  Dim xPath As String

  Message.Info(("Generating Report ...."), ("OK"))
  xPath = modCHTMLPatSummary.ShowWardOccupPackageDetail("Outstanding")
  modControlSub.OpenHTMLPreview("", xPath, "ReportSize")

End

Public Sub btnsummary_Click()

  Dim xPath As String

  xPath = modCHTMLPatSummary.ShowBedOccupPackageReport()
  modControlSub.OpenHTMLPreview("", xPath, "ReportSize")

End

''------------- Billing ----------------
Public Sub mnureport_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetSelectedPatientValues($rData["fldencounterval"], MMain.$defUnit)
  Endif

End

Public Sub btnautobill_Click()

  If modBasic.$AutoBillBed = "Standard" Or If modBasic.$AutoBillBed = "Full" Or If modBasic.$AutoBillBed = "Partial" Then
    Message.Warning(("Auto Billing of Bed Charges is enabled"), ("OK"))
  Else
    If Message.Question(("Are you sure?"), ("No"), ("Yes")) = 2 Then
      modBillings.GetAutoBillingRegularCharges("Bed Charge")
      btnautobill.Visible = False
    Endif
  Endif

End

Public Sub btnautoround_Click()

  If Message.Question(("Are you sure?"), ("No"), ("Yes")) = 2 Then
    modBillings.GetAutoBillingRegularCharges("Round Charge")
    btnautoround.Visible = False
  Endif

End

Private Sub ActivateAutoBilling()

  Dim xfir As Date
  Dim xlast As Date
  Dim dt As Date
  Dim yfir As String
  Dim ylast As String
  Dim aa As Integer
  Dim bb As Integer

  If GetAutoEntryRecord("Bed Charge") = True Then
  Else
    yfir = modGlobalSetting.ShowSettingFromDB("AutoServiceBilling/BedCharge_OnTime")
    ylast = modGlobalSetting.ShowSettingFromDB("AutoServiceBilling/BedCharge_OffTime")
    dt = Now()
    If yfir And If ylast Then
      aa = CInt(yfir)
      bb = CInt(ylast)
    Else
      aa = 19
      bb = 7
    Endif
    xfir = Date(Year(dt), Month(dt), Day(dt), aa, 0, 0, 0)
    xlast = Date(Year(dt), Month(dt), Day(dt), bb, 0, 0, 0)

    If aa < bb Then
      If xfir < dt And If xlast > dt Then
        btnautobill.Visible = True
      Endif
    Else If aa > bb Then
      If xfir < dt Or If xlast > dt Then
        btnautobill.Visible = True
      Endif
    Endif
  Endif

End

Private Sub ActivateAutoRound()

  Dim xfir As Date
  Dim xlast As Date
  Dim dt As Date
  Dim yfir As String
  Dim ylast As String
  Dim aa As Integer
  Dim bb As Integer

  If GetAutoEntryRecord("Round Charge") = True Then
  Else
    yfir = modGlobalSetting.ShowSettingFromDB("AutoServiceBilling/RoundCharge_OnTime")
    ylast = modGlobalSetting.ShowSettingFromDB("AutoServiceBilling/RoundCharge_OffTime")
    dt = Now()
    If yfir And If ylast Then
      aa = CInt(yfir)
      bb = CInt(ylast)
    Else
      aa = 5
      bb = 12
    Endif
    xfir = Date(Year(dt), Month(dt), Day(dt), aa, 0, 0, 0)
    xlast = Date(Year(dt), Month(dt), Day(dt), bb, 0, 0, 0)

    If aa < bb Then
      If xfir < dt And If xlast > dt Then
        btnautoround.Visible = True
      Endif
    Else If aa > bb Then
      If xfir < dt Or If xlast > dt Then
        btnautoround.Visible = True
      Endif
    Endif
  Endif

End

Private Function GetAutoEntryRecord(sType As String) As Boolean

  Dim res As Result
  Dim xdat As Date
  Dim xx As Boolean

  xdat = Now()
  res = modDatabase.$myConn.Exec("select fldhostmac from tblcronjob where fldcategory=&1 and fldtime>=&2 and fldtime<=&3", sType, modDate.StartSqlDate(xdat), modDate.EndSqlDate(xdat))
  If res.Available Then
    xx = True
  Else
    xx = False
  Endif
  Return xx

End

Private Function GetOxygenIcon(sBedVal As String) As String

  Dim sVal As String
  Dim sPath As String
  Dim res As Result

  If cmbdept.Text = "All" Then
    res = modDatabase.$myConn.Exec("select fldoxyport from tbldepartmentbed where fldbed=&1", sBedVal)
    If res.Available Then
      sVal = res["fldoxyport"]
    Else
      sVal = ""
    Endif
  Else
    sVal = sBedVal
  Endif

  If sVal = "Present" Then
    sPath = modMisc.GetWebIconPath("icons/oxygen.png")
  Else
    sPath = ""
  Endif
  Return sPath

End

Private Function GetVentilatorIcon(sBedVal As String) As String

  Dim sVal As String
  Dim sPath As String
  Dim res As Result

  If cmbdept.Text = "All" Then
    res = modDatabase.$myConn.Exec("select fldventilator from tbldepartmentbed where fldbed=&1", sBedVal)
    If res.Available Then
      sVal = res["fldventilator"]
    Else
      sVal = ""
    Endif
  Else
    sVal = sBedVal
  Endif

  If sVal = "Present" Then
    sPath = modMisc.GetWebIconPath("icons/ventilator.png")
  Else
    sPath = ""
  Endif
  Return sPath

End

Public Sub mnuColumns_Click()

  If Message.Question(modGridView.GetColumnsListString(GridView1), ("OK"), ("Setting")) = 2 Then
    fmChartSetting.ShowModal
  Endif

End

Public Sub mnuaddcolumn_Click()

  Dim hForm As FmAddNewColumn

  hForm = New FmAddNewColumn(Me.Tag)
  hForm.ShowModal

End

Private Sub GetComboItemList()

  If $UserRestrict.Exist("Patient History") = False Then
    btnall.Visible = True
  Endif
  If $UserRestrict.Exist("Demographics") = False Then
    mnudemographic.Visible = True
  Endif
  If $UserRestrict.Exist("Consultation Plan") = False Then
    mnureqconsult.Visible = True
  Endif
  If $UserRestrict.Exist("Essential Examinations") = False Then
    btnmobilevital.Visible = True
    btntriage.Visible = True
  Endif
  If $UserRestrict.Exist("Medicine Dosing") = False Then
    btndosing.Visible = True
  Endif
  If $UserRestrict.Exist("IV Infusion") = False Then
    btnmobivfl.Visible = True
  Endif
  If $UserRestrict.Exist("General Services") = False Then
    btnbilling.Visible = True
  Endif
  If $UserRestrict.Exist("Minor Procedure") = False Then
    btnmobminor.Visible = True
  Endif
  If $UserRestrict.Exist("Equipments Used") = False Then
    btnmobequip.Visible = True
  Endif
  If $UserRestrict.Exist("General Images") = False Then
    btnmobimage.Visible = True
    btndraw.Visible = True    ''''(incomplete)
  Endif
  If $UserRestrict.Exist("Video Data") = False Then
    btnvideo.Visible = True
  Endif
  If $UserRestrict.Exist("PACS Images") = False Then
    btnmobpacs.Visible = True
  Endif
  If $UserRestrict.Exist("Devices Used") = False Then
    btnmobevent.Visible = True
  Endif
  If $UserRestrict.Exist("Clinical Findings") = False Then
    btnmobexam.Visible = True
    btnmobexamall.Visible = True
    mnuformatexams.Visible = True
  Endif
  If $UserRestrict.Exist("Clinical Notes") = False Then
    btnmobnote.Visible = True
  Endif

  If $UserRestrict.Exist("Laboratory Request") = False Then
    btnlabs.Visible = True
  Endif
  If $UserRestrict.Exist("Radiology Request") = False Then
    btnradio.Visible = True
  Endif
  If $UserRestrict.Exist("Pharmacy Request") = False Then
    btnpharm.Visible = True
  Endif
  If $UserRestrict.Exist("PO Intake Plan") = False Then
    btndiet.Visible = True
  Endif
  If $UserRestrict.Exist("Provisional Diagnosis") = False Then
    btnmobilediagno.Visible = True
    btnobsdiagno.Visible = True
  Endif

End

''============================== Mobile apps ===========================
Public Sub btnmobilevital_Click()

  Dim hForm As FmVItalMobile

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmVItalMobile($rData["fldencounterval"])
    hForm.ShowModal
  Endif

End

Public Sub btnmobilebed_Click()

  Dim xbed As String
  Dim abed As String

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    If $rData["fldencounterval"] Then
      If cmbdept.Text = "Unallocated" Then
        abed = $rData["fldcurrlocat"]
      Else
        abed = $rData["fldbed"]
      Endif
      xbed = GetBedNumber($rData["fldencounterval"])
      If abed <> xbed Then
        FillBedGrid()
      Endif
    Endif
  Endif

End

Public Sub mnudemographic_Click()

  Dim hForm7 As FmPatdemograph

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm7 = New FmPatdemograph($rData["fldencounterval"], "Clinical")
    hForm7.ShowModal
  Endif

End

Public Sub btnmobilediagno_Click()

  Dim xGroup As String
  Dim sName As String[]
  Dim Row As Integer

  If GridView1.Selection.Count Then
    Row = GridView1.Selection[0]
    $rData.MoveTo(GridView1.Selection[0])
    If MMain.$Ayurveda = "Yes" Then
      sName = AyurvedicDiagnosis(modAyurv.$AyurvedicDiagnosis)
    Else
      xGroup = modPathoSub.GetDiagnoGroupForService($rData["fldbed"])
      If xGroup Then
        sName = ICDTree(modDatabase.$icdConn, "Disease", modBasic.$ClinDiagnoChapterGrouped, xGroup, modBasic.$FixDiagnoGroupER, modBasic.$ClinDiagnoSelectGrouped, modBasic.$ClinDiagnoSelectERGroup)
      Else
        sName = ICDTree(modDatabase.$icdConn, "Disease", modBasic.$ClinDiagnoChapterGrouped, modBasic.$FixDiagnoGroupOPD, modBasic.$FixDiagnoGroupER, modBasic.$ClinDiagnoSelectGrouped, modBasic.$ClinDiagnoSelectERGroup)
      Endif
    Endif
    If sName Then
      If sName[1] And If sName[0] Then
        modPatientGeneral.AddPatientFindings("Provisional Diagnosis", $rData["fldencounterval"], sName[0], sName[1], sName[2])
        Me.Exec(Subst("Toastify({text: '&1', duration: &2}).showToast()", "Information saved", modBasic.$BalloonDelay))
        FillBedGrid()
      Endif
    Endif
    GridView1.Select(Row)
  Endif

End

Public Sub btnIPform_Click()

  Dim hForm As FmPatientMain
  Dim hForm1 As FmNursingForm

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    Me.Parent.DeleteChildren()
    If modGeneralMain.$HideFormList.Exist("Clinician Form") = True Then
      hForm1 = New FmNursingForm($rData["fldencounterval"], fmOfficer.Workspace1)
    Else
      modGeneralMain.$FormOpenList.Add(["fmClinBedList"])
      hForm = New FmPatientMain($rData["fldencounterval"], fmOfficer.Workspace1)
    Endif
  Endif

End

Public Sub btnvideo_Click()

  Dim hForm8 As FmPatVideo

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm8 = New FmPatVideo("VIDEO", $rData["fldencounterval"], "")
    hForm8.ShowModal
  Endif

End

Public Sub btntriage_Click()

  Dim xcol As String
  Dim xback As Integer
  Dim Row As Integer

  If GridView1.Selection.Count Then
    Row = GridView1.Selection[0]
    $rData.MoveTo(GridView1.Selection[0])
    xback = modPatient.GetPatientColor($rData["fldencounterval"])
    xcol = InputColor("Triage", CStr(xback))
    If xcol Then
      modPatient.SetPatientColor($rData["fldencounterval"], xcol)
      FillBedGrid()
    Endif
    GridView1.Select(Row)
  Endif

End

Public Sub btnlabs_Click()

  Dim hForm10 As FmTestList

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    If modNonMedical.AllowEntryWithDeposit($rData["fldencounterval"], "Test") = True Then
      hForm10 = New FmTestList($rData["fldencounterval"], modNonMedical.GetAutoIPBillingPack("Test", $rData["fldencounterval"]))
      hForm10.ShowModal
      SHowPatIndicators($rData["fldencounterval"])
    Endif
  Endif

End

Public Sub btnradio_Click()

  Dim hForm11 As FmRadioList

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    If modNonMedical.AllowEntryWithDeposit($rData["fldencounterval"], "Radio") = True Then
      hForm11 = New FmRadioList($rData["fldencounterval"], modNonMedical.GetAutoIPBillingPack("Radio", $rData["fldencounterval"]))
      hForm11.ShowModal
      SHowPatIndicators($rData["fldencounterval"])
    Endif
  Endif

End

Public Sub btnpharm_Click()

  Dim hForm12 As FmMedOrder

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    If modNonMedical.AllowEntryWithDeposit($rData["fldencounterval"], "Pharmacy") = True Then
      If modBasic.$MedRequestForm = "Separate" Then
      Else
        hForm12 = New FmMedOrder($rData["fldencounterval"], "Admitted", modNonMedical.GetAutoIPBillingPack("Pharmacy", $rData["fldencounterval"]))
        hForm12.ShowModal
      Endif
      SHowPatIndicators($rData["fldencounterval"])
    Endif
  Endif

End

Public Sub btndiet_Click()

  Dim hForm15 As FmFoodPlan

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm15 = New FmFoodPlan($rData["fldencounterval"])
    hForm15.ShowModal
  Endif

End

Public Sub btndosing_Click()

  Dim hForm4 As FmDoseMobile

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm4 = New FmDoseMobile($rData["fldencounterval"])
    hForm4.ShowModal
  Endif

End

Public Sub mnucomplete_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetSelectedPatientValues($rData["fldencounterval"], MMain.$defUnit)
  Endif

End

Public Sub btnmobexam_Click()

  Dim hForm As FmEnterGroupExam
  Dim hForm1 As FmWardHistoryMin

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    If modBasic.$ClinIPDExamination Then
      hForm1 = New FmWardHistoryMin(modBasic.$ClinIPDExamination, $rData["fldencounterval"], "Physician Examinations")
      hForm1.ShowModal
    Else
      hForm = New FmEnterGroupExam($rData["fldencounterval"], "Physician Examinations", "Group", modBasic.$compID)
      hForm.ShowModal
    Endif
  Endif

End

Public Sub btnmobexamall_Click()

  Dim hForm21 As FmEnterGroupExam

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm21 = New FmEnterGroupExam($rData["fldencounterval"], "Physician Examinations", "All", modBasic.$compID)
    hForm21.ShowModal
  Endif

End

Public Sub btnmobnote_Click()

  Dim hForm As FmMobileForm

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmMobileForm($rData["fldencounterval"], "Notes")
    hForm.ShowModal
  Endif

End

Public Sub btnmobequip_Click()

  Dim hForm6 As FmEquipment

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    If modNonMedical.AllowEntryWithDeposit($rData["fldencounterval"], "Equipment") = True Then
      hForm6 = New FmEquipment($rData["fldencounterval"], modNonMedical.GetAutoIPBillingPack("Equipment", $rData["fldencounterval"]))
      hForm6.ShowModal
      SHowPatIndicators($rData["fldencounterval"])
    Endif
  Endif

End

Public Sub btnall_Click()

  Dim hForm As FmHistoryMobile

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmHistoryMobile($rData["fldencounterval"])
    hForm.ShowModal
  Endif

End

Public Sub btnmobevent_Click()

  Dim hForm9 As FmDeviceUse

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm9 = New FmDeviceUse($rData["fldencounterval"], "Devices")
    hForm9.ShowModal
    SHowPatIndicators($rData["fldencounterval"])
  Endif

End

Public Sub btnmobimage_Click()

  Dim hForm8 As FmPatImage

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm8 = New FmPatImage("IMAGE", $rData["fldencounterval"], "")
    hForm8.ShowModal
  Endif

End

Public Sub btnmobpacs_Click()

  Dim hForm As FmPacsShow

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmPacsShow($rData["fldencounterval"], "Visit")
    hForm.ShowModal
  Endif

End

Public Sub btnmobivfl_Click()

  Dim hForm18 As FmIVInfusion

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm18 = New FmIVInfusion($rData["fldencounterval"])
    hForm18.ShowModal
  Endif

End

Public Sub btnmobminor_Click()

  Dim hForm5 As FmMiniProcedure

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    If modNonMedical.AllowEntryWithDeposit($rData["fldencounterval"], "Procedure") = True Then
      hForm5 = New FmMiniProcedure($rData["fldencounterval"], modNonMedical.GetAutoIPBillingPack("Procedure", $rData["fldencounterval"]))
      hForm5.ShowModal
    Endif
  Endif

End

Public Sub btnbilling_Click()

  Dim hForm14 As FmMiniService
  Dim xservmode As String
  Dim xprocmode As String
  Dim xothermode As String
  Dim xpharmmode As String

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xservmode = modNonMedical.GetAutoIPBillingPack("Service", $rData["fldencounterval"])
    xprocmode = modNonMedical.GetAutoIPBillingPack("Procedure", $rData["fldencounterval"])
    xothermode = modNonMedical.GetAutoIPBillingPack("Others", $rData["fldencounterval"])
    xpharmmode = modNonMedical.GetAutoIPBillingPack("Pharmacy", $rData["fldencounterval"])
    hForm14 = New FmMiniService($rData["fldencounterval"], xservmode, xprocmode, xothermode, xpharmmode)
    hForm14.ShowModal
  Endif

End

Public Sub btndraw_Click()

  Dim ximg As String
  Dim xval As String

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    ximg = CustomDraw()
    If ximg Then
      xval = modImage.SaveClinicScreenDraw($rData["fldencounterval"], modString.GetDateString(Now()), ximg)
    Endif
  Endif

End

''------------------------------------ custom menus -----------------------------------
Private Sub FillCustomMenu()

  Dim xform1 As String
  Dim xform2 As String
  Dim xform3 As String
  Dim xform4 As String
  Dim xform5 As String
  Dim xform6 As String
  Dim xform7 As String
  Dim xform8 As String
  Dim xform9 As String
  Dim xform10 As String

  xform1 = modSettings.ShowSettingFromFIle("CustomReport1/Name")
  xform2 = modSettings.ShowSettingFromFIle("CustomReport2/Name")
  xform3 = modSettings.ShowSettingFromFIle("CustomReport3/Name")
  xform4 = modSettings.ShowSettingFromFIle("CustomReport4/Name")
  xform5 = modSettings.ShowSettingFromFIle("CustomReport5/Name")
  xform6 = modSettings.ShowSettingFromFIle("CustomReport6/Name")
  xform7 = modSettings.ShowSettingFromFIle("CustomReport7/Name")
  xform8 = modSettings.ShowSettingFromFIle("CustomReport8/Name")
  xform9 = modSettings.ShowSettingFromFIle("CustomReport9/Name")
  xform10 = modSettings.ShowSettingFromFIle("CustomReport10/Name")

  If xform1 Then
    mnucust1.Title = xform1
    mnucust1.Tag = "CustomReport1"
    mnucust1.Visible = True
  Endif

  If xform2 Then
    mnucust2.Title = xform2
    mnucust2.Tag = "CustomReport2"
    mnucust2.Visible = True
  Endif

  If xform3 Then
    mnucust3.Title = xform3
    mnucust3.Tag = "CustomReport3"
    mnucust3.Visible = True
  Endif

  If xform4 Then
    mnucust4.Title = xform4
    mnucust4.Tag = "CustomReport4"
    mnucust4.Visible = True
  Endif

  If xform5 Then
    mnucust5.Title = xform5
    mnucust5.Tag = "CustomReport5"
    mnucust5.Visible = True
  Endif

  If xform6 Then
    mnucust6.Title = xform6
    mnucust6.Tag = "CustomReport6"
    mnucust6.Visible = True
  Endif

  If xform7 Then
    mnucust7.Title = xform7
    mnucust7.Tag = "CustomReport7"
    mnucust7.Visible = True
  Endif

  If xform8 Then
    mnucust8.Text = xform8
    mnucust8.Tag = "CustomReport8"
    mnucust8.Visible = True
  Endif

  If xform9 Then
    mnucust9.Title = xform9
    mnucust9.Tag = "CustomReport9"
    mnucust9.Visible = True
  Endif

  If xform10 Then
    mnucust10.Title = xform10
    mnucust10.Tag = "CustomReport10"
    mnucust10.Visible = True
  Endif

End

''''------------------------------- custom report menu ---------------------------------------------------
Public Sub mnucust1_Click()

  Dim hCls As CReportCustom

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hCls = New CReportCustom($rData["fldencounterval"], mnucust1.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Public Sub mnucust2_Click()

  Dim hCls As CReportCustom

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hCls = New CReportCustom($rData["fldencounterval"], mnucust2.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Public Sub mnucust3_Click()

  Dim hCls As CReportCustom

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hCls = New CReportCustom($rData["fldencounterval"], mnucust3.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Public Sub mnucust4_Click()

  Dim hCls As CReportCustom

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hCls = New CReportCustom($rData["fldencounterval"], mnucust4.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Public Sub mnucust5_Click()

  Dim hCls As CReportCustom

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hCls = New CReportCustom($rData["fldencounterval"], mnucust5.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Public Sub mnucust6_Click()

  Dim hCls As CReportCustom

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hCls = New CReportCustom($rData["fldencounterval"], mnucust6.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Public Sub mnucust7_Click()

  Dim hCls As CReportCustom

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hCls = New CReportCustom($rData["fldencounterval"], mnucust7.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Public Sub mnucust8_Click()

  Dim hCls As CReportCustom

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hCls = New CReportCustom($rData["fldencounterval"], mnucust8.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Public Sub mnucust9_Click()

  Dim hCls As CReportCustom

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hCls = New CReportCustom($rData["fldencounterval"], mnucust9.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Public Sub mnucust10_Click()

  Dim hCls As CReportCustom

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hCls = New CReportCustom($rData["fldencounterval"], mnucust10.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

''========================== chart ========================
Private Sub FillCustomFormMenu()

  Dim xList As String[]

  xList = modControlSub.GetDirectFillresult(modDatabase.$myConn.Exec("select distinct(fldtitle) as col from tbldepartchart where (fldcomp=&1 or fldcomp=&2)", modBasic.$compID, "%"))

  If xList.Count > 0 Then
    mnucustform1.Text = xList[0]
    mnucustform1.Tag = xList[0]
    mnucustform1.Visible = True
  Endif

  If xList.Count > 1 Then
    mnucustform2.Text = xList[1]
    mnucustform2.Tag = xList[1]
    mnucustform2.Visible = True
  Endif

  If xList.Count > 2 Then
    mnucustform3.Text = xList[2]
    mnucustform3.Tag = xList[2]
    mnucustform3.Visible = True
  Endif

  If xList.Count > 3 Then
    mnucustform4.Text = xList[3]
    mnucustform4.Tag = xList[3]
    mnucustform4.Visible = True
  Endif

  If xList.Count > 4 Then
    mnucustform5.Text = xList[4]
    mnucustform5.Tag = xList[4]
    mnucustform5.Visible = True
  Endif

  If xList.Count > 5 Then
    mnucustform6.Text = xList[5]
    mnucustform6.Tag = xList[5]
    mnucustform6.Visible = True
  Endif

  If xList.Count > 6 Then
    mnucustform7.Text = xList[6]
    mnucustform7.Tag = xList[6]
    mnucustform7.Visible = True
  Endif

  If xList.Count > 7 Then
    mnucustform8.Text = xList[7]
    mnucustform8.Tag = xList[7]
    mnucustform8.Visible = True
  Endif

  If xList.Count > 8 Then
    mnucustform9.Text = xList[8]
    mnucustform9.Tag = xList[8]
    mnucustform9.Visible = True
  Endif

  If xList.Count > 9 Then
    mnucustform10.Text = xList[9]
    mnucustform10.Tag = xList[9]
    mnucustform10.Visible = True
  Endif

End

Public Sub mnuessenexam_Click()

  Dim hForm As FmMultiChart

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmMultiChart($rData["fldencounterval"], "Essential Examinations", LabUnitForm())
    hForm.ShowModal
  Endif

End

Public Sub mnucustform1_Click()

  Dim hForm As FmMultiChart

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmMultiChart($rData["fldencounterval"], mnucustform1.Tag, LabUnitForm())
    hForm.ShowModal
  Endif

End

Public Sub mnucustform2_Click()

  Dim hForm As FmMultiChart

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmMultiChart($rData["fldencounterval"], mnucustform2.Tag, LabUnitForm())
    hForm.ShowModal
  Endif

End

Public Sub mnucustform3_Click()

  Dim hForm As FmMultiChart

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmMultiChart($rData["fldencounterval"], mnucustform3.Tag, LabUnitForm())
    hForm.ShowModal
  Endif

End

Public Sub mnucustform4_Click()

  Dim hForm As FmMultiChart

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmMultiChart($rData["fldencounterval"], mnucustform4.Tag, LabUnitForm())
    hForm.ShowModal
  Endif

End

Public Sub mnucustform5_Click()

  Dim hForm As FmMultiChart

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmMultiChart($rData["fldencounterval"], mnucustform5.Tag, LabUnitForm())
    hForm.ShowModal
  Endif

End

Public Sub mnucustform6_Click()

  Dim hForm As FmMultiChart

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmMultiChart($rData["fldencounterval"], mnucustform6.Tag, LabUnitForm())
    hForm.ShowModal
  Endif

End

Public Sub mnucustform7_Click()

  Dim hForm As FmMultiChart

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmMultiChart($rData["fldencounterval"], mnucustform7.Tag, LabUnitForm())
    hForm.ShowModal
  Endif

End

Public Sub mnucustform8_Click()

  Dim hForm As FmMultiChart

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmMultiChart($rData["fldencounterval"], mnucustform8.Tag, LabUnitForm())
    hForm.ShowModal
  Endif

End

Public Sub mnucustform9_Click()

  Dim hForm As FmMultiChart

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmMultiChart($rData["fldencounterval"], mnucustform9.Tag, LabUnitForm())
    hForm.ShowModal
  Endif

End

Public Sub mnucustform10_Click()

  Dim hForm As FmMultiChart

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmMultiChart($rData["fldencounterval"], mnucustform10.Tag, LabUnitForm())
    hForm.ShowModal
  Endif

End

''========================= Indicators ================
Private Sub SHowPatIndicators(encid As String)

  Dim xlab As Boolean
  Dim xradio As Boolean
  Dim xpharm As Boolean
  Dim xequip As Boolean
  Dim xevent As Boolean

  xlab = modClinSub.GetLabTestPending(encid)
  If xlab = True Then
    btnlabs.Foreground = Color.Red
  Else
    btnlabs.Foreground = Color.Default
  Endif

  xradio = modClinSub.GetRadioTestPending(encid)
  If xradio = True Then
    btnradio.Foreground = Color.Red
  Else
    btnradio.Foreground = Color.Default
  Endif

  xpharm = modClinSub.GetPharmacyPending(encid)
  If xpharm = True Then
    btnpharm.Foreground = Color.Red
  Else
    btnpharm.Foreground = Color.Default
  Endif

  xequip = modClinSub.GetEquipmentPending(encid)
  If xequip = True Then
    btnmobequip.Foreground = Color.Red
  Else
    btnmobequip.Foreground = Color.Default
  Endif

  xevent = modClinSub.GetDevicePending(encid)
  If xevent = True Then
    btnmobevent.Foreground = Color.Red
  Else
    btnmobevent.Foreground = Color.Default
  Endif

End

Public Sub mnucurarchive_Click()

  Dim xxx As String[]

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xxx = AddReports($rData["fldencounterval"], False)
  Endif

End

Public Sub mnulabview_Click()

  Dim xPath As String

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xPath = modCHTMLPatient.ShowPatientLaboratoryReport($rData["fldencounterval"], LabUnitForm())
    modControlSub.OpenHTMLPreview($rData["fldencounterval"], xPath, "ReportSize")
  Endif

End

Public Sub mnuexamview_Click()

  Dim xPath As String

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xPath = modCHTMLPatient.ShowPatientExaminationgReport($rData["fldencounterval"])
    modControlSub.OpenHTMLPreview($rData["fldencounterval"], xPath, "ReportSize")
  Endif

End

Public Sub mnuradioview_Click()

  Dim xPath As String

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xPath = modCHTMLPatient.ShowPatRadioReportbyEncID($rData["fldencounterval"])
    modControlSub.OpenHTMLPreview($rData["fldencounterval"], xPath, "ReportSize")
  Endif

End

Public Sub mnumedview_Click()

  Dim xPath As String

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xPath = modCHTMLPatient.ShowNursingDosing($rData["fldencounterval"])
    modControlSub.OpenHTMLPreview($rData["fldencounterval"], xPath, "ReportSize")
  Endif

End

Public Sub mnuhistoreport_Click()

  Dim xPath As String

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xPath = modCHTMLPatient.ShowPatientHistoryReport($rData["fldencounterval"])
    modControlSub.OpenHTMLPreview($rData["fldencounterval"], xPath, "ReportSize")
  Endif

End

Public Sub mnunoteview_Click()

  Dim xPath As String

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xPath = modCHTMLPatient.ShowPatientNoteReport($rData["fldencounterval"], "Inpatient Notes")
    modControlSub.OpenHTMLPreview($rData["fldencounterval"], xPath, "ReportSize")
  Endif

End

Public Sub mnuplanview_Click()

  Dim xPath As String

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xPath = modCHTMLPatient.ShowPatientPlanningReport($rData["fldencounterval"], "Clinician Plan")
    modControlSub.OpenHTMLPreview($rData["fldencounterval"], xPath, "ReportSize")
  Endif

End

Public Sub mnuprogresview_Click()

  Dim xPath As String

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xPath = modCHTMLPatient.ShowPatientPlanningReport($rData["fldencounterval"], "IP Monitoring")
    modControlSub.OpenHTMLPreview($rData["fldencounterval"], xPath, "ReportSize")
  Endif

End

Public Sub mnuexpense_Click()

  Dim xPath As String

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xPath = modCHTMLInvoice.ShowTotalExpensebyPatient(modDatabase.$syConn, $rData["fldencounterval"], "Complete")
    modControlSub.OpenHTMLPreview($rData["fldencounterval"], xPath, "ReportSize")
  Endif

End

''===================== Structured exams==========================
Private Sub FillExamMenu()

  If $structExamList.Count > 0 Then
    mnurec1.Text = $structExamList[0]
    mnurec1.Visible = True
  Endif

  If $structExamList.Count > 1 Then
    mnurec2.Text = $structExamList[1]
    mnurec2.Visible = True
  Endif

  If $structExamList.Count > 2 Then
    mnurec3.Text = $structExamList[2]
    mnurec3.Visible = True
  Endif

  If $structExamList.Count > 3 Then
    mnurec4.Text = $structExamList[3]
    mnurec4.Visible = True
  Endif

  If $structExamList.Count > 4 Then
    mnurec5.Text = $structExamList[4]
    mnurec5.Visible = True
  Endif

  If $structExamList.Count > 5 Then
    mnurec6.Text = $structExamList[5]
    mnurec6.Visible = True
  Endif

  If $structExamList.Count > 6 Then
    mnurec7.Text = $structExamList[6]
    mnurec7.Visible = True
  Endif

  If $structExamList.Count > 7 Then
    mnurec8.Text = $structExamList[7]
    mnurec8.Visible = True
  Endif

  If $structExamList.Count > 8 Then
    mnurec9.Text = $structExamList[8]
    mnurec9.Visible = True
  Endif

  If $structExamList.Count > 9 Then
    mnurec10.Text = $structExamList[9]
    mnurec10.Visible = True
  Endif

End

Public Sub mnurec1_Click()

  Dim hForm As FmWardHistoryMin

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmWardHistoryMin(mnurec1.Text, $rData["fldencounterval"], "Physician Examinations")
    hForm.ShowModal
  Endif

End

Public Sub mnurec2_Click()

  Dim hForm As FmWardHistoryMin

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmWardHistoryMin(mnurec2.Text, $rData["fldencounterval"], "Physician Examinations")
    hForm.ShowModal
  Endif

End

Public Sub mnurec3_Click()

  Dim hForm As FmWardHistoryMin

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmWardHistoryMin(mnurec3.Text, $rData["fldencounterval"], "Physician Examinations")
    hForm.ShowModal
  Endif

End

Public Sub mnurec4_Click()

  Dim hForm As FmWardHistoryMin

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmWardHistoryMin(mnurec4.Text, $rData["fldencounterval"], "Physician Examinations")
    hForm.ShowModal
  Endif

End

Public Sub mnurec5_Click()

  Dim hForm As FmWardHistoryMin

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmWardHistoryMin(mnurec5.Text, $rData["fldencounterval"], "Physician Examinations")
    hForm.ShowModal
  Endif

End

Public Sub mnurec6_Click()

  Dim hForm As FmWardHistoryMin

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmWardHistoryMin(mnurec6.Text, $rData["fldencounterval"], "Physician Examinations")
    hForm.ShowModal
  Endif

End

Public Sub mnurec7_Click()

  Dim hForm As FmWardHistoryMin

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmWardHistoryMin(mnurec7.Text, $rData["fldencounterval"], "Physician Examinations")
    hForm.ShowModal
  Endif

End

Public Sub mnurec8_Click()

  Dim hForm As FmWardHistoryMin

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmWardHistoryMin(mnurec8.Text, $rData["fldencounterval"], "Physician Examinations")
    hForm.ShowModal
  Endif

End

Public Sub mnurec9_Click()

  Dim hForm As FmWardHistoryMin

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmWardHistoryMin(mnurec9.Text, $rData["fldencounterval"], "Physician Examinations")
    hForm.ShowModal
  Endif

End

Public Sub mnurec10_Click()

  Dim hForm As FmWardHistoryMin

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmWardHistoryMin(mnurec10.Text, $rData["fldencounterval"], "Physician Examinations")
    hForm.ShowModal
  Endif

End

Public Sub btnobsdiagno_Click()

  Dim xsex As String
  Dim sName As String[]
  Dim Row As Integer

  If GridView1.Selection.Count Then
    Row = GridView1.Selection[0]
    $rData.MoveTo(GridView1.Selection[0])
    xsex = modPatient.GetPatientSex($rData["fldencounterval"], modDatabase.$myConn)
    If xsex = "Female" Then
      sName = DiagnoObstetrics($rData["fldencounterval"], True)
      FillBedGrid()
    Endif
    GridView1.Select(Row)
  Endif

End

''---------------- services -------------
Public Sub mnusetservice_Click()

  Dim xservice As String

  If GridView1.Selection.Count Then
    If cmbdept.Text = "Unallocated" Then
    Else If cmbdept.Text = "Free Beds" Then
    Else
      xservice = GridViewNew("Select Service to assign", modBasic.$IPDServDepartments, False)
      If xservice Then
        $rData.MoveTo(GridView1.Selection[0])
        modPatientSub.SetPatientBedService($rData["fldbed"], xservice)
      Endif
    Endif
  Endif

End

Public Sub mnugenviolence_Click()

  Dim hForm As FmGenViolence

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmGenViolence($rData["fldencounterval"])
    hForm.ShowModal
  Endif

End

Public Sub mnuvaccination_Click()

  Dim hForm As FmVaccine

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmVaccine($rData["fldencounterval"])
    hForm.ShowModal
  Endif

End

Public Sub mnureqconsult_Click()

  Dim hForm As FmMiniConsult

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmMiniConsult($rData["fldencounterval"], modNonMedical.GetAutoIPBillingPack("Service", $rData["fldencounterval"]))
    hForm.ShowModal
  Endif

End

Public Sub mnuscanner_Click()

  Dim hForm As FmScanForm

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmScanForm($rData["fldencounterval"], "Scanned Images", "")
    hForm.ShowModal
  Endif

End

Public Sub mnucountuni_Click()

  Dim Column As Integer
  Dim xFieColm As String
  Dim res As Result
  Dim yval As Variant

  Dim xColl As Collection
  Dim xFldList As String[]
  Dim xPath As String

  Column = ListIndex("Column Index", modGridView.GetGridViewColumns(GridView1))
  If Column + 1 > 0 Then
    xFldList = GetSQLColumns()
    xFieColm = xFldList[Column]
    res = ExecuteQuery([xFieColm])
    xColl = New Collection
    If res.Available Then
      For Each res
        yval = GetGridViewValue(Column, res[xFieColm])
        If yval Then
          If xColl.Exist(CStr(yval)) Then
            xColl[CStr(yval)] = xColl[CStr(yval)] + 1
          Else
            xColl[CStr(yval)] = 1
          Endif
        Endif
      Next
    Endif
    If xColl.Count Then
      xPath = modCHTMLReport.CreateHTMLReportFromCollection(["Variable", "Count"], xColl, GridView1.Columns[Column].Text, modReportVar.GetDateTimeReport(Now(), gb.GeneralDate))
    Endif

    modControlSub.OpenHTMLPreview("", xPath, "ReportSize")
  Endif

End

''----------- History ----------
Public Sub mnuexamlocal_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetPatHistoryLocalResult("Examination", $rData["fldencounterval"], LabUnitForm())
  Endif

End

Public Sub mnuexamrepo_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetRepoHistoryLocalResult("Examination", $rData["fldencounterval"], LabUnitForm())
  Endif

End

Public Sub mnulabhist_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetPatHistoryLocalResult("Laboratory", $rData["fldencounterval"], LabUnitForm())
  Endif

End

Public Sub mnulabviewrepo_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetRepoHistoryLocalResult("Laboratory", $rData["fldencounterval"], LabUnitForm())
  Endif

End

Public Sub mnuarchlab_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetArchiveReportResult("Diagnostic Tests", modPatient.GetPatientNoByEnc($rData["fldencounterval"]))
  Endif

End

Public Sub mnuarchlabrepo_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetRepoArchiveReportResult("Diagnostic Tests", modPatient.GetPatientNoByEnc($rData["fldencounterval"]))
  Endif

End

Public Sub mnuradiohist_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetPatHistoryLocalResult("Radiology", $rData["fldencounterval"], LabUnitForm())
  Endif

End

Public Sub mnuradioviewrepo_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetRepoHistoryLocalResult("Radiology", $rData["fldencounterval"], LabUnitForm())
  Endif

End

Public Sub mnuarchradio_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetArchiveReportResult("Radio Diagnostics", modPatient.GetPatientNoByEnc($rData["fldencounterval"]))
  Endif

End

Public Sub mnuarchradiorepo_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetRepoArchiveReportResult("Radio Diagnostics", modPatient.GetPatientNoByEnc($rData["fldencounterval"]))
  Endif

End

Public Sub mnumedhist_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetPatHistoryLocalResult("Medicines", $rData["fldencounterval"], LabUnitForm())
  Endif

End

Public Sub mnumedviewrepo_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetRepoHistoryLocalResult("Medicines", $rData["fldencounterval"], LabUnitForm())
  Endif

End

Public Sub mnugenhistory_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetSelectHistoryResult($rData["fldencounterval"], LabUnitForm())
  Endif

End

Public Sub mnugenhistrepo_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetRepoSelectHistoryResult($rData["fldencounterval"], LabUnitForm())
  Endif

End

Public Sub mnuarchgenerl_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetArchiveReportResult("General Reports", modPatient.GetPatientNoByEnc($rData["fldencounterval"]))
  Endif

End

Public Sub mnuarchgenerlrepo_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetRepoArchiveReportResult("General Reports", modPatient.GetPatientNoByEnc($rData["fldencounterval"]))
  Endif

End

Public Sub mnuscanimg_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetArchiveReportResult("Scanned Images", modPatient.GetPatientNoByEnc($rData["fldencounterval"]))
  Endif

End

Public Sub mnuscanimgrepo_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetRepoArchiveReportResult("Scanned Images", modPatient.GetPatientNoByEnc($rData["fldencounterval"]))
  Endif

End

Public Sub mnupastdocs_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetArchiveReportResult("Past Documents", modPatient.GetPatientNoByEnc($rData["fldencounterval"]))
  Endif

End

Public Sub mnupastdocsrepo_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetRepoArchiveReportResult("Past Documents", modPatient.GetPatientNoByEnc($rData["fldencounterval"]))
  Endif

End

Public Sub mnupacshist_Click()

  Dim hForm As FmPacsShow

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmPacsShow($rData["fldencounterval"], "History")
    hForm.ShowModal
  Endif

End

Public Sub mnuexpocolumn_Click()

  Dim hForm As FmCustColumnSet

  hForm = New FmCustColumnSet(Me.Tag)
  hForm.ShowModal

End

Public Sub chkshowdepart_Click()

  modSettings.EnterCheckSetting(chkshowdepart, "BedOccupancy/ShowParameters")

End

Public Sub chkshowstatus_Click()

  modSettings.EnterCheckSetting(chkshowstatus, "BedOccupancy/ShowStatusIcons")

End

''-------------- Forms -------------
Public Sub mnunursingform_Click()

  ' Dim hForm As FmNursingForm
  '
  ' If GridView1.Selection.Count Then
  '   $rData.MoveTo(GridView1.Selection[0])
  '   Me.Parent.DeleteChildren()
  '   hForm = New FmNursingForm($rData["fldencounterval"], fmOfficer.Workspace1)
  ' Endif

End

Public Sub mnudeliveryform_Click()

  ' Dim hForm As FmDeliveryNew
  '
  ' If GridView1.Selection.Count Then
  '   $rData.MoveTo(GridView1.Selection[0])
  '   Me.Parent.DeleteChildren()
  '   hForm = New FmDeliveryNew($rData["fldencounterval"], fmOfficer.Workspace1)
  ' Endif

End

Public Sub mnuexamination_Click()

  ' Dim hForm As FmExamReporting
  '
  ' If GridView1.Selection.Count Then
  '   $rData.MoveTo(GridView1.Selection[0])
  '   Me.Parent.DeleteChildren()
  '   hForm = New FmExamReporting($rData["fldencounterval"], fmOfficer.Workspace1)
  ' Endif

End
