' Gambas class file

Private $sNow As Date
Private $AgeGroupList As String[]
Private $EthnicityList As String[]
Private $dtFir As Date
Private $dtLast As Date

Private $rData As Result
Private $aMyFields As String[]
Private $rData2 As Result
Private $aMyFields2 As String[]
Private $rData3 As Result
Private $aMyFields3 As String[]

Public Sub _new()

  $AgeGroupList = modPublicDash.GetDashAgeGroupList
  $EthnicityList = ["Dalit", "Janajati", "Madhesi", "Muslim", "Brahmin/Chettri", "Other"]
  cmbhousehold.List = ["With mobile phones", "With television", "With toilet", "With Water Supply"]
  $sNow = Now()
  $dtFir = modDate.StartSqlMonthBS($sNow)
  $dtLast = modDate.EndSqlMonthBS($sNow)
  SetLocations()
  If cmbpality.Text Then
    ShowAgeGroupingValues()
    ShowEthnicValues()
    ShowHouseholdValues()
  Endif

End

Public Sub cmbpality_Click()

  ShowAgeGroupingValues()
  ShowEthnicValues()
  ShowHouseholdValues()

End

Private Sub SetLocations()

  If modDataRepo.$RepositoryMode = "Hospital" Then

  Else If modDataRepo.$RepositoryMode = "Municipality" Then
    cmbpality.Text = modBasic.$HospCode
    cmbpality.Enabled = False
    cmbhospdistrict.Text = modDataRepo.GetDistrictFromMunicipal(modBasic.$HospCode)
    cmbhospdistrict.Enabled = False
  Else If modDataRepo.$RepositoryMode = "District" Then
    cmbpality.List = modDataRepo.GetMunicipalsByDistrict(modBasic.$HospCode)
    cmbhospdistrict.Text = modBasic.$HospCode
    cmbhospdistrict.Enabled = False
  Else If modDataRepo.$RepositoryMode = "Province" Then
    cmbhospdistrict.List = modControlSub.GetDirectFillresult(modDatabase.$myConn.Exec("select flddistrict as col from tblmunicipals where fldprovince=&1", modBasic.$HospCode))
  Else
    cmbhospdistrict.List = modBasic.$DistrictList
  Endif

End

Public Sub cmbhospdistrict_Click()

  If cmbhospdistrict.Text Then
    cmbpality.List = modDataRepo.GetMunicipalsByDistrict(cmbhospdistrict.Text)
  Endif

End

''-------------------- age grouping ---------------------
Public Sub btnaddpop_Click()

  If cmbagepop.Text Then
    If cmbhospdistrict.Text And If cmbpality.Text Then
      modPopDash.AddPopulationParameters("Age Grouping", cmbagepop.Text, txtmalepop.Value, txtfemalepop.Value, txtotherpop.Value, cmbpality.Text, cmbhospdistrict.Text)
      ShowAgeGroupingValues()
      Me.Exec("Toastify({text: 'Information added', duration: 3000}).showToast()")
    Endif
  Endif

End

Private Sub ShowAgeGroupingValues()

  Dim aList As String[]

  aList = New String[]
  $rData = modDatabase.$myConn.Exec("select fldcategory,fldmale,fldfemale,fldother from tblpopulation where fldchapter=&1 and fldpality=&2 and flddistrict=&3 and fldtime>=&4 and fldtime<=&5", "Age Grouping", cmbpality.Text, cmbhospdistrict.Text, $dtFir, $dtLast)                                     ''
  If $rData Then
    For Each $rData
      aList.Add($rData["fldcategory"])
    Next
  Endif

  $aMyFields = New String[]
  modGridView.ReadSmallData(WebTable1, $rData, $aMyFields)
  With WebTable1
    .Columns[0].Width = CStr(200 * modBasic.$AppWidthRatio) & "px"
    .Columns[1].Width = CStr(100 * modBasic.$AppWidthRatio) & "px"
    .Columns[2].Width = CStr(100 * modBasic.$AppWidthRatio) & "px"
    .Columns[3].Width = CStr(100 * modBasic.$AppWidthRatio) & "px"

    .Columns[0].Text = "Age Group"
    .Columns[1].Text = "Male"
    .Columns[2].Text = "Female"
    .Columns[3].Text = "Others"
  End With
  cmbagepop.List = modString.GetRemainingArray($AgeGroupList, aList)

End

Public Sub WebTable1_Data(Row As Integer, Column As Integer, Data As WebTableData)

  $rData.MoveTo(Row)
  modGridView.GridViewDecoration(Data, Row)
  Data.Text = $rData[$aMyFields[Column]]

End

''-------------------- ethnicity ---------------------------
Public Sub btnaddethnic_Click()

  If cmbethnicity.Text Then
    If cmbhospdistrict.Text And If cmbpality.Text Then
      modPopDash.AddPopulationParameters("Ethnicity", cmbethnicity.Text, txtmaleethnic.Value, txtfemaleethnic.Value, txtotherethnic.Value, cmbpality.Text, cmbhospdistrict.Text)
      ShowEthnicValues()
      Me.Exec("Toastify({text: 'Information added', duration: 3000}).showToast()")
    Endif
  Endif

End

Private Sub ShowEthnicValues()

  Dim aList As String[]

  aList = New String[]
  $rData2 = modDatabase.$myConn.Exec("select fldcategory,fldmale,fldfemale,fldother from tblpopulation where fldchapter=&1 and fldpality=&2 and flddistrict=&3 and fldtime>=&4 and fldtime<=&5", "Ethnicity", cmbpality.Text, cmbhospdistrict.Text, $dtFir, $dtLast)                                     ''
  If $rData2 Then
    For Each $rData2
      aList.Add($rData2["fldcategory"])
    Next
  Endif

  $aMyFields2 = New String[]
  modGridView.ReadSmallData(WebTable2, $rData2, $aMyFields2)
  With WebTable2
    .Columns[0].Width = CStr(200 * modBasic.$AppWidthRatio) & "px"
    .Columns[1].Width = CStr(100 * modBasic.$AppWidthRatio) & "px"
    .Columns[2].Width = CStr(100 * modBasic.$AppWidthRatio) & "px"
    .Columns[3].Width = CStr(100 * modBasic.$AppWidthRatio) & "px"

    .Columns[0].Text = "Ethnicity"
    .Columns[1].Text = "Male"
    .Columns[2].Text = "Female"
    .Columns[3].Text = "Others"
  End With
  cmbethnicity.List = modString.GetRemainingArray($EthnicityList, aList)

End

Public Sub WebTable2_Data(Row As Integer, Column As Integer, Data As WebTableData)

  $rData2.MoveTo(Row)
  modGridView.GridViewDecoration(Data, Row)
  Data.Text = $rData2[$aMyFields2[Column]]

End

''--------------------------- literacy rates -----------------------
Public Sub btnaddliter_Click()

  If cmbhospdistrict.Text And If cmbpality.Text Then
    modPopDash.AddPopulationParameters("Percentage", "Literacy Rate", txtmaleliter.Value, txtfemaleliter.Value, txtotherliter.Value, cmbpality.Text, cmbhospdistrict.Text)
    Me.Exec("Toastify({text: 'Information added', duration: 3000}).showToast()")
  Endif

End

''-------------------------------- house hold parameters -----------------
Public Sub btnhousemobile_Click()

  If cmbhousehold.Text Then
    If cmbhospdistrict.Text And If cmbpality.Text Then
      modPopDash.AddPopulationGeneral("Household Parameters", cmbhousehold.Text, "", txthousemobile.Value, cmbpality.Text, cmbhospdistrict.Text)
      ShowHouseholdValues()
      Me.Exec("Toastify({text: 'Information added', duration: 3000}).showToast()")
    Endif
  Endif

End

Private Sub ShowHouseholdValues()

  $rData3 = modDatabase.$myConn.Exec("select fldcategory,fldquanti from tbldashparameters where fldchapter=&1 and fldpality=&2 and flddistrict=&3 and fldtime>=&4 and fldtime<=&5", "Household Parameters", cmbpality.Text, cmbhospdistrict.Text, $dtFir, $dtLast)                                     ''
  $aMyFields3 = New String[]
  modGridView.ReadSmallData(WebTable3, $rData3, $aMyFields3)
  With WebTable3
    .Columns[0].Width = CStr(250 * modBasic.$AppWidthRatio) & "px"
    .Columns[1].Width = CStr(100 * modBasic.$AppWidthRatio) & "px"

    .Columns[0].Text = "Parameters"
    .Columns[1].Text = "Percentage"
  End With

End

Public Sub WebTable3_Data(Row As Integer, Column As Integer, Data As WebTableData)

  $rData3.MoveTo(Row)
  modGridView.GridViewDecoration(Data, Row)
  Data.Text = $rData3[$aMyFields3[Column]]

End
