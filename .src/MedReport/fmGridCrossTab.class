' Gambas class file

Private $sName As String
Private $sPath As String
Private $xVar As Variant[]

Public Sub _new(sName As String, sPath As String)

  $sName = sName
  $sPath = sPath
  CreateChartView()

End

Private Sub CreateChartView()

  Dim xpath As String

  xpath = modChartFix.GetCrossTabFormating($sPath, $sName)
  LoadCSVToGrid(xpath, gb.Tab)
  modImage.StretchtPictureToBox(PictureBox1, modChart.GetProportionChartOnly(xpath, $sName))                                        ''

End

Public Sub btnexport_Click()

  ' Me.Exec("printJS('" & PictureBox1.Tag & "', 'image')")
  Me.Exec("window.open('" & PictureBox1.Image & "'); ")

End

Public Sub btnreport_Click()

  If modBasic.$ChartExecStat = "PSPP" Then
    modControlSub.OpenBrowser(modPSPP.CreatePSPPStatFIle("crosstab", $sPath))
  Else
    modControlSub.OpenBrowser(modPSPP.CreatePSPPStatFIle("crosstab", $sPath))
  Endif

End

'first row is grid column titles
Private Sub LoadCSVToGrid(sPath As String, sMark As String)

  Dim idx As Integer
  Dim xcoll As Collection
  Dim j As Integer

  Dim hCSV As CsvFile
  Dim Row As Integer
  Dim ycoll As Collection

  Row = 0
  hCSV = New CsvFile(sPath, sMark)
  While hCSV.Eof = False
    hCSV.Read()
    Row = Row + 1
  Wend
  GridView1.Columns.Count = hCSV.Fields.Count
  GridView1.Count = Row
  For idx = 0 To hCSV.Fields.Count - 1
    GridView1.Columns[idx].Text = hCSV.Fields[idx]
  Next
  hCSV.Close()

  $xVar = New Variant[]
  hCSV = New CsvFile(sPath, sMark)
  While hCSV.Eof = False
    xcoll = hCSV.Read()
    ycoll = New Collection
    For j = 0 To hCSV.Fields.Count - 1
      ycoll.Add(xcoll[hCSV.Fields[j]], CStr(j))
    Next
    $xVar.Add(ycoll)
  Wend
  hCSV.Close()

End

Public Sub GridView1_Data(Row As Integer, Column As Integer, Data As WebTableData)

  modGridView.GridViewDecoration(Data, Row)
  Data.Text = $xVar[Row][CStr(Column)]

End

Public Sub btnexpogrid_Click()

  modCHTMLReport.ExportGridToHTML(GridView1, $sName, modReportVar.GetDateTimeReport(Now(), gb.GeneralDate))

End

Public Sub btnexpoexcel_Click()

  Me.Exec("ExportToExcel('" & GridView1.Name & "', 'xlsx')")

End

Public Sub btnclose_Click()

  Me.Close()

End
