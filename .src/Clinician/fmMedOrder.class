' Gambas class file

Private $encid As String
Private $status As String
Private $DiscPackage As String
Private $Dept As String
Private $doa As Date
Private $xFinClear As Boolean
Private $PatientNum As String
Private $xNHISCode As String
Private $Ready As Boolean
Private $NarcoDoctor As String
Private $NarcoRegd As String

Private $PatAge As Float
Private $PatSex As String
Private $PatWeight As Float
Private $PatHeight As Float

Private $rDataM As Result
Private $aMyFieldsM As String[]
' Private $rData As Result
' Private $aMyFields As String[]
Private $rData2 As Result
Private $aMyFields2 As String[]
Private $rData3 As Result
Private $aMyFields3 As String[]
Private $LastEncid As String

Private $HideErr As Boolean
Private $HideDos As Boolean
Private $ShowReview As String
Private $AlphaList As String[]
Private $LedgerAC As String
Private $xBillType As String
Private $sBillMode As String
Private $sClaimState As String
Private $LabelType As String
Private xYear As Integer

Private $ClinicianLst As String[]
Private hOwnStockForm As FmWardStock
Private $HiCappingVar As Collection

Public Sub _new(encid As String, sStatus As String, DiscPackage As String)

  Dim mfglist As String
  Dim accLst As String[]
  Dim xbirthDate As Date

  $encid = encid
  $status = sStatus
  $DiscPackage = DiscPackage

  modGeneralMain.GetOpenModalForm(Me)
  Select $status
    Case "Admitted", "Discharged", "LAMA", "Death", "Refer", "Absconder"
      $Dept = "IPD"
    Case Else
      $Dept = "OPD"
  End Select

  hOwnStockForm = New FmWardStock($encid, $status, $DiscPackage, "height-tablet-medium-less", pnlwardstock)
  hOwnStockForm.SetOwnDepartment($Dept)

  accLst = modBasic.$BillDiscountCash
  If accLst.Count = 0 Then
    accLst.Add($DiscPackage)
  Endif
  cmbdisctype.List = accLst
  cmbdisctype.Text = $DiscPackage
  If modSettings.ShowSettingFromFIle("ClinicForms/ShowInjectionSubRoutes") = "Disable" Then
    cmbroute.List = modMedicine.AllComboRoute()
  Else
    cmbroute.List = modMedicine.InpatientRoute(False)
  Endif
  cmbfreq.List = modMedicine.FrequencyCombo()
  cmbcurrent.List = ["Continue", "On Hold", "Removed", "All Types"]
  cmbstatus.List = ["Continue", "Completed", "Discontinue", "On Hold", "Change", "ReWrite", "Cancelled", "Wasted"]
  $ClinicianLst = modGeneral.GetClinicianCodeList()
  modStockSub.DisplayDefaultDispensingMode(rbrand, rbgeneric)
  modSettings.ShowCheckBox(chkout, "OutOfStock/Dispensing")

  mfglist = modSettings.ShowSettingFromFIle("PharmacyForm/AdviceList")
  If mfglist Then
    If Exist(mfglist) Then
      txtdirection.List = modString.GetStringArrayFromFile(mfglist)
    Endif
  Endif

  txtpatientname.Text = modPatient.GetPatientNameByEnc($encid)
  $PatSex = modPatient.GetPatientSex($encid)
  xbirthDate = modPatient.GetPatientBirthDay($encid)
  txtgender.Text = modDate.GetAgeString(xbirthDate, Now()) & "/" & $PatSex
  xYear = DateDiff(xbirthDate, Now(), gb.Year)
  $doa = modPatient.GetRecordDate($encid)
  $PatientNum = modPatient.GetPatientNoByEnc($encid)
  $xNHISCode = modPatient.GetPatientExtCOdebyEnc($encid)

  $PatAge = xYear
  $PatHeight = modClinic.GetPatientHeightinCm($encid)
  $PatWeight = modClinic.GetBodyWeight($encid)

  ShowBillingParam($DiscPackage)
  If $status = "Admitted" Then
    $LabelType = "Inpatient"
  Else
    $LabelType = "Outpatient"
  Endif

  If $status = "Registered" Then
    $LastEncid = modPatient.GetSecondLastEncidPatient($encid)
  Else
    $LastEncid = $encid
  Endif
  $xFinClear = modNonMedical.GetFinanceClearance($encid)
  SetNarcoticsPrescriber()

  $ShowReview = modBasic.$MedErrorEnable
  If Not $ShowReview Then
    $ShowReview = "Notification"
  Endif
  If modPharmacy.DisableEncounterForReview($encid) = True Then
    $ShowReview = "None"
  Endif

  $AlphaList = New String[]
  GetDoseFormatType()

  rbcurrent.Value = True
  cmbcurrent.Text = "Continue"
  ShowRunningMedicine(cmbcurrent.Text)

  If $xFinClear = True Then
    btnsetregimen.Visible = False
    btngroup.Visible = False
    chksave.Visible = False
    pnlwardstock.Enabled = False
  Endif
  modSysCons.ClearPatParameterCalc()
  ShowBasicParamStatus()
  $Ready = True

End

Public Sub WebForm_Close()

  modSysCons.ClearPatParameterCalc()

End

' Public Sub Form_KeyRelease()
'
'   If Key.Code = Key.Esc Then
'     Me.Close
'   Else If Key.Code = Key.F1 Then
'     TabPanel1.Index = 0
'     ShowRunningMedicine()
'   Else If Key.Code = Key.F2 Then
'     TabPanel1.Index = 1
'     btndoserefresh_Click()
'   Else If Key.Code = Key.F3 Then
'     TabPanel1.Index = 2
'     FillDosingGrid()
'     BlankDosingBox()
'     cmbroute.SetFocus
'   Else If Key.Code = Key.F4 Then
'     TabPanel1.Index = 3
'     ShowCurrStockGrid()
'     ShowUsedGridViewList()
'     txtname.SetFocus
'   Else
'     modGeneralmain.GoToNextControlTab()
'   Endif
'
' End

Private Sub SetNarcoticsPrescriber()

  Dim res As Result

  If modBasic.$MedNarcoPrescriber = "User" Then
    res = modDatabase.$myConn.Exec("select fldusername,fldusercode from tbluser where flduserid=&1 and (fldopconsult=&2 or fldipconsult=&2) and fldstatus=&3 and fldusercode like &4", modBasic.$lbluser, True, "Active", "%")
    If res.Available Then
      $NarcoDoctor = res["fldusername"]
      $NarcoRegd = res["fldusercode"]
    Endif
  Endif

End

Private Sub ShowBasicParamStatus()

  Dim xmsg As String

  If $ShowReview = "None" Then
  Else

    xmsg = ""
    If Not $PatHeight Then
      $PatHeight = modSysCons.GetPatientEmptyHeight($PatAge, $PatSex)
      If $PatHeight Then
        xmsg = "Patient's height not set. Using " & $PatHeight & " cm for now" & "<br>"
        ' WebForm.Exec(Subst("Toastify({text: '&1', duration: &2}).showToast()", xmsg, modBasic.$BalloonDelay))
      Endif
    Endif
    If Not $PatWeight Then
      If $PatHeight Then
        $PatWeight = modSysCons.GetPatientEmptyWeight($PatHeight, $PatSex)
        If $PatWeight Then
          xmsg = xmsg & "Patient's weight not set. Using " & $PatWeight & " Kg for now"
          ' WebForm.Exec(Subst("Toastify({text: '&1', duration: &2}).showToast()", xmsg, modBasic.$BalloonDelay))
        Endif
      Endif
    Endif

    If xmsg Then
      Message.Warning(xmsg, ("OK"))
    Endif

  Endif

End

Public Sub TabPanel1_Click()

  If TabPanel1.Index = 0 Then
    ShowRunningMedicine(cmbcurrent.Text)
  Else If TabPanel1.Index = 1 Then
    modSettings.ShowCheckBox(chkout, "OutOfStock/Dispensing")
    If modBasic.$AppSelect2JS = "Enable" Then
      cmbfreq.ReadOnly = True
      modJavaScript.SetSelect2Combo(cmbfreq)
    Endif
    BlankDosingBox()
    FillDosingGrid()
    If modBasic.$TabletModeEnable = "Yes" Then
    Else
      txtstart.SetFocus
    Endif
  Else If TabPanel1.Index = 2 Then

  Else If TabPanel1.Index = 3 Then
    ShowMedicationHistory()
  Else If TabPanel1.Index = 4 Then
    ShowPatProtocols()
  Endif

End

Private Sub BlankDosingBox()

  cmbroute.Text = ""
  cmbmedicine.Text = ""
  txtdose.Value = 0
  If modBasic.$AppSelect2JS = "Enable" Then
    modJavaScript.TriggerSelect2Combo(cmbfreq)
  Endif
  cmbfreq.Text = ""
  txtday.Tag = ""
  txtday.Value = 0
  txtqty.Tag = ""
  txtqty.Value = 0
  txtdirection.Text = ""
  $HideErr = False
  $HideDos = False
  lbldose.Text = ""
  lblregimen.Text = ""

End

Private Sub ShowBillingParam(sDisctype As String)

  Dim hForm As CPackageParams

  $HiCappingVar = New Collection
  hForm = New CPackageParams($encid, sDisctype)
  $sBillMode = hForm.GetBillingMode()
  $LedgerAC = hForm.GetLedgerAC()
  $xBillType = hForm.GetBillType()
  $sClaimState = hForm.GetClaimState()

End

Private Sub GetHImedicineCappingVar()

  Dim hForm As CimisAPICap

  If cmbdisctype.Text = modBasic.$HIPackage Or If cmbdisctype.Text = modBasic.$HIPackageER Then
    If modBasic.$IMISValidateURL Then

      If modClaim.GetChronicClaimStatus($encid) = True Then
        If $HiCappingVar.Count Then
          $HiCappingVar.Clear()
        Endif
      Else
        If Not $HiCappingVar.Count Then
          hForm = New CimisAPICap($xNHISCode)
          $HiCappingVar = hForm.GetMedicineLimits()
        Endif
      Endif

    Endif
  Endif

End

''------------------------------ Request ---------------------------------
Public Sub chkout_Click()

  modSettings.EnterCheckSetting(chkout, "OutOfStock/Dispensing")

End

Public Sub rbgeneric_Click()

  modSettings.SaveSettingsToFile("BrandOrGeneric/Dispensing", "Generic")

End

Public Sub rbrand_Click()

  modSettings.SaveSettingsToFile("BrandOrGeneric/Dispensing", "Brand")

End

Private Function GetBrandGenerricType() As String

  Dim brandOrGeneric As String

  If rbrand.Value = True Then
    brandOrGeneric = "Brand"
  Else
    brandOrGeneric = "Generic"
  Endif
  Return brandOrGeneric

End

Public Sub cmbdisctype_Click()

  If cmbdisctype.Text Then
    ShowBillingParam(cmbdisctype.Text)
    hOwnStockForm.$DiscPackage = cmbdisctype.Text
    hOwnStockForm.UpdateBillingParam()
  Endif

End

Private Sub RegimenBoxSetting(sBool As Boolean)

  txtdose.Enabled = sBool
  cmbfreq.Enabled = sBool
  txtday.Enabled = sBool

End

Public Sub cmbroute_Click()

  cmbmedicine.Text = ""
  RegimenBoxSetting(True)
  If modBasic.$TabletModeEnable = "Yes" Then
  Else
    cmbmedicine.SetFocus
  Endif

End

Private Function GetPharmTarget(sRoute As String) As String

  Dim xtarg As String

  Select sRoute
    Case "msurg"
      xtarg = modBasic.$BillTargetSurgical
    Case "suture"
      xtarg = modBasic.$BillTargetSutures
    Case "ortho"
      xtarg = modBasic.$BillTargetOrthopedics
    Case "extra"
      xtarg = modBasic.$BillTargetExtras
    Case Else
      xtarg = modBasic.$BillTargetMedicine
  End Select

  Return xtarg

End

Private Function GetMedicineList() As String[]

  Dim res As Result
  Dim xlist As String[]

  If cmbroute.Text = "suture" Or If cmbroute.Text = "msurg" Or If cmbroute.Text = "ortho" Or If cmbroute.Text = "extra" Then
    If chkout.Value = True Then
      res = modStock.ItemListForPurchaseBillMode(cmbroute.Text, GetBrandGenerricType(), $sBillMode)
    Else
      If modBasic.$ClinLockPharmStock = "Enable" Then
        res = modStock.FillMedicinesDispensingComboResult(cmbroute.Text, GetBrandGenerricType(), GetPharmTarget(cmbroute.Text), $sBillMode)
      Else
        res = modStock.FillMedicinesPrescribingComboResult(cmbroute.Text, GetBrandGenerricType(), $sBillMode)
      Endif
    Endif
    xlist = modControlSub.GetDirectFillresult(res)
  Else
    If chkout.Value = True Then
      res = modStock.ItemListForPurchaseBillMode(cmbroute.Text, GetBrandGenerricType(), $sBillMode)
    Else
      If modBasic.$ClinLockPharmStock = "Enable" Then
        res = modStock.FillMedicinesDispensingComboResult(cmbroute.Text, GetBrandGenerricType(), GetPharmTarget(cmbroute.Text), $sBillMode)
      Else
        res = modStock.FillMedicinesPrescribingComboResult(cmbroute.Text, GetBrandGenerricType(), $sBillMode)
      Endif
    Endif
    xlist = modControlSub.GetDirectFillresult(res)
  Endif

  Return xlist

End

Public Sub cmbmedicine_Completion(Text As String)

  Dim xallLst As String[]
  Dim xList As String[]

  xallLst = GetMedicineList()
  If xallLst And If xallLst.Count Then
    xList = modString.SelectStringArrayToText(Text, xallLst, False)
    cmbmedicine.CompleteWith(xList)
  Endif

End

Public Sub btnmedlist_Click()

  Dim xlist As String[]
  Dim xlist1 As String[]

  $HideErr = False
  xlist = GetMedicineList()
  If xlist Then
    If cmbroute.Text = "suture" Or If cmbroute.Text = "msurg" Or If cmbroute.Text = "ortho" Or If cmbroute.Text = "extra" Then
      cmbmedicine.Text = GridViewNew("Select Particulars", xlist, False)
    Else
      If modBasic.$ClinCategoryGrid = "Yes" Then
        xlist1 = modMedConstant.GetStockIDWithCategory(xlist)
        If xlist1 Then
          cmbmedicine.Text = GridViewGroup("Select Medicine", xlist1, False)
        Endif
      Else
        cmbmedicine.Text = GridViewNew("Select Particulars", xlist, False)
      Endif
    Endif
  Endif
  CheckMedicineName()

End

Private Sub CheckMedicineName()
  ' ' Dim hForm As FmDiseaseDose

  Dim cForm As CRecommendDosing

  If cmbmedicine.Text Then
    If cmbroute.Text = "suture" Or If cmbroute.Text = "msurg" Or If cmbroute.Text = "ortho" Or If cmbroute.Text = "extra" Then
      RegimenBoxSetting(False)
      txtqty.SetFocus
      Me.Exec("$_(" & JS(txtqty.Name & ":entry") & ").select()")
    Else
      If rbrand.Value = True Then
        cmbmedicine.Text = modMedConstant.ConvertBrandToGeneric(cmbroute.Text, cmbmedicine.Text)
      Endif
      RegimenBoxSetting(True)
      lbldose.Text = modMedConstant.GetDrugDosingUnit(cmbmedicine.Text)

      If modBasic.$MedDoseRecommend = "No" Then
      Else
        cForm = New CRecommendDosing($encid, xYear, cmbmedicine.Text)
        txtdose.Value = cForm.UnitDose()
        cmbfreq.Text = cForm.Frequency()
        lblregimen.Text = cForm.Regimen()
      Endif
      If $HideDos = False Then
        CheckLastDispensing(cmbmedicine.Text)
      Endif

      ' '   If modBasic.$MedDiseaseDose Then
      ' '     If modBasic.$MedDiseaseDose = "None" Then
      ' '     Else
      ' '       hForm = New FmDiseaseDose(modBasic.$MedDiseaseDose, $encid, cmbroute.Text, cmbmedicine.Text, txtdose, cmbfreq, txtday)
      ' '       hForm.ShowModal
      ' '     Endif
      ' '   Endif

      txtdose.SetFocus()
      Me.Exec("$_(" & JS(txtdose.Name & ":entry") & ").select()")
    Endif
  Endif

End

Private Sub CheckLastDispensing(xmedicine As String)

  Dim cForm As CLastDispensing
  Dim xdate As Date
  Dim xdays As Integer

  If modBasic.$SalesHistoryAlert Then
    cForm = New CLastDispensing(xmedicine, $PatientNum, $xNHISCode, cmbdisctype.Text)
    txttotalqty.Value = cForm.GetLastQty()
    xdate = cForm.GetLastDate()
    xdays = cForm.GetLastDays()

    If xdate Then
      txtlastdispdate.Text = modReportVar.GetDateTimeReport(xdate, gb.MediumDate)
      If DateDiff(xdate, Now(), gb.Month) <= 3 Then
        txtlastdispdate.Foreground = Color.Red
      Endif

      If xdays Then
        If DateAdd(xdate, gb.Day, xdays) > Now() Then
          $HideDos = True
          Message.Warning("Dispensed for " & xdays & " Days On " & modReportVar.GetDateTimeReport(xdate, gb.GeneralDate), ("OK"))
        Endif
      Else
        $HideDos = True
      Endif
    Endif

  Else
    $HideDos = True
  Endif

End

Public Sub cmbmedicine_Activate()

  If Not cmbroute.Text Then
    cmbroute.SetFocus
  Else If cmbroute.Text Then
    If Not cmbmedicine.Text Then
      btnmedlist_Click()
    Else
      CheckMedicineName()
    Endif
  Endif

End

Public Sub txtdose_Activate()

  If modBasic.$AppSelect2JS = "Enable" Then
    modJavaScript.PopUpSelect2Combo(cmbfreq)
  Endif
  cmbfreq.SetFocus

End

Public Sub cmbfreq_Click()

  txtday.SetFocus()
  If txtdose.Value Then
    Me.Exec("$_(" & JS(txtday.Name & ":entry") & ").select()")
  Endif

End

' Public Sub cmbfreq_Activate()
'
'   If cmbfreq.Text Then
'     txtday.SetFocus
'   Endif
'
' End

Public Sub txtday_Activate()

  Dim opt As String[]
  Dim xval As String
  Dim xcount As String
  Dim xday As Integer
  Dim cForm As CMedError

  If txtdose.Value And If cmbfreq.Text Then
    If txtday.Value Then
      xday = txtday.Value
    Else
      If modBasic.$ClinIPDVarDays = "Enable" And If $status = "Admitted" Then
        xday = 1
      Endif
    Endif

    If xday Then
      xcount = 0
      If $HideErr = False Then
        If txtdose.Value And If cmbfreq.Text Then

          Select cmbroute.Text
            Case "suture", "msurg", "ortho", "extra", "topical"
              ''do nothing
            Case Else
              If $ShowReview = "None" Then
              Else
                opt = New String[]
                For Each $rDataM
                  Select $rDataM["fldroute"]
                    Case "suture", "msurg", "ortho", "extra", "topical"
                    Case Else
                      xval = modMedConstant.GetDrugFromStockID($rDataM["flditem"])
                      If opt.Count = 0 Then
                        opt.Add(xval)
                      Else
                        If opt.Exist(xval) = False Then
                          opt.Add(xval)
                        Endif
                      Endif
                  End Select
                Next
                $HideErr = True
                cForm = New CMedError
                xcount = cForm.ShowMedicationReviewPunching($encid, cmbroute.Text, cmbmedicine.Text, txtdose.Value, cmbfreq.Text, opt)
              Endif
          End Select

        Endif
      Endif

      txtqty.Value = Ceil(modMedConstant.GetQuantityDosing(cmbmedicine.Text, txtdose.Value, cmbfreq.Text, xday))
      txtqty.SetFocus()
      Me.Exec("$_(" & JS(txtqty.Name & ":entry") & ").select()")
    Endif
  Endif

End

Public Sub txtqty_Activate()

  txtdirection.SetFocus

End

Public Sub txtdirection_Activate()

  chksave_Click()

End

Public Sub chksave_Click()

  If chksave.Visible = True Then
    If cmbroute.Text And If cmbmedicine.Text And If txtqty.Value Then
      If modStockSub.GetComboStockControl(cmbroute.Text, cmbmedicine.Text, rbgeneric, rbrand, modDatabase.$medConn) = False Then
        cmbmedicine.Text = ""
        Message.Warning(("Item not listed"), "OK")
        cmbroute.SetFocus
      Else
        EnterDosingRecord()
        If modBasic.$TabletModeEnable = "Yes" Then
        Else
          If modBasic.$AppSelect2JS = "Enable" Then
            modJavaScript.TriggerSelect2Combo(cmbfreq)
          Endif
          cmbroute.SetFocus
        Endif
      Endif '
    Endif
  Endif

End

Private Sub EnterDosingRecord()

  Dim txprescriber As String
  Dim txpresno As String

  Dim xtax As Float
  Dim xdisc As Float
  Dim itemtype As String
  Dim xfixrate As Float
  Dim xfixname As String
  ' Dim xvarfix As Variant[]
  Dim itemmode As String
  Dim xcurVal As String
  Dim xnarcotic As String[]
  Dim CPharmFix As CFixRatePharmacy

  If chknextplan.Value = True Then
    xcurVal = "Planned"
  Else
    If modBasic.$DispRequestStatus = "Reserve" Then
      xcurVal = "Reserve"
    Else
      xcurVal = "Continue"
    Endif
  Endif
  If cmbroute.Text And If cmbmedicine.Text Then

    itemtype = modNonMedical.GetBillItemCategoryFromCombo(cmbroute.Text)
    CPharmFix = New CFixRatePharmacy(itemtype, cmbmedicine.Text, $sBillMode)
    xfixrate = CPharmFix.GetFixRate()
    xfixname = CPharmFix.GetFixItem()
    itemmode = $sBillMode
    xtax = modNonMedical.ShowTaxValues(itemtype, cmbmedicine.Text)
    xdisc = modNonMedical.DiscPercentForCategoryValue($encid, cmbdisctype.Text, itemtype, cmbmedicine.Text, itemmode)
    If cmbroute.Text = "suture" Or If cmbroute.Text = "msurg" Or If cmbroute.Text = "ortho" Or If cmbroute.Text = "extra" Then
      modPharmSub.InsertNonMedDosingEntry(itemtype, $encid, $xBillType, $sBillMode, cmbdisctype.Text, $LedgerAC, cmbroute.Text, cmbmedicine.Text, txtqty.Value, $status, txtstart.Value, xtax, xdisc, xfixname, xfixrate, "Request", $Dept, Trim(txtdirection.Text), False, xcurVal)

    Else
      If modMedConstant.GetNarcoticType(cmbmedicine.Text) = "Yes" Then
        txprescriber = $NarcoDoctor
        txpresno = $NarcoRegd
        If Not txpresno Then
          xnarcotic = DualGridValue(("Select Narcotic Prescriber"), $ClinicianLst, False)
          If xnarcotic Then
            txprescriber = xnarcotic[1]
            txpresno = xnarcotic[0]
          Endif
        Endif
        If txprescriber And If txpresno Then
          modPharmSub.InsertDosingEntry($encid, $xBillType, $sBillMode, cmbdisctype.Text, $LedgerAC, cmbroute.Text, cmbmedicine.Text, txtdose.Value, cmbfreq.Text, txtday.Value, txtqty.Value, $status, txprescriber, txpresno, txtstart.Value, xtax, xdisc, xfixname, xfixrate, "Request", $Dept, Trim(txtdirection.Text), False, xcurVal)                     '
        Endif
      Else
        modPharmSub.InsertDosingEntry($encid, $xBillType, $sBillMode, cmbdisctype.Text, $LedgerAC, cmbroute.Text, cmbmedicine.Text, txtdose.Value, cmbfreq.Text, txtday.Value, txtqty.Value, $status, "", "", txtstart.Value, xtax, xdisc, xfixname, xfixrate, "Request", $Dept, Trim(txtdirection.Text), False, xcurVal)                     '
      Endif
    Endif

    FillDosingGrid()
    BlankDosingBox()
  Endif

End

Public Sub btngroup_Click()

  Dim xList As Long[]
  Dim xIndex As Long

  Dim res As Result
  Dim txprescriber As String
  Dim txpresno As String
  Dim xdose As Float
  Dim xtax As Float
  Dim xdisc As Float
  Dim itemtype As String
  Dim xfixrate As Float
  Dim xfixname As String
  ' Dim xvarfix As Variant[]
  Dim itemmode As String
  Dim xcurVal As String
  Dim xnarcotic As String[]
  Dim CPharmFix As CFixRatePharmacy
  Dim xgo As Boolean

  If chknextplan.Value = True Then
    xcurVal = "Planned"
  Else
    If modBasic.$DispRequestStatus = "Reserve" Then
      xcurVal = "Reserve"
    Else
      xcurVal = "Continue"
    Endif
  Endif

  xList = GetSetProtocol($encid)
  If xList And If xList.Count Then
    For Each xIndex In xList
      res = modDatabase.$myConn.Exec("select fldroute,flditem,flddose,flddoseunit,fldfreq,fldday,fldqty,fldstart,fldadvice from tblproductgroup where fldid=&1 and (fldcomp=&2 or fldcomp=&3)", xIndex, modBasic.$compID, "%")
      If res.Available Then
        itemtype = modNonMedical.GetBillItemCategoryFromCombo(res["fldroute"])

        xgo = False
        If modBasic.$BillPharmFixedModes.Exist($sBillMode) = True Then
          CPharmFix = New CFixRatePharmacy(itemtype, res["flditem"], $sBillMode)
          xfixrate = CPharmFix.GetFixRate()
          xfixname = CPharmFix.GetFixItem()
          If xfixname Then
            xgo = True
          Else
            xgo = False
          Endif
        Else
          xgo = True
        Endif
        If xgo = True Then
          itemmode = $sBillMode
          xtax = modNonMedical.ShowTaxValues(itemtype, res["flditem"])
          xdisc = modNonMedical.DiscPercentForCategoryValue($encid, cmbdisctype.Text, itemtype, res["flditem"], itemmode)
          Select res["fldroute"]
            Case "suture", "msurg", "ortho"
              modPharmSub.InsertNonMedDosingEntry("Surgicals", $encid, $xBillType, $sBillMode, cmbdisctype.Text, $LedgerAC, res["fldroute"], res["flditem"], res["fldqty"], $status, res["fldstart"], xtax, xdisc, xfixname, xfixrate, "Request", $Dept, res["fldadvice"], False, xcurVal)
            Case "extra"
              modPharmSub.InsertNonMedDosingEntry("Extra Items", $encid, $xBillType, $sBillMode, cmbdisctype.Text, $LedgerAC, res["fldroute"], res["flditem"], res["fldqty"], $status, res["fldstart"], xtax, xdisc, xfixname, xfixrate, "Request", $Dept, res["fldadvice"], False, xcurVal)
            Case Else
              xdose = modMedDosing.GetDoseInMg(res["flddose"], res["flddoseunit"], $encid)
              If xdose Then
                If modMedConstant.GetNarcoticType(res["flditem"]) = "Yes" Then
                  txprescriber = $NarcoDoctor
                  txpresno = $NarcoRegd
                  If Not txpresno Then
                    xnarcotic = DualGridValue(("Select Narcotic Prescriber"), $ClinicianLst, False)
                    If xnarcotic Then
                      txprescriber = xnarcotic[1]
                      txpresno = xnarcotic[0]
                    Endif
                  Endif
                  If txprescriber And If txpresno Then
                    modPharmSub.InsertDosingEntry($encid, $xBillType, $sBillMode, cmbdisctype.Text, $LedgerAC, res["fldroute"], res["flditem"], xdose, res["fldfreq"], res["fldday"], res["fldqty"], $status, txprescriber, txpresno, res["fldstart"], xtax, xdisc, xfixname, xfixrate, "Request", $Dept, res["fldadvice"], False, xcurVal)
                  Endif
                Else
                  modPharmSub.InsertDosingEntry($encid, $xBillType, $sBillMode, cmbdisctype.Text, $LedgerAC, res["fldroute"], res["flditem"], xdose, res["fldfreq"], res["fldday"], res["fldqty"], $status, "", "", res["fldstart"], xtax, xdisc, xfixname, xfixrate, "Request", $Dept, res["fldadvice"], False, xcurVal)
                Endif
              Endif
          End Select
        Endif

      Endif
    Next
    FillDosingGrid()
  Endif

End

Private Sub FillDosingGrid()

  Dim sql As String

  If rblabel.Value = True Then
    sql = "select fldid,fldstarttime,fldroute,flditem,fldid,fldfreq,flddays,fldqtydisp,flduserid_order,fldid,fldid,fldstarttime,fldcurval,flddirection,flddosecount,fldmixing,flddose from tblpatdosing where fldencounterval=&1 and fldsave_order=&2 and fldstatus=&3 and fldorder=&4 and (fldcurval=&5 or fldcurval=&6 or fldcurval=&7)"
  Else
    sql = "select fldid,fldstarttime,fldroute,flditem,flddose,fldfreq,flddays,fldqtydisp,flduserid_order,fldid,fldid,fldstarttime,fldcurval,flddirection,flddosecount,fldmixing,flddose from tblpatdosing where fldencounterval=&1 and fldsave_order=&2 and fldstatus=&3 and fldorder=&4 and (fldcurval=&5 or fldcurval=&6 or fldcurval=&7)"                                                   ''
  Endif
  $rDataM = modDatabase.$myConn.Exec(sql, $encid, False, $status, "Request", "Continue", "Reserve", "Planned")
  $aMyFieldsM = New String[]
  modGridView.ReadSmallData(GridView1, $rDataM, $aMyFieldsM)

  With GridView1
    .Columns[0].Hidden = True
    .Columns[1].Width = CStr(100 * modBasic.$AppWidthRatio) & "px"
    .Columns[2].Width = CStr(100 * modBasic.$AppWidthRatio) & "px"
    .Columns[3].Width = CStr(275 * modBasic.$AppWidthRatio) & "px"
    .Columns[4].Width = CStr(75 * modBasic.$AppWidthRatio) & "px"
    .Columns[5].Width = CStr(75 * modBasic.$AppWidthRatio) & "px"
    .Columns[6].Width = CStr(50 * modBasic.$AppWidthRatio) & "px"
    .Columns[7].Width = CStr(50 * modBasic.$AppWidthRatio) & "px"
    .Columns[8].Hidden = True
    .Columns[9].Hidden = True
    .Columns[10].Hidden = True
    .Columns[11].Hidden = True
    .Columns[12].Width = CStr(75 * modBasic.$AppWidthRatio) & "px"
    .Columns[13].Width = CStr(200 * modBasic.$AppWidthRatio) & "px"
    .Columns[14].Width = CStr(50 * modBasic.$AppWidthRatio) & "px"
    .Columns[15].Width = CStr(200 * modBasic.$AppWidthRatio) & "px"
    .Columns[16].Hidden = True

    .Columns[1].Text = "Start"
    .Columns[2].Text = "Route"
    .Columns[3].Text = "Particulars"
    .Columns[4].Text = "Dose"
    .Columns[5].Text = "Freq"
    .Columns[6].Text = "Day"
    .Columns[7].Text = "QTY"
    .Columns[12].Text = "Status"
    .Columns[13].Text = "Direction"
    .Columns[14].Text = "N"
    .Columns[15].Text = "Mixture"
  End With

End

Public Sub GridView1_Data(Row As Integer, Column As Integer, Data As WebTableData)

  $rDataM.MoveTo(Row)
  modGridView.GridViewDecoration(Data, Row)
  If Column = 1 Then
    Data.Text = modReportVar.GetDateTimeReport($rDataM[$aMyFieldsM[Column]], gb.GeneralDate)
  Else If Column = 4 Then
    If rblabel.Value = True Then
      Data.Text = modPharmacy.GetMedicineDoseInFormat($rDataM[$aMyFieldsM[Column]], "Label")
    Else
      Data.Text = $rDataM[$aMyFieldsM[Column]]
    Endif
  Else
    Data.Text = $rDataM[$aMyFieldsM[Column]]
  Endif

End

Public Sub btnsetregimen_Click()

  Dim sColl As Collection
  Dim xLst As Long[]

  sColl = GetSetRegimen($encid)
  If sColl And If sColl.Count Then
    For Each xLst In sColl
      If sColl.Key = "New Regimen" Then
        AddNewRegimen(xLst)
      Else If sColl.Key = "Past Regimen" Then
        AddPastRegimens(xLst)
      Endif
    Next
  Endif

End

Private Sub AddNewRegimen(itmList As Long[])

  Dim idx As Long
  Dim res As Result
  Dim txprescriber As String
  Dim txpresno As String

  Dim xtax As Float
  Dim xdisc As Float
  Dim itemtype As String
  Dim xfixrate As Float
  Dim xfixname As String
  Dim itemmode As String
  Dim xcurVal As String
  Dim xnarcotic As String[]
  Dim CPharmFix As CFixRatePharmacy
  Dim xgo As Boolean

  If chknextplan.Value = True Then
    xcurVal = "Planned"
  Else
    If modBasic.$DispRequestStatus = "Reserve" Then
      xcurVal = "Reserve"
    Else
      xcurVal = "Continue"
    Endif
  Endif

  If modMisc.AllowDiagnoBilling($encid) = True Then
    If itmList And If itmList.Count Then

      For Each idx In itmList
        res = modDatabase.$myConn.Exec("select fldroute,fldbrandid,flddose,fldfreq,fldday,fldqty,fldusage from tblmedregimen where fldid=&1", idx)
        If res.Available Then
          itemtype = modNonMedical.GetBillItemCategoryFromCombo(res["fldroute"])

          xgo = False
          If modBasic.$BillPharmFixedModes.Exist($sBillMode) = True Then
            CPharmFix = New CFixRatePharmacy(itemtype, res["fldbrandid"], $sBillMode)
            xfixrate = CPharmFix.GetFixRate()
            xfixname = CPharmFix.GetFixItem()
            If xfixname Then
              xgo = True
            Else
              xgo = False
            Endif
          Else
            xgo = True
          Endif
          If xgo = True Then
            itemmode = $sBillMode
            xtax = modNonMedical.ShowTaxValues(itemtype, res["fldbrandid"])
            xdisc = modNonMedical.DiscPercentForCategoryValue($encid, cmbdisctype.Text, itemtype, res["fldbrandid"], itemmode)
            Select res["fldroute"]
              Case "suture", "msurg", "ortho"
                modPharmSub.InsertNonMedDosingEntry("Surgicals", $encid, $xBillType, $sBillMode, cmbdisctype.Text, $LedgerAC, res["fldroute"], res["fldbrandid"], res["fldqty"], $status, txtstart.Value, xtax, xdisc, xfixname, xfixrate, "Request", $Dept, res["fldusage"], False, xcurVal)
              Case "extra"
                modPharmSub.InsertNonMedDosingEntry("Extra Items", $encid, $xBillType, $sBillMode, cmbdisctype.Text, $LedgerAC, res["fldroute"], res["fldbrandid"], res["fldqty"], $status, txtstart.Value, xtax, xdisc, xfixname, xfixrate, "Request", $Dept, res["fldusage"], False, xcurVal)
              Case Else
                If modMedConstant.GetNarcoticType(res["fldbrandid"]) = "Yes" Then
                  txprescriber = $NarcoDoctor
                  txpresno = $NarcoRegd
                  If Not txpresno Then
                    xnarcotic = DualGridValue(("Select Narcotic Prescriber"), $ClinicianLst, False)
                    If xnarcotic Then
                      txprescriber = xnarcotic[1]
                      txpresno = xnarcotic[0]
                    Endif
                  Endif
                  If txprescriber And If txpresno Then
                    modPharmSub.InsertDosingEntry($encid, $xBillType, $sBillMode, cmbdisctype.Text, $LedgerAC, res["fldroute"], res["fldbrandid"], res["flddose"], res["fldfreq"], res["fldday"], res["fldqty"], $status, txprescriber, txpresno, txtstart.Value, xtax, xdisc, xfixname, xfixrate, "Request", $Dept, res["fldusage"], False, xcurVal)
                  Endif
                Else
                  modPharmSub.InsertDosingEntry($encid, $xBillType, $sBillMode, cmbdisctype.Text, $LedgerAC, res["fldroute"], res["fldbrandid"], res["flddose"], res["fldfreq"], res["fldday"], res["fldqty"], $status, "", "", txtstart.Value, xtax, xdisc, xfixname, xfixrate, "Request", $Dept, res["fldusage"], False, xcurVal)
                Endif
            End Select
          Endif

        Endif
      Next

      BlankDosingBox()
      FillDosingGrid()
    Endif
  Else
    Message.Warning("Diagnosis not provided", ("OK"))
  Endif

End

Private Sub AddPastRegimens(itmList As Long[])

  Dim idx As Long
  Dim res As Result
  Dim txprescriber As String
  Dim txpresno As String

  Dim xtax As Float
  Dim xdisc As Float
  Dim itemtype As String
  Dim xfixrate As Float
  Dim xfixname As String
  Dim itemmode As String
  Dim xcurVal As String
  Dim xnarcotic As String[]
  Dim CPharmFix As CFixRatePharmacy
  Dim xgo As Boolean

  If chknextplan.Value = True Then
    xcurVal = "Planned"
  Else
    If modBasic.$DispRequestStatus = "Reserve" Then
      xcurVal = "Reserve"
    Else
      xcurVal = "Continue"
    Endif
  Endif

  If modMisc.AllowDiagnoBilling($encid) = True Then
    If itmList And If itmList.Count Then

      For Each idx In itmList
        res = modDatabase.$myConn.Exec("select fldroute,flditem,flddose,fldfreq,flddays,fldqtydisp,flddirection from tblpatdosing where fldid=&1", idx)
        If res.Available Then
          itemtype = modNonMedical.GetBillItemCategoryFromCombo(res["fldroute"])

          xgo = False
          If modBasic.$BillPharmFixedModes.Exist($sBillMode) = True Then
            CPharmFix = New CFixRatePharmacy(itemtype, res["flditem"], $sBillMode)
            xfixrate = CPharmFix.GetFixRate()
            xfixname = CPharmFix.GetFixItem()
            If xfixname Then
              xgo = True
            Else
              xgo = False
            Endif
          Else
            xgo = True
          Endif
          If xgo = True Then
            itemmode = $sBillMode
            xtax = modNonMedical.ShowTaxValues(itemtype, res["flditem"])
            xdisc = modNonMedical.DiscPercentForCategoryValue($encid, cmbdisctype.Text, itemtype, res["flditem"], itemmode)
            Select res["fldroute"]
              Case "suture", "msurg", "ortho"
                modPharmSub.InsertNonMedDosingEntry("Surgicals", $encid, $xBillType, $sBillMode, cmbdisctype.Text, $LedgerAC, res["fldroute"], res["flditem"], res["fldqtydisp"], $status, txtstart.Value, xtax, xdisc, xfixname, xfixrate, "Request", $Dept, res["flddirection"], False, xcurVal)
              Case "extra"
                modPharmSub.InsertNonMedDosingEntry("Extra Items", $encid, $xBillType, $sBillMode, cmbdisctype.Text, $LedgerAC, res["fldroute"], res["flditem"], res["fldqtydisp"], $status, txtstart.Value, xtax, xdisc, xfixname, xfixrate, "Request", $Dept, res["flddirection"], False, xcurVal)
              Case Else
                If modMedConstant.GetNarcoticType(res["flditem"]) = "Yes" Then
                  txprescriber = $NarcoDoctor
                  txpresno = $NarcoRegd
                  If Not txpresno Then
                    xnarcotic = DualGridValue(("Select Narcotic Prescriber"), $ClinicianLst, False)
                    If xnarcotic Then
                      txprescriber = xnarcotic[1]
                      txpresno = xnarcotic[0]
                    Endif
                  Endif
                  If txprescriber And If txpresno Then
                    modPharmSub.InsertDosingEntry($encid, $xBillType, $sBillMode, cmbdisctype.Text, $LedgerAC, res["fldroute"], res["flditem"], res["flddose"], res["fldfreq"], res["flddays"], res["fldqtydisp"], $status, txprescriber, txpresno, txtstart.Value, xtax, xdisc, xfixname, xfixrate, "Request", $Dept, res["flddirection"], False, xcurVal)
                  Endif
                Else
                  modPharmSub.InsertDosingEntry($encid, $xBillType, $sBillMode, cmbdisctype.Text, $LedgerAC, res["fldroute"], res["flditem"], res["flddose"], res["fldfreq"], res["flddays"], res["fldqtydisp"], $status, "", "", txtstart.Value, xtax, xdisc, xfixname, xfixrate, "Request", $Dept, res["flddirection"], False, xcurVal)
                Endif
            End Select
          Endif

        Endif
      Next

      BlankDosingBox()
      FillDosingGrid()
    Endif
  Else
    Message.Warning("Diagnosis not provided", ("OK"))
  Endif

End

Public Sub btnmeddate_Click()

  Dim xdate As Date

  If GridView1.Selection.Count Then
    $rDataM.MoveTo(GridView1.Selection[0])
    If modGeneral.AllowClinicalEdit($rDataM["flduserid_order"]) = True Then
      xdate = GetDateValue($rDataM["flditem"], ("Alter Starting Date"), $rDataM["fldstarttime"])
      If xdate Then
        modPharmSub.UpdateStartBefDispensing($rDataM["fldid"], xdate)
        FillDosingGrid()
      Endif
    Endif
  Endif

End

Public Sub txtmeddose_Click()

  Dim xval As Float

  If GridView1.Selection.Count Then
    $rDataM.MoveTo(GridView1.Selection[0])
    If modGeneral.AllowClinicalEdit($rDataM["flduserid_order"]) = True Then
      If $rDataM["flddose"] Then
        xval = InputValue($rDataM["flditem"], ("Alter Unit Dose"), $rDataM["flddose"])
      Else
        xval = InputValue($rDataM["flditem"], ("Alter Unit Dose"), 0)
      Endif
      If xval Then
        modPharmSub.UpdateDoseBefDispensing($rDataM["fldid"], xval)
        FillDosingGrid()
      Endif
    Endif
  Endif

End

Public Sub btnmedfreq_Click()

  Dim yval As String

  If GridView1.Selection.Count Then
    $rDataM.MoveTo(GridView1.Selection[0])
    If modGeneral.AllowClinicalEdit($rDataM["flduserid_order"]) = True Then
      yval = InputCombo($rDataM["flditem"], ("Alter Frequency"), modMedicine.FrequencyCombo(), $rDataM["fldfreq"], True)
      If yval Then
        modPharmSub.UpdateFreqBefDispensing($rDataM["fldid"], yval)
        FillDosingGrid()
      Endif
    Endif
  Endif

End

Public Sub btnmeddays_Click()

  Dim xval As Float

  If GridView1.Selection.Count Then
    $rDataM.MoveTo(GridView1.Selection[0])
    If modGeneral.AllowClinicalEdit($rDataM["flduserid_order"]) = True Then
      xval = InputValue($rDataM["flditem"], ("Alter Duration"), $rDataM["flddays"])
      If modBasic.$ClinIPDVarDays = "Enable" And If $status = "Admitted" Then
        modPharmSub.UpdateDaysBefDispensing($rDataM["fldid"], xval)
        FillDosingGrid()
      Else
        If xval Then
          modPharmSub.UpdateDaysBefDispensing($rDataM["fldid"], xval)
          FillDosingGrid()
        Endif
      Endif
    Endif
  Endif

End

Public Sub btnmedqty_Click()

  Dim xval As Float

  If GridView1.Selection.Count Then
    $rDataM.MoveTo(GridView1.Selection[0])
    xval = InputValue($rDataM["flditem"], ("Alter Quantity"), $rDataM["fldqtydisp"])
    If xval Then
      modPharmSub.UpdateQTYBefDispensing($rDataM["fldid"], xval)
      FillDosingGrid()
    Endif
  Endif

End

Public Sub btnadvice_Click()

  Dim yval As String

  If GridView1.Selection.Count Then
    $rDataM.MoveTo(GridView1.Selection[0])
    If modGeneral.AllowClinicalEdit($rDataM["flduserid_order"]) = True Then
      yval = InputBox($rDataM["flditem"], ("Alter Direction"), $rDataM["flddirection"])
      If yval Then
        modPharmSub.UpdateAdviceBefDispensing($rDataM["fldid"], yval)
        FillDosingGrid()
      Endif
    Endif
  Endif

End

Public Sub mnumaxdose_Click()

  Dim xval As Float

  If GridView1.Selection.Count Then
    $rDataM.MoveTo(GridView1.Selection[0])
    If modGeneral.AllowClinicalEdit($rDataM["flduserid_order"]) = True Then
      If $rDataM["flddosecount"] Then
        xval = InputValue($rDataM["flditem"], ("Alter Maximum Dose Count"), $rDataM["flddosecount"])
      Else
        xval = InputValue($rDataM["flditem"], ("Alter Maximum Dose Count"), 0)
      Endif
      If xval Then
        modPharmSub.UpdateMaxCountBeffDispensing($rDataM["fldid"], xval)
        FillDosingGrid()
      Endif
    Endif
  Endif

End

Public Sub mnumixture_Click()

  Dim yval As String

  If GridView1.Selection.Count Then
    $rDataM.MoveTo(GridView1.Selection[0])
    If modGeneral.AllowClinicalEdit($rDataM["flduserid_order"]) = True Then
      yval = InputBox($rDataM["flditem"], ("Alter Compounding Direction"), $rDataM["fldmixing"])
      If yval Then
        modPharmSub.UpdateMixtureBefDispensing($rDataM["fldid"], yval)
        FillDosingGrid()
      Endif
    Endif
  Endif

End

Public Sub btnmeddelete_Click()

  Dim res As Result

  If GridView1.Selection.Count Then
    $rDataM.MoveTo(GridView1.Selection[0])
    If Message.Question(("Are you sure?"), ("No"), ("Yes")) = 2 Then
      res = modDatabase.$myConn.Edit("tblpatdosing", "fldid=&1 and fldsave_order=&2", $rDataM["fldid"], False)
      If modGeneral.AllowClinicalEdit(res["flduserid_order"]) = True Then
        modDatabase.$myConn.Delete("tblpatdosing", "fldid=&1 and fldsave_order=&2", $rDataM["fldid"], False)
      Else
        res["fldcurval"] = "Cancelled"
        res["flduserid_order"] = modBasic.$lbluser
        res["xyz"] = False
        res.Update
      Endif
      FillDosingGrid()
    Endif
  Endif

End

Public Sub btnmedlabel_Click()

  Dim hClabel As CLabelSize

  If GridView1.Selection.Count Then
    $rDataM.MoveTo(GridView1.Selection[0])
    hClabel = New CLabelSize($rDataM["fldid"], $LabelType)
    ' modPrint.PrintPopUp(CStr($rDataM["fldid"], hClabel.LabelPath(), "LabelSize")
  Endif

End

Public Sub btnreview_Click()

  Dim opt As Long[]
  Dim cForm As CMedError
  Dim xPath As String

  If GridView1.Count Then
    opt = New Long[]
    For Each $rDataM
      Select $rDataM["fldroute"]
        Case "suture", "msurg", "ortho", "extra", "topical"
        Case Else
          opt.Add($rDataM["fldid"])
      End Select
    Next
    cForm = New CMedError
    xPath = cForm.ShowMedicationReviewMultipleDosIDReport($encid, opt)
    modControlSub.OpenHTMLPreview($encid, xPath, "ReportSize")
  Endif

End

Public Sub btnaireview_Click()

  Dim opt As Long[]
  Dim xdata As String
  Dim xans As String

  If GridView1.Count Then
    opt = New Long[]
    For Each $rDataM
      Select $rDataM["fldroute"]
        Case "suture", "msurg", "ortho", "extra", "topical"
        Case Else
          opt.Add($rDataM["fldid"])
      End Select
    Next

    If opt.Count Then
      xdata = modPharmacy.ShowMedicationListDosID($encid, opt).Join(gb.NewLine)
      xans = modCloudAI.GetComboCloudAIResponse(xdata, modBasic.$CloudAIDrugQuery)
      If xans Then
        xans = MessageHtml("Cloud AI Response", modString.TextToHTML(xans), [("Useless"), ("Neutral"), ("Useful")])
      Endif
    Endif

  Endif

End

Public Sub btnshow_Click()

  Dim xPath As String

  xPath = modCHTMLPatient.ShowMedicationOrder($encid)
  modControlSub.OpenHTMLPreview($encid, xPath, "ReportSize")

End

' Public Sub GridView1_Menu()
'
'   mnuhide.Popup
'
' End

Public Sub mnutaper_Click()

  Dim hForm As Fmtaperdose

  If GridView1.Selection.Count Then
    $rDataM.MoveTo(GridView1.Selection[0])
    If $rDataM["fldfreq"] = "Tapering" Then
      hForm = New Fmtaperdose($rDataM["fldid"])
      hForm.ShowModal
    Endif
  Endif

End

Public Sub btndispown_Click()

  If GridView1.Selection.Count Then
    If Message.Question(("Dispense from LOCAL Stock. Are you sure ?"), ("No"), ("Yes")) = 2 Then
      $rDataM.MoveTo(GridView1.Selection[0])
      SaveOwnDispensing($rDataM["fldid"], "Continue")
      FillDosingGrid()
    Endif
  Endif

End

Public Sub mnusave_Click()

  If GridView1.Selection.Count Then
    If Message.Question(("Bring from OUTSIDE. Are you sure ?"), ("No"), ("Yes")) = 2 Then
      $rDataM.MoveTo(GridView1.Selection[0])
      modPharmSub.UpdateDispensing($rDataM["fldid"], True)
      FillDosingGrid()
    Endif
  Endif

End

Public Sub mnuonline_Click()

  If GridView1.Selection.Count Then
    $rDataM.MoveTo(GridView1.Selection[0])
    modPharmSub.DisableDispOnline($rDataM["fldid"])
    FillDosingGrid()
    Me.Exec("Toastify({text: 'Request updated', duration: 3000}).showToast()")
  Endif

End

Public Sub mnucontinue_Click()

  If GridView1.Selection.Count Then
    $rDataM.MoveTo(GridView1.Selection[0])
    modPharmSub.ContinueDispReq($rDataM["fldid"])
    FillDosingGrid()
    Me.Exec("Toastify({text: 'Request updated', duration: 3000}).showToast()")
  Endif

End

Public Sub mnureview_Click()

  Dim opt As String[]
  Dim xval As String
  Dim cForm As CMedError
  Dim xPath As String

  opt = New String[]
  For Each $rDataM
    Select $rDataM["fldroute"]
      Case "suture", "msurg", "ortho", "extra", "topical"
      Case Else
        xval = modMedConstant.GetDrugFromStockID($rDataM["flditem"])
        If opt.Count = 0 Then
          opt.Add(xval)
        Else
          If opt.Exist(xval) = False Then
            opt.Add(xval)
          Endif
        Endif
    End Select
  Next

  If GridView1.Selection.Count Then
    $rDataM.MoveTo(GridView1.Selection[0])
    cForm = New CMedError
    xPath = cForm.ShowMedicationReviewSingleDosIDReport($rDataM["fldid"], opt)
    modControlSub.OpenHTMLPreview($encid, xPath, "ReportSize")
  Endif

End

Public Sub mnudisplabel_Click()

  Dim xPath As String

  If GridView1.Selection.Count Then
    $rDataM.MoveTo(GridView1.Selection[0])
    xPath = modCHTMLPatient.ShowSingleCounselingReport($rDataM["fldid"])
    modControlSub.OpenHTMLPreview("", xPath, "ReportSize")
  Endif

End

''====================================Runnung medicines =================================
Private Sub GetDoseFormatType()

  Dim def As String

  def = modSettings.ShowSettingFromFIle("DoseFormat/Dispensing")
  If def Then
    If def = "Label" Then
      rblabel.Value = True
    Else
      rbvalue.Value = True
    Endif
  Else
    rbvalue.Value = True
  Endif

End

Public Sub rbvalue_Click()

  modSettings.SaveSettingsToFile("DoseFormat/Dispensing", "Value")
  RefreshGridsLabel()

End

Public Sub rblabel_Click()

  modSettings.SaveSettingsToFile("DoseFormat/Dispensing", "Label")
  RefreshGridsLabel()

End

Public Sub rballdates_Click()

  RefreshGridsLabel()

End

Public Sub rbcurrent_Click()

  RefreshGridsLabel()

End

Private Sub RefreshGridsLabel()

  If $Ready = True Then
    If TabPanel1.Index = 0 Then
      If rballdates.Value = True Then
        ShowAllMedicines()
      Else If rbcurrent.Value = True Then
        ShowRunningMedicine(cmbcurrent.Text)
      Endif
    Else If TabPanel1.Index = 1 Then
      FillDosingGrid()
    Endif
  Endif

End

Public Sub btncurrefresh_Click()

  If rballdates.Value = True Then
    ShowAllMedicines()
  Else If rbcurrent.Value = True Then
    ShowRunningMedicine(cmbcurrent.Text)
  Endif

End

Private Sub ShowAllMedicines()

  Dim sql1 As String
  Dim sql2 As String
  Dim xFields As String[]

  If rblabel.Value = True Then
    xFields = ["fldid", "fldsave_order", "fldstarttime", "fldroute", "flditem", "fldid", "fldfreq", "flddays", "fldcurval", "fldid", "fldstarttime", "fldstatus", "flduserid_order"]
  Else
    xFields = ["fldid", "fldsave_order", "fldstarttime", "fldroute", "flditem", "flddose", "fldfreq", "COUNT(fldid)", "fldcurval", "fldid", "fldstarttime", "fldstatus", "flduserid_order"]
  Endif
  If rblabel.Value = True Then
    sql1 = "select " & xFields.Join(",") & " from tblpatdosing where fldencounterval=&1 and fldsave_order=&2 and flditemtype=&3 and flddays>&4"
    sql2 = "select " & xFields.Join(",") & " from tblpatdosing where fldencounterval=&1 and fldsave_order=&2 and flditemtype=&3 and flddays=&4 GROUP BY flditem,flddose,fldfreq"
  Else
    sql1 = "select " & xFields.Join(",") & " from tblpatdosing where fldencounterval=&1 and fldsave_order=&2 and flditemtype=&3 and flddays>&4"                    ''
    sql2 = "select " & xFields.Join(",") & " from tblpatdosing where fldencounterval=&1 and fldsave_order=&2 and flditemtype=&3 and flddays=&4 GROUP BY flditem,flddose,fldfreq"
  Endif
  $rData2 = modDatabase.$myConn.Exec(sql1 & " UNION ALL " & sql2, $encid, True, "Medicines", 0)

  $aMyFields2 = New String[]
  modGridView.ReadSmallData(grdmedicine, $rData2, $aMyFields2)
  ResizeGrid()

End

Private Sub ShowRunningMedicine(xCurrent As String)

  Dim sql As String
  Dim asx As String[] = ["Completed", "Discontinue", "Change", "ReWrite", "Cancelled", "Wasted"]
  Dim i As Integer
  Dim xFields As String[]

  For i = 0 To asx.Count - 1
    asx[i] = "'" & asx[i] & "'"
  Next

  If rblabel.Value = True Then
    xFields = ["fldid", "fldsave_order", "fldstarttime", "fldroute", "flditem", "fldid", "fldfreq", "flddays", "fldcurval", "fldid", "fldstarttime", "fldstatus", "flduserid_order"]
  Else
    xFields = ["fldid", "fldsave_order", "fldstarttime", "fldroute", "flditem", "flddose", "fldfreq", "flddays", "fldcurval", "fldid", "fldstarttime", "fldstatus", "flduserid_order"]
  Endif
  Select xCurrent
    Case "Continue", "On Hold"
      If rblabel.Value = True Then
        sql = "select " & xFields.Join(",") & " from tblpatdosing where fldencounterval=&1 and fldstarttime<=&2 and DATE_ADD(fldstarttime, INTERVAL flddays DAY)>=&3 and flditemtype=&4 and fldcurval=&5 and fldqtydisp>fldqtyret ORDER BY fldid DESC"
      Else
        sql = "select " & xFields.Join(",") & " from tblpatdosing where fldencounterval=&1 and fldstarttime<=&2 and DATE_ADD(fldstarttime, INTERVAL flddays DAY)>=&3 and flditemtype=&4 and fldcurval=&5 and fldqtydisp>fldqtyret ORDER BY fldid DESC"                    ''
      Endif
      $rData2 = modDatabase.$myConn.Exec(sql, $encid, Now(), DateAdd(Now(), gb.Hour, -3), "Medicines", xCurrent)

    Case "Removed"
      If rblabel.Value = True Then
        sql = "select " & xFields.Join(",") & " from tblpatdosing where fldencounterval=&1 and fldstarttime<=&2 and DATE_ADD(fldstarttime, INTERVAL flddays DAY)>=&3 and flditemtype=&4 and fldcurval in(" & asx.Join(",") & ") and fldqtydisp>fldqtyret ORDER BY fldid DESC"
      Else
        sql = "select " & xFields.Join(",") & " from tblpatdosing where fldencounterval=&1 and fldstarttime<=&2 and DATE_ADD(fldstarttime, INTERVAL flddays DAY)>=&3 and flditemtype=&4 and fldcurval in(" & asx.Join(",") & ") and fldqtydisp>fldqtyret ORDER BY fldid DESC"                    ''
      Endif
      $rData2 = modDatabase.$myConn.Exec(sql, $encid, Now(), DateAdd(Now(), gb.Hour, -3), "Medicines")

    Case "All Types"
      If rblabel.Value = True Then
        sql = "select " & xFields.Join(",") & " from tblpatdosing where fldencounterval=&1 and fldstarttime<=&2 and DATE_ADD(fldstarttime, INTERVAL flddays DAY)>=&3 and flditemtype=&4 and fldqtydisp>fldqtyret ORDER BY fldid DESC"
      Else
        sql = "select " & xFields.Join(",") & " from tblpatdosing where fldencounterval=&1 and fldstarttime<=&2 and DATE_ADD(fldstarttime, INTERVAL flddays DAY)>=&3 and flditemtype=&4 and fldqtydisp>fldqtyret ORDER BY fldid DESC"                    ''
      Endif
      $rData2 = modDatabase.$myConn.Exec(sql, $encid, Now(), DateAdd(Now(), gb.Hour, -3), "Medicines")

  End Select
  $aMyFields2 = New String[]
  modGridView.ReadSmallData(grdmedicine, $rData2, $aMyFields2)
  ResizeGrid()

End

Private Sub ResizeGrid()

  With grdmedicine
    .Columns[0].Hidden = True
    .Columns[1].Width = CStr(25 * modBasic.$AppWidthRatio) & "px"
    .Columns[2].Width = CStr(150 * modBasic.$AppWidthRatio) & "px"
    .Columns[3].Width = CStr(75 * modBasic.$AppWidthRatio) & "px"
    .Columns[4].Width = CStr(275 * modBasic.$AppWidthRatio) & "px"
    .Columns[5].Width = CStr(75 * modBasic.$AppWidthRatio) & "px"
    .Columns[6].Width = CStr(50 * modBasic.$AppWidthRatio) & "px"
    .Columns[7].Width = CStr(50 * modBasic.$AppWidthRatio) & "px"
    .Columns[8].Width = CStr(100 * modBasic.$AppWidthRatio) & "px"
    If rballdates.Value = True Then
      .Columns[9].Hidden = True
      .Columns[10].Hidden = True
      .Columns[11].Hidden = True
      .Columns[12].Hidden = True
    Else
      .Columns[9].Width = CStr(50 * modBasic.$AppWidthRatio) & "px"
      .Columns[10].Hidden = True
      .Columns[11].Hidden = True
      .Columns[12].Width = CStr(125 * modBasic.$AppWidthRatio) & "px"
    Endif

    .Columns[2].Text = "StartDate"
    .Columns[3].Text = "Route"
    .Columns[4].Text = "Medicine"
    .Columns[5].Text = "Dose"
    .Columns[6].Text = "Freq"
    .Columns[7].Text = "Days"
    .Columns[8].Text = "Status"
    If rballdates.Value = True Then
    Else
      .Columns[9].Text = "N"
      .Columns[12].Text = "Order"
    Endif
  End With

End

Public Sub grdmedicine_Data(Row As Integer, Column As Integer, Data As WebTableData)

  $rData2.MoveTo(Row)
  modGridView.GridViewDecoration(Data, Row)
  If Column = 1 Then
    If rballdates.Value = True Then
      Data.Text = ""
    Else
      Data.Html = modString.GetImageForHTMLGrid(GetMedStatus($rData2[$aMyFields2[Column]]), "auto", "auto")
      Data.Text = ""
    Endif
  Else If Column = 2 Then
    Data.Text = modReportVar.GetDateTimeReport($rData2[$aMyFields2[Column]], gb.GeneralDate)
  Else If Column = 5 Then
    If rblabel.Value = True Then
      If $rData2[$aMyFields2[Column]] Then
        Data.Text = modPharmacy.GetMedicineDoseInFormat($rData2[$aMyFields2[Column]], "Label")
      Endif
    Else
      Data.Text = $rData2[$aMyFields2[Column]]
    Endif
  Else If Column = 9 Then
    If rballdates.Value = True Then
      Data.Text = ""
    Else
      Data.Text = modPharmacy.TotalDoseCount($rData2[$aMyFields2[Column]])
    Endif
  Else If Column = 12 Then
    If rballdates.Value = True Then
      Data.Text = ""
    Else
      Data.Text = modGeneral.GetUserFullName($rData2[$aMyFields2[Column]])
    Endif
  Else
    Data.Text = $rData2[$aMyFields2[Column]]
  Endif

End

Private Function GetMedStatus(sBool As Boolean) As String

  Dim xicon As String

  If sBool = True Then
    xicon = ""
  Else If sBool = False Then
    xicon = "/" &/ Application.Root &/ "icons/coll5.png"
  Endif

  Return xicon

End

Public Sub btnstatus_Click()

  Dim res As Result

  If grdmedicine.Selection.Count Then
    If rbcurrent.Value = True Then
      If cmbcurrent.Text = "Continue" Or If cmbcurrent.Text = "On Hold" Then

        If cmbstatus.Text Then
          $rData2.MoveTo(grdmedicine.Selection[0])
          res = modDatabase.$myConn.Edit("tblpatdosing", "fldid=&1 and fldcurval=&2", $rData2["fldid"], cmbcurrent.Text)
          res["fldcurval"] = cmbstatus.Text
          res["xyz"] = False
          res.Update()
          ShowRunningMedicine(cmbcurrent.Text)
          cmbstatus.Text = ""
          Me.Exec(Subst("Toastify({text: '&1', duration: &2}).showToast()", "Information saved", modBasic.$BalloonDelay))
        Endif

      Endif
    Endif
  Endif

End

Public Sub btnaiadvice_Click()

  Dim xList As String[]
  Dim xans As String

  xList = New String[]
  For Each $rData2
    xList.Add($rData2["fldroute"] & Space(1) & modMedConstant.GetCodeFromStockID($rData2["flditem"]) & Space(2) & $rData2["flddose"] & " " & modMedConstant.GetMedicineDoseUnit($rData2["flditem"]) & " X " & $rData2["fldfreq"] & " X " & $rData2["flddays"] & " day(s)")
  Next

  If xList.Count Then
    xans = modCloudAI.GetComboCloudAIResponse(xList.Join(gb.NewLine), modBasic.$CloudAIDrugQuery)
    If xans Then
      xans = MessageHtml("Cloud AI Response", modString.TextToHTML(xans), [("Useless"), ("Neutral"), ("Useful")])
    Endif
  Endif

End

Private Sub SaveOwnDispensing(sID As Long, sStatus As String)

  Dim sql1 As String
  Dim res1 As Result
  Dim hForm As CPharmOwn

  sql1 = "select fldid,fldtime,fldroute,flditem,flddose,fldfreq,flddays,fldqtydisp,fldlabel,flditemtype,fldfixname,fldfixrate,fldtaxper,flddiscper,fldbillingmode,flddisctype,fldacledger,fldbilltype,fldcashincredit from tblpatdosing where fldid=&1 and fldsave_order=&2 and fldcurval=&3 and fldencounterval=&4"                                                   ''
  res1 = modDatabase.$myConn.Exec(sql1, sID, False, "Continue", $encid)
  If res1.Available = True Then
    hForm = New CPharmOwn($encid, $sBillMode, res1)
    If $sClaimState = "Consultation" Or If $sClaimState = "Patient Ward" Then
      GetHImedicineCappingVar()
    Endif
    hForm.SetCappingLimit($HiCappingVar)
    hForm.DispenseItem(sStatus)
  Endif

End

Public Sub btnclose_Click()

  Me.Close()

End

''================================Dosing History ===============================
Private Sub ShowMedicationHistory()

  Dim dtList As Date[]
  Dim xdate As Date
  Dim sql As String
  Dim res As Result

  Dim Column As Integer
  Dim pic2 As String
  Dim pic3 As String

  pic2 = "icons/coll2.png"
  pic3 = "icons/coll3.png"

  dtList = modDate.GetDateArrayBetween($doa, Now())
  dtList.Sort(gb.Descent)
  GridView2.Clear()
  GridView2.Columns.Count = 6
  With GridView2
    .Columns[0].Width = CStr(75 * modBasic.$AppWidthRatio) & "px"
    .Columns[1].Width = CStr(175 * modBasic.$AppWidthRatio) & "px"
    .Columns[2].Width = CStr(175 * modBasic.$AppWidthRatio) & "px"
    .Columns[3].Width = CStr(75 * modBasic.$AppWidthRatio) & "px"
    .Columns[4].Width = CStr(75 * modBasic.$AppWidthRatio) & "px"
    .Columns[5].Width = CStr(75 * modBasic.$AppWidthRatio) & "px"

    .Columns[0].Text = "Time"
    .Columns[1].Text = "Medicine"
    .Columns[2].Text = "Regimen"
    .Columns[3].Text = "Dose"
    .Columns[4].Text = "Unit"
    .Columns[5].Text = "User"
  End With

  For Each xdate In dtList
    sql = "select tblnurdosing.fldtime as fldtime,tblpatdosing.flditem as flditem,tblpatdosing.fldid as fldid,tblnurdosing.fldvalue as fldvalue,tblnurdosing.fldunit as fldunit,tblnurdosing.flduserid as flduserid from tblnurdosing inner join tblpatdosing on tblnurdosing.flddoseno=tblpatdosing.fldid where tblnurdosing.fldencounterval=&1 and tblpatdosing.fldencounterval=&1 and tblnurdosing.fldtime>=&2 and tblnurdosing.fldtime<=&3"
    res = modDatabase.$syConn.Exec(sql, $encid, modDate.StartSqlDate(xdate), modDate.EndSqlDate(xdate))
    If res.Available Then
      GridView2.Add(CStr(xdate), modReportVar.GetDateTimeReport(xdate, gb.MediumDate), pic2)

      Column = 0
      For Each res
        GridView2.Add(CStr(xdate) & ":" & CStr(Column), modReportVar.GetDateTimeReport(res["fldtime"], gb.ShortTime), pic3, CStr(xdate))

        GridView2[CStr(xdate) & ":" & CStr(Column)][1] = res["flditem"]
        GridView2[CStr(xdate) & ":" & CStr(Column)][2] = modPharmacy.GetDoseRegimenString(res["fldid"], True)
        GridView2[CStr(xdate) & ":" & CStr(Column)][3] = res["fldvalue"]
        GridView2[CStr(xdate) & ":" & CStr(Column)][4] = res["fldunit"]
        GridView2[CStr(xdate) & ":" & CStr(Column)][5] = res["flduserid"]
        Column = Column + 1
      Next
    Endif
  Next

End

''======================= Protocols =======================
Public Sub btnaddprotocol_Click()

  Dim xx As String
  Dim xList As String[]
  Dim res As Result

  xList = modMedicine.GetMedicineProcolsList()
  If xList And If xList.Count Then
    xx = InputCombo("Select Protocol to Assign", "Drug Protocols", xList, "", True)
    If xx Then
      res = modDatabase.$myConn.Create("tblpatprotocols")
      res["fldencounterval"] = $encid
      res["fldpatientval"] = $PatientNum
      res["fldprotocol"] = xx
      res["fldstatus"] = "Active"
      res["fldusage"] = ""
      res["fldfuture"] = chknewvisit.Value
      res["flduserid"] = modBasic.$lbluser
      res["fldtime"] = Now()
      res["fldcomp"] = modBasic.$compID
      res["fldsave"] = True
      res["xyz"] = False
      res.Update
      ShowPatProtocols()
    Endif
  Endif

End

Private Sub ShowPatProtocols()

  Dim sql1 As String
  Dim sql2 As String

  sql1 = "select fldid,fldtime,fldprotocol,fldstatus,fldfuture,flduserid,fldusage from tblpatprotocols where fldencounterval=&1 and (fldstatus=&2 or fldstatus=&3)"
  sql2 = "select fldid,fldtime,fldprotocol,fldstatus,fldfuture,flduserid,fldusage from tblpatprotocols where fldpatientval=&4 and (fldstatus=&2 or fldstatus=&3) and fldfuture=&5"
  $rData3 = modDatabase.$myConn.Exec(sql1 & " UNION " & sql2, $encid, "Active", "Inactive", $PatientNum, True)
  $aMyFields3 = New String[]
  modGridView.ReadSmallData(GridView3, $rData3, $aMyFields3)

  With GridView3
    .Columns[0].Hidden = True
    .Columns[1].Width = CStr(150 * modBasic.$AppWidthRatio) & "px"
    .Columns[2].Width = CStr(250 * modBasic.$AppWidthRatio) & "px"
    .Columns[3].Width = CStr(100 * modBasic.$AppWidthRatio) & "px"
    .Columns[4].Width = CStr(25 * modBasic.$AppWidthRatio) & "px"
    .Columns[5].Width = CStr(100 * modBasic.$AppWidthRatio) & "px"
    .Columns[6].Width = CStr(300 * modBasic.$AppWidthRatio) & "px"

    .Columns[1].Text = "DateTime"
    .Columns[2].Text = "Protocols"
    .Columns[3].Text = "Status"
    .Columns[5].Text = "Prescriber"
    .Columns[6].Text = "Direction"
  End With

End

Public Sub GridView3_Data(Row As Integer, Column As Integer, Data As WebTableData)

  $rData3.MoveTo(Row)
  modGridView.GridViewDecoration(Data, Row)
  If Column = 1 Then
    Data.Text = modReportVar.GetDateTimeReport($rData3[$aMyFields3[Column]], gb.GeneralDate)
  Else If Column = 4 Then
    Data.Html = modString.GetImageForHTMLGrid(modMisc.SetGridCheckIcon($rData3[$aMyFields3[Column]]), "75%", "75%")
    Data.Text = ""
  Else
    Data.Text = $rData3[$aMyFields3[Column]]
  Endif

End

Public Sub btnproflag_Click()

  Dim xx As String
  Dim res As Result

  If GridView3.Selection.Count Then
    $rData3.MoveTo(GridView3.Selection[0])
    xx = InputCombo("Alter Status of " & $rData3["fldprotocol"], "Alter Status", ["Active", "Inactive"], $rData3["fldstatus"], True)
    If xx Then
      res = modDatabase.$myConn.Edit("tblpatprotocols", "fldid=&1 and fldencounterval=&2", $rData3["fldid"], $encid)
      res["fldstatus"] = xx
      res.Update
      ShowPatProtocols()
    Endif
  Endif

End

Public Sub btndirection_Click()

  Dim xx As String
  Dim res As Result

  If GridView3.Selection.Count Then
    $rData3.MoveTo(GridView3.Selection[0])
    xx = InputBox("Alter Directions for " & $rData3["fldprotocol"], "Alter Directions", $rData3["fldusage"])
    If xx Then
      res = modDatabase.$myConn.Edit("tblpatprotocols", "fldid=&1 and fldencounterval=&2", $rData3["fldid"], $encid)
      res["fldusage"] = xx
      res.Update
      ShowPatProtocols()
    Endif
  Endif

End

Public Sub btnprotdel_Click()

  Dim res As Result

  If GridView3.Selection.Count Then
    $rData3.MoveTo(GridView3.Selection[0])
    If Message.Question("Are you sure ?", ("No"), ("Yes")) = 2 Then
      res = modDatabase.$myConn.Edit("tblpatprotocols", "fldid=&1 and fldencounterval=&2", $rData3["fldid"], $encid)
      If modGeneral.AllowClinicalEdit(res["flduserid"]) = True Then
        modDatabase.$myConn.Delete("tblpatprotocols", "fldid=&1 and fldencounterval=&2", $rData3["fldid"], $encid)
      Else
        res["fldstatus"] = "Cancelled"
        res.Update
      Endif
      ShowPatProtocols()
    Endif
  Endif

End
