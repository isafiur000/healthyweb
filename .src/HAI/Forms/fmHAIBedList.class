' Gambas class file

Private $structExamList As String[]
Private $UserRestrict As String[]
Private $rData As Result
Private $aMyFields As String[]
Private $SSQLFields As String[]
Private $ColCount As Integer
Private $newColumn As String[]
Private $RepoStr As String

Public Sub _new()

  If MMain.$WebReport = "Multiple" Then
    xPanelentry.Visible = False
    btntriage.Visible = False
    If modBasic.$HospCode Then
      cmblocation.Text = modDataRepo.$RepositoryMode
      cmbvalue.Text = modBasic.$HospCode
      WebContainer21.Enabled = False
    Else
      cmblocation.List = ["Hospital", "Municipality", "Category", "District", "Province"]
    Endif
  Else
    WebContainer21.Visible = False
  Endif

  Select modHelpVariable.$LogInCategory
    Case "Research"
      mnudata.Visible = True
      mnuhistoryall.Visible = True
      mnuarchive.Visible = True
      mnucustreport.Visible = True
    Case "Clinician"
      mnudata.Visible = True
      mnuhistoryall.Visible = True
      mnuarchive.Visible = True
      mnucustreport.Visible = True
      mnucustchartall.Visible = True
      mnuformatexams.Visible = True
  End Select

  $UserRestrict = modBasic.$ClinicDisableCompo
  cmbdept.List = modBasic.$IPDDepartmentsAll
  cmbdept.Add("%")
  cmbdept.Add("Exited")
  If modHelpVariable.$LogInCategory = "Clinician" Then
    GetComboItemList()
    xPanelentry.Visible = True
  Endif
  If modBasic.$FixedDepartment Then
    cmbdept.Text = modBasic.$FixedDepartment
    If modBasic.$LockToOwnDepart = "Yes" Then
      cmbdept.Enabled = False
    Endif
  Else
    cmbdept.Text = modSettings.ShowSettingFromFIle("IPClinic/DefaultDepart")
  Endif

  $structExamList = modMedicine.FillClinicalSubClass("Physician Examinations")
  FillCustomMenu()
  FillCustomFormMenu()
  FillExamMenu()

  rbmetric.Value = True
  If cmbdept.Text Then
    btnrefresh_Click()
  Endif
  cmbdept.SetFocus

End

Public Sub cmblocation_Click()

  cmbvalue.Clear()
  If cmblocation.Text Then
    cmbvalue.List = modDataRepo.GetRepoValueListType(cmblocation.Text)
  Endif

End

Public Sub ToolButton1_Click()

  Dim xcol As String

  xcol = InputColor("Triage", ToolButton1.Background)
  If xcol = CStr(Color.White) Then
    ToolButton1.Background = Color.White
  Else
    If xcol Then
      ToolButton1.Background = CInt(xcol)
    Endif
  Endif

End

Private Function LabUnitForm() As String

  Dim xx As String

  If rbsi.Value = True Then
    xx = "SI"
  Else
    xx = "Metric"
  Endif
  Return xx

End

Public Sub txtencid_Change()

  FillBedGrid()

End

Public Sub btnrefresh_Click()

  Dim bedcount As Integer

  If cmbdept.Text Then
    FillBedGrid()
    If cmbdept.Text = "Exited" Then
      xPanelentry.Enabled = False
    Else
      xPanelentry.Enabled = True
      modSettings.SaveSettingsToFile("IPClinic/DefaultDepart", cmbdept.Text)
    Endif
    bedcount = modGeneral.GetWardBedCount(cmbdept.Text)
    GridView1.SetFocus
  Endif

End

Private Function GetFieldsList()

  Dim xhospfld As String

  xhospfld = modDataRepo.HospitalField()
  $SSQLFields = ["fldencounterval", "fldcurrlocat", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval"]
  If xhospfld Then
    $SSQLFields.Add(xhospfld)
  Endif

End

Private Function GetSQLColumns() As String[]

  Dim xFldList As String[]
  Dim i As Integer

  GetFieldsList()
  modCustPatient.FillNewCOlumnCollection(Me.Tag)
  $newColumn = modCustPatient.CustomNewColumnsTitle(Me.Tag)
  xFldList = $SSQLFields.Copy()
  If $newColumn.Count Then
    For i = 0 To $newColumn.Count - 1
      xFldList.Add("fldencounterval")
    Next
  Endif
  Return xFldList

End

Private Function ExecuteQuery(xFldList As String[]) As Result

  Dim res As Result
  Dim sql As String
  Dim xencid As String
  Dim xcolor As String
  Dim xdate As Date[]

  If ToolButton1.Background = Color.White Then
    xcolor = ""
  Else
    xcolor = " and " & db.Subst("fldheight=&1", CStr(ToolButton1.Background))
  Endif

  If Len(txtencid.Text) Then
    xencid = db.Subst(" and lower(fldencounterval) like &1", LCase(Trim(txtencid.Text)) & "%")
  Else
    xencid = ""
  Endif

  $RepoStr = modDataRepo.GetWhereStringRepo(cmblocation.Text, cmbvalue.Text)
  ''show only if device insertion date > 48 hours from now
  If cmbdept.Text = "%" Then
    sql = "select " & xFldList.Join(",") & " from tblencounter where flddoa<=&1 and (flddod>=&2 or flddod IS NULL) and fldencounterval like &3 and fldencounterval in(select fldencounterval from tblpatevents where fldtype=&4 and fldfirsttime<=&5)" & xencid & xcolor & $RepoStr & " ORDER BY fldcurrlocat ASC"                       ''
    res = modDatabase.$myConn.Exec(sql, modDate.EndSqlDate(Now()), modDate.StartSqlDate(Now()), "%", "Devices", DateAdd(Now(), gb.Hour, -48))
  Else If cmbdept.Text = "Exited" Then
    xdate = DoubleDates("Select Discharge Dates", "Exited Patients", [DateAdd(Now(), gb.Month, -1), Now()])
    If xdate Then
      sql = "select " & xFldList.Join(",") & " from tblencounter where flddod>=&1 and flddod<=&2 and fldencounterval like &3 and fldencounterval in(select fldencounterval from tblpatevents where fldtype=&4 and fldsecondtime IS NOT NULL)" & xencid & xcolor & $RepoStr & " ORDER BY fldcurrlocat ASC"                       ''
      res = modDatabase.$myConn.Exec(sql, modDate.StartSqlDate(xdate[0]), modDate.EndSqlDate(xdate[1]), "%", "Devices")
    Endif
  Else
    sql = "select " & xFldList.Join(",") & " from tblencounter where flddoa<=&1 and (flddod>=&2 or flddod IS NULL) and fldencounterval like &3 and fldcurrlocat in(select fldbed from tbldepartmentbed where flddept=&4) and fldencounterval in(select fldencounterval from tblpatevents where fldtype=&5 and fldfirsttime<=&6)" & xencid & xcolor & $RepoStr & "ORDER BY fldcurrlocat ASC"                       ''
    res = modDatabase.$myConn.Exec(sql, modDate.EndSqlDate(Now()), modDate.StartSqlDate(Now()), "%", cmbdept.Text, "Devices", DateAdd(Now(), gb.Hour, -48))
  Endif
  Return res

End

Private Function GetGridViewValue(Column As Integer, xVariable As Variant) As Variant

  Dim xxx As Variant
  Dim i As Integer

  If Column = 2 Then
    xxx = modPatient.GetPatientNameByEnc(xVariable, modDatabase.$syConn) & "<br>" & "<small>" & modPatient.GetPatientAgeString(xVariable, Now()) & "/" & modPatient.GetPatientSex(xVariable, modDatabase.$syConn) & "<br>" & modReportVar.GetDateTimeReport(modPatient.GetAdmissionDate(xVariable), gb.GeneralDate) & "</small>"
  Else If Column = 5 Then
    xxx = modString.TextToHTML(modHAI.GetDeviceStartDates(xVariable).Join(gb.NewLine))
  Else If Column = 6 Then
    xxx = modString.TextToHTML(modHAI.GetHAIDeviceProfile(xVariable).Join(gb.NewLine))
  Else If Column = 7 Then
    xxx = modString.TextToHTML(modHAI.GetInfectionValues(xVariable, modHIReport.$DepartmentName).Join(gb.NewLine))
  Else If Column = 8 Then
    xxx = modString.TextToHTML(modHAI.GetCultureNoGrowthList(xVariable).Join(gb.NewLine))
  Else If Column = 9 Then
    xxx = modString.TextToHTML(modHAI.GetCulturePathogenList(xVariable).Join(gb.NewLine))
  Else If Column = 10 Then
    xxx = modHAI.GetHAIGridOutcome(xVariable)
  Else If Column = 11 Then
    xxx = modHAI.GetFixedClassification(xVariable)
  Else
    xxx = xVariable
  Endif

  If $newColumn.Count Then
    For i = 0 To $newColumn.Count - 1
      If Column = $ColCount + i Then
        xxx = modCustPatient.NewColValue(Me.Tag, $newColumn[i], xVariable)
      Endif
    Next
  Endif

  Return xxx

End

Private Sub FillBedGrid()

  Dim xFldList As String[]

  xFldList = GetSQLColumns()
  $rData = ExecuteQuery(xFldList)
  ResizeGrid()

End

Private Sub ResizeGrid()

  Dim i As Integer

  Dim xvismode As String
  Dim noCols As Integer[]
  Dim Column As Integer

  $aMyFields = New String[]
  modGridView.ReadSmallData(GridView1, $rData, $aMyFields)
  $ColCount = $SSQLFields.Count

  With GridView1
    .Columns[0].Width = CStr(15 * modBasic.$AppWidthRatio) & "px"
    .Columns[1].Width = CStr(100 * modBasic.$AppWidthRatio) & "px"
    .Columns[2].Width = CStr(175 * modBasic.$AppWidthRatio) & "px"
    .Columns[3].Width = CStr(100 * modBasic.$AppWidthRatio) & "px"
    .Columns[4].Hidden = True
    .Columns[5].Width = CStr(175 * modBasic.$AppWidthRatio) & "px"
    .Columns[6].Width = CStr(175 * modBasic.$AppWidthRatio) & "px"
    .Columns[7].Width = CStr(325 * modBasic.$AppWidthRatio) & "px"
    .Columns[8].Width = CStr(300 * modBasic.$AppWidthRatio) & "px"
    .Columns[9].Width = CStr(200 * modBasic.$AppWidthRatio) & "px"
    .Columns[10].Width = CStr(200 * modBasic.$AppWidthRatio) & "px"
    .Columns[11].Width = CStr(200 * modBasic.$AppWidthRatio) & "px"

    .Columns[1].Text = "Bed"
    .Columns[2].Text = "Patient"
    .Columns[3].Text = "EncID"
    .Columns[5].Text = "First Insertion"
    .Columns[6].Text = "Device Hours"
    .Columns[7].Text = "Examinations"
    .Columns[8].Text = "No Growth"
    .Columns[9].Text = "Pathogens"
    .Columns[10].Text = "Outcome"
    .Columns[11].Text = "Summary"

    If $newColumn.Count Then
      For i = 0 To $newColumn.Count - 1
        .Columns[$ColCount + i].Text = $newColumn[i]
        .Columns[$ColCount + i].Width = CStr(150 * modBasic.$AppWidthRatio) & "px"
      Next
    Endif
  End With

  xvismode = modSettings.ShowSettingFromFIle("ReportColumnVisibility/VisibilityMode")
  If xvismode = "Yes" Then
    noCols = modCHTMLReport.HideColumnExport()
    For Column = 0 To GridView1.Columns.Count - 1
      If noCols.Exist(Column) = True Then
        GridView1.Columns[Column].Hidden = True
      Endif
    Next
  Endif

End

Public Sub GridView1_Data(Row As Integer, Column As Integer, Data As WebTableData)

  $rData.MoveTo(Row)
  modGridView.GridViewDecoration(Data, Row)
  Select Column
    Case 0
      Data.Text = ""
      Data.Background = GetPatientHAIColor($rData[$aMyFields[Column]])
    Case 2, 5, 6, 7, 8, 9, 10, 11
      Data.Html = GetGridViewValue(Column, $rData[$aMyFields[Column]])
    Case Else
      If Column > $SSQLFields.Count - 1 Then
        Data.Html = modString.TextToHTML(GetGridViewValue(Column, $rData[$aMyFields[Column]]))
      Else
        Data.Text = GetGridViewValue(Column, $rData[$aMyFields[Column]])
      Endif
  End Select

End

Private Function GetPatientHAIColor(encid As String) As Integer

  Dim xcolor As Integer
  Dim xexam As String[]
  Dim xpatho As String[]
  Dim xnoGrow As String[]

  If modHIReport.GetHAIAllDevicesTotalHour(encid) >= 48 Then
    xexam = modHAI.GetInfectionValues(encid, modHIReport.$DepartmentName)
    If xexam And If xexam.Count Then
      xpatho = modHAI.GetCulturePathogenList(encid)
      If xpatho And If xpatho.Count Then
        xcolor = Color.DarkRed
      Else
        xnoGrow = modHAI.GetCultureNoGrowthList(encid)
        If xnoGrow And If xnoGrow.Count Then
          xcolor = Color.Orange
        Else
          xcolor = Color.SoftBlue
        Endif
      Endif

    Else
      xcolor = Color.White
    Endif
  Else
    xcolor = Color.White
  Endif

  Return xcolor

End

Public Sub GridView1_Select()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    SHowPatIndicators($rData["fldencounterval"])
  Endif

End

''---------------- Reports ------------------
Public Sub btnexpo_Click()

  Dim xHeader As String[]
  Dim xhide As Integer[]
  Dim Column As Integer
  Dim xCollRow As Collection
  Dim xColum As Integer

  Dim $hGridExportTable As CExportResult
  Dim xparam1 As String
  Dim xparam2 As String
  Dim encColumn As Integer

  Dim xFldList As String[]

  xHeader = New String[]
  xhide = New Integer[]
  For Column = 0 To GridView1.Columns.Count - 1
    xHeader.Add(GridView1.Columns[Column].Text)
    If GridView1.Columns[Column].Hidden = True Then
      xhide.Add(Column)
    Endif
  Next
  xparam1 = cmbdept.Text
  xparam2 = modReportVar.GetDateTimeReport(Now(), gb.GeneralDate)
  encColumn = 1
  $hGridExportTable = New CExportResult(Me.Tag, xHeader, xhide, xparam1, xparam2, encColumn)

  xFldList = GetSQLColumns()

  For Each $rData
    xCollRow = New Collection
    For xColum = 0 To xFldList.Count - 1
      xCollRow.Add(GetGridViewValue(xColum, $rData[xFldList[xColum]]), CStr(xColum))
    Next
    $hGridExportTable.Add($rData.Index, xCollRow)
  Next

  modControlSub.DisplayReportExport($hGridExportTable.HTMLPath())

End

Private Function GetHAIClassification(encid As String) As String

  Dim xstatus As String
  Dim xexam As String[]
  Dim xpatho As String[]
  Dim xnoGrow As String[]

  If modHIReport.GetHAIAllDevicesTotalHour(encid) >= 48 Then
    xexam = modHAI.GetInfectionValues(encid, modHIReport.$DepartmentName)
    If xexam And If xexam.Count Then
      xpatho = modHAI.GetCulturePathogenList(encid)
      If xpatho And If xpatho.Count Then
        xstatus = "Confirmed"
      Else
        xnoGrow = modHAI.GetCultureNoGrowthList(encid)
        If xnoGrow And If xnoGrow.Count Then
          xstatus = "Probable"
        Else
          xstatus = "Suspected"
        Endif
      Endif
    Else
      xstatus = ""
    Endif
  Else
    xstatus = ""
  Endif

  Return xstatus

End

Public Sub btnsummary_Click()

  Dim xPath As String
  Dim xclass As String

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xclass = GetHAIClassification($rData["fldencounterval"])
    xPath = modHIReport.GetCaseReportForm($rData["fldencounterval"], xclass)
    modControlSub.OpenHTMLPreview("", xPath, "ReportSize")
  Endif

End

Public Sub mnuColumns_Click()

  If Message.Question(modGridView.GetColumnsListString(GridView1), ("OK"), ("Setting")) = 2 Then
    fmChartSetting.ShowModal
  Endif

End

Public Sub mnuaddcolumn_Click()

  Dim hForm As FmAddNewColumn

  hForm = New FmAddNewColumn(Me.Tag)
  hForm.ShowModal

End

Private Sub GetComboItemList()

  If $UserRestrict.Exist("Provisional Diagnosis") = False Then
    btnmobilediagno.Visible = True
    btnobsdiagno.Visible = True
  Endif
  If $UserRestrict.Exist("Essential Examinations") = False Then
    btnmobilevital.Visible = True
    btntriage.Visible = True
  Endif

  If $UserRestrict.Exist("Devices Used") = False Then
    btnmobevent.Visible = True
  Endif
  If $UserRestrict.Exist("Clinical Findings") = False Then
    btnmobexam.Visible = True
  Endif
  If $UserRestrict.Exist("Clinical Notes") = False Then
    btnmobnote.Visible = True
  Endif

  If $UserRestrict.Exist("Laboratory Request") = False Then
    btnlabs.Visible = True
  Endif
  If $UserRestrict.Exist("Radiology Request") = False Then
    btnradio.Visible = True
  Endif
  If $UserRestrict.Exist("Pharmacy Request") = False Then
    btnpharm.Visible = True
  Endif

End

''============================== Mobile apps ===========================
''vitals
Public Sub btnmobilevital_Click()

  Dim hForm As FmVItalMobile

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmVItalMobile($rData["fldencounterval"])
    hForm.ShowModal
  Endif

End

''bed
Public Sub btnmobilebed_Click()

  Dim xbed As String
  Dim abed As String

  abed = ""
  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    If $rData["fldencounterval"] Then
      xbed = GetBedNumber($rData["fldencounterval"])
      If abed <> xbed Then
        FillBedGrid()
      Endif
    Endif
  Endif

End

''doagnosis
Public Sub btnmobilediagno_Click()

  Dim hForm As FmAddDiagno

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmAddDiagno("Disease", $rData["fldencounterval"], "", modBasic.$DefaultDiagnoGroup)
    hForm.ShowModal
    FillBedGrid()
  Endif

End

''ip form
Public Sub btnIPform_Click()

  Dim hForm As FmPatientMain

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    Me.Parent.DeleteChildren()
    modGeneralMain.$FormOpenList.Add(["fmClinBedList"])
    hForm = New FmPatientMain($rData["fldencounterval"], fmOfficer.Workspace1)
  Endif

End

''triage
Public Sub btntriage_Click()

  Dim xcol As String
  Dim xback As Integer

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xback = modPatient.GetPatientColor($rData["fldencounterval"])
    xcol = InputColor("Triage", CStr(xback))
    If xcol Then
      modPatient.SetPatientColor($rData["fldencounterval"], xcol)
      FillBedGrid()
    Endif
  Endif

End

''labs
Public Sub btnlabs_Click()

  Dim hForm10 As FmTestList

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    If modNonMedical.AllowEntryWithDeposit($rData["fldencounterval"], "Test") = True Then
      hForm10 = New FmTestList($rData["fldencounterval"], modNonMedical.GetAutoIPBillingPack("Test", $rData["fldencounterval"]))
      hForm10.ShowModal
      SHowPatIndicators($rData["fldencounterval"])
    Endif
  Endif

End

''radio
Public Sub btnradio_Click()

  Dim hForm11 As FmRadioList

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    If modNonMedical.AllowEntryWithDeposit($rData["fldencounterval"], "Radio") = True Then
      hForm11 = New FmRadioList($rData["fldencounterval"], modNonMedical.GetAutoIPBillingPack("Radio", $rData["fldencounterval"]))
      hForm11.ShowModal
      SHowPatIndicators($rData["fldencounterval"])
    Endif
  Endif

End

''pharm
Public Sub btnpharm_Click()

  Dim hForm12 As FmMedOrder

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    If modNonMedical.AllowEntryWithDeposit($rData["fldencounterval"], "Pharmacy") = True Then
      If modBasic.$MedRequestForm = "Separate" Then
      Else
        hForm12 = New FmMedOrder($rData["fldencounterval"], "Admitted", modNonMedical.GetAutoIPBillingPack("Pharmacy", $rData["fldencounterval"]))
        hForm12.ShowModal
      Endif
      SHowPatIndicators($rData["fldencounterval"])
    Endif
  Endif

End

Public Sub mnucomplete_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetSelectedPatientValues($rData["fldencounterval"], MMain.$defUnit)
  Endif

End

''exams
Public Sub btnmobexam_Click()

  Dim hForm1 As FmEnterDepartExam
  Dim xItem As String

  If modBasic.$ClinIPDExamination Then
    xItem = modBasic.$ClinIPDExamination
  Else
    xItem = "Hospital Acquired Infection"
    modBasic.$ClinFlagAbnormExam = "Disable"
  Endif
  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm1 = New FmEnterDepartExam(xItem, $rData["fldencounterval"], modBasic.$ClinIPDExamination, "Physician Examinations")
    hForm1.ShowModal
    FillBedGrid()
  Endif

End

''notes
Public Sub btnmobnote_Click()

  Dim hForm As FmNoteMobile

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmNoteMobile($rData["fldencounterval"])
    hForm.ShowModal
  Endif

End

''device
Public Sub btnmobevent_Click()

  Dim hForm9 As FmDeviceUse

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm9 = New FmDeviceUse($rData["fldencounterval"], "Devices")
    hForm9.ShowModal
    FillBedGrid()
  Endif

End

''------------------------------------ custom menus -----------------------------------
Private Sub FillCustomMenu()

  Dim xform1 As String
  Dim xform2 As String
  Dim xform3 As String
  Dim xform4 As String
  Dim xform5 As String
  Dim xform6 As String
  Dim xform7 As String
  Dim xform8 As String
  Dim xform9 As String
  Dim xform10 As String

  xform1 = modSettings.ShowSettingFromFIle("CustomReport1/Name")
  xform2 = modSettings.ShowSettingFromFIle("CustomReport2/Name")
  xform3 = modSettings.ShowSettingFromFIle("CustomReport3/Name")
  xform4 = modSettings.ShowSettingFromFIle("CustomReport4/Name")
  xform5 = modSettings.ShowSettingFromFIle("CustomReport5/Name")
  xform6 = modSettings.ShowSettingFromFIle("CustomReport6/Name")
  xform7 = modSettings.ShowSettingFromFIle("CustomReport7/Name")
  xform8 = modSettings.ShowSettingFromFIle("CustomReport8/Name")
  xform9 = modSettings.ShowSettingFromFIle("CustomReport9/Name")
  xform10 = modSettings.ShowSettingFromFIle("CustomReport10/Name")

  If xform1 Then
    mnucust1.Title = xform1
    mnucust1.Tag = "CustomReport1"
    mnucust1.Visible = True
  Endif

  If xform2 Then
    mnucust2.Title = xform2
    mnucust2.Tag = "CustomReport2"
    mnucust2.Visible = True
  Endif

  If xform3 Then
    mnucust3.Title = xform3
    mnucust3.Tag = "CustomReport3"
    mnucust3.Visible = True
  Endif

  If xform4 Then
    mnucust4.Title = xform4
    mnucust4.Tag = "CustomReport4"
    mnucust4.Visible = True
  Endif

  If xform5 Then
    mnucust5.Title = xform5
    mnucust5.Tag = "CustomReport5"
    mnucust5.Visible = True
  Endif

  If xform6 Then
    mnucust6.Title = xform6
    mnucust6.Tag = "CustomReport6"
    mnucust6.Visible = True
  Endif

  If xform7 Then
    mnucust7.Title = xform7
    mnucust7.Tag = "CustomReport7"
    mnucust7.Visible = True
  Endif

  If xform8 Then
    mnucust8.Text = xform8
    mnucust8.Tag = "CustomReport8"
    mnucust8.Visible = True
  Endif

  If xform9 Then
    mnucust9.Title = xform9
    mnucust9.Tag = "CustomReport9"
    mnucust9.Visible = True
  Endif

  If xform10 Then
    mnucust10.Title = xform10
    mnucust10.Tag = "CustomReport10"
    mnucust10.Visible = True
  Endif

End

''''------------------------------- custom report menu ---------------------------------------------------
Public Sub mnucust1_Click()

  Dim hCls As CReportCustom

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hCls = New CReportCustom($rData["fldencounterval"], mnucust1.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Public Sub mnucust2_Click()

  Dim hCls As CReportCustom

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hCls = New CReportCustom($rData["fldencounterval"], mnucust2.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Public Sub mnucust3_Click()

  Dim hCls As CReportCustom

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hCls = New CReportCustom($rData["fldencounterval"], mnucust3.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Public Sub mnucust4_Click()

  Dim hCls As CReportCustom

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hCls = New CReportCustom($rData["fldencounterval"], mnucust4.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Public Sub mnucust5_Click()

  Dim hCls As CReportCustom

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hCls = New CReportCustom($rData["fldencounterval"], mnucust5.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Public Sub mnucust6_Click()

  Dim hCls As CReportCustom

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hCls = New CReportCustom($rData["fldencounterval"], mnucust6.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Public Sub mnucust7_Click()

  Dim hCls As CReportCustom

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hCls = New CReportCustom($rData["fldencounterval"], mnucust7.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Public Sub mnucust8_Click()

  Dim hCls As CReportCustom

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hCls = New CReportCustom($rData["fldencounterval"], mnucust8.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Public Sub mnucust9_Click()

  Dim hCls As CReportCustom

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hCls = New CReportCustom($rData["fldencounterval"], mnucust9.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Public Sub mnucust10_Click()

  Dim hCls As CReportCustom

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hCls = New CReportCustom($rData["fldencounterval"], mnucust10.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Private Sub FillCustomFormMenu()

  Dim xform1 As String
  Dim xform2 As String
  Dim xform3 As String
  Dim xform4 As String
  Dim xform5 As String
  Dim xform6 As String
  Dim xform7 As String
  Dim xform8 As String
  Dim xform9 As String
  Dim xform10 As String

  xform1 = modSettings.ShowSettingForReport("CustomForm1/Form_Name")
  xform2 = modSettings.ShowSettingForReport("CustomForm2/Form_Name")
  xform3 = modSettings.ShowSettingForReport("CustomForm3/Form_Name")
  xform4 = modSettings.ShowSettingForReport("CustomForm4/Form_Name")
  xform5 = modSettings.ShowSettingForReport("CustomForm5/Form_Name")
  xform6 = modSettings.ShowSettingForReport("CustomForm6/Form_Name")
  xform7 = modSettings.ShowSettingForReport("CustomForm7/Form_Name")
  xform8 = modSettings.ShowSettingForReport("CustomForm8/Form_Name")
  xform9 = modSettings.ShowSettingForReport("CustomForm9/Form_Name")
  xform10 = modSettings.ShowSettingForReport("CustomForm10/Form_Name")

  If xform1 Then
    mnucustform1.Title = xform1
    mnucustform1.Tag = "CustomForm1"
    mnucustform1.Visible = True
  Endif

  If xform2 Then
    mnucustform2.Title = xform2
    mnucustform2.Tag = "CustomForm2"
    mnucustform2.Visible = True
  Endif

  If xform3 Then
    mnucustform3.Title = xform3
    mnucustform3.Tag = "CustomForm3"
    mnucustform3.Visible = True
  Endif

  If xform4 Then
    mnucustform4.Title = xform4
    mnucustform4.Tag = "CustomForm4"
    mnucustform4.Visible = True
  Endif

  If xform5 Then
    mnucustform5.Title = xform5
    mnucustform5.Tag = "CustomForm5"
    mnucustform5.Visible = True
  Endif

  If xform6 Then
    mnucustform6.Title = xform6
    mnucustform6.Tag = "CustomForm6"
    mnucustform6.Visible = True
  Endif

  If xform7 Then
    mnucustform7.Title = xform7
    mnucustform7.Tag = "CustomForm7"
    mnucustform7.Visible = True
  Endif

  If xform8 Then
    mnucustform8.Title = xform8
    mnucustform8.Tag = "CustomForm8"
    mnucustform8.Visible = True
  Endif

  If xform9 Then
    mnucustform9.Title = xform9
    mnucustform9.Tag = "CustomForm9"
    mnucustform9.Visible = True
  Endif

  If xform10 Then
    mnucustform10.Title = xform10
    mnucustform10.Tag = "CustomForm10"
    mnucustform10.Visible = True
  Endif

End

Public Sub mnuessenexam_Click()

  Dim xx As String[]
  Dim yy As String[]
  Dim hForm As FmMultiChart

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xx = modClinic.GetFullVitalList($rData["fldencounterval"])
    yy = New String[]
    hForm = New FmMultiChart($rData["fldencounterval"], xx, yy, LabUnitForm())
    hForm.ShowModal
  Endif

End

Public Sub mnucustform1_Click()

  Dim xx As String[]
  Dim yy As String[]
  Dim hForm As FmMultiChart

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xx = Split(modSettings.ShowSettingForReport(mnucustform1.Tag & "/" & "Form_Exam"), ";")
    yy = Split(modSettings.ShowSettingForReport(mnucustform1.Tag & "/" & "Form_Test"), ";")
    hForm = New FmMultiChart($rData["fldencounterval"], xx, yy, LabUnitForm())
    hForm.ShowModal
  Endif

End

Public Sub mnucustform2_Click()

  Dim xx As String[]
  Dim yy As String[]
  Dim hForm As FmMultiChart

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xx = Split(modSettings.ShowSettingForReport(mnucustform2.Tag & "/" & "Form_Exam"), ";")
    yy = Split(modSettings.ShowSettingForReport(mnucustform2.Tag & "/" & "Form_Test"), ";")
    hForm = New FmMultiChart($rData["fldencounterval"], xx, yy, LabUnitForm())
    hForm.ShowModal
  Endif

End

Public Sub mnucustform3_Click()

  Dim xx As String[]
  Dim yy As String[]
  Dim hForm As FmMultiChart

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xx = Split(modSettings.ShowSettingForReport(mnucustform3.Tag & "/" & "Form_Exam"), ";")
    yy = Split(modSettings.ShowSettingForReport(mnucustform3.Tag & "/" & "Form_Test"), ";")
    hForm = New FmMultiChart($rData["fldencounterval"], xx, yy, LabUnitForm())
    hForm.ShowModal
  Endif

End

Public Sub mnucustform4_Click()

  Dim xx As String[]
  Dim yy As String[]
  Dim hForm As FmMultiChart

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xx = Split(modSettings.ShowSettingForReport(mnucustform4.Tag & "/" & "Form_Exam"), ";")
    yy = Split(modSettings.ShowSettingForReport(mnucustform4.Tag & "/" & "Form_Test"), ";")
    hForm = New FmMultiChart($rData["fldencounterval"], xx, yy, LabUnitForm())
    hForm.ShowModal
  Endif

End

Public Sub mnucustform5_Click()

  Dim xx As String[]
  Dim yy As String[]
  Dim hForm As FmMultiChart

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xx = Split(modSettings.ShowSettingForReport(mnucustform5.Tag & "/" & "Form_Exam"), ";")
    yy = Split(modSettings.ShowSettingForReport(mnucustform5.Tag & "/" & "Form_Test"), ";")
    hForm = New FmMultiChart($rData["fldencounterval"], xx, yy, LabUnitForm())
    hForm.ShowModal
  Endif

End

Public Sub mnucustform6_Click()

  Dim xx As String[]
  Dim yy As String[]
  Dim hForm As FmMultiChart

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xx = Split(modSettings.ShowSettingForReport(mnucustform6.Tag & "/" & "Form_Exam"), ";")
    yy = Split(modSettings.ShowSettingForReport(mnucustform6.Tag & "/" & "Form_Test"), ";")
    hForm = New FmMultiChart($rData["fldencounterval"], xx, yy, LabUnitForm())
    hForm.ShowModal
  Endif

End

Public Sub mnucustform7_Click()

  Dim xx As String[]
  Dim yy As String[]
  Dim hForm As FmMultiChart

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xx = Split(modSettings.ShowSettingForReport(mnucustform7.Tag & "/" & "Form_Exam"), ";")
    yy = Split(modSettings.ShowSettingForReport(mnucustform7.Tag & "/" & "Form_Test"), ";")
    hForm = New FmMultiChart($rData["fldencounterval"], xx, yy, LabUnitForm())
    hForm.ShowModal
  Endif

End

Public Sub mnucustform8_Click()

  Dim xx As String[]
  Dim yy As String[]
  Dim hForm As FmMultiChart

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xx = Split(modSettings.ShowSettingForReport(mnucustform8.Tag & "/" & "Form_Exam"), ";")
    yy = Split(modSettings.ShowSettingForReport(mnucustform8.Tag & "/" & "Form_Test"), ";")
    hForm = New FmMultiChart($rData["fldencounterval"], xx, yy, LabUnitForm())
    hForm.ShowModal
  Endif

End

Public Sub mnucustform9_Click()

  Dim xx As String[]
  Dim yy As String[]
  Dim hForm As FmMultiChart

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xx = Split(modSettings.ShowSettingForReport(mnucustform9.Tag & "/" & "Form_Exam"), ";")
    yy = Split(modSettings.ShowSettingForReport(mnucustform9.Tag & "/" & "Form_Test"), ";")
    hForm = New FmMultiChart($rData["fldencounterval"], xx, yy, LabUnitForm())
    hForm.ShowModal
  Endif

End

Public Sub mnucustform10_Click()

  Dim xx As String[]
  Dim yy As String[]
  Dim hForm As FmMultiChart

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xx = Split(modSettings.ShowSettingForReport(mnucustform10.Tag & "/" & "Form_Exam"), ";")
    yy = Split(modSettings.ShowSettingForReport(mnucustform10.Tag & "/" & "Form_Test"), ";")
    hForm = New FmMultiChart($rData["fldencounterval"], xx, yy, LabUnitForm())
    hForm.ShowModal
  Endif

End

''========================= Indicators ================
Private Function GetLabTestPending(encid As String) As Boolean

  Dim sql As String
  Dim res As Result
  Dim xval As Boolean

  sql = "select fldid from tblpatbilling where fldencounterval=&1 and flditemtype=&2 and fldsave=&3 and (fldstatus=&4 or fldstatus=&5) and fldsample=&6"
  res = modDatabase.$myConn.Exec(sql, encid, "Diagnostic Tests", True, "Done", "Cleared", "Waiting")
  xval = res.Available

  Return xval

End

Private Function GetRadioTestPending(encid As String) As Boolean

  Dim sql As String
  Dim res As Result
  Dim xval As Boolean

  sql = "select fldid from tblpatbilling where fldencounterval=&1 and flditemtype=&2 and fldsave=&3 and (fldstatus=&4 or fldstatus=&5) and fldsample=&6"
  res = modDatabase.$myConn.Exec(sql, encid, "Radio Diagnostics", True, "Done", "Cleared", "Waiting")
  xval = res.Available

  Return xval

End

Private Function GetPharmacyPending(encid As String) As Boolean

  Dim sql As String
  Dim res As Result
  Dim xval As Boolean

  sql = "select fldid from tblpatdosing where fldencounterval=&1 and fldsave_order=&2 and fldstatus=&3 and fldorder=&4 and fldcurval=&5"                                                   ''
  res = modDatabase.$myConn.Exec(sql, encid, False, "Admitted", "Request", "Continue")
  xval = res.Available

  Return xval

End

Private Function GetDevicePending(encid As String) As Boolean

  Dim res As Result
  Dim xval As Boolean

  res = modDatabase.$myConn.Exec("select fldid from tblpatevents where fldencounterval=&1 and fldtype=&2 and fldfirstsave=&3 and fldsecondsave=&4", encid, "Devices", True, False)
  xval = res.Available

  Return xval

End

Private Sub SHowPatIndicators(encid As String)

  Dim xlab As Boolean
  Dim xradio As Boolean
  Dim xpharm As Boolean
  Dim xevent As Boolean

  xlab = GetLabTestPending(encid)
  If xlab = True Then
    btnlabs.Foreground = Color.Red
  Else
    btnlabs.Foreground = Color.Default
  Endif

  xradio = GetRadioTestPending(encid)
  If xradio = True Then
    btnradio.Foreground = Color.Red
  Else
    btnradio.Foreground = Color.Default
  Endif

  xpharm = GetPharmacyPending(encid)
  If xpharm = True Then
    btnpharm.Foreground = Color.Red
  Else
    btnpharm.Foreground = Color.Default
  Endif

  xevent = GetDevicePending(encid)
  If xevent = True Then
    btnmobevent.Foreground = Color.Red
  Else
    btnmobevent.Foreground = Color.Default
  Endif

End

Public Sub mnulabview_Click()

  Dim xPath As String

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xPath = modCHTMLPatient.ShowPatientLaboratoryReport($rData["fldencounterval"], LabUnitForm())
    modControlSub.OpenHTMLPreview($rData["fldencounterval"], xPath, "ReportSize")
  Endif

End

Public Sub mnuexamview_Click()

  Dim xPath As String

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xPath = modCHTMLPatient.ShowPatientExaminationgReport($rData["fldencounterval"])
    modControlSub.OpenHTMLPreview($rData["fldencounterval"], xPath, "ReportSize")
  Endif

End

Public Sub mnuradioview_Click()

  Dim xPath As String

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xPath = modCHTMLPatient.ShowPatRadioReportbyEncID($rData["fldencounterval"])
    modControlSub.OpenHTMLPreview($rData["fldencounterval"], xPath, "ReportSize")
  Endif

End

Public Sub mnumedview_Click()

  Dim xPath As String

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xPath = modCHTMLPatient.ShowNursingDosing($rData["fldencounterval"])
    modControlSub.OpenHTMLPreview($rData["fldencounterval"], xPath, "ReportSize")
  Endif

End

Public Sub mnuhistoreport_Click()

  Dim xPath As String

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xPath = modCHTMLPatient.ShowPatientHistoryReport($rData["fldencounterval"])
    modControlSub.OpenHTMLPreview($rData["fldencounterval"], xPath, "ReportSize")
  Endif

End

Public Sub mnunoteview_Click()

  Dim xPath As String

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xPath = modCHTMLPatient.ShowPatientNoteReport($rData["fldencounterval"], "Inpatient Notes")
    modControlSub.OpenHTMLPreview($rData["fldencounterval"], xPath, "ReportSize")
  Endif

End

Public Sub mnuplanview_Click()

  Dim xPath As String

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xPath = modCHTMLPatient.ShowPatientPlanningReport($rData["fldencounterval"], "Clinician Plan")
    modControlSub.OpenHTMLPreview($rData["fldencounterval"], xPath, "ReportSize")
  Endif

End

Public Sub mnuprogresview_Click()

  Dim xPath As String

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xPath = modCHTMLPatient.ShowPatientPlanningReport($rData["fldencounterval"], "IP Monitoring")
    modControlSub.OpenHTMLPreview($rData["fldencounterval"], xPath, "ReportSize")
  Endif

End

Public Sub mnuexpense_Click()

  Dim xPath As String

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xPath = modCHTMLInvoice.ShowTotalExpensebyPatient(modDatabase.$syConn, $rData["fldencounterval"], "Complete")
    modControlSub.OpenHTMLPreview($rData["fldencounterval"], xPath, "ReportSize")
  Endif

End

''===================== Structured exams==========================
Private Sub FillExamMenu()

  If $structExamList.Count > 0 Then
    mnurec1.Text = $structExamList[0]
    mnurec1.Visible = True
  Endif

  If $structExamList.Count > 1 Then
    mnurec2.Text = $structExamList[1]
    mnurec2.Visible = True
  Endif

  If $structExamList.Count > 2 Then
    mnurec3.Text = $structExamList[2]
    mnurec3.Visible = True
  Endif

  If $structExamList.Count > 3 Then
    mnurec4.Text = $structExamList[3]
    mnurec4.Visible = True
  Endif

  If $structExamList.Count > 4 Then
    mnurec5.Text = $structExamList[4]
    mnurec5.Visible = True
  Endif

  If $structExamList.Count > 5 Then
    mnurec6.Text = $structExamList[5]
    mnurec6.Visible = True
  Endif

  If $structExamList.Count > 6 Then
    mnurec7.Text = $structExamList[6]
    mnurec7.Visible = True
  Endif

  If $structExamList.Count > 7 Then
    mnurec8.Text = $structExamList[7]
    mnurec8.Visible = True
  Endif

  If $structExamList.Count > 8 Then
    mnurec9.Text = $structExamList[8]
    mnurec9.Visible = True
  Endif

  If $structExamList.Count > 9 Then
    mnurec10.Text = $structExamList[9]
    mnurec10.Visible = True
  Endif

End

Public Sub mnurec1_Click()

  Dim hForm As FmWardHistoryMin

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmWardHistoryMin(mnurec1.Text, $rData["fldencounterval"], "Physician Examinations")
    hForm.ShowModal
  Endif

End

Public Sub mnurec2_Click()

  Dim hForm As FmWardHistoryMin

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmWardHistoryMin(mnurec2.Text, $rData["fldencounterval"], "Physician Examinations")
    hForm.ShowModal
  Endif

End

Public Sub mnurec3_Click()

  Dim hForm As FmWardHistoryMin

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmWardHistoryMin(mnurec3.Text, $rData["fldencounterval"], "Physician Examinations")
    hForm.ShowModal
  Endif

End

Public Sub mnurec4_Click()

  Dim hForm As FmWardHistoryMin

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmWardHistoryMin(mnurec4.Text, $rData["fldencounterval"], "Physician Examinations")
    hForm.ShowModal
  Endif

End

Public Sub mnurec5_Click()

  Dim hForm As FmWardHistoryMin

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmWardHistoryMin(mnurec5.Text, $rData["fldencounterval"], "Physician Examinations")
    hForm.ShowModal
  Endif

End

Public Sub mnurec6_Click()

  Dim hForm As FmWardHistoryMin

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmWardHistoryMin(mnurec6.Text, $rData["fldencounterval"], "Physician Examinations")
    hForm.ShowModal
  Endif

End

Public Sub mnurec7_Click()

  Dim hForm As FmWardHistoryMin

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmWardHistoryMin(mnurec7.Text, $rData["fldencounterval"], "Physician Examinations")
    hForm.ShowModal
  Endif

End

Public Sub mnurec8_Click()

  Dim hForm As FmWardHistoryMin

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmWardHistoryMin(mnurec8.Text, $rData["fldencounterval"], "Physician Examinations")
    hForm.ShowModal
  Endif

End

Public Sub mnurec9_Click()

  Dim hForm As FmWardHistoryMin

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmWardHistoryMin(mnurec9.Text, $rData["fldencounterval"], "Physician Examinations")
    hForm.ShowModal
  Endif

End

Public Sub mnurec10_Click()

  Dim hForm As FmWardHistoryMin

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmWardHistoryMin(mnurec10.Text, $rData["fldencounterval"], "Physician Examinations")
    hForm.ShowModal
  Endif

End

''obs diagno
Public Sub btnobsdiagno_Click()

  Dim xsex As String
  Dim sName As String[]

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xsex = modPatient.GetPatientSex($rData["fldencounterval"], modDatabase.$myConn)
    If xsex = "Female" Then
      sName = DiagnoObstetrics($rData["fldencounterval"], True)
      FillBedGrid()
    Endif
  Endif

End

''---------------- services -------------
Public Sub mnugenviolence_Click()

  Dim hForm As FmGenViolence

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmGenViolence($rData["fldencounterval"])
    hForm.ShowModal
  Endif

End

Public Sub mnuvaccination_Click()

  Dim hForm As FmVaccine

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmVaccine($rData["fldencounterval"])
    hForm.ShowModal
  Endif

End

Public Sub mnuscanner_Click()

  Dim hForm As FmScanForm

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmScanForm($rData["fldencounterval"], "Scanned Images", "")
    hForm.ShowModal
  Endif

End

Public Sub mnucountuni_Click()

  Dim Column As Integer
  Dim xFieColm As String
  Dim res As Result
  Dim yval As Variant
  Dim xList As String[]

  Dim xVar As Variant[]
  Dim xFldList As String[]
  Dim xPath As String

  Column = ListIndex("Column Index", modGridView.GetGridViewColumns(GridView1))
  If Column + 1 > 0 Then
    xFldList = GetSQLColumns()
    xFieColm = xFldList[Column]
    res = ExecuteQuery([xFieColm])
    xList = New String[]
    If res.Available Then
      For Each res
        yval = GetGridViewValue(Column, res[xFieColm])
        If yval Then
          xList.Add(yval)
        Endif
      Next
    Endif
    If xList.Count Then
      xVar = modString.GetUnivariateSummary(xList)
      xPath = modCHTMLReport.CreateHTMLReportFromArray(["Variable", "Count"], xVar, GridView1.Columns[Column].Text, modReportVar.GetDateTimeReport(Now(), gb.GeneralDate))
    Endif

    modControlSub.OpenHTMLPreview("", xPath, "ReportSize")
  Endif

End

''----------- History ----------
Public Sub mnuexamlocal_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetPatHistoryLocalResult("Examination", $rData["fldencounterval"], LabUnitForm())
  Endif

End

Public Sub mnuexamrepo_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetRepoHistoryLocalResult("Examination", $rData["fldencounterval"], LabUnitForm())
  Endif

End

Public Sub mnulabhist_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetPatHistoryLocalResult("Laboratory", $rData["fldencounterval"], LabUnitForm())
  Endif

End

Public Sub mnulabviewrepo_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetRepoHistoryLocalResult("Laboratory", $rData["fldencounterval"], LabUnitForm())
  Endif

End

Public Sub mnuarchlab_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetArchiveReportResult("Diagnostic Tests", modPatient.GetPatientNoByEnc($rData["fldencounterval"]))
  Endif

End

Public Sub mnuarchlabrepo_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetRepoArchiveReportResult("Diagnostic Tests", modPatient.GetPatientNoByEnc($rData["fldencounterval"]))
  Endif

End

Public Sub mnuradiohist_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetPatHistoryLocalResult("Radiology", $rData["fldencounterval"], LabUnitForm())
  Endif

End

Public Sub mnuradioviewrepo_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetRepoHistoryLocalResult("Radiology", $rData["fldencounterval"], LabUnitForm())
  Endif

End

Public Sub mnuarchradio_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetArchiveReportResult("Radio Diagnostics", modPatient.GetPatientNoByEnc($rData["fldencounterval"]))
  Endif

End

Public Sub mnuarchradiorepo_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetRepoArchiveReportResult("Radio Diagnostics", modPatient.GetPatientNoByEnc($rData["fldencounterval"]))
  Endif

End

Public Sub mnumedhist_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetPatHistoryLocalResult("Medicines", $rData["fldencounterval"], LabUnitForm())
  Endif

End

Public Sub mnumedviewrepo_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetRepoHistoryLocalResult("Medicines", $rData["fldencounterval"], LabUnitForm())
  Endif

End

Public Sub mnugenhistory_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetSelectHistoryResult($rData["fldencounterval"], LabUnitForm())
  Endif

End

Public Sub mnugenhistrepo_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetRepoSelectHistoryResult($rData["fldencounterval"], LabUnitForm())
  Endif

End

Public Sub mnuarchgenerl_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetArchiveReportResult("General Reports", modPatient.GetPatientNoByEnc($rData["fldencounterval"]))
  Endif

End

Public Sub mnuarchgenerlrepo_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetRepoArchiveReportResult("General Reports", modPatient.GetPatientNoByEnc($rData["fldencounterval"]))
  Endif

End

Public Sub mnuscanimg_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetArchiveReportResult("Scanned Images", modPatient.GetPatientNoByEnc($rData["fldencounterval"]))
  Endif

End

Public Sub mnuscanimgrepo_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetRepoArchiveReportResult("Scanned Images", modPatient.GetPatientNoByEnc($rData["fldencounterval"]))
  Endif

End

Public Sub mnupastdocs_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetArchiveReportResult("Past Documents", modPatient.GetPatientNoByEnc($rData["fldencounterval"]))
  Endif

End

Public Sub mnupastdocsrepo_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modPatReports.GetRepoArchiveReportResult("Past Documents", modPatient.GetPatientNoByEnc($rData["fldencounterval"]))
  Endif

End

Public Sub mnupacshist_Click()

  Dim hForm As FmPacsShow

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmPacsShow($rData["fldencounterval"], "History")
    hForm.ShowModal
  Endif

End

Public Sub mnuexpocolumn_Click()

  Dim hForm As FmCustColumnSet

  hForm = New FmCustColumnSet(Me.Tag)
  hForm.ShowModal

End

''======================= HAI data ==========================

Public Sub mnudenominator_Menu()

  mnuappendix.Popup(mnudenominator)

End

Public Sub mnuappendix1_Click()

  fmAppendixOne.ShowModal

End

Public Sub mnuappendix2_Click()

  fmAppendixTwo.ShowModal

End

Public Sub mnuapiparam_Click()

  Dim hForm As FmAPISetting

  hForm = New FmAPISetting("FIND")
  hForm.ShowModal

End

Public Sub btnupload_Click()

  Dim xclass As String

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xclass = GetHAIClassification($rData["fldencounterval"])
    If xclass Then
      modCRFUpload.FindPatientEnroll($rData["fldencounterval"], xclass)
      Me.Exec("Toastify({text: 'Upload completed', duration: 3000}).showToast()")
    Endif
  Endif

End
