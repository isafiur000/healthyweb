' Gambas class file

Private $UserRestrict As String[]
Private asx As String
Private $rData As Result
Private $aMyFields As String[]

Private $sInput As String

Public Sub _new(sInput As String)

  $sInput = sInput

  If $sInput = "Location" Then
    txtlabel.Text = "BedNo"
    wbqrcodescan.Visible = True
    WebHBox1.Visible = True
    wbward.Visible = False
  Else If $sInput = "Encounter" Then
    txtlabel.Text = "EncID"
    WebHBox1.Visible = True
    wbqrcodescan.Visible = True
    wbward.Visible = False
  Else
    wbqrcodescan.Visible = False
    WebHBox1.Visible = False
    wbward.Visible = True
    FillBedGrid()
  Endif
  modBasic.$TabletModeEnable = "Yes"
  $UserRestrict = modBasic.$ClinicDisableCompo
  If modHelpVariable.$LogInCategory = "Clinician" Then
    GetComboItemList()
    WebContainer2.Visible = True
  Endif

End

Public Sub wbqrcodescan_Render()

  Print "<div id='my-qr-reader'></div>"

End

Public Sub WebTimer1_Timer()

  WebTimer1.Enabled = False
  Select $sInput
    Case "Location", "Encounter"
      WebForm.Current.Reload()
  End Select

End

Public Sub btncopy_Click()

  txtvalue.SetFocus
  asx = "$_(" & JS(txtvalue.Name & ":entry") & ").value = qrvalue;"
  asx = asx & " gw.update(" & JS(txtvalue.Name) & ", 'text', qrvalue);"
  Me.Exec(asx)

End

Public Sub btnshow_Click()

  BasicProfile()
  btncopy.Enabled = False

End

Public Sub btnclear_Click()

  btncopy.Enabled = True
  txtencid.Text = ""
  txtpatientname.Text = ""
  txtvalue.Text = ""

End

''---------------------------- Patient ---------------------------------------
Private Sub BasicProfile()

  If txtvalue.Text Then
    If $sInput = "Location" Then
      txtencid.Text = modGeneral.GetEncounterFromBed(Trim(txtvalue.Text))
    Else If $sInput = "Encounter" Then
      txtencid.Text = Trim(txtvalue.Text)
    Endif
  Endif

  If txtencid.Text Then
    txtpatientname.Text = modPatient.GetPatientNameByEnc(Trim(txtencid.Text))
  Endif

End

Private Sub GetComboItemList()

  If $UserRestrict.Exist("Essential Examinations") = False Then
    btnmobilevital.Visible = True
  Endif
  If $UserRestrict.Exist("Medicine Dosing") = False Then
    btndosing.Visible = True
  Endif
  If $UserRestrict.Exist("IV Infusion") = False Then
    btnmobivfl.Visible = True
  Endif
  If $UserRestrict.Exist("Equipments Used") = False Then
    btnmobequip.Visible = True
  Endif
  If $UserRestrict.Exist("General Images") = False Then
    btnmobileimage.Visible = True
  Endif
  If $UserRestrict.Exist("Devices Used") = False Then
    btnmobevent.Visible = True
  Endif
  If $UserRestrict.Exist("Clinical Notes") = False Then
    btnmobnote.Visible = True
  Endif

  If $UserRestrict.Exist("Laboratory Request") = False Then
    btnlabs.Visible = True
  Endif
  If $UserRestrict.Exist("Radiology Request") = False Then
    btnradio.Visible = True
  Endif
  If $UserRestrict.Exist("Pharmacy Request") = False Then
    btnpharm.Visible = True
  Endif
  If $UserRestrict.Exist("Provisional Diagnosis") = False Then
    btnmobileimage.Visible = True
  Endif

End

Public Sub btnmobevent_Click()

  Dim hForm9 As FmDeviceUse

  If txtpatientname.Text Then
    hForm9 = New FmDeviceUse(Trim(txtencid.Text), "Devices")
    hForm9.ShowModal
  Endif

End

Public Sub btnmobilevital_Click()

  Dim hForm As FmVItalMobile

  If txtpatientname.Text Then
    hForm = New FmVItalMobile(Trim(txtencid.Text))
    hForm.ShowModal
  Endif

End

Public Sub btndosing_Click()

  Dim hForm4 As FmDoseMobile

  If txtpatientname.Text Then
    hForm4 = New FmDoseMobile(Trim(txtencid.Text))
    hForm4.ShowModal
  Endif

End

Public Sub btnmobileimage_Click()

  Dim hForm4 As FmImageLoad

  If txtpatientname.Text Then
    hForm4 = New FmImageLoad("IMAGE", Trim(txtencid.Text))
    hForm4.ShowModal
  Endif

End

Public Sub btnmobnote_Click()

  Dim hForm As FmMobileForm

  If txtpatientname.Text Then
    hForm = New FmMobileForm(Trim(txtencid.Text), "Notes")
    hForm.ShowModal
  Endif

End

Public Sub btnlabs_Click()

  Dim hForm10 As FmTestList

  If txtpatientname.Text Then
    If modNonMedical.AllowEntryWithDeposit(Trim(txtencid.Text), "Test") = True Then
      hForm10 = New FmTestList(Trim(txtencid.Text), modNonMedical.GetAutoIPBillingPack("Test", Trim(txtencid.Text)))
      hForm10.ShowModal
    Endif
  Endif

End

Public Sub btnradio_Click()

  Dim hForm11 As FmRadioList

  If txtpatientname.Text Then
    If modNonMedical.AllowEntryWithDeposit(Trim(txtencid.Text), "Radio") = True Then
      hForm11 = New FmRadioList(Trim(txtencid.Text), modNonMedical.GetAutoIPBillingPack("Radio", Trim(txtencid.Text)))
      hForm11.ShowModal
    Endif
  Endif

End

Public Sub btnpharm_Click()

  Dim hForm As FmMobileForm

  If txtpatientname.Text Then
    If modNonMedical.AllowEntryWithDeposit(Trim(txtencid.Text), "Pharmacy") = True Then
      hForm = New FmMobileForm(Trim(txtencid.Text), "Ward Stock")
      hForm.ShowModal
    Endif
  Endif

End

Public Sub btnmobequip_Click()

  Dim hForm6 As FmEquipment

  If txtpatientname.Text Then
    If modNonMedical.AllowEntryWithDeposit(Trim(txtencid.Text), "Equipment") = True Then
      hForm6 = New FmEquipment(Trim(txtencid.Text), modNonMedical.GetAutoIPBillingPack("Equipment", Trim(txtencid.Text)))
      hForm6.ShowModal
    Endif
  Endif

End

Public Sub btnmobivfl_Click()

  Dim hForm18 As FmIVInfusion

  If txtpatientname.Text Then
    hForm18 = New FmIVInfusion(Trim(txtencid.Text))
    hForm18.ShowModal
  Endif

End

''===================== Gridview ==========================
Private Sub FillBedGrid()

  Dim xFldList As String[]
  Dim sql As String

  xFldList = ["fldencounterval", "fldbed", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval"]
  If modBasic.$ClinDepartFormat = "Service" Then
    sql = "select " & xFldList.Join(",") & " from tbldepartmentbed where tbldepartmentbed.fldencounterval like &1 and (tbldepartmentbed.fldservice=&2 or tbldepartmentbed.fldaddservice=&2) ORDER BY fldbed ASC"
  Else
    sql = "select " & xFldList.Join(",") & " from tbldepartmentbed where tbldepartmentbed.fldencounterval like &1 and tbldepartmentbed.flddept=&2 ORDER BY fldbed ASC"
  Endif
  $rData = modDatabase.$myConn.Exec(sql, "%", $sInput)
  $aMyFields = New String[]
  modGridView.ReadSmallData(GridView1, $rData, $aMyFields)

  With GridView1
    .Columns[0].Width = CStr(10 * modBasic.$AppWidthRatio) & "px"
    .Columns[1].Width = CStr(125 * modBasic.$AppWidthRatio) & "px"
    .Columns[2].Width = CStr(115 * modBasic.$AppWidthRatio) & "px"
    .Columns[3].Width = CStr(200 * modBasic.$AppWidthRatio) & "px"
    .Columns[4].Width = CStr(125 * modBasic.$AppWidthRatio) & "px"
    .Columns[5].Hidden = True
    .Columns[6].Width = CStr(200 * modBasic.$AppWidthRatio) & "px"

    .Columns[1].Text = "Bed"
    .Columns[2].Text = "EncID"
    .Columns[3].Text = "Name"
    .Columns[4].Text = "Age/Sex"
    .Columns[6].Text = "Diagnosis"
  End With

End

Private Function GetGridViewValue(Column As Integer, xVariable As Variant) As Variant

  Dim xxx As Variant

  If Column = 3 Then
    xxx = modPatient.GetPatientNameByEnc(xVariable, modDatabase.$syConn) & "<br>" & "<small>" & modPatient.ShowDiscountCategEnc(xVariable) & "</small>"
  Else If Column = 4 Then
    xxx = modPatient.GetPatientAgeString(xVariable, Now()) & modString.HTMLBlankSpace(1) & modPatient.GetPatientSex(xVariable, modDatabase.$syConn) & "<br>" & "<small>" & modReportVar.GetDateTimeReport(modPatient.GetAdmissionDate(xVariable), gb.GeneralDate) & "</small>"                           ''
  Else If Column = 6 Then
    xxx = modPatient.PatientDiagnoCurrentList(xVariable).Join(gb.NewLine)
  Else
    xxx = xVariable
  Endif

  Return xxx

End

Public Sub GridView1_Data(Row As Integer, Column As Integer, Data As WebTableData)

  $rData.MoveTo(Row)
  modGridView.GridViewDecoration(Data, Row)
  If Column = 0 Then
    Data.Background = modPatient.GetPatientColor($rData[$aMyFields[Column]])
  Else If Column = 3 Then
    Data.Html = GetGridViewValue(Column, $rData[$aMyFields[Column]])
  Else If Column = 4 Then
    Data.Html = GetGridViewValue(Column, $rData[$aMyFields[Column]])
  Else If Column = 6 Then
    Data.Text = GetGridViewValue(Column, $rData[$aMyFields[Column]])
  Else
    Data.Text = GetGridViewValue(Column, $rData[$aMyFields[Column]])
  Endif

End

Public Sub GridView1_Select()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    txtencid.Text = $rData["fldencounterval"]
    txtvalue.Text = $rData["fldbed"]
    If txtencid.Text Then
      txtpatientname.Text = modPatient.GetPatientNameByEnc(Trim(txtencid.Text))
    Endif
  Endif

End
