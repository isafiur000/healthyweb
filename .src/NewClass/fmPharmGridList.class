' Gambas class file

Private $sRoute As String
Private $sMode As String
Private $sValue As Variant

Private $GridDataList As String[]
Private $GridWorkList As String[]
Private $sColmn As Integer

Public Sub Run(sTitle As String, sRoute As String, sMode As String, dataList As String[]) As Variant
  
  Me.Title = sTitle
  $sRoute = sRoute
  $sMode = sMode
  $GridDataList = dataList
  modGeneralMain.GetOpenModalForm(Me)
  
  If modBasic.$BillExpiredEntry = "Enable" Then
    modSettings.ShowCheckBox(chknonexp, "DispensingList/Non-ExpiredOnly")
  Else
    chknonexp.Value = True
    chknonexp.Enabled = False
  Endif
  chkleftmain.Value = modBasic.$SearchBothSide
  
  Select $sRoute
    Case "vaccine"
      $sColmn = 7
    Case "suture", "msurg", "ortho", "extra"
      $sColmn = 6
    Case Else
      $sColmn = 7
  End Select
  
  If Not txtname.Text And If chknonexp.Value = False Then
    $GridWorkList = $GridDataList
    FillItemGrid()
  Else
    If $sColmn = 6 Then
      SortFiveSelectedRows()
    Else If $sColmn = 7 Then
      SortSixSelectedRows()
    Endif
  Endif
  
  If modBasic.$TabletModeEnable = "Yes" Then
  Else
    txtname.SetFocus
  Endif
  
  If Me.ShowModal() Then Return $sValue
  
End

Private Sub FillItemGrid()
  
  Dim i As Integer
  Dim j As Integer
  
  If $GridWorkList Then
    GridView1.Clear()
    GridView1.Columns.Count = $sColmn
    GridView1.Count = $GridWorkList.Count
    
    With GridView1
      If $sColmn = 6 Then
        .Columns[0].Expand = True
        i = 0
      Else If $sColmn = 7 Then
        If $sMode = "Generic" Then
          .Columns[0].Expand = True
          .Columns[1].Width = CStr(175 * modBasic.$AppWidthRatio) & "px"
        Else If $sMode = "Brand" Then
          .Columns[0].Width = CStr(250 * modBasic.$AppWidthRatio) & "px"
          .Columns[1].Expand = True
        Endif
        i = 1
      Endif
      .Columns[i + 1].Width = CStr(20 * modBasic.$AppWidthRatio) & "px"
      .Columns[i + 2].Width = CStr(100 * modBasic.$AppWidthRatio) & "px"
      If $sRoute = "vaccine" Then
        .Columns[i + 3].Hidden = True
        .Columns[i + 4].Hidden = True
      Else
        .Columns[i + 3].Width = CStr(75 * modBasic.$AppWidthRatio) & "px"
        .Columns[i + 4].Width = CStr(75 * modBasic.$AppWidthRatio) & "px"
      Endif
      .Columns[i + 5].Hidden = True
      
      .Columns[0].Text = "Particulars"
      If $sColmn = 6 Then
        j = 0
      Else If $sColmn = 7 Then
        .Columns[1].Text = "Brand/Generic"
        j = 1
      Endif
      .Columns[j + 2].Text = "Expiry"
      If $sRoute = "vaccine" Then
      Else
        .Columns[j + 3].Text = "Rate"
        .Columns[j + 4].Text = "Stock"
      Endif
    End With
    
  Endif
  
End

Public Sub GridView1_Data(Row As Integer, Column As Integer, Data As WebTableData)
  
  Dim asx As String[]
  
  asx = Split($GridWorkList[Row], "|")
  modGridView.GridViewDecoration(Data, Row)
  If Column = 1 Then
    If $sColmn = 6 Then
      Data.Html = modString.GetImageForHTMLGrid(modMisc.GetWebIconPath(asx[Column]), "100%", "100%")
      Data.Text = ""
    Else If $sColmn = 7 Then
      Data.Text = asx[Column]
    Endif
  Else If Column = 2 Then
    If $sColmn = 6 Then
      Data.Text.Text = asx[Column]
    Else If $sColmn = 7 Then
      Data.Html = modString.GetImageForHTMLGrid(modMisc.GetWebIconPath(asx[Column]), "100%", "100%")
      Data.Text = ""
    Endif
  Else
    Data.Text = asx[Column]
  Endif
  
End

Private Sub SortFiveSelectedRows()
  
  Dim xx As String
  Dim asx As String[]
  Dim xfinal As String[]
  
  xfinal = New String[]
  If $GridDataList Then
    For Each xx In $GridDataList
      asx = Split(xx, "|")
      
      If chkleftmain.Value Then
        If LCase(asx[0]) Like "*" & LCase(txtname.Text) & "*" Then
          If chknonexp.Value = True Then
            If asx[1] = "icons/true.svg" Then
            Else
              xfinal.Add(asx[0] & "|" & asx[1] & "|" & asx[2] & "|" & asx[3] & "|" & asx[4] & "|" & asx[5])
            Endif
          Else
            xfinal.Add(asx[0] & "|" & asx[1] & "|" & asx[2] & "|" & asx[3] & "|" & asx[4] & "|" & asx[5])
          Endif
        Endif
      Else
        If LCase(asx[0]) Like LCase(txtname.Text) & "*" Then
          If chknonexp.Value = True Then
            If asx[1] = "icons/true.svg" Then
            Else
              xfinal.Add(asx[0] & "|" & asx[1] & "|" & asx[2] & "|" & asx[3] & "|" & asx[4] & "|" & asx[5])
            Endif
          Else
            xfinal.Add(asx[0] & "|" & asx[1] & "|" & asx[2] & "|" & asx[3] & "|" & asx[4] & "|" & asx[5])
          Endif
        Endif
      Endif
      
    Next
  Endif
  $GridWorkList = xfinal
  FillItemGrid()
  
End

Private Sub SortSixSelectedRows()
  
  Dim xx As String
  Dim asx As String[]
  Dim xfinal As String[]
  
  xfinal = New String[]
  If $GridDataList Then
    For Each xx In $GridDataList
      asx = Split(xx, "|")
      
      If chkleftmain.Value Then
        If LCase(asx[0]) Like "*" & LCase(txtname.Text) & "*" Then
          If chknonexp.Value = True Then
            If asx[2] = "icons/true.svg" Then
            Else
              xfinal.Add(asx[0] & "|" & asx[1] & "|" & asx[2] & "|" & asx[3] & "|" & asx[4] & "|" & asx[5] & "|" & asx[6])
            Endif
          Else
            xfinal.Add(asx[0] & "|" & asx[1] & "|" & asx[2] & "|" & asx[3] & "|" & asx[4] & "|" & asx[5] & "|" & asx[6])
          Endif
        Endif
      Else
        If LCase(asx[0]) Like LCase(txtname.Text) & "*" Then
          If chknonexp.Value = True Then
            If asx[2] = "icons/true.svg" Then
            Else
              xfinal.Add(asx[0] & "|" & asx[1] & "|" & asx[2] & "|" & asx[3] & "|" & asx[4] & "|" & asx[5] & "|" & asx[6])
            Endif
          Else
            xfinal.Add(asx[0] & "|" & asx[1] & "|" & asx[2] & "|" & asx[3] & "|" & asx[4] & "|" & asx[5] & "|" & asx[6])
          Endif
        Endif
      Endif
      
    Next
  Endif
  $GridWorkList = xfinal
  FillItemGrid()
  
End

Public Sub btninsert_Click()
  
  Dim asx As String[]
  
  If GridView1.Selection.Count Then
    asx = Split($GridWorkList[GridView1.Selection[0]], "|")
    If $sColmn = 6 Then
      $sValue = asx[5]
    Else If $sColmn = 7 Then
      $sValue = asx[6]
    Endif
    Me.Close(True)
  Endif
  
End

Public Sub txtname_Change()
  
  If $sColmn = 6 Then
    SortFiveSelectedRows()
  Else If $sColmn = 7 Then
    SortSixSelectedRows()
  Endif
  
End

Public Sub chkleftmain_Click()
  
  modBasic.$SearchBothSide = chkleftmain.Value
  txtname.SetFocus
  
End

Public Sub Form_Deactivate()
  
  Me.Close()
  
End

Public Sub chknonexp_Click()
  
  modSettings.EnterCheckSetting(chknonexp, "DispensingList/Non-ExpiredOnly")
  If $sColmn = 6 Then
    SortFiveSelectedRows()
  Else If $sColmn = 7 Then
    SortSixSelectedRows()
  Endif
  
End

Public Sub btnclose_Click()
  
  Me.Close()
  
End

Public Sub txtname_KeyPress()
  
  If Key.Code = "Down" Then
    If GridView1.Count Then
      GridView1.Select(0)
    Endif
  Endif
  
End
