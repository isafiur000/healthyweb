' Gambas class file

Private $patID As String
Private $sDiseaseId As Integer
Private $sBillNo As String
Private $xOutput As String

Public Sub _new(sPatID As String, sDiseaseID As Integer, sBillNo As String)

  $patID = sPatID
  $sDiseaseId = sDiseaseID
  $sBillNo = sBillNo

  ExecuteAPI()

End

Private Sub GetCollectionData() As String[]

  Dim res As Result
  Dim aData As String[]
  Dim ximg As String
  Dim asx As String[]
  Dim xnepdate As String

  res = modDatabase.$myConn.Exec("select fldtime,fldchargedamt from tblpatbilldetail where fldbillno=&1", $sBillNo)
  If res.Available Then
    ximg = modBILLFormat.GetInvoiceCopyPDFPath($sBillNo, False, False)
    asx = Split(modDate.ConvertToLocaldate(res["fldtime"]), "/")
    xnepdate = asx[0] & "-" & asx[1] & "-" & asx[2]

    aData = New String[]
    aData.Add("--form 'patient_id=" & Quote($patID) & "'")
    aData.Add("--form 'patient_disease_id=" & Quote($sDiseaseId) & "'")
    aData.Add("--form 'issueddate=" & Quote(xnepdate) & "'")
    aData.Add("--form 'bill_no=" & Quote($sBillNo) & "'")
    aData.Add("--form 'bill_amount=" & res["fldchargedamt"] & "'")
    aData.Add("--form 'attachment=@" & Quote(ximg) & "'")
  Endif
  Return aData

End

Private Sub ExecuteAPI()

  Dim acmd As String
  Dim xurl As String
  Dim xauth As String
  Dim xcont As String
  Dim ycont As String

  Dim aData As String[]

  xurl = modBasic.$BipannaBillingtURL
  xauth = "Authorization: Bearer " & modBasic.$BipannaHospitalCode
  xcont = "Content-Type: application/json"
  ycont = "Accept: application/json"
  aData = GetCollectionData()

  acmd = "curl -H " & Quote(xauth) & " --location " & xurl & Space(1) & aData.Join(Space(1))
  modBasic.DebugAPIString(Replace("Execute " & acmd, xauth, "****"))
  Shell acmd To $xOutput
  modBasic.DebugAPIString("Response: " & $xOutput)

End

Public Function GetUploadAPI() As String

  Return $xOutput

End
