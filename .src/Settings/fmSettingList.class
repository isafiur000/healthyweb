' Gambas class file

Private $sType As String
Private $sItem As String
Private $sComp As String

Private $mainLst As String[]
Private $sList As String[]

Public Sub _new(sTitle As String, xType As String, xItem As String, xComp As String)

  Me.Title = sTitle
  $sType = xType
  $sItem = xItem
  $sComp = xComp

  ShowSettingParams()
  GetRemainingParam()

End

Private Sub GetRemainingParam()

  If $sType = "User List" Then
    $mainLst = modGeneral.GetActiveUserIDAll()
  Else If $sType = "Service List" Then
    $mainLst = modNonMedical.NonStockBillingItemArray("%", "%")
  Else If $sType = "Medicines List" Then
    $mainLst = modMedicine.GetPharmacyItemList("Medicines")
  Endif
  FillGridViewSelected()

End

''================= First Grid view ===============
Public Sub txtsearch_Change()

  FillGridViewSelected()

End

Private Sub FillGridViewSelected()

  Dim xval As String
  Dim xList As String[]

  xList = New String[]
  If $mainLst And If $mainLst.Count Then
    For Each xval In $mainLst
      If Len(xval) Then
        If lstsecond.List.Exist(xval) Then
        Else

          If Len(Trim(txtsearch.Text)) Then
            If chkleftmain.Value = True Then
              If LCase(xval) Like "*" & Trim(txtsearch.Text) & "*" Then
                xList.Add(xval)
              Endif
            Else
              If LCase(xval) Like Trim(txtsearch.Text) & "*" Then
                xList.Add(xval)
              Endif
            Endif
          Else
            xList.Add(xval)
          Endif

        Endif
      Endif
    Next
  Endif

  $sList = xList

  GridView1.Clear()
  GridView1.Count = $sList.Count
  GridView1.Columns.Count = 1

  With GridView1
    .Columns[0].Expand = True
  End With

End

Public Sub GridView1_Data(Row As Integer, Column As Integer, Data As WebTableData)

  modGridView.GridViewDecoration(Data, Row)
  Data.Text = $sList[Row]

End

Public Sub chkall_Click()

  If chkall.Value = True Then
    GridView1.SelectAll()
  Else
    GridView1.UnselectAll()
  Endif

End

Public Sub btnsave_Click()

  Dim res As Result
  Dim i As Integer
  Dim xval As String

  For i = 0 To GridView1.Count - 1
    If GridView1.IsSelected(i) = True Then
      xval = $sList[i]
      If lstsecond.List.Exist(xval) = False Then

        res = modDatabase.$myConn.Create("tbltabsettings")
        res["fldcomp"] = $sComp
        res["fldcategory"] = $sItem
        res["fldvalue"] = xval
        res["fldtime"] = Now()
        res["flduserid"] = modBasic.$lbluser
        res.Update
        GridView1.Unselect(i)

      Endif
    Endif
  Next

  ShowSettingParams()
  GetRemainingParam()

End

''================= Second list =================
Private Sub ShowSettingParams()

  Dim res As Result

  res = modDatabase.$myConn.Exec("select fldvalue as col from tbltabsettings where fldcategory=&1 and fldcomp=&2 ORDER BY fldvalue", $sItem, $sComp)
  modFillContainer.FillListBox(lstsecond, res, False)

End

Public Sub mnudelete_Click()

  If lstsecond.Text Then
    modDatabase.$myConn.Delete("tbltabsettings", "fldcategory=&1 and fldcomp=&2 and fldvalue=&3", $sItem, $sComp, lstsecond.Text)
    ShowSettingParams()
    GetRemainingParam()
  Endif

End

Public Sub btnclose_Click()

  Me.Close()

End
