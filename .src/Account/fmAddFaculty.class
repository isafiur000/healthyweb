' Gambas class file

Private $varList As String[]
Private $rData As Result
Private $aMyFields As String[]

Public Sub _new()

  $varList = modNonMedical.GetGroupNameAccount()
  FilVarList()

End

Public Sub btnOK_Click()

  Dim res As Result

  If txtvariable.Text Then
    res = modDatabase.$myConn.Create("tblmasterdept")
    res["fldmaster"] = Trim(txtcategory.Text)
    res["fldgroup"] = Trim(txtvariable.Text)
    res.Update()
    SHowSelectGrid()
    txtvariable.Text = ""
    Me.Exec("Toastify({text: 'Variable added', duration: 3000}).showToast()")
    txtcategory.SetFocus
  Endif

End

Public Sub btnrefresh_Click()

  SHowSelectGrid()

End

Private Sub SHowSelectGrid()

  Dim sql As String

  If txtcategory.Text Then
    sql = "select fldmaster,fldgroup from tblmasterdept where fldmaster=&1"
    $rData = modDatabase.$myConn.Exec(sql, txtcategory.Text)
    $aMyFields = New String[]
    modGridView.ReadSmallData(GridView1, $rData, $aMyFields)
    GetColumnItemList()

    With GridView1
      .Columns[0].Width = CStr(150 * modBasic.$AppWidthRatio) & "px"
      .Columns[1].Width = CStr(200 * modBasic.$AppWidthRatio) & "px"
      .Columns[0].Text = Label1.Text
      .Columns[1].Text = Label2.Text
    End With

  Endif

End

Private Sub FilVarList()

  Dim sql As String

  sql = "select fldmaster,fldgroup from tblmasterdept ORDER BY fldmaster"
  $rData = modDatabase.$myConn.Exec(sql)
  $aMyFields = New String[]
  modGridView.ReadSmallData(GridView1, $rData, $aMyFields)
  GetColumnItemList()

  With GridView1
    .Columns[0].Width = CStr(150 * modBasic.$AppWidthRatio) & "px"
    .Columns[1].Width = CStr(200 * modBasic.$AppWidthRatio) & "px"
    .Columns[0].Text = Label1.Text
    .Columns[1].Text = Label2.Text
  End With

End

Private Sub GetColumnItemList()

  Dim res As Result
  Dim aColList As String[]

  aColList = New String[]
  res = modDatabase.$myConn.Exec("select fldmaster,fldgroup from tblmasterdept")
  For Each res
    aColList.Add(res["fldgroup"])
  Next
  txtvariable.List = modString.GetRemainingArray($varList, aColList)
  txtcategory.List = modControlSub.GetDirectFillresultNoNull(modDatabase.$myConn.Exec("select distinct(fldmaster) as col from tblmasterdept"))

End

Public Sub GridView1_Data(Row As Integer, Column As Integer, Data As WebTableData)

  $rData.MoveTo(Row)
  modGridView.GridViewDecoration(Data, Row)
  Data.Text = $rData[$aMyFields[Column]]

End

Public Sub btnCancel_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    modDatabase.$myConn.Delete("tblmasterdept", "fldmaster=&1 and fldgroup=&2", $rData["fldmaster"], $rData["fldgroup"])       ''
    If txtcategory.Text Then
      SHowSelectGrid()
    Else
      FilVarList()
    Endif
    Me.Exec("Toastify({text: 'Variable deleted', duration: 3000}).showToast()")
  Endif

End

Public Sub btnexport_Click()

  modCHTMLReport.ExportGridToHTML(GridView1, Me.Title, modReportVar.GetDateTimeReport(Now(), gb.GeneralDate))

End

Public Sub GridView1_Select()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    txtcategory.Text = $rData["fldmaster"]
    txtvariable.Text = $rData["fldgroup"]
  Endif

End

Public Sub btnupload_Click()

  Dim xdelim As String

  If txtdelim.Text Then
    xdelim = txtdelim.Text
  Else
    xdelim = ";"
  Endif
  If Message.Question(("Are you sure ?"), ("No"), ("Yes")) = 2 Then
    modTextDB.ImportCSVToCurrentDB(modDatabase.$myConn, "tblmasterdept", txtcsv.Text, xdelim)
    FilVarList()
  Endif

End

Public Sub btnclose_Click()

  Me.Close()

End
