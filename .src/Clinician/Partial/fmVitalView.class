' Gambas class file

Private $encid As String
Private $PatientNum As String
Private xFinal As Variant[]
Private $sVitalsVar As Variant[]

Public Sub _new(encid As String)

  $encid = encid
  $PatientNum = modPatient.GetPatientNoByEnc($encid)
  $sVitalsVar = modPathoSub.GetAllEssentialExams($encid)
  rbhourly.Value = True
  FillDailyGrid()

End

Public Sub RefreshValues()

  FillDailyGrid()

End

Public Sub btnrefresh_Click()

  FillDailyGrid()

End

Private Sub FillDailyGrid()

  Dim xRowVal As Collection
  Dim xfir As Date
  Dim xlast As Date

  Dim i As Integer
  Dim j As Integer

  xFinal = New Variant[]

  GridView2.Clear()
  GridView2.Count = $sVitalsVar.Count
  If rbminutes.Value = True Then
    xfir = modDate.StartSqlTenMinute(DateAdd(Now(), gb.Minute, -120))
    xlast = modDate.StartSqlTenMinute(DateAdd(Now(), gb.Minute, 10))
    GridView2.Columns.Count = (DateDiff(xfir, xlast, gb.Minute) / 10) + 1
  Else If rbhourly.Value = True Then
    xfir = modDate.StartSqlHour(DateAdd(Now(), gb.Hour, -12))
    xlast = modDate.StartSqlHour(DateAdd(Now(), gb.Hour, 1))
    GridView2.Columns.Count = DateDiff(xfir, xlast, gb.Hour) + 1
  Else If rbdaily.Value = True Then
    xfir = modDate.StartSqlDate(DateAdd(Now(), gb.Day, -12))
    xlast = modDate.StartSqlDate(DateAdd(Now(), gb.Day, 1))
    GridView2.Columns.Count = DateDiff(xfir, xlast, gb.Day) + 1
  Else If rbmonthly.Value = True Then
    xfir = modDate.StartSqlMonth(DateAdd(Now(), gb.Month, -12))
    xlast = modDate.StartSqlMonth(DateAdd(Now(), gb.Month, 1))
    GridView2.Columns.Count = DateDiff(xfir, xlast, gb.Month) + 1
  Endif

  For i = 0 To GridView2.Count - 1
    xRowVal = New Collection
    For j = 0 To GridView2.Columns.Count - 1
      If j = 0 Then
        xRowVal.Add($sVitalsVar[i]["ExamName"], CStr(j))
      Else
        If rbminutes.Value = True Then
          xRowVal.Add(GetExamValueByDate($PatientNum, $sVitalsVar[i]["ExamName"], DateAdd(xfir, gb.Minute, j * 10)), CStr(j))
        Else If rbhourly.Value = True Then
          xRowVal.Add(GetExamValueByDate($PatientNum, $sVitalsVar[i]["ExamName"], DateAdd(xfir, gb.Hour, j)), CStr(j))
        Else If rbdaily.Value = True Then
          xRowVal.Add(GetExamValueByDate($PatientNum, $sVitalsVar[i]["ExamName"], DateAdd(xfir, gb.Day, j)), CStr(j))
        Else If rbmonthly.Value = True Then
          xRowVal.Add(GetExamValueByDate($PatientNum, $sVitalsVar[i]["ExamName"], DateAdd(xfir, gb.Month, j)), CStr(j))
        Endif
      Endif
    Next
    xFinal.Add(xRowVal)
  Next

  With GridView2
    For j = 0 To GridView2.Columns.Count - 1
      If j = 0 Then
        .Columns[j].Width = CStr(150 * modBasic.$AppWidthRatio) & "px"
        .Columns[j].Text = "Examination"
      Else
        .Columns[j].Width = CStr(64 * modBasic.$AppWidthRatio) & "px"
        If rbminutes.Value = True Then
          .Columns[j].Text = modReportVar.GetDateTimeReport(DateAdd(xfir, gb.Minute, j * 10), gb.ShortTime)
        Else If rbhourly.Value = True Then
          .Columns[j].Text = modReportVar.GetDateTimeReport(DateAdd(xfir, gb.Hour, j), gb.ShortTime)
        Else If rbdaily.Value = True Then
          .Columns[j].Text = modDate.GetDateOnlyInFormatForAll(DateAdd(xfir, gb.Day, j), modBasic.$DateFormat, "DateOnly")
        Else If rbmonthly.Value = True Then
          .Columns[j].Text = modDate.GetDateOnlyInFormatForAll(DateAdd(xfir, gb.Month, j), modBasic.$DateFormat, "YearMonth")
        Endif
      Endif
    Next
  End With
  ' GridView2.Scroll(GridView2.X + GridView2.Width, GridView2.Y)

End

Public Sub GridView2_Data(Row As Integer, Column As Integer, Data As WebTableData)

  modGridView.GridViewDecoration(Data, Row)
  Data.Text = xFinal[Row][CStr(Column)]

End

Private Function GetExamValueByDate(patNo As String, xexam As String, xDate As Date) As String

  Dim res As Result
  Dim xx As String
  Dim xfir As Date
  Dim xlast As Date

  If rbminutes.Value = True Then
    xfir = modDate.StartSqlTenMinute(xDate)
    xlast = modDate.EndSqlTenMinute(xDate)
  Else If rbhourly.Value = True Then
    xfir = modDate.StartSqlHour(xDate)
    xlast = modDate.EndSqlHour(xDate)
  Else If rbdaily.Value = True Then
    xfir = modDate.StartSqlDate(xDate)
    xlast = modDate.EndSqlDate(xDate)
  Else If rbmonthly.Value = True Then
    xfir = modDate.StartSqlMonth(xDate)
    xlast = modDate.EndSqlMonth(xDate)
  Endif

  res = modDatabase.$myConn.Exec("select tblpatientexam.fldrepquali as fldrepquali,tblpatientexam.fldrepquanti as fldrepquanti from tblpatientexam inner join tblencounter on tblpatientexam.fldencounterval=tblencounter.fldencounterval  where tblencounter.fldpatientval=&1 and tblpatientexam.fldsave=&2 and tblpatientexam.fldhead=&3 and tblpatientexam.fldtime>=&4 and tblpatientexam.fldtime<=&5 ORDER BY tblpatientexam.fldtime", patNo, True, xexam, xfir, xlast)
  If res.Available Then
    res.MoveLast
    If res["fldrepquanti"] Then
      xx = CStr(res["fldrepquanti"])
    Else
      xx = res["fldrepquali"]
    Endif
  Else
    xx = ""
  Endif
  Return xx

End
