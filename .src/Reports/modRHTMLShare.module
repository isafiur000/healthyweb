' Gambas module file

' Private $ProgressBar1 As WebProgressBar

''-------------------------------- Sharing Reports ---------------------------------------------------------
Public Function SharingPaymentPrecise(xState As String, $con As Connection, CategType As String, dt1 As Date, dt2 As Date, xcateg As String, sType As String, sInvoiced As Boolean, sPackage As String, TotalFormat As String, xuserList As String[], sInput As String, sMode As String, Optional sParam As String) As String

  Dim $BillingReport As CReportHTML
  Dim asx As New String[0]
  Dim i As Integer
  Dim xpay As Float
  Dim xshare As Float
  Dim xtax As Float
  Dim tot As Float
  Dim res2 As Result
  Dim xparam As String

  Dim upay As Float
  Dim ushare As Float
  Dim utax As Float
  Dim netot As Float

  Dim apay As Float
  Dim ashare As Float
  Dim atax As Float
  Dim antot As Float

  Dim xuser As String
  Dim fld As String
  Dim totfld As String
  Dim sql1 As String
  Dim sql2 As String
  Dim sql3 As String
  Dim xgroupbool As Boolean

  ' If MMain.$IsGUIApp = True Then
  '   $ProgressBar1 = modAppSupport.FindWorkProgressBar(modHelpVariable.$LogInCategory)
  '   $ProgressBar1.Tag = "Const"
  ' Endif
  If sParam Then
    xparam = sParam
  Else
    xparam = ""
  Endif
  If xState = "Locked" Then
    xgroupbool = False
  Else
    xgroupbool = True
  Endif

  $BillingReport = New CReportHTML([("User Name"), ("PAN No"), ("Account"), ("Total"), ("ShareAmt"), ("TDSAmt"), ("NetAMT")], "", "")
  $BillingReport.UserData.Add(UCase(sType) & " SHARE : " & " CATEGORY : " & xcateg & " FORMAT: " & TotalFormat & " PACKAGE: " & sPackage & " MODE: " & sMode & " SOURCE: " & sInput, "PARAM1")
  $BillingReport.UserData.Add(UCase(xState) & " : " & modReportVar.GetDateTimeReport(dt1, gb.MediumDate) & " TO " & modReportVar.GetDateTimeReport(dt2, gb.MediumDate) & Space(2) & xparam, "PARAM2")

  apay = 0
  ashare = 0
  atax = 0
  antot = 0
  i = 0
  For Each xuser In xuserList
    If xuser Then
      xpay = 0
      xshare = 0
      xtax = 0
      tot = 0
      If sType = "Payable" Then
        fld = "fldpayto"
      Else If sType = "Referral" Then
        fld = "fldrefer"
      Endif
      If TotalFormat = "SubTotal" Then
        totfld = "(flditemrate*flditemqty) as totl"
      Else If TotalFormat = "NetTotal" Then
        totfld = "(flditemrate*flditemqty*(1-flddiscper/100)) as totl"
      Endif

      If CategType = "Category" Then
        If sInvoiced = True Then
          sql1 = Subst("select fldid,&1", totfld) & " from tblpatbilling " & Subst("where &1", fld) & " like &7 and fldsave=&1 and fldbilltype like &9 and fldbillno in(select fldbillno from tblpatbilldetail where fldtime>=&2 and fldtime<=&3) and flditemname like &4 and flditemtype like &5 and flddisctype like &6" & " and fldid not in(select flditemid from tblpatgenshare where fldvalue=&7)" & " and fldid not in(select fldbillid from tblpatusershares where fldshareuser=&7)"                                                                                               ''
          sql2 = Subst("select fldid,&1", totfld) & " from tblpatbilling " & "where fldsave=&1 and fldbilltype like &9 and fldbillno in(select fldbillno from tblpatbilldetail where fldtime>=&2 and fldtime<=&3) and flditemname like &4 and flditemtype like &5 and flddisctype like &6" & " and fldid in(select flditemid from tblpatgenshare where fldvalue=&7 and fldactive=&8 and fldsave=&{10})" & " and fldid not in(select fldbillid from tblpatusershares where fldshareuser=&7)"
          sql3 = Subst("select fldid,&1", totfld) & " from tblpatbilling " & "where fldsave=&1 and fldbilltype like &9 and fldbillno in(select fldbillno from tblpatbilldetail where fldtime>=&2 and fldtime<=&3) and flditemname like &4 and flditemtype like &5 and flddisctype like &6" & " and fldid in(select fldbillid from tblpatusershares where fldshareuser=&7 and fldactive=&8)"
        Else
          sql1 = Subst("select fldid,&1", totfld) & " from tblpatbilling " & Subst("where &1", fld) & " like &7 and fldsave=&1 and fldbilltype like &9 and fldtime>=&2 and fldtime<=&3 and flditemname like &4 and flditemtype like &5 and flddisctype like &6" & " and fldid not in(select flditemid from tblpatgenshare where fldvalue=&7)" & " and fldid not in(select fldbillid from tblpatusershares where fldshareuser=&7)"                                                   ''
          sql2 = Subst("select fldid,&1", totfld) & " from tblpatbilling " & "where fldsave=&1 and fldbilltype like &9 and flditemname like &4 and flditemtype like &5 and flddisctype like &6" & " and fldid in(select flditemid from tblpatgenshare where fldvalue=&7 and fldactive=&8 and fldtime>=&2 and fldtime<=&3 and fldsave=&{10})" & " and fldid not in(select fldbillid from tblpatusershares where fldshareuser=&7)"
          sql3 = Subst("select fldid,&1", totfld) & " from tblpatbilling " & "where fldsave=&1 and fldbilltype like &9 and flditemname like &4 and flditemtype like &5 and flddisctype like &6" & " and fldid in(select fldbillid from tblpatusershares where fldshareuser=&7 and fldactive=&8 and fldtime>=&2 and fldtime<=&3)"
        Endif
      Else If CategType = "Group" Then
        If sInvoiced = True Then
          sql1 = Subst("select fldid,&1", totfld) & " from tblpatbilling " & Subst("where &1", fld) & " like &7 and fldsave=&1 and fldbilltype like &9 and fldbillno in(select fldbillno from tblpatbilldetail where fldtime>=&2 and fldtime<=&3) and flditemname like &4 and flditemname in(select flditemname from tblreportgroup where fldgroup like &5) and flddisctype like &6" & " and fldid not in(select flditemid from tblpatgenshare where fldvalue=&7)" & " and fldid not in(select fldbillid from tblpatusershares where fldshareuser=&7)"                                                                                               ''
          sql2 = Subst("select fldid,&1", totfld) & " from tblpatbilling " & "where fldsave=&1 and fldbilltype like &9 and fldbillno in(select fldbillno from tblpatbilldetail where fldtime>=&2 and fldtime<=&3) and flditemname like &4 and flditemname in(select flditemname from tblreportgroup where fldgroup like &5) and flddisctype like &6" & " and fldid in(select flditemid from tblpatgenshare where fldvalue=&7 and fldactive=&8 and fldsave=&{10})" & " and fldid not in(select fldbillid from tblpatusershares where fldshareuser=&7)"
          sql3 = Subst("select fldid,&1", totfld) & " from tblpatbilling " & "where fldsave=&1 and fldbilltype like &9 and fldbillno in(select fldbillno from tblpatbilldetail where fldtime>=&2 and fldtime<=&3) and flditemname like &4 and flditemname in(select flditemname from tblreportgroup where fldgroup like &5) and flddisctype like &6" & " and fldid in(select fldbillid from tblpatusershares where fldshareuser=&7 and fldactive=&8)"
        Else
          sql1 = Subst("select fldid,&1", totfld) & " from tblpatbilling " & Subst("where &1", fld) & " like &7 and fldsave=&1 and fldbilltype like &9 and fldtime>=&2 and fldtime<=&3 and flditemname like &4 and flditemname in(select flditemname from tblreportgroup where fldgroup like &5) and flddisctype like &6" & " and fldid not in(select flditemid from tblpatgenshare where fldvalue=&7)" & " and fldid not in(select fldbillid from tblpatusershares where fldshareuser=&7)"                                                   ''
          sql2 = Subst("select fldid,&1", totfld) & " from tblpatbilling " & "where fldsave=&1 and fldbilltype like &9 and flditemname like &4 and flditemname in(select flditemname from tblreportgroup where fldgroup like &5) and flddisctype like &6" & " and fldid in(select flditemid from tblpatgenshare where fldvalue=&7 and fldactive=&8 and fldtime>=&2 and fldtime<=&3 and fldsave=&{10})" & " and fldid not in(select fldbillid from tblpatusershares where fldshareuser=&7)"
          sql3 = Subst("select fldid,&1", totfld) & " from tblpatbilling " & "where fldsave=&1 and fldbilltype like &9 and flditemname like &4 and flditemname in(select flditemname from tblreportgroup where fldgroup like &5) and flddisctype like &6" & " and fldid in(select fldbillid from tblpatusershares where fldshareuser=&7 and fldactive=&8 and fldtime>=&2 and fldtime<=&3)"
        Endif
      Endif
      res2 = $con.Exec(sql1 & " UNION ALL " & sql2 & " UNION ALL " & sql3, True, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), "%", xcateg, sPackage, xuser, "Active", sMode, xgroupbool)

      If res2.Available = True Then
        For Each res2
          upay = 0
          ushare = 0
          utax = 0
          netot = 0
          upay = res2["totl"]
          If sInput = "Percent" Then
            ushare = res2["totl"] * modSharing.GetUserPayPercent(xState, $con, res2["fldid"], xuser, sType) / 100
          Else If sInput = "Amount" Then
            ushare = modSharing.GetUserPayAmount(xState, $con, res2["fldid"], xuser, sType)
          Endif
          utax = ushare * modSharing.GetUserPayTaxReduction(xState, $con, res2["fldid"], xuser, sType) / 100
          netot = ushare - utax

          xpay = xpay + upay
          xshare = xshare + ushare
          xtax = xtax + utax
          tot = tot + netot
        Next
      Endif

      apay = apay + xpay
      ashare = ashare + xshare
      atax = atax + xtax
      antot = antot + tot
      ''total for each user
      With asx
        .Add(xuser & " [" & modGeneral.GetUserFullName(xuser) & "]")
        .Add(modGeneral.GetStaffPanIdent(xuser))
        .Add(modGeneral.GetStaffAccountRelig(xuser))
        .Add(modReportVar.GetLocaleNumberFormat(xpay, gb.Currency))
        .Add(modReportVar.GetLocaleNumberFormat(xshare, gb.Currency))
        .Add(modReportVar.GetLocaleNumberFormat(xtax, gb.Currency))
        .Add(modReportVar.GetLocaleNumberFormat(tot, gb.Currency))
      End With
      $BillingReport.Add(asx)
      asx.Clear()
    Endif

    ' If MMain.$IsGUIApp = True Then
    '   $ProgressBar1.Value = (i + 1) / xuserList.Count
    '   Wait
    ' Endif
    i = i + 1
  Next

  With asx
    .Add("***")
    .Add("***")
    .Add("***")
    .Add("***")
    .Add("***")
    .Add("***")
    .Add("***")
  End With
  $BillingReport.Add(asx)
  asx.Clear()
  With asx
    .Add("GRAND TOTAL")
    .Add("")
    .Add("")
    .Add("") ''modReportVar.GetLocaleNumberFormat(apay, gb.Currency)
    .Add(modReportVar.GetLocaleNumberFormat(ashare, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(atax, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(antot, gb.Currency))
  End With
  $BillingReport.Add(asx)
  asx.Clear()

  Return $BillingReport.NewHTMLPath()

End

Public Function SharingCategPaymentSummary(xState As String, $con As Connection, CategType As String, dt1 As Date, dt2 As Date, categorylst As String[], sType As String, sInvoiced As Boolean, sPackage As String, TotalFormat As String, xuserList As String[], sInput As String, sMode As String) As String

  Dim $BillingReport As CReportHTML
  Dim asx As New String[0]
  Dim xpay As Float
  Dim xshare As Float
  Dim xtax As Float
  Dim tot As Float
  Dim i As Integer
  Dim xgroupbool As Boolean

  Dim gpay As Float
  Dim gshare As Float
  Dim gtax As Float
  Dim gtot As Float
  Dim xcateg As String
  Dim res2 As Result

  Dim upay As Float
  Dim ushare As Float
  Dim utax As Float
  Dim netot As Float

  Dim apay As Float
  Dim ashare As Float
  Dim atax As Float
  Dim antot As Float

  Dim xuser As String
  Dim fld As String
  Dim totfld As String
  Dim sql1 As String
  Dim sql2 As String
  Dim sql3 As String

  ' If MMain.$IsGUIApp = True Then
  '   $ProgressBar1 = modAppSupport.FindWorkProgressBar(modHelpVariable.$LogInCategory)
  '   $ProgressBar1.Tag = "Const"
  ' Endif
  If xState = "Locked" Then
    xgroupbool = False
  Else
    xgroupbool = True
  Endif

  $BillingReport = New CReportHTML([("User Name"), ("PAN No"), ("Account"), ("Total"), ("ShareAmt"), ("TDSAmt"), ("NetAMT")], "", "")
  $BillingReport.UserData.Add(UCase(sType) & " SHARE : " & " CATEGORY : " & xcateg & " FORMAT: " & TotalFormat & " PACKAGE: " & sPackage & " MODE: " & sMode & " SOURCE: " & sInput, "PARAM1")
  $BillingReport.UserData.Add(UCase(xState) & " : " & modReportVar.GetDateTimeReport(dt1, gb.MediumDate) & " TO " & modReportVar.GetDateTimeReport(dt2, gb.MediumDate), "PARAM2")

  apay = 0
  ashare = 0
  atax = 0
  antot = 0
  i = 0
  For Each xcateg In categorylst
    If xcateg Then
      $BillingReport.AddChapter(xcateg)
      gpay = 0
      gshare = 0
      gtax = 0
      gtot = 0

      For Each xuser In xuserList
        xpay = 0
        xshare = 0
        xtax = 0
        tot = 0
        If sType = "Payable" Then
          fld = "fldpayto"
        Else If sType = "Referral" Then
          fld = "fldrefer"
        Endif
        If TotalFormat = "SubTotal" Then
          totfld = "(flditemrate*flditemqty) as totl"
        Else If TotalFormat = "NetTotal" Then
          totfld = "(flditemrate*flditemqty*(1-flddiscper/100)) as totl"
        Endif

        If CategType = "Category" Then
          If sInvoiced = True Then
            sql1 = Subst("select fldid,&1", totfld) & " from tblpatbilling " & Subst("where &1", fld) & " like &7 and fldsave=&1 and fldbilltype like &9 and fldbillno in(select fldbillno from tblpatbilldetail where fldtime>=&2 and fldtime<=&3) and flditemname like &4 and flditemtype like &5 and flddisctype like &6" & " and fldid not in(select flditemid from tblpatgenshare where fldvalue=&7)" & " and fldid not in(select fldbillid from tblpatusershares where fldshareuser=&7)"                                                                                               ''
            sql2 = Subst("select fldid,&1", totfld) & " from tblpatbilling " & "where fldsave=&1 and fldbilltype like &9 and fldbillno in(select fldbillno from tblpatbilldetail where fldtime>=&2 and fldtime<=&3) and flditemname like &4 and flditemtype like &5 and flddisctype like &6" & " and fldid in(select flditemid from tblpatgenshare where fldvalue=&7 and fldactive=&8 and fldsave=&{10})" & " and fldid not in(select fldbillid from tblpatusershares where fldshareuser=&7)"
            sql3 = Subst("select fldid,&1", totfld) & " from tblpatbilling " & "where fldsave=&1 and fldbilltype like &9 and fldbillno in(select fldbillno from tblpatbilldetail where fldtime>=&2 and fldtime<=&3) and flditemname like &4 and flditemtype like &5 and flddisctype like &6" & " and fldid in(select fldbillid from tblpatusershares where fldshareuser=&7 and fldactive=&8)"
          Else
            sql1 = Subst("select fldid,&1", totfld) & " from tblpatbilling " & Subst("where &1", fld) & " like &7 and fldsave=&1 and fldbilltype like &9 and fldtime>=&2 and fldtime<=&3 and flditemname like &4 and flditemtype like &5 and flddisctype like &6" & " and fldid not in(select flditemid from tblpatgenshare where fldvalue=&7)" & " and fldid not in(select fldbillid from tblpatusershares where fldshareuser=&7)"                                                   ''
            sql2 = Subst("select fldid,&1", totfld) & " from tblpatbilling " & "where fldsave=&1 and fldbilltype like &9 and flditemname like &4 and flditemtype like &5 and flddisctype like &6" & " and fldid in(select flditemid from tblpatgenshare where fldvalue=&7 and fldactive=&8 and fldtime>=&2 and fldtime<=&3 and fldsave=&{10})" & " and fldid not in(select fldbillid from tblpatusershares where fldshareuser=&7)"
            sql3 = Subst("select fldid,&1", totfld) & " from tblpatbilling " & "where fldsave=&1 and fldbilltype like &9 and flditemname like &4 and flditemtype like &5 and flddisctype like &6" & " and fldid in(select fldbillid from tblpatusershares where fldshareuser=&7 and fldactive=&8 and fldtime>=&2 and fldtime<=&3)"
          Endif
        Else If CategType = "Group" Then
          If sInvoiced = True Then
            sql1 = Subst("select fldid,&1", totfld) & " from tblpatbilling " & Subst("where &1", fld) & " like &7 and fldsave=&1 and fldbilltype like &9 and fldbillno in(select fldbillno from tblpatbilldetail where fldtime>=&2 and fldtime<=&3) and flditemname like &4 and flditemname in(select flditemname from tblreportgroup where fldgroup like &5) and flddisctype like &6" & " and fldid not in(select flditemid from tblpatgenshare where fldvalue=&7)" & " and fldid not in(select fldbillid from tblpatusershares where fldshareuser=&7)"                                                                                               ''
            sql2 = Subst("select fldid,&1", totfld) & " from tblpatbilling " & "where fldsave=&1 and fldbilltype like &9 and fldbillno in(select fldbillno from tblpatbilldetail where fldtime>=&2 and fldtime<=&3) and flditemname like &4 and flditemname in(select flditemname from tblreportgroup where fldgroup like &5) and flddisctype like &6" & " and fldid in(select flditemid from tblpatgenshare where fldvalue=&7 and fldactive=&8 and fldsave=&{10})" & " and fldid not in(select fldbillid from tblpatusershares where fldshareuser=&7)"
            sql3 = Subst("select fldid,&1", totfld) & " from tblpatbilling " & "where fldsave=&1 and fldbilltype like &9 and fldbillno in(select fldbillno from tblpatbilldetail where fldtime>=&2 and fldtime<=&3) and flditemname like &4 and flditemname in(select flditemname from tblreportgroup where fldgroup like &5) and flddisctype like &6" & " and fldid in(select fldbillid from tblpatusershares where fldshareuser=&7 and fldactive=&8)"
          Else
            sql1 = Subst("select fldid,&1", totfld) & " from tblpatbilling " & Subst("where &1", fld) & " like &7 and fldsave=&1 and fldbilltype like &9 and fldtime>=&2 and fldtime<=&3 and flditemname like &4 and flditemname in(select flditemname from tblreportgroup where fldgroup like &5) and flddisctype like &6" & " and fldid not in(select flditemid from tblpatgenshare where fldvalue=&7)" & " and fldid not in(select fldbillid from tblpatusershares where fldshareuser=&7)"                                                   ''
            sql2 = Subst("select fldid,&1", totfld) & " from tblpatbilling " & "where fldsave=&1 and fldbilltype like &9 and flditemname like &4 and flditemname in(select flditemname from tblreportgroup where fldgroup like &5) and flddisctype like &6" & " and fldid in(select flditemid from tblpatgenshare where fldvalue=&7 and fldactive=&8 and fldtime>=&2 and fldtime<=&3 and fldsave=&{10})" & " and fldid not in(select fldbillid from tblpatusershares where fldshareuser=&7)"
            sql3 = Subst("select fldid,&1", totfld) & " from tblpatbilling " & "where fldsave=&1 and fldbilltype like &9 and flditemname like &4 and flditemname in(select flditemname from tblreportgroup where fldgroup like &5) and flddisctype like &6" & " and fldid in(select fldbillid from tblpatusershares where fldshareuser=&7 and fldactive=&8 and fldtime>=&2 and fldtime<=&3)"
          Endif
        Endif
        res2 = $con.Exec(sql1 & " UNION ALL " & sql2 & " UNION ALL " & sql3, True, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), "%", xcateg, sPackage, xuser, "Active", sMode, xgroupbool)

        If res2.Available = True Then
          For Each res2
            upay = 0
            ushare = 0
            utax = 0
            netot = 0
            upay = res2["totl"]
            If sInput = "Percent" Then
              ushare = res2["totl"] * modSharing.GetUserPayPercent(xState, $con, res2["fldid"], xuser, sType) / 100
            Else If sInput = "Amount" Then
              ushare = modSharing.GetUserPayAmount(xState, $con, res2["fldid"], xuser, sType)
            Endif
            utax = ushare * modSharing.GetUserPayTaxReduction(xState, $con, res2["fldid"], xuser, sType) / 100
            netot = ushare - utax

            xpay = xpay + upay
            xshare = xshare + ushare
            xtax = xtax + utax
            tot = tot + netot
          Next
        Endif

        'for each category
        gpay = gpay + xpay
        gshare = gshare + xshare
        gtax = gtax + xtax
        gtot = gtot + tot
        If xpay Then
          With asx
            .Add(xuser & " [" & modGeneral.GetUserFullName(xuser) & "]")
            .Add(modGeneral.GetStaffPanIdent(xuser))
            .Add(modGeneral.GetStaffAccountRelig(xuser))
            .Add(modReportVar.GetLocaleNumberFormat(xpay, gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(xshare, gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(xtax, gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(tot, gb.Currency))
          End With
          $BillingReport.Add(asx)
          asx.Clear()
        Endif
      Next

      apay = apay + gpay
      ashare = ashare + gshare
      atax = atax + gtax
      antot = antot + gtot
      ''total for each user
      With asx
        .Add(modString.HTMLBlankSpace(5) & xcateg)
        .Add("")
        .Add("")
        .Add("") ''modReportVar.GetLocaleNumberFormat(gpay, gb.Currency)
        .Add(modReportVar.GetLocaleNumberFormat(gshare, gb.Currency))
        .Add(modReportVar.GetLocaleNumberFormat(gtax, gb.Currency))
        .Add(modReportVar.GetLocaleNumberFormat(gtot, gb.Currency))
      End With
      $BillingReport.Add(asx)
      asx.Clear()
      With asx
        .Add("...")
        .Add("...")
        .Add("...")
        .Add("...")
        .Add("...")
        .Add("...")
        .Add("...")
      End With
      $BillingReport.Add(asx)
      asx.Clear()
    Endif

    ' If MMain.$IsGUIApp = True Then
    '   $ProgressBar1.Value = (i + 1) / categorylst.Count
    '   Wait
    ' Endif
    i = i + 1
  Next

  With asx
    .Add("***")
    .Add("***")
    .Add("***")
    .Add("***")
    .Add("***")
    .Add("***")
    .Add("***")
  End With
  $BillingReport.Add(asx)
  asx.Clear()
  With asx
    .Add("GRAND TOTAL")
    .Add("")
    .Add("")
    .Add("") ''modReportVar.GetLocaleNumberFormat(apay, gb.Currency)
    .Add(modReportVar.GetLocaleNumberFormat(ashare, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(atax, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(antot, gb.Currency))
  End With
  $BillingReport.Add(asx)
  asx.Clear()

  Return $BillingReport.NewHTMLPath()

End

Public Function SharingPaymentSummary(xState As String, $con As Connection, CategType As String, dt1 As Date, dt2 As Date, categorylst As String[], sType As String, sInvoiced As Boolean, sPackage As String, TotalFormat As String, xuserList As String[], sInput As String, sMode As String) As String

  Dim $BillingReport As CReportHTML
  Dim asx As New String[0]
  Dim xpay As Float
  Dim xshare As Float
  Dim xtax As Float
  Dim tot As Float
  Dim i As Integer
  Dim xgroupbool As Boolean

  Dim gpay As Float
  Dim gshare As Float
  Dim gtax As Float
  Dim gtot As Float
  Dim xcateg As String
  Dim res2 As Result

  Dim upay As Float
  Dim ushare As Float
  Dim utax As Float
  Dim netot As Float

  Dim apay As Float
  Dim ashare As Float
  Dim atax As Float
  Dim antot As Float

  Dim xuser As String
  Dim fld As String
  Dim totfld As String
  Dim sql1 As String
  Dim sql2 As String
  Dim sql3 As String

  ' If MMain.$IsGUIApp = True Then
  '   $ProgressBar1 = modAppSupport.FindWorkProgressBar(modHelpVariable.$LogInCategory)
  '   $ProgressBar1.Tag = "Const"
  ' Endif
  If xState = "Locked" Then
    xgroupbool = False
  Else
    xgroupbool = True
  Endif

  $BillingReport = New CReportHTML([("Particulars"), ("Total"), ("ShareAmt"), ("TDSAmt"), ("NetAMT")], "", "")
  $BillingReport.UserData.Add(UCase(sType) & " SHARE : " & " CATEGORY : " & xcateg & " FORMAT: " & TotalFormat & " PACKAGE: " & sPackage & " MODE: " & sMode & " SOURCE: " & sInput, "PARAM1")
  $BillingReport.UserData.Add(UCase(xState) & " : " & modReportVar.GetDateTimeReport(dt1, gb.MediumDate) & " TO " & modReportVar.GetDateTimeReport(dt2, gb.MediumDate), "PARAM2")

  apay = 0
  ashare = 0
  atax = 0
  antot = 0
  i = 0
  For Each xuser In xuserList
    If xuser Then
      $BillingReport.AddChapter(xuser & " [" & modGeneral.GetUserFullName(xuser) & "]")
      gpay = 0
      gshare = 0
      gtax = 0
      gtot = 0

      For Each xcateg In categorylst
        xpay = 0
        xshare = 0
        xtax = 0
        tot = 0
        If sType = "Payable" Then
          fld = "fldpayto"
        Else If sType = "Referral" Then
          fld = "fldrefer"
        Endif
        If TotalFormat = "SubTotal" Then
          totfld = "(flditemrate*flditemqty) as totl"
        Else If TotalFormat = "NetTotal" Then
          totfld = "(flditemrate*flditemqty*(1-flddiscper/100)) as totl"
        Endif

        If CategType = "Category" Then
          If sInvoiced = True Then
            sql1 = Subst("select fldid,&1", totfld) & " from tblpatbilling " & Subst("where &1", fld) & " like &7 and fldsave=&1 and fldbilltype like &9 and fldbillno in(select fldbillno from tblpatbilldetail where fldtime>=&2 and fldtime<=&3) and flditemname like &4 and flditemtype like &5 and flddisctype like &6" & " and fldid not in(select flditemid from tblpatgenshare where fldvalue=&7)" & " and fldid not in(select fldbillid from tblpatusershares where fldshareuser=&7)"                                                                                               ''
            sql2 = Subst("select fldid,&1", totfld) & " from tblpatbilling " & "where fldsave=&1 and fldbilltype like &9 and fldbillno in(select fldbillno from tblpatbilldetail where fldtime>=&2 and fldtime<=&3) and flditemname like &4 and flditemtype like &5 and flddisctype like &6" & " and fldid in(select flditemid from tblpatgenshare where fldvalue=&7 and fldactive=&8 and fldsave=&{10})" & " and fldid not in(select fldbillid from tblpatusershares where fldshareuser=&7)"
            sql3 = Subst("select fldid,&1", totfld) & " from tblpatbilling " & "where fldsave=&1 and fldbilltype like &9 and fldbillno in(select fldbillno from tblpatbilldetail where fldtime>=&2 and fldtime<=&3) and flditemname like &4 and flditemtype like &5 and flddisctype like &6" & " and fldid in(select fldbillid from tblpatusershares where fldshareuser=&7 and fldactive=&8)"
          Else
            sql1 = Subst("select fldid,&1", totfld) & " from tblpatbilling " & Subst("where &1", fld) & " like &7 and fldsave=&1 and fldbilltype like &9 and fldtime>=&2 and fldtime<=&3 and flditemname like &4 and flditemtype like &5 and flddisctype like &6" & " and fldid not in(select flditemid from tblpatgenshare where fldvalue=&7)" & " and fldid not in(select fldbillid from tblpatusershares where fldshareuser=&7)"                                                   ''
            sql2 = Subst("select fldid,&1", totfld) & " from tblpatbilling " & "where fldsave=&1 and fldbilltype like &9 and flditemname like &4 and flditemtype like &5 and flddisctype like &6" & " and fldid in(select flditemid from tblpatgenshare where fldvalue=&7 and fldactive=&8 and fldtime>=&2 and fldtime<=&3 and fldsave=&{10})" & " and fldid not in(select fldbillid from tblpatusershares where fldshareuser=&7)"
            sql3 = Subst("select fldid,&1", totfld) & " from tblpatbilling " & "where fldsave=&1 and fldbilltype like &9 and flditemname like &4 and flditemtype like &5 and flddisctype like &6" & " and fldid in(select fldbillid from tblpatusershares where fldshareuser=&7 and fldactive=&8 and fldtime>=&2 and fldtime<=&3)"
          Endif
        Else If CategType = "Group" Then
          If sInvoiced = True Then
            sql1 = Subst("select fldid,&1", totfld) & " from tblpatbilling " & Subst("where &1", fld) & " like &7 and fldsave=&1 and fldbilltype like &9 and fldbillno in(select fldbillno from tblpatbilldetail where fldtime>=&2 and fldtime<=&3) and flditemname like &4 and flditemname in(select flditemname from tblreportgroup where fldgroup like &5) and flddisctype like &6" & " and fldid not in(select flditemid from tblpatgenshare where fldvalue=&7)" & " and fldid not in(select fldbillid from tblpatusershares where fldshareuser=&7)"                                                                                               ''
            sql2 = Subst("select fldid,&1", totfld) & " from tblpatbilling " & "where fldsave=&1 and fldbilltype like &9 and fldbillno in(select fldbillno from tblpatbilldetail where fldtime>=&2 and fldtime<=&3) and flditemname like &4 and flditemname in(select flditemname from tblreportgroup where fldgroup like &5) and flddisctype like &6" & " and fldid in(select flditemid from tblpatgenshare where fldvalue=&7 and fldactive=&8 and fldsave=&{10})" & " and fldid not in(select fldbillid from tblpatusershares where fldshareuser=&7)"
            sql3 = Subst("select fldid,&1", totfld) & " from tblpatbilling " & "where fldsave=&1 and fldbilltype like &9 and fldbillno in(select fldbillno from tblpatbilldetail where fldtime>=&2 and fldtime<=&3) and flditemname like &4 and flditemname in(select flditemname from tblreportgroup where fldgroup like &5) and flddisctype like &6" & " and fldid in(select fldbillid from tblpatusershares where fldshareuser=&7 and fldactive=&8)"
          Else
            sql1 = Subst("select fldid,&1", totfld) & " from tblpatbilling " & Subst("where &1", fld) & " like &7 and fldsave=&1 and fldbilltype like &9 and fldtime>=&2 and fldtime<=&3 and flditemname like &4 and flditemname in(select flditemname from tblreportgroup where fldgroup like &5) and flddisctype like &6" & " and fldid not in(select flditemid from tblpatgenshare where fldvalue=&7)" & " and fldid not in(select fldbillid from tblpatusershares where fldshareuser=&7)"                                                   ''
            sql2 = Subst("select fldid,&1", totfld) & " from tblpatbilling " & "where fldsave=&1 and fldbilltype like &9 and flditemname like &4 and flditemname in(select flditemname from tblreportgroup where fldgroup like &5) and flddisctype like &6" & " and fldid in(select flditemid from tblpatgenshare where fldvalue=&7 and fldactive=&8 and fldtime>=&2 and fldtime<=&3 and fldsave=&{10})" & " and fldid not in(select fldbillid from tblpatusershares where fldshareuser=&7)"
            sql3 = Subst("select fldid,&1", totfld) & " from tblpatbilling " & "where fldsave=&1 and fldbilltype like &9 and flditemname like &4 and flditemname in(select flditemname from tblreportgroup where fldgroup like &5) and flddisctype like &6" & " and fldid in(select fldbillid from tblpatusershares where fldshareuser=&7 and fldactive=&8 and fldtime>=&2 and fldtime<=&3)"
          Endif
        Endif
        res2 = $con.Exec(sql1 & " UNION ALL " & sql2 & " UNION ALL " & sql3, True, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), "%", xcateg, sPackage, xuser, "Active", sMode, xgroupbool)

        If res2.Available = True Then
          For Each res2
            upay = 0
            ushare = 0
            utax = 0
            netot = 0
            upay = res2["totl"]
            If sInput = "Percent" Then
              ushare = res2["totl"] * modSharing.GetUserPayPercent(xState, $con, res2["fldid"], xuser, sType) / 100
            Else If sInput = "Amount" Then
              ushare = modSharing.GetUserPayAmount(xState, $con, res2["fldid"], xuser, sType)
            Endif
            utax = ushare * modSharing.GetUserPayTaxReduction(xState, $con, res2["fldid"], xuser, sType) / 100
            netot = ushare - utax

            xpay = xpay + upay
            xshare = xshare + ushare
            xtax = xtax + utax
            tot = tot + netot
          Next
        Endif

        'for each category
        gpay = gpay + xpay
        gshare = gshare + xshare
        gtax = gtax + xtax
        gtot = gtot + tot
        If xpay Then
          With asx
            .Add(xcateg)
            .Add(modReportVar.GetLocaleNumberFormat(xpay, gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(xshare, gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(xtax, gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(tot, gb.Currency))
          End With
          $BillingReport.Add(asx)
          asx.Clear()
        Endif
      Next

      apay = apay + gpay
      ashare = ashare + gshare
      atax = atax + gtax
      antot = antot + gtot
      ''total for each user
      With asx
        .Add(modString.HTMLBlankSpace(5) & xuser & " [" & modGeneral.GetUserFullName(xuser) & "]")
        .Add("")  ''modReportVar.GetLocaleNumberFormat(gpay, gb.Currency)
        .Add(modReportVar.GetLocaleNumberFormat(gshare, gb.Currency))
        .Add(modReportVar.GetLocaleNumberFormat(gtax, gb.Currency))
        .Add(modReportVar.GetLocaleNumberFormat(gtot, gb.Currency))
      End With
      $BillingReport.Add(asx)
      asx.Clear()
      With asx
        .Add("***")
        .Add("***")
        .Add("***")
        .Add("***")
        .Add("***")
      End With
      $BillingReport.Add(asx)
      asx.Clear()
    Endif

    ' If MMain.$IsGUIApp = True Then
    '   $ProgressBar1.Value = (i + 1) / xuserList.Count
    '   Wait
    ' Endif
    i = i + 1
  Next

  With asx
    .Add("***")
    .Add("***")
    .Add("***")
    .Add("***")
    .Add("***")
  End With
  $BillingReport.Add(asx)
  asx.Clear()
  With asx
    .Add("GRAND TOTAL")
    .Add("") ''modReportVar.GetLocaleNumberFormat(apay, gb.Currency)
    .Add(modReportVar.GetLocaleNumberFormat(ashare, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(atax, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(antot, gb.Currency))
  End With
  $BillingReport.Add(asx)
  asx.Clear()

  Return $BillingReport.NewHTMLPath()

End

Public Function SharingPaymentItemSummary(xState As String, $con As Connection, CategType As String, dt1 As Date, dt2 As Date, categorylst As String[], sType As String, sInvoiced As Boolean, sPackage As String, TotalFormat As String, xuserList As String[], sInput As String, sMode As String) As String

  Dim $BillingReport As CReportHTML
  Dim asx As New String[0]
  Dim xpay As Float
  Dim xshare As Float
  Dim xtax As Float
  Dim tot As Float
  Dim i As Integer
  Dim xgroupbool As Boolean

  Dim gpay As Float
  Dim gshare As Float
  Dim gtax As Float
  Dim gtot As Float
  Dim xcateg As String
  Dim res2 As Result

  Dim upay As Float
  Dim ushare As Float
  Dim utax As Float
  Dim netot As Float

  Dim apay As Float
  Dim ashare As Float
  Dim atax As Float
  Dim antot As Float

  Dim xuser As String
  Dim fld As String
  Dim totfld As String
  Dim sql1 As String
  Dim sql2 As String
  Dim sql3 As String

  ' If MMain.$IsGUIApp = True Then
  '   $ProgressBar1 = modAppSupport.FindWorkProgressBar(modHelpVariable.$LogInCategory)
  '   $ProgressBar1.Tag = "Const"
  ' Endif
  If xState = "Locked" Then
    xgroupbool = False
  Else
    xgroupbool = True
  Endif

  $BillingReport = New CReportHTML([("Date"), ("Encounter"), ("Particulars"), ("Rate"), ("Total"), ("ShareAmt"), ("TDSAmt"), ("NetAMT"), ("Mode"), ("Invoice"), ("Package")], "", "")
  $BillingReport.UserData.Add(UCase(sType) & " SHARE : " & " CATEGORY : " & xcateg & " FORMAT: " & TotalFormat & " PACKAGE: " & sPackage & " MODE: " & sMode & " SOURCE: " & sInput, "PARAM1")
  $BillingReport.UserData.Add(UCase(xState) & " : " & modReportVar.GetDateTimeReport(dt1, gb.MediumDate) & " TO " & modReportVar.GetDateTimeReport(dt2, gb.MediumDate), "PARAM2")

  apay = 0
  ashare = 0
  atax = 0
  antot = 0
  i = 0
  For Each xuser In xuserList
    If xuser Then
      $BillingReport.AddSection(xuser & " [" & modGeneral.GetUserFullName(xuser) & "]", True)
      gpay = 0
      gshare = 0
      gtax = 0
      gtot = 0

      For Each xcateg In categorylst
        xpay = 0
        xshare = 0
        xtax = 0
        tot = 0
        If sType = "Payable" Then
          fld = "fldpayto"
        Else If sType = "Referral" Then
          fld = "fldrefer"
        Endif
        If TotalFormat = "SubTotal" Then
          totfld = "(flditemrate*flditemqty) as totl"
        Else If TotalFormat = "NetTotal" Then
          totfld = "(flditemrate*flditemqty*(1-flddiscper/100)) as totl"
        Endif

        If CategType = "Category" Then
          If sInvoiced = True Then
            sql1 = Subst("select fldid,fldtime,fldencounterval,fldbilltype,fldbillno,flddisctype,flditemname,flditemrate,flditemqty,&1", totfld) & " from tblpatbilling " & Subst("where &1", fld) & " like &7 and fldsave=&1 and fldbilltype like &9 and fldbillno in(select fldbillno from tblpatbilldetail where fldtime>=&2 and fldtime<=&3) and flditemname like &4 and flditemtype like &5 and flddisctype like &6" & " and fldid not in(select flditemid from tblpatgenshare where fldvalue=&7)" & " and fldid not in(select fldbillid from tblpatusershares where fldshareuser=&7)"                                                                                               ''
            sql2 = Subst("select fldid,fldtime,fldencounterval,fldbilltype,fldbillno,flddisctype,flditemname,flditemrate,flditemqty,&1", totfld) & " from tblpatbilling " & "where fldsave=&1 and fldbilltype like &9 and fldbillno in(select fldbillno from tblpatbilldetail where fldtime>=&2 and fldtime<=&3) and flditemname like &4 and flditemtype like &5 and flddisctype like &6" & " and fldid in(select flditemid from tblpatgenshare where fldvalue=&7 and fldactive=&8 and fldsave=&{10})" & " and fldid not in(select fldbillid from tblpatusershares where fldshareuser=&7)"
            sql3 = Subst("select fldid,fldtime,fldencounterval,fldbilltype,fldbillno,flddisctype,flditemname,flditemrate,flditemqty,&1", totfld) & " from tblpatbilling " & "where fldsave=&1 and fldbilltype like &9 and fldbillno in(select fldbillno from tblpatbilldetail where fldtime>=&2 and fldtime<=&3) and flditemname like &4 and flditemtype like &5 and flddisctype like &6" & " and fldid in(select fldbillid from tblpatusershares where fldshareuser=&7 and fldactive=&8)"
          Else
            sql1 = Subst("select fldid,fldtime,fldencounterval,fldbilltype,fldbillno,flddisctype,flditemname,flditemrate,flditemqty,&1", totfld) & " from tblpatbilling " & Subst("where &1", fld) & " like &7 and fldsave=&1 and fldbilltype like &9 and fldtime>=&2 and fldtime<=&3 and flditemname like &4 and flditemtype like &5 and flddisctype like &6" & " and fldid not in(select flditemid from tblpatgenshare where fldvalue=&7)" & " and fldid not in(select fldbillid from tblpatusershares where fldshareuser=&7)"                                                   ''
            sql2 = Subst("select fldid,fldtime,fldencounterval,fldbilltype,fldbillno,flddisctype,flditemname,flditemrate,flditemqty,&1", totfld) & " from tblpatbilling " & "where fldsave=&1 and fldbilltype like &9 and flditemname like &4 and flditemtype like &5 and flddisctype like &6" & " and fldid in(select flditemid from tblpatgenshare where fldvalue=&7 and fldactive=&8 and fldtime>=&2 and fldtime<=&3 and fldsave=&{10})" & " and fldid not in(select fldbillid from tblpatusershares where fldshareuser=&7)"
            sql3 = Subst("select fldid,fldtime,fldencounterval,fldbilltype,fldbillno,flddisctype,flditemname,flditemrate,flditemqty,&1", totfld) & " from tblpatbilling " & "where fldsave=&1 and fldbilltype like &9 and flditemname like &4 and flditemtype like &5 and flddisctype like &6" & " and fldid in(select fldbillid from tblpatusershares where fldshareuser=&7 and fldactive=&8 and fldtime>=&2 and fldtime<=&3)"
          Endif
        Else If CategType = "Group" Then
          If sInvoiced = True Then
            sql1 = Subst("select fldid,fldtime,fldencounterval,fldbilltype,fldbillno,flddisctype,flditemname,flditemrate,flditemqty,&1", totfld) & " from tblpatbilling " & Subst("where &1", fld) & " like &7 and fldsave=&1 and fldbilltype like &9 and fldbillno in(select fldbillno from tblpatbilldetail where fldtime>=&2 and fldtime<=&3) and flditemname like &4 and flditemname in(select flditemname from tblreportgroup where fldgroup like &5) and flddisctype like &6" & " and fldid not in(select flditemid from tblpatgenshare where fldvalue=&7)" & " and fldid not in(select fldbillid from tblpatusershares where fldshareuser=&7)"                                                                                               ''
            sql2 = Subst("select fldid,fldtime,fldencounterval,fldbilltype,fldbillno,flddisctype,flditemname,flditemrate,flditemqty,&1", totfld) & " from tblpatbilling " & "where fldsave=&1 and fldbilltype like &9 and fldbillno in(select fldbillno from tblpatbilldetail where fldtime>=&2 and fldtime<=&3) and flditemname like &4 and flditemname in(select flditemname from tblreportgroup where fldgroup like &5) and flddisctype like &6" & " and fldid in(select flditemid from tblpatgenshare where fldvalue=&7 and fldactive=&8 and fldsave=&{10})" & " and fldid not in(select fldbillid from tblpatusershares where fldshareuser=&7)"
            sql3 = Subst("select fldid,fldtime,fldencounterval,fldbilltype,fldbillno,flddisctype,flditemname,flditemrate,flditemqty,&1", totfld) & " from tblpatbilling " & "where fldsave=&1 and fldbilltype like &9 and fldbillno in(select fldbillno from tblpatbilldetail where fldtime>=&2 and fldtime<=&3) and flditemname like &4 and flditemname in(select flditemname from tblreportgroup where fldgroup like &5) and flddisctype like &6" & " and fldid in(select fldbillid from tblpatusershares where fldshareuser=&7 and fldactive=&8)"
          Else
            sql1 = Subst("select fldid,fldtime,fldencounterval,fldbilltype,fldbillno,flddisctype,flditemname,flditemrate,flditemqty,&1", totfld) & " from tblpatbilling " & Subst("where &1", fld) & " like &7 and fldsave=&1 and fldbilltype like &9 and fldtime>=&2 and fldtime<=&3 and flditemname like &4 and flditemname in(select flditemname from tblreportgroup where fldgroup like &5) and flddisctype like &6" & " and fldid not in(select flditemid from tblpatgenshare where fldvalue=&7)" & " and fldid not in(select fldbillid from tblpatusershares where fldshareuser=&7)"                                                   ''
            sql2 = Subst("select fldid,fldtime,fldencounterval,fldbilltype,fldbillno,flddisctype,flditemname,flditemrate,flditemqty,&1", totfld) & " from tblpatbilling " & "where fldsave=&1 and fldbilltype like &9 and flditemname like &4 and flditemname in(select flditemname from tblreportgroup where fldgroup like &5) and flddisctype like &6" & " and fldid in(select flditemid from tblpatgenshare where fldvalue=&7 and fldactive=&8 and fldtime>=&2 and fldtime<=&3 and fldsave=&{10})" & " and fldid not in(select fldbillid from tblpatusershares where fldshareuser=&7)"
            sql3 = Subst("select fldid,fldtime,fldencounterval,fldbilltype,fldbillno,flddisctype,flditemname,flditemrate,flditemqty,&1", totfld) & " from tblpatbilling " & "where fldsave=&1 and fldbilltype like &9 and flditemname like &4 and flditemname in(select flditemname from tblreportgroup where fldgroup like &5) and flddisctype like &6" & " and fldid in(select fldbillid from tblpatusershares where fldshareuser=&7 and fldactive=&8 and fldtime>=&2 and fldtime<=&3)"
          Endif
        Endif
        res2 = $con.Exec(sql1 & " UNION ALL " & sql2 & " UNION ALL " & sql3, True, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), "%", xcateg, sPackage, xuser, "Active", sMode, xgroupbool)

        If res2.Available = True Then
          $BillingReport.AddChapter(xcateg)
          For Each res2
            upay = 0
            ushare = 0
            utax = 0
            netot = 0
            upay = res2["totl"]
            If sInput = "Percent" Then
              ushare = res2["totl"] * modSharing.GetUserPayPercent(xState, $con, res2["fldid"], xuser, sType) / 100
            Else If sInput = "Amount" Then
              ushare = modSharing.GetUserPayAmount(xState, $con, res2["fldid"], xuser, sType)
            Endif
            utax = ushare * modSharing.GetUserPayTaxReduction(xState, $con, res2["fldid"], xuser, sType) / 100
            netot = ushare - utax

            xpay = xpay + upay
            xshare = xshare + ushare
            xtax = xtax + utax
            tot = tot + netot
            With asx
              .Add(modReportVar.GetDateTimeReport(res2["fldtime"], gb.GeneralDate))
              .Add(res2["fldencounterval"])
              .Add(res2["flditemname"])
              .Add(modReportVar.GetLocaleNumberFormat(res2["flditemrate"], gb.Currency))
              .Add(modReportVar.GetLocaleNumberFormat(upay, gb.Currency))
              .Add(modReportVar.GetLocaleNumberFormat(ushare, gb.Currency))
              .Add(modReportVar.GetLocaleNumberFormat(utax, gb.Currency))
              .Add(modReportVar.GetLocaleNumberFormat(netot, gb.Currency))
              .Add(res2["fldbilltype"])
              .Add(res2["fldbillno"])
              .Add(res2["flddisctype"])
            End With
            $BillingReport.Add(asx)
            asx.Clear()
          Next

          'for each category
          gpay = gpay + xpay
          gshare = gshare + xshare
          gtax = gtax + xtax
          gtot = gtot + tot
          With asx
            .Add("")
            .Add("")
            .Add(xuser & "@" & xcateg)
            .Add("")
            .Add("") ''modReportVar.GetLocaleNumberFormat(xpay, gb.Currency)
            .Add(modReportVar.GetLocaleNumberFormat(xshare, gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(xtax, gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(tot, gb.Currency))
            .Add("")
            .Add("")
            .Add("")
          End With
          $BillingReport.Add(asx)
          asx.Clear()
          With asx
            .Add("")
            .Add("")
            .Add("")
            .Add("")
            .Add("")
            .Add("")
            .Add("")
            .Add("")
            .Add("")
            .Add("")
            .Add("")
          End With
          $BillingReport.Add(asx)
          asx.Clear()
        Endif

      Next

      apay = apay + gpay
      ashare = ashare + gshare
      atax = atax + gtax
      antot = antot + gtot
      ''total for each user
      With asx
        .Add("")
        .Add("")
        .Add("<b>" & xuser & " [" & modGeneral.GetUserFullName(xuser) & "]" & "</b>")
        .Add("")
        .Add("") ''modReportVar.GetLocaleNumberFormat(gpay, gb.Currency)
        .Add(modReportVar.GetLocaleNumberFormat(gshare, gb.Currency))
        .Add(modReportVar.GetLocaleNumberFormat(gtax, gb.Currency))
        .Add(modReportVar.GetLocaleNumberFormat(gtot, gb.Currency))
        .Add("")
        .Add("")
        .Add("")
      End With
      $BillingReport.Add(asx)
      asx.Clear()
      With asx
        .Add("***")
        .Add("***")
        .Add("***")
        .Add("***")
        .Add("***")
        .Add("***")
        .Add("***")
        .Add("***")
        .Add("***")
        .Add("***")
        .Add("***")
      End With
      $BillingReport.Add(asx)
      asx.Clear()
    Endif

    ' If MMain.$IsGUIApp = True Then
    '   $ProgressBar1.Value = (i + 1) / xuserList.Count
    '   Wait
    ' Endif
    i = i + 1
  Next

  With asx
    .Add("***")
    .Add("***")
    .Add("***")
    .Add("***")
    .Add("***")
    .Add("***")
    .Add("***")
    .Add("***")
    .Add("***")
    .Add("***")
    .Add("***")
  End With
  $BillingReport.Add(asx)
  asx.Clear()
  With asx
    .Add("")
    .Add("")
    .Add("GRAND TOTAL")
    .Add("")
    .Add("") ''modReportVar.GetLocaleNumberFormat(apay, gb.Currency)
    .Add(modReportVar.GetLocaleNumberFormat(ashare, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(atax, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(antot, gb.Currency))
    .Add("")
    .Add("")
    .Add("")
  End With
  $BillingReport.Add(asx)
  asx.Clear()

  Return $BillingReport.NewHTMLPath()

End
