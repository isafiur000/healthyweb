' Gambas class file

Private $encid As String
Private $PatientNum As String
Private $InvoiceFormat As Boolean
Private $package As String
Private $BillMode As String

Private $ProcBill As Long
Private $sBillMode As String
Private $sItemName As String
Private $sLevel As String
Private $rDataAp As Result
Private $aMyFieldsAp As String[]

Private $rData As Result
Private $aMyFields As String[]

Private $rData2 As Result
Private $aMyFields2 As String[]

Private $rData3 As Result
Private $aMyFields3 As String[]

Private $rData4 As Result
Private $aMyFields4 As String[]
Private $PositionList As String[]
Private $sPath As String
Private $counterLst As String[]

Private $tblpatbilling As String

Public Sub _new()

  Dim xdefault As String
  Dim xoption As String
  Dim xoption1 As String

  cmbcategory.List = modMedicine.GetPathoCategoryList("Radio")
  cmbcategory.Text = modSettings.ShowSettingFromFIle("Radiology/DefaultDepartment")
  cmbcategorynew.List = modMedicine.GetPathoCategoryList("Radio")
  cmbcategorynew.Add("%")
  xdefault = modSettings.ShowSettingFromFIle("Radiology/DefaultDepartment")
  If xdefault Then
    cmbcategorynew.Text = xdefault
  Else
    cmbcategorynew.Text = "%"
  Endif
  cmbsourcedept.List = modGeneral.GetDepartmentAllList("%")
  dtsort.Value = Now()
  dtplan.Value = Now()
  xoption = modSettings.ShowSettingFromFIle("EntrySetting/Radiology_DateSelect")
  If xoption = "Yes" Then
    chkdate.Value = True
  Else If xoption = "No" Then
    chkdate.Value = False
  Endif
  dtlisted.Value = Now()
  xoption1 = modSettings.ShowSettingFromFIle("EntrySetting/Radiology_DateSelect")
  If xoption1 = "Yes" Then
    chklist.Value = True
  Else If xoption1 = "No" Then
    chklist.Value = False
  Endif
  DateSelectionSett()
  If modBasic.$PayableSettingVerify = "Enable" Then
    $sLevel = "Waiting"
  Else
    $sLevel = "Active"
  Endif
  modSettings.ShowCheckBox(chkall, "RadioReporting/ShowAll")
  If modGlobalSetting.ShowSettingFromDB("GeneralSettings/Radiology_TestAddition") = "Yes" Then
    mnuaddtest.Visible = True
    mnuaddgroup.Visible = True
  Endif
  rbwaiting.Value = True
  If modBasic.$ShareRadiologyAccess = "Yes" Then
    btnaddperson.Visible = True
    btnpersondelete.Visible = True
  Else
    btnaddperson.Visible = False
    btnpersondelete.Visible = False
  Endif
  $counterLst = modControlSub.GetDirectFillresultNoNull(modDatabase.$myConn.Exec("select fldcounter as col from tblradiocounter"))

  modRepository.ReadRemoteRepoConfig()
  If modRepository.$RepoPACSHost Then
    btnupload.Visible = True
  Endif

  ShowInputForm()
  modAccount.PasInvoiceSetting(cmbfiscal, False)
  LoadTableNames()

End

' Public Sub Form_KeyRelease()
'
'   If Key.Code = Key.F2 Then
'     TabPanel1.Index = 0
'   Else If Key.Code = Key.F3 Then
'     TabPanel1.Index = 1
'   Else If Key.Code = Key.F1 Then
'     btnnewsearch_Click()
'   Else If Key.Code = Key["O"] And If Key.Control Then
'     btnwebcam_Click()
'   Else If Key.Code = Key["F"] And If Key.Control Then
'   Else If Key.Code = Key["B"] And If Key.Control Then
'     Me.Close
'     Wait
'     modAppSupport.AddNewFormToWorkspace(fmRadioReporting)
'   Else If Key.Code = Key["R"] And If Key.Control Then
'     If TabPanel1.Index = 0 Then
'       btnnewrefresh_Click()
'     Else If TabPanel1.Index = 1 Then
'       btnrefresh_Click()
'     Endif
'   Else If Key.Code = Key["X"] And If Key.Control Then
'     Me.Close()
'   Endif
'
' End

Private Sub ShowInputForm()

  Dim xx As String

  If modBasic.$TestAddSource Then
    If modBasic.$TestAddSource = "Invoice" Then
      rbinvoice.Value = True
      rbencounter.Enabled = False
      btnsearname.Enabled = False
    Else If modBasic.$TestAddSource = "Encounter" Then
      rbencounter.Value = True
      rbinvoice.Enabled = False
      btnsearname.Enabled = True
    Else
      rbencounter.Value = True
      btnsearname.Enabled = True
    Endif

  Else
    xx = modSettings.ShowSettingFromFIle("Radiology/InputFormat")
    If xx = "Invoice" Then
      rbinvoice.Value = True
    Else
      rbencounter.Value = True
    Endif
  Endif

End

Private Sub LoadTableNames()

  Dim res As Result

  If cmbfiscal.Text = "Current" Then
    $tblpatbilling = "tblpatbilling"
  Else
    res = modDatabase.$myConn.Exec("select fldpatbilling,fldpatbilldetail,fldtempbilldetail from tblfisclosing where fldindex=&1 and (fldstate=&2 or fldstate IS NULL)", cmbfiscal.Text, "Active")
    If res.Available Then
      If res["fldpatbilling"] Then
        $tblpatbilling = res["fldpatbilling"]
      Else
        $tblpatbilling = "tblpatbilling"
      Endif
    Else
      $tblpatbilling = "tblpatbilling"
    Endif
  Endif

End

Public Sub cmbfiscal_Click()

  LoadTableNames()

End

Public Sub rbencounter_Click()

  modSettings.SaveSettingsToFile("Radiology/InputFormat", "Encounter")

End

Public Sub rbinvoice_Click()

  modSettings.SaveSettingsToFile("Radiology/InputFormat", "Invoice")

End

Private Sub DateSelectionSett()

  If chklist.Value = True Then
    Panel13.Enabled = True
  Else
    Panel13.Enabled = False
  Endif

End

Public Sub chklist_Click()

  modSettings.EnterCheckSetting(chklist, "EntrySetting/Radiology_DateSelect")
  DateSelectionSett()

End

Public Sub chkall_Click()

  modSettings.EnterCheckSetting(chkall, "RadioReporting/ShowAll")

End

Public Sub btndtplan_Click()

  Dim xx As String

  xx = BSDateFormat(("Enter BS Date in yyyy/mm/dd format"), ("Date Converter"), modDate.ConvertToLocaldate(dtplan.Value))
  If xx Then
    dtplan.Value = modDate.ConvertToEnglishdate(xx)
  Endif

End

Public Sub btnepsort_Click()

  Dim xx As String

  xx = BSDateFormat(("Enter BS Date in yyyy/mm/dd format"), ("Date Converter"), modDate.ConvertToLocaldate(dtsort.Value))
  If xx Then
    dtsort.Value = modDate.ConvertToEnglishdate(xx)
  Endif

End

Public Sub chkdate_Click()

  modSettings.EnterCheckSetting(chkdate, "EntrySetting/Radiology_DateSelect")

End

Public Sub btnnewrefresh_Click()

  If rbencounter.Value = True Then
    FillNewSamplingEncounters()
    ShowNewEncounterTests("")
  Else If rbinvoice.Value = True Then
    FillNewSamplingInvoices()
    ShowNewInvoiceTests("")
  Else If rbindoor.Value = True Then
    FillNewSamplingSaved()
    ShowNewEncSavedTests("")
  Endif
  ShowSampled("")
  GridView3.SetFocus

End

''---------------------------- sample grids -------------------------
Public Sub btnnewsearch_Click()

  Dim enc As String
  Dim xbillno As String

  rbwaiting.Value = True
  If rbencounter.Value = True Then
    If modBasic.$AutoEncPrefix Then
      enc = InputBox(("Encounter ID of Patient"), ("Search Patient"), modBasic.$EncIdPrefix)
    Else
      enc = InputBox(("Encounter ID of Patient"), ("Search Patient"), "")
    Endif
    If enc Then
      If txtlabbill.Text Then
        txtlabbill.Text = ""
      Endif
      FillNewSamplingSelectedEncounter(Trim(enc))
      ShowNewEncounterTests(Trim(enc))
    Endif

  Else If rbinvoice.Value = True Then
    xbillno = InputBox(("Laboratory Invoice No"), ("Search Patient"), "")
    If xbillno Then
      If txtlabbill.Text Then
        txtlabbill.Text = ""
      Endif
      FillNewSamplingSelectedInvoice(Trim(xbillno))
      ShowNewInvoiceTests(Trim(xbillno))
    Endif

  Else If rbindoor.Value = True Then
    If modBasic.$AutoEncPrefix Then
      enc = InputBox(("Encounter ID of Patient"), ("Search Patient"), modBasic.$EncIdPrefix)
    Else
      enc = InputBox(("Encounter ID of Patient"), ("Search Patient"), "")
    Endif
    If enc Then
      txtlabbill.Text = ""
      FillNewSamplingSelectedSaved(Trim(enc))
      ShowNewEncSavedTests(Trim(enc))
    Endif

  Endif
  ShowSampled("")

End

Public Sub btnsearname_Click()

  Dim xname As String[]
  Dim sql As String

  xname = InputDoubleText(("Search Patient Name"), ["First Name", "SurName"], ["%", "%"], modBasic.$SurNameList)
  If xname Then
    If cmbcategorynew.Text = "%" Then
      sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname like &6 and fldencounterval in(select fldencounterval from tblencounter where fldpatientval in(select fldpatientval from tblpatientinfo where lower(fldptnamefir) like &7 and lower(fldptnamelast) like &8)) and flditemqty>fldretqty"                                                                         ''
      $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", "%", LCase(xname[0]), LCase(xname[1]))
    Else
      sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname in(select fldgroupname from tblgroupradio where fldtestid in(select fldexamid from tblradio where fldcategory like &6)) and fldencounterval in(select fldencounterval from tblencounter where fldpatientval in(select fldpatientval from tblpatientinfo where lower(fldptnamefir) like &7 and lower(fldptnamelast) like &8)) and flditemqty>fldretqty"                                                                         ''
      $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", cmbcategorynew.Text, LCase(xname[0]), LCase(xname[1]))
    Endif

    rbencounter.Value = True
    $InvoiceFormat = False
    If txtlabbill.Text Then
      txtlabbill.Text = ""
    Endif

    $aMyFields3 = New String[]
    modGridView.ReadSmallData(GridView3, $rData3, $aMyFields3)
    DisplayInitialGrid()
    ShowNewEncounterTests("")
    ShowSampled("")
    GridView4.SetFocus
  Endif

End

Private Sub FillNewSamplingSaved()

  Dim sql As String
  Dim xcomp As String
  Dim xstr As String
  Dim xsource As String

  If modBasic.$LabSamplingComp Then
    xcomp = modBasic.$LabSamplingComp
  Else
    xcomp = "%"
  Endif
  If modBasic.$LabSamplingFrom = "Not From" Then
    xstr = "fldordcomp not like "
  Else
    xstr = "fldordcomp like "
  Endif
  If cmbsourcedept.Text Then
    xsource = db.Subst(" and fldcurrlocat like &1", cmbsourcedept.Text)
  Else
    xsource = ""
  Endif

  If chklist.Value = True Then
    If cmbcategorynew.Text = "%" Then
      sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and fldtime>=&6 and fldtime<=&7 and flditemname like &8 and flditemqty>fldretqty and fldbillno IS NULL and " & xstr & "&9" & xsource                                                    ''
      $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", modDate.StartSqlDate(dtlisted.Value), modDate.EndSqlDate(DateAdd(dtlisted.Value, gb.Day, txtrange.Value)), "%", xcomp)
    Else
      sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and fldtime>=&6 and fldtime<=&7 and flditemname in(select fldgroupname from tblgroupradio where fldtestid in(select fldexamid from tblradio where fldcategory like &8)) and flditemqty>fldretqty and fldbillno IS NULL and " & xstr & "&9" & xsource                                                     ''
      $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", modDate.StartSqlDate(dtlisted.Value), modDate.EndSqlDate(DateAdd(dtlisted.Value, gb.Day, txtrange.Value)), cmbcategorynew.Text, xcomp)
    Endif

  Else
    If cmbcategorynew.Text = "%" Then
      sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname like &6 and flditemqty>fldretqty and fldbillno IS NULL and " & xstr & "&7" & xsource                                                     ''
      $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", "%", xcomp)
    Else
      sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname in(select fldgroupname from tblgroupradio where fldtestid in(select fldexamid from tblradio where fldcategory like &6)) and flditemqty>fldretqty and fldbillno IS NULL and " & xstr & "&7" & xsource                                                   ''
      $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", cmbcategorynew.Text, xcomp)
    Endif

  Endif
  $aMyFields3 = New String[]
  modGridView.ReadSmallData(GridView3, $rData3, $aMyFields3)
  DisplayInitialGrid()
  $InvoiceFormat = False

End

Private Sub FillNewSamplingEncounters()

  Dim sql As String
  Dim xcomp As String
  Dim xstr As String
  Dim xsource As String

  If modBasic.$LabSamplingComp Then
    xcomp = modBasic.$LabSamplingComp
  Else
    xcomp = "%"
  Endif
  If modBasic.$LabSamplingFrom = "Not From" Then
    xstr = "fldordcomp not like "
  Else
    xstr = "fldordcomp like "
  Endif
  If cmbsourcedept.Text Then
    xsource = db.Subst(" and fldcurrlocat like &1", cmbsourcedept.Text)
  Else
    xsource = ""
  Endif

  If chklist.Value = True Then
    If cmbcategorynew.Text = "%" Then
      sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and fldtime>=&6 and fldtime<=&7 and flditemname like &8 and flditemqty>fldretqty and fldbillno IS NOT NULL and " & xstr & "&9" & xsource                                                    ''
      $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", modDate.StartSqlDate(dtlisted.Value), modDate.EndSqlDate(DateAdd(dtlisted.Value, gb.Day, txtrange.Value)), "%", xcomp)
    Else
      sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and fldtime>=&6 and fldtime<=&7 and flditemname in(select fldgroupname from tblgroupradio where fldtestid in(select fldexamid from tblradio where fldcategory like &8)) and flditemqty>fldretqty and fldbillno IS NOT NULL and " & xstr & "&9" & xsource                                                     ''
      $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", modDate.StartSqlDate(dtlisted.Value), modDate.EndSqlDate(DateAdd(dtlisted.Value, gb.Day, txtrange.Value)), cmbcategorynew.Text, xcomp)
    Endif

  Else
    If cmbcategorynew.Text = "%" Then
      sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname like &6 and flditemqty>fldretqty and fldbillno IS NOT NULL and " & xstr & "&7" & xsource                                                     ''
      $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", "%", xcomp)
    Else
      sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname in(select fldgroupname from tblgroupradio where fldtestid in(select fldexamid from tblradio where fldcategory like &6)) and flditemqty>fldretqty and fldbillno IS NOT NULL and " & xstr & "&7" & xsource                                                    ''
      $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", cmbcategorynew.Text, xcomp)
    Endif

  Endif
  $aMyFields3 = New String[]
  modGridView.ReadSmallData(GridView3, $rData3, $aMyFields3)
  DisplayInitialGrid()
  $InvoiceFormat = False

End

Private Sub FillNewSamplingInvoices()

  Dim sql As String
  Dim xcomp As String
  Dim xstr As String
  Dim xsource As String

  If modBasic.$LabSamplingComp Then
    xcomp = modBasic.$LabSamplingComp
  Else
    xcomp = "%"
  Endif
  If modBasic.$LabSamplingFrom = "Not From" Then
    xstr = "fldordcomp not like "
  Else
    xstr = "fldordcomp like "
  Endif
  If cmbsourcedept.Text Then
    xsource = db.Subst(" and fldcurrlocat like &1", cmbsourcedept.Text)
  Else
    xsource = ""
  Endif

  If chklist.Value = True Then
    If cmbcategorynew.Text = "%" Then
      sql = "select distinct(fldbillno) as fldbillno,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and fldtime>=&6 and fldtime<=&7 and flditemname like &8 and flditemqty>fldretqty and " & xstr & "&9" & xsource                                                  ''
      $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", modDate.StartSqlDate(dtlisted.Value), modDate.EndSqlDate(DateAdd(dtlisted.Value, gb.Day, txtrange.Value)), "%", xcomp)
    Else
      sql = "select distinct(fldbillno) as fldbillno,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and fldtime>=&6 and fldtime<=&7 and flditemname in(select fldgroupname from tblgroupradio where fldtestid in(select fldexamid from tblradio where fldcategory like &8)) and flditemqty>fldretqty and " & xstr & "&9" & xsource                                                    ''
      $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", modDate.StartSqlDate(dtlisted.Value), modDate.EndSqlDate(DateAdd(dtlisted.Value, gb.Day, txtrange.Value)), cmbcategorynew.Text, xcomp)
    Endif

  Else
    If cmbcategorynew.Text = "%" Then
      sql = "select distinct(fldbillno) as fldbillno,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname like &6 and flditemqty>fldretqty and " & xstr & "&7" & xsource                                                   ''
      $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", "%", xcomp)
    Else
      sql = "select distinct(fldbillno) as fldbillno,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname in(select fldgroupname from tblgroupradio where fldtestid in(select fldexamid from tblradio where fldcategory like &6)) and flditemqty>fldretqty and " & xstr & "&7" & xsource                                                     ''
      $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", cmbcategorynew.Text, xcomp)
    Endif

  Endif
  $aMyFields3 = New String[]
  modGridView.ReadSmallData(GridView3, $rData3, $aMyFields3)
  DisplayInitialGrid()
  $InvoiceFormat = True

End

Private Sub FillNewSamplingSelectedEncounter(encid As String)

  Dim sql As String

  If cmbcategorynew.Text = "%" Then
    sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname like &6 and fldencounterval=&7 and flditemqty>fldretqty"                                                                         ''
    $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", "%", encid)
  Else
    sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname in(select fldgroupname from tblgroupradio where fldtestid in(select fldexamid from tblradio where fldcategory like &6)) and fldencounterval=&7 and flditemqty>fldretqty"                                                                         ''
    $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", cmbcategorynew.Text, encid)
  Endif
  $aMyFields3 = New String[]
  modGridView.ReadSmallData(GridView3, $rData3, $aMyFields3)
  DisplayInitialGrid()
  $InvoiceFormat = False

End

Private Sub FillNewSamplingSelectedInvoice(xbillNo As String)

  Dim sql As String

  If cmbcategorynew.Text = "%" Then
    sql = "select distinct(fldbillno) as fldbillno,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname like &6 and fldbillno=&7 and flditemqty>fldretqty"                                                                         ''
    $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", "%", xbillNo)
  Else
    sql = "select distinct(fldbillno) as fldbillno,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname in(select fldgroupname from tblgroupradio where fldtestid in(select fldexamid from tblradio where fldcategory like &6)) and fldbillno=&7 and flditemqty>fldretqty"                                                                         ''
    $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", cmbcategorynew.Text, xbillNo)
  Endif
  $aMyFields3 = New String[]
  modGridView.ReadSmallData(GridView3, $rData3, $aMyFields3)
  DisplayInitialGrid()
  $InvoiceFormat = True

End

Private Sub FillNewSamplingSelectedSaved(encid As String)

  Dim sql As String

  If cmbcategorynew.Text = "%" Then
    sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname like &6 and fldencounterval=&7 and flditemqty>fldretqty and fldbillno IS NULL"                                                                         ''
    $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", "%", encid)
  Else
    sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname in(select fldgroupname from tblgroupradio where fldtestid in(select fldexamid from tblradio where fldcategory like &6)) and fldencounterval=&7 and flditemqty>fldretqty and fldbillno IS NULL"                                                                         ''
    $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", cmbcategorynew.Text, encid)
  Endif
  $aMyFields3 = New String[]
  modGridView.ReadSmallData(GridView3, $rData3, $aMyFields3)
  DisplayInitialGrid()
  $InvoiceFormat = False

End

Private Sub DisplayInitialGrid()

  With GridView3
    .Columns[0].Width = CStr(125 * modBasic.$AppWidthRatio) & "px"
    .Columns[1].Width = CStr(10 * modBasic.$AppWidthRatio) & "px"
    .Columns[2].Width = CStr(175 * modBasic.$AppWidthRatio) & "px"
    .Columns[3].Width = CStr(75 * modBasic.$AppWidthRatio) & "px"
    .Columns[4].Width = CStr(125 * modBasic.$AppWidthRatio) & "px"
    .Columns[5].Width = CStr(100 * modBasic.$AppWidthRatio) & "px"

    If rbencounter.Value = True Then
      .Columns[0].Text = "EncID"
    Else If rbinvoice.Value = True Then
      .Columns[0].Text = "Invoice"
    Else If rbindoor.Value = True Then
      .Columns[0].Text = "EncID"
    Endif
    .Columns[2].Text = "Name"
    .Columns[3].Text = "Sender"
    .Columns[4].Text = "EncID"
    .Columns[5].Text = "Location"
  End With

End

Public Sub GridView3_Data(Row As Integer, Column As Integer, Data As WebTableData)

  $rData3.MoveTo(Row)
  modGridView.GridViewDecoration(Data, Row)
  If Column = 1 Then
    Data.Text = ""
    Data.Background = modPatient.GetPatientColor($rData3[$aMyFields3[Column]])
  Else If Column = 2 Then
    Data.Text = modPatient.GetPatientNameByEnc($rData3[$aMyFields3[Column]])
  Else If Column = 5 Then
    Data.Text = modPatient.GetPatientLocation($rData3[$aMyFields3[Column]])
  Else
    Data.Text = $rData3[$aMyFields3[Column]]
  Endif

End

Private Sub SHowPAtientRadioList()

  If GridView3.Selection.Count Then
    $rData3.MoveTo(GridView3.Selection[0])
    rbwaiting.Value = True
    If $InvoiceFormat = True Then
      ShowNewInvoiceTests($rData3["fldbillno"])
    Else
      If rbencounter.Value = True Then
        ShowNewEncounterTests($rData3["fldencounterval"])
      Else If rbindoor.Value = True Then
        ShowNewEncSavedTests($rData3["fldencounterval"])
      Endif
    Endif

    btnpayto.Tag = modBillings.GetPayableUserSetting("Radio", $rData3["fldencounterval"])
    If btnpayto.Tag Then
      btnpayto.Text = modGeneral.GetUserFullName(btnpayto.Tag)
    Endif
    If modBasic.$PayableLockEntry = "Yes" Then
      btnselectuser.Enabled = False
    Endif
    txtcolor.Background = modPatient.GetPatientColor($rData3["fldencounterval"])
    ShowSampled("")
  Endif

End

Public Sub GridView3_Select()

  SHowPAtientRadioList()

End

Public Sub btnaddedsearch_Click()

  Dim enc As String

  If modBasic.$AutoEncPrefix Then
    enc = InputBox(("Encounter ID of Patient"), ("Search Patient"), modBasic.$EncIdPrefix)
  Else
    enc = InputBox(("Encounter ID of Patient"), ("Search Patient"), "")
  Endif
  If enc Then
    ShowAddedEncounterTests(Trim(enc))
    ShowSampled("")
  Endif

End

Private Sub ShowNewEncSavedTests(encid As String)

  Dim sql As String

  If rbwaiting.Value = True Then
    If cmbcategorynew.Text = "%" Then
      sql = "select flditemname,fldreason,fldid,fldencounterval,fldcurrlocat,(flditemqty-fldretqty) as xqty,fldtime from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldencounterval=&3 and fldsave=&4 and (fldtarget=&5 or fldtarget=&6) and flditemqty>fldretqty and fldbillno IS NULL"
    Else
      sql = "select flditemname,fldreason,fldid,fldencounterval,fldcurrlocat,(flditemqty-fldretqty) as xqty,fldtime from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldencounterval=&3 and fldsave=&4 and (fldtarget=&5 or fldtarget=&6) and flditemname in(select fldgroupname from tblgroupradio where fldtestid in(select fldexamid from tblradio where fldcategory like &7)) and flditemqty>fldretqty and fldbillno IS NULL"
    Endif
    $rData4 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", encid, True, modBasic.$compID, "%", cmbcategorynew.Text)
    $aMyFields4 = New String[]
    modGridView.ReadSmallData(GridView4, $rData4, $aMyFields4)
    ShowLeftGridView()
  Endif

End

Private Sub ShowNewEncounterTests(encid As String)

  Dim sql As String

  If rbwaiting.Value = True Then
    If cmbcategorynew.Text = "%" Then
      sql = "select flditemname,fldreason,fldid,fldencounterval,fldcurrlocat,(flditemqty-fldretqty) as xqty,fldtime from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldencounterval=&3 and fldsave=&4 and (fldtarget=&5 or fldtarget=&6) and flditemqty>fldretqty and fldbillno IS NOT NULL"
    Else
      sql = "select flditemname,fldreason,fldid,fldencounterval,fldcurrlocat,(flditemqty-fldretqty) as xqty,fldtime from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldencounterval=&3 and fldsave=&4 and (fldtarget=&5 or fldtarget=&6) and flditemname in(select fldgroupname from tblgroupradio where fldtestid in(select fldexamid from tblradio where fldcategory like &7)) and flditemqty>fldretqty and fldbillno IS NOT NULL"
    Endif
    $rData4 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", encid, True, modBasic.$compID, "%", cmbcategorynew.Text)
    $aMyFields4 = New String[]
    modGridView.ReadSmallData(GridView4, $rData4, $aMyFields4)
    ShowLeftGridView()
  Endif

End

Private Sub ShowNewInvoiceTests(xBillNo As String)

  Dim sql As String

  If rbwaiting.Value = True Then
    If cmbcategorynew.Text = "%" Then
      sql = "select flditemname,fldreason,fldid,fldencounterval,fldcurrlocat,(flditemqty-fldretqty) as xqty,fldtime from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldbillno=&3 and fldsave=&4 and (fldtarget=&5 or fldtarget=&6) and flditemqty>fldretqty"
    Else
      sql = "select flditemname,fldreason,fldid,fldencounterval,fldcurrlocat,(flditemqty-fldretqty) as xqty,fldtime from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldbillno=&3 and fldsave=&4 and (fldtarget=&5 or fldtarget=&6) and flditemname in(select fldgroupname from tblgroupradio where fldtestid in(select fldexamid from tblradio where fldcategory like &7)) and flditemqty>fldretqty"
    Endif
    $rData4 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", xBillNo, True, modBasic.$compID, "%", cmbcategorynew.Text)
    $aMyFields4 = New String[]
    modGridView.ReadSmallData(GridView4, $rData4, $aMyFields4)
    ShowLeftGridView()
  Endif

End

''for added tests
Private Sub ShowAddedEncounterTests(encid As String)

  Dim sql As String

  If rbadded.Value = True Then
    If cmbcategorynew.Text = "%" Then
      sql = "select flditemname,fldreason,fldid,fldencounterval,fldcurrlocat,(flditemqty-fldretqty) as xqty,fldtime from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldencounterval=&3 and fldsave=&4 and (fldtarget=&5 or fldtarget=&6) and flditemqty>fldretqty"
    Else
      sql = "select flditemname,fldreason,fldid,fldencounterval,fldcurrlocat,(flditemqty-fldretqty) as xqty,fldtime from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldencounterval=&3 and fldsave=&4 and (fldtarget=&5 or fldtarget=&6) and flditemname in(select fldgroupname from tblgroupradio where fldtestid in(select fldexamid from tblradio where fldcategory like &7)) and flditemqty>fldretqty"
    Endif
    $rData4 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Sampled", encid, True, modBasic.$compID, "%", cmbcategorynew.Text)
    $aMyFields4 = New String[]
    modGridView.ReadSmallData(GridView4, $rData4, $aMyFields4)
    ShowLeftGridView()
  Endif

End

Private Sub ShowLeftGridView()

  With GridView4
    .Columns[0].Width = CStr(250 * modBasic.$AppWidthRatio) & "px"
    .Columns[1].Width = CStr(200 * modBasic.$AppWidthRatio) & "px"
    .Columns[2].Hidden = True
    .Columns[3].Hidden = True
    .Columns[4].Width = CStr(100 * modBasic.$AppWidthRatio) & "px"
    .Columns[5].Hidden = True
    .Columns[6].Width = CStr(150 * modBasic.$AppWidthRatio) & "px"
    .Columns[0].Text = "Test Name"
    .Columns[1].Text = "Comment"
    .Columns[4].Text = "Location"
    .Columns[6].Text = "DateTime"
  End With

End

Public Sub GridView4_Data(Row As Integer, Column As Integer, Data As WebTableData)

  $rData4.MoveTo(Row)
  modGridView.GridViewDecoration(Data, Row)
  If Column = 1 Then
    Data.Control = GetPresenceIcon($rData4[$aMyFields4[Column]])
  Else If Column = 6 Then
    Data.Text = modReportVar.GetDateTimeReport($rData4[$aMyFields4[Column]], gb.GeneralDate)
  Else
    Data.Text = $rData4[$aMyFields4[Column]]
  Endif

End

Public Sub btnopeninfo_Click()

  If GridView4.Selection.Count Then
    $rData4.MoveTo(GridView4.Selection[0])
    If $rData4["fldreason"] Then
      Message.Info($rData4["fldreason"])
    Endif
  Endif

End

Private Function GetPresenceIcon(sText As String) As WebControl

  Dim sval As WebControl

  If sText Then
    sval = btnopeninfo
  Else
    sText = Null
  Endif
  Return sval

End

Private Sub ShowEntryRadioName()

  Dim xx As String[]

  cmbformat.Clear()
  If GridView4.Selection.Count Then
    $rData4.MoveTo(GridView4.Selection[0])
    xx = modControlSub.GetDirectFillresult(modDatabase.$myConn.Exec("select distinct(fldptsex) as col from tblgroupradio where fldgroupname=&1", $rData4["flditemname"]))
    cmbformat.List = xx
    If xx.Count = 1 Then
      cmbformat.Text = xx[0]
    Endif
    cmbformat.SetFocus
  Endif

End

Public Sub GridView4_Select()

  ShowEntryRadioName()

End

Public Sub btnnewexpotree_Click()

  Dim $BillingReport As CReportHTML
  Dim asx As New String[0]
  Dim sql As String
  Dim res As Result
  Dim xcomp As String

  If modBasic.$LabSamplingComp Then
    xcomp = modBasic.$LabSamplingComp
  Else
    xcomp = "%"
  Endif

  $BillingReport = New CReportHTML([("Encounter"), ("PatientName"), ("Age/Sex"), ("Particulars"), ("Remarks")], " ", "")
  $BillingReport.UserData.Add("TEST REQUESTS", "PARAM1")
  $BillingReport.UserData.Add("Category : " & cmbcategorynew.Text, "PARAM2")

  If cmbcategorynew.Text = "%" Then
    sql = "select distinct(fldencounterval) from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and fldtarget=&4 and fldordcomp like &5 and flditemqty>fldretqty"
  Else
    sql = "select distinct(fldencounterval) from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and fldtarget=&4 and fldordcomp like &5 and flditemname in(select fldgroupname from tblgroupradio where fldtestid in(select fldexamid from tblradio where fldcategory like &6)) and flditemqty>fldretqty"
  Endif
  res = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, xcomp, cmbcategorynew.Text)
  If res.Available Then
    For Each res
      With asx
        .Add(res!fldencounterval)
        .Add(modPatient.GetPatientNameByEnc(res!fldencounterval))
        .Add(modPatient.GetPatientAgeString(res!fldencounterval, Now()) & "/" & modPatient.GetPatientSex(res!fldencounterval))
        .Add(GetTestListForSample(res!fldencounterval).Join("; "))
        .Add("")
      End With
      $BillingReport.Add(asx)
      asx.Clear()
    Next
  Endif

  modControlSub.OpenHTMLPreview("", $BillingReport.NewHTMLPath(), "ReportSize")

End

Private Sub GetTestListForSample(encid As String) As String[]

  Dim xx As String[]
  Dim sql As String
  Dim res As Result

  If cmbcategorynew.Text = "%" Then
    sql = "select flditemname from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldencounterval=&3 and fldsave=&4 and fldtarget=&5"
  Else
    sql = "select flditemname from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldencounterval=&3 and fldsave=&4 and fldtarget=&5 and flditemname in(select fldgroupname from tblgroupradio where fldtestid in(select fldexamid from tblradio where fldcategory like &6))"
  Endif
  res = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", encid, True, modBasic.$compID, cmbcategorynew.Text)
  xx = modControlSub.GetDirectFillresult(res)
  Return xx

End

Private Sub AddSampling(plandate As Date, sFormat As String)

  Dim res As Result
  Dim res1 As Result
  Dim resx As Result
  Dim j As Integer
  Dim res2 As Result
  Dim asx As String[]
  Dim xformat As String

  If btnformatlist.Tag Then
    asx = Split(btnformatlist.Tag, "|")
  Else
    asx = New String[]
  Endif
  If GridView4.Selection.Count Then
    $rData4.MoveTo(GridView4.Selection[0])
    res2 = modDatabase.$myConn.Exec("select fldbillno,fldrefer,fldreason,(flditemqty-fldretqty) as xqty from " & $tblpatbilling & " where fldid=&1", $rData4["fldid"])
    If res2["xqty"] > 0 Then
      resx = modDatabase.$myConn.Exec("select fldtestid,fldtesttype,fldactive from tblgroupradio where fldgroupname=&1 and fldptsex=&2", $rData4["flditemname"], sFormat)
      If resx.Available Then

        modDatabase.$myConn.Begin
        For j = 0 To res2["xqty"] - 1
          If asx.Count > j Then
            xformat = asx[j]
          Else
            xformat = sFormat
          Endif
          res = modDatabase.$myConn.Exec("select fldtestid,fldtesttype,fldactive from tblgroupradio where fldgroupname=&1 and fldptsex=&2", $rData4["flditemname"], xformat)
          If res.Available = True Then
            For Each res
              modRadioSub.InsertRadioTestOrder($rData4["fldencounterval"], res["fldtestid"], res["fldtesttype"], res["fldactive"], $rData4["fldid"], modGeneral.GetUserFullNamePrint(res2["fldrefer"]), res2["fldbillno"], res2["fldreason"], plandate, xformat)
            Next
          Endif
        Next

        If $InvoiceFormat = True Then
          txtencid.Text = $rData3["fldbillno"]
        Else
          txtencid.Text = $rData3["fldencounterval"]
        Endif
        res1 = modDatabase.$myConn.Edit($tblpatbilling, "fldid=&1", $rData4["fldid"])
        res1["fldsample"] = "Sampled"
        res1["fldpayto"] = btnpayto.Tag
        res1["fldhostmac"] = CGI["REMOTE_ADDR"] & ":" & CGI["REMOTE_PORT"]
        res1["xyz"] = False
        res1.Update()
        modDatabase.$myConn.Commit

        If $InvoiceFormat = True Then
          $encid = $rData4["fldencounterval"]
          BasicInfoPatient()
          txtlabbill.Text = txtencid.Text
          ShowSampledBill($encid, txtlabbill.Text)
          ShowNewInvoiceTests(txtencid.Text)
        Else
          $encid = $rData4["fldencounterval"]
          BasicInfoPatient()
          txtlabbill.Text = ""
          ShowSampled($encid)
          If rbencounter.Value = True Then
            ShowNewEncounterTests(txtencid.Text)
          Else If rbindoor.Value = True Then
            ShowNewEncSavedTests(txtencid.Text)
          Endif
        Endif

      Endif
    Endif
  Endif

Catch
  modDatabase.$myConn.Rollback
  modHelpVariable.CreateErrorReport()

End

Private Sub UpdateSampledTest()

  Dim resx As Result

  Dim res As Result
  Dim res1 As Result
  Dim j As Integer
  Dim res2 As Result

  If GridView4.Selection.Count Then
    If Message.Question("Are you sure to alter the selected Test addition ?", ("No"), ("Yes")) = 2 Then
      $rData4.MoveTo(GridView4.Selection[0])
      resx = modDatabase.$myConn.Edit("tblpatradiotest", "fldgroupid=&1 and fldstatus=&2", $rData4["fldid"], "Sampled")
      If resx.Available Then

        res2 = modDatabase.$myConn.Exec("select flditemqty,fldretqty,fldbillno,fldrefer,fldreason from " & $tblpatbilling & " where fldid=&1", $rData4["fldid"])
        If res2["flditemqty"] > res2["fldretqty"] Then
          res = modDatabase.$myConn.Exec("select fldtestid,fldtesttype,fldactive from tblgroupradio where fldgroupname=&1 and fldptsex=&2", $rData4["flditemname"], cmbformat.Text)
          If res.Available = True Then

            modDatabase.$myConn.Begin
            For Each res
              For j = 1 To (res2["flditemqty"] - res2["fldretqty"])
                modRadioSub.InsertRadioTestOrder($rData4["fldencounterval"], res["fldtestid"], res["fldtesttype"], res["fldactive"], $rData4["fldid"], modGeneral.GetUserFullNamePrint(res2["fldrefer"]), res2["fldbillno"], res2["fldreason"], dtplan.Value, cmbformat.Text)
              Next
            Next
            If $InvoiceFormat = True Then
              txtencid.Text = resx["fldbillno"]
            Else
              txtencid.Text = resx["fldencounterval"]
            Endif
            res1 = modDatabase.$myConn.Edit($tblpatbilling, "fldid=&1", $rData4["fldid"])
            res1["fldsample"] = "Sampled"
            res1["fldpayto"] = btnpayto.Tag
            res1["fldhostmac"] = CGI["REMOTE_ADDR"] & ":" & CGI["REMOTE_PORT"]
            res1["xyz"] = False
            res1.Update()

            For Each resx
              resx["fldstatus"] = "Cancelled"
              resx["flduserid_report"] = modBasic.$lbluser
              resx["fldtime_report"] = ""
              resx["fldcomp_report"] = modBasic.$compID
              resx.Update
            Next
            modDatabase.$myConn.Commit

          Endif

          If $InvoiceFormat = True Then
            $encid = $rData4["fldencounterval"]
            BasicInfoPatient()
            txtlabbill.Text = txtencid.Text
            ShowSampledBill($encid, txtlabbill.Text)
            ShowNewInvoiceTests(txtencid.Text)
          Else
            $encid = $rData4["fldencounterval"]
            BasicInfoPatient()
            txtlabbill.Text = ""
            ShowSampled($encid)
            If rbencounter.Value = True Then
              ShowNewEncounterTests(txtencid.Text)
            Else If rbindoor.Value = True Then
              ShowNewEncSavedTests(txtencid.Text)
            Endif
          Endif
        Endif

      Endif
    Endif
  Endif

Catch
  modDatabase.$myConn.Rollback
  modHelpVariable.CreateErrorReport()

End

Public Sub mnuadd_Click()

  If cmbformat.Text Then
    If rbwaiting.Value = True Then
      AddSampling(dtplan.Value, cmbformat.Text)
    Else If rbadded.Value = True Then
      UpdateSampledTest()
    Endif
  Endif
  btnformatlist.Tag = ""

End

Public Sub mnudel_Click()

  Dim res As Result
  Dim xmsg As String
  Dim xcashcrd As Float

  xmsg = InputBox("Reason for Cancellation", "Radiology", "")
  If GridView4.Selection.Count Then
    $rData4.MoveTo(GridView4.Selection[0])
    If xmsg Then

      If modBasic.$BillAutoReturn = "No" Then
        Message.Warning("Not allowed", "OK")
      Else
        modDatabase.$myConn.Begin
        res = modDatabase.$myConn.Edit($tblpatbilling, "fldid=&1", $rData4["fldid"])
        If res.Available = True Then
          If res["fldcashincredit"] Then
            xcashcrd = res["fldcashincredit"]
          Else
            xcashcrd = 0
          Endif
          modBillings.InsertBlankBillItemNewApp(res["fldencounterval"], res["fldbilltype"], res["fldbillingmode"], res["flddisctype"], res["fldacledger"], res["flditemtype"], res["flditemno"], res["flditemname"], res["flditemrate"], 0 - res["flditemqty"], res["fldtaxper"], res["flddiscper"], xcashcrd, "Done", res["fldid"], True, False, res["fldtarget"], res["fldpayto"], res["fldrefer"], Trim(xmsg), res["fldbillno"])
          res["fldsample"] = "Removed"
          res["fldretqty"] = res["flditemqty"]
          res["xyz"] = False
          res.Update()
        Endif
        modDatabase.$myConn.Commit
      Endif

      ShowNewEncounterTests($rData3["fldencounterval"])
    Endif
  Endif

Catch
  modDatabase.$myConn.Rollback
  modHelpVariable.CreateErrorReport()

End

Public Sub btnaddmenu_Menu()

  mnutest.Popup(btnaddmenu)

End

Public Sub mnutransf_Click()

  Dim res As Result
  Dim xx As String

  If GridView4.Selection.Count Then
    $rData4.MoveTo(GridView4.Selection[0])
    xx = InputCombo(("Enter Target Location"), ("Transfer"), modBasic.$AllCompList, "", True)
    If xx Then
      res = modDatabase.$myConn.Edit($tblpatbilling, "fldid=&1", $rData4["fldid"])
      res["fldtarget"] = xx
      res["xyz"] = False
      res.Update()
      If xx <> modBasic.$compID Then
        ShowNewEncounterTests($rData3["fldencounterval"])
      Endif
    Endif
  Endif

End

Public Sub btnselectuser_Click()

  Dim xMedUser As String[]

  xMedUser = MedicalSelectedValue(("Select Payable User"), modBasic.$PayUserList)
  If xMedUser And If xMedUser.Count Then
    btnpayto.Tag = xMedUser[0]
    btnpayto.Text = xMedUser[1]
  Else
    btnpayto.Tag = ""
    btnpayto.Text = ""
  Endif

End

Public Sub btnpayto_Change()

  If btnpayto.Text = "" Then
    btnpayto.Tag = ""
  Endif

End

Public Sub mnublank_Click()

  Me.Parent.DeleteChildren()
  modGeneralMain.LoadRadioReporting()

End

Public Sub mnuaddtest_Click()

  Dim xx As String[]
  Dim xitem As String

  If txtencid.Text Then
    xx = GridListView(("Select requested Tests"), modMedicine.FillRadioTestCombo("%"))
    If xx And If xx.Count Then
      For Each xitem In xx
        modRadioSub.InsertRadioTestOrder(Trim(txtencid.Text), xitem, modFixRadio.GetRadioTestType(xitem), "Regular", 0, "", "", "", "", "")
      Next
      ShowSampled(Trim(txtencid.Text))
    Endif
  Endif

End

Public Sub mnuaddgroup_Click()

  Dim xList As String[]
  Dim xformat As String
  Dim xitem As String
  Dim res As Result
  Dim xmode As String

  If txtencid.Text Then
    xmode = $BillMode
    If xmode Then
      xitem = GridViewNew(("Select requested Test Groups"), modNonMedical.NonStockBillingItemArray("Radio Diagnostics", xmode), False)
      If xitem Then
        xList = modControlSub.GetDirectFillresult(modDatabase.$myConn.Exec("select distinct(fldptsex) as col from tblgroupradio where fldgroupname=&1", xitem))
        xformat = InputCombo("Select Format", xitem, xList, "", True)
        If xformat Then

          modDatabase.$myConn.Begin
          res = modDatabase.$myConn.Exec("select fldtestid,fldtesttype,fldactive from tblgroupradio where fldgroupname=&1 and fldptsex=&2", xitem, xformat)
          If res.Available = True Then
            For Each res
              modRadioSub.InsertRadioTestOrder(Trim(txtencid.Text), res!fldtestid, res!fldtesttype, res!fldactive, 0, "", "", "", "", xformat)
            Next
          Endif
          modDatabase.$myConn.Commit
          ShowSampled(Trim(txtencid.Text))

        Endif
      Endif
    Endif
  Endif

Catch
  modDatabase.$myConn.Rollback
  modHelpVariable.CreateErrorReport()

End

Public Sub mnusearchpat_Click()

  If Not txtencid.Text Then
    txtencid.Text = PatSearch("Encounter")
  Endif

End

Public Sub mnulastencid_Click()

  txtencid.Text = modSettings.ShowLogValues("LastValue/Encounter")

End

''---------------------------- Added Grids -------------------------
Public Sub btnrefresh_Click()

  FillSamplingEncounters()
  ShowSampled("")

End

Private Sub FillSamplingEncounters()

  Dim sql As String
  Dim xdate As String
  Dim xcateg As String

  If chkdate.Value = True Then
    xdate = " and fldnewdate>=&4 and fldnewdate<=&5"
  Else
    xdate = ""
  Endif

  If cmbcategory.Text = "%" Then
    xcateg = ""
  Else
    xcateg = " and fldtestid in(select fldexamid from tblradio where fldcategory like &6)"
  Endif

  If rbencounter.Value = True Then
    sql = "select fldencounterval,fldencounterval,fldencounterval,fldencounterval,fldtestid,fldnewdate,fldid,fldnewdate from tblpatradiotest where fldstatus=&1 and fldsave_report=&2 and fldcomp_report=&3" & xdate & xcateg                                        ''
  Else If rbinvoice.Value = True Then
    sql = "select fldbillno,fldencounterval,fldencounterval,fldencounterval,fldtestid,fldnewdate,fldid,fldnewdate from tblpatradiotest where fldstatus=&1 and fldsave_report=&2 and fldcomp_report=&3" & xdate & xcateg
  Else If rbindoor.Value = True Then
    sql = "select fldencounterval,fldencounterval,fldencounterval,fldencounterval,fldtestid,fldnewdate,fldid,fldnewdate from tblpatradiotest where fldstatus=&1 and fldsave_report=&2 and fldcomp_report=&3" & xdate & xcateg                                        ''
  Endif
  $rData2 = modDatabase.$myConn.Exec(sql, "Sampled", False, modBasic.$compID, modDate.StartSqlDate(dtsort.value), modDate.EndSqlDate(dtsort.value), cmbcategory.Text)
  $aMyFields2 = New String[]
  modGridView.ReadSmallData(GridView2, $rData2, $aMyFields2)
  With GridView2
    .Columns[0].Width = CStr(100 * modBasic.$AppWidthRatio) & "px"
    .Columns[1].Width = CStr(10 * modBasic.$AppWidthRatio) & "px"
    .Columns[2].Width = CStr(150 * modBasic.$AppWidthRatio) & "px"
    .Columns[3].Hidden = True
    .Columns[4].Width = CStr(150 * modBasic.$AppWidthRatio) & "px"
    .Columns[5].Width = CStr(150 * modBasic.$AppWidthRatio) & "px"
    .Columns[6].Hidden = True
    .Columns[7].Hidden = True

    .Columns[0].Text = "EncID"
    .Columns[2].Text = "Name"
    .Columns[4].Text = "TestName"
    .Columns[5].Text = "PlanDate"
  End With

End

Public Sub GridView2_Data(Row As Integer, Column As Integer, Data As WebTableData)

  $rData2.MoveTo(Row)
  modGridView.GridViewDecoration(Data, Row)
  If Column = 1 Then
    Data.Text = ""
    Data.Background = modPatient.GetPatientColor($rData2[$aMyFields2[Column]])
  Else If Column = 2 Then
    Data.Text = modPatient.GetPatientNameByEnc($rData2[$aMyFields2[Column]])
  Else If Column = 5 Then
    Data.Text = modReportVar.GetDateTimeReport($rData2[$aMyFields2[Column]], gb.GeneralDate)
  Else
    Data.Text = $rData2[$aMyFields2[Column]]
  Endif

End

Public Sub GridView2_Select()

  Dim xstatus As String

  If GridView2.Selection.Count Then
    $rData2.MoveTo(GridView2.Selection[0])
    modRepository.$RepoDataStatus = False
    If rbencounter.Value = True Then
      txtencid.Text = $rData2["fldencounterval"]
    Else If rbinvoice.Value = True Then
      txtencid.Text = $rData2["fldbillno"]
    Else If rbindoor.Value = True Then
      txtencid.Text = $rData2["fldencounterval"]
    Endif
    $encid = $rData2["fldencounterval"]
    $PatientNum = modPatient.GetPatientNoByEnc($encid)
    txtpatientname.Text = modPatient.GetPatientNameByEnc($encid)
    txtgender.Text = modPatient.GetPatientAgeString($encid, Now()) & "/" & modPatient.GetPatientSex($encid)
    txtpatientaddress.Text = modPatient.GetPatientAddressByEnc($encid)

    xstatus = modPatient.CurrentAdmissionStatus($encid)
    txtlocation.Text = modPatient.GetLocationSetting($encid, xstatus)
    ShowGridMain()
  Endif

End

Private Sub ShowGridMain()

  If rbencounter.Value = True Then
    ShowSampled($encid)
  Else If rbinvoice.Value = True Then
    ShowSampledBill($encid, Trim(txtencid.Text))
  Else If rbindoor.Value = True Then
    ShowSampled($encid)
  Endif

End

Public Sub mnueditdate_Click()

  Dim res As Result
  Dim xdate As Date

  If GridView2.Selection.Count Then
    $rData.MoveTo(GridView2.Selection[0])

    xdate = GetDateValue(("Select Plan Date for ") & $rData2["fldtestid"], $rData2["fldencounterval"], $rData2["fldnewdate"])
    If xdate Then
      res = modDatabase.$myConn.Edit("tblpatradiotest", "fldid=&1", $rData2["fldid"])
      res["fldnewdate"] = xdate
      res["xyz"] = False
      res.Update
      FillSamplingEncounters()
    Endif

  Endif

End

Public Sub btnexpotree_Click()

  modCHTMLReport.ExportGridToHTML(GridView2, "RADIOLOGY PLAN: " & cmbcategory.Text, modReportVar.GetDateTimeReport(Now(), gb.GeneralDate))

End

''------------------------------------------ patient profile -------------------------------------
Public Sub btnshow_Click()

  If Not txtencid.Text Then Return
  If modBasic.$EncIdPrefix And If txtencid.Text = modBasic.$EncIdPrefix Then
    txtencid.SetFocus
    Return
  Endif

  If txtencid.Text Then
    modRepository.$RepoDataStatus = False
    If rbencounter.Value = True Then
      txtlabbill.Text = ""
      $InvoiceFormat = False
      $encid = Trim(txtencid.Text)
      BasicInfoPatient()
      ShowSampled($encid)
    Else If rbinvoice.Value = True Then
      txtlabbill.Text = Trim(txtencid.Text)
      $InvoiceFormat = True
      $encid = modNonMedical.GetEncounterFromBillNo(txtencid.Text)
      BasicInfoPatient()
      ShowSampledBill($encid, txtlabbill.Text)
    Else If rbindoor.Value = True Then
      txtlabbill.Text = ""
      $InvoiceFormat = False
      $encid = Trim(txtencid.Text)
      BasicInfoPatient()
      ShowSampled($encid)
    Endif
  Endif

End

Private Sub BasicInfoPatient()

  Dim xstatus As String

  txtpatientname.Text = modPatient.GetPatientNameByEnc($encid)
  txtgender.Text = modPatient.GetPatientAgeString($encid, Now()) & "/" & modPatient.GetPatientSex($encid)
  txtpatientaddress.Text = modPatient.GetPatientAddressByEnc($encid)

  $PatientNum = modPatient.GetPatientNoByEnc($encid)
  xstatus = modPatient.CurrentAdmissionStatus($encid)
  txtlocation.Text = modPatient.GetLocationSetting($encid, xstatus)
  txtcolor.Background = modPatient.GetPatientColor($encid)
  $package = modNonMedical.DefaultBillingScheme($encid, modBasic.$compID)
  $BillMode = modNonMedical.GetDiscBindBillMode($package)
  If Not $BillMode Then
    $billMode = modPatient.GetPatBillingMode($encid)
  Endif
  modAppSupport.RecordPatientActivity("Patient Data", Me.Name, "EncounterID", $encid)

End

Public Sub btnwebcam_Click()

  If Not txtencid.Text Then
    txtencid.Text = QRScanValue("")
  Endif

End

'''------------------------------------------ added tests -------------------------------------------
Private Sub ShowSampled(encid As String)

  Dim sql As String

  If chkall.Value = False Then
    sql = "select fldid,fldchk,fldtestid,fldreportquali,flvisible,fldsampletype,fldreportquanti,fldtest_type,fldmethod,fldcondition,fldcomment,fldtime_report,fldencounterval,fldstatus,fldabnormal,fldpacstudy,fldgroupid,fldsampleid,fldreportquali,fldbillno,fldnewdate from tblpatradiotest where (fldstatus=&1 or fldstatus=&2) and fldencounterval=&3 and fldcomp_report=&4"
    $rData = modDatabase.$myConn.Exec(sql, "Ordered", "Sampled", encid, modBasic.$compID)
  Else
    sql = "select fldid,fldchk,fldtestid,fldreportquali,flvisible,fldsampletype,fldreportquanti,fldtest_type,fldmethod,fldcondition,fldcomment,fldtime_report,fldencounterval,fldstatus,fldabnormal,fldpacstudy,fldgroupid,fldsampleid,fldreportquali,fldbillno,fldnewdate from tblpatradiotest where (fldstatus=&1 or fldstatus=&2 or fldstatus=&3) and fldencounterval=&4 and fldcomp_report=&5"
    $rData = modDatabase.$myConn.Exec(sql, "Ordered", "Sampled", "Reported", encid, modBasic.$compID)
  Endif
  FillSamplingGrid()

End

Private Sub ShowSampledBill(encid As String, billno As String)

  Dim sql As String

  If chkall.Value = False Then
    sql = "select fldid,fldchk,fldtestid,fldreportquali,flvisible,fldsampletype,fldreportquanti,fldtest_type,fldmethod,fldcondition,fldcomment,fldtime_report,fldencounterval,fldstatus,fldabnormal,fldpacstudy,fldgroupid,fldsampleid,fldreportquali,fldbillno,fldnewdate from tblpatradiotest where (fldstatus=&1 or fldstatus=&2) and fldencounterval=&3 and fldcomp_report=&4 and fldbillno=&5"
    $rData = modDatabase.$myConn.Exec(sql, "Ordered", "Sampled", encid, modBasic.$compID, billno)
  Else
    sql = "select fldid,fldchk,fldtestid,fldreportquali,flvisible,fldsampletype,fldreportquanti,fldtest_type,fldmethod,fldcondition,fldcomment,fldtime_report,fldencounterval,fldstatus,fldabnormal,fldpacstudy,fldgroupid,fldsampleid,fldreportquali,fldbillno,fldnewdate from tblpatradiotest where (fldstatus=&1 or fldstatus=&2 or fldstatus=&3) and fldencounterval=&4 and fldcomp_report=&5 and fldbillno=&6"
    $rData = modDatabase.$myConn.Exec(sql, "Ordered", "Sampled", "Reported", encid, modBasic.$compID, billno)
  Endif
  FillSamplingGrid()

End

Private Sub FillSamplingGrid()

  $aMyFields = New String[]
  modGridView.ReadSmallData(GridView1, $rData, $aMyFields)

  With GridView1
    .Columns[0].Hidden = True
    .Columns[1].Hidden = True
    .Columns[2].Width = CStr(225 * modBasic.$AppWidthRatio) & "px"
    .Columns[3].Width = CStr(225 * modBasic.$AppWidthRatio) & "px"
    .Columns[4].Width = CStr(75 * modBasic.$AppWidthRatio) & "px"
    .Columns[5].Width = CStr(100 * modBasic.$AppWidthRatio) & "px"
    .Columns[6].Hidden = True
    .Columns[7].Hidden = True
    .Columns[8].Width = CStr(125 * modBasic.$AppWidthRatio) & "px"
    .Columns[9].Hidden = True
    .Columns[10].Hidden = True
    .Columns[11].Width = CStr(150 * modBasic.$AppWidthRatio) & "px"
    .Columns[12].Hidden = True
    .Columns[13].Hidden = True
    .Columns[14].Hidden = True
    .Columns[15].Hidden = True
    .Columns[16].Hidden = True
    .Columns[17].Width = CStr(125 * modBasic.$AppWidthRatio) & "px"
    .Columns[18].Hidden = True
    .Columns[19].Width = CStr(150 * modBasic.$AppWidthRatio) & "px"
    .Columns[20].Hidden = True

    .Columns[2].Text = "Examination"
    .Columns[3].Text = "Observation"     ''5
    .Columns[4].Text = "Visible" ''4
    .Columns[5].Text = "EvalSite"      ''3
    .Columns[8].Text = "Method"
    .Columns[11].Text = "ReportDate"
    .Columns[17].Text = "Index"
    .Columns[19].Text = "Invoice"
  End With

  ' modGridView.SetLabReportIcon(GridView1, 13, 14, 3)

End

Public Sub GridView1_Data(Row As Integer, Column As Integer, Data As WebTableData)

  $rData.MoveTo(Row)
  modGridView.GridViewDecoration(Data, Row)
  If Column = 11 Then
    Data.Text = modReportVar.GetDateTimeReport($rData[$aMyFields[Column]], gb.GeneralDate)
  Else
    Data.Text = $rData[$aMyFields[Column]]
  Endif

End

Public Sub btnflag_Click()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
  Endif

End

Public Sub btnvisible_Click()

  Dim xopt As String[] = ["Visible", "Hidden"]
  Dim xx As String
  Dim res As Result

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xx = InputCombo("Set Visibility", $rData["fldtestid"], xopt, $rData["flvisible"], True)
    If xx Then
      res = modDatabase.$myConn.Edit("tblpatradiotest", "fldid=&1", $rData["fldid"])
      res["flvisible"] = xx
      res["xyz"] = False
      res.Update
      ShowGridMain()
    Endif
  Endif

End

Public Sub btnspecimen_Click()

  Dim xx As String
  Dim res As Result
  Dim xspec As String[]

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xspec = New String[]
    xx = InputCombo("Set Site of Evaluation Site", $rData["fldtestid"], xspec, $rData["fldsampletype"], False)
    If xx Then
      res = modDatabase.$myConn.Edit("tblpatradiotest", "fldid=&1", $rData["fldid"])
      res["fldsampletype"] = xx
      res["xyz"] = False
      res.Update
      ShowGridMain()
    Endif
  Endif

End

Public Sub btnmethod_Click()

  Dim xx As String

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xx = InputCombo(("Select Test Method"), ("Test Method"), modFixLab.GetTestExamEquipments("Radio"), $rData["fldmethod"], True)
    If xx Then
      modRadioSub.UpdateEquipmenRadiotMethod($rData["fldid"], xx)
      ShowGridMain()
    Endif
  Endif

End

Public Sub btnshowcomponents_Click()

  UpdateRadioValue()

End

Private Sub AddSubTestData()

  Dim rs As Result
  Dim rsx As Result

  rs = modDatabase.$myConn.Exec("select fldid,fldsubtest from tblpatradiosubtest where fldtestid=&1", $rData["fldid"])
  If rs.Available = False Then
    Select modFixRadio.GetRadioTestOption($rData["fldtestid"])
      Case "Fixed Components", "Left/Right Components"
        rsx = modDatabase.$myConn.Exec("select fldsubexam,fldtanswertype,fldindex from tblradioquali where fldexamid=&1 GROUP BY fldsubexam", $rData["fldtestid"])
        If rsx.Available Then
          For Each rsx
            modRadioSub.InsertRadioSubTestUnit($rData["fldencounterval"], $rData["fldid"], $rData["fldtestid"], rsx["fldsubexam"], rsx["fldtanswertype"], rsx["fldindex"])
          Next
        Endif
    End Select
  Endif

End

Private Sub UpdateRadioValue()

  Dim yqualival As Variant[]
  Dim xquantival As Variant[]
  Dim hForm3 As FmEnterMultiple
  Dim hFormTwo As FmEnterMultipleTwo
  Dim res As Result
  Dim sql As String
  Dim xData As Variant[]
  Dim xType As String
  Dim xdate As Date

  Dim xmax As Float
  Dim xmin As Float

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])

    If $rData["fldtest_type"] = "Qualitative" Then
      AddSubTestData()

      xType = modFixRadio.GetRadioTestOption($rData["fldtestid"])
      sql = "select fldid,fldsubtest,fldreport,fldtanswertype,fldabnormal,fldindex from tblpatradiosubtest where fldtestid=&1" & modRadioSub.GetRadioRepoOrder("SubTest")
      res = modDatabase.$myConn.Exec(sql, $rData["fldid"])
      If res.Available = False Then
        If xType = "Clinical Scale" Then
          yqualival = modExamOption.GetClinScalePopUp("Radio", $rData["fldtestid"])
          If yqualival Then
            ' modRadioSub.UpdateRadioTestReportQuali($rData["fldid"], yqualival[0], yqualival[1], yqualival[2])
          Endif
        Else If xType = "Left and Right" Then
          yqualival = CLeftRight($rData["fldtestid"], $rData["fldreportquali"], modFixClinic.GetLeftRightMainHeader("Radio", $rData["fldtestid"]))
          If yqualival Then
            modRadioSub.UpdateRadioTestReportQuali($rData["fldid"], yqualival[0], yqualival[1], "")
          Endif
        Else If xType = "Date Time" Then
          xdate = GetDateValue($rData["fldtestid"], ("Select Date Time"), Val($rData["fldreportquali"]))
          If xdate Then
            modRadioSub.UpdateRadioTestReportQuali($rData["fldid"], modDate.DateStringForExam(xdate), False, "")
          Endif
        Else If xType = "BS Date" Then
          xdate = GetDateValue($rData["fldtestid"], ("Select Date Time"), modDate.ConvertToEnglishdate($rData["fldreportquali"]))
          If xdate Then
            modRadioSub.UpdateRadioTestReportQuali($rData["fldid"], modDate.ConvertToLocaldate(xdate), False, "")
          Endif
        Else If xType = "Qualitative" Then
          yqualival = GetQualiString($rData["fldtestid"], $rData["fldreportquali"], "Radio")
          If yqualival Then
            modRadioSub.UpdateRadioTestReportQuali($rData["fldid"], yqualival[0], yqualival[1])
          Endif
        Else If xType = "RichText Area" Then
          yqualival = GetQualiRich($rData["fldtestid"], $rData["fldreportquali"], "Radio")
          If yqualival Then
            modRadioSub.UpdateRadioTestReportQuali($rData["fldid"], yqualival[0], yqualival[1], yqualival[2])
          Endif
        Else
          yqualival = GetQualiValues($rData["fldtestid"], $rData["fldreportquali"], "Radio")
          If yqualival Then
            modRadioSub.UpdateRadioTestReportQuali($rData["fldid"], yqualival[0], yqualival[1], yqualival[2])
          Endif
        Endif

      Else If res.Available = True Then
        xData = New Variant[]
        res.MoveFirst
        For Each res
          xData.Add([res["fldsubtest"], res["fldreport"], res["fldid"], res["fldtanswertype"], res["fldabnormal"], res["fldindex"]])
        Next
        xData.Add(["Final Impression", $rData["fldreportquali"], 0, "RichText Area", False, ""])
        If xType = "Left/Right Components" Then
          hFormTwo = New FmEnterMultipleTwo($rData["fldid"], "Radio", $rData["fldtestid"], xData, "", "Current")
          hFormTwo.ShowModal
        Else
          hForm3 = New FmEnterMultiple($rData["fldid"], "Radio", $rData["fldtestid"], xData, "", "Current")
          hForm3.ShowModal
        Endif
      Endif

    Else If $rData["fldtest_type"] = "Quantitative" Then
      xmax = modRadioTest.GetMaxQuantiRadioVal($rData["fldtestid"], $encid)
      xmin = modRadioTest.GetMinQuantiRadioVal($rData["fldtestid"], $encid)
      xquantival = GetQuantiValues("Radio", Trim(txtencid.Text), $rData["fldtestid"], xmin, xmax, $rData["fldreportquanti"])
      If xquantival Then
        modRadioSub.UpdateRadioTestReportQuanti($rData["fldid"], xquantival[0], xquantival[1])
      Endif

    Endif

    ShowGridMain()
  Endif

End

''-------------------------------- button report ----------------------------------
Public Sub btnrepo_Click()

  Dim hCls As CReportCustom

  If $encid Then
    If modSettings.ShowSettingFromFIle("Diagnostic Help/Name") Then
      hCls = New CReportCustom($encid, "Diagnostic Help", "ReportSize", MMain.$defUnit)
      hCls.Preview()
    Endif
  Endif

End

Public Sub btnpacs_Click()

  Dim hForm As FmPacsShow

  If txtencid.Text Then
    hForm = New FmPacsShow($encid, "History")
    hForm.ShowModal
  Endif

End

Public Sub mnuopenview_Click()

  If $sPath Then
    Me.Exec("window.open('" & $sPath & "'); ")
  Endif

End

Public Sub btnplay_Click()

  Dim res As Result
  Dim xserver As String
  Dim hForm As FmPacsShow

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    If $rData["fldpacstudy"] Then

      res = modDatabase.$myConn.Exec("select fldpacstudy,fldpacseries,fldpacsform from tblpatradiotest where fldid=&1", $rData["fldid"])
      If res.Available Then
        If res["fldpacseries"] Then
          xserver = InputCombo("Select PACS Node to Use", "PACS", modMisc.GetPacsServerList(), "", True)
          If xserver Then
            modpacs.GetPacsSetting(xserver)
            $sPath = modPACS.DicomSeriesWebView(res["fldpacsform"], $encid, res["fldpacstudy"], res["fldpacseries"])
            mnuopenview_Click()
          Endif
        Endif
      Endif

    Else
      hForm = New FmPacsShow($encid, CStr($rData["fldid"]))
      hForm.ShowModal
      ShowGridMain()

    Endif
  Endif

End

Public Sub mnulocal_Click()

  Dim xPath As String
  Dim xpatno As String

  If txtencid.Text Then
    xpatno = $PatientNum
    If modPatientSub.GetPatPassCheck(modDatabase.$myConn, xpatno) = True Then
      xPath = modCHTMLPatient.ShowPatRadioReportAllEnc($encid)
      modControlSub.OpenHTMLPreview($encid, xPath, "ReportSize")
    Endif
  Endif

End

Public Sub mnuremote_Click()

  Dim xPath As String
  Dim xpatno As String
  Dim sCon As Connection
  Dim xCon As Connection

  If txtencid.Text Then
    xpatno = $PatientNum

    If modPatientSub.GetPatPassCheck(modDatabase.$myConn, xpatno) = True Then
      sCon = modDatabase.$myConn
      xCon = modDatabase.$syConn
      modRepository.TransferRemoConn(xpatno)
      xPath = modCHTMLPatient.ShowPatRadioReportAllEnc($encid)
      modControlSub.OpenHTMLPreview($encid, xPath, "ReportSize")
      modDatabase.$myConn = sCon
      modDatabase.$syConn = xCon
      MMain.InitialAppMode()
    Endif

  Endif

End

Public Sub btnrepoall_Click()

  Dim hForm As FmRadioRepPrint

  If txtencid.Text Then
    modGeneralMain.$LastEncounterID = Trim(txtencid.Text)
    Try Me.Parent.DeleteChildren()
    hForm = New FmRadioRepPrint(modGeneralMain.$LastEncounterID, fmTechnician.Workspace1)
  Endif

End

Public Sub btnhistory_Menu()

  mnuhistory.Popup(btnhistory)

End

Public Sub btnfullrep_Click()

  If txtencid.Text Then
    modCHTMLReport.ExportGridToHTML(GridView1, "", "RADIOLOGY REPORTING",, txtencid.Text)
  Endif

End

Public Sub btncomponent_Click()

  Dim xxx As String[]
  Dim yyy As String[]

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    If modFixRadio.GetRadioTestOption($rData["fldtestid"]) = "Custom Components" Then
      xxx = modControlSub.GetDirectFillresult(modDatabase.$myConn.Exec("select distinct(fldsubexam) as col from tblradioquali where fldexamid=&1 ORDER BY fldindex", $rData["fldtestid"]))
      yyy = GridListView(("Select Components"), xxx)
      If yyy And If yyy.Count Then
        modRadioSub.InsertRadioSubTest($rData["fldencounterval"], $rData["fldid"], $rData["fldtestid"], yyy)
      Endif
    Endif
  Endif

End

Public Sub btncondi_Click()

  Dim xx As String

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xx = GetTextArea(("Condition"), $rData["fldcondition"])
    If xx Then
      modRadioSub.UpdateConditionRadio($rData["fldid"], xx)
      ShowGridMain()
    Endif
  Endif

End

Public Sub btncomment_Click()

  Dim xx As String
  Dim res As Result

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xx = GetTextArea($rData["fldtestid"], $rData["fldcomment"])
    If xx Then
      res = modDatabase.$myConn.Edit("tblpatradiotest", "fldid=&1", $rData["fldid"])
      res["fldcomment"] = xx
      res["xyz"] = False
      res.Update
      ShowGridMain()
    Endif
  Endif

End

Public Sub btnrefer_Click()

  Dim res As Result
  Dim xx As String
  Dim reflist As String

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    reflist = modSettings.ShowSettingFromFIle("Laboratory/ReferralList")
    If reflist Then
      If Exist(reflist) Then
        xx = InputCombo(("Enter Referral Name"), ("Referral"), modString.GetStringArrayFromFile(reflist), $rData["fldmethod"], False)
      Endif
    Else
      xx = InputBox(("Enter Referral Name"), ("Referral"), $rData["fldmethod"])
    Endif

    If xx Then
      res = modDatabase.$myConn.Edit("tblpatradiotest", "fldid=&1", $rData["fldid"])
      res["fldrefername"] = xx
      res["xyz"] = False
      res.Update
      ShowSampled(Trim(txtencid.Text))
    Endif
  Endif

End

Public Sub btnimage_Click()

  Dim hForm As FmTestImage

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmTestImage("IMAGE", $encid, $rData["fldid"], $rData["fldtestid"], "Radiology", "")
    hForm.ShowModal
  Endif

End

Public Sub btndicom_Click()

  Dim hForm As FmTestImage

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    hForm = New FmTestImage("DICOM", $encid, $rData["fldid"], $rData["fldtestid"], "Radiology", "")
    hForm.ShowModal
  Endif

End

Public Sub btnsms_Click()

  Dim xmsg As String

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xmsg = modDevice.SendSMSLabPatient($encid, $rData["fldtestid"], modRadioTest.GetRadioTestValueString($rData["fldid"], False))
  Endif
  If xmsg Then
    Message.Info(xmsg, ("OK"))
  Endif

End

Public Sub mnudemog_Click()

  Dim hForm As FmPatdemograph

  If txtencid.Text Then
    hForm = New FmPatdemograph($encid, "Clinical")
    hForm.ShowModal
  Endif

End

''============================= Professional involved ====================================
Public Sub GridView1_Select()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    $ProcBill = $rData["fldgroupid"]
    ShowShareUsers($ProcBill)
  Endif

End

Private Sub ShowShareUsers(sID As Long)

  Dim res As Result

  $sBillMode = ""
  $sItemName = ""
  $PositionList = New String[]
  If sID Then
    res = modDatabase.$myConn.Exec("select fldencounterval,fldbillingmode,flditemtype,flditemname from " & $tblpatbilling & " where fldid=&1 and fldencounterval=&2", sID, $encid)
    If res.Available Then
      $sBillMode = res["fldbillingmode"]
      $sItemName = res["flditemname"]
      $PositionList = modControlSub.GetDirectFillresult(modDatabase.$myConn.Exec("select distinct(fldusertype) as col from tblprocedureshare where flditemtype=&1 and fldbillingmode like &2 and (flditemname like &3 or flditemname=&4) and fldactive=&5", "Radio Diagnostics", res["fldbillingmode"], res["flditemname"], "%", "Active"))
      ShowSurgUser()
      btnaddperson.Enabled = True
    Endif
  Endif

End

' Public Sub cmbpertype_KeyRelease()
'
'   modFillContainer.AutoFillComboBox(cmbpertype)
'   modFillContainer.RestrictComboToContent(cmbpertype)
'
' End

Public Sub cmbpertype_Click()

  Dim xval As String

  If cmbpertype.Text Then
    xval = GetDefaultUser(cmbpertype.Text)
    If xval Then
      btnaddconsult.Tag = xval
      btnaddconsult.Text = modGeneral.GetUserFullName(btnaddconsult.Tag)
      btnaddconsult.Enabled = False
      btnselectadd.Enabled = False
    Endif
  Endif

End

Private Function GetDefaultUser(xUserType As String) As String

  Dim res As Result
  Dim xval As String

  If $ProcBill Then
    res = modDatabase.$myConn.Exec("select flddefault from tblprocedureshare where flditemtype=&1 and fldbillingmode like &2 and (flditemname like &3 or flditemname=&4) and fldactive=&5 and fldusertype=&6", "Radio Diagnostics", $sBillMode, $sItemName, "%", "Active", xUserType)
    If res.Available Then
      res.MoveFirst
      If res["flddefault"] Then
        xval = res["flddefault"]
      Else
        xval = ""
      Endif
    Else
      xval = ""
    Endif
  Endif
  Return xval

End

Public Sub btnselectadd_Click()

  Dim xMedUser As String[]

  If modBasic.$PayableUserFormat = "Restricted" Then
    xMedUser = MedicalSelectedValue(("Select Payable User"), modGeneral.CategoricalUserList("fldpayable", cmbpertype.Text))
  Else
    xMedUser = MedicalSelectedValue(("Select Payable User"), modBasic.$PayUserList)
  Endif
  If xMedUser And If xMedUser.Count Then
    btnaddconsult.Tag = xMedUser[0]
    btnaddconsult.Text = xMedUser[1]
  Else
    btnaddconsult.Tag = ""
    btnaddconsult.Text = ""
  Endif

End

Public Sub btnaddperson_Click()

  If $ProcBill Then
    If cmbpertype.Text And If btnaddconsult.Tag Then
      If Not btnpayto.Tag Then
        modPatientGeneral.AddClinicalSharingUser("Radio Diagnostics", $ProcBill, Trim(txtencid.Text), cmbpertype.Text, btnaddconsult.Tag, "", $sLevel, 100)
        ' ' modPatientGeneral.AddSubGeneralQualiData($ProcIndex, Trim(txtencid.Text), cmbpertype.Text, btnconsult.Tag, "")
        ShowSurgUser()
        cmbpertype.Text = ""
        btnaddconsult.Tag = ""
        btnaddconsult.Text = ""
        btnaddconsult.Enabled = True
        btnselectadd.Enabled = True
        cmbpertype.SetFocus
      Endif
    Endif
  Else
    Message.Warning("User Sharing can be added only after Billing", ("OK"))
  Endif

End

Private Sub ShowSurgUser()

  Dim posList As String[]

  $rDataAp = modDatabase.$myConn.Exec("select fldid,fldtime,fldusertype,fldvalue,fldreport from tblpatgenshare where flditemid=&1 and fldcategory=&2 and fldactive=&3", $ProcBill, "Radio Diagnostics", $sLevel)
  $aMyFieldsAp = New String[]
  modGridView.ReadSmallData(grdperson, $rDataAp, $aMyFieldsAp)

  posList = New String[]
  For Each $rDataAp
    posList.Add($rDataAp["fldusertype"])
  Next
  cmbpertype.List = modString.GetRemainingArray($PositionList, posList)

  With grdperson
    .Columns[0].Hidden = True
    .Columns[1].Hidden = True
    .Columns[2].Width = CStr(100 * modBasic.$AppWidthRatio) & "px"
    .Columns[3].Width = CStr(175 * modBasic.$AppWidthRatio) & "px"
    .Columns[4].Width = CStr(250 * modBasic.$AppWidthRatio) & "px"

    .Columns[2].Text = "Category"
    .Columns[3].Text = "User Name"
    .Columns[4].Text = "Description"
  End With

End

Public Sub grdperson_Data(Row As Integer, Column As Integer, Data As WebTableData)

  $rDataAp.MoveTo(Row)
  modGridView.GridViewDecoration(Data, Row)
  If Column = 3 Then
    Data.Text = modGeneral.GetUserFullName($rDataAp[$aMyFieldsAp[Column]])
  Else
    Data.Text = $rDataAp[$aMyFieldsAp[Column]]
  Endif

End

Public Sub btnpersoncomment_Click()

  Dim res As Result
  Dim xx As String

  If grdperson.Selection.Count Then
    $rDataAp.MoveTo(grdperson.Selection[0])
    xx = GetTextArea($rDataAp["fldvalue"], $rDataAp["fldreport"])
    If xx Then
      res = modDatabase.$myConn.Edit("tblpatgenshare", "fldid=&1 and fldsave=&2", $rDataAp["fldid"], True)
      res["fldreport"] = xx
      res["flduptime"] = Now()
      res["xyz"] = False
      res.Update
      ShowSurgUser()
    Endif
  Endif

End

Public Sub btnpersondelete_Click()

  If grdperson.Selection.Count Then
    $rDataAp.MoveTo(grdperson.Selection[0])
    modDatabase.$myConn.Delete("tblpatgenshare", "fldid=&1 and fldsave=&2", $rDataAp["fldid"], True)
    ShowSurgUser()
  Endif

End

''======================== Menus ===============
Public Sub mnuenc_Click()

  btnnewsearch_Click()

End

Public Sub mnuname_Click()

  btnsearname_Click()

End

Public Sub btnprefix_Click()

  Dim res As Result
  Dim xrefer As String

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    res = modDatabase.$myConn.Edit("tblpatradiotest", "fldid=&1", $rData["fldid"])
    If res["fldsampleid"] Then
      Message.Warning("Reference is " & res["fldsampleid"], "OK")
    Else

      xrefer = InputBox("Reference For this Examination", "Radiology", modRadioSub.GetRadioAutoIncreasingNo(res["fldtestid"]))
      If xrefer Then
        If res["fldsampleid"] And If $counterLst.Exist(res["fldsampleid"]) = True Then
          res["fldsampleid"] = res["fldsampleid"] & "-" & xrefer
        Else
          res["fldsampleid"] = xrefer
        Endif
        res.Update
        ShowGridMain()
      Endif

    Endif
  Endif

End

Public Sub btnbarcode_Click()

  Dim sColl As New Collection

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    If $rData["fldnewdate"] Then
      sColl.Add(modReportVar.GetDateTimeReport($rData["fldnewdate"], gb.MediumDate), "SampleBookingDate")
      modLabSub.PrintBarCodeSampling($encid, $rData["fldsampleid"], $rData["fldtestid"], $rData["fldsampletype"], txtencid.Text, sColl)
    Else
      modLabSub.PrintBarCodeSampling($encid, $rData["fldsampleid"], $rData["fldtestid"], $rData["fldsampletype"], txtencid.Text)
    Endif
  Endif

End

''================== Repository ====================
Public Sub btnupload_Click()

  Dim rsx1 As Result
  Dim rs1 As Result
  Dim hField1 As ResultField
  Dim res1 As Result

  Dim rsx2 As Result
  Dim rs2 As Result
  Dim hField2 As ResultField
  Dim res2 As Result

  Dim hForm As FmTeleRadio

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    '' import tblpatradiotest
    rsx1 = modDatabase.$myConn.Exec("select fldid from tbltelradiotest where fldtestno=&1", $rData["fldid"])
    If Not rsx1.Available Then
      rs1 = modDatabase.$myConn.Exec("select *from tblpatradiotest where fldid=&1", $rData["fldid"])
      If rs1.Available Then
        res1 = modDatabase.$myConn.Create("tbltelradiotest")
        For Each hField1 In res1.Fields
          If hField1.Name = "fldtestno" Then
            res1["fldtestno"] = rs1["fldid"]
          Else If hField1.Name = "fldreportquali" Then
            res1["fldreportquali"] = ""
          Else If hField1.Name = "fldreportquanti" Then
            res1["fldreportquanti"] = 0
          Else
            res1[hField1.Name] = rs1[hField1.Name]
          Endif
        Next
        res1.Update
      Endif
    Endif

    ''import tblpatradiosubtest
    rsx2 = modDatabase.$myConn.Exec("select fldid from tbltelradiosubtest where fldencounterval=&1 and fldtestid=&2", $encid, $rData["fldid"])
    If Not rsx2.Available Then
      rs2 = modDatabase.$myConn.Exec("select *from tblpatradiosubtest where fldencounterval=&1 and fldtestid=&2", $encid, $rData["fldid"])
      If rs2.Available Then
        For Each rs2
          res2 = modDatabase.$myConn.Create("tbltelradiosubtest")
          For Each hField2 In res2.Fields
            If hField2.Name = "fldsubtestno" Then
              res2["fldsubtestno"] = rs2["fldid"]
            Else If hField2.Name = "fldreport" Then
              res2["fldreport"] = ""
            Else
              res2[hField2.Name] = rs2[hField2.Name]
            Endif
          Next
          res2.Update
        Next
      Endif
    Endif

    hForm = New FmTeleRadio($encid, "Radio")
    hForm.ShowModal()
  Endif

End
