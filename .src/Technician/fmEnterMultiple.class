' Gambas class file

''controls
Private aWebFrame As New Object[50]
Private aWebPanel As New Object[50]
Private aIndexLabel As New Object[50]
Private aNameLabel As New Object[50]
Private aAbnormCheck As New Object[50]
Private aDelButton As New Object[50]
Private aComboBox As New Object[50]
Private aDichoValue As New Object[50]
Private aHTMLText As New Object[50]
Private aLineText As New Object[50]
Private aUnitText As New Object[50]
Private aValueBox As New Object[50]
Private aNullCheck As New Object[50]
Private aClinBox As New Object[50]
Private aTextArea As New Object[50]
Private aDateBox As New Object[50]
Private aBSDate As New Object[50]
Private aLeftRight As New Object[50]
Private aGridView As New Object[50]
Private aGridButton As New Object[50]
Private xVarGridView As New Object[50]
Private aHelpButton As New Object[50]
Private aLimitLabel As New Object[50]
Private aGenTextArea As New Object[50]
Private aBlankBox As New Object[50]
Private aWebSpace As New Object[50]
Private aInterSpace As New Object[50]
Private aCalcBox As New Object[50]
Private aCalcUnit As New Object[50]
Private aCalcNull As New Object[50]
Private aCalcLimit As New Object[50]
Private aButtonBox As New Object[50]

''other variables
Private $frm As String
Private $id As Long
Private AppFactor As Float
''lists
Private $xData As Variant[]
Private $sYear As String
Private $encid As String

Private $tblpatlabtest As String
Private $tblpatlabsubtest As String
Private $FocusTag As Integer

''----------------------------------------- create controls -----------------------------------------
Public Sub _new(id As Long, frm As String, strExam As String, xData As Variant[], xnote As String, sYear As String)

  Dim ht As String
  Dim xRepoLock As String

  $id = id
  $frm = frm
  lblitem.Text = strExam
  $xData = xData
  $sYear = sYear

  If xnote Then
    lblnote.Text = xnote
  Else
    lblnote.Visible = False
  Endif

  ht = modSettings.ShowSettingFromFIle("MultipleTextBox/Height")
  If ht Then
    Slider1.Value = CInt(ht)
  Else
    Slider1.Value = 3
  Endif

  If modBasic.$LabPrintWithEntry = "Enable" Then
    xRepoLock = modBasic.$LabOutputLock
    If xRepoLock = "Verified" Then
      pnlprint.Visible = False
    Else
      If $frm = "Test" Then
        pnlprint.Visible = True
        cmbprintform.List = ["A", "B", "C", "D"]
      Else If $frm = "Radio" Then
        pnlprint.Visible = True
        cmbprintform.List = ["A", "B", "C"]
      Else
        pnlprint.Visible = False
      Endif
    Endif
  Endif

  AppFactor = modBasic.$AppScaleFactor
  LoadTableNames()
  $encid = modMedReports.GetPatientEncFromID($tblpatlabtest, $id)
  CreateControls()

End

Private Sub LoadTableNames()

  Dim res As Result

  If $sYear = "Current" Then
    $tblpatlabtest = "tblpatlabtest"
    $tblpatlabsubtest = "tblpatlabsubtest"
  Else
    res = modDatabase.$syConn.Exec("select fldpatlabtest,fldpatlabsubtest from tblfisclosing where fldindex=&1 and (fldstate=&2 or fldstate IS NULL)", $sYear, "Active")
    If res.Available Then
      If res["fldpatlabtest"] Then
        $tblpatlabtest = res["fldpatlabtest"]
      Else
        $tblpatlabtest = "tblpatlabtest"
      Endif
      If res["fldpatlabsubtest"] Then
        $tblpatlabsubtest = res["fldpatlabsubtest"]
      Else
        $tblpatlabsubtest = "tblpatlabsubtest"
      Endif
    Else
      $tblpatlabtest = "tblpatlabtest"
      $tblpatlabsubtest = "tblpatlabsubtest"
    Endif
  Endif

End

Private Sub CreateControls()

  Dim i As Integer

  For i = 0 To $xData.Count - 1
    If i < 49 Then

      aWebFrame[i] = New WebHBox(Frame1)
      aIndexLabel[i] = New WebLabel(aWebFrame[i])
      aNameLabel[i] = New WebHtml(aWebFrame[i])

      aWebPanel[i] = New WebHBox(Frame1)
      Select $xData[i][3]
        Case "Drug Sensitivity", "WHO Sensitivity"
          aDelButton[i] = New WebButton(aWebPanel[i]) As "DeleteButton"
        Case Else
          aAbnormCheck[i] = New WebCheckBox(aWebPanel[i]) As "CheckBoxgroup"
      End Select
      Select $xData[i][3]
        Case "Multiple Selection", "Drug Sensitivity", "WHO Sensitivity", "Text Table", "Dual Columns", "Triple Columns", "Single Column"
          xVarGridView[i] = New Variant[]
          aGridView[i] = New WebTable(aWebPanel[i]) As "Gridgroup"
          aGridButton[i] = New WebButton(aWebPanel[i]) As "GridCmdgroup"
        Case "Left and Right"
          aLeftRight[i] = New LeftRightTextArea(aWebPanel[i])
        Case "Date Time", "BS Date"
          aDateBox[i] = New WebDateBox(aWebPanel[i])
          aBSDate[i] = New WebButton(aWebPanel[i]) As "BSButton"
        Case "User Profile"
        Case "ImageValue"
          aButtonBox[i] = New WebButtonBox(aWebPanel[i])
        Case "Calculated"
          aCalcBox[i] = New WebValueBox(aWebPanel[i]) As "CalcGroup"
          aCalcUnit[i] = New WebTextBox(aWebPanel[i])
          aCalcNull[i] = New WebCheckBox(aWebPanel[i])
          aCalcLimit[i] = New WebLabel(aWebPanel[i])
        Case "Quantitative", "Percent Sum"
          aValueBox[i] = New WebValueBox(aWebPanel[i]) As "ValueGroup"
          aUnitText[i] = New WebTextBox(aWebPanel[i])
          aNullCheck[i] = New WebCheckBox(aWebPanel[i])
          aLimitLabel[i] = New WebLabel(aWebPanel[i])
        Case "Clinical Scale"
          aTextArea[i] = New WebTextArea(aWebPanel[i])
          aClinBox[i] = New WebValueBox(aWebPanel[i])
        Case "Qualitative"
          aLineText[i] = New WebTextBox(aWebPanel[i])
          aLimitLabel[i] = New WebLabel(aWebPanel[i])
        Case "Single Selection"
          aComboBox[i] = New WebComboBox(aWebPanel[i]) As "ComboGroup"
          aInterSpace[i] = New WebContainer(aWebPanel[i])
        Case "Dichotomous"
          aDichoValue[i] = New DichotomousValue(aWebPanel[i]) As "DichoText"
          aInterSpace[i] = New WebContainer(aWebPanel[i])
        Case "RichText Area"
          aHTMLText[i] = New WebTextHTML(aWebPanel[i])
        Case "Label Only"
          aLineText[i] = New WebLabel(aWebPanel[i])
        Case Else
          aGenTextArea[i] = New WebTextArea(aWebPanel[i])
      End Select
      aHelpButton[i] = New WebButton(aWebPanel[i]) As "ButtonBoxgroup"
      aBlankBox[i] = New WebLabel(aWebPanel[i])
      aWebSpace[i] = New WebSeparator(Frame1)
    Endif
  Next
  DIsplayTextForm()

End

Private Sub DIsplayTextForm()

  Dim i As Integer
  Dim asx As String[]
  Dim aCoLst As String[]

  For i = 0 To $xData.Count - 1
    If i < 49 Then

      With aWebFrame[i]
        .Class = "less-container-margin"
      End With

      ''create index label
      With aIndexLabel[i]
        .Width = "2em"
        .Height = "2em"
        .Text = i + 1
        .Visible = False
        .Tag = i
      End With

      ''create Name Label
      With aNameLabel[i]
        .Font = "bold"
        If $xData[i][3] = "Label Only" Then
          .Text = UCase($xData[i][0])
        Else
          .Text = "<p>" & $xData[i][0] & "</p>"
        Endif
        .Tag = i
      End With

      If $xData[i][3] = "Label Only" Then
        With aWebPanel[i]
          .Visible = False
        End With
      Else
        With aWebPanel[i]
          .Class = "less-container-margin"
        End With
      Endif

      ''create abnormal checkbox
      If $xData[i][3] = "Drug Sensitivity" Or If $xData[i][3] = "WHO Sensitivity" Then
        With aDelButton[i]
          .Class = "toolButton"
          .Width = "2em"
          .Height = "2em"
          .Image = "icon:/small/cancel"
          .Tag = i
        End With
      Else
        With aAbnormCheck[i]
          .Width = "4em"
          .Height = "2em"
          .Text = "Abn"
          .Value = $xData[i][4]
          If .Value = True Then
            .Foreground = Color.Red
          Else
            .Foreground = Color.Default
          Endif
          .Tag = i
        End With
      Endif

      ''create observation entry
      If $xData[i][3] = "Multiple Selection" Or If $xData[i][3] = "Drug Sensitivity" Or If $xData[i][3] = "WHO Sensitivity" Or If $xData[i][3] = "Text Table" Or If $xData[i][3] = "Dual Columns" Or If $xData[i][3] = "Triple Columns" Or If $xData[i][3] = "Single Column" Then
        If $xData[i][3] = "Dual Columns" Or If $xData[i][3] = "Triple Columns" Then
          aCoLst = GetCustColHeadings(i)
        Endif
        With aGridView[i]
          .Expand = True
          .Height = CStr(2 * Slider1.Value) & "em"
          .Border = True
          .Mode = Select.Single
          .ShowCheck = False
          .Tag = i
        End With
        xVarGridView[i] = LoadSubTable($xData[i][2], $frm, aGridView[i])
        With aGridView[i]
          If $xData[i][3] = "Dual Columns" Then
            .Columns[0].Hidden = True
            .Columns[1].Expand = True 'CStr(100 * modBasic.$AppWidthRatio) & "px"
            .Columns[2].Expand = True 'CStr(200 * modBasic.$AppWidthRatio) & "px"
            .Columns[3].Expand = True 'CStr(200 * modBasic.$AppWidthRatio) & "px"
            .Columns[4].Width = CStr(35 * modBasic.$AppWidthRatio) & "px"
            .Columns[1].Text = "Parameter"
            .Columns[2].Text = aCoLst[0]
            .Columns[3].Text = aCoLst[1]
          Else If $xData[i][3] = "Triple Columns" Then
            .Columns[0].Hidden = True
            .Columns[1].Expand = True 'CStr(100 * modBasic.$AppWidthRatio) & "px"
            .Columns[2].Expand = True 'CStr(150 * modBasic.$AppWidthRatio) & "px"
            .Columns[3].Expand = True 'CStr(150 * modBasic.$AppWidthRatio) & "px"
            .Columns[4].Expand = True 'CStr(150 * modBasic.$AppWidthRatio) & "px"
            .Columns[5].Width = CStr(35 * modBasic.$AppWidthRatio) & "px"
            .Columns[1].Text = "Parameter"
            .Columns[2].Text = aCoLst[0]
            .Columns[3].Text = aCoLst[1]
            .Columns[4].Text = aCoLst[2]
          Else If $xData[i][3] = "WHO Sensitivity" Then
            .Columns[0].Hidden = True
            .Columns[1].Expand = True 'CStr(100 * modBasic.$AppWidthRatio) & "px"
            .Columns[2].Expand = True 'CStr(100 * modBasic.$AppWidthRatio) & "px"
            .Columns[3].Expand = True 'CStr(75 * modBasic.$AppWidthRatio) & "px"
            .Columns[4].Expand = True 'CStr(75 * modBasic.$AppWidthRatio) & "px"
          Else If $xData[i][3] = "Drug Sensitivity" Then
            .Columns[0].Hidden = True
            .Columns[1].Expand = True 'CStr(100 * modBasic.$AppWidthRatio) & "px"
            .Columns[2].Expand = True 'CStr(100 * modBasic.$AppWidthRatio) & "px"
          Else
            .Columns[0].Hidden = True
            .Columns[1].Expand = True 'CStr(200 * modBasic.$AppWidthRatio) & "px"
          Endif
        End With

        With aGridButton[i]
          .Class = "toolButton"
          .Width = "2em"
          .Height = "2em"
          .Text = ""
          .Image = "icon:/small/edit"
          .Tag = i
        End With

      Else If $xData[i][3] = "Left and Right" Then
        asx = GetListForControl($xData[i][0], $xData[i][3])
        With aLeftRight[i]
          .Expand = True
          .Height = CStr(2 * Slider1.Value) & "em"
          If asx.Count >= 1 Then
            .LeftTitle = asx[0]
            .RightTitle = asx[1]
          Endif
          .DataText = $xData[i][1]
          .Tag = i
        End With

      Else If $xData[i][3] = "Date Time" Then
        With aDateBox[i]
          .Width = "12em"
          .Height = "2em"
          .Border = True
          .DateTime = True
          .Tag = i
          .Value = Val($xData[i][1])
        End With
        With aBSDate[i]
          .Class = "toolButton"
          .Width = "2em"
          .Height = "2em"
          .Image = "icon:/small/calendar"
          .Tag = i
        End With

      Else If $xData[i][3] = "BS Date" Then
        With aDateBox[i]
          .Width = "12em"
          .Height = "2em"
          .Border = True
          .DateTime = True
          .Tag = i
          .Value = modDate.ConvertToEngFullDateTime($xData[i][1])
        End With
        With aBSDate[i]
          .Class = "toolButton"
          .Width = "2em"
          .Height = "2em"
          .Image = "icon:/small/calendar"
          .Tag = i
        End With

      Else If $xData[i][3] = "User Profile" Then
      Else If $xData[i][3] = "ImageValue" Then
        With aButtonBox[i]
          .Expand = True
          .Height = "2em"
          .Border = True
          .Text = ""
          .Tag = i
        End With

      Else If $xData[i][3] = "Calculated" Then
        If $xData[i][1] Then
          asx = modString.SplitValueText($xData[i][1])
        Else
          asx = ["", ""]
        Endif
        With aCalcBox[i]
          .Width = "6em"
          .Height = "2em"
          .Border = True
          .Tag = i
          If asx[0] Then
            .Value = CFloat(asx[0])
          Endif
        End With
        With aCalcUnit[i]
          .Width = "6em"
          .Height = "2em"
          .Border = True
          .Tag = i
          .Text = asx[1]
        End With
        With aCalcNull[i]
          .Width = "6em"
          .Height = "2em"
          .Border = True
          .Tag = i
          .Value = False
          .Text = "Null"
        End With
        With aCalcLimit[i]
          .Expand = True
          .Height = "2em"
          .Border = True
          .Tag = i
          .Text = modFixLab.GetSubLatTestQualiReference(lblitem.Text, $xData[i][0])
        End With

      Else If $xData[i][3] = "Quantitative" Or If $xData[i][3] = "Percent Sum" Then
        If $xData[i][1] Then
          asx = modString.SplitValueText($xData[i][1])
        Else
          asx = ["", ""]
        Endif
        With aValueBox[i]
          .Width = "6em"
          .Height = "2em"
          .Border = True
          .Tag = i
          If asx[0] And If IsNumber(asx[0]) Then
            .Value = CFloat(asx[0])
          Endif
        End With
        With aUnitText[i]
          .Width = "6em"
          .Height = "2em"
          .Border = True
          .Tag = i
          .Text = asx[1]
        End With
        With aNullCheck[i]
          .Width = "6em"
          .Height = "2em"
          .Border = True
          .Tag = i
          .Value = False
          .Text = "Null"
        End With
        With aLimitLabel[i]
          .Expand = True
          .Height = "2em"
          .Border = True
          .Tag = i
          .Text = modFixLab.GetSubLatTestQualiReference(lblitem.Text, $xData[i][0])
        End With

      Else If $xData[i][3] = "Clinical Scale" Then
        With aTextArea[i]
          .Expand = True
          .Height = CStr(2 * Slider1.Value) & "em"
          .Border = True
          .Tag = i
        End With
        With aClinBox[i]
          .Width = "6em"
          .Height = "2em"
          .Border = True
          .Tag = i
        End With

      Else If $xData[i][3] = "Qualitative" Then
        With aLineText[i]
          .Expand = True
          .Height = "2em"
          .Border = True
          .Text = $xData[i][1]
          .Tag = i
        End With
        With aLimitLabel[i]
          .Width = "25%"
          .Height = "2em"
          .Border = True
          .Tag = i
          .Text = modFixLab.GetSubLatTestQualiReference(lblitem.Text, $xData[i][0])
        End With

      Else If $xData[i][3] = "Single Selection" Then
        With aComboBox[i]
          .Expand = True
          .Height = "2em"
          .Border = True
          .ReadOnly = False
          .List = GetListForControl($xData[i][0], $xData[i][3])
          .Text = $xData[i][1]
          .Tag = i
        End With
        With aInterSpace[i]
          .Width = "10%"
          .Height = "2em"
        End With

      Else If $xData[i][3] = "Dichotomous" Then
        With aDichoValue[i]
          .Expand = True
          .Height = "2em"
          .List = GetListForControl($xData[i][0], $xData[i][3])
          .Value = $xData[i][1]
          .Tag = i
        End With
        With aInterSpace[i]
          .Width = "10%"
          .Height = "2em"
        End With

      Else If $xData[i][3] = "RichText Area" Then
        With aHTMLText[i]
          .Expand = True
          .Height = CStr(2 * Slider1.Value) & "em"
          .Border = True
          .RichText = $xData[i][1]
          ' .DictionaryPath = modBasic.$dictPathList
          .Tag = i
        End With

      Else If $xData[i][3] = "Label Only" Then
        With aLineText[i]
          .Expand = True
          .Height = "2em"
          .Border = True
          .Text = ""
          .Tag = i
        End With

      Else
        With aGenTextArea[i]
          .Expand = True
          .Height = CStr(2 * Slider1.Value) & "em"
          .Border = True
          .Text = $xData[i][1]
          .Wrap = True
          .Tag = i
        End With

      Endif

      ''create help button
      With aHelpButton[i]
        ' .Class = "toolButton"
        .Width = "2em"
        .Height = "2em"
        .Text = ""
        .Image = "icon:/small/info"
        .Tag = i
        .Tooltip = "[Ctrl+O] to display Options"
      End With
      With aBlankBox[i]
        .Width = "1em"
        .Height = "2em"
      End With

      With aWebSpace[i]
        .Height = "1em"
      End With

    Endif
  Next

End

Private Function GetListForControl(sItem As String, sSelection As String) As String[]

  Dim xList As String[]

  xList = modAllExam.SelectSubExamOptionList($frm, lblitem.Text, sItem, sSelection)

  Return xList

End

Public Sub DeleteButton_Click()

  Dim j As Integer

  j = Last.Tag
  modDatabase.$myConn.Delete($tblpatlabsubtest, "fldid=&1", $xData[j][2])
  Wait
  Me.Close()

End

Public Sub CheckBoxgroup_Click()

  Dim j As Integer

  j = Last.Tag
  If aAbnormCheck[j].Value = True Then
    aAbnormCheck[j].Foreground = Color.Red
  Else
    aAbnormCheck[j].Foreground = Color.Default
  Endif

End

Public Sub BSButton_Click()

  Dim j As Integer
  Dim xx As String

  j = Last.Tag
  xx = BSDateFormat(("Enter BS Date in yyyy/mm/dd format"), ("Date Converter"), modDate.ConvertToLocaldate(aDateBox[j].Value))
  If xx Then
    aDateBox[j].Value = modDate.ConvertToEnglishdate(xx)
  Endif

End

Public Sub btnrefresh_Click()

  modSettings.SaveSettingsToFile("MultipleTextBox/Height", Slider1.Value)
  DIsplayTextForm()

End

Public Sub btnclose_Click()

  Me.Close()

End

Public Sub btnBrOK_Click()

  Dim i As Integer
  Dim xval As Float

  xval = 0
  For i = 0 To $xData.Count - 1
    If $xData[i][3] = "Percent Sum" Then
      xval = xval + aValueBox[i].Value
    Endif
  Next
  If xval = 0 Then
    SaveEntryData()
  Else
    If xval = 100 Then
      SaveEntryData()
    Else
      If Message.Question(("Percent Values Sum not equal to 100. Do you want to proceed?"), ("No"), ("Yes")) = 2 Then
        SaveEntryData()
      Endif
    Endif
  Endif

End

Private Sub SaveEntryData()

  If $frm = "Test" Then
    FillLabTestSubTest()
  Else If $frm = "Exam" Then
    FillExamSubExam()
  Else If $frm = "Radio" Then
    FillRadioTestSubTest()
  Endif
  Me.Exec(Subst("Toastify({text: '&1', duration: &2}).showToast()", "Information saved", modBasic.$BalloonDelay))

End

''for examination
Private Sub FillExamSubExam()

  Dim i As Integer
  Dim res As Result

  For i = 0 To $xData.Count - 1
    If i < 49 Then
      If $xData[i][0] = "Final Impression" Then
        If aHTMLText[i] Then
          modClinSub.UpdateQualiData($id, aHTMLText[i].RichText, aAbnormCheck[i].Value, aHTMLText[i].KeyList.Join(";"))
        Else If aGenTextArea[i] Then
          modClinSub.UpdateQualiData($id, aGenTextArea[i].Text, aAbnormCheck[i].Value, "")
        Endif

      Else
        If $xData[i][3] = "Multiple Selection" Or If $xData[i][3] = "Text Table" Or If $xData[i][3] = "Dual Columns" Or If $xData[i][3] = "Triple Columns" Or If $xData[i][3] = "Single Column" Then
          res = modDatabase.$myConn.Edit("tblpatientsubexam", "fldsubtexam=&1 and fldheadid=&2", $xData[i][0], $id)
          If res.Available Then
            res["fldreport"] = ""
            res["fldsave"] = True
            res["fldabnormal"] = aAbnormCheck[i].Value
            res["flduserid"] = modBasic.$lbluser
            res["fldtime"] = Now()
            res["xyz"] = False
            res.Update()
          Endif
        Else If $xData[i][3] = "Drug Sensitivity" Or If $xData[i][3] = "WHO Sensitivity" Then
          res = modDatabase.$myConn.Edit("tblpatientsubexam", "fldsubtexam=&1 and fldheadid=&2", $xData[i][0], $id)
          If res.Available Then
            res["fldreport"] = ""
            res["fldsave"] = True
            res["fldabnormal"] = True
            res["flduserid"] = modBasic.$lbluser
            res["fldtime"] = Now()
            res["xyz"] = False
            res.Update()
          Endif
        Else If $xData[i][3] = "Left and Right" Then
          If aLeftRight[i].DataText Then
            res = modDatabase.$myConn.Edit("tblpatientsubexam", "fldsubtexam=&1 and fldheadid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = aLeftRight[i].DataText
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Date Time" Then
          If aDateBox[i].Value Then
            res = modDatabase.$myConn.Edit("tblpatientsubexam", "fldsubtexam=&1 and fldheadid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = modDate.DateStringForExam(aDateBox[i].Value)
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "BS Date" Then
          If aDateBox[i].Value Then
            res = modDatabase.$myConn.Edit("tblpatientsubexam", "fldsubtexam=&1 and fldheadid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = modDate.ConvertToLocaldate(aDateBox[i].Value)
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "User Profile" Then
        Else If $xData[i][3] = "ImageValue" Then
          If aButtonBox[i].Text Then
            res = modDatabase.$myConn.Edit("tblpatientsubexam", "fldsubtexam=&1 and fldheadid=&2", $xData[i][0], $id)
            If res.Available Then

            Endif
          Endif
        Else If $xData[i][3] = "Calculated" Then
          If aCalcBox[i].Value Or If aNullCheck[i].Value Then
            res = modDatabase.$myConn.Edit("tblpatientsubexam", "fldsubtexam=&1 and fldheadid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = CStr(aCalcBox[i].Value) & Space(1) & aCalcUnit[i].Text
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Quantitative" Or If $xData[i][3] = "Percent Sum" Then
          If aValueBox[i].Value Or If aNullCheck[i].Value Then
            res = modDatabase.$myConn.Edit("tblpatientsubexam", "fldsubtexam=&1 and fldheadid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = CStr(aValueBox[i].Value) & Space(1) & aUnitText[i].Text
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Clinical Scale" Then
          If aTextArea[i].Text Then
            res = modDatabase.$myConn.Edit("tblpatientsubexam", "fldsubtexam=&1 and fldheadid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = CStr(aClinBox[i].Value)
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Qualitative" Then
          If Len(Trim(aLineText[i].Text)) Then
            res = modDatabase.$myConn.Edit("tblpatientsubexam", "fldsubtexam=&1 and fldheadid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = aLineText[i].Text
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Single Selection" Then
          If aComboBox[i].Text Then
            res = modDatabase.$myConn.Edit("tblpatientsubexam", "fldsubtexam=&1 and fldheadid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = aComboBox[i].Text
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Dichotomous" Then
          If aDichoValue[i].Value Then
            res = modDatabase.$myConn.Edit("tblpatientsubexam", "fldsubtexam=&1 and fldheadid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = aDichoValue[i].Value
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "RichText Area" Then
          If aHTMLText[i].Text Then
            res = modDatabase.$myConn.Edit("tblpatientsubexam", "fldsubtexam=&1 and fldheadid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = aHTMLText[i].RichText
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["fldfilepath"] = aHTMLText[i].KeyList.Join(";")
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Label Only" Then
          res = modDatabase.$myConn.Edit("tblpatientsubexam", "fldsubtexam=&1 and fldheadid=&2", $xData[i][0], $id)
          If res.Available Then
            res["fldreport"] = ""
            res["fldsave"] = True
            res["fldabnormal"] = False
            res["flduserid"] = ""
            res["fldtime"] = ""
            res["xyz"] = False
            res.Update()
          Endif
        Else
          If Len(Trim(aGenTextArea[i].Text)) Then
            res = modDatabase.$myConn.Edit("tblpatientsubexam", "fldsubtexam=&1 and fldheadid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = aGenTextArea[i].Text
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["fldfilepath"] = ""
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Endif
      Endif
    Endif
  Next

End

''for lab tests
Private Sub FillLabTestSubTest()

  Dim i As Integer
  Dim res As Result

  For i = 0 To $xData.Count - 1
    If i < 49 Then
      If $xData[i][0] = "Final Impression" Then
        If aHTMLText[i] Then
          modLabSub.UpdateLabTestReportQuali($id, aHTMLText[i].RichText, aAbnormCheck[i].Value, aHTMLText[i].KeyList.Join(";"), $tblpatlabtest)
        Else If aGenTextArea[i] Then
          modLabSub.UpdateLabTestReportQuali($id, aGenTextArea[i].Text, aAbnormCheck[i].Value, "", $tblpatlabtest)
        Endif

      Else
        If $xData[i][3] = "Multiple Selection" Or If $xData[i][3] = "Text Table" Or If $xData[i][3] = "Dual Columns" Or If $xData[i][3] = "Triple Columns" Or If $xData[i][3] = "Single Column" Then
          res = modDatabase.$myConn.Edit($tblpatlabsubtest, "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
          If res.Available Then
            res["fldreport"] = ""
            res["fldsave"] = True
            res["fldabnormal"] = aAbnormCheck[i].Value
            res["flduserid"] = modBasic.$lbluser
            res["fldtime"] = Now()
            res["xyz"] = False
            res.Update()
          Endif
        Else If $xData[i][3] = "Drug Sensitivity" Or If $xData[i][3] = "WHO Sensitivity" Then
          res = modDatabase.$myConn.Edit($tblpatlabsubtest, "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
          If res.Available Then
            res["fldreport"] = ""
            res["fldsave"] = True
            res["fldabnormal"] = True
            res["flduserid"] = modBasic.$lbluser
            res["fldtime"] = Now()
            res["xyz"] = False
            res.Update()
          Endif
        Else If $xData[i][3] = "Left and Right" Then
          If aLeftRight[i].DataText Then
            res = modDatabase.$myConn.Edit($tblpatlabsubtest, "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = aLeftRight[i].DataText
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Date Time" Then
          If aDateBox[i].Value Then
            res = modDatabase.$myConn.Edit($tblpatlabsubtest, "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = modDate.DateStringForExam(aDateBox[i].Value)
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "BS Date" Then
          If aDateBox[i].Value Then
            res = modDatabase.$myConn.Edit($tblpatlabsubtest, "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = modDate.ConvertToLocaldate(aDateBox[i].Value)
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "User Profile" Then
        Else If $xData[i][3] = "ImageValue" Then
          If aButtonBox[i].Text Then
            res = modDatabase.$myConn.Edit($tblpatlabsubtest, "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then

            Endif
          Endif
        Else If $xData[i][3] = "Calculated" Then
          If aCalcBox[i].Value Or If aNullCheck[i].Value Then
            res = modDatabase.$myConn.Edit($tblpatlabsubtest, "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = CStr(aCalcBox[i].Value) & Space(1) & aCalcUnit[i].Text
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Quantitative" Or If $xData[i][3] = "Percent Sum" Then
          If aValueBox[i].Value Or If aNullCheck[i].Value Then
            res = modDatabase.$myConn.Edit($tblpatlabsubtest, "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = CStr(aValueBox[i].Value) & Space(1) & aUnitText[i].Text
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Clinical Scale" Then
          If aTextArea[i].Text Then
            res = modDatabase.$myConn.Edit($tblpatlabsubtest, "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = CStr(aClinBox[i].Value)
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Qualitative" Then
          If Len(Trim(aLineText[i].Text)) Then
            res = modDatabase.$myConn.Edit($tblpatlabsubtest, "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = aLineText[i].Text
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Single Selection" Then
          If aComboBox[i].Text Then
            res = modDatabase.$myConn.Edit($tblpatlabsubtest, "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = aComboBox[i].Text
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Dichotomous" Then
          If aDichoValue[i].Value Then
            res = modDatabase.$myConn.Edit($tblpatlabsubtest, "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = aDichoValue[i].Value
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "RichText Area" Then
          If aHTMLText[i].Text Then
            res = modDatabase.$myConn.Edit($tblpatlabsubtest, "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = aHTMLText[i].RichText
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["fldfilepath"] = aHTMLText[i].KeyList.Join(";")
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Label Only" Then
          res = modDatabase.$myConn.Edit($tblpatlabsubtest, "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
          If res.Available Then
            res["fldreport"] = ""
            res["fldsave"] = True
            res["fldabnormal"] = False
            res["flduserid"] = ""
            res["fldtime"] = ""
            res["xyz"] = False
            res.Update()
          Endif
        Else
          If Len(Trim(aGenTextArea[i].Text)) Then
            res = modDatabase.$myConn.Edit($tblpatlabsubtest, "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = aGenTextArea[i].Text
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["fldfilepath"] = ""
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Endif
      Endif
    Endif
  Next

End

''for radio tests
Private Sub FillRadioTestSubTest()

  Dim i As Integer
  Dim res As Result

  For i = 0 To $xData.Count - 1
    If i < 49 Then
      If $xData[i][0] = "Final Impression" Then
        If aHTMLText[i] Then
          modRadioSub.UpdateRadioTestReportQuali($id, aHTMLText[i].RichText, aAbnormCheck[i].Value, aHTMLText[i].KeyList.Join(";"))
        Else If aGenTextArea[i] Then
          modRadioSub.UpdateRadioTestReportQuali($id, aGenTextArea[i].Text, aAbnormCheck[i].Value, "")
        Endif

      Else
        If $xData[i][3] = "Multiple Selection" Or If $xData[i][3] = "Text Table" Or If $xData[i][3] = "Dual Columns" Or If $xData[i][3] = "Triple Columns" Or If $xData[i][3] = "Single Column" Then
          res = modDatabase.$myConn.Edit("tblpatradiosubtest", "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
          If res.Available Then
            res["fldreport"] = ""
            res["fldsave"] = True
            res["fldabnormal"] = aAbnormCheck[i].Value
            res["flduserid"] = modBasic.$lbluser
            res["fldtime"] = Now()
            res["xyz"] = False
            res.Update()
          Endif
        Else If $xData[i][3] = "Drug Sensitivity" Or If $xData[i][3] = "WHO Sensitivity" Then
          res = modDatabase.$myConn.Edit("tblpatradiosubtest", "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
          If res.Available Then
            res["fldreport"] = ""
            res["fldsave"] = True
            res["fldabnormal"] = True
            res["flduserid"] = modBasic.$lbluser
            res["fldtime"] = Now()
            res["xyz"] = False
            res.Update()
          Endif
        Else If $xData[i][3] = "Left and Right" Then
          If aLeftRight[i].DataText Then
            res = modDatabase.$myConn.Edit("tblpatradiosubtest", "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = aLeftRight[i].DataText
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Date Time" Then
          If aDateBox[i].Value Then
            res = modDatabase.$myConn.Edit("tblpatradiosubtest", "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = modDate.DateStringForExam(aDateBox[i].Value)
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "BS Date" Then
          If aDateBox[i].Value Then
            res = modDatabase.$myConn.Edit("tblpatradiosubtest", "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = modDate.ConvertToLocaldate(aDateBox[i].Value)
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "User Profile" Then
        Else If $xData[i][3] = "ImageValue" Then
          If aButtonBox[i].Text Then
            res = modDatabase.$myConn.Edit("tblpatradiosubtest", "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then

            Endif
          Endif
        Else If $xData[i][3] = "Calculated" Then
          If aCalcBox[i].Value Or If aNullCheck[i].Value Then
            res = modDatabase.$myConn.Edit("tblpatradiosubtest", "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = CStr(aCalcBox[i].Value) & Space(1) & aCalcUnit[i].Text
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Quantitative" Or If $xData[i][3] = "Percent Sum" Then
          If aValueBox[i].Value Or If aNullCheck[i].Value Then
            res = modDatabase.$myConn.Edit("tblpatradiosubtest", "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = CStr(aValueBox[i].Value) & Space(1) & aUnitText[i].Text
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Clinical Scale" Then
          If aTextArea[i].Text Then
            res = modDatabase.$myConn.Edit("tblpatradiosubtest", "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = CStr(aClinBox[i].Value)
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Qualitative" Then
          If Len(Trim(aLineText[i].Text)) Then
            res = modDatabase.$myConn.Edit("tblpatradiosubtest", "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = aLineText[i].Text
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Single Selection" Then
          If aComboBox[i].Text Then
            res = modDatabase.$myConn.Edit("tblpatradiosubtest", "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = aComboBox[i].Text
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Dichotomous" Then
          If aDichoValue[i].Value Then
            res = modDatabase.$myConn.Edit("tblpatradiosubtest", "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = aDichoValue[i].Value
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "RichText Area" Then
          If aHTMLText[i].Text Then
            res = modDatabase.$myConn.Edit("tblpatradiosubtest", "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = aHTMLText[i].RichText
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["fldfilepath"] = aHTMLText[i].KeyList.Join(";")
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Label Only" Then
          res = modDatabase.$myConn.Edit("tblpatradiosubtest", "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
          If res.Available Then
            res["fldreport"] = ""
            res["fldsave"] = True
            res["fldabnormal"] = False
            res["flduserid"] = ""
            res["fldtime"] = ""
            res["xyz"] = False
            res.Update()
          Endif
        Else
          If Len(Trim(aGenTextArea[i].Text)) Then
            res = modDatabase.$myConn.Edit("tblpatradiosubtest", "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = aGenTextArea[i].Text
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["fldfilepath"] = ""
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Endif
      Endif
    Endif
  Next

End

''for tabular data
Private Sub AddSubTableData(testid As Long, subtestid As Long, sIndex As String, sType As String, sVal As String[])

  Dim res As Result
  Dim xx As String
  Dim asx As String[]
  Dim xIntVal As String

  For Each xx In sVal
    asx = Split(Trim(xx), ";")

    If $frm = "Test" Then
      res = modDatabase.$myConn.Create("tblpatlabsubtable")
      res["fldtestid"] = testid
      res["fldsubtestid"] = subtestid
      res["fldindex"] = sIndex
    Else If $frm = "Exam" Then
      res = modDatabase.$myConn.Create("tblpatexamsubtable")
      res["fldexamid"] = testid
      res["fldsubexamid"] = subtestid
      res["fldindex"] = sIndex
    Else If $frm = "Radio" Then
      res = modDatabase.$myConn.Create("tblpatradiosubtable")
      res["fldexamid"] = testid
      res["fldsubexamid"] = subtestid
      res["fldindex"] = sIndex
    Endif
    res["fldtype"] = sType
    res["fldvariable"] = asx[0]
    If asx.Count > 1 Then
      res["fldvalue"] = asx[1]
    Endif
    If asx.Count > 2 Then
      res["fldcolm2"] = asx[2]
    Endif
    If asx.Count > 3 Then
      res["fldcolm3"] = asx[3]
    Endif
    If asx.Count > 4 Then
      res["fldcolm4"] = asx[4]
    Endif
    res["fldhide"] = False
    res["xyz"] = False
    If MMain.$WebEntry = True Then
      xIntVal = modString.GetDateString(Now())
      res["fldid"] = CLong(xIntVal)
      res["fldrepoid"] = modMisc.GetWebIndexStr(xIntVal)
      res["fldrepodate"] = Now()
      res["fldrepomac"] = CGI["REMOTE_ADDR"] & ":" & CGI["REMOTE_PORT"]
      res["fldhospcode"] = modBasic.$HospCode
    Endif
    res.Update
  Next

End

Private Sub SetQualitativeAbnormal(i As Integer)

  If $xData[i][3] = "Single Selection" Then
    If aComboBox[i].Text Then
      aAbnormCheck[i].Value = modAllExam.SelectSubExamAbnormal($frm, lblitem.Text, $xData[i][0], aComboBox[i].Text, $xData[i][3])
    Endif
  Else If $xData[i][3] = "Dichotomous" Then
    If aDichoValue[i].Value Then
      aAbnormCheck[i].Value = modAllExam.SelectSubExamAbnormal($frm, lblitem.Text, $xData[i][0], aDichoValue[i].Value, $xData[i][3])
    Endif
  Else If $xData[i][3] = "Left and Right" Then
    If aLeftRight[i].DataText Then
      aAbnormCheck[i].Value = modAllExam.SelectSubExamAbnormal($frm, lblitem.Text, $xData[i][0], aLeftRight[i].DataText, $xData[i][3])
    Endif
  Else If $xData[i][3] = "Qualitative" Then
    If aLineText[i].Text Then
      aAbnormCheck[i].Value = modAllExam.SelectSubExamAbnormal($frm, lblitem.Text, $xData[i][0], aLineText[i].Text, $xData[i][3])
    Endif
  Else If $xData[i][3] = "No Selection" Then
    If aGenTextArea[i].Text Then
      aAbnormCheck[i].Value = modAllExam.SelectSubExamAbnormal($frm, lblitem.Text, $xData[i][0], aGenTextArea[i].Text, $xData[i][3])
    Endif
  Endif

End

''-------------------------------- Create Grid data --------------------------------------------
Private Function LoadSubTable(subTestID As Long, frm As String, GridView1 As WebTable) As Variant[]

  Dim res As Result
  Dim i As Integer

  Dim xFinal As Variant[]
  Dim xRowVal As Collection
  Dim ref As ResultField
  Dim Column As Integer

  i = GridView1.Tag
  If frm = "Test" Then
    If $xData[i][3] = "Multiple Selection" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable from tblpatlabsubtable where fldsubtestid=&1 and fldtestid=&2 and (fldhide=&3 or fldhide IS NULL)", subTestID, $id, False)
    Else If $xData[i][3] = "Drug Sensitivity" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable,fldvalue from tblpatlabsubtable where fldsubtestid=&1 and fldtestid=&2 and (fldhide=&3 or fldhide IS NULL)", subTestID, $id, False)
    Else If $xData[i][3] = "WHO Sensitivity" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable,fldvalue,fldcolm2,fldcolm3 from tblpatlabsubtable where fldsubtestid=&1 and fldtestid=&2 and (fldhide=&3 or fldhide IS NULL)", subTestID, $id, False)
    Else If $xData[i][3] = "Single Column" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable,fldvalue from tblpatlabsubtable where fldsubtestid=&1 and fldtestid=&2 and (fldhide=&3 or fldhide IS NULL)", subTestID, $id, False)
    Else If $xData[i][3] = "Dual Columns" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable,fldvalue,fldcolm2,fldid from tblpatlabsubtable where fldsubtestid=&1 and fldtestid=&2 and (fldhide=&3 or fldhide IS NULL)", subTestID, $id, False)
    Else If $xData[i][3] = "Triple Columns" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable,fldvalue,fldcolm2,fldcolm3,fldid from tblpatlabsubtable where fldsubtestid=&1 and fldtestid=&2 and (fldhide=&3 or fldhide IS NULL)", subTestID, $id, False)
    Else If $xData[i][3] = "Text Table" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable,fldvalue,fldcolm2,fldcolm3,fldcolm4 from tblpatlabsubtable where fldsubtestid=&1 and fldtestid=&2 and (fldhide=&3 or fldhide IS NULL)", subTestID, $id, False)
    Endif

  Else If frm = "Exam" Then
    If $xData[i][3] = "Multiple Selection" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable from tblpatexamsubtable where fldsubexamid=&1 and fldexamid=&2 and (fldhide=&3 or fldhide IS NULL)", subTestID, $id, False)
    Else If $xData[i][3] = "Drug Sensitivity" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable,fldvalue from tblpatexamsubtable where fldsubexamid=&1 and fldexamid=&2 and (fldhide=&3 or fldhide IS NULL)", subTestID, $id, False)
    Else If $xData[i][3] = "WHO Sensitivity" Then
    Else If $xData[i][3] = "Single Column" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable,fldvalue from tblpatexamsubtable where fldsubexamid=&1 and fldexamid=&2 and (fldhide=&3 or fldhide IS NULL)", subTestID, $id, False)
    Else If $xData[i][3] = "Dual Columns" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable,fldvalue,fldcolm2,fldid from tblpatexamsubtable where fldsubexamid=&1 and fldexamid=&2 and (fldhide=&3 or fldhide IS NULL)", subTestID, $id, False)
    Else If $xData[i][3] = "Triple Columns" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable,fldvalue,fldcolm2,fldcolm3,fldid from tblpatexamsubtable where fldsubexamid=&1 and fldexamid=&2 and (fldhide=&3 or fldhide IS NULL)", subTestID, $id, False)
    Else If $xData[i][3] = "Text Table" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable,fldvalue,fldcolm2,fldcolm3,fldcolm4 from tblpatexamsubtable where fldsubexamid=&1 and fldexamid=&2 and (fldhide=&3 or fldhide IS NULL)", subTestID, $id, False)
    Endif

  Else If frm = "Radio" Then
    If $xData[i][3] = "Multiple Selection" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable from tblpatradiosubtable where fldsubexamid=&1 and fldexamid=&2 and (fldhide=&3 or fldhide IS NULL)", subTestID, $id, False)
    Else If $xData[i][3] = "Drug Sensitivity" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable,fldvalue from tblpatradiosubtable where fldsubexamid=&1 and fldexamid=&2 and (fldhide=&3 or fldhide IS NULL)", subTestID, $id, False)
    Else If $xData[i][3] = "WHO Sensitivity" Then
    Else If $xData[i][3] = "Single Column" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable,fldvalue from tblpatradiosubtable where fldsubexamid=&1 and fldexamid=&2 and (fldhide=&3 or fldhide IS NULL)", subTestID, $id, False)
    Else If $xData[i][3] = "Dual Columns" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable,fldvalue,fldcolm2,fldid from tblpatradiosubtable where fldsubexamid=&1 and fldexamid=&2 and (fldhide=&3 or fldhide IS NULL)", subTestID, $id, False)
    Else If $xData[i][3] = "Triple Columns" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable,fldvalue,fldcolm2,fldcolm3,fldid from tblpatradiosubtable where fldsubexamid=&1 and fldexamid=&2 and (fldhide=&3 or fldhide IS NULL)", subTestID, $id, False)
    Else If $xData[i][3] = "Text Table" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable,fldvalue,fldcolm2,fldcolm3,fldcolm4 from tblpatradiosubtable where fldsubexamid=&1 and fldexamid=&2 and (fldhide=&3 or fldhide IS NULL)", subTestID, $id, False)
    Endif

  Endif

  xFinal = New Variant[]
  If res.Available Then
    For Each res

      xRowVal = New Collection
      Column = 0
      For Each ref In res.Fields
        If Column = res.Fields.Count - 1 Then
          Select $xData[i][3]
            Case "Dual Columns", "Triple Columns"
              xRowVal.Add("$Delete", CStr(Column))
            Case Else
              xRowVal.Add(res[ref.Name], CStr(Column))
          End Select
        Else
          xRowVal.Add(res[ref.Name], CStr(Column))
        Endif
        Column = Column + 1
      Next

      xFinal.Add(xRowVal)
    Next
  Endif

  GridView1.Clear
  GridView1.Columns.Count = res.Fields.Count
  GridView1.Count = res.Count

  Return xFinal

End

Public Sub Gridgroup_Data(Row As Integer, Column As Integer, Data As WebTableData)

  Dim j As Integer

  j = Last.Tag
  modGridView.GridViewDecoration(Data, Row)
  If xVarGridView[j][Row][CStr(Column)] = "$Delete" Then
    Data.Control = btndelgrid
    Data.Text = ""
  Else
    Data.Text = xVarGridView[j][Row][CStr(Column)]
  Endif

End

Public Sub btndelgrid_Click()

  ''delete

End

Public Sub GridCmdgroup_Click()

  Dim j As Integer
  Dim xx As String
  Dim res As Result
  Dim tbl As String
  Dim fld As String
  Dim xval As String
  Dim xselect As String

  j = Last.Tag

  If $frm = "Test" Then
    tbl = "tblpatlabsubtable"
  Else If $frm = "Exam" Then
    tbl = "tblpatexamsubtable"
  Else If $frm = "Radio" Then
    tbl = "tblpatradiosubtable"
  Endif

  If aGridView[j].Selection.Count Then
    If $xData[j][3] = "Multiple Selection" Then
      fld = "fldvariable"
      xx = InputBox(("Edit Selected Value"), "Multiple Selection", xVarGridView[j][CStr(aGridView[j].Selection[0])][CStr(1)])

    Else If $xData[j][3] = "Drug Sensitivity" Then
      fld = "fldvalue"
      xx = InputCombo(("Edit Sensitivity Value"), xVarGridView[j][CStr(aGridView[j].Selection[0])][CStr(1)], ["Sensitive", "Intermediate", "Resistant", "Cancelled"], xVarGridView[j][CStr(aGridView[j].Selection[0])][CStr(2)], True)                  ''                                       ''

    Else If $xData[j][3] = "WHO Sensitivity" Then
      xselect = InputCombo("Alter Selected Parameters", "WHO Sensitivity", ["Observation", "Interpretation"], "", True)
      If xselect = "Interpretation" Then
        fld = "fldvalue"
        xx = InputCombo(("Edit Sensitivity Value"), xVarGridView[j][CStr(aGridView[j].Selection[0])][CStr(1)], ["Sensitive", "Intermediate", "Resistant", "Cancelled"], xVarGridView[j][CStr(aGridView[j].Selection[0])][CStr(2)], True)                  ''                                       ''
      Else If xselect = "Observation" Then
        fld = "fldcolm3"
        xx = InputBox(("Edit Value"), xVarGridView[j][CStr(aGridView[j].Selection[0])][CStr(1)], xVarGridView[j][CStr(aGridView[j].Selection[0])][CStr(4)])
      Endif

    Else If $xData[j][3] = "Single Column" Then
      fld = "fldvalue"
      xx = InputBox(("Edit Observation"), xVarGridView[j][CStr(aGridView[j].Selection[0])][CStr(1)], xVarGridView[j][CStr(aGridView[j].Selection[0])][CStr(2)], True)                  ''                                       ''

    Else If $xData[j][3] = "Dual Columns" Then
      xval = InputCombo("Select", "Dual Columns", ["LEFT", "RIGHT"], "", True)
      If xval = "LEFT" Then
        fld = "fldvalue"
        xx = InputBox(("Edit Value"), "LEFT", xVarGridView[j][CStr(aGridView[j].Selection[0])][CStr(2)])
      Else If xval = "RIGHT" Then
        fld = "fldcolm2"
        xx = InputBox(("Edit Value"), "RIGHT", xVarGridView[j][CStr(aGridView[j].Selection[0])][CStr(3)])
      Endif

    Else If $xData[j][3] = "Triple Columns" Then
      xval = InputCombo("Select", "Triple Columns", ["COLUMN-I", "COLUMN-II", "COLUMN-III"], "", True)
      If xval = "COLUMN-I" Then
        fld = "fldvalue"
        xx = InputBox(("Edit Value"), "COLUMN-I", xVarGridView[j][CStr(aGridView[j].Selection[0])][CStr(2)])
      Else If xval = "COLUMN-II" Then
        fld = "fldcolm2"
        xx = InputBox(("Edit Value"), "COLUMN-II", xVarGridView[j][CStr(aGridView[j].Selection[0])][CStr(3)])
      Else If xval = "COLUMN-III" Then
        fld = "fldcolm3"
        xx = InputBox(("Edit Value"), "COLUMN-III", xVarGridView[j][CStr(aGridView[j].Selection[0])][CStr(3)])
      Endif

    Else If $xData[j][3] = "Text Table" Then
      xval = InputCombo("Select", "Text Table", ["Column1", "Column2", "Column3", "Column4", "Column5"], "", True)
      If xval = "Column1" Then
        fld = "fldvariable"
        xx = InputBox(("Edit Value"), "Text Table", xVarGridView[j][CStr(aGridView[j].Selection[0])][CStr(1)])
      Else If xval = "Column2" Then
        fld = "fldvalue"
        xx = InputBox(("Edit Value"), "Text Table", xVarGridView[j][CStr(aGridView[j].Selection[0])][CStr(2)])
      Else If xval = "Column3" Then
        fld = "fldcolm2"
        xx = InputBox(("Edit Value"), "Text Table", xVarGridView[j][CStr(aGridView[j].Selection[0])][CStr(3)])
      Else If xval = "Column4" Then
        fld = "fldcolm3"
        xx = InputBox(("Edit Value"), "Text Table", xVarGridView[j][CStr(aGridView[j].Selection[0])][CStr(4)])
      Else If xval = "Column5" Then
        fld = "fldcolm4"
        xx = InputBox(("Edit Value"), "Text Table", xVarGridView[j][CStr(aGridView[j].Selection[0])][CStr(5)])
      Endif

    Endif
    If xx Then
      res = modDatabase.$myConn.Edit(tbl, "fldid=&1", xVarGridView[j][CStr(aGridView[j].Selection[0])][CStr(0)])
      res[fld] = xx
      res.Update
      xVarGridView[j] = LoadSubTable($xData[j][2], $frm, aGridView[j])
    Endif

  Endif

End

Public Sub ValueGroup_Change()

  Dim i As Integer
  Dim xrange As Float[]

  i = Last.Tag

  If aValueBox[i].Value Then
    xrange = GetRefRange(aLimitLabel[i].Text)
    If xrange And If xrange.Count = 2 Then
      If aValueBox[i].Value < xrange[0] Then
        aAbnormCheck[i].Value = True
      Else If aValueBox[i].Value > xrange[1] Then
        aAbnormCheck[i].Value = True
      Else
        aAbnormCheck[i].Value = False
      Endif
    Else
      aAbnormCheck[i].Value = False
    Endif
  Else
    aAbnormCheck[i].Value = False
  Endif

  If aAbnormCheck[i].Value = True Then
    aAbnormCheck[i].Foreground = Color.Red
  Else
    aAbnormCheck[i].Foreground = Color.Default
  Endif

End

Public Sub CalcGroup_Change()

  Dim i As Integer
  Dim xrange As Float[]

  i = Last.Tag

  If aCalcBox[i].Value Then
    xrange = GetRefRange(aCalcLimit[i].Text)
    If xrange And If xrange.Count = 2 Then
      If aCalcBox[i].Value < xrange[0] Then
        aAbnormCheck[i].Value = True
      Else If aCalcBox[i].Value > xrange[1] Then
        aAbnormCheck[i].Value = True
      Else
        aAbnormCheck[i].Value = False
      Endif
    Else
      aAbnormCheck[i].Value = False
    Endif
  Else
    aAbnormCheck[i].Value = False
  Endif

  If aAbnormCheck[i].Value = True Then
    aAbnormCheck[i].Foreground = Color.Red
  Else
    aAbnormCheck[i].Foreground = Color.Default
  Endif

End

Private Function GetRefRange(sRange As String) As Float[]

  Dim asx As String[]
  Dim bsx1 As String[]
  Dim bsx2 As String[]
  Dim afinal As Float[]

  afinal = New Float[]
  If sRange Then
    asx = Split(sRange, "-")
    bsx1 = Split(Trim(asx[0]), " ")
    Try afinal.Add(CFloat(Trim(bsx1[0])))
    If asx.Count > 1 Then
      bsx2 = Split(Trim(asx[1]), " ")
      Try afinal.Add(CFloat(Trim(bsx2[0])))
    Endif
  Endif
  Return afinal

End

''------------------------------------- short cut keys ------------------------------
Public Sub ComboGroup_Click()

  Dim j As Integer

  j = Last.Tag
  SetQualitativeAbnormal(j)

End

Public Sub DichoText_Click()

  Dim j As Integer

  j = Last.Tag
  SetQualitativeAbnormal(j)

End

''-----------------------------help options  --------------------------------------
Public Sub ButtonBoxgroup_Click()

  Dim j As Integer

  j = Last.Tag
  $FocusTag = j

  OpenOption(j)
  SetQualitativeAbnormal(J)

End

Private Sub OpenOption(j As Integer)

  Dim sql1 As String
  Dim sql As String
  Dim res1 As Result
  Dim res As Result
  Dim xoption As String[]
  Dim sVal As String[]
  Dim sPath As String
  Dim xval As String

  Dim hForm As FmWHOSensitivity

  xoption = New String[]

  If $xData[j][0] = "Final Impression" Then
    If $frm = "Test" Then
      sql1 = "select fldoption as fldanswertype from tbltest where fldtestid=&1"
      sql = "select fldanswertype,fldanswer,fldscale,fldscalegroup from tbltestoption where fldtestid=&1 ORDER BY fldindex"
    Else If $frm = "Exam" Then
      sql1 = "select fldoption as fldanswertype from tblexam where fldexamid=&1"
      sql = "select fldanswertype,fldanswer,fldscale,fldscalegroup from tblexamoption where fldexamid=&1 ORDER BY fldindex"
    Else If $frm = "Radio" Then
      sql1 = "select fldoption as fldanswertype from tblradio where fldexamid=&1"
      sql = "select fldanswertype,fldanswer,fldscale,fldscalegroup from tblradiooption where fldexamid=&1 ORDER BY fldindex"
    Endif
    res1 = modDatabase.$myConn.Exec(sql1, lblitem.Text)
    res = modDatabase.$myConn.Exec(sql, lblitem.Text)
  Else
    If $frm = "Test" Then
      sql1 = "select fldtanswertype as fldanswertype from tbltestquali where fldsubtest=&1 and fldtestid=&2"
      sql = "select fldanswertype,fldanswer,fldscale,fldscalegroup from tblsubtestquali where fldsubtest=&1 and fldtestid=&2 ORDER BY fldindex"
    Else If $frm = "Exam" Then
      sql1 = "select fldtanswertype as fldanswertype from tblexamquali where fldsubexam=&1 and fldexamid=&2"
      sql = "select fldanswertype,fldanswer,fldscale,fldscalegroup from tblsubexamquali where fldsubexam=&1 and fldexamid=&2 ORDER BY fldindex"
    Else If $frm = "Radio" Then
      sql1 = "select fldtanswertype as fldanswertype from tblradioquali where fldsubexam=&1 and fldexamid=&2"
      sql = "select fldanswertype,fldanswer,fldscale,fldscalegroup from tblsubradioquali where fldsubexam=&1 and fldexamid=&2 ORDER BY fldindex"
    Endif
    res1 = modDatabase.$myConn.Exec(sql1, $xData[j][0], lblitem.Text)
    res = modDatabase.$myConn.Exec(sql, $xData[j][0], lblitem.Text)
  Endif

  If res1.Available Then
    If res1["fldanswertype"] = "Date Time" Then
      xval = BSDateFormat(("Enter BS Date in yyyy/mm/dd format"), ("Date Converter"), modDate.ConvertToLocaldate(aDateBox[j].Value))
      If xval Then
        aDateBox[j].Value = modDate.ConvertToEnglishdate(xval)
      Endif

    Else If res1["fldanswertype"] = "BS Date" Then
      xval = BSDateFormat(("Enter BS Date in yyyy/mm/dd format"), ("Date Converter"), modDate.ConvertToLocaldate(aDateBox[j].Value))
      If xval Then
        aDateBox[j].Value = modDate.ConvertToEnglishdate(xval)
      Endif

    Else If res1["fldanswertype"] = "User Profile" Then

    Else If res1["fldanswertype"] = "ImageValue" Then
      sPath = modImage.DisplayVisualData($frm, lblitem.Text, $xData[j][0], res1["fldanswertype"])
      sVal = CustomDraw(sPath)
      If sVal Then
        aButtonBox[j].Text = sVal[0]
      Endif

    Else If res1["fldanswertype"] = "Visual Input" Then
      sPath = modImage.DisplayVisualData($frm, lblitem.Text, $xData[j][0], res1["fldanswertype"])
      If sPath Then
        xval = CVisualValue(lblitem.Text, sPath, aGenTextArea[j].Text)
        If xval Then
          aGenTextArea[j].Text = xval
        Endif
      Endif

    Else If res1["fldanswertype"] = "Calculated" Then

    Else If res1["fldanswertype"] = "Quantitative" Or If res1["fldanswertype"] = "Percent Sum" Then
      aValueBox[j].Value = GetCalculateValue(modSettings.ShowEqnSettingFromFIle(lblitem.Text & "/" & $xData[j][0]))

    Else If res1["fldanswertype"] = "RichText Area" Then
      aHTMLText[j].RichText = aHTMLText[j].RichText & Space(1) & modFillContainer.GetExtraTextArea($xData[j][0], aHTMLText[j].Text)

    Else If res1["fldanswertype"] = "No Selection" Then
      aGenTextArea[j].Text = aGenTextArea[j].Text & Space(1) & GetTextArea($xData[j][0], "")

    Else
      If res.Available Then    ''if options available
        If res1["fldanswertype"] = "Single Selection" Then
          For Each res
            xoption.Add(res["fldanswer"])
          Next
          sVal = SubChoose(xoption, "Single Selection", $xData[j][0])
          If sVal Then
            aComboBox[j].Text = sVal[0]
          Endif

        Else If res1["fldanswertype"] = "Dichotomous" Then
          For Each res
            xoption.Add(res["fldanswer"])
          Next
          sVal = SubChoose(xoption, "Single Selection", $xData[j][0])
          If sVal Then
            aDichoValue[j].Value = sVal[0]
          Endif

        Else If res1["fldanswertype"] = "Multiple Selection" Then
          For Each res
            xoption.Add(res["fldanswer"])
          Next
          sVal = SubChoose(xoption, "Multiple Selection", $xData[j][0])
          If sVal Then
            AddSubTableData($id, $xData[j][2], $xData[j][5], "Multiple Selection", sVal)
            xVarGridView[j] = LoadSubTable($xData[j][2], $frm, aGridView[j])
          Endif

        Else If res1["fldanswertype"] = "Text Table" Then
          For Each res
            xoption.Add(res["fldanswer"])
          Next
          sVal = SubChoose(xoption, "Text Table", $xData[j][0])
          If sVal Then
            AddSubTableData($id, $xData[j][2], $xData[j][5], "Text Table", sVal)
            xVarGridView[j] = LoadSubTable($xData[j][2], $frm, aGridView[j])
          Endif

        Else If res1["fldanswertype"] = "Drug Sensitivity" Then
          For Each res
            xoption.Add(res["fldanswer"])
          Next
          sVal = SubChoose(xoption, "Drug Sensitivity", $xData[j][0])
          If sVal Then
            AddSubTableData($id, $xData[j][2], $xData[j][5], "Drug Sensitivity", sVal)
            xVarGridView[j] = LoadSubTable($xData[j][2], $frm, aGridView[j])
          Endif

        Else If res1["fldanswertype"] = "WHO Sensitivity" Then
          hForm = New FmWHOSensitivity($id, $xData[j][2], $xData[j][5], $xData[j][0], res["fldanswer"], lblnote.Text)
          hForm.ShowModal
          xVarGridView[j] = LoadSubTable($xData[j][2], $frm, aGridView[j])

        Else If res1["fldanswertype"] = "Single Column" Then
          For Each res
            xoption.Add(res["fldanswer"])
          Next
          sVal = SubChoose(xoption, "Single Column", $xData[j][0])
          If sVal Then
            AddSubTableData($id, $xData[j][2], $xData[j][5], "Single Column", sVal)
            xVarGridView[j] = LoadSubTable($xData[j][2], $frm, aGridView[j])
          Endif

        Else If res1["fldanswertype"] = "Dual Columns" Then
          For Each res
            xoption.Add(res["fldanswer"])
          Next
          sVal = SubChoose(xoption, "Dual Columns", $xData[j][0])
          If sVal Then
            AddSubTableData($id, $xData[j][2], $xData[j][5], "Dual Columns", sVal)
            xVarGridView[j] = LoadSubTable($xData[j][2], $frm, aGridView[j])
          Endif

        Else If res1["fldanswertype"] = "Triple Columns" Then
          For Each res
            xoption.Add(res["fldanswer"])
          Next
          sVal = SubChoose(xoption, "Triple Columns", $xData[j][0])
          If sVal Then
            AddSubTableData($id, $xData[j][2], $xData[j][5], "Triple Columns", sVal)
            xVarGridView[j] = LoadSubTable($xData[j][2], $frm, aGridView[j])
          Endif

        Else If res1["fldanswertype"] = "Clinical Scale" Then
          For Each res
            xoption.Add(res["fldanswer"] & "|" & res["fldscale"] & "|" & res["fldscalegroup"])
          Next
          sVal = SubChoose(xoption, "Clinical Scale", $xData[j][0])
          If sVal Then
            aClinBox[j].Value = sVal[0]
            aTextArea[j].Text = sVal[1]
          Endif

          ' Else If res1["fldanswertype"] = "Left and Right" Then
          '   aLeftRight[j].LeftText = aLeftRight[j].LeftText & res["fldanswer"]
          '   aLeftRight[j].RightText = aLeftRight[j].RightText & res["fldanswer"]

          ' Else If res1["fldanswertype"] = "Date Time" Then
          '   aDateBox[j].Value = Now()
          '
          ' Else If res1["fldanswertype"] = "BS Date" Then
          '   aDateBox[j].Value = Now()
          '
          ' Else If res1["fldanswertype"] = "Calculated" Then

        Endif
      Endif

    Endif
  Endif

End

Public Sub btnfill_Click()

  Dim j As Integer
  Dim res As Result
  Dim sql As String
  Dim asx As String[]

  For j = 0 To $xData.Count - 1
    If j < 49 Then

      If $xData[j][0] = "Final Impression" Then
        If aHTMLText[j] Then
          If Not aHTMLText[j].Text Then
            aHTMLText[j].RichText = modAllExam.GetExamDefaultValue($frm, lblitem.Text)
          Endif
        Else If aGenTextArea[j] Then
          If Not aGenTextArea[j].Text Then
            aGenTextArea[j].Text = modAllExam.GetExamDefaultValue($frm, lblitem.Text)
          Endif
        Endif

      Else
        If $frm = "Test" Then
          sql = "select flddetail from tbltestquali where fldsubtest=&1 and fldtestid=&2"
        Else If $frm = "Exam" Then
          sql = "select flddetail from tblexamquali where fldsubexam=&1 and fldexamid=&2"
        Else If $frm = "Radio" Then
          sql = "select flddetail from tblradioquali where fldsubexam=&1 and fldexamid=&2"
        Endif
        res = modDatabase.$myConn.Exec(sql, $xData[j][0], lblitem.Text)
        If res.Available Then

          res.MoveLast
          If aHTMLText[j] Then
            If Not aHTMLText[j].Text Then
              aHTMLText[j].RichText = res["flddetail"]
            Endif

          Else If aGenTextArea[j] Then
            If Not aGenTextArea[j].Text Then
              aGenTextArea[j].Text = res["flddetail"]
            Endif

          Else If aComboBox[j] Then
            If Not aComboBox[j].Text Then
              aComboBox[j].Text = res["flddetail"]
            Endif

          Else If aDichoValue[j] Then
            If Not aDichoValue[j].Value Then
              aDichoValue[j].Value = res["flddetail"]
            Endif

          Else If aLineText[j] Then
            If Not aLineText[j].Text Then
              aLineText[j].Text = res["flddetail"]
            Endif

          Else If aUnitText[j] Then
            asx = New String[]
            asx = Split(res["flddetail"], Space(1))
            If asx.Count = 2 Then
              aValueBox[j].Value = CFloat(asx[0])
              aUnitText[j].Text = asx[1]
            Else If asx.Count = 1 Then
              aValueBox[j].Value = CFloat(asx[0])
            Endif

          Else If aCalcUnit[j] Then
            asx = New String[]
            asx = Split(res["flddetail"], Space(1))
            If asx.Count = 2 Then
              aCalcBox[j].Value = modReportVar.GetCalcValueFloat(asx[0], $encid)
              aCalcUnit[j].Text = asx[1]
            Else If asx.Count = 1 Then
              aCalcBox[j].Value = modReportVar.GetCalcValueFloat(asx[0], $encid)
            Endif

          Endif

        Endif
      Endif

    Endif
  Next

End

Public Sub chkabnall_Click()

  Dim j As Integer

  For j = 0 To $xData.Count - 1
    If j < 49 Then
      aAbnormCheck[j].Value = chkabnall.Value
    Endif
  Next

End

Private Function GetCalculateValue(sLine As String) As Float

  Dim i As Integer
  Dim xval As Float

  If sLine Then
    For i = 0 To $xData.Count - 1
      If aValueBox[i] Then
        If (String.InStr(sLine, $xData[i][0]) > 0) Then                                   ''
          sLine = Replace(sLine, "{" & $xData[i][0] & "}", CStr(aValueBox[i].Value))
        Endif
      Endif
    Next
    If (String.InStr(sLine, "$Calc[") > 0) Then
      sLine = modReportVar.GetReportCalculation(sLine)
    Endif
    xval = CFloat(sLine)

  Else
    xval = 0
  Endif

  Return xval

End

''-------------- icons
Public Sub btntxtmulti_Click()

  Dim j As Integer

  Try j = $FocusTag
  If aHTMLText[j] Then
    aHTMLText[j].RichText = aHTMLText[j].RichText & Space(1) & modFillContainer.GetExtraTextArea($xData[j][0], aHTMLText[j].Text)
  Else If aGenTextArea[j] Then
    aGenTextArea[j].Text = aGenTextArea[j].Text & Space(1) & GetTextArea($xData[j][0], aGenTextArea[j].Text)
  Endif

End

Public Sub btnexecexam_Click()

  Dim j As Integer

  Try j = $FocusTag
  If aHTMLText[j] Then
    aHTMLText[j].RichText = aHTMLText[j].RichText & modCloudAI.GetPatCloudAIResponse($encid, aHTMLText[j].Text)
  Else If aGenTextArea[j] Then
    aGenTextArea[j].Text = aGenTextArea[j].Text & modCloudAI.GetPatCloudAIResponse($encid, aGenTextArea[j].Text)
  Endif

End

Public Sub btntempltext_Click()

  Dim j As Integer

  Try j = $FocusTag
  If aHTMLText[j] Then
    aHTMLText[j].RichText = aHTMLText[j].RichText & DictionaryVIew(modBasic.$dictadvPath)
  Else If aGenTextArea[j] Then
    aGenTextArea[j].Text = aGenTextArea[j].Text & DictionaryVIew(modBasic.$dictadvPath)
  Endif

End

''================== Print ===================
Public Sub btnarchive_Click()

  Dim cLabForm As CLabReport
  Dim cRadioForm As CRadioReport

  If $frm = "Test" Then
    cLabForm = New CLabReport($id, cmbprintform.Text, "", chkprinted.Value)
    cLabForm.GetReportArchived()
  Else If $frm = "Radio" Then
    cRadioForm = New CRadioReport($id, cmbprintform.Text, chkprinted.Value)
    cRadioForm.GetReportArchived()
  Endif

End

Public Sub btnnohead_Click()

  Dim cLabForm As CLabReport
  Dim cRadioForm As CRadioReport

  If $frm = "Test" Then
    cLabForm = New CLabReport($id, cmbprintform.Text, "", chkprinted.Value)
    cLabForm.GetReportHeadless()
  Else If $frm = "Radio" Then
    cRadioForm = New CRadioReport($id, cmbprintform.Text, chkprinted.Value)
    cRadioForm.GetReportHeadless()
  Endif

End

Public Sub btnreport_Click()

  Dim cLabForm As CLabReport
  Dim cRadioForm As CRadioReport

  If $frm = "Test" Then
    cLabForm = New CLabReport($id, cmbprintform.Text, "", chkprinted.Value)
    cLabForm.GetReportComplete()
  Else If $frm = "Radio" Then
    cRadioForm = New CRadioReport($id, cmbprintform.Text, chkprinted.Value)
    cRadioForm.GetReportComplete()
  Endif

End

Private Function GetCustColHeadings(i As Integer) As String[]

  Dim sDefault As String
  Dim acolx As String[]
  Dim aCoLst As String[]

  sDefault = modAllExam.GetESubxamDefaultValue($frm, lblitem.Text, $xData[i][0])
  If $xData[i][3] = "Dual Columns" Then
    If sDefault Then
      acolx = Split(sDefault, ":")
      If acolx[0] = "Columns" Then
        aCoLst = Split(acolx[1], ";")
      Else
        aCoLst = ["LEFT", "RIGHT"]
      Endif
    Else
      aCoLst = ["LEFT", "RIGHT"]
    Endif

  Else If $xData[i][3] = "Triple Columns" Then
    If sDefault Then
      acolx = Split(sDefault, ":")
      If acolx[0] = "Columns" Then
        aCoLst = Split(acolx[1], ";")
      Else
        aCoLst = ["COLUMN-I", "COLUMN-II", "COLUMN-III"]
      Endif
    Else
      aCoLst = ["COLUMN-I", "COLUMN-II", "COLUMN-III"]
    Endif
  Endif

  Return aCoLst

End
