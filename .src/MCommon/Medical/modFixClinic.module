' Gambas module file

Public Function SysConstFromGetExamID(sExam As String, Optional sCon As Connection) As String

  Dim res As Result
  Dim xx As String
  Dim $con As Connection

  If sCon Then
    $con = sCon
  Else
    $con = modDatabase.$medConn
  Endif

  If modTableCache.$ExamMasterData.Exist(sExam) Then
    xx = modTableCache.$ExamMasterData[sExam]["fldsysconst"]
    If Not xx Then
      xx = ""
    Endif

  Else
    res = $con.Exec("select fldsysconst from tblexam where fldexamid=&1", sExam)
    If res.Available = True Then
      If res["fldsysconst"] Then
        xx = res["fldsysconst"]
      Else
        xx = ""
      Endif
    Else
      xx = ""
    Endif
  Endif
  Return xx

End

Public Function GetExamtOptionType(strTest As String, Optional sCon As Connection) As String

  Dim res As Result
  Dim xx As String
  Dim $con As Connection

  If sCon Then
    $con = sCon
  Else
    $con = modDatabase.$medConn
  Endif

  If modTableCache.$ExamMasterData.Exist(strTest) Then
    xx = modTableCache.$ExamMasterData[strTest]["fldoption"]
    If Not xx Then
      xx = ""
    Endif

  Else
    res = $con.Exec("select fldoption from tblexam where fldexamid=&1", strTest)
    If res.Available Then
      If res["fldoption"] Then
        xx = res["fldoption"]
      Else
        xx = ""
      Endif
    Else
      xx = ""
    Endif
  Endif

  If Not xx Then
    If modMedicine.GetFixedLRExaminations().Exist(strTest) = True Then
      xx = "Left and Right"
    Endif
  Endif
  Return xx

End

Public Function GetExaminationCategory(test As String, Optional sCon As Connection) As String

  Dim xx As String
  Dim res As Result
  Dim $con As Connection

  If sCon Then
    $con = sCon
  Else
    $con = modDatabase.$medConn
  Endif

  If modTableCache.$ExamMasterData.Exist(test) Then
    xx = modTableCache.$ExamMasterData[test]["fldcategory"]
    If Not xx Then
      xx = ""
    Endif

  Else
    res = $con.Exec("select fldcategory from tblexam where fldexamid=&1", test)
    If res.Available Then
      If res["fldcategory"] Then
        xx = res["fldcategory"]
      Else
        xx = ""
      Endif
    Else
      xx = ""
    Endif
  Endif
  Return xx

End

Public Function GetExaminationType(strTest As String, Optional sCon As Connection) As String

  Dim res As Result
  Dim xx As String
  Dim $con As Connection

  If sCon Then
    $con = sCon
  Else
    $con = modDatabase.$medConn
  Endif

  If modTableCache.$ExamMasterData.Exist(strTest) Then
    xx = modTableCache.$ExamMasterData[strTest]["fldtype"]
    If Not xx Then
      xx = "Qualitative"
    Endif

  Else
    res = $con.Exec("select fldtype from tblexam where fldexamid=&1", strTest)
    If res.Available = True Then
      If res["fldtype"] Then
        xx = res["fldtype"]
      Else
        xx = "Qualitative"
      Endif
    Else
      xx = "Qualitative"
    Endif
  Endif
  Return xx

End

Public Function GetExamSysName(sExam As String, Optional sCon As Connection) As String

  Dim res As Result
  Dim xx As String

  Dim $con As Connection

  If sCon Then
    $con = sCon
  Else
    $con = modDatabase.$medConn
  Endif

  If modTableCache.$ExamMasterData.Exist(sExam) Then
    xx = modTableCache.$ExamMasterData[sExam]["fldsysconst"]
    If Not xx Then
      xx = ""
    Endif

  Else
    res = $con.Exec("select fldsysconst from tblexam where fldexamid=&1", sExam)
    If res.Available Then
      If res["fldsysconst"] Then
        xx = res["fldsysconst"]
      Else
        xx = ""
      Endif
    Else
      xx = ""
    Endif
  Endif
  Return xx

End

Public Function GetCritValueExam(strTest As String, Optional sCon As Connection) As Float

  Dim res As Result
  Dim xval As Float
  Dim $con As Connection

  If sCon Then
    $con = sCon
  Else
    $con = modDatabase.$medConn
  Endif

  If modTableCache.$ExamMasterData.Exist(strTest) Then
    xval = modTableCache.$ExamMasterData[strTest]["fldcritical"]
    If Not xval Then
      xval = 0
    Endif

  Else
    res = $con.Exec("select fldcritical from tblexam where fldexamid=&1", strTest)
    If res.Available Then
      If res["fldcritical"] Then
        xval = res["fldcritical"]
      Else
        xval = 0
      Endif
    Else
      xval = 0
    Endif
  Endif

  Return xval

End

''from sys constant
Public Function GetExamIDFromSysConst(syscons As String) As String

  Dim res As Result
  Dim xx As String

  res = modDatabase.$medConn.Exec("select fldexamid from tblexam where fldsysconst=&1", syscons)
  If res.Available = True Then
    res.MoveFirst
    If res["fldexamid"] Then
      xx = res["fldexamid"]
    Else
      xx = ""
    Endif
  Else
    xx = ""
  Endif

  Return xx

End

Public Function GetExamSysOptionType(strSys As String) As String

  Dim res As Result
  Dim xx As String

  res = modDatabase.$medConn.Exec("select fldoption from tblexam where fldsysconst=&1", strSys)
  If res.Available Then
    If res["fldoption"] Then
      xx = res["fldoption"]
    Else
      xx = ""
    Endif
  Else
    xx = ""
  Endif

  If Not xx Then
    If modMedicine.GetFixedLRExaminations().Exist(strSys) = True Then
      xx = "Left and Right"
    Endif
  Endif
  Return xx

End

''----------------------------- General --------------------------------------
Public Function SelectDeptExamAbnormal(sDepart As String, sExam As String, sOption As String, Optional xOptionType As String) As Boolean

  Dim res As Result
  Dim xabn As Boolean

  If xOptionType Then
    res = modDatabase.$medConn.Exec("select fldabnormal from tbldeptexamoption where fldexamid=&1 and flddept=&2 and fldtanswertype=&3 and fldanswer=&4", sExam, sDepart, xOptionType, sOption)
  Else
    res = modDatabase.$medConn.Exec("select fldabnormal from tbldeptexamoption where fldexamid=&1 and flddept=&2 and fldanswer=&3", sExam, sOption)
  Endif
  If res.Available Then
    If res["fldabnormal"] Then
      xabn = res["fldabnormal"]
    Else
      xabn = False
    Endif
  Else
    xabn = False
  Endif

  Return xabn

End

Public Function GetLeftRightMainHeader(sType As String, sExam As String) As String

  Dim opt As String[]
  Dim optStr As String

  opt = modAllExam.SelectExamOptionList(sType, sExam, "Left and Right")
  If opt.Count >= 2 Then
    optStr = modString.GetLefRightJSON(opt[0], opt[1])
  Endif

  Return optStr

End

'NOTE: -------------------------------------- EXAM Procedure ---------------------------------------
Public Function GetSubExamArray(examid As String) As String[]

  Dim res As Result
  Dim xx As String[]

  res = modDatabase.$medConn.Exec("select fldsubexam from tblexamquali where fldexamid=&1 ORDER BY fldindex", examid)
  xx = modControlSub.GetDirectFillresult(res)

  Return xx

End

Public Function GetSubExamCollection(examid As String) As Variant[]

  Dim res As Result
  Dim xvar As Variant[]
  Dim xcol As Collection

  xvar = New Variant[]
  res = modDatabase.$medConn.Exec("select fldsubexam,fldtanswertype from tblexamquali where fldexamid=&1 ORDER BY fldindex", examid)
  If res.Available Then
    For Each res
      xcol = New Collection
      xcol.Add(res["fldsubexam"], "fldsubexam")
      xcol.Add(res["fldtanswertype"], "fldtanswertype")
      xvar.Add(xcol)
    Next
  Endif

  Return xvar

End

Public Function GetSubExamOption(headid As String, subheadid As String) As String

  Dim res As Result
  Dim xx As String

  res = modDatabase.$medConn.Exec("select fldtanswertype from tblexamquali where fldexamid=&1 and fldsubexam=&2", headid, subheadid)
  If res.Available Then
    If res["fldtanswertype"] Then
      xx = res["fldtanswertype"]
    Else
      xx = ""
    Endif
  Else
    xx = ""
  Endif
  Return xx

End

Public Function GetExamWithCategory(sExamList As String[]) As String[]

  Dim xx As String
  Dim xval As String[]

  xval = New String[]
  For Each xx In sExamList
    xval.Add(GetExaminationCategory(xx) & "|" & xx)
  Next
  Return xval

End

Public Function MethodsForClinExam(sTestName As String) As String[]

  Dim xx As String[]
  Dim res As Result

  res = modDatabase.$medConn.Exec("select distinct(fldmethod) as col from tblexamlimit where fldexamid=&1", sTestName)
  xx = modControlSub.GetDirectFillresult(res)
  Return xx

End

Public Function GetExamQualiTextReference(txttest As String) As String

  Dim res As Result
  Dim xx As String

  res = modDatabase.$medConn.Exec("select fldanswer from tblexamoption where fldexamid=&1 and fldanswertype=&2 ORDER BY fldindex", txttest, "Text Reference")
  If res.Available = True Then
    res.MoveFirst
    If res["fldanswer"] Then
      xx = res["fldanswer"]
    Else
      xx = ""
    Endif
  Else
    xx = ""
  Endif
  Return xx

End

Public Function GetExamUnitWithOutAgeSex(txtexam As String) As String

  Dim res As Result
  Dim xx As String

  res = modDatabase.$medConn.Exec("select fldunit from tblexamlimit where fldexamid=&1", txtexam)                                                              ''
  If res.Available = True Then
    res.MoveFirst
    If res["fldunit"] Then
      xx = res["fldunit"]
    Else
      xx = ""
    Endif
  Else
    xx = ""
  Endif

  Return xx

End

Public Function ExamTableValue(sField As String, txtexam As String) As Float

  Dim res1 As Result
  Dim xx As Float

  res1 = modDatabase.$medConn.Exec(Subst("select &1 as fld from tblexam", sField) & " where fldexamid=&1", txtexam)
  If res1.Available Then
    If res1["fld"] Then
      xx = res1["fld"]
    Else
      xx = 0
    Endif
  Else
    xx = 0
  Endif

  Return xx

End
