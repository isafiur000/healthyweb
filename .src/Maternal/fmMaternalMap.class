' Gambas class file

Private $rData1 As Result
Private $aMyFields1 As String[]
Private $locatMode As String
Private $HFType As String = "DMNR"

Private ServList As String[] = ["ANC Visit", "PNC Visit", "Admission", "Discharge", "Referred", "Death", "Live Baby", "Still Birth"]
Private $hospList As String[]
Private xancvisitColl As Collection
Private xpncvisitColl As Collection
Private xdelliveColl As Collection
Private xdelstilColl As Collection
Private xadmissionColl As Collection
Private xdischargeColl As Collection
Private xreferColl As Collection
Private xdeathColl As Collection

Public Sub _new()

  cmblocation.List = ["Hospital", "Municipality", "Category", "District", "Province"]
  $locatMode = "Hospital"
  SetLocations()
  LoadSurveillanceData()

End

Public Sub mnurowform_Click()

  Dim aList As String[] = ["Hospital", "Municipality", "Category", "District", "Province"]
  Dim xx As String

  xx = InputCombo("Select Row Format", "Row Format", aList, "Hospital", True)
  If xx Then
    $locatMode = xx
  Else
    $locatMode = "Hospital"
  Endif
  SetLocations()

End

Private Sub SetLocations()

  If modBasic.$HospCode Then
    If modDataRepo.$RepositoryMode = "Hospital" Then
    Else
      If cmbvalue.Text Then
        $hospList = modDataRepo.GetRepoValueListSelectedType($locatMode, modBasic.$HospCode, cmblocation.Text, cmbvalue.Text)
      Else
        $hospList = modDataRepo.GetRepoValueListSelectedType($locatMode, modBasic.$HospCode)
      Endif
    Endif
  Else
    If cmbvalue.Text Then
      $hospList = modDataRepo.GetRepoValueListType($locatMode, cmblocation.Text, cmbvalue.Text)
    Else
      $hospList = modDataRepo.GetRepoValueListType($locatMode)
    Endif
  Endif

End

Public Sub cmblocation_Click()

  If cmbvalue.List.Count Then
    cmbvalue.List.Clear()
  Endif
  cmbvalue.Text = ""
  If modBasic.$HospCode Then
    If modDataRepo.$RepositoryMode = "Hospital" Then
    Else
      cmbvalue.List = modDataRepo.GetRepoValueListSelectedType(cmblocation.Text, modBasic.$HospCode)
    Endif
  Else
    cmbvalue.List = modDataRepo.GetRepoValueListType(cmblocation.Text)
  Endif
  SetLocations()

End

Public Sub dtnepfir_Click()

  Dim xx As String

  xx = BSDateFormat(("Enter BS Date in yyyy/mm/dd format"), ("Date Converter"), modDate.ConvertToLocaldate(dtfir.Value))
  If xx Then
    dtfir.Value = modDate.ConvertToEnglishdate(xx)
  Endif

End

Public Sub dtneplast_Click()

  Dim xx As String

  xx = BSDateFormat(("Enter BS Date in yyyy/mm/dd format"), ("Date Converter"), modDate.ConvertToLocaldate(dtlast.Value))
  If xx Then
    dtlast.Value = modDate.ConvertToEnglishdate(xx)
  Endif

End

Private Sub ShowAllGrids()

  LoadSummaryData()

End

Public Sub btnshow_Click()

  SetLocations()
  ShowAllGrids()

End

Public Sub btntoday_Click()

  dtfir.Value = modDate.StartSqlDate(Now())
  dtlast.Value = modDate.EndSqlDate(Now())
  SetLocations()
  ShowAllGrids()

End

Public Sub btnyesterday_Click()

  dtfir.Value = modDate.StartSqlDate(DateAdd(Now(), gb.Day, -1))
  dtlast.Value = modDate.EndSqlDate(DateAdd(Now(), gb.Day, -1))
  SetLocations()
  ShowAllGrids()

End

Public Sub btnthismonth_Click()

  If modBasic.$DateFormat = "BS Date" Then
    dtfir.Value = modDate.StartSqlMonthBS(Now())
    dtlast.Value = modDate.EndSqlMonthBS(Now())
  Else
    dtfir.Value = modDate.StartSqlMonth(Now())
    dtlast.Value = modDate.EndSqlMonth(Now())
  Endif
  SetLocations()
  ShowAllGrids()

End

Public Sub btnlastmonth_Click()

  If modBasic.$DateFormat = "BS Date" Then
    dtfir.Value = modDate.StartSqlMonthBS(DateAdd(Now(), gb.Month, -1))
    dtlast.Value = modDate.EndSqlMonthBS(DateAdd(Now(), gb.Month, -1))
  Else
    dtfir.Value = modDate.StartSqlMonth(DateAdd(Now(), gb.Month, -1))
    dtlast.Value = modDate.EndSqlMonth(DateAdd(Now(), gb.Month, -1))
  Endif
  SetLocations()
  ShowAllGrids()

End

Public Sub btnthisyear_Click()

  If modBasic.$DateFormat = "BS Date" Then
    dtfir.Value = modDate.StartSqlYearBS(Now())
    dtlast.Value = modDate.EndSqlYearBS(Now())
  Else
    dtfir.Value = modDate.StartSqlYear(Now())
    dtlast.Value = modDate.EndSqlYear(Now())
  Endif
  SetLocations()
  ShowAllGrids()

End

Public Sub btnlastyear_Click()

  If modBasic.$DateFormat = "BS Date" Then
    dtfir.Value = modDate.StartSqlYearBS(DateAdd(Now(), gb.Year, -1))
    dtlast.Value = modDate.EndSqlYearBS(DateAdd(Now(), gb.Year, -1))
  Else
    dtfir.Value = modDate.StartSqlYear(DateAdd(Now(), gb.Year, -1))
    dtlast.Value = modDate.EndSqlYear(DateAdd(Now(), gb.Year, -1))
  Endif
  SetLocations()
  ShowAllGrids()

End

''=============================== SUMMARY ===========================
Private Function GetCollectionData(res As Result) As Collection

  Dim xcoll As Collection

  xcoll = New Collection
  If res.Available Then
    For Each res

      If $locatMode = "Municipality" Then
        If res["tblhospitals.fldpality"] Then
          xcoll.Add(res["xtotal"], res["tblhospitals.fldpality"])
        Endif
      Else If $locatMode = "Category" Then
        If res["tblhospitals.fldcategory"] Then
          xcoll.Add(res["xtotal"], res["tblhospitals.fldcategory"])
        Endif
      Else If $locatMode = "District" Then
        If res["tblhospitals.flddistrict"] Then
          xcoll.Add(res["xtotal"], res["tblhospitals.flddistrict"])
        Endif
      Else If $locatMode = "Province" Then
        If res["tblhospitals.fldprovince"] Then
          xcoll.Add(res["xtotal"], res["tblhospitals.fldprovince"])
        Endif
      Else
        If res["fldhospcode"] Then
          xcoll.Add(res["xtotal"], res["fldhospcode"])
        Endif
      Endif
    Next
  Endif
  Return xcoll

End

Private Function GetTotalArray(sColl As Collection) As Integer

  Dim sKey As Integer
  Dim xtot As Integer

  xtot = 0
  For Each sKey In sColl
    If $hospList.Exist(sColl.Key) Then
      xtot = xtot + sKey
    Endif
  Next

  Return xtot

End

Private Function RepoStr(sTable As String) As String

  Dim xRepostr As String

  If modBasic.$HospCode Then
    If $locatMode = "Hospital" Then
      xRepostr = modDataRepo.GetRepoLastStr(sTable)
    Else
      If modDataRepo.$RepositoryMode = "Category" Then
        xRepostr = db.Subst(" and tblhospitals.fldcategory like &1", modBasic.$HospCode)
      Else If modDataRepo.$RepositoryMode = "District" Then
        xRepostr = db.Subst(" and tblhospitals.flddistrict like &1", modBasic.$HospCode)
      Else If modDataRepo.$RepositoryMode = "Province" Then
        xRepostr = db.Subst(" and tblhospitals.fldprovince like &1", modBasic.$HospCode)
      Else If modDataRepo.$RepositoryMode = "Municipality" Then
        xRepostr = db.Subst(" and tblhospitals.fldpality like &1", modBasic.$HospCode)
      Else
        xRepostr = db.Subst(" and tblhospitals.fldhospcode like &1", modBasic.$HospCode)
      Endif
    Endif
  Else
    xRepostr = ""
  Endif

  Return xRepostr

End

Private Sub LoadSummaryData()

  Dim i As Integer
  Dim xstr As String

  If cmbvalue.Text Then
    If cmblocation.Text = "Category" Then
      xstr = db.Subst(" and tblhospitals.fldcategory like &1", cmbvalue.Text)
    Else If cmblocation.Text = "District" Then
      xstr = db.Subst(" and tblhospitals.flddistrict like &1", cmbvalue.Text)
    Else If cmblocation.Text = "Province" Then
      xstr = db.Subst(" and tblhospitals.fldprovince like &1", cmbvalue.Text)
    Else If cmblocation.Text = "Municipality" Then
      xstr = db.Subst(" and tblhospitals.fldpality like &1", cmbvalue.Text)
    Else
      xstr = db.Subst(" and tblhospitals.fldhospcode like &1", cmbvalue.Text)
    Endif
  Else
    xstr = ""
  Endif

  If $locatMode = "Municipality" Then
    xancvisitColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldpality,COUNT(tblopvisit.fldencounterval) as xtotal from tblopvisit inner join tblhospitals on tblopvisit.fldhospcode=tblhospitals.fldhospcode where tblopvisit.fldconsulttime>=&1 and tblopvisit.fldconsulttime<=&2 and tblopvisit.fldconsultname=&3 and tblhospitals.fldcategory=&4" & RepoStr("tblopvisit") & xstr & " GROUP BY tblhospitals.fldpality", dtfir.Value, dtlast.Value, "ANC Visit", $HFType))                    ''
    xpncvisitColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldpality,COUNT(tblopvisit.fldencounterval) as xtotal from tblopvisit inner join tblhospitals on tblopvisit.fldhospcode=tblhospitals.fldhospcode where tblopvisit.fldconsulttime>=&1 and tblopvisit.fldconsulttime<=&2 and tblopvisit.fldconsultname=&3 and tblhospitals.fldcategory=&4" & RepoStr("tblopvisit") & xstr & " GROUP BY tblhospitals.fldpality", dtfir.Value, dtlast.Value, "PNC Visit", $HFType))                    ''
    xadmissionColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldpality,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3 and tblhospitals.fldcategory=&4" & RepoStr("tblpatientdate") & xstr & " GROUP BY tblhospitals.fldpality", dtfir.Value, dtlast.Value, "Admitted", $HFType))
    xdischargeColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldpality,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3 and tblhospitals.fldcategory=&4" & RepoStr("tblpatientdate") & xstr & " GROUP BY tblhospitals.fldpality", dtfir.Value, dtlast.Value, "Discharged", $HFType))
    xreferColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldpality,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3 and tblhospitals.fldcategory=&4" & RepoStr("tblpatientdate") & xstr & " GROUP BY tblhospitals.fldpality", dtfir.Value, dtlast.Value, "Refer", $HFType))
    xdeathColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldpality,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3 and tblhospitals.fldcategory=&4" & RepoStr("tblpatientdate") & xstr & " GROUP BY tblhospitals.fldpality", dtfir.Value, dtlast.Value, "Death", $HFType))
    xdelliveColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldpality,COUNT(tblconfinement.fldencounterval) as xtotal from tblconfinement inner join tblhospitals on tblconfinement.fldhospcode=tblhospitals.fldhospcode where tblconfinement.flddeltime>=&1 and tblconfinement.flddeltime<=&2 and tblconfinement.flddelresult=&3 and tblhospitals.fldcategory=&4" & RepoStr("tblconfinement") & xstr & " GROUP BY tblhospitals.fldpality", dtfir.Value, dtlast.Value, "Live Baby", $HFType))
    xdelstilColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldpality,COUNT(tblconfinement.fldencounterval) as xtotal from tblconfinement inner join tblhospitals on tblconfinement.fldhospcode=tblhospitals.fldhospcode where tblconfinement.flddeltime>=&1 and tblconfinement.flddeltime<=&2 and tblconfinement.flddelresult<>&3 and tblhospitals.fldcategory=&4" & RepoStr("tblconfinement") & xstr & " GROUP BY tblhospitals.fldpality", dtfir.Value, dtlast.Value, "Live Baby", $HFType))

  Else If $locatMode = "Category" Then
    xancvisitColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldcategory,COUNT(tblopvisit.fldencounterval) as xtotal from tblopvisit inner join tblhospitals on tblopvisit.fldhospcode=tblhospitals.fldhospcode where tblopvisit.fldconsulttime>=&1 and tblopvisit.fldconsulttime<=&2 and tblopvisit.fldconsultname=&3 and tblhospitals.fldcategory=&4" & RepoStr("tblopvisit") & xstr & " GROUP BY tblhospitals.fldcategory", dtfir.Value, dtlast.Value, "ANC Visit", $HFType))                    ''
    xpncvisitColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldcategory,COUNT(tblopvisit.fldencounterval) as xtotal from tblopvisit inner join tblhospitals on tblopvisit.fldhospcode=tblhospitals.fldhospcode where tblopvisit.fldconsulttime>=&1 and tblopvisit.fldconsulttime<=&2 and tblopvisit.fldconsultname=&3 and tblhospitals.fldcategory=&4" & RepoStr("tblopvisit") & xstr & " GROUP BY tblhospitals.fldcategory", dtfir.Value, dtlast.Value, "PNC Visit", $HFType))                    ''                   ''
    xadmissionColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldcategory,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3 and tblhospitals.fldcategory=&4" & RepoStr("tblpatientdate") & xstr & " GROUP BY tblhospitals.fldcategory", dtfir.Value, dtlast.Value, "Admitted", $HFType))
    xdischargeColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldcategory,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3 and tblhospitals.fldcategory=&4" & RepoStr("tblpatientdate") & xstr & " GROUP BY tblhospitals.fldcategory", dtfir.Value, dtlast.Value, "Discharged", $HFType))
    xreferColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldcategory,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3 and tblhospitals.fldcategory=&4" & RepoStr("tblpatientdate") & xstr & " GROUP BY tblhospitals.fldcategory", dtfir.Value, dtlast.Value, "Refer", $HFType))
    xdeathColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldcategory,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3 and tblhospitals.fldcategory=&4" & RepoStr("tblpatientdate") & xstr & " GROUP BY tblhospitals.fldcategory", dtfir.Value, dtlast.Value, "Death", $HFType))
    xdelliveColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldcategory,COUNT(tblconfinement.fldencounterval) as xtotal from tblconfinement inner join tblhospitals on tblconfinement.fldhospcode=tblhospitals.fldhospcode where tblconfinement.flddeltime>=&1 and tblconfinement.flddeltime<=&2 and tblconfinement.flddelresult=&3 and tblhospitals.fldcategory=&4" & RepoStr("tblconfinement") & xstr & " GROUP BY tblhospitals.fldcategory", dtfir.Value, dtlast.Value, "Live Baby", $HFType))
    xdelstilColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldcategory,COUNT(tblconfinement.fldencounterval) as xtotal from tblconfinement inner join tblhospitals on tblconfinement.fldhospcode=tblhospitals.fldhospcode where tblconfinement.flddeltime>=&1 and tblconfinement.flddeltime<=&2 and tblconfinement.flddelresult<>&3 and tblhospitals.fldcategory=&4" & RepoStr("tblconfinement") & xstr & " GROUP BY tblhospitals.fldcategory", dtfir.Value, dtlast.Value, "Live Baby", $HFType))

  Else If $locatMode = "District" Then
    xancvisitColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.flddistrict,COUNT(tblopvisit.fldencounterval) as xtotal from tblopvisit inner join tblhospitals on tblopvisit.fldhospcode=tblhospitals.fldhospcode where tblopvisit.fldconsulttime>=&1 and tblopvisit.fldconsulttime<=&2 and tblopvisit.fldconsultname=&3 and tblhospitals.fldcategory=&4" & RepoStr("tblopvisit") & xstr & " GROUP BY tblhospitals.flddistrict", dtfir.Value, dtlast.Value, "ANC Visit", $HFType))                    ''
    xpncvisitColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.flddistrict,COUNT(tblopvisit.fldencounterval) as xtotal from tblopvisit inner join tblhospitals on tblopvisit.fldhospcode=tblhospitals.fldhospcode where tblopvisit.fldconsulttime>=&1 and tblopvisit.fldconsulttime<=&2 and tblopvisit.fldconsultname=&3 and tblhospitals.fldcategory=&4" & RepoStr("tblopvisit") & xstr & " GROUP BY tblhospitals.flddistrict", dtfir.Value, dtlast.Value, "PNC Visit", $HFType))                    ''
    xadmissionColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.flddistrict,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3 and tblhospitals.fldcategory=&4" & RepoStr("tblpatientdate") & xstr & " GROUP BY tblhospitals.flddistrict", dtfir.Value, dtlast.Value, "Admitted", $HFType))
    xdischargeColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.flddistrict,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3 and tblhospitals.fldcategory=&4" & RepoStr("tblpatientdate") & xstr & " GROUP BY tblhospitals.flddistrict", dtfir.Value, dtlast.Value, "Discharged", $HFType))
    xreferColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.flddistrict,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3 and tblhospitals.fldcategory=&4" & RepoStr("tblpatientdate") & xstr & " GROUP BY tblhospitals.flddistrict", dtfir.Value, dtlast.Value, "Refer", $HFType))
    xdeathColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.flddistrict,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3 and tblhospitals.fldcategory=&4" & RepoStr("tblpatientdate") & xstr & " GROUP BY tblhospitals.flddistrict", dtfir.Value, dtlast.Value, "Death", $HFType))
    xdelliveColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.flddistrict,COUNT(tblconfinement.fldencounterval) as xtotal from tblconfinement inner join tblhospitals on tblconfinement.fldhospcode=tblhospitals.fldhospcode where tblconfinement.flddeltime>=&1 and tblconfinement.flddeltime<=&2 and tblconfinement.flddelresult=&3 and tblhospitals.fldcategory=&4" & RepoStr("tblconfinement") & xstr & " GROUP BY tblhospitals.flddistrict", dtfir.Value, dtlast.Value, "Live Baby", $HFType))
    xdelstilColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.flddistrict,COUNT(tblconfinement.fldencounterval) as xtotal from tblconfinement inner join tblhospitals on tblconfinement.fldhospcode=tblhospitals.fldhospcode where tblconfinement.flddeltime>=&1 and tblconfinement.flddeltime<=&2 and tblconfinement.flddelresult<>&3 and tblhospitals.fldcategory=&4" & RepoStr("tblconfinement") & xstr & " GROUP BY tblhospitals.flddistrict", dtfir.Value, dtlast.Value, "Live Baby", $HFType))

  Else If $locatMode = "Province" Then
    xancvisitColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldprovince,COUNT(tblopvisit.fldencounterval) as xtotal from tblopvisit inner join tblhospitals on tblopvisit.fldhospcode=tblhospitals.fldhospcode where tblopvisit.fldconsulttime>=&1 and tblopvisit.fldconsulttime<=&2 and tblopvisit.fldconsultname=&3 and tblhospitals.fldcategory=&4" & RepoStr("tblopvisit") & xstr & " GROUP BY tblhospitals.fldprovince", dtfir.Value, dtlast.Value, "ANC Visit", $HFType))                    ''
    xpncvisitColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldprovince,COUNT(tblopvisit.fldencounterval) as xtotal from tblopvisit inner join tblhospitals on tblopvisit.fldhospcode=tblhospitals.fldhospcode where tblopvisit.fldconsulttime>=&1 and tblopvisit.fldconsulttime<=&2 and tblopvisit.fldconsultname=&3 and tblhospitals.fldcategory=&4" & RepoStr("tblopvisit") & xstr & " GROUP BY tblhospitals.fldprovince", dtfir.Value, dtlast.Value, "PNC Visit", $HFType))                    ''                                   ''
    xadmissionColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldprovince,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3 and tblhospitals.fldcategory=&4" & RepoStr("tblpatientdate") & xstr & " GROUP BY tblhospitals.fldprovince", dtfir.Value, dtlast.Value, "Admitted", $HFType))
    xdischargeColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldprovince,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3 and tblhospitals.fldcategory=&4" & RepoStr("tblpatientdate") & xstr & " GROUP BY tblhospitals.fldprovince", dtfir.Value, dtlast.Value, "Discharged", $HFType))
    xreferColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldprovince,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3 and tblhospitals.fldcategory=&4" & RepoStr("tblpatientdate") & xstr & " GROUP BY tblhospitals.fldprovince", dtfir.Value, dtlast.Value, "Refer", $HFType))
    xdeathColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldprovince,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3 and tblhospitals.fldcategory=&4" & RepoStr("tblpatientdate") & xstr & " GROUP BY tblhospitals.fldprovince", dtfir.Value, dtlast.Value, "Death", $HFType))
    xdelliveColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldprovince,COUNT(tblconfinement.fldencounterval) as xtotal from tblconfinement inner join tblhospitals on tblconfinement.fldhospcode=tblhospitals.fldhospcode where tblconfinement.flddeltime>=&1 and tblconfinement.flddeltime<=&2 and tblconfinement.flddelresult=&3 and tblhospitals.fldcategory=&4" & RepoStr("tblconfinement") & xstr & " GROUP BY tblhospitals.fldprovince", dtfir.Value, dtlast.Value, "Live Baby", $HFType))
    xdelstilColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldprovince,COUNT(tblconfinement.fldencounterval) as xtotal from tblconfinement inner join tblhospitals on tblconfinement.fldhospcode=tblhospitals.fldhospcode where tblconfinement.flddeltime>=&1 and tblconfinement.flddeltime<=&2 and tblconfinement.flddelresult<>&3 and tblhospitals.fldcategory=&4" & RepoStr("tblconfinement") & xstr & " GROUP BY tblhospitals.fldprovince", dtfir.Value, dtlast.Value, "Live Baby", $HFType))

  Else
    xancvisitColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldhospcode,COUNT(tblopvisit.fldencounterval) as xtotal from tblopvisit inner join tblhospitals on tblopvisit.fldhospcode=tblhospitals.fldhospcode where tblopvisit.fldconsulttime>=&1 and tblopvisit.fldconsulttime<=&2 and tblopvisit.fldconsultname=&3 and tblhospitals.fldcategory=&4" & RepoStr("tblopvisit") & xstr & " GROUP BY tblhospitals.fldhospcode", dtfir.Value, dtlast.Value, "ANC Visit", $HFType))                    ''
    xpncvisitColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldhospcode,COUNT(tblopvisit.fldencounterval) as xtotal from tblopvisit inner join tblhospitals on tblopvisit.fldhospcode=tblhospitals.fldhospcode where tblopvisit.fldconsulttime>=&1 and tblopvisit.fldconsulttime<=&2 and tblopvisit.fldconsultname=&3 and tblhospitals.fldcategory=&4" & RepoStr("tblopvisit") & xstr & " GROUP BY tblhospitals.fldhospcode", dtfir.Value, dtlast.Value, "PNC Visit", $HFType))                    ''
    xadmissionColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldhospcode,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3 and tblhospitals.fldcategory=&4" & RepoStr("tblpatientdate") & xstr & " GROUP BY tblhospitals.fldhospcode", dtfir.Value, dtlast.Value, "Admitted", $HFType))
    xdischargeColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldhospcode,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3 and tblhospitals.fldcategory=&4" & RepoStr("tblpatientdate") & xstr & " GROUP BY tblhospitals.fldhospcode", dtfir.Value, dtlast.Value, "Discharged", $HFType))
    xreferColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldhospcode,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3 and tblhospitals.fldcategory=&4" & RepoStr("tblpatientdate") & xstr & " GROUP BY tblhospitals.fldhospcode", dtfir.Value, dtlast.Value, "Refer", $HFType))
    xdeathColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldhospcode,COUNT(tblpatientdate.fldencounterval) as xtotal from tblpatientdate inner join tblhospitals on tblpatientdate.fldhospcode=tblhospitals.fldhospcode where tblpatientdate.fldtime>=&1 and tblpatientdate.fldtime<=&2 and tblpatientdate.fldhead=&3 and tblhospitals.fldcategory=&4" & RepoStr("tblpatientdate") & xstr & " GROUP BY tblhospitals.fldhospcode", dtfir.Value, dtlast.Value, "Death".$HFType))
    xdelliveColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldhospcode,COUNT(tblconfinement.fldencounterval) as xtotal from tblconfinement inner join tblhospitals on tblconfinement.fldhospcode=tblhospitals.fldhospcode where tblconfinement.flddeltime>=&1 and tblconfinement.flddeltime<=&2 and tblconfinement.flddelresult=&3 and tblhospitals.fldcategory=&4" & RepoStr("tblconfinement") & xstr & " GROUP BY tblhospitals.fldhospcode", dtfir.Value, dtlast.Value, "Live Baby", $HFType))
    xdelstilColl = GetCollectionData(modDatabase.$syConn.Exec("select tblhospitals.fldhospcode,COUNT(tblconfinement.fldencounterval) as xtotal from tblconfinement inner join tblhospitals on tblconfinement.fldhospcode=tblhospitals.fldhospcode where tblconfinement.flddeltime>=&1 and tblconfinement.flddeltime<=&2 and tblconfinement.flddelresult<>&3 and tblhospitals.fldcategory=&4" & RepoStr("tblconfinement") & xstr & " GROUP BY tblhospitals.fldhospcode", dtfir.Value, dtlast.Value, "Live Baby", $HFType))

  Endif

  GridView1.Clear()
  GridView1.Columns.Count = 9
  GridView1.Count = $hospList.Count + 1

  With GridView1
    .Columns[0].Width = CStr(125 * modBasic.$AppWidthRatio) & "px"
    .Columns[0].Text = "Variable"
    For i = 1 To 8
      .Columns[i].Width = CStr(75 * modBasic.$AppWidthRatio) & "px"
      .Columns[i].Text = ServList[i - 1]
    Next
  End With

End

Public Sub GridView1_Data(Row As Integer, Column As Integer, Data As WebTableData)

  modGridView.GridViewDecoration(Data, Row)
  If Row = $hospList.Count Then
    If Column = 0 Then
      Data.Html = "<b>" & "TOTAL" & "</b>"
    Else If Column = 1 Then
      Data.Html = "<b>" & GetTotalArray(xancvisitColl) & "</b>"
    Else If Column = 2 Then
      Data.Html = "<b>" & GetTotalArray(xpncvisitColl) & "</b>"
    Else If Column = 3 Then
      Data.Html = "<b>" & GetTotalArray(xadmissionColl) & "</b>"
    Else If Column = 4 Then
      Data.Html = "<b>" & GetTotalArray(xdischargeColl) & "</b>"
    Else If Column = 5 Then
      Data.Html = "<b>" & GetTotalArray(xreferColl) & "</b>"
    Else If Column = 6 Then
      Data.Html = "<b>" & GetTotalArray(xdeathColl) & "</b>"
    Else If Column = 7 Then
      Data.Html = "<b>" & GetTotalArray(xdelliveColl) & "</b>"
    Else If Column = 8 Then
      Data.Html = "<b>" & GetTotalArray(xdelstilColl) & "</b>"
    Endif

  Else
    If Column = 0 Then
      If $locatMode = "Hospital" Then
        Data.Text = modDataRepo.GetHospitaltName($hospList[Row])
      Else
        Data.Text = $hospList[Row]
      Endif
    Else If Column = 1 Then
      Data.Text = xancvisitColl[$hospList[Row]]
    Else If Column = 2 Then
      Data.Text = xpncvisitColl[$hospList[Row]]
    Else If Column = 3 Then
      Data.Text = xadmissionColl[$hospList[Row]]
    Else If Column = 4 Then
      Data.Text = xdischargeColl[$hospList[Row]]
    Else If Column = 5 Then
      Data.Text = xreferColl[$hospList[Row]]
    Else If Column = 6 Then
      Data.Text = xdeathColl[$hospList[Row]]
    Else If Column = 7 Then
      Data.Text = xdelliveColl[$hospList[Row]]
    Else If Column = 8 Then
      Data.Text = xdelstilColl[$hospList[Row]]
    Endif

  Endif

End

''----------------------- surveillance ---------------------------
Private Sub LoadSurveillanceData()

  Dim xhospfld As String
  Dim xFldList As String[]
  Dim sql As String

  xhospfld = modDataRepo.HospitalField()
  xFldList = ["fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", xhospfld]
  sql = "select " & xFldList.Join(",") & " from tblencounter where (fldheight=&1 or fldheight=&2)"
  $rData1 = modDatabase.$syConn.Exec(sql, Color.Red, Color.Black)
  $aMyFields1 = New String[]
  modGridView.ReadSmallData(GridView2, $rData1, $aMyFields1)
  With GridView2
    .Columns[0].Width = CStr(20 * modBasic.$AppWidthRatio) & "px"
    .Columns[1].Width = CStr(125 * modBasic.$AppWidthRatio) & "px"
    .Columns[2].Width = CStr(225 * modBasic.$AppWidthRatio) & "px"
    .Columns[3].Width = CStr(100 * modBasic.$AppWidthRatio) & "px"
    .Columns[4].Hidden = True
    .Columns[5].Width = CStr(150 * modBasic.$AppWidthRatio) & "px"

    .Columns[1].Text = "EncID"
    .Columns[2].Text = "Name"
    .Columns[3].Text = "Age"
    .Columns[5].Text = "Facility"
  End With

End

Public Sub GridView2_Data(Row As Integer, Column As Integer, Data As WebTableData)

  $rData1.MoveTo(Row)
  modGridView.GridViewDecoration(Data, Row)
  If Column = 0 Then
    Data.Background = Color.Red
    Data.Text = ""
  Else If Column = 2 Then
    Data.Text = modPatient.GetPatientNameByEnc($rData1[$aMyFields1[Column]], modDatabase.$syConn)
  Else If Column = 3 Then
    Data.Text = modMedReports.GetPatientPastAgeString("tblencounter", $rData1[$aMyFields1[Column]])
  Else If Column = 5 Then
    Data.Text = modDataRepo.GetHospitalTextLabel($rData1[$aMyFields1[Column]])
  Else
    Data.Text = $rData1[$aMyFields1[Column]]
  Endif

End

Public Sub btnshowtable_Click()

  If GridView2.Selection.Count Then
    $rData1.MoveTo(GridView2.Selection[0])
    If modPatientSub.AllowEncIDHistory($rData1["fldencounterval"], modDatabase.$syConn) = True Then
      modPatReports.GetSelectedPatientValues($rData1["fldencounterval"], MMain.$defUnit)
    Endif
  Endif

End

Public Sub btnshowmap_Click()

  Dim res As Result
  Dim hForm As FRequest
  Dim xpatno As String

  If GridView2.Selection.Count Then
    $rData1.MoveTo(GridView2.Selection[0])
    If modPatientSub.AllowEncIDHistory($rData1["fldencounterval"], modDatabase.$syConn) = True Then
      xpatno = modPatient.GetPatientNoByEnc($rData1["fldencounterval"])
      If MMain.$RepoReportMode = True Then
        res = modDatabase.$syConn.Exec("select fldencounterval,fldregdate,fldadmission,fldcurrlocat,flduserid,flddisctype,fldhospcode from tblencounter where fldpatientval=&1 ORDER BY fldregdate", xpatno)
      Else
        res = modDatabase.$syConn.Exec("select fldencounterval,fldregdate,fldadmission,fldcurrlocat,flduserid,flddisctype from tblencounter where fldpatientval=&1 ORDER BY fldregdate", xpatno)
      Endif
      hForm = New FRequest(res, "Patient Encounters", "PatientEncounters", False)
      hForm.ShowModal
    Endif
  Endif

End

''------------------ Charts ----------------------
Private Function ChartRepositoryWithHosp(sType As String, sMode As String, sValue As String) As Result

  Dim res As Result

  Select sType
    Case "ANC Visit"
      res = modDatabase.$syConn.Exec("select COUNT(fldencounterval) as xtotal,DATE(fldtime) as xdate from tblopvisit where fldconsulttime>=&1 and fldconsulttime<=&2 and fldconsultname=&3" & modDataRepo.GetWhereStringRepo(sMode, sValue) & " GROUP BY DATE(tblopvisit.fldconsulttime)", dtfir.Value, dtlast.Value, "ANC Visit")
    Case "PNC Visit"
      res = modDatabase.$syConn.Exec("select COUNT(fldencounterval) as xtotal,DATE(fldtime) as xdate from tblopvisit where fldconsulttime>=&1 and fldconsulttime<=&2 and fldconsultname=&3" & modDataRepo.GetWhereStringRepo(sMode, sValue) & " GROUP BY DATE(tblopvisit.fldconsulttime)", dtfir.Value, dtlast.Value, "PNC Visit")
    Case "Live Baby"
      res = modDatabase.$syConn.Exec("select COUNT(fldencounterval) as xtotal,DATE(fldtime) as xdate from tblconfinement where flddeltime>=&1 and flddeltime<=&2 and flddelresult=&3" & modDataRepo.GetWhereStringRepo(sMode, sValue) & " GROUP BY DATE(tblconfinement.flddeltime)", dtfir.Value, dtlast.Value, "Live Baby")
    Case "Still Birth"
      res = modDatabase.$syConn.Exec("select COUNT(fldencounterval) as xtotal,DATE(fldtime) as xdate from tblconfinement where flddeltime>=&1 and flddeltime<=&2 and flddelresult<>&3" & modDataRepo.GetWhereStringRepo(sMode, sValue) & " GROUP BY DATE(tblconfinement.flddeltime)", dtfir.Value, dtlast.Value, "Live Baby")
    Case "Admission"
      res = modDatabase.$syConn.Exec("select COUNT(fldencounterval) as xtotal,DATE(fldtime) as xdate from tblpatientdate where fldtime>=&1 and fldtime<=&2 and fldhead=&3" & modDataRepo.GetWhereStringRepo(sMode, sValue) & " GROUP BY DATE(tblpatientdate.fldtime)", dtfir.Value, dtlast.Value, "Admitted")
    Case "Discharge"
      res = modDatabase.$syConn.Exec("select COUNT(fldencounterval) as xtotal,DATE(fldtime) as xdate from tblpatientdate where fldtime>=&1 and fldtime<=&2 and fldhead=&3" & modDataRepo.GetWhereStringRepo(sMode, sValue) & " GROUP BY DATE(tblpatientdate.fldtime)", dtfir.Value, dtlast.Value, "Discharged")
    Case "Referred"
      res = modDatabase.$syConn.Exec("select COUNT(fldencounterval) as xtotal,DATE(fldtime) as xdate from tblpatientdate where fldtime>=&1 and fldtime<=&2 and fldhead=&3" & modDataRepo.GetWhereStringRepo(sMode, sValue) & " GROUP BY DATE(tblpatientdate.fldtime)", dtfir.Value, dtlast.Value, "Refer")
    Case "Death"
      res = modDatabase.$syConn.Exec("select COUNT(fldencounterval) as xtotal,DATE(fldtime) as xdate from tblpatientdate where fldtime>=&1 and fldtime<=&2 and fldhead=&3" & modDataRepo.GetWhereStringRepo(sMode, sValue) & " GROUP BY DATE(tblpatientdate.fldtime)", dtfir.Value, dtlast.Value, "Death")
  End Select

  Return res

End

Private Function ChartRepositoryAllHosp(sType As String) As Result

  Dim res As Result

  Select sType
    Case "ANC Visit"
      res = modDatabase.$syConn.Exec("select COUNT(fldencounterval) as xtotal,DATE(fldtime) as xdate from tblopvisit where fldconsulttime>=&1 and fldconsulttime<=&2 and fldconsultname=&3 GROUP BY DATE(tblopvisit.fldconsulttime)", dtfir.Value, dtlast.Value, "ANC Visit")
    Case "PNC Visit"
      res = modDatabase.$syConn.Exec("select COUNT(fldencounterval) as xtotal,DATE(fldtime) as xdate from tblopvisit where fldconsulttime>=&1 and fldconsulttime<=&2 and fldconsultname=&3 GROUP BY DATE(tblopvisit.fldconsulttime)", dtfir.Value, dtlast.Value, "PNC Visit")
    Case "Live Baby"
      res = modDatabase.$syConn.Exec("select COUNT(fldencounterval) as xtotal,DATE(fldtime) as xdate from tblconfinement where flddeltime>=&1 and flddeltime<=&2 and flddelresult=&3 GROUP BY DATE(tblconfinement.flddeltime)", dtfir.Value, dtlast.Value, "Live Baby")
    Case "Still Birth"
      res = modDatabase.$syConn.Exec("select COUNT(fldencounterval) as xtotal,DATE(fldtime) as xdate from tblconfinement where flddeltime>=&1 and flddeltime<=&2 and flddelresult<>&3 GROUP BY DATE(tblconfinement.flddeltime)", dtfir.Value, dtlast.Value, "Live Baby")
    Case "Admission"
      res = modDatabase.$syConn.Exec("select COUNT(fldencounterval) as xtotal,DATE(fldtime) as xdate from tblpatientdate where fldtime>=&1 and fldtime<=&2 and fldhead=&3 GROUP BY DATE(tblpatientdate.fldtime)", dtfir.Value, dtlast.Value, "Admitted")
    Case "Discharge"
      res = modDatabase.$syConn.Exec("select COUNT(fldencounterval) as xtotal,DATE(fldtime) as xdate from tblpatientdate where fldtime>=&1 and fldtime<=&2 and fldhead=&3 GROUP BY DATE(tblpatientdate.fldtime)", dtfir.Value, dtlast.Value, "Discharged")
    Case "Referred"
      res = modDatabase.$syConn.Exec("select COUNT(fldencounterval) as xtotal,DATE(fldtime) as xdate from tblpatientdate where fldtime>=&1 and fldtime<=&2 and fldhead=&3 GROUP BY DATE(tblpatientdate.fldtime)", dtfir.Value, dtlast.Value, "Refer")
    Case "Death"
      res = modDatabase.$syConn.Exec("select COUNT(fldencounterval) as xtotal,DATE(fldtime) as xdate from tblpatientdate where fldtime>=&1 and fldtime<=&2 and fldhead=&3 GROUP BY DATE(tblpatientdate.fldtime)", dtfir.Value, dtlast.Value, "Death")
  End Select

  Return res

End

Private Sub SHowChartCanvas(sType As String)

  Dim res As Result
  Dim xValues As Variant[]
  Dim yValues As Variant[]
  Dim xChart As Collection
  Dim sPath As String

  Dim xWebCanv As WebCanvas

  xValues = New Variant[]
  yValues = New Variant[]
  If modBasic.$HospCode Then
    If modDataRepo.$RepositoryMode = "Hospital" Then
    Else
      res = ChartRepositoryWithHosp(sType, $locatMode, modBasic.$HospCode)
    Endif
  Else
    res = ChartRepositoryAllHosp(sType)
  Endif
  If res And If res.Available Then
    For Each res
      xValues.Add(Format(res["xdate"], gb.ShortDate))
      yValues.Add(res["xtotal"])
    Next
    xChart = modChartJS.GetHTMLChartScript("line", sType, xValues, yValues)

    If WebContainer9.Children.Count Then
      WebContainer9.DeleteChildren()
    Endif
    xWebCanv = New WebCanvas(WebContainer9)
    xWebCanv.Expand = True
    sPath = "new Chart(\"" & xWebCanv.Name & "\", " & JSON.Encode(xChart) & ")"
    Me.Exec(sPath)
  Endif

End

Public Sub btnancvisit_Click()

  SHowChartCanvas("ANC Visit")

End

Public Sub btnpncvisit_Click()

  SHowChartCanvas("PNC Visit")

End

Public Sub btnlivebaby_Click()

  SHowChartCanvas("Live Baby")

End

Public Sub btnstillbirth_Click()

  SHowChartCanvas("Still Birth")

End

Public Sub btnadmisssion_Click()

  SHowChartCanvas("Admission")

End

Public Sub btndischarge_Click()

  SHowChartCanvas("Discharge")

End

Public Sub btnreferred_Click()

  SHowChartCanvas("Referred")

End

Public Sub btndeath_Click()

  SHowChartCanvas("Death")

End

Public Sub btnexportgrid_Click()

  modCHTMLReport.ExportGridToHTML(GridView1, "Summary Statistics", modReportVar.GetDateTimeReport(Now(), gb.GeneralDate))

End

Public Sub btnexportsurv_Click()

  modCHTMLReport.ExportGridToHTML(GridView2, "Surveillance Statistics", modReportVar.GetDateTimeReport(Now(), gb.GeneralDate))

End
