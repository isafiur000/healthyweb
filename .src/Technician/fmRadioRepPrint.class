' Gambas class file

Private $encid As String
Private $patNo As String
Private $TestID As Long
Private $CategList As String[]

Private $rData As Result
Private $aMyFields As String[]
Private $rData1 As Result
Private $aMyFields1 As String[]

Private $HashCode As String
Private $PortalUser As String
Private $NewHash As String
Private $PortalLink As String
Private $RemoteUpload As String
Private $RemoteMethod As String
Private $RepoLock As String

Public Sub _new(encid As String)

  Dim xoption As String
  Dim xdefault As String

  txtencid.Text = encid
  If modBasic.$AppCachePatientDemographics = "Yes" Then
  Else
    modGeneralMain.RemovePatientCacheSelected("PatientData")
  Endif

  If modHelpVariable.$LogInCategory = "Technologist" Then
    Me.Title = "Radiology Verification"
    pnlverify.Visible = True
    btnverify.Visible = True
  Else
    Me.Title = "Radiology Printing"
    pnlverify.Visible = False
    btnverify.Visible = False
  Endif

  cmbcategory.List = modMedicine.GetPathoCategoryList("Radio")
  cmbcategory.Add("%")
  xdefault = modSettings.ShowSettingFromFIle("Radiology/DefaultDepartment")
  If xdefault Then
    cmbcategory.Text = xdefault
  Else
    cmbcategory.Text = "%"
  Endif
  cmbflag.List = ["%", "Normal", "Abnormal"]
  cmbflag.Text = "%"

  DefaultTestReportFormat()
  modSettings.ShowCheckBox(chknew, "RadioReportFormat/NewItems")
  modSettings.ShowCheckBox(chkprinted, "RadioReportFormat/PrintedItems")
  modSettings.ShowCheckBox(chkmark, "RadioReportFormat/MarkPrinted")
  $RepoLock = modBasic.$LabOutputLock
  rbreported.Value = True

  dtselected.Value = Now()
  xoption = modSettings.ShowSettingFromFIle("EntrySetting/Radiology_DateSelect")
  If xoption = "Yes" Then
    chkdate.Value = True
  Else If xoption = "No" Then
    chkdate.Value = False
  Endif
  DateSelectionSett()
  $PortalLink = modBasic.$PatPortalURL
  $RemoteUpload = modSettings.ShowSettingFromFIle("Laboratory/FileUpload_Repo")
  $RemoteMethod = modSettings.ShowSettingFromFIle("Laboratory/FileUpload_Method")
  ShowInputForm()

End

' Public Sub Form_KeyRelease()
'
'   Dim hForm As FmLabRepSettings
'
'   If Key.Code = Key["F"] And If Key.Control Then
'   Else If Key.Code = Key["R"] And If Key.Control Then
'     If btnreport.Enabled = True Then
'       btnreport_Click()
'     Endif
'   Else If Key.Code = Key["A"] And If Key.Control Then
'     If btnrecord.Enabled = True Then
'       btnrecord_Click()
'     Endif
'   Else If Key.Code = Key["X"] And If Key.Control Then
'     Me.Close()
'   Else If Key.Code = Key["B"] And If Key.Control Then
'     Me.Close
'     Wait
'     hForm = New FmLabRepSettings("")
'     modAppSupport.AddNewFormToWorkspace(hForm)
'   Else If Key.Code = Key.F2 Then
'     If modHelpVariable.$LogInCategory = "Technologist" Then
'       txtencid.Text = VerifyList(cmbcategory.Text, "Radio","Current")
'       rbencounter.Value = True
'     Endif
'   Endif
'
' End

Private Sub ShowInputForm()

  Dim xx As String

  xx = modSettings.ShowSettingFromFIle("Radiology/InputFormat")
  If xx = "Invoice" Then
    rbinvoice.Value = True
  Else
    rbencounter.Value = True
  Endif

End

Public Sub rbencounter_Click()

  modSettings.SaveSettingsToFile("Radiology/InputFormat", "Encounter")

End

Public Sub rbinvoice_Click()

  modSettings.SaveSettingsToFile("Radiology/InputFormat", "Invoice")

End

Public Sub chknew_Click()

  modSettings.EnterCheckSetting(chknew, "RadioReportFormat/NewItems")

End

Public Sub chkprinted_Click()

  modSettings.EnterCheckSetting(chkprinted, "RadioReportFormat/PrintedItems")

End

Public Sub chkmark_Click()

  modSettings.EnterCheckSetting(chkmark, "RadioReportFormat/MarkPrinted")

End

Private Sub DefaultTestReportFormat()

  Dim def As String

  def = modSettings.ShowSettingFromFIle("TestReportFormat/Format")
  If def Then
    If def = "A" Then
      rbform1.Value = True
    Else If def = "B" Then
      rbform2.Value = True
    Else If def = "C" Then
      rbform3.Value = True
    Endif
  Else
    rbform2.Value = True
  Endif

End

Public Sub rbform1_Click()

  modSettings.SaveSettingsToFile("RadioReportFormat/Format", "A")

End

Public Sub rbform2_Click()

  modSettings.SaveSettingsToFile("RadioReportFormat/Format", "B")

End

Public Sub rbform3_Click()

  modSettings.SaveSettingsToFile("RadioReportFormat/Format", "C")

End

Public Sub dtnepselect_Click()

  Dim xx As String

  xx = BSDateFormat(("Enter BS Date in yyyy/mm/dd format"), ("Date Converter"), modDate.ConvertToLocaldate(dtselected.Value))
  If xx Then
    dtselected.Value = modDate.ConvertToEnglishdate(xx)
  Endif

End

Public Sub btnsearch_Click()

  If Not txtencid.Text Then
    txtencid.Text = PatSearch("Encounter")
  Endif

End

Public Sub btnverify_Click()

  If cmbcategory.Text Then
    txtencid.Text = VerifyList(cmbcategory.Text, "Radio", "Current")
  Endif

End

Public Sub btnsearchenc_Click()

  If Not txtencid.Text Then
    txtencid.Text = QRScanValue("")
  Endif

End

Public Sub txtencid_Activate()

  btnshow_Click()

End

Public Sub btnshow_Click()

  Dim xstatus As String

  If txtencid.Text And If cmbcategory.Text Then
    txtportal.Text = ""
    If rbencounter.Value = True Then
      $encid = Trim(txtencid.Text)
    Else If rbinvoice.Value = True Then
      $encid = modNonMedical.GetEncounterFromBillNo(txtencid.Text)
    Endif
    txtpatientname.Text = modPatient.GetPatientNameByEnc($encid)
    txtgender.Text = modPatient.GetPatientAgeString($encid, Now()) & "/" & modPatient.GetPatientSex($encid)

    $patNo = modPatient.GetPatientNoByEnc($encid)
    xstatus = modPatient.CurrentAdmissionStatus($encid)
    txtlocation.Text = modPatient.GetLocationSetting($encid, xstatus)
    modAppSupport.RecordPatientActivity("Patient Data", Me.Name, "EncounterID", $encid)
    $CategList = New String[]
    If modPatientSub.AllowEncIDHistory($encid, modDatabase.$myConn) = True Then
      FillLabtable()
      txtcomment.Text = ""
    Else
      Me.Enabled = False
    Endif
    $HashCode = ""
    If modBasic.$RemoteUserType = "Encounter" Then
      If InStr($encid, modBasic.$HospCode) = 0 Then
        $PortalUser = $encid & modBasic.$HospCode
      Else
        $PortalUser = $encid
      Endif
    Else If modBasic.$RemoteUserType = "PatientID" Then
      If InStr($patNo, modBasic.$HospCode) = 0 Then
        $PortalUser = $patNo & modBasic.$HospCode
      Else
        $PortalUser = $patNo
      Endif
    Endif
  Endif

End

Private Sub DateSelectionSett()

  If chkdate.Value = True Then
    Panel9.Enabled = True
  Else
    Panel9.Enabled = False
  Endif

End

Public Sub chkdate_Click()

  modSettings.EnterCheckSetting(chkdate, "EntrySetting/Radiology_DateSelect")
  DateSelectionSett()

End

Private Sub FillLabtable()

  Dim reprt As String
  Dim vrfd As String
  Dim sprt As Boolean
  Dim xstr As String
  Dim abnm As Boolean
  Dim xFldList As String[]

  If cmbflag.Text = "%" Then
    xstr = " and fldsave_report=&5"
    abnm = True
  Else
    xstr = " and fldabnormal=&5"
    If cmbflag.Text = "Normal" Then
      abnm = False
    Else If cmbflag.Text = "Abnormal" Then
      abnm = True
    Endif
  Endif

  If rbreported.Value = True Then
    vrfd = "Verified"
    reprt = "Reported"
  Else If rbverified.Value = True Then
    vrfd = "Verified"
    reprt = "Verified"
  Endif

  xFldList = ["fldid", "fldchk", "fldsave_report", "fldtest_type", "fldtestid", "fldsampletype", "fldtime_report", "fldabnormal", "fldid", "flvisible", "fldstatus", "flduserid_report", "flduserid_verify", "fldsampletype", "fldcondition", "fldtime_report", "fldprint", "fldorder", "fldtestid", "fldcomment", "fldtime_verify", "flduptime_report", "flduptime_verify", "fldbillno", "fldupuser_report", "fldupuser_verify"]
  If chkdate.Value = True Then
    If chknew.Value And If chkprinted.Value Then
      If cmbcategory.Text = "%" Then
        If rbencounter.Value = True Then
          $rData = modDatabase.$myConn.Exec("select " & xFldList.Join(",") & " from tblpatradiotest where fldsave_report=&1 and fldencounterval=&2 and (fldstatus=&3 or fldstatus=&4)" & xstr & " and fldtime_report>=&6 and fldtime_report<=&7" & modRadioSub.GetRadioRepoOrder("Test"), True, Trim(txtencid.Text), reprt, vrfd, abnm, modDate.StartSqlDate(dtselected.Value), modDate.EndSqlDate(DateAdd(dtselected.Value, gb.Day, txtdtrange.Value)))
        Else If rbinvoice.Value = True Then
          $rData = modDatabase.$myConn.Exec("select " & xFldList.Join(",") & " from tblpatradiotest where fldsave_report=&1 and fldbillno=&2 and (fldstatus=&3 or fldstatus=&4)" & xstr & " and fldtime_report>=&6 and fldtime_report<=&7" & modRadioSub.GetRadioRepoOrder("Test"), True, Trim(txtencid.Text), reprt, vrfd, abnm, modDate.StartSqlDate(dtselected.Value), modDate.EndSqlDate(DateAdd(dtselected.Value, gb.Day, txtdtrange.Value)))
        Endif
      Else
        If rbencounter.Value = True Then
          $rData = modDatabase.$myConn.Exec("select " & xFldList.Join(",") & " from tblpatradiotest where fldsave_report=&1 and fldencounterval=&2 and (fldstatus=&3 or fldstatus=&4)" & xstr & " and fldtestid in(select fldexamid from tblradio where fldcategory like &6) and fldtime_report>=&6 and fldtime_report>=&7 and fldtime_report<=&8 and fldtime_report<=&7" & modRadioSub.GetRadioRepoOrder("Test"), True, Trim(txtencid.Text), reprt, vrfd, abnm, cmbcategory.Text, modDate.StartSqlDate(dtselected.Value), modDate.EndSqlDate(DateAdd(dtselected.Value, gb.Day, txtdtrange.Value)))                                                   ''
        Else If rbinvoice.Value = True Then
          $rData = modDatabase.$myConn.Exec("select " & xFldList.Join(",") & " from tblpatradiotest where fldsave_report=&1 and fldbillno=&2 and (fldstatus=&3 or fldstatus=&4)" & xstr & " and fldtestid in(select fldexamid from tblradio where fldcategory like &6) and fldtime_report>=&6 and fldtime_report>=&7 and fldtime_report<=&8 and fldtime_report<=&7" & modRadioSub.GetRadioRepoOrder("Test"), True, Trim(txtencid.Text), reprt, vrfd, abnm, cmbcategory.Text, modDate.StartSqlDate(dtselected.Value), modDate.EndSqlDate(DateAdd(dtselected.Value, gb.Day, txtdtrange.Value)))
        Endif
      Endif
    Else
      If chknew.Value Then
        sprt = False
      Else If chkprinted.Value Then
        sprt = True
      Endif
      If cmbcategory.Text = "%" Then
        If rbencounter.Value = True Then
          $rData = modDatabase.$myConn.Exec("select " & xFldList.Join(",") & " from tblpatradiotest where fldsave_report=&1 and fldencounterval=&2 and (fldstatus=&3 or fldstatus=&4)" & xstr & " and fldprint=&6 and fldtime_report>=&7 and fldtime_report<=&8" & modRadioSub.GetRadioRepoOrder("Test"), True, Trim(txtencid.Text), reprt, vrfd, abnm, sprt, modDate.StartSqlDate(dtselected.Value), modDate.EndSqlDate(DateAdd(dtselected.Value, gb.Day, txtdtrange.Value)))
        Else If rbinvoice.Value = True Then
          $rData = modDatabase.$myConn.Exec("select " & xFldList.Join(",") & " from tblpatradiotest where fldsave_report=&1 and fldbillno=&2 and (fldstatus=&3 or fldstatus=&4)" & xstr & " and fldprint=&6 and fldtime_report>=&7 and fldtime_report<=&8" & modRadioSub.GetRadioRepoOrder("Test"), True, Trim(txtencid.Text), reprt, vrfd, abnm, sprt, modDate.StartSqlDate(dtselected.Value), modDate.EndSqlDate(DateAdd(dtselected.Value, gb.Day, txtdtrange.Value)))
        Endif
      Else
        If rbencounter.Value = True Then
          $rData = modDatabase.$myConn.Exec("select " & xFldList.Join(",") & " from tblpatradiotest where fldsave_report=&1 and fldencounterval=&2 and (fldstatus=&3 or fldstatus=&4)" & xstr & " and fldprint=&6 and fldtestid in(select fldexamid from tblradio where fldcategory like &7) and fldtime_report>=&8 and fldtime_report<=&9" & modRadioSub.GetRadioRepoOrder("Test"), True, Trim(txtencid.Text), reprt, vrfd, abnm, sprt, cmbcategory.Text, modDate.StartSqlDate(dtselected.Value), modDate.EndSqlDate(DateAdd(dtselected.Value, gb.Day, txtdtrange.Value)))                                                   ''
        Else If rbinvoice.Value = True Then
          $rData = modDatabase.$myConn.Exec("select " & xFldList.Join(",") & " from tblpatradiotest where fldsave_report=&1 and fldbillno=&2 and (fldstatus=&3 or fldstatus=&4)" & xstr & " and fldprint=&6 and fldtestid in(select fldexamid from tblradio where fldcategory like &7) and fldtime_report>=&8 and fldtime_report<=&9" & modRadioSub.GetRadioRepoOrder("Test"), True, Trim(txtencid.Text), reprt, vrfd, abnm, sprt, cmbcategory.Text, modDate.StartSqlDate(dtselected.Value), modDate.EndSqlDate(DateAdd(dtselected.Value, gb.Day, txtdtrange.Value)))
        Endif
      Endif
    Endif

  Else
    If chknew.Value And If chkprinted.Value Then
      If cmbcategory.Text = "%" Then
        If rbencounter.Value = True Then
          $rData = modDatabase.$myConn.Exec("select " & xFldList.Join(",") & " from tblpatradiotest where fldsave_report=&1 and fldencounterval=&2 and (fldstatus=&3 or fldstatus=&4)" & xstr & modRadioSub.GetRadioRepoOrder("Test"), True, Trim(txtencid.Text), reprt, vrfd, abnm)
        Else If rbinvoice.Value = True Then
          $rData = modDatabase.$myConn.Exec("select " & xFldList.Join(",") & " from tblpatradiotest where fldsave_report=&1 and fldbillno=&2 and (fldstatus=&3 or fldstatus=&4)" & xstr & modRadioSub.GetRadioRepoOrder("Test"), True, Trim(txtencid.Text), reprt, vrfd, abnm)
        Endif
      Else
        If rbencounter.Value = True Then
          $rData = modDatabase.$myConn.Exec("select " & xFldList.Join(",") & " from tblpatradiotest where fldsave_report=&1 and fldencounterval=&2 and (fldstatus=&3 or fldstatus=&4)" & xstr & " and fldtestid in(select fldexamid from tblradio where fldcategory like &6)" & modRadioSub.GetRadioRepoOrder("Test"), True, Trim(txtencid.Text), reprt, vrfd, abnm, cmbcategory.Text)                                                   ''
        Else If rbinvoice.Value = True Then
          $rData = modDatabase.$myConn.Exec("select " & xFldList.Join(",") & " from tblpatradiotest where fldsave_report=&1 and fldbillno=&2 and (fldstatus=&3 or fldstatus=&4)" & xstr & " and fldtestid in(select fldexamid from tblradio where fldcategory like &6)" & modRadioSub.GetRadioRepoOrder("Test"), True, Trim(txtencid.Text), reprt, vrfd, abnm, cmbcategory.Text)
        Endif
      Endif
    Else
      If chknew.Value Then
        sprt = False
      Else If chkprinted.Value Then
        sprt = True
      Endif
      If cmbcategory.Text = "%" Then
        If rbencounter.Value = True Then
          $rData = modDatabase.$myConn.Exec("select " & xFldList.Join(",") & " from tblpatradiotest where fldsave_report=&1 and fldencounterval=&2 and (fldstatus=&3 or fldstatus=&4)" & xstr & " and fldprint=&6" & modRadioSub.GetRadioRepoOrder("Test"), True, Trim(txtencid.Text), reprt, vrfd, abnm, sprt)
        Else If rbinvoice.Value = True Then
          $rData = modDatabase.$myConn.Exec("select " & xFldList.Join(",") & " from tblpatradiotest where fldsave_report=&1 and fldbillno=&2 and (fldstatus=&3 or fldstatus=&4)" & xstr & " and fldprint=&6" & modRadioSub.GetRadioRepoOrder("Test"), True, Trim(txtencid.Text), reprt, vrfd, abnm, sprt)
        Endif
      Else
        If rbencounter.Value = True Then
          $rData = modDatabase.$myConn.Exec("select " & xFldList.Join(",") & " from tblpatradiotest where fldsave_report=&1 and fldencounterval=&2 and (fldstatus=&3 or fldstatus=&4)" & xstr & " and fldprint=&6 and fldtestid in(select fldexamid from tblradio where fldcategory like &7)" & modRadioSub.GetRadioRepoOrder("Test"), True, Trim(txtencid.Text), reprt, vrfd, abnm, sprt, cmbcategory.Text)                                                   ''
        Else If rbinvoice.Value = True Then
          $rData = modDatabase.$myConn.Exec("select " & xFldList.Join(",") & " from tblpatradiotest where fldsave_report=&1 and fldbillno=&2 and (fldstatus=&3 or fldstatus=&4)" & xstr & " and fldprint=&6 and fldtestid in(select fldexamid from tblradio where fldcategory like &7)" & modRadioSub.GetRadioRepoOrder("Test"), True, Trim(txtencid.Text), reprt, vrfd, abnm, sprt, cmbcategory.Text)
        Endif
      Endif
    Endif

  Endif
  $aMyFields = New String[]
  modGridView.ReadSmallData(GridView1, $rData, $aMyFields)
  ShowGridmainData()
  ' EnableButton(False)
  BlankSubGrid() ''false grid to make grid empty
  GetTestItemList()

End

Private Sub ShowGridmainData()

  With GridView1
    .Columns[4].Text = "Examination"
    .Columns[5].Text = "EvalSite"
    .Columns[6].Text = "ReportDate"
    .Columns[8].Text = "Observation"
    .Columns[9].Text = "Visible"
    .Columns[10].Text = "Status"

    .Columns[0].Hidden = True
    .Columns[1].Width = CStr(25 * modBasic.$AppWidthRatio) & "px"
    .Columns[2].Hidden = True
    .Columns[3].Hidden = True
    .Columns[4].Width = CStr(250 * modBasic.$AppWidthRatio) & "px"
    .Columns[5].Width = CStr(100 * modBasic.$AppWidthRatio) & "px"
    .Columns[6].Width = CStr(150 * modBasic.$AppWidthRatio) & "px"
    .Columns[7].Width = CStr(25 * modBasic.$AppWidthRatio) & "px"
    .Columns[8].Width = CStr(200 * modBasic.$AppWidthRatio) & "px"
    .Columns[9].Width = CStr(75 * modBasic.$AppWidthRatio) & "px"
    .Columns[10].Width = CStr(75 * modBasic.$AppWidthRatio) & "px" 'status

    .Columns[11].Hidden = True  'reported by
    .Columns[12].Hidden = True  'verified by
    .Columns[13].Hidden = True 'specimen name
    .Columns[14].Hidden = True  'refer dept
    .Columns[15].Hidden = True  'reporting time
    .Columns[16].Width = CStr(25 * modBasic.$AppWidthRatio) & "px"
    .Columns[17].Width = CStr(30 * modBasic.$AppWidthRatio) & "px"
    .Columns[18].Hidden = True
    .Columns[19].Hidden = True ''comment
    .Columns[20].Hidden = True ''verify date
    .Columns[21].Hidden = True ''last report date
    .Columns[22].Hidden = True ''last verify date
    .Columns[23].Hidden = True ''invoice
    .Columns[24].Hidden = True  'Updated Reported by
    .Columns[25].Hidden = True  'Updated verified by
  End With

End

Public Sub GridView1_Data(Row As Integer, Column As Integer, Data As WebTableData)

  $rData.MoveTo(Row)
  modGridView.GridViewDecoration(Data, Row)
  If Column = 1 Then
    Data.Html = modString.GetImageForHTMLGrid(modMisc.SetGridCheckIcon($rData[$aMyFields[Column]]), "75%", "75%")
    Data.Text = ""
    ' Else If Column = 2 Then
    '   GridView1[$rData.Index, Column].Picture = Picture["icons/unchecked.png"]
    '   GridView1[$rData.Index, Column].Text = ""
  Else If Column = 6 Then
    Data.Text = modReportVar.GetDateTimeReport($rData[$aMyFields[Column]], gb.GeneralDate)
  Else If Column = 7 Then
    Data.Html = modString.GetImageForHTMLGrid(modMisc.GetGridIcon($rData[$aMyFields[Column]]), "75%", "75%")
    Data.Text = ""
  Else If Column = 8 Then
    Data.Html = modRadioTest.GetRadioTestValueString($rData[$aMyFields[Column]], True)
  Else If Column = 16 Then
    Data.Html = modString.GetImageForHTMLGrid(modMisc.SetGridCheckIcon($rData[$aMyFields[Column]]), "75%", "75%")
    Data.Text = ""
  Else If Column = 18 Then
    Data.Text = modFixRadio.GetRadioTestCategory($rData[$aMyFields[Column]])
  Else
    Data.Text = $rData[$aMyFields[Column]]
  Endif

End

Private Sub FillTestAutoFooter(TestName As String)

  Dim xfoot As String

  If modBasic.$LabAutoFooter = "Database" Then
    xfoot = modFixRadio.GetRadioToolTip(TestName)
    If xfoot Then
      If Not txtcomment.Text Then
        txtcomment.RichText = xfoot
      Else
        If txtcomment.RichMode = True Then
          txtcomment.RichText = txtcomment.RichText & "<br>" & xfoot
        Else
          txtcomment.RichText = txtcomment.RichText & gb.NewLine & xfoot
        Endif
      Endif
    Endif
  Endif

End

Private Sub GetTestItemList()

  Dim testList As String[]

  testList = New String[]
  For Each $rData
    testList.Add($rData["fldtestid"])
  Next
  If testList Then
    testList.Sort()
  Endif
  cmbfootest.List = testList

End

Private Sub EnableButton(sval As Boolean)

  If sval = True Then
    btnrecord.Enabled = True
    If modBasic.$LabSMSReportLock = "Verified" Then
      If rbverified.Value = True
        btnftp.Enabled = True
      Else
        btnftp.Enabled = False
      Endif
    Else
      btnftp.Enabled = True
    Endif
    btnreport.Enabled = True
  Else If sval = False Then
    btnrecord.Enabled = False
    btnftp.Enabled = False
    btnreport.Enabled = False
  Endif

End

' Private Sub EnableSelected()
'
'   Dim sval As Integer
'   Dim i As Integer
'
'   sval = 0
'   For i = 0 To GridView1.Count - 1
'     If GridView1[i, 1].Picture = Picture["icons/checked.png"] Then
'       sval = sval + 1
'     Endif
'   Next
'   If sval Then
'     EnableButton(True)
'   Else
'     EnableButton(False)
'   Endif
'
' End

Public Sub btnorder_Click()

  Dim categ As String[]
  Dim i As Integer

  categ = New String[]
  For i = 0 To GridView1.Count - 1
    If GridView1.IsSelected(i) = True Then
      $rData.MoveTo(i)
      categ.Add(modFixRadio.GetRadioTestCategory($rData["fldtestid"]))
    Endif
  Next

  ' $CategList = ListOrder(("Reorder Items"), modString.BinaryDistinctStringArray(categ))

End

Private Sub CheckSelectFirGrid(sVal As Boolean, sInt As Long)

  Dim res As Result
  Dim res1 As Result

  res1 = modDatabase.$myConn.Edit("tblpatradiotest", "fldid=&1 and flvisible=&2", sInt, "Visible")
  If res1.Available Then
    res1["fldchk"] = sVal
    res1["xyz"] = False
    res = modDatabase.$myConn.Edit("tblpatradiosubtest", "fldtestid=&1", sInt)
    If res.Available Then
      For Each res
        res["fldchk"] = sVal
        res["xyz"] = False
        res.Update
      Next
    Endif
    res1.Update
  Endif

End

Private Sub CheckFirstGrid(sVal As Boolean)

  Dim i As Integer

  For i = 0 To GridView1.Count - 1
    $rData.MoveTo(i)
    CheckSelectFirGrid(sVal, $rData["fldid"])
    FillTestAutoFooter($rData["fldtestid"])
  Next

End

Public Sub mnuselall_Click()

  Dim i As Integer

  BlankSubGrid()
  If chkselmain.Value = True Then
    For i = 0 To GridView1.Count - 1
      $rData.MoveTo(i)
      If $rData["flvisible"] = "Visible" Then
        If $RepoLock = "Verified" Then
          If $rData["fldstatus"] = "Verified" Then
            CheckSelectFirGrid(True, $rData["fldid"])
            FillTestAutoFooter($rData["fldtestid"])
          Endif
        Else
          CheckSelectFirGrid(True, $rData["fldid"])
          FillTestAutoFooter($rData["fldtestid"])
        Endif
      Endif
    Next

  Else
    If GridView1.Selection.Count Then
      $rData.MoveTo(GridView1.Selection[0])
      If $rData["flvisible"] = "Visible" Then
        If $RepoLock = "Verified" Then
          If $rData["fldstatus"] = "Verified" Then
            CheckSelectFirGrid(True, $rData["fldid"])
            FillTestAutoFooter($rData["fldtestid"])
          Endif
        Else
          CheckSelectFirGrid(True, $rData["fldid"])
          FillTestAutoFooter($rData["fldtestid"])
        Endif
      Else
        Message.Warning(("Observation not visible"), ("OK"))
      Endif
    Endif
  Endif
  ' EnableButton(True)
  FillLabtable()

End

Public Sub mnudselal_Click()

  Dim i As Integer

  BlankSubGrid()
  If chkselmain.Value = True Then
    For i = 0 To GridView1.Count - 1
      $rData.MoveTo(i)
      CheckSelectFirGrid(False, $rData["fldid"])
    Next

  Else
    If GridView1.Selection.Count Then
      $rData.MoveTo(GridView1.Selection[0])
      CheckSelectFirGrid(False, $rData["fldid"])
    Endif
  Endif
  ' EnableButton(False)
  FillLabtable()

End

Public Sub GridView1_Select()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    $TestID = $rData["fldid"]
    SHowQualiSUbTest($rData["fldid"])
  Endif

End

Public Sub btnflag_Click()

  Dim xx As String
  Dim res As Result

  If GridView1.Selection.Count Then
    If modHelpVariable.$LogInCategory = "Technologist" Then
      $rData.MoveTo(GridView1.Selection[0])

      xx = InputCombo("Select Flag for observation", "Change Flag", ["Normal", "Abnormal"], modMisc.GetIconValue($rData["fldabnormal"]), True)
      If xx Then
        res = modDatabase.$myConn.Edit("tblpatradiotest", "fldid=&1", $rData["fldid"])
        If xx = "Abnormal" Then
          res["fldabnormal"] = True
        Else
          res["fldabnormal"] = False
        Endif
        res["xyz"] = False
        res.Update
        FillLabtable()
      Endif

    Endif
  Endif

End

Public Sub btnvisible_Click()

  Dim xopt As String[] = ["Visible", "Hidden"]
  Dim xx As String
  Dim res As Result

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])

    xx = InputCombo("Set Visibility", $rData["fldtestid"], xopt, $rData["flvisible"], True)
    If xx Then
      res = modDatabase.$myConn.Edit("tblpatradiotest", "fldid=&1", $rData["fldid"])
      res["flvisible"] = xx
      res["xyz"] = False
      res.Update
      FillLabtable()
    Endif

  Endif

End

Public Sub btnspecimen_Click()

  Dim xx As String
  Dim res As Result
  Dim xspec As String[]

  If GridView1.Selection.Count Then
    If modHelpVariable.$LogInCategory = "Technologist" Then
      $rData.MoveTo(GridView1.Selection[0])

      xspec = New String[]
      xx = InputCombo("Set Site of Evaluation Site", $rData["fldtestid"], xspec, $rData["fldsampletype"], False)
      If xx Then
        res = modDatabase.$myConn.Edit("tblpatradiotest", "fldid=&1", $rData["fldid"])
        res["fldsampletype"] = xx
        res["xyz"] = False
        res.Update
        FillLabtable()
      Endif

    Endif
  Endif

End

Public Sub btnorderne_Click()

  Dim xx As String

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])

    xx = InputBox(("Enter Order Number"), ("Test Order"), $rData["fldorder"])
    If xx Then
      modLabSub.UpdateRadioTestOrder($rData["fldid"], CInt(xx))
      FillLabtable()
    Endif

  Endif

End

Public Sub mnuemail_Click()

  Dim xemail As String
  Dim hForm As FmRemoteMail

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xemail = modPatient.GetPatientEmail($encid)
    If xemail Then
      hForm = New FmRemoteMail(xemail, "", "Radiology Report", $rData["fldtestid"] & " : " & modRadioTest.GetRadioTestValueString($rData["fldid"], False, $encid))
      hForm.ShowModal()
    Endif
  Endif

End

Public Sub mnusms_Click()

  Dim xmsg As String

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xmsg = modDevice.SendSMSLabPatient($encid, $rData["fldtestid"], modRadioTest.GetRadioTestValueString($rData["fldid"], False, $encid))
  Endif
  If xmsg Then
    Message.Info(xmsg, ("OK"))
  Endif

End

Public Sub mnureport_Click()

  Dim xx As String

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    xx = GetRichTextArea($rData["fldtestid"], modRadioTest.GetRadioTestValueGridString($encid, $rData["fldid"], False))
  Endif

End

''------------------ verify
Public Sub mnuverify_Click()

  If GridView1.Selection.Count Then
    If modHelpVariable.$LogInCategory = "Technologist" Then
      $rData.MoveTo(GridView1.Selection[0])
      modRadioSub.UpdateVerifyRadioReport($rData["fldid"])
      FillLabtable()
    Endif
  Endif

End

Public Sub mnuverifyall_Click()

  Dim Row As Integer

  If modHelpVariable.$LogInCategory = "Technologist" Then
    For Row = 0 To GridView1.Count - 1
      $rData.MoveTo(Row)
      modRadioSub.UpdateVerifyRadioReport($rData["fldid"])
    Next
    FillLabtable()
  Endif

End

''--------------------- cancel
Public Sub mnucancel_Click()

  If GridView1.Selection.Count Then
    If modHelpVariable.$LogInCategory = "Technologist" Then
      $rData.MoveTo(GridView1.Selection[0])
      modRadioSub.CancelVerifyRadioReport($rData["fldid"])
      FillLabtable()
    Endif
  Endif

End

Public Sub mnucancelall_Click()

  Dim Row As Integer

  If modHelpVariable.$LogInCategory = "Technologist" Then
    For Row = 0 To GridView1.Count - 1
      $rData.MoveTo(Row)
      modRadioSub.CancelVerifyRadioReport($rData["fldid"])
    Next
    FillLabtable()
  Endif

End

Public Sub btntestfactors_Click()

  If GridView1.Selection.Count Then
    If modHelpVariable.$LogInCategory = "Technologist" Then
      $rData.MoveTo(GridView1.Selection[0])

      ' EnterTextData()

    Endif
  Endif

End

''========================= Sub Test ===========================
Private Sub ResizeSubGrid()

  With GridView2
    .Columns[0].Hidden = True
    .Columns[1].Width = CStr(25 * modBasic.$AppWidthRatio) & "px"
    .Columns[2].Width = CStr(175 * modBasic.$AppWidthRatio) & "px"
    .Columns[3].Width = CStr(25 * modBasic.$AppWidthRatio) & "px"
    .Columns[4].Width = CStr(400 * modBasic.$AppWidthRatio) & "px"
    .Columns[5].Width = CStr(50 * modBasic.$AppWidthRatio) & "px"
    .Columns[2].Text = "SubTest"
    .Columns[4].Text = "Observation"
  End With

End

Private Sub SHowQualiSUbTest(serial As Long)

  Dim sql As String

  sql = "select fldid,fldchk,fldsubtest,fldabnormal,fldreport,fldorder from tblpatradiosubtest where fldtestid=&1 and fldsave=&2" & modRadioSub.GetRadioRepoOrder("SubTest")
  $rData1 = modDatabase.$myConn.Exec(sql, serial, True)
  $aMyFields1 = New String[]
  modGridView.ReadSmallData(GridView2, $rData1, $aMyFields1)
  ResizeSubGrid()

End

Private Sub BlankSubGrid()

  GridView2.Clear
  GridView2.Columns.Count = 6
  GridView2.Count = 0
  ResizeSubGrid()

End

Public Sub GridView2_Data(Row As Integer, Column As Integer, Data As WebTableData)

  $rData1.MoveTo(Row)
  modGridView.GridViewDecoration(Data, Row)
  If Column = 1 Then
    Data.Html = modString.GetImageForHTMLGrid(modMisc.SetGridCheckIcon($rData1[$aMyFields1[Column]]), "75%", "75%")
    Data.Text = ""
  Else If Column = 3 Then
    Data.Html = modString.GetImageForHTMLGrid(modMisc.GetGridIcon($rData1[$aMyFields1[Column]]), "75%", "75%")
    Data.Text = ""
  Else If Column = 4 Then
    Data.Html = $rData1[$aMyFields1[Column]]
  Else
    Data.Text = $rData1[$aMyFields1[Column]]
  Endif

End

Public Sub mnuselsec_Click()

  Dim res As Result

  If GridView2.Selection.Count Then
    $rData1.MoveTo(GridView2.Selection[0])
    res = modDatabase.$myConn.Edit("tblpatradiosubtest", "fldid=&1 and fldsave=&2", $rData1["fldid"], True)
    If res.Available Then
      res["fldchk"] = True
      res["xyz"] = False
      res.Update
      SHowQualiSUbTest($TestID)
    Endif
  Endif

End

Public Sub mnudselsec_Click()

  Dim res As Result

  If GridView2.Selection.Count Then
    $rData1.MoveTo(GridView2.Selection[0])
    res = modDatabase.$myConn.Edit("tblpatradiosubtest", "fldid=&1 and fldsave=&2", $rData1["fldid"], True)
    If res.Available Then
      res["fldchk"] = False
      res["xyz"] = False
      res.Update
      SHowQualiSUbTest($TestID)
    Endif
  Endif

End

Public Sub btnordersec_Click()

  Dim xx As String

  If GridView2.Selection.Count Then
    $rData1.MoveTo(GridView2.Selection[0])
    xx = InputBox(("Enter Order Number"), ("Test Order"), $rData1["fldorder"])
    If xx Then
      modLabSub.UpdateRadioSubTestOrder($rData1["fldid"], CInt(xx))
      SHowQualiSUbTest($TestID)
    Endif
  Endif

End

' Private Sub ManipulateSecondGrid(Row As Integer, testid As Long)
'
'   Dim res As Result
'   Dim i As Integer
'
'   res = modDatabase.$myConn.Edit("tblpatlabsubtest", "fldtestid=&1 and fldsave=&2", testid, True)
'   If GridView1[Row, 2].Picture = Picture["icons/checked.png"] Then
'     For Each res
'       res["fldchk"] = True
'       res["xyz"] = False
'       res.Update
'     Next
'     For i = 0 To GridView2.Count - 1
'       GridView2[i, 1].Picture = Picture["icons/checked.png"]
'     Next
'
'   Else If GridView1[Row, 2].Picture = Picture["icons/unchecked.png"] Then
'     For Each res
'       res["fldchk"] = False
'       res["xyz"] = False
'       res.Update
'     Next
'     For i = 0 To GridView2.Count - 1
'       GridView2[i, 1].Picture = Picture["icons/unchecked.png"]
'     Next
'
'   Endif
'
' End

''============== Reporting Procedures =============================
Private Sub MarkPrintedSelected()

  Dim i As Integer
  Dim res As Result

  If chkmark.Value = True Then
    For i = 0 To GridView1.Count - 1
      $rData.MoveTo(i)
      If $rData["fldchk"] = True Then
        res = modDatabase.$myConn.Edit("tblpatradiotest", "fldid=&1", $rData["fldid"])
        res["fldprint"] = True
        res["xyz"] = False
        res.Update
      Endif
    Next
  Endif

End

Public Sub btncommlist_Click()

  Dim testList As String[]
  Dim i As Integer

  testList = New String[]
  For i = 0 To GridView1.Count - 1
    $rData.MoveTo(i)
    If $rData["fldchk"] = True Then
      If $rData["fldcomment"] Then
        testList.Add("<p>" & "<b>" & $rData["fldtestid"] & ":</b>" & modString.HTMLBlankSpace(2) & $rData["fldcomment"] & "</p>")
      Endif
    Endif
  Next
  If testList.Count Then
    txtcomment.RichText = txtcomment.RichText & gb.NewLine & testList.Join(gb.NewLine)
  Endif

End

Public Sub btnfootlist_Click()

  Dim xlst As String[]
  Dim i As Integer
  Dim xx As String
  Dim xlink As String
  Dim sText As String[]

  xlst = SelectListView(("Select Foot Notes"), modLabSub.ListFooterNoteList(), False)
  If xlst Then
    sText = New String[]
    For i = 1 To 50
      xx = modSettings.ShowSettingFromFIle("FooterNote/Name_" & CStr(i))
      If xlst.Exist(xx) Then
        xlink = modSettings.ShowSettingFromFIle("FooterNote/Link_" & CStr(i))
        If Exist(xlink) Then
          sText.Add(File.Load(xlink))
        Endif
      Endif
    Next

    If sText.Count Then
      txtcomment.RichText = txtcomment.RichText & gb.NewLine & sText.Join(gb.NewLine)
    Endif
  Endif

End

Public Sub cmbfootest_Click()

  Dim xx As String

  If cmbfootest.Text Then
    xx = modFixRadio.GetRadioToolTip(cmbfootest.Text)
    If xx Then
      txtcomment.RichText = txtcomment.RichText & gb.NewLine & xx
    Endif
  Endif

End

''=============================== REPORTING ============================
Private Sub ShowRadioLaboratoryReport(sType As String, sHide As Boolean)

  Dim $BillingReport As CReportHTML
  Dim res As Result
  Dim asx As New String[0]
  Dim i As Integer
  Dim sTitles As String[]
  Dim aColl As Collection
  Dim xType As String

  Dim categ As String[]
  Dim newCateg As String[]
  Dim xx As String
  Dim dtcont As String
  Dim xval As String
  Dim xsection As String
  Dim xbarinv As String
  Dim xqrinv As String

  Dim repor As String
  Dim verif As String
  Dim repolast As String
  Dim verilast As String

  Dim xfontcol1 As String
  Dim xfontcol2 As String
  Dim xfontbod As String
  Dim col1Font As String
  Dim col2Font As String
  Dim xintrp As String
  Dim xexlabel As String

  Dim aa As String
  Dim bb As String
  Dim cc As String
  Dim xquali As String
  Dim xrefstr As String
  Dim yrefstr As String

  Dim $reportedBy As String[]
  Dim $verifiedBy As String[]
  Dim $reportedLast As String[]
  Dim $verifiedLast As String[]
  Dim $specName As String[]
  Dim $condiName As String[]
  Dim $ReportDate As String[]
  Dim $ReportLastDate As String[]
  Dim $VerifyDate As String[]
  Dim $VerifyLastDate As String[]
  Dim $invoiceNo As String[]

  xfontbod = modSettings.ShowSettingFromFIle("ReportFormat/ReportBody_ContentFont")
  xfontcol1 = modSettings.ShowSettingFromFIle("ReportFormat/ReportBody_Font_Column1")
  xfontcol2 = modSettings.ShowSettingFromFIle("ReportFormat/ReportBody_Font_Column2")
  xintrp = modSettings.ShowSettingFromFIle("Laboratory/Observation_Comment")

  If xfontcol1 Then
    col1Font = xfontcol1
  Else
    If xfontbod Then
      col1Font = xfontbod
    Else
      col1Font = "bold"
    Endif
  Endif

  If xfontcol2 Then
    col2Font = xfontcol2
  Else
    If xfontbod Then
      col2Font = xfontbod
    Else
      col2Font = ""
    Endif
  Endif

  aColl = New Collection
  If $CategList.Count Then
    newCateg = $CategList
  Else
    categ = New String[]
    For i = 0 To GridView1.Count - 1
      $rData.MoveTo(i)
      If $rData["fldchk"] = True Then
        xval = modFixRadio.GetRadioTestCategory($rData["fldtestid"])

        If categ.Count = 0 Then
          categ.Add(xval)
        Else
          If categ.Exist(xval) = False Then
            categ.Add(xval)
          Endif
        Endif

      Endif
    Next

    newCateg = categ
  Endif

  If rbimage.Value = True Then
    sTitles = [("Examination"), ("Observation"), ("Images")]
  Else If rbform1.Value = True Then
    sTitles = [("Examination"), ("Observation")]
  Else If rbform3.Value = True Then
    sTitles = [("Examination")]
  Else
    sTitles = [("Examination"), ("Observation"), ("Reference Range")]
  Endif

  If sHide = True Then
    $BillingReport = New CReportHTML(sTitles, "LaboratoryReport", $encid, ["Title", "FootImage"])
  Else
    $BillingReport = New CReportHTML(sTitles, "LaboratoryReport", $encid)
  Endif
  $HashCode = $BillingReport.GetReportHash()

  xsection = modBasic.$LabReportSections
  If xsection = "Separate" Then
    ''=========== For separate Report ============
    For Each xx In newCateg
      $BillingReport.UserData.Add("SECTION", "Report")
      $BillingReport.UserData.Add(xx, "PARAM1")
      $BillingReport.UserData.Add(txtcomment.RichText, "FooterSummary")

      $reportedBy = New String[]
      $verifiedBy = New String[]
      $reportedLast = New String[]
      $verifiedLast = New String[]
      $specName = New String[]
      $condiName = New String[]
      $ReportDate = New String[]
      $ReportLastDate = New String[]
      $VerifyDate = New String[]
      $VerifyLastDate = New String[]
      $invoiceNo = New String[]

      dtcont = modSettings.ShowSettingFromFIle("Laboratory/DateContent")
      For i = 0 To GridView1.Count - 1
        aa = ""
        bb = ""
        cc = ""
        $rData.MoveTo(i)
        If $rData["fldchk"] = True And If modFixRadio.GetRadioTestCategory($rData["fldtestid"]) = xx Then
          $reportedBy.Add($rData["flduserid_report"])
          $verifiedBy.Add($rData["flduserid_verify"])
          If $rData["fldupuser_report"] Then
            $reportedLast.Add($rData["fldupuser_report"])
          Else
            $reportedLast.Add($rData["flduserid_report"])
          Endif
          If $rData["fldupuser_verify"] Then
            $verifiedLast.Add($rData["fldupuser_verify"])
          Else
            $verifiedLast.Add($rData["flduserid_verify"])
          Endif
          $specName.Add($rData["fldsampletype"])
          $condiName.Add($rData["fldcondition"])
          $invoiceNo.Add($rData["fldbillno"])
          If dtcont = "DateTime" Then
            $ReportDate.Add(modReportVar.GetDateTimeReport($rData["fldtime_report"], gb.GeneralDate))
            If $rData["flduptime_report"] Then
              $ReportLastDate.Add(modReportVar.GetDateTimeReport($rData["flduptime_report"], gb.GeneralDate))
            Else
              $ReportLastDate.Add(modReportVar.GetDateTimeReport($rData["fldtime_report"], gb.GeneralDate))
            Endif
            $VerifyDate.Add(modReportVar.GetDateTimeReport($rData["fldtime_verify"], gb.GeneralDate))
            If $rData["flduptime_verify"] Then
              $VerifyLastDate.Add(modReportVar.GetDateTimeReport($rData["flduptime_verify"], gb.GeneralDate))
            Else
              $VerifyLastDate.Add(modReportVar.GetDateTimeReport($rData["fldtime_verify"], gb.GeneralDate))
            Endif

          Else
            $ReportDate.Add(modReportVar.GetDateTimeReport($rData["fldtime_report"], gb.MediumDate))
            If $rData["flduptime_report"] Then
              $ReportLastDate.Add(modReportVar.GetDateTimeReport($rData["flduptime_report"], gb.MediumDate))
            Else
              $ReportLastDate.Add(modReportVar.GetDateTimeReport($rData["fldtime_report"], gb.MediumDate))
            Endif
            $VerifyDate.Add(modReportVar.GetDateTimeReport($rData["fldtime_verify"], gb.MediumDate))
            If $rData["flduptime_verify"] Then
              $VerifyLastDate.Add(modReportVar.GetDateTimeReport($rData["flduptime_verify"], gb.MediumDate))
            Else
              $VerifyLastDate.Add(modReportVar.GetDateTimeReport($rData["fldtime_verify"], gb.MediumDate))
            Endif

          Endif
          If $rData["fldcomment"] Then
            aColl.Add($rData["fldcomment"], $rData["fldtestid"])
          Endif

          If rbimage.Value = True Then
            aa = modRadioTest.GetRadionameFromTestID($rData["fldid"])
            If $rData["fldtest_type"] = "Quantitative" Then
              If xintrp = "Interpretation" Then
                xrefstr = "<br>" & "<small>" & modRadioTest.RadioTestInterpretByTestID($rData["fldid"]) & "</small>"
              Else If xintrp = "Comment" Then
                xrefstr = "<br>" & "<small>" & $rData["fldcomment"] & "</small>"
              Else
                xrefstr = ""
              Endif
              bb = modRadioTest.GetRadioTestValueGridString($encid, $rData["fldid"], True) & " [" & modRadioTest.GetRadioTestLimitSrting($rData["fldid"]) & "]" & xrefstr
            Else If $rData["fldtest_type"] = "Qualitative" Then
              xrefstr = modRadioTest.GetRadioTestLimitSrting($rData["fldid"])
              If xrefstr Then
                bb = modRadioTest.GetRadioTestValueGridString($encid, $rData["fldid"], True) & " [" & xrefstr & "]"
              Else
                bb = modRadioTest.GetRadioTestValueGridString($encid, $rData["fldid"], True)
              Endif
            Endif
            If Not Len(Trim(bb)) Then
              With asx
                .Add(aa)
                .Add(modImage.ShowTestExamImageListString("Radio", $rData["fldid"], $encid))
              End With
              $BillingReport.Add(asx, "2")
              asx.Clear()
            Else
              With asx
                .Add(aa)
                .Add(bb)
                .Add(modImage.ShowTestExamImageListString("Radio", $rData["fldid"], $encid))
              End With
              $BillingReport.Add(asx)
              asx.Clear()
            Endif

          Else If rbform1.Value = True Then
            aa = modRadioTest.GetRadionameFromTestID($rData["fldid"])
            If $rData["fldtest_type"] = "Quantitative" Then
              If xintrp = "Interpretation" Then
                xrefstr = "<br>" & "<small>" & modRadioTest.RadioTestInterpretByTestID($rData["fldid"]) & "</small>"
              Else If xintrp = "Comment" Then
                xrefstr = "<br>" & "<small>" & $rData["fldcomment"] & "</small>"
              Else
                xrefstr = ""
              Endif
              bb = modRadioTest.GetRadioTestValueGridString($encid, $rData["fldid"], True) & " [" & modRadioTest.GetRadioTestLimitSrting($rData["fldid"]) & "]" & xrefstr
            Else If $rData["fldtest_type"] = "Qualitative" Then
              xrefstr = modRadioTest.GetRadioTestLimitSrting($rData["fldid"])
              If xrefstr Then
                bb = modRadioTest.GetRadioTestValueGridString($encid, $rData["fldid"], True) & " [" & xrefstr & "]"
              Else
                bb = modRadioTest.GetRadioTestValueGridString($encid, $rData["fldid"], True)
              Endif
            Endif
            If Not Len(Trim(bb)) Then
              With asx
                .Add(aa)
              End With
              $BillingReport.Add(asx, "2")
              asx.Clear()
            Else
              With asx
                .Add(aa)
                .Add(bb)
              End With
              $BillingReport.Add(asx)
              asx.Clear()
            Endif

          Else If rbform3.Value = True Then
            aa = modRadioTest.GetRadionameFromTestID($rData["fldid"])
            If $rData["fldtest_type"] = "Quantitative" Then
              If xintrp = "Interpretation" Then
                xrefstr = "<br>" & "<small>" & modRadioTest.RadioTestInterpretByTestID($rData["fldid"]) & "</small>"
              Else If xintrp = "Comment" Then
                xrefstr = "<br>" & "<small>" & $rData["fldcomment"] & "</small>"
              Else
                xrefstr = ""
              Endif
              bb = modRadioTest.GetRadioTestValueGridString($encid, $rData["fldid"], True) & " [" & modRadioTest.GetRadioTestLimitSrting($rData["fldid"]) & "]" & xrefstr
            Else If $rData["fldtest_type"] = "Qualitative" Then
              xrefstr = modRadioTest.GetRadioTestLimitSrting($rData["fldid"])
              If xrefstr Then
                bb = modRadioTest.GetRadioTestValueGridString($encid, $rData["fldid"], True) & " [" & xrefstr & "]"
              Else
                bb = modRadioTest.GetRadioTestValueGridString($encid, $rData["fldid"], True)
              Endif
            Endif
            With asx
              .Add(modString.GetFormatTextFontString(aa, col1Font) & "<br>" & modString.GetFormatTextFontString(bb, col2Font))
            End With
            $BillingReport.Add(asx)
            asx.Clear()

          Else
            aa = modRadioTest.GetRadionameFromTestID($rData["fldid"])
            If $rData["fldtest_type"] = "Quantitative" Then
              If xintrp = "Interpretation" Then
                xrefstr = "<br>" & "<small>" & modRadioTest.RadioTestInterpretByTestID($rData["fldid"]) & "</small>"
              Else If xintrp = "Comment" Then
                xrefstr = "<br>" & "<small>" & $rData["fldcomment"] & "</small>"
              Else
                xrefstr = ""
              Endif
              bb = modRadioTest.GetRadioTestValueGridString($encid, $rData["fldid"], True) & xrefstr
              cc = modRadioTest.GetRadioTestLimitSrting($rData["fldid"])
            Else If $rData["fldtest_type"] = "Qualitative" Then
              bb = modRadioTest.GetRadioTestValueGridString($encid, $rData["fldid"], True)
              cc = modRadioTest.GetRadioTestLimitSrting($rData["fldid"])
            Endif
            If Not Len(Trim(bb)) Then
              With asx
                .Add(aa)
                .Add(cc)
              End With
              $BillingReport.Add(asx, "2")
              asx.Clear()
            Else
              With asx
                .Add(aa)
                .Add(bb)
                .Add(cc)
              End With
              $BillingReport.Add(asx)
              asx.Clear()
            Endif

          Endif

          If $rData["fldtest_type"] = "Qualitative" Then

            xType = modFixRadio.GetRadioTestOption($rData["fldtestid"])
            If xType = "Left/Right Components" Then
              With asx
                If rbform1.Value = True Then
                  .Add("")
                  .Add(modString.GetLeftRightTableHeader())
                Else If rbform3.Value = True Then
                  .Add(modString.GetLeftRightTableHeader())
                  $BillingReport.Add(asx)
                  asx.Clear()
                Else
                  .Add("")
                  .Add(modString.GetLeftRightTableHeader())
                  .Add("")
                Endif
              End With
              $BillingReport.Add(asx)
              asx.Clear()
            Endif

            res = modDatabase.$myConn.Exec("select fldsubtest,fldabnormal,fldreport,fldid,fldtestid,fldtanswertype,fldindex from tblpatradiosubtest where fldtestid=&1 and fldchk=&2 and fldsave=&3" & modRadioSub.GetRadioRepoOrder("SubTest"), $rData["fldid"], True, True)
            If res.Available = True Then
              For Each res
                If xType = "Left/Right Components" Then
                  xquali = modString.GetLeftRightTableValue(res["fldreport"])
                Else
                  If res["fldtanswertype"] = "Multiple Selection" Then
                    xquali = modRadioTest.GetSubRadioTableReportString(res["fldtestid"], res["fldid"], True, res["fldindex"])
                  Else If res["fldtanswertype"] = "Text Table" Then
                    xquali = modRadioTest.GetSubRadioTableReportString(res["fldtestid"], res["fldid"], True, res["fldindex"])
                  Else If res["fldtanswertype"] = "Dual Columns" Then
                    xquali = modRadioTest.GetSubRadioDualTableString(res["fldtestid"], res["fldid"], True, res["fldindex"])
                  Else If res["fldtanswertype"] = "Triple Columns" Then
                    xquali = modRadioTest.GetSubRadioTriTableString(res["fldtestid"], res["fldid"], True, res["fldindex"])
                  Else If res["fldtanswertype"] = "Single Column" Then
                    xquali = modRadioTest.GetSubRadioTableReportString(res["fldtestid"], res["fldid"], True, res["fldindex"])
                  Else If res["fldtanswertype"] = "Left and Right" Then
                    xquali = modString.GetJSONToDualHTMLTable(res["fldreport"])
                  Else
                    If res["fldabnormal"] = True And If modBasic.$AbnFormat Then
                      xquali = modString.GetAbnormalFormattedString(res["fldreport"])
                    Else
                      xquali = res["fldreport"]
                    Endif
                  Endif
                Endif

                If xquali Then
                  If rbform1.Value = True Then
                    aa = modString.HTMLBlankSpace(4) & res["fldsubtest"]
                    yrefstr = modFixRadio.GetSubRadioTestQualiReference(modRadioTest.GetRadionameFromTestID($rData["fldid"]), res["fldsubtest"])
                    If yrefstr Then
                      bb = res["fldreport"] & " [" & yrefstr & " ]"
                    Else
                      bb = xquali
                    Endif
                    With asx
                      .Add(aa)
                      .Add(bb)
                    End With
                    $BillingReport.Add(asx)
                    asx.Clear()

                  Else If rbform3.Value = True Then
                    aa = res["fldsubtest"]
                    yrefstr = modFixRadio.GetSubRadioTestQualiReference(modRadioTest.GetRadionameFromTestID($rData["fldid"]), res["fldsubtest"])
                    If yrefstr Then
                      bb = res["fldreport"] & " [" & yrefstr & " ]"
                    Else
                      bb = xquali
                    Endif
                    With asx
                      .Add(modString.GetFormatTextFontString(aa, col1Font) & "<br>" & modString.GetFormatTextFontString(bb, col2Font))
                    End With
                    $BillingReport.Add(asx)
                    asx.Clear()

                  Else
                    aa = modString.HTMLBlankSpace(4) & res["fldsubtest"]
                    bb = xquali
                    cc = modFixRadio.GetSubRadioTestQualiReference(modRadioTest.GetRadionameFromTestID($rData["fldid"]), res["fldsubtest"])
                    With asx
                      .Add(aa)
                      .Add(bb)
                      .Add(cc)
                    End With
                    $BillingReport.Add(asx)
                    asx.Clear()

                  Endif
                Endif

              Next
            Endif
          Endif

        Endif
      Next

      ''default footer
      If aColl.Count Then
        $BillingReport.UserData.Add(modString.GetCollectionString(aColl).Join("<br>"), "FooterComment")
      Else
        $BillingReport.UserData.Add("", "FooterComment")
      Endif
      repor = modSettings.ShowSettingFromFIle("Laboratory/Footer_ReportedBy")
      verif = modSettings.ShowSettingFromFIle("Laboratory/Footer_VerifiedBy")
      repolast = modSettings.ShowSettingFromFIle("Laboratory/Footer_ReportedPos")
      verilast = modSettings.ShowSettingFromFIle("Laboratory/Footer_VerifiedPos")

      modReportVar.$FoottUser1 = ""
      modReportVar.$FoottUser2 = ""
      modReportVar.$FoottUser3 = ""

      If repolast = "Last" Then
        If repor = "Column1" Then
          modReportVar.$FoottUser1 = modString.BinaryDistinctStringArray($reportedLast).Join(",")
        Else If repor = "Column2" Then
          modReportVar.$FoottUser2 = modString.BinaryDistinctStringArray($reportedLast).Join(",")
        Else If repor = "Column3" Then
          modReportVar.$FoottUser3 = modString.BinaryDistinctStringArray($reportedLast).Join(",")
        Endif
      Else
        If repor = "Column1" Then
          modReportVar.$FoottUser1 = modString.BinaryDistinctStringArray($reportedBy).Join(",")
        Else If repor = "Column2" Then
          modReportVar.$FoottUser2 = modString.BinaryDistinctStringArray($reportedBy).Join(",")
        Else If repor = "Column3" Then
          modReportVar.$FoottUser3 = modString.BinaryDistinctStringArray($reportedBy).Join(",")
        Endif
      Endif

      If verilast = "Last" Then
        If verif = "Column1" Then
          modReportVar.$FoottUser1 = modString.BinaryDistinctStringArray($verifiedLast).Join(",")
        Else If verif = "Column2" Then
          modReportVar.$FoottUser2 = modString.BinaryDistinctStringArray($verifiedLast).Join(",")
        Else If verif = "Column3" Then
          modReportVar.$FoottUser3 = modString.BinaryDistinctStringArray($verifiedLast).Join(",")
        Endif
      Else
        If verif = "Column1" Then
          modReportVar.$FoottUser1 = modString.BinaryDistinctStringArray($verifiedBy).Join(",")
        Else If verif = "Column2" Then
          modReportVar.$FoottUser2 = modString.BinaryDistinctStringArray($verifiedBy).Join(",")
        Else If verif = "Column3" Then
          modReportVar.$FoottUser3 = modString.BinaryDistinctStringArray($verifiedBy).Join(",")
        Endif
      Endif

      ''header
      $BillingReport.UserData.Add("", "EXTRA1")
      $BillingReport.UserData.Add("", "EXTRA2")
      $BillingReport.UserData.Add("", "EXTRA3")
      $BillingReport.UserData.Add("", "EXTRA4")
      $BillingReport.UserData.Add("", "EXTRA5")
      $BillingReport.UserData.Add("", "EXTRA6")
      $BillingReport.UserData.Add("", "EXTRA7")
      $BillingReport.UserData.Add("", "EXTRA8")

      xexlabel = modSettings.ShowSettingFromFIle("Laboratory/Show_ExtraLabel")
      If xexlabel = "Yes" Then
        If modLabSub.GetLabExtraColumnName("ReportDate") Then
          $BillingReport.UserData.Add("Reporting Date: " & modString.BinaryDistinctStringArray($ReportDate).Join(","), modLabSub.GetLabExtraColumnName("ReportDate"))
        Endif
        If modLabSub.GetLabExtraColumnName("ReportLastDate") Then
          $BillingReport.UserData.Add("Reporting Date: " & modString.BinaryDistinctStringArray($ReportLastDate).Join(","), modLabSub.GetLabExtraColumnName("ReportLastDate"))
        Endif
        If modLabSub.GetLabExtraColumnName("VerifydDate") Then
          $BillingReport.UserData.Add("Verification Date: " & modString.BinaryDistinctStringArray($VerifyDate).Join(","), modLabSub.GetLabExtraColumnName("VerifydDate"))
        Endif
        If modLabSub.GetLabExtraColumnName("VerifyLastDate") Then
          $BillingReport.UserData.Add("Verification Date: " & modString.BinaryDistinctStringArray($VerifyLastDate).Join(","), modLabSub.GetLabExtraColumnName("VerifyLastDate"))
        Endif
        If modLabSub.GetLabExtraColumnName("Specimen") Then
          $BillingReport.UserData.Add("Eval Site: " & modString.BinaryDistinctStringArray($specName).Join(","), modLabSub.GetLabExtraColumnName("Specimen"))
        Endif
        If modLabSub.GetLabExtraColumnName("Condition") Then
          $BillingReport.UserData.Add("Clinical Note: " & modString.BinaryDistinctStringArray($condiName).Join(","), modLabSub.GetLabExtraColumnName("Condition"))
        Endif
        If modLabSub.GetLabExtraColumnName("InvoiceNo") Then
          $BillingReport.UserData.Add("Invoice No: " & modString.BinaryDistinctStringArray($invoiceNo).Join(","), modLabSub.GetLabExtraColumnName("InvoiceNo"))
        Endif

      Else
        If modLabSub.GetLabExtraColumnName("ReportDate") Then
          $BillingReport.UserData.Add(modString.BinaryDistinctStringArray($ReportDate).Join(","), modLabSub.GetLabExtraColumnName("ReportDate"))
        Endif
        If modLabSub.GetLabExtraColumnName("ReportLastDate") Then
          $BillingReport.UserData.Add(modString.BinaryDistinctStringArray($ReportLastDate).Join(","), modLabSub.GetLabExtraColumnName("ReportLastDate"))
        Endif
        If modLabSub.GetLabExtraColumnName("VerifydDate") Then
          $BillingReport.UserData.Add(modString.BinaryDistinctStringArray($VerifyDate).Join(","), modLabSub.GetLabExtraColumnName("VerifydDate"))
        Endif
        If modLabSub.GetLabExtraColumnName("VerifyLastDate") Then
          $BillingReport.UserData.Add(modString.BinaryDistinctStringArray($VerifyLastDate).Join(","), modLabSub.GetLabExtraColumnName("VerifyLastDate"))
        Endif
        If modLabSub.GetLabExtraColumnName("Specimen") Then
          $BillingReport.UserData.Add(modString.BinaryDistinctStringArray($specName).Join(","), modLabSub.GetLabExtraColumnName("Specimen"))
        Endif
        If modLabSub.GetLabExtraColumnName("Condition") Then
          $BillingReport.UserData.Add(modString.BinaryDistinctStringArray($condiName).Join(","), modLabSub.GetLabExtraColumnName("Condition"))
        Endif
        If modLabSub.GetLabExtraColumnName("InvoiceNo") Then
          $BillingReport.UserData.Add(modString.BinaryDistinctStringArray($invoiceNo).Join(","), modLabSub.GetLabExtraColumnName("InvoiceNo"))
        Endif

      Endif
      If modLabSub.GetLabExtraColumnName("InvoiceBarCode") Then
        xbarinv = modDevAll.GetBarCodeWithOptions(modString.BinaryDistinctStringArray($invoiceNo)[0])
        If xbarinv Then
          $BillingReport.UserData.Add(modPrint.GetFileWebURL(xbarinv), modLabSub.GetLabExtraColumnName("InvoiceBarCode"))
        Else
          $BillingReport.UserData.Add("", modLabSub.GetLabExtraColumnName("InvoiceBarCode"))
        Endif
      Endif
      If modLabSub.GetLabExtraColumnName("InvoiceQRCode") Then
        xqrinv = modDevAll.MakeQRCode(modString.BinaryDistinctStringArray($invoiceNo)[0])
        If xqrinv Then
          $BillingReport.UserData.Add(modPrint.GetFileWebURL(xqrinv), modLabSub.GetLabExtraColumnName("InvoiceQRCode"))
        Else
          $BillingReport.UserData.Add("", modLabSub.GetLabExtraColumnName("InvoiceQRCode"))
        Endif
      Endif

      ''final print
      If sType = "Report" Then
        modControlSub.OpenHTMLPreview($encid, $BillingReport.NewHTMLPath(), "ReportSize", "Radio Diagnostics")
      Else If sType = "FTP" Then
        SendFTPSMS($BillingReport.NewHTMLPath())
      Else If sType = "Save" Then
        SaveReportAsHTML($BillingReport.NewHTMLPath())
      Endif
    Next

  Else
    ''=========== For combined Report ============
    $BillingReport.UserData.Add("SECTION", "Report")
    $BillingReport.UserData.Add(newCateg.Join(";"), "PARAM1")
    $BillingReport.UserData.Add(txtcomment.RichText, "FooterSummary")

    $reportedBy = New String[]
    $verifiedBy = New String[]
    $reportedLast = New String[]
    $verifiedLast = New String[]
    $specName = New String[]
    $condiName = New String[]
    $ReportDate = New String[]
    $ReportLastDate = New String[]
    $VerifyDate = New String[]
    $VerifyLastDate = New String[]
    $invoiceNo = New String[]

    dtcont = modSettings.ShowSettingFromFIle("Laboratory/DateContent")
    For Each xx In newCateg
      $BillingReport.AddSection(xx, True)

      For i = 0 To GridView1.Count - 1
        aa = ""
        bb = ""
        cc = ""
        $rData.MoveTo(i)
        If $rData["fldchk"] = True And If modFixRadio.GetRadioTestCategory($rData["fldtestid"]) = xx Then
          $reportedBy.Add($rData["flduserid_report"])
          $verifiedBy.Add($rData["flduserid_verify"])
          If $rData["fldupuser_report"] Then
            $reportedLast.Add($rData["fldupuser_report"])
          Else
            $reportedLast.Add($rData["flduserid_report"])
          Endif
          If $rData["fldupuser_verify"] Then
            $verifiedLast.Add($rData["fldupuser_verify"])
          Else
            $verifiedLast.Add($rData["flduserid_verify"])
          Endif
          $specName.Add($rData["fldsampletype"])
          $condiName.Add($rData["fldcondition"])
          $invoiceNo.Add($rData["fldbillno"])
          If dtcont = "DateTime" Then
            $ReportDate.Add(modReportVar.GetDateTimeReport($rData["fldtime_report"], gb.GeneralDate))
            If $rData["flduptime_report"] Then
              $ReportLastDate.Add(modReportVar.GetDateTimeReport($rData["flduptime_report"], gb.GeneralDate))
            Else
              $ReportLastDate.Add(modReportVar.GetDateTimeReport($rData["fldtime_report"], gb.GeneralDate))
            Endif
            $VerifyDate.Add(modReportVar.GetDateTimeReport($rData["fldtime_verify"], gb.GeneralDate))
            If $rData["flduptime_verify"] Then
              $VerifyLastDate.Add(modReportVar.GetDateTimeReport($rData["flduptime_verify"], gb.GeneralDate))
            Else
              $VerifyLastDate.Add(modReportVar.GetDateTimeReport($rData["fldtime_verify"], gb.GeneralDate))
            Endif

          Else
            $ReportDate.Add(modReportVar.GetDateTimeReport($rData["fldtime_report"], gb.MediumDate))
            If $rData["flduptime_report"] Then
              $ReportLastDate.Add(modReportVar.GetDateTimeReport($rData["flduptime_report"], gb.MediumDate))
            Else
              $ReportLastDate.Add(modReportVar.GetDateTimeReport($rData["fldtime_report"], gb.MediumDate))
            Endif
            $VerifyDate.Add(modReportVar.GetDateTimeReport($rData["fldtime_verify"], gb.MediumDate))
            If $rData["flduptime_verify"] Then
              $VerifyLastDate.Add(modReportVar.GetDateTimeReport($rData["flduptime_verify"], gb.MediumDate))
            Else
              $VerifyLastDate.Add(modReportVar.GetDateTimeReport($rData["fldtime_verify"], gb.MediumDate))
            Endif

          Endif
          If $rData["fldcomment"] Then
            aColl.Add($rData["fldcomment"], $rData["fldtestid"])
          Endif

          If rbimage.Value = True Then
            aa = modRadioTest.GetRadionameFromTestID($rData["fldid"])
            If $rData["fldtest_type"] = "Quantitative" Then
              If xintrp = "Interpretation" Then
                xrefstr = "<br>" & "<small>" & modRadioTest.RadioTestInterpretByTestID($rData["fldid"]) & "</small>"
              Else If xintrp = "Comment" Then
                xrefstr = "<br>" & "<small>" & $rData["fldcomment"] & "</small>"
              Else
                xrefstr = ""
              Endif
              bb = modRadioTest.GetRadioTestValueGridString($encid, $rData["fldid"], True) & " [" & modRadioTest.GetRadioTestLimitSrting($rData["fldid"]) & "]" & xrefstr
            Else If $rData["fldtest_type"] = "Qualitative" Then
              xrefstr = modRadioTest.GetRadioTestLimitSrting($rData["fldid"])
              If xrefstr Then
                bb = modRadioTest.GetRadioTestValueGridString($encid, $rData["fldid"], True) & " [" & xrefstr & "]"
              Else
                bb = modRadioTest.GetRadioTestValueGridString($encid, $rData["fldid"], True)
              Endif
            Endif
            If Not Len(Trim(bb)) Then
              With asx
                .Add(aa)
                .Add(modImage.ShowTestExamImageListString("Radio", $rData["fldid"], $encid))
              End With
              $BillingReport.Add(asx, "2")
              asx.Clear()
            Else
              With asx
                .Add(aa)
                .Add(bb)
                .Add(modImage.ShowTestExamImageListString("Radio", $rData["fldid"], $encid))
              End With
              $BillingReport.Add(asx)
              asx.Clear()
            Endif

          Else If rbform1.Value = True Then
            aa = modRadioTest.GetRadionameFromTestID($rData["fldid"])
            If $rData["fldtest_type"] = "Quantitative" Then
              If xintrp = "Interpretation" Then
                xrefstr = "<br>" & "<small>" & modRadioTest.RadioTestInterpretByTestID($rData["fldid"]) & "</small>"
              Else If xintrp = "Comment" Then
                xrefstr = "<br>" & "<small>" & $rData["fldcomment"] & "</small>"
              Else
                xrefstr = ""
              Endif
              bb = modRadioTest.GetRadioTestValueGridString($encid, $rData["fldid"], True) & " [" & modRadioTest.GetRadioTestLimitSrting($rData["fldid"]) & "]" & xrefstr
            Else If $rData["fldtest_type"] = "Qualitative" Then
              xrefstr = modRadioTest.GetRadioTestLimitSrting($rData["fldid"])
              If xrefstr Then
                bb = modRadioTest.GetRadioTestValueGridString($encid, $rData["fldid"], True) & " [" & xrefstr & "]"
              Else
                bb = modRadioTest.GetRadioTestValueGridString($encid, $rData["fldid"], True)
              Endif
            Endif
            If Not Len(Trim(bb)) Then
              With asx
                .Add(aa)
              End With
              $BillingReport.Add(asx, "2")
              asx.Clear()
            Else
              With asx
                .Add(aa)
                .Add(bb)
              End With
              $BillingReport.Add(asx)
              asx.Clear()
            Endif

          Else If rbform3.Value = True Then
            aa = modRadioTest.GetRadionameFromTestID($rData["fldid"])
            If $rData["fldtest_type"] = "Quantitative" Then
              If xintrp = "Interpretation" Then
                xrefstr = "<br>" & "<small>" & modRadioTest.RadioTestInterpretByTestID($rData["fldid"]) & "</small>"
              Else If xintrp = "Comment" Then
                xrefstr = "<br>" & "<small>" & $rData["fldcomment"] & "</small>"
              Else
                xrefstr = ""
              Endif
              bb = modRadioTest.GetRadioTestValueGridString($encid, $rData["fldid"], True) & " [" & modRadioTest.GetRadioTestLimitSrting($rData["fldid"]) & "]" & xrefstr
            Else If $rData["fldtest_type"] = "Qualitative" Then
              xrefstr = modRadioTest.GetRadioTestLimitSrting($rData["fldid"])
              If xrefstr Then
                bb = modRadioTest.GetRadioTestValueGridString($encid, $rData["fldid"], True) & " [" & xrefstr & "]"
              Else
                bb = modRadioTest.GetRadioTestValueGridString($encid, $rData["fldid"], True)
              Endif
            Endif
            With asx
              .Add(modString.GetFormatTextFontString(aa, col1Font) & "<br>" & modString.GetFormatTextFontString(bb, col2Font))
            End With
            $BillingReport.Add(asx)
            asx.Clear()

          Else
            aa = modRadioTest.GetRadionameFromTestID($rData["fldid"])
            If $rData["fldtest_type"] = "Quantitative" Then
              If xintrp = "Interpretation" Then
                xrefstr = "<br>" & "<small>" & modRadioTest.RadioTestInterpretByTestID($rData["fldid"]) & "</small>"
              Else If xintrp = "Comment" Then
                xrefstr = "<br>" & "<small>" & $rData["fldcomment"] & "</small>"
              Else
                xrefstr = ""
              Endif
              bb = modRadioTest.GetRadioTestValueGridString($encid, $rData["fldid"], True) & xrefstr
              cc = modRadioTest.GetRadioTestLimitSrting($rData["fldid"])
            Else If $rData["fldtest_type"] = "Qualitative" Then
              bb = modRadioTest.GetRadioTestValueGridString($encid, $rData["fldid"], True)
              cc = modRadioTest.GetRadioTestLimitSrting($rData["fldid"])
            Endif
            If Not Len(Trim(bb)) Then
              With asx
                .Add(aa)
                .Add(cc)
              End With
              $BillingReport.Add(asx, "2")
              asx.Clear()
            Else
              With asx
                .Add(aa)
                .Add(bb)
                .Add(cc)
              End With
              $BillingReport.Add(asx)
              asx.Clear()
            Endif

          Endif

          If $rData["fldtest_type"] = "Qualitative" Then

            xType = modFixRadio.GetRadioTestOption($rData["fldtestid"])
            If xType = "Left/Right Components" Then
              With asx
                If rbform1.Value = True Then
                  .Add("")
                  .Add(modString.GetLeftRightTableHeader())
                Else If rbform3.Value = True Then
                  .Add(modString.GetLeftRightTableHeader())
                  $BillingReport.Add(asx)
                  asx.Clear()
                Else
                  .Add("")
                  .Add(modString.GetLeftRightTableHeader())
                  .Add("")
                Endif
              End With
              $BillingReport.Add(asx)
              asx.Clear()
            Endif

            res = modDatabase.$myConn.Exec("select fldsubtest,fldabnormal,fldreport,fldid,fldtestid,fldtanswertype,fldindex from tblpatradiosubtest where fldtestid=&1 and fldchk=&2 and fldsave=&3" & modRadioSub.GetRadioRepoOrder("SubTest"), $rData["fldid"], True, True)
            If res.Available = True Then
              For Each res
                If xType = "Left/Right Components" Then
                  xquali = modString.GetLeftRightTableValue(res["fldreport"])
                Else
                  If res["fldtanswertype"] = "Multiple Selection" Then
                    xquali = modRadioTest.GetSubRadioTableReportString(res["fldtestid"], res["fldid"], True, res["fldindex"])
                  Else If res["fldtanswertype"] = "Text Table" Then
                    xquali = modRadioTest.GetSubRadioTableReportString(res["fldtestid"], res["fldid"], True, res["fldindex"])
                  Else If res["fldtanswertype"] = "Dual Columns" Then
                    xquali = modRadioTest.GetSubRadioDualTableString(res["fldtestid"], res["fldid"], True, res["fldindex"])
                  Else If res["fldtanswertype"] = "Triple Columns" Then
                    xquali = modRadioTest.GetSubRadioTriTableString(res["fldtestid"], res["fldid"], True, res["fldindex"])
                  Else If res["fldtanswertype"] = "Single Column" Then
                    xquali = modRadioTest.GetSubRadioTableReportString(res["fldtestid"], res["fldid"], True, res["fldindex"])
                  Else If res["fldtanswertype"] = "Left and Right" Then
                    xquali = modString.GetJSONToDualHTMLTable(res["fldreport"])
                  Else
                    If res["fldabnormal"] = True And If modBasic.$AbnFormat Then
                      xquali = modString.GetAbnormalFormattedString(res["fldreport"])
                    Else
                      xquali = res["fldreport"]
                    Endif
                  Endif
                Endif

                If res["fldtanswertype"] = "Label Only" Then
                  aa = modString.HTMLBlankSpace(3) & res["fldsubtest"]
                  With asx
                    If rbform1.Value = True Then
                      .Add(aa)
                      .Add("")
                    Else If rbform3.Value = True Then
                      .Add(res["fldsubtest"])
                    Else
                      .Add(aa)
                      .Add("")
                      .Add("")
                    Endif
                  End With
                  $BillingReport.Add(asx)
                  asx.Clear()

                Else
                  If xquali Then
                    If rbform1.Value = True Then
                      aa = modString.HTMLBlankSpace(5) & res["fldsubtest"]
                      yrefstr = modFixRadio.GetSubRadioTestQualiReference(modRadioTest.GetRadionameFromTestID($rData["fldid"]), res["fldsubtest"])
                      If yrefstr Then
                        bb = res["fldreport"] & " [" & yrefstr & " ]"
                      Else
                        bb = xquali
                      Endif
                      With asx
                        .Add(aa)
                        .Add(bb)
                      End With
                      $BillingReport.Add(asx)
                      asx.Clear()

                    Else If rbform3.Value = True Then
                      aa = res["fldsubtest"]
                      yrefstr = modFixRadio.GetSubRadioTestQualiReference(modRadioTest.GetRadionameFromTestID($rData["fldid"]), res["fldsubtest"])
                      If yrefstr Then
                        bb = res["fldreport"] & " [" & yrefstr & " ]"
                      Else
                        bb = xquali
                      Endif
                      With asx
                        .Add(modString.GetFormatTextFontString(aa, col1Font) & "<br>" & modString.GetFormatTextFontString(bb, col2Font))
                      End With
                      $BillingReport.Add(asx)
                      asx.Clear()

                    Else
                      aa = modString.HTMLBlankSpace(5) & res["fldsubtest"]
                      bb = xquali
                      cc = modFixRadio.GetSubRadioTestQualiReference(modRadioTest.GetRadionameFromTestID($rData["fldid"]), res["fldsubtest"])
                      With asx
                        .Add(aa)
                        .Add(bb)
                        .Add(cc)
                      End With
                      $BillingReport.Add(asx)
                      asx.Clear()

                    Endif
                  Endif

                Endif

              Next
            Endif
          Endif

        Endif
      Next

    Next

    ''default footer
    If aColl.Count Then
      $BillingReport.UserData.Add(modString.GetCollectionString(aColl).Join("<br>"), "FooterComment")
    Else
      $BillingReport.UserData.Add("", "FooterComment")
    Endif
    repor = modSettings.ShowSettingFromFIle("Laboratory/Footer_ReportedBy")
    verif = modSettings.ShowSettingFromFIle("Laboratory/Footer_VerifiedBy")
    repolast = modSettings.ShowSettingFromFIle("Laboratory/Footer_ReportedPos")
    verilast = modSettings.ShowSettingFromFIle("Laboratory/Footer_VerifiedPos")

    modReportVar.$FoottUser1 = ""
    modReportVar.$FoottUser2 = ""
    modReportVar.$FoottUser3 = ""

    If repolast = "Last" Then
      If repor = "Column1" Then
        modReportVar.$FoottUser1 = modString.BinaryDistinctStringArray($reportedLast).Join(",")
      Else If repor = "Column2" Then
        modReportVar.$FoottUser2 = modString.BinaryDistinctStringArray($reportedLast).Join(",")
      Else If repor = "Column3" Then
        modReportVar.$FoottUser3 = modString.BinaryDistinctStringArray($reportedLast).Join(",")
      Endif
    Else
      If repor = "Column1" Then
        modReportVar.$FoottUser1 = modString.BinaryDistinctStringArray($reportedBy).Join(",")
      Else If repor = "Column2" Then
        modReportVar.$FoottUser2 = modString.BinaryDistinctStringArray($reportedBy).Join(",")
      Else If repor = "Column3" Then
        modReportVar.$FoottUser3 = modString.BinaryDistinctStringArray($reportedBy).Join(",")
      Endif
    Endif

    If verilast = "Last" Then
      If verif = "Column1" Then
        modReportVar.$FoottUser1 = modString.BinaryDistinctStringArray($verifiedLast).Join(",")
      Else If verif = "Column2" Then
        modReportVar.$FoottUser2 = modString.BinaryDistinctStringArray($verifiedLast).Join(",")
      Else If verif = "Column3" Then
        modReportVar.$FoottUser3 = modString.BinaryDistinctStringArray($verifiedLast).Join(",")
      Endif
    Else
      If verif = "Column1" Then
        modReportVar.$FoottUser1 = modString.BinaryDistinctStringArray($verifiedBy).Join(",")
      Else If verif = "Column2" Then
        modReportVar.$FoottUser2 = modString.BinaryDistinctStringArray($verifiedBy).Join(",")
      Else If verif = "Column3" Then
        modReportVar.$FoottUser3 = modString.BinaryDistinctStringArray($verifiedBy).Join(",")
      Endif
    Endif

    ''header
    $BillingReport.UserData.Add("", "EXTRA1")
    $BillingReport.UserData.Add("", "EXTRA2")
    $BillingReport.UserData.Add("", "EXTRA3")
    $BillingReport.UserData.Add("", "EXTRA4")
    $BillingReport.UserData.Add("", "EXTRA5")
    $BillingReport.UserData.Add("", "EXTRA6")
    $BillingReport.UserData.Add("", "EXTRA7")
    $BillingReport.UserData.Add("", "EXTRA8")

    xexlabel = modSettings.ShowSettingFromFIle("Laboratory/Show_ExtraLabel")
    If xexlabel = "Yes" Then
      If modLabSub.GetLabExtraColumnName("ReportDate") Then
        $BillingReport.UserData.Add("Reporting Date: " & modString.BinaryDistinctStringArray($ReportDate).Join(","), modLabSub.GetLabExtraColumnName("ReportDate"))
      Endif
      If modLabSub.GetLabExtraColumnName("ReportLastDate") Then
        $BillingReport.UserData.Add("Reporting Date: " & modString.BinaryDistinctStringArray($ReportLastDate).Join(","), modLabSub.GetLabExtraColumnName("ReportLastDate"))
      Endif
      If modLabSub.GetLabExtraColumnName("VerifydDate") Then
        $BillingReport.UserData.Add("Verification Date: " & modString.BinaryDistinctStringArray($VerifyDate).Join(","), modLabSub.GetLabExtraColumnName("VerifydDate"))
      Endif
      If modLabSub.GetLabExtraColumnName("VerifyLastDate") Then
        $BillingReport.UserData.Add("Verification Date: " & modString.BinaryDistinctStringArray($VerifyLastDate).Join(","), modLabSub.GetLabExtraColumnName("VerifyLastDate"))
      Endif
      If modLabSub.GetLabExtraColumnName("Specimen") Then
        $BillingReport.UserData.Add("Eval Site: " & modString.BinaryDistinctStringArray($specName).Join(","), modLabSub.GetLabExtraColumnName("Specimen"))
      Endif
      If modLabSub.GetLabExtraColumnName("Condition") Then
        $BillingReport.UserData.Add("Clinical Note: " & modString.BinaryDistinctStringArray($condiName).Join(","), modLabSub.GetLabExtraColumnName("Condition"))
      Endif
      If modLabSub.GetLabExtraColumnName("InvoiceNo") Then
        $BillingReport.UserData.Add("Invoice No: " & modString.BinaryDistinctStringArray($invoiceNo).Join(","), modLabSub.GetLabExtraColumnName("InvoiceNo"))
      Endif

    Else
      If modLabSub.GetLabExtraColumnName("ReportDate") Then
        $BillingReport.UserData.Add(modString.BinaryDistinctStringArray($ReportDate).Join(","), modLabSub.GetLabExtraColumnName("ReportDate"))
      Endif
      If modLabSub.GetLabExtraColumnName("ReportLastDate") Then
        $BillingReport.UserData.Add(modString.BinaryDistinctStringArray($ReportLastDate).Join(","), modLabSub.GetLabExtraColumnName("ReportLastDate"))
      Endif
      If modLabSub.GetLabExtraColumnName("VerifydDate") Then
        $BillingReport.UserData.Add(modString.BinaryDistinctStringArray($VerifyDate).Join(","), modLabSub.GetLabExtraColumnName("VerifydDate"))
      Endif
      If modLabSub.GetLabExtraColumnName("VerifyLastDate") Then
        $BillingReport.UserData.Add(modString.BinaryDistinctStringArray($VerifyLastDate).Join(","), modLabSub.GetLabExtraColumnName("VerifyLastDate"))
      Endif
      If modLabSub.GetLabExtraColumnName("Specimen") Then
        $BillingReport.UserData.Add(modString.BinaryDistinctStringArray($specName).Join(","), modLabSub.GetLabExtraColumnName("Specimen"))
      Endif
      If modLabSub.GetLabExtraColumnName("Condition") Then
        $BillingReport.UserData.Add(modString.BinaryDistinctStringArray($condiName).Join(","), modLabSub.GetLabExtraColumnName("Condition"))
      Endif
      If modLabSub.GetLabExtraColumnName("InvoiceNo") Then
        $BillingReport.UserData.Add(modString.BinaryDistinctStringArray($invoiceNo).Join(","), modLabSub.GetLabExtraColumnName("InvoiceNo"))
      Endif

    Endif
    If modLabSub.GetLabExtraColumnName("InvoiceBarCode") Then
      xbarinv = modDevAll.GetBarCodeWithOptions(modString.BinaryDistinctStringArray($invoiceNo)[0])
      If xbarinv Then
        $BillingReport.UserData.Add(modPrint.GetFileWebURL(xbarinv), modLabSub.GetLabExtraColumnName("InvoiceBarCode"))
      Else
        $BillingReport.UserData.Add("", modLabSub.GetLabExtraColumnName("InvoiceBarCode"))
      Endif
    Endif
    If modLabSub.GetLabExtraColumnName("InvoiceQRCode") Then
      xqrinv = modDevAll.MakeQRCode(modString.BinaryDistinctStringArray($invoiceNo)[0])
      If xqrinv Then
        $BillingReport.UserData.Add(modPrint.GetFileWebURL(xqrinv), modLabSub.GetLabExtraColumnName("InvoiceQRCode"))
      Else
        $BillingReport.UserData.Add("", modLabSub.GetLabExtraColumnName("InvoiceQRCode"))
      Endif
    Endif

    ''final print
    If sType = "Report" Then
      modControlSub.OpenHTMLPreview($encid, $BillingReport.NewHTMLPath(), "ReportSize", "Radio Diagnostics")
    Else If sType = "FTP" Then
      SendFTPSMS($BillingReport.NewHTMLPath())
    Else If sType = "Save" Then
      SaveReportAsHTML($BillingReport.NewHTMLPath())
    Else If sType = "Log" Then
      SaveReportLogAsHTML($BillingReport.NewHTMLPath())
    Endif

  Endif

End

Private Sub SaveReportAsHTML(sHTML As String)

  Dim xx As String
  Dim sPath As String
  Dim sInt As String
  Dim sLongID As Long

  sInt = modString.GetNowString()
  sPath = modPrint.ConvertHTMLToPDFString(sHTML, "ReportSize", sInt)
  xx = InputBox(("Title of Report for Archive"), "Radio Diagnostics", cmbcategory.Text)
  sLongID = modImage.SavePatientFileGeneral($encid, "Radio Diagnostics", xx, sPath, $HashCode)
  If sLongID Then
    Me.Exec(Subst("Toastify({text: '&1', duration: &2}).showToast()", "File saved", modBasic.$BalloonDelay))
  Endif

End

Private Sub SaveReportLogAsHTML(sHTML As String)

  Dim xx As String
  Dim sPath As String
  Dim sInt As String
  Dim sLongID As Long

  sInt = modString.GetNowString()
  sPath = modPrint.ConvertHTMLToPDFString(sHTML, "ReportSize", sInt)
  xx = InputBox(("Title of Report for Log"), "Radio Diagnostics", cmbcategory.Text)
  sLongID = modImage.SavePatientFileGeneral($encid, "Radio Diagnostics Log", xx, sPath)
  If sLongID Then
    Me.Exec(Subst("Toastify({text: '&1', duration: &2}).showToast()", "File saved", modBasic.$BalloonDelay))
  Endif

End

Private Sub SendFTPSMS(sHTML As String)

  Dim sPath As String
  Dim sInt As String
  Dim xmsg As String
  Dim xmode As String
  Dim sLongID As Long

  sInt = modString.GetNowString()
  sPath = modPrint.ConvertHTMLToPDFString(sHTML, "ReportSize", sInt)

  sLongID = modImage.SavePatientFileGeneral($encid, "Radio Diagnostics", "SMS Sent", sPath, $HashCode)
  xmode = modSettings.ShowSettingFromFIle("Laboratory/Messaging_Format")
  If xmode = "EMail" Then
    modDevice.SendEMailLabPatient($encid, sPath)
  Else If xmode = "SMS+EMail" Then
    xmsg = modDevice.SendSMSLabPatient($encid, "", "")
    modDevice.SendEMailLabPatient($encid, sPath)
  Else
    xmsg = modDevice.SendSMSLabPatient($encid, "", "")
  Endif
  If $RemoteUpload = "Enable" Then
    modRepository.UploadOneReportToRepository("tblpatreport", sLongID)
    modRepository.UploadSingleToRepository("tblpatientpass", $PortalUser)
    modRepository.UploadSingleToRepository("tblpatientinfo", $patNo)
    modRepository.UploadSingleToRepository("tblencounter", $encid)
  Endif

  If sLongID Then
    Me.Exec(Subst("Toastify({text: '&1', duration: &2}).showToast()", "File saved", modBasic.$BalloonDelay))
  Endif
  If xmsg Then
    Message.Info(xmsg, ("OK"))
  Endif

End

''buttons
Public Sub btnheadless_Click()

  If txtencid.Text Then
    If modNonMedical.AllowEntryWithDeposit($encid, "Test") = True
      MarkPrintedSelected()
      ShowRadioLaboratoryReport("Report", True)
    Else
      Message.Warning("Report printing not allowed", ("OK"))
    Endif
  Endif

End

Public Sub btnreport_Click()

  If txtencid.Text Then
    If modNonMedical.AllowEntryWithDeposit($encid, "Test") = True
      MarkPrintedSelected()
      ShowRadioLaboratoryReport("Report", False)
    Else
      Message.Warning("Report printing not allowed", ("OK"))
    Endif
  Endif

End

Public Sub btnrecord_Click()

  Dim xpass As String

  If txtencid.Text Then
    If modNonMedical.AllowEntryWithDeposit($encid, "Test") = True Then
      MarkPrintedSelected()
      ShowRadioLaboratoryReport("Save", False)
      xpass = modGeneral.SendPatientPasswordForRemote($encid)
      If modBasic.$LabArchieveLog = "Enable" Then
        ShowRadioLaboratoryReport("Log", True)
      Endif
    Else
      Message.Warning("Report printing not allowed", ("OK"))
    Endif
  Endif

End

Public Sub btnftp_Click()

  Dim xpass As String

  If txtencid.Text Then
    If modNonMedical.AllowEntryWithDeposit($encid, "Test") = True Then
      MarkPrintedSelected()
      ShowRadioLaboratoryReport("FTP", False)
      xpass = modGeneral.SendPatientPasswordForRemote($encid)
      If modBasic.$LabArchieveLog = "Enable" Then
        ShowRadioLaboratoryReport("Log", True)
      Endif
      txtportal.Text = GetPortalLink(xpass, $HashCode)
      $NewHash = $HashCode
    Else
      Message.Warning("Report printing not allowed", ("OK"))
    Endif
  Endif

End

Private Function GetPortalLink(sPass As String, sHash As String) As String

  Dim xLink As String

  xLink = $PortalLink & "?user=" & $PortalUser & "&pass=" & sPass & "&type=" & $encid & "@" & sHash

  Return xLink

End

Public Sub btnmoveweb_Click()

  Me.Exec("window.open('" & txtportal.Text & "'); ")

End
