' Gambas module file

Public Function GetTotalExpensebyPatient($BillingReport As CReportHTML, $con As Connection, encid As String, sType As String) As Float

  Dim res As Result
  Dim asx As New String[0]
  Dim xdisc As Float
  Dim xtax As Float
  Dim xcrdt As Float
  Dim xcash As Float

  Dim adisc As Float
  Dim atax As Float
  Dim acrdt As Float
  Dim acash As Float

  Dim xmode As String
  Dim xmodeList As String[] = ["Credit", "Cash"]
  Dim xdoa As Date
  Dim xCategList As String[]
  Dim xcateg As String
  Dim i As Integer
  Dim xfin As Float

  Dim xdueclr As Float
  Dim xdeposit As Float
  Dim xcashtot As Float
  Dim xinvpay As Float

  xdoa = modPatient.GetAdmissionDate(encid)
  xdeposit = modNonMedical.GetPatientDeposit($con, encid)
  If sType = "Admitted" And If xdoa Then
  Else
    xcashtot = modNonMedical.GetCashBillAmtbyPatient($con, encid)
    xdueclr = modNonMedical.GetDueClearPaidAmtbyPatient($con, encid)
    xinvpay = modNonMedical.InvoicePaidAmountbyPatient($con, encid)
  Endif

  For Each xmode In xmodeList
    $BillingReport.AddSection(UCase(xmode), True)

    $BillingReport.AddChapter(UCase(xmode) & " EXPENSES")
    xCategList = modControlSub.GetDirectFillresult($con.Exec("select distinct(flditemtype) as col from tblpatbilling where fldencounterval=&1 and fldsave=&2 and fldbilltype=&3", encid, True, xmode))
    i = 1
    xdisc = 0
    xtax = 0
    xcrdt = 0
    xcash = 0
    For Each xcateg In xCategList
      adisc = 0
      atax = 0
      acrdt = 0
      acash = 0

      If sType = "Admitted" Then
        If xdoa Then
          res = $con.Exec("select flditemname,AVG(flditemrate) as flditemrate,SUM(flditemqty) as flditemqty,SUM(fldtaxamt) as fldtaxamt,SUM(flddiscamt) as flddiscamt," & modNonMedical.CashCreditSQL() & " from tblpatbilling where fldencounterval=&1 and fldsave=&2 and fldbilltype=&3 and flditemtype=&4 and fldtime>=&5 GROUP BY flditemname", encid, True, xmode, xcateg, xdoa)
        Endif
      Else
        res = $con.Exec("select flditemname,AVG(flditemrate) as flditemrate,SUM(flditemqty) as flditemqty,SUM(fldtaxamt) as fldtaxamt,SUM(flddiscamt) as flddiscamt," & modNonMedical.CashCreditSQL() & " from tblpatbilling where fldencounterval=&1 and fldsave=&2 and fldbilltype=&3 and flditemtype=&4 GROUP BY flditemname", encid, True, xmode, xcateg)
      Endif
      If res And If res.Available Then
        $BillingReport.AddChapter(xcateg)
        For Each res
          If res["flddiscamt"] Then
            adisc = adisc + res["flddiscamt"]
          Endif
          If res["fldtaxamt"] Then
            atax = atax + res["fldtaxamt"]
          Endif
          If res["xcredit"] Then
            acrdt = acrdt + res["xcredit"]
          Endif
          If res["xcash"] Then
            acash = acash + res["xcash"]
          Endif
          With asx
            .Add(CStr(i))
            .Add(res["flditemname"])
            .Add(modReportVar.GetLocaleNumberFormat(res["flditemrate"], gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(res["flditemqty"], -2))
            .Add(modReportVar.GetLocaleNumberFormat(res["flddiscamt"], gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(res["fldtaxamt"], gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(res["xcredit"], gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(res["xcash"], gb.Currency))
          End With
          $BillingReport.Add(asx)
          asx.Clear()
          i = i + 1
        Next 'ends res

        xdisc = xdisc + adisc
        xtax = xtax + atax
        xcrdt = xcrdt + acrdt
        xcash = xcash + acash
        With asx
          .Add("")
          .Add(modString.HTMLBlankSpace(5) & "SUBTOTAL")
          .Add("")
          .Add("")
          .Add(modReportVar.GetLocaleNumberFormat(adisc, gb.Currency))
          .Add(modReportVar.GetLocaleNumberFormat(atax, gb.Currency))
          .Add(modReportVar.GetLocaleNumberFormat(acrdt, gb.Currency))
          .Add(modReportVar.GetLocaleNumberFormat(acash, gb.Currency))
        End With
        $BillingReport.Add(asx)
        asx.Clear()
      Endif
    Next
    With asx
      .Add("")
      .Add("")
      .Add("")
      .Add("")
      .Add("")
      .Add("")
      .Add("")
      .Add("")
    End With
    $BillingReport.Add(asx)
    asx.Clear()

    With asx
      .Add("")
      .Add("TOTAL " & UCase(xmode) & " EXPENSES")
      .Add("...")
      .Add("...")
      .Add(modReportVar.GetLocaleNumberFormat(xdisc, gb.Currency))
      .Add(modReportVar.GetLocaleNumberFormat(xtax, gb.Currency))
      .Add(modReportVar.GetLocaleNumberFormat(xcrdt, gb.Currency))
      .Add(modReportVar.GetLocaleNumberFormat(xcash, gb.Currency))
    End With
    $BillingReport.Add(asx)
    asx.Clear()

    $BillingReport.AddChapter(UCase(xmode) & " PAYMENTS")
    If xmode = "Cash" Then
      With asx
        .Add("")
        .Add("DEPOSITS")
        .Add("")
        .Add("")
        .Add("")
        .Add("")
        .Add("")
        .Add(modReportVar.GetLocaleNumberFormat(xdeposit, gb.Currency))
      End With
      $BillingReport.Add(asx)
      asx.Clear()
    Endif

    ''for admitted/complete
    If sType = "Admitted" And If xdoa Then
    Else
      If xmode = "Cash" Then
        With asx
          .Add("")
          .Add("CASH PAYMENTS")
          .Add("")
          .Add("")
          .Add("")
          .Add("")
          .Add("")
          .Add(modReportVar.GetLocaleNumberFormat(xcashtot, gb.Currency))
        End With
        $BillingReport.Add(asx)
        asx.Clear()
      Else If xmode = "Credit" Then
        With asx
          .Add("")
          .Add("CREDIT CLEARED")
          .Add("")
          .Add("")
          .Add("")
          .Add("")
          .Add("")
          .Add(modReportVar.GetLocaleNumberFormat(xdueclr, gb.Currency))
        End With
        $BillingReport.Add(asx)
        asx.Clear()
      Endif
    Endif

    With asx
      .Add("...")
      .Add("...")
      .Add("...")
      .Add("...")
      .Add("...")
      .Add("...")
      .Add("...")
      .Add("...")
    End With
    $BillingReport.Add(asx)
    asx.Clear()
  Next

  $BillingReport.AddChapter("SUMMARY")
  If sType = "Admitted" And If xdoa Then
  Else
    ''grand summary
    With asx
      .Add("")
      .Add("TOTAL PAYMENTS")
      .Add("")
      .Add("")
      .Add("")
      .Add("")
      .Add("")
      .Add(modReportVar.GetLocaleNumberFormat(xdeposit + xinvpay, gb.Currency))
    End With
    $BillingReport.Add(asx)
    asx.Clear()
  Endif

  xfin = xdeposit + xinvpay
  Return xfin

End

Public Function GetPendingExpensebyPatient($BillingReport As CReportHTML, $con As Connection, encid As String, sType As String, xmodeList As String[]) As Float

  Dim res As Result
  Dim asx As New String[0]
  Dim i As Integer
  Dim rte As Float
  Dim qty As Float
  Dim disc As Float
  Dim xtax As Float
  Dim crdtamt As Float
  Dim cashamt As Float
  Dim xfin As Float

  Dim scateg As String
  Dim scrdttot As Float
  Dim scashtot As Float
  Dim categList As String[]
  Dim xmode As String
  Dim xdoa As Date

  ''extra espenses
  Dim crdttot As Float
  Dim cashtot As Float
  Dim res1 As Result
  Dim res2 As Result

  Dim beditem As String
  Dim unitrate As String
  Dim xhr As Float
  Dim xrate As Float
  Dim xdscamt As Float
  Dim xtaxamt As Float
  Dim xnetamt As Float
  Dim xCshCrd As Float
  Dim xcredt As Float
  Dim xcash As Float

  Dim rex1 As Result
  Dim rex2 As Result
  Dim xTotal As Integer
  Dim dtend As Date
  Dim sBillingMode As String

  xfin = 0
  xdoa = modPatient.GetAdmissionDate(encid)
  i = 1
  crdttot = 0
  cashtot = 0
  $BillingReport.AddSection("ESTIMATED CHARGES", True)
  If xdoa Then
    $BillingReport.AddChapter("ESTIMATED BED CHARGES")
    res1 = $con.Exec("select fldid,flditem,fldbillitem,flddisctype,fldfirsttime,fldfirstreport from tblpattiming where fldencounterval=&1 and fldtype=&2 and fldfirstsave=&3 and fldsecondsave=&4 and fldfirstreport=&5", encid, "General Services", True, False, "Bed")
    If res1.Available Then
      res1.MoveFirst
      unitrate = ""
      xhr = 0
      xrate = 0
      xdscamt = 0
      xtaxamt = 0
      xnetamt = 0
      xCshCrd = 0
      xcredt = 0
      xcash = 0

      beditem = res1["fldbillitem"]
      If Not beditem Then
        beditem = modNonMedical.GetIPDepartChargeRate(res1["flditem"], res1["flddisctype"])
      Endif
      If beditem Then
        rex1 = modDatabase.$myConn.Exec("select fldmode,fldbillingmode,fldacledger,fldbilltype,fldreference,fldlimit,fldlockstate from tbldiscount where fldtype=&1", res1["flddisctype"])
        If rex1.Available Then
          unitrate = modNonMedical.GetBillingTargeDept(beditem, "General Services")
          If modBasic.$AutoBedChargeMode = "Daily" Then ''done before update
            xTotal = modBillings.GetSavedBedChargesTotal(encid)
            dtend = modDate.StartSqlDate(DateAdd(Now(), gb.Day, 1))
          Else
            xTotal = 0
            dtend = Now()
          Endif
          xhr = modPatPatho.GetWardBedUseDuration(encid, res1["flditem"], unitrate, res1["fldfirsttime"], dtend, xTotal)
          xrate = modNonMedical.GetCashBillItemCost(beditem, "General Services")
          xdscamt = modNonMedical.DiscPercentForCategoryValue(encid, res1["flddisctype"], "General Services", beditem, modNonMedical.GetDiscBindBillMode(res1["flddisctype"]))
          xtaxamt = modNonMedical.ShowTaxValues("General Services", beditem)
          If rex1["fldbillingmode"] Then
            sBillingMode = rex1["fldbillingmode"]
          Else
            sBillingMode = modPatient.GetPatBillingMode(encid)
          Endif
          xnetamt = (xrate * xhr) * (1 - xdscamt / 100) * (1 + xtaxamt / 100)
          xCshCrd = modNonMedical.CashInCreditPerForCategory(res1["flddisctype"], "General Services", beditem, sBillingMode)
          If rex1["fldbilltype"] = "Credit" Then
            xcredt = xnetamt - ((xCshCrd / 100) * xnetamt)
            xcash = (xCshCrd / 100) * xnetamt
          Else
            xcredt = 0
            xcash = xnetamt
          Endif
        Endif

        crdttot = crdttot + xcredt
        cashtot = cashtot + xcash
        With asx
          .Add(CStr(i))
          .Add(beditem)
          .Add(modReportVar.GetLocaleNumberFormat(xrate, gb.Currency))
          .Add(modReportVar.GetLocaleNumberFormat(xhr, -2))
          .Add(modReportVar.GetLocaleNumberFormat(xdscamt, -2))
          .Add(modReportVar.GetLocaleNumberFormat(xtaxamt, -2))
          .Add(modReportVar.GetLocaleNumberFormat(xcredt, gb.Currency))
          .Add(modReportVar.GetLocaleNumberFormat(xcash, gb.Currency))
        End With
        $BillingReport.Add(asx)
        asx.Clear()
        i = i + 1
      Endif
    Endif
  Endif

  res2 = $con.Exec("select fldid,flditem,flddisctype,fldfirsttime from tblpattiming where fldencounterval=&1 and fldtype=&2 and fldfirstsave=&3 and fldsecondsave=&4", encid, "Equipment", True, False)
  If res2.Available Then
    $BillingReport.AddChapter("ESTIMATED EQUIPMENTS CHARGES")
    For Each res2
      unitrate = ""
      xhr = 0
      xrate = 0
      xdscamt = 0
      xtaxamt = 0
      xnetamt = 0
      xCshCrd = 0
      xcredt = 0
      xcash = 0

      rex2 = modDatabase.$myConn.Exec("select fldmode,fldbillingmode,fldacledger,fldbilltype,fldreference,fldlimit,fldlockstate from tbldiscount where fldtype=&1", res2["flddisctype"])
      If rex2.Available Then
        unitrate = modNonMedical.GetBillingTargeDept(res2["flditem"], "Equipment")
        xhr = modPatPatho.GetEquipmentDurationSetting(unitrate, res2["fldfirsttime"], Now(), True)
        xrate = modNonMedical.GetCashBillItemCost(res2["flditem"], "Equipment")
        xdscamt = modNonMedical.DiscPercentForCategoryValue(encid, res2["flddisctype"], "Equipment", res2["flditem"], modNonMedical.GetDiscBindBillMode(res1["flddisctype"]))
        xtaxamt = modNonMedical.ShowTaxValues("Equipment", res2["flditem"])

        If rex2["fldbillingmode"] Then
          sBillingMode = rex2["fldbillingmode"]
        Else
          sBillingMode = modPatient.GetPatBillingMode(encid)
        Endif
        xnetamt = (xrate * xhr) * (1 - xdscamt / 100) * (1 + xtaxamt / 100)
        xCshCrd = modNonMedical.CashInCreditPerForCategory(res2["flddisctype"], "Equipment", res2["flditem"], sBillingMode)
        If rex2["fldbilltype"] = "Credit" Then
          xcredt = xnetamt - ((xCshCrd / 100) * xnetamt)
          xcash = (xCshCrd / 100) * xnetamt
        Else
          xcredt = 0
          xcash = xnetamt
        Endif
      Endif

      crdttot = crdttot + xcredt
      cashtot = cashtot + xcash
      With asx
        .Add(CStr(i))
        .Add(res2["flditem"])
        .Add(modReportVar.GetLocaleNumberFormat(xrate, gb.Currency))
        .Add(modReportVar.GetLocaleNumberFormat(xhr, -2))
        .Add(modReportVar.GetLocaleNumberFormat(xdscamt, -2))
        .Add(modReportVar.GetLocaleNumberFormat(xtaxamt, -2))
        .Add(modReportVar.GetLocaleNumberFormat(xcredt, gb.Currency))
        .Add(modReportVar.GetLocaleNumberFormat(xcash, gb.Currency))
      End With
      $BillingReport.Add(asx)
      asx.Clear()
      i = i + 1
    Next
  Endif

  xfin = xfin + cashtot
  With asx
    .Add("")
    .Add("<b>ESTIMATED TOTAL CHARGES</b>")
    .Add("")
    .Add("")
    .Add("")
    .Add("")
    .Add(modReportVar.GetLocaleNumberFormat(crdttot, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(cashtot, gb.Currency))
  End With
  $BillingReport.Add(asx)
  asx.Clear()
  With asx
    .Add("<br>")
    .Add("<br>")
    .Add("<br>")
    .Add("<br>")
    .Add("<br>")
    .Add("<br>")
    .Add("<br>")
    .Add("<br>")
  End With
  $BillingReport.Add(asx)
  asx.Clear()

  $BillingReport.AddSection("PENDING SALES", True)
  ''saved entries
  For Each xmode In xmodeList

    categList = modControlSub.GetDirectFillresult($con.Exec("select distinct(flddisctype) as col from tblpatbilling where fldencounterval=&1 and fldsave=&2 and fldprint=&3 and fldbilltype=&4 and flditemqty>&5", encid, True, False, xmode, 0))
    For Each scateg In categList
      If sType = "Admitted" Then
        If xdoa Then
          res = $con.Exec("select flditemname,flditemrate,flditemqty,flddiscamt,fldtaxamt,fldditemamt,fldbilltype,flddisctype," & modNonMedical.CashCreditRow() & " from tblpatbilling where fldencounterval=&1 and fldsave=&2 and fldprint=&3 and flddisctype=&4 and fldbilltype=&5 and flditemqty>&6 and fldtime>=&7", encid, True, False, scateg, xmode, 0, xdoa)
        Endif
      Else
        res = $con.Exec("select flditemname,flditemrate,flditemqty,flddiscamt,fldtaxamt,fldditemamt,fldbilltype,flddisctype," & modNonMedical.CashCreditRow() & " from tblpatbilling where fldencounterval=&1 and fldsave=&2 and fldprint=&3 and flddisctype=&4 and fldbilltype=&5 and flditemqty>&6", encid, True, False, scateg, xmode, 0)
      Endif
      If res And If res.Available Then
        $BillingReport.AddChapter("SCHEME : " & scateg)

        i = 1
        scrdttot = 0
        scashtot = 0
        For Each res
          rte = 0
          disc = 0
          xtax = 0
          qty = 0
          crdtamt = 0
          cashamt = 0
          If res["flditemrate"] Then
            rte = res["flditemrate"]
          Endif
          If res["flditemqty"] Then
            qty = res["flditemqty"]
          Endif
          If res["fldtaxamt"] Then
            xtax = res["fldtaxamt"]
          Endif
          If res["flddiscamt"] Then
            disc = res["flddiscamt"]
          Endif
          If res["xcredit"] Then
            crdtamt = res["xcredit"]
          Endif
          If res["xcash"] Then
            cashamt = res["xcash"]
          Endif

          scrdttot = scrdttot + crdtamt
          scashtot = scashtot + cashamt
          With asx
            .Add(CStr(i))
            .Add(res["flditemname"])
            .Add(modReportVar.GetLocaleNumberFormat(rte, gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(qty, -2))
            .Add(modReportVar.GetLocaleNumberFormat(disc, gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(xtax, gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(crdtamt, gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(cashamt, gb.Currency))
          End With
          $BillingReport.Add(asx)
          asx.Clear()
          i = i + 1
        Next

        xfin = xfin + scashtot
        With asx
          .Add("")
          .Add("SUBTOTAL")
          .Add("")
          .Add("")
          .Add("")
          .Add("")
          .Add(modReportVar.GetLocaleNumberFormat(scrdttot, gb.Currency))
          .Add(modReportVar.GetLocaleNumberFormat(scashtot, gb.Currency))
        End With
        $BillingReport.Add(asx)
        asx.Clear()
        With asx
          .Add("<br>")
          .Add("<br>")
          .Add("<br>")
          .Add("<br>")
          .Add("<br>")
          .Add("<br>")
          .Add("<br>")
          .Add("<br>")
        End With
        $BillingReport.Add(asx)
        asx.Clear()

      Endif
    Next   ''end category

  Next

  $BillingReport.AddSection("PENDING RETURNS", True)
  ''saved entries
  For Each xmode In xmodeList

    categList = modControlSub.GetDirectFillresult($con.Exec("select distinct(flddisctype) as col from tblpatbilling where fldencounterval=&1 and fldsave=&2 and fldprint=&3 and fldbilltype=&4 and flditemqty<&5", encid, True, False, xmode, 0))
    For Each scateg In categList
      If sType = "Admitted" Then
        If xdoa Then
          res = $con.Exec("select flditemname,flditemrate,flditemqty,flddiscamt,fldtaxamt,fldditemamt,fldbilltype,flddisctype," & modNonMedical.CashCreditRow() & " from tblpatbilling where fldencounterval=&1 and fldsave=&2 and fldprint=&3 and flddisctype=&4 and fldbilltype=&5 and flditemqty<&6 and fldtime>=&7", encid, True, False, scateg, xmode, 0, xdoa)
        Endif
      Else
        res = $con.Exec("select flditemname,flditemrate,flditemqty,flddiscamt,fldtaxamt,fldditemamt,fldbilltype,flddisctype," & modNonMedical.CashCreditRow() & " from tblpatbilling where fldencounterval=&1 and fldsave=&2 and fldprint=&3 and flddisctype=&4 and fldbilltype=&5 and flditemqty<&6", encid, True, False, scateg, xmode, 0)
      Endif
      If res And If res.Available Then
        $BillingReport.AddChapter("SCHEME : " & scateg)

        i = 1
        scrdttot = 0
        scashtot = 0
        For Each res
          rte = 0
          disc = 0
          xtax = 0
          qty = 0
          crdtamt = 0
          cashamt = 0
          If res["flditemrate"] Then
            rte = res["flditemrate"]
          Endif
          If res["flditemqty"] Then
            qty = res["flditemqty"]
          Endif
          If res["fldtaxamt"] Then
            xtax = res["fldtaxamt"]
          Endif
          If res["flddiscamt"] Then
            disc = res["flddiscamt"]
          Endif
          If res["xcredit"] Then
            crdtamt = res["xcredit"]
          Endif
          If res["xcash"] Then
            cashamt = res["xcash"]
          Endif

          scrdttot = scrdttot + crdtamt
          scashtot = scashtot + cashamt
          With asx
            .Add(CStr(i))
            .Add(res["flditemname"])
            .Add(modReportVar.GetLocaleNumberFormat(rte, gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(qty, -2))
            .Add(modReportVar.GetLocaleNumberFormat(disc, gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(xtax, gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(crdtamt, gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(cashamt, gb.Currency))
          End With
          $BillingReport.Add(asx)
          asx.Clear()
          i = i + 1
        Next

        xfin = xfin + scashtot
        With asx
          .Add("")
          .Add("SUBTOTAL")
          .Add("")
          .Add("")
          .Add("")
          .Add("")
          .Add(modReportVar.GetLocaleNumberFormat(scrdttot, gb.Currency))
          .Add(modReportVar.GetLocaleNumberFormat(scashtot, gb.Currency))
        End With
        $BillingReport.Add(asx)
        asx.Clear()
        With asx
          .Add("<br>")
          .Add("<br>")
          .Add("<br>")
          .Add("<br>")
          .Add("<br>")
          .Add("<br>")
          .Add("<br>")
          .Add("<br>")
        End With
        $BillingReport.Add(asx)
        asx.Clear()

      Endif
    Next   ''end category

  Next

  $BillingReport.AddSection("SUMMARY", True)
  With asx
    .Add("")
    .Add("<b>SALES RECEIVEABLE AMT</b>")
    .Add("")
    .Add("")
    .Add("")
    .Add("")
    .Add("")
    .Add(modReportVar.GetLocaleNumberFormat(xfin, gb.Currency))
  End With
  $BillingReport.Add(asx)
  asx.Clear()

  Return xfin

End
