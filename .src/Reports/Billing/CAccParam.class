' Gambas class file

Private $sTable As String
Private $LockType As String
Private $BillVariable As String

Private $xvarsql As String
Private $FootComment As String

Private $UserGrp As String
Private $CompGrp As String
Private $CompLst As String[]

Public Sub _new(Optional sLockType As String, Optional sBillVariable As String, Optional sTable As String)

  If sLockType Then
    $LockType = sLockType
    $BillVariable = sBillVariable
  Endif
  $sTable = sTable
  LockParameter()

End

Private Sub LockParameter()

  Dim aList As String[]
  Dim compLst As String[]
  Dim i As Integer

  Select modHelpVariable.$LogInCategory
    Case "Cashier", "Dispensar"
      If modBasic.$ViewLockInvoice = "User" Then
        If $sTable Then
          $xvarsql = db.Subst(" and " & $sTable & ".flduserid like &1", modBasic.$lbluser)
        Else
          $xvarsql = db.Subst(" and flduserid like &1", modBasic.$lbluser)
        Endif
        $FootComment = modBasic.$lbluser
        $UserGrp = modBasic.$lbluser
        $CompGrp = "%"
      Else If modBasic.$ViewLockInvoice = "Branch" Then
        compLst = modBasic.$branchList.Copy()
        For i = 0 To compLst.Count - 1
          compLst[i] = "'" & compLst[i] & "'"
        Next
        If $sTable Then
          $xvarsql = " and " & $sTable & ".fldcomp in(" & compLst.Join(",") & ")"
        Else
          $xvarsql = " and fldcomp in(" & compLst.Join(",") & ")"
        Endif
        $FootComment = modBasic.$branch
        $UserGrp = "%"
        $CompLst = modBasic.$branchList.Copy()
      Else If modBasic.$ViewLockInvoice = "Location" Then
        If $sTable Then
          $xvarsql = db.Subst(" and " & $sTable & ".fldcomp like &1", modBasic.$compID)
        Else
          $xvarsql = db.Subst(" and fldcomp like &1", modBasic.$compID)
        Endif
        $FootComment = modBasic.$compID
        $UserGrp = "%"
        $CompGrp = modBasic.$compID
      Else
        $xvarsql = ""
        $FootComment = ""
        $UserGrp = "%"
        $CompGrp = "%"
      Endif

    Case Else  ''for account
      If $LockType = "User" Then
        If $sTable Then
          $xvarsql = db.Subst(" and " & $sTable & ".flduserid like &1", $BillVariable)
        Else
          $xvarsql = db.Subst(" and flduserid like &1", $BillVariable)
        Endif
        $FootComment = $BillVariable
        $UserGrp = $BillVariable
        $CompGrp = "%"
      Else If $LockType = "Branch" Then
        aList = modControlSub.GetDirectFillresultNoNull(modDatabase.$myConn.Exec("select fldcompid as col from tblhospbranch where fldbranch=&1", $BillVariable))
        compLst = aList.Copy()
        For i = 0 To compLst.Count - 1
          compLst[i] = "'" & compLst[i] & "'"
        Next
        If $sTable Then
          $xvarsql = " and " & $sTable & ".fldcomp in(" & compLst.Join(",") & ")"
        Else
          $xvarsql = " and fldcomp in(" & compLst.Join(",") & ")"
        Endif
        $FootComment = $BillVariable
        $UserGrp = "%"
        $CompLst = aList.Copy()
      Else If $LockType = "Location" Then
        If $sTable Then
          $xvarsql = db.Subst(" and " & $sTable & ".fldcomp like &1", $BillVariable)
        Else
          $xvarsql = db.Subst(" and fldcomp like &1", $BillVariable)
        Endif
        $FootComment = $BillVariable
        $UserGrp = "%"
        $CompGrp = $BillVariable
      Else
        $xvarsql = ""
        $FootComment = ""
        $UserGrp = "%"
        $CompGrp = "%"
      Endif
  End Select

End

Public Function GetExtraSQL() As String

  Return $xvarsql

End

Public Function GetFooterText() As String

  Return $FootComment

End

Public Function GetUserID() As String

  Return $UserGrp

End

Public Function GetCompID() As String

  Return $CompGrp

End

Public Function GetCompList() As String[]

  Return $CompLst

End
