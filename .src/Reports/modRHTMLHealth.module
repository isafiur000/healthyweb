' Gambas module file

' Private $ProgressBar1 As ProgressBar

''--------------------------- ICD diseases and allergy ------------------------
Public Function ShowDiseaseHealthReport($con As Connection, sType As String, dtfir As Date, dtlas As Date, sCount As String, sLocaType As String, sLocation As String, Optional sItem As String) As String

  Dim $BillingReport As CReportHTML
  Dim asx As New String[0]
  Dim res As Result
  Dim res1 As Result
  Dim res11 As Result
  Dim itmList As String[]
  Dim aitem As String
  Dim i As Integer

  Dim xx As String
  Dim grplist As String[]
  Dim sHead As String[]
  Dim agegrp As String[]
  Dim scol As String[]

  Dim dt As Date
  Dim dtlst As Date[]
  Dim aa As Integer
  Dim bb As Integer
  Dim xdtstr As String
  Dim RepoStr As String

  ' If MMain.$IsGUIApp = True Then
  '   $ProgressBar1 = modAppSupport.FindWorkProgressBar(modHelpVariable.$LogInCategory)
  '   $ProgressBar1.Tag = "Const"
  ' Endif

  agegrp = New String[]
  grplist = modMedReports.AgeGroupList()
  agegrp.Add("DATE")
  agegrp.Add("WEEKDAY")
  For Each xx In grplist
    sHead = Split(xx, ";")
    agegrp.Add(sHead[0] & "<br>[" & sHead[1] & "]")
  Next
  agegrp.Add("TOTAL")
  xdtstr = modMedReports.GetAgeStringByTable("tblpatfindings", $con)

  $BillingReport = New CReportHTML(agegrp, "", "")
  $BillingReport.UserData.Add("COUNT TYPE: " & sCount, "PARAM1")
  $BillingReport.UserData.Add(modReportVar.GetDateTimeReport(dtfir, gb.MediumDate) & " TO " & modReportVar.GetDateTimeReport(dtlas, gb.MediumDate), "PARAM2")                                 ''

  RepoStr = modDataRepo.GetWhereStringRepo(sLocaType, sLocation)
  dtlst = modDate.GetDateArrayBetween(dtfir, dtlas)
  If sItem Then
    itmList = New String[]
    If sType = "Allergic Drugs" Then
      itmList = New String[]
      itmList.Add(sItem)
    Else
      itmList.Add(modPathology.GetNewDiagnosisValue(sItem))
    Endif
  Else
    If sType = "Allergic Drugs" Then
      res = $con.Exec("select distinct(fldcode) as col from tblpatfindings where fldtime>=&1 and fldtime<=&2 and fldtype=&3 and fldsave=&4" & RepoStr, modDate.StartSqlDate(dtfir), modDate.EndSqlDate(dtlas), sType, True)
    Else
      res = $con.Exec("select distinct(fldcodenew) as col from tblpatfindings where fldtime>=&1 and fldtime<=&2 and fldtype=&3 and fldsave=&4" & RepoStr, modDate.StartSqlDate(dtfir), modDate.EndSqlDate(dtlas), sType, True)
    Endif
    itmList = modControlSub.GetDirectFillresult(res)
    If itmList Then
      itmList.Sort()
    Endif
  Endif

  RepoStr = modDataRepo.GetWhereStringRepo(sLocaType, sLocation, "tblpatfindings")
  i = 1
  For Each aitem In itmList
    If sType = "Allergic Drugs" Then
      $BillingReport.AddSection(aitem, True)
    Else
      $BillingReport.AddSection("[" & aitem & "] " & modPathology.GetNewDiagnoCodeValue(aitem), True)
    Endif

    ''for each date
    For Each dt In dtlst
      With asx
        .Add(modReportVar.GetDateTimeReport(dt, gb.MediumDate))
        .Add(modDate.GetWeekDay(dt))

        bb = 0
        For Each xx In grplist
          scol = Split(xx, ";")
          aa = 0
          If sCount = "Encounter" Then
            If sType = "Allergic Drugs" Then
              res1 = $con.Exec("select distinct(tblpatfindings.fldencounterval) as col from (tblpatfindings inner join tblencounter on tblpatfindings.fldencounterval=tblencounter.fldencounterval) inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblpatfindings.fldtime>=&1 and tblpatfindings.fldtime<=&2 and tblpatfindings.fldtype=&3 and tblpatfindings.fldcode like &4 and tblpatientinfo.fldptsex like &5 and " & xdtstr & ">=&6 and " & xdtstr & "<&7 and tblpatfindings.fldsave=&8" & RepoStr, modDate.StartSqlDate(dt), modDate.EndSqlDate(dt), sType, aitem, scol[1], CInt(scol[2]), CInt(scol[3]), True)
            Else
              res1 = $con.Exec("select distinct(tblpatfindings.fldencounterval) as col from (tblpatfindings inner join tblencounter on tblpatfindings.fldencounterval=tblencounter.fldencounterval) inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblpatfindings.fldtime>=&1 and tblpatfindings.fldtime<=&2 and tblpatfindings.fldtype=&3 and tblpatfindings.fldcodenew like &4 and tblpatientinfo.fldptsex like &5 and " & xdtstr & ">=&6 and " & xdtstr & "<&7 and tblpatfindings.fldsave=&8" & RepoStr, modDate.StartSqlDate(dt), modDate.EndSqlDate(dt), sType, aitem, scol[1], CInt(scol[2]), CInt(scol[3]), True)
            Endif
            If res1.Available Then
              aa = res1.Count
            Endif
          Else If sCount = "Item" Then
            If sType = "Allergic Drugs" Then
              res1 = $con.Exec("select COUNT(tblpatfindings.fldid) as col from (tblpatfindings inner join tblencounter on tblpatfindings.fldencounterval=tblencounter.fldencounterval) inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblpatfindings.fldtime>=&1 and tblpatfindings.fldtime<=&2 and tblpatfindings.fldtype=&3 and tblpatfindings.fldcode like &4 and tblpatientinfo.fldptsex like &5 and " & xdtstr & ">=&6 and " & xdtstr & "<&7 and tblpatfindings.fldsave=&8" & RepoStr, modDate.StartSqlDate(dt), modDate.EndSqlDate(dt), sType, aitem, scol[1], CInt(scol[2]), CInt(scol[3]), True)
            Else
              res1 = $con.Exec("select COUNT(tblpatfindings.fldid) as col from (tblpatfindings inner join tblencounter on tblpatfindings.fldencounterval=tblencounter.fldencounterval) inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblpatfindings.fldtime>=&1 and tblpatfindings.fldtime<=&2 and tblpatfindings.fldtype=&3 and tblpatfindings.fldcodenew like &4 and tblpatientinfo.fldptsex like &5 and " & xdtstr & ">=&6 and " & xdtstr & "<&7 and tblpatfindings.fldsave=&8" & RepoStr, modDate.StartSqlDate(dt), modDate.EndSqlDate(dt), sType, aitem, scol[1], CInt(scol[2]), CInt(scol[3]), True)
            Endif
            If res1["col"] Then
              aa = res1["col"]
            Endif
          Endif
          .Add(aa)
          If scol[1] = "Male" Or If scol[1] = "Female" Then
            bb = bb + aa
          Endif
        Next 'for each age group
        .Add(bb)  'for sum total of a row

      End With
      $BillingReport.Add(asx)
      asx.Clear()
    Next  ''for each date

    ''for all date
    With asx
      .Add("****")
      .Add("****")

      bb = 0
      For Each xx In grplist
        scol = Split(xx, ";")
        aa = 0
        If sCount = "Encounter" Then
          If sType = "Allergic Drugs" Then
            res11 = $con.Exec("select distinct(tblpatfindings.fldencounterval) as col from (tblpatfindings inner join tblencounter on tblpatfindings.fldencounterval=tblencounter.fldencounterval) inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblpatfindings.fldtime>=&1 and tblpatfindings.fldtime<=&2 and tblpatfindings.fldtype=&3 and tblpatfindings.fldcode like &4 and tblpatientinfo.fldptsex like &5 and " & xdtstr & ">=&6 and " & xdtstr & "<&7 and tblpatfindings.fldsave=&8" & RepoStr, modDate.StartSqlDate(dtfir), modDate.EndSqlDate(dtlas), sType, aitem, scol[1], CInt(scol[2]), CInt(scol[3]), True)
          Else
            res11 = $con.Exec("select distinct(tblpatfindings.fldencounterval) as col from (tblpatfindings inner join tblencounter on tblpatfindings.fldencounterval=tblencounter.fldencounterval) inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblpatfindings.fldtime>=&1 and tblpatfindings.fldtime<=&2 and tblpatfindings.fldtype=&3 and tblpatfindings.fldcodenew like &4 and tblpatientinfo.fldptsex like &5 and " & xdtstr & ">=&6 and " & xdtstr & "<&7 and tblpatfindings.fldsave=&8" & RepoStr, modDate.StartSqlDate(dtfir), modDate.EndSqlDate(dtlas), sType, aitem, scol[1], CInt(scol[2]), CInt(scol[3]), True)
          Endif
          If res11.Available Then
            aa = res11.Count
          Endif
        Else If sCount = "Item" Then
          If sType = "Allergic Drugs" Then
            res11 = $con.Exec("select COUNT(tblpatfindings.fldid) as col from (tblpatfindings inner join tblencounter on tblpatfindings.fldencounterval=tblencounter.fldencounterval) inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblpatfindings.fldtime>=&1 and tblpatfindings.fldtime<=&2 and tblpatfindings.fldtype=&3 and tblpatfindings.fldcode like &4 and tblpatientinfo.fldptsex like &5 and " & xdtstr & ">=&6 and " & xdtstr & "<&7 and tblpatfindings.fldsave=&8" & RepoStr, modDate.StartSqlDate(dtfir), modDate.EndSqlDate(dtlas), sType, aitem, scol[1], CInt(scol[2]), CInt(scol[3]), True)
          Else
            res11 = $con.Exec("select COUNT(tblpatfindings.fldid) as col from (tblpatfindings inner join tblencounter on tblpatfindings.fldencounterval=tblencounter.fldencounterval) inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblpatfindings.fldtime>=&1 and tblpatfindings.fldtime<=&2 and tblpatfindings.fldtype=&3 and tblpatfindings.fldcodenew like &4 and tblpatientinfo.fldptsex like &5 and " & xdtstr & ">=&6 and " & xdtstr & "<&7 and tblpatfindings.fldsave=&8" & RepoStr, modDate.StartSqlDate(dtfir), modDate.EndSqlDate(dtlas), sType, aitem, scol[1], CInt(scol[2]), CInt(scol[3]), True)
          Endif
          If res11["col"] Then
            aa = res11["col"]
          Endif
        Endif
        .Add(aa)
        If scol[1] = "Male" Or If scol[1] = "Female" Then
          bb = bb + aa
        Endif
      Next 'for each age group
      .Add(bb)  'for sum total of a row

    End With
    $BillingReport.Add(asx)
    asx.Clear()

    ' If MMain.$IsGUIApp = True Then
    '   $ProgressBar1.Value = i / itmList.Count
    '   Wait
    ' Endif
    i = i + 1
  Next  ''for each status

  Return $BillingReport.NewHTMLPath()

End

''----------------------------------------- diagnostic tests --------------------------------------
Public Function ShowDiagnosisHealthReport($con As Connection, dtfir As Date, dtlas As Date, sCount As String, sLocaType As String, sLocation As String, Optional sItem As String) As String

  Dim $BillingReport As CReportHTML
  Dim asx As New String[0]
  Dim res As Result
  Dim res1 As Result
  Dim res11 As Result
  Dim itmList As String[]
  Dim aitem As String
  Dim i As Integer

  Dim xx As String
  Dim grplist As String[]
  Dim sHead As String[]
  Dim agegrp As String[]
  Dim scol As String[]

  Dim dt As Date
  Dim dtlst As Date[]
  Dim aa As Integer
  Dim bb As Integer
  Dim xdtstr As String
  Dim RepoStr As String

  ' If MMain.$IsGUIApp = True Then
  '   $ProgressBar1 = modAppSupport.FindWorkProgressBar(modHelpVariable.$LogInCategory)
  '   $ProgressBar1.Tag = "Const"
  ' Endif

  agegrp = New String[]
  grplist = modMedReports.AgeGroupList()
  agegrp.Add("DATE")
  agegrp.Add("WEEKDAY")
  For Each xx In grplist
    sHead = Split(xx, ";")
    agegrp.Add(sHead[0] & "<br>[" & sHead[1] & "]")
  Next
  agegrp.Add("TOTAL")
  xdtstr = modMedReports.GetAgeStringByTable("tblpatlabtest", $con)

  $BillingReport = New CReportHTML(agegrp, "", "")
  $BillingReport.UserData.Add("COUNT TYPE: " & sCount, "PARAM1")
  $BillingReport.UserData.Add(modReportVar.GetDateTimeReport(dtfir, gb.MediumDate) & " TO " & modReportVar.GetDateTimeReport(dtlas, gb.MediumDate), "PARAM2")                                 ''

  RepoStr = modDataRepo.GetWhereStringRepo(sLocaType, sLocation)
  dtlst = modDate.GetDateArrayBetween(dtfir, dtlas)
  If sItem Then
    itmList = New String[]
    itmList.Add(sItem)
  Else
    res = $con.Exec("select distinct(fldtestid) as col from tblpatlabtest where fldtime_sample>=&1 and fldtime_sample<=&2 and (fldstatus=&3 or fldstatus=&4)" & RepoStr, modDate.StartSqlDate(dtfir), modDate.EndSqlDate(dtlas), "Reported", "Verified")
    itmList = modControlSub.GetDirectFillresult(res)
    If itmList Then
      itmList.Sort()
    Endif
  Endif

  RepoStr = modDataRepo.GetWhereStringRepo(sLocaType, sLocation, "tblpatlabtest")
  i = 1
  For Each aitem In itmList
    $BillingReport.AddSection(aitem, True)

    ''for individual date
    For Each dt In dtlst
      With asx
        .Add(modReportVar.GetDateTimeReport(dt, gb.MediumDate))
        .Add(modDate.GetWeekDay(dt))

        bb = 0
        For Each xx In grplist
          scol = Split(xx, ";")
          aa = 0
          If sCount = "Encounter" Then
            res1 = $con.Exec("select distinct(tblpatlabtest.fldencounterval) as col from (tblpatlabtest inner join tblencounter on tblpatlabtest.fldencounterval=tblencounter.fldencounterval) inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblpatlabtest.fldtime_sample>=&1 and tblpatlabtest.fldtime_sample<=&2 and (tblpatlabtest.fldstatus=&3 or tblpatlabtest.fldstatus=&4) and tblpatlabtest.fldtestid=&5 and tblpatientinfo.fldptsex like &6 and " & xdtstr & ">=&7 and " & xdtstr & "<&8" & RepoStr, modDate.StartSqlDate(dt), modDate.EndSqlDate(dt), "Reported", "Verified", aitem, scol[1], CInt(scol[2]), CInt(scol[3]))
            If res1.Available Then
              aa = res1.Count
            Endif
          Else If sCount = "Item" Then
            res1 = $con.Exec("select COUNT(tblpatlabtest.fldid) as col from (tblpatlabtest inner join tblencounter on tblpatlabtest.fldencounterval=tblencounter.fldencounterval) inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblpatlabtest.fldtime_sample>=&1 and tblpatlabtest.fldtime_sample<=&2 and (tblpatlabtest.fldstatus=&3 or tblpatlabtest.fldstatus=&4) and tblpatlabtest.fldtestid=&5 and tblpatientinfo.fldptsex like &6 and " & xdtstr & ">=&7 and " & xdtstr & "<&8" & RepoStr, modDate.StartSqlDate(dt), modDate.EndSqlDate(dt), "Reported", "Verified", aitem, scol[1], CInt(scol[2]), CInt(scol[3])) '
            If res1["col"] Then
              aa = res1["col"]
            Endif
          Endif
          .Add(aa)
          If scol[1] = "Male" Or If scol[1] = "Female" Then
            bb = bb + aa
          Endif
        Next 'for each age group
        .Add(bb)  'for sum total of a row

      End With
      $BillingReport.Add(asx)
      asx.Clear()
    Next  ''for each date

    ''for all date total
    With asx
      .Add("****")
      .Add("****")

      bb = 0
      For Each xx In grplist
        scol = Split(xx, ";")
        aa = 0
        If sCount = "Encounter" Then
          res11 = $con.Exec("select distinct(tblpatlabtest.fldencounterval) as col from (tblpatlabtest inner join tblencounter on tblpatlabtest.fldencounterval=tblencounter.fldencounterval) inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblpatlabtest.fldtime_sample>=&1 and tblpatlabtest.fldtime_sample<=&2 and (tblpatlabtest.fldstatus=&3 or tblpatlabtest.fldstatus=&4) and tblpatlabtest.fldtestid=&5 and tblpatientinfo.fldptsex like &6 and " & xdtstr & ">=&7 and " & xdtstr & "<&8" & RepoStr, modDate.StartSqlDate(dtfir), modDate.EndSqlDate(dtlas), "Reported", "Verified", aitem, scol[1], CInt(scol[2]), CInt(scol[3]))
          If res11.Available Then
            aa = res11.Count
          Endif
        Else If sCount = "Item" Then
          res11 = $con.Exec("select COUNT(tblpatlabtest.fldid) as col from (tblpatlabtest inner join tblencounter on tblpatlabtest.fldencounterval=tblencounter.fldencounterval) inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblpatlabtest.fldtime_sample>=&1 and tblpatlabtest.fldtime_sample<=&2 and (tblpatlabtest.fldstatus=&3 or tblpatlabtest.fldstatus=&4) and tblpatlabtest.fldtestid=&5 and tblpatientinfo.fldptsex like &6 and " & xdtstr & ">=&7 and " & xdtstr & "<&8" & RepoStr, modDate.StartSqlDate(dtfir), modDate.EndSqlDate(dtlas), "Reported", "Verified", aitem, scol[1], CInt(scol[2]), CInt(scol[3])) '
          If res11["col"] Then
            aa = res11["col"]
          Endif
        Endif
        .Add(aa)
        If scol[1] = "Male" Or If scol[1] = "Female" Then
          bb = bb + aa
        Endif
      Next 'for each age group
      .Add(bb)  'for sum total of a row

    End With
    $BillingReport.Add(asx)
    asx.Clear()

    ' If MMain.$IsGUIApp = True Then
    '   $ProgressBar1.Value = i / itmList.Count
    '   Wait
    ' Endif
    i = i + 1
  Next  ''for each status

  Return $BillingReport.NewHTMLPath()

End

''------------------------------- examinations --------------------------------------
Public Function ShowExamsHealthReport($con As Connection, dtfir As Date, dtlas As Date, sCount As String, sLocaType As String, sLocation As String, Optional sItem As String) As String

  Dim $BillingReport As CReportHTML
  Dim asx As New String[0]
  Dim res As Result
  Dim res1 As Result
  Dim res11 As Result
  Dim itmList As String[]
  Dim aitem As String
  Dim i As Integer

  Dim xx As String
  Dim grplist As String[]
  Dim sHead As String[]
  Dim agegrp As String[]
  Dim scol As String[]

  Dim dt As Date
  Dim dtlst As Date[]
  Dim aa As Integer
  Dim bb As Integer
  Dim xdtstr As String
  Dim RepoStr As String

  ' If MMain.$IsGUIApp = True Then
  '   $ProgressBar1 = modAppSupport.FindWorkProgressBar(modHelpVariable.$LogInCategory)
  '   $ProgressBar1.Tag = "Const"
  ' Endif

  agegrp = New String[]
  grplist = modMedReports.AgeGroupList()
  agegrp.Add("DATE")
  agegrp.Add("WEEKDAY")
  For Each xx In grplist
    sHead = Split(xx, ";")
    agegrp.Add(sHead[0] & "<br>[" & sHead[1] & "]")
  Next
  agegrp.Add("TOTAL")
  xdtstr = modMedReports.GetAgeStringByTable("tblpatientexam", $con)

  $BillingReport = New CReportHTML(agegrp, "", "")
  $BillingReport.UserData.Add("COUNT TYPE: " & sCount, "PARAM1")
  $BillingReport.UserData.Add(modReportVar.GetDateTimeReport(dtfir, gb.MediumDate) & " TO " & modReportVar.GetDateTimeReport(dtlas, gb.MediumDate), "PARAM2")                                 ''

  RepoStr = modDataRepo.GetWhereStringRepo(sLocaType, sLocation)
  dtlst = modDate.GetDateArrayBetween(dtfir, dtlas)
  If sItem Then
    itmList = New String[]
    itmList.Add(sItem)
  Else
    res = $con.Exec("select distinct(fldhead) as col from tblpatientexam where fldtime>=&1 and fldtime<=&2 and fldsave=&3" & RepoStr, modDate.StartSqlDate(dtfir), modDate.EndSqlDate(dtlas), True)
    itmList = modControlSub.GetDirectFillresult(res)
    If itmList Then
      itmList.Sort()
    Endif
  Endif

  RepoStr = modDataRepo.GetWhereStringRepo(sLocaType, sLocation, "tblpatientexam")
  i = 1
  For Each aitem In itmList
    $BillingReport.AddSection(aitem, True)

    ''for each date
    For Each dt In dtlst
      With asx
        .Add(modReportVar.GetDateTimeReport(dt, gb.MediumDate))
        .Add(modDate.GetWeekDay(dt))

        bb = 0
        For Each xx In grplist
          scol = Split(xx, ";")
          aa = 0
          If sCount = "Encounter" Then
            res1 = $con.Exec("select distinct(tblpatientexam.fldencounterval) as col from (tblpatientexam inner join tblencounter on tblpatientexam.fldencounterval=tblencounter.fldencounterval) inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblpatientexam.fldtime>=&1 and tblpatientexam.fldtime<=&2 and tblpatientexam.fldsave=&3 and tblpatientexam.fldhead=&4 and tblpatientinfo.fldptsex like &5 and " & xdtstr & ">=&6 and " & xdtstr & "<&7" & RepoStr, modDate.StartSqlDate(dt), modDate.EndSqlDate(dt), True, aitem, scol[1], CInt(scol[2]), CInt(scol[3]))
            If res1.Available Then
              aa = res1.Count
            Endif
          Else If sCount = "Item" Then
            res1 = $con.Exec("select count(tblpatientexam.fldid) as col from (tblpatientexam inner join tblencounter on tblpatientexam.fldencounterval=tblencounter.fldencounterval) inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblpatientexam.fldtime>=&1 and tblpatientexam.fldtime<=&2 and tblpatientexam.fldsave=&3 and tblpatientexam.fldhead=&4 and tblpatientinfo.fldptsex like &5 and " & xdtstr & ">=&6 and " & xdtstr & "<&7" & RepoStr, modDate.StartSqlDate(dt), modDate.EndSqlDate(dt), True, aitem, scol[1], CInt(scol[2]), CInt(scol[3]))
            If res1["col"] Then
              aa = res1["col"]
            Endif
          Endif
          .Add(aa)
          If scol[1] = "Male" Or If scol[1] = "Female" Then
            bb = bb + aa
          Endif
        Next 'for each age group
        .Add(bb)  'for sum total of a row

      End With
      $BillingReport.Add(asx)
      asx.Clear()
    Next  ''for each date

    ''for all date total
    With asx
      .Add("****")
      .Add("****")

      bb = 0
      For Each xx In grplist
        scol = Split(xx, ";")
        aa = 0
        If sCount = "Encounter" Then
          res11 = $con.Exec("select distinct(tblpatientexam.fldencounterval) as col from (tblpatientexam inner join tblencounter on tblpatientexam.fldencounterval=tblencounter.fldencounterval) inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblpatientexam.fldtime>=&1 and tblpatientexam.fldtime<=&2 and tblpatientexam.fldsave=&3 and tblpatientexam.fldhead=&4 and tblpatientinfo.fldptsex like &5 and " & xdtstr & ">=&6 and " & xdtstr & "<&7" & RepoStr, modDate.StartSqlDate(dtfir), modDate.EndSqlDate(dtlas), True, aitem, scol[1], CInt(scol[2]), CInt(scol[3]))
          If res11.Available Then
            aa = res11.Count
          Endif
        Else If sCount = "Item" Then
          res11 = $con.Exec("select count(tblpatientexam.fldid) as col from (tblpatientexam inner join tblencounter on tblpatientexam.fldencounterval=tblencounter.fldencounterval) inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblpatientexam.fldtime>=&1 and tblpatientexam.fldtime<=&2 and tblpatientexam.fldsave=&3 and tblpatientexam.fldhead=&4 and tblpatientinfo.fldptsex like &5 and " & xdtstr & ">=&6 and " & xdtstr & "<&7" & RepoStr, modDate.StartSqlDate(dtfir), modDate.EndSqlDate(dtlas), True, aitem, scol[1], CInt(scol[2]), CInt(scol[3]))
          If res11["col"] Then
            aa = res11["col"]
          Endif
        Endif
        .Add(aa)
        If scol[1] = "Male" Or If scol[1] = "Female" Then
          bb = bb + aa
        Endif
      Next 'for each age group
      .Add(bb)  'for sum total of a row

    End With
    $BillingReport.Add(asx)
    asx.Clear()

    ' If MMain.$IsGUIApp = True Then
    '   $ProgressBar1.Value = i / itmList.Count
    '   Wait
    ' Endif
    i = i + 1
  Next  ''for each status

  Return $BillingReport.NewHTMLPath()

End

''---------------------------------- Health Report ---------------------------------------
Private Function QSymbol(sItem As String) As String

  Dim xx As String

  If Not sItem Then
    xx = " IS "
  Else
    xx = " LIKE "
  Endif
  Return xx

End

Private Function TotalVisitSelectedCount(conn As Connection, dt1 As Date, dt2 As Date, sDiscType As String, sComp As String, sVisit As String, sStatus As String, sLocaType As String, sLocation As String) As Integer

  Dim res4 As Result
  Dim coltime As String
  Dim xval As Integer
  Dim xstr As String

  xstr = modDataRepo.GetWhereStringRepo(sLocaType, sLocation)
  If sStatus = "Admission" Then
    coltime = "flddoa"
  Else If sStatus = "Discharge/Other" Then
    coltime = "flddod"
  Else
    coltime = "fldregdate"
  Endif
  res4 = conn.Exec("select COUNT(fldencounterval) as tot from tblencounter where fldvisit like &1 and " & coltime & ">=&2 and " & coltime & "<=&3 and flddisctype like &4 and fldcomp like &5" & xstr, sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sDiscType, sComp)
  If res4!tot Then
    xval = res4!tot
  Else
    xval = 0
  Endif
  Return xval

End

Public Function SummarySelectedEncounter(conn As Connection, dt1 As Date, dt2 As Date, sRow As String, sColumn As String, sDiscType As String, sComp As String, sVisit As String, sStatus As String, sLocaType As String, sLocation As String) As String

  Dim $BillingReport As CReportHTML
  Dim sql1 As String
  Dim asx As New String[0]
  Dim res1 As Result
  Dim xval As String
  Dim yval As String
  Dim xcol As String[]

  Dim res2 As Result
  Dim dtlst As Date[]
  Dim dt As Date
  Dim i As Integer
  Dim xtot As Float
  Dim res3 As Result
  Dim aTot As Integer

  Dim res As Result
  Dim sql As String
  Dim coltime As String
  Dim xdateform As String
  Dim xfirdate As Date
  Dim xlasdate As Date
  Dim chapdate As String
  Dim xstr As String

  xstr = modDataRepo.GetWhereStringRepo(sLocaType, sLocation)
  If sStatus = "Admission" Then
    coltime = "flddoa"
  Else If sStatus = "Discharge/Other" Then
    coltime = "flddod"
  Else
    coltime = "fldregdate"
  Endif

  xval = modMedReports.GetColumnEncounter(sRow)
  yval = modMedReports.GetColumnEncounter(sColumn)
  Select sColumn
    Case "Gender", "Surname", "District", "Municipality", "Service Rank", "Service Unit", "Service Category"
      sql = Subst("select distinct(&1) as fld from tblpatientinfo", yval)
      res = conn.Exec(sql & "  where fldpatientval in(select fldpatientval from tblencounter where fldvisit like &1 and " & coltime & ">=&2 and " & coltime & "<=&3 and flddisctype like &4 and fldcomp like &5) ORDER BY " & yval & " ASC", sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sDiscType, sComp)
    Case "Prov Diagno Group"
      sql = Subst("select distinct(&1) as fld from tbldiagnogroup", yval)
      res = conn.Exec(sql & "  where flditemname in(select fldcode from tblpatfindings where fldtype=&1 and fldsave=&2 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &3 and " & coltime & ">=&4 and " & coltime & "<=&5 and flddisctype like &6 and fldcomp like &7))" & xstr & " ORDER BY " & yval & " ASC", "Provisional Diagnosis", True, sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sDiscType, sComp)
    Case "Final Diagno Group"
      sql = Subst("select distinct(&1) as fld from tbldiagnogroup", yval)
      res = conn.Exec(sql & "  where flditemname in(select fldcode from tblpatfindings where fldtype=&1 and fldsave=&2 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &3 and " & coltime & ">=&4 and " & coltime & "<=&5 and flddisctype like &6 and fldcomp like &7))" & xstr & " ORDER BY " & yval & " ASC", "Final Diagnosis", True, sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sDiscType, sComp)
    Case Else
      sql = Subst("select distinct(&1) as fld from tblencounter", yval)
      res = conn.Exec(sql & " where fldvisit like &1 and " & coltime & ">=&2 and " & coltime & "<=&3 and flddisctype like &4 and fldcomp like &5" & xstr & " ORDER BY " & yval & " ASC", sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sDiscType, sComp)
  End Select
  xcol = New String[]
  If res.Available Then
    xcol.Add(UCase(sRow))
    For Each res
      xcol.Add(res!fld)
    Next
    xcol.Add("TOTAL")
  Endif

  $BillingReport = New CReportHTML(xcol, "", "")
  $BillingReport.UserData.Add("Visit:" & sVisit & " Status:" & sStatus & " Location:" & sComp & " Pack:" & sDiscType & "Date: " & modReportVar.GetDateTimeReport(dt1, gb.MediumDate) & " TO " & modReportVar.GetDateTimeReport(dt2, gb.MediumDate), "PARAM1")
  $BillingReport.UserData.Add("TOTAL COUNT: " & modReportVar.GetLocaleNumberFormat(TotalVisitSelectedCount(conn, dt1, dt2, sDiscType, sComp, sVisit, sStatus, sLocaType, sLocation), 0), "PARAM2")

  If sRow = "Year" Or If sRow = "Month" Or If sRow = "Date" Then
    xdateform = modSettings.ShowSettingFromFIle("HealthReport/RowDateFormat")

    If sRow = "Year" Then
      If modBasic.$DateFormat = "BS Date" Then
        dtlst = modDate.GetSelectDateBSArrayBetween(gb.Year, dt1, dt2)
      Else
        dtlst = modDate.GetSelectDateArrayBetween(gb.Year, dt1, dt2)
      Endif
    Else If sRow = "Month" Then
      If modBasic.$DateFormat = "BS Date" Then
        dtlst = modDate.GetSelectDateBSArrayBetween(gb.Month, dt1, dt2)
      Else
        dtlst = modDate.GetSelectDateArrayBetween(gb.Month, dt1, dt2)
      Endif
    Else
      dtlst = modDate.GetSelectDateArrayBetween(gb.Day, dt1, dt2)
    Endif
    For Each dt In dtlst
      If sRow = "Year" Then
        If modBasic.$DateFormat = "BS Date" Then
          chapdate = modDate.DateFormatViewBS(dt, "YearOnly")
          xfirdate = modDate.StartSqlYearBS(dt)
          xlasdate = modDate.EndSqlYearBS(dt)
        Else
          chapdate = Format(dt, "yyyy")
          xfirdate = modDate.StartSqlYear(dt)
          xlasdate = modDate.EndSqlYear(dt)
        Endif
      Else If sRow = "Month" Then
        If modBasic.$DateFormat = "BS Date" Then
          chapdate = modDate.DateFormatViewBS(dt, "YearMonth")
          xfirdate = modDate.StartSqlMonthBS(dt)
          xlasdate = modDate.EndSqlMonthBS(dt)
        Else
          chapdate = Format(dt, "mmm yyyy")
          xfirdate = modDate.StartSqlMonth(dt)
          xlasdate = modDate.EndSqlMonth(dt)
        Endif
      Else
        If xdateform = "Disable" Then
          chapdate = modReportVar.GetDateTimeReport(dt, gb.MediumDate)
        Else
          chapdate = modReportVar.GetDateTimeReport(dt, gb.MediumDate) & " [" & modDate.GetWeekDay(dt) & "]"
        Endif
        xfirdate = modDate.StartSqlDate(dt)
        xlasdate = modDate.EndSqlDate(dt)
      Endif

      With asx
        .Add(chapdate)
        xtot = 0
        For i = 1 To xcol.Count - 2
          Select sColumn
            Case "Gender", "Surname", "District", "Municipality", "Service Rank", "Service Unit", "Service Category"
              res2 = conn.Exec("select COUNT(fldencounterval) as tot from tblencounter where fldvisit like &1 and " & coltime & ">=&2 and " & coltime & "<=&3 and flddisctype like &4 and fldcomp like &5 and fldpatientval in(select fldpatientval from tblpatientinfo where " & yval & QSymbol(xcol[i]) & "&6)" & xstr, sVisit, xfirdate, xlasdate, sDiscType, sComp, xcol[i])
            Case "Prov Diagno Group"
              res2 = conn.Exec("select COUNT(fldencounterval) as tot from tblencounter where fldvisit like &1 and " & coltime & ">=&2 and " & coltime & "<=&3 and flddisctype like &4 and fldcomp like &5 and fldencounterval in(select fldencounterval from tblpatfindings where fldtype=&6 and fldsave=&7 and fldcode in(select flditemname from tbldiagnogroup where " & yval & QSymbol(xcol[i]) & "&8))" & xstr, sVisit, xfirdate, xlasdate, sDiscType, sComp, "Provisional Diagnosis", True, xcol[i])
            Case "Final Diagno Group"
              res2 = conn.Exec("select COUNT(fldencounterval) as tot from tblencounter where fldvisit like &1 and " & coltime & ">=&2 and " & coltime & "<=&3 and flddisctype like &4 and fldcomp like &5 and fldencounterval in(select fldencounterval from tblpatfindings where fldtype=&6 and fldsave=&7 and fldcode in(select flditemname from tbldiagnogroup where " & yval & QSymbol(xcol[i]) & "&8))" & xstr, sVisit, xfirdate, xlasdate, sDiscType, sComp, "Final Diagnosis", True, xcol[i])
            Case Else
              res2 = conn.Exec("select COUNT(fldencounterval) as tot from tblencounter where fldvisit like &1 and " & coltime & ">=&2 and " & coltime & "<=&3 and flddisctype like &4 and fldcomp like &5 and " & yval & QSymbol(xcol[i]) & "&6" & xstr, sVisit, xfirdate, xlasdate, sDiscType, sComp, xcol[i])
          End Select
          If res2!tot Then
            xtot = xtot + res2!tot
            .Add(modReportVar.GetLocaleNumberFormat(res2!tot, 0))
          Else
            .Add(modReportVar.GetLocaleNumberFormat(0, 0))
          Endif
        Next
        .Add(modReportVar.GetLocaleNumberFormat(xtot, 0))
      End With
      $BillingReport.Add(asx)
      asx.Clear()
    Next

    With asx
      .Add("")
      aTot = 0
      For i = 1 To xcol.Count - 2
        Select sColumn
          Case "Gender", "Surname", "District", "Municipality", "Service Rank", "Service Unit", "Service Category"
            res3 = conn.Exec("select COUNT(fldencounterval) as tot from tblencounter where fldvisit like &1 and " & coltime & ">=&2 and " & coltime & "<=&3 and flddisctype like &4 and fldcomp like &5 and fldpatientval in(select fldpatientval from tblpatientinfo where " & yval & QSymbol(xcol[i]) & "&6)" & xstr, sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sDiscType, sComp, xcol[i])
          Case "Prov Diagno Group"
            res3 = conn.Exec("select COUNT(fldencounterval) as tot from tblencounter where fldvisit like &1 and " & coltime & ">=&2 and " & coltime & "<=&3 and flddisctype like &4 and fldcomp like &5 and fldencounterval in(select fldencounterval from tblpatfindings where fldtype=&6 and fldsave=&7 and fldcode in(select flditemname from tbldiagnogroup where " & yval & QSymbol(xcol[i]) & "&8))" & xstr, sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sDiscType, sComp, "Provisional Diagnosis", True, xcol[i])
          Case "Final Diagno Group"
            res3 = conn.Exec("select COUNT(fldencounterval) as tot from tblencounter where fldvisit like &1 and " & coltime & ">=&2 and " & coltime & "<=&3 and flddisctype like &4 and fldcomp like &5 and fldencounterval in(select fldencounterval from tblpatfindings where fldtype=&6 and fldsave=&7 and fldcode in(select flditemname from tbldiagnogroup where " & yval & QSymbol(xcol[i]) & "&8))" & xstr, sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sDiscType, sComp, "Final Diagnosis", True, xcol[i])
          Case Else
            res3 = conn.Exec("select COUNT(fldencounterval) as tot from tblencounter where fldvisit like &1 and " & coltime & ">=&2 and " & coltime & "<=&3 and flddisctype like &4 and fldcomp like &5 and " & yval & QSymbol(xcol[i]) & "&6" & xstr, sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sDiscType, sComp, xcol[i])
        End Select
        If res3!tot Then
          aTot = aTot + res3!tot
          .Add(modReportVar.GetLocaleNumberFormat(res3!tot, 0))
        Else
          .Add(modReportVar.GetLocaleNumberFormat(0, 0))
        Endif
      Next
      .Add(modReportVar.GetLocaleNumberFormat(aTot, 0))
    End With
    $BillingReport.Add(asx)
    asx.Clear()

  Else

    Select sRow
      Case "Gender", "Surname", "District", "Municipality", "Ethnic Group", "Service Rank", "Service Unit", "Service Category"
        sql1 = Subst("select distinct(&1) as fld from tblpatientinfo", xval)
        res1 = conn.Exec(sql1 & "  where fldpatientval in(select fldpatientval from tblencounter where fldvisit like &1 and " & coltime & ">=&2 and " & coltime & "<=&3 and flddisctype like &4 and fldcomp like &5) ORDER BY " & xval & " ASC", sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sDiscType, sComp)
      Case Else
        sql1 = Subst("select distinct(&1) as fld from tblencounter", xval)
        res1 = conn.Exec(sql1 & " where fldvisit like &1 and " & coltime & ">=&2 and " & coltime & "<=&3 and flddisctype like &4 and fldcomp like &5" & xstr & " ORDER BY " & xval & " ASC", sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sDiscType, sComp)
    End Select
    If res1.Available Then

      For Each res1
        With asx
          .Add(res1!fld)

          xtot = 0
          For i = 1 To xcol.Count - 2
            Select sRow
              Case "Gender", "Surname", "District", "Municipality", "Ethnic Group", "Service Rank", "Service Unit", "Service Category"
                Select sColumn
                  Case "Gender", "Surname", "District", "Municipality", "Service Rank", "Service Unit", "Service Category"
                    res2 = conn.Exec("select COUNT(fldencounterval) as tot from tblencounter where fldvisit like &1 and " & coltime & ">=&2 and " & coltime & "<=&3 and flddisctype like &4 and fldcomp like &5 and fldpatientval in(select fldpatientval from tblpatientinfo where " & xval & QSymbol(res1!fld) & "&6 and " & yval & QSymbol(xcol[i]) & "&7)" & xstr, sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sDiscType, sComp, res1!fld, xcol[i])
                  Case Else
                    res2 = conn.Exec("select COUNT(fldencounterval) as tot from tblencounter where fldvisit like &1 and " & coltime & ">=&2 and " & coltime & "<=&3 and flddisctype like &4 and fldcomp like &5 and fldpatientval in(select fldpatientval from tblpatientinfo where " & xval & QSymbol(res1!fld) & "&6) and " & yval & QSymbol(xcol[i]) & "&7" & xstr, sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sDiscType, sComp, res1!fld, xcol[i])
                End Select
              Case Else
                Select sColumn
                  Case "Gender", "Surname", "District", "Municipality", "Service Rank", "Service Unit", "Service Category"
                    res2 = conn.Exec("select COUNT(fldencounterval) as tot from tblencounter where fldvisit like &1 and " & coltime & ">=&2 and " & coltime & "<=&3 and flddisctype like &4 and fldcomp like &5 and " & xval & QSymbol(res1!fld) & "&6 and fldpatientval in(select fldpatientval from tblpatientinfo where " & yval & QSymbol(xcol[i]) & "&7)" & xstr, sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sDiscType, sComp, res1!fld, xcol[i])
                  Case Else
                    res2 = conn.Exec("select COUNT(fldencounterval) as tot from tblencounter where fldvisit like &1 and " & coltime & ">=&2 and " & coltime & "<=&3 and flddisctype like &4 and fldcomp like &5 and " & xval & QSymbol(res1!fld) & "&6 and " & yval & QSymbol(xcol[i]) & "&7" & xstr, sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sDiscType, sComp, res1!fld, xcol[i])
                End Select
            End Select
            If res2!tot Then
              xtot = xtot + res2!tot
              .Add(modReportVar.GetLocaleNumberFormat(res2!tot, 0))
            Else
              .Add(modReportVar.GetLocaleNumberFormat(0, 0))
            Endif
          Next
          .Add(modReportVar.GetLocaleNumberFormat(xtot, 0))

        End With
        $BillingReport.Add(asx)
        asx.Clear()
      Next

      With asx
        .Add("")

        aTot = 0
        For i = 1 To xcol.Count - 2
          Select sRow
            Case "Gender", "Surname", "District", "Municipality", "Ethnic Group", "Service Rank", "Service Unit", "Service Category"
              Select sColumn
                Case "Gender", "Surname", "District", "Municipality", "Service Rank", "Service Unit", "Service Category"
                  res3 = conn.Exec("select COUNT(fldencounterval) as tot from tblencounter where fldvisit like &1 and " & coltime & ">=&2 and " & coltime & "<=&3 and flddisctype like &4 and fldcomp like &5 and fldpatientval in(select fldpatientval from tblpatientinfo where " & yval & QSymbol(xcol[i]) & "&6)" & xstr, sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sDiscType, sComp, xcol[i])
                Case Else
                  res3 = conn.Exec("select COUNT(fldencounterval) as tot from tblencounter where fldvisit like &1 and " & coltime & ">=&2 and " & coltime & "<=&3 and flddisctype like &4 and fldcomp like &5 and " & yval & QSymbol(xcol[i]) & "&6" & xstr, sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sDiscType, sComp, xcol[i])
              End Select
            Case Else
              Select sColumn
                Case "Gender", "Surname", "District", "Municipality", "Service Rank", "Service Unit", "Service Category"
                  res3 = conn.Exec("select COUNT(fldencounterval) as tot from tblencounter where fldvisit like &1 and " & coltime & ">=&2 and " & coltime & "<=&3 and flddisctype like &4 and fldcomp like &5 and fldpatientval in(select fldpatientval from tblpatientinfo where " & yval & QSymbol(xcol[i]) & "&6)" & xstr, sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sDiscType, sComp, xcol[i])
                Case Else
                  res3 = conn.Exec("select COUNT(fldencounterval) as tot from tblencounter where fldvisit like &1 and " & coltime & ">=&2 and " & coltime & "<=&3 and flddisctype like &4 and fldcomp like &5 and " & yval & QSymbol(xcol[i]) & "&6" & xstr, sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sDiscType, sComp, xcol[i])
              End Select
          End Select
          If res3!tot Then
            aTot = aTot + res3!tot
            .Add(modReportVar.GetLocaleNumberFormat(res3!tot, 0))
          Else
            .Add(modReportVar.GetLocaleNumberFormat(0, 0))
          Endif
        Next
        .Add(modReportVar.GetLocaleNumberFormat(aTot, 0))

      End With
      $BillingReport.Add(asx)
      asx.Clear()

    Endif

  Endif
  Return $BillingReport.NewHTMLPath()

End

Public Function SummarySelectedAgeEncounter(conn As Connection, dt1 As Date, dt2 As Date, sRow As String, sColumn As String, sDiscType As String, sComp As String, sVisit As String, sStatus As String, sLocaType As String, sLocation As String) As String

  Dim $BillingReport As CReportHTML
  Dim sql1 As String
  Dim asx As New String[0]
  Dim agegrp As String[]
  Dim agegendergrp As String[]
  Dim agesql As String
  Dim ageval As String[]
  Dim genval As String[]

  Dim res1 As Result
  Dim xval As String
  Dim xcol As String[]
  Dim res2 As Result
  Dim dtlst As Date[]
  Dim dt As Date
  Dim i As Integer
  Dim xtot As Float
  Dim res3 As Result
  Dim aTot As Integer

  Dim coltime As String
  Dim xdateform As String
  Dim xfirdate As Date
  Dim xlasdate As Date
  Dim chapdate As String
  Dim xstr As String

  xstr = modDataRepo.GetWhereStringRepo(sLocaType, sLocation, "tblencounter")
  If sStatus = "Admission" Then
    coltime = "tblencounter.flddoa"
  Else If sStatus = "Discharge/Other" Then
    coltime = "tblencounter.flddod"
  Else
    coltime = "tblencounter.fldregdate"
  Endif

  xval = modMedReports.GetColumnEncounter(sRow)
  agegrp = modMedReports.AgeGroupNameList()
  agegendergrp = modMedReports.AgeGroupGenderList()
  agesql = modMedReports.GetAgeStringByTable("tblencounter", conn)

  xcol = New String[]
  xcol.Add(UCase(sRow))
  If sColumn = "Age Group" Then
    xcol.Insert(agegrp)
  Else If sColumn = "Age Group (Gender)" Then
    xcol.Insert(agegendergrp)
  Endif
  xcol.Add("TOTAL")

  $BillingReport = New CReportHTML(xcol, "", "")
  $BillingReport.UserData.Add("Visit:" & sVisit & " Status:" & sStatus & " Location:" & sComp & " Pack:" & sDiscType & "Date: " & modReportVar.GetDateTimeReport(dt1, gb.MediumDate) & " TO " & modReportVar.GetDateTimeReport(dt2, gb.MediumDate), "PARAM1")
  $BillingReport.UserData.Add("TOTAL COUNT: " & modReportVar.GetLocaleNumberFormat(TotalVisitSelectedCount(conn, dt1, dt2, sDiscType, sComp, sVisit, sStatus, sLocaType, sLocation), 0), "PARAM2")

  If sRow = "Year" Or If sRow = "Month" Or If sRow = "Date" Then
    xdateform = modSettings.ShowSettingFromFIle("HealthReport/RowDateFormat")

    If sRow = "Year" Then
      If modBasic.$DateFormat = "BS Date" Then
        dtlst = modDate.GetSelectDateBSArrayBetween(gb.Year, dt1, dt2)
      Else
        dtlst = modDate.GetSelectDateArrayBetween(gb.Year, dt1, dt2)
      Endif
    Else If sRow = "Month" Then
      If modBasic.$DateFormat = "BS Date" Then
        dtlst = modDate.GetSelectDateBSArrayBetween(gb.Month, dt1, dt2)
      Else
        dtlst = modDate.GetSelectDateArrayBetween(gb.Month, dt1, dt2)
      Endif
    Else
      dtlst = modDate.GetSelectDateArrayBetween(gb.Day, dt1, dt2)
    Endif
    For Each dt In dtlst
      If sRow = "Year" Then
        If modBasic.$DateFormat = "BS Date" Then
          chapdate = modDate.DateFormatViewBS(dt, "YearOnly")
          xfirdate = modDate.StartSqlYearBS(dt)
          xlasdate = modDate.EndSqlYearBS(dt)
        Else
          chapdate = Format(dt, "yyyy")
          xfirdate = modDate.StartSqlYear(dt)
          xlasdate = modDate.EndSqlYear(dt)
        Endif
      Else If sRow = "Month" Then
        If modBasic.$DateFormat = "BS Date" Then
          chapdate = modDate.DateFormatViewBS(dt, "YearMonth")
          xfirdate = modDate.StartSqlMonthBS(dt)
          xlasdate = modDate.EndSqlMonthBS(dt)
        Else
          chapdate = Format(dt, "mmm yyyy")
          xfirdate = modDate.StartSqlMonth(dt)
          xlasdate = modDate.EndSqlMonth(dt)
        Endif
      Else
        If xdateform = "Disable" Then
          chapdate = modReportVar.GetDateTimeReport(dt, gb.MediumDate)
        Else
          chapdate = modReportVar.GetDateTimeReport(dt, gb.MediumDate) & " [" & modDate.GetWeekDay(dt) & "]"
        Endif
        xfirdate = modDate.StartSqlDate(dt)
        xlasdate = modDate.EndSqlDate(dt)
      Endif

      With asx
        .Add(chapdate)
        xtot = 0

        If sColumn = "Age Group" Then
          For i = 1 To xcol.Count - 2
            ageval = Split(modMedReports.GetAgeValuefromgroup(xcol[i]), ";")
            res2 = conn.Exec("select COUNT(tblencounter.fldencounterval) as tot from tblencounter inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblencounter.fldvisit like &1 and " & coltime & ">=&2 and " & coltime & "<=&3 and tblencounter.flddisctype like &4 and tblencounter.fldcomp like &5 and " & agesql & ">=&6 and " & agesql & "<&7" & xstr, sVisit, xfirdate, xlasdate, sDiscType, sComp, CLong(ageval[0]), CLong(ageval[1]))                                                          ''
            If res2!tot Then
              xtot = xtot + res2!tot
              .Add(modReportVar.GetLocaleNumberFormat(res2!tot, 0))
            Else
              .Add(modReportVar.GetLocaleNumberFormat(0, 0))
            Endif
          Next
        Else If sColumn = "Age Group (Gender)" Then
          For i = 1 To xcol.Count - 2
            genval = Split(xcol[i], ":")
            ageval = Split(modMedReports.GetAgeValuefromgroup(genval[0]), ";")
            res2 = conn.Exec("select COUNT(tblencounter.fldencounterval) as tot from tblencounter inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblencounter.fldvisit like &1 and " & coltime & ">=&2 and " & coltime & "<=&3 and tblencounter.flddisctype like &4 and tblencounter.fldcomp like &5 and " & agesql & ">=&6 and " & agesql & "<&7 and tblpatientinfo.fldptsex=&8" & xstr, sVisit, xfirdate, xlasdate, sDiscType, sComp, CLong(ageval[0]), CLong(ageval[1]), genval[1])                                                          ''
            If res2!tot Then
              xtot = xtot + res2!tot
              .Add(modReportVar.GetLocaleNumberFormat(res2!tot, 0))
            Else
              .Add(modReportVar.GetLocaleNumberFormat(0, 0))
            Endif
          Next
        Endif

        .Add(modReportVar.GetLocaleNumberFormat(xtot, 0))
      End With
      $BillingReport.Add(asx)
      asx.Clear()
    Next

    With asx
      .Add("")
      aTot = 0

      If sColumn = "Age Group" Then
        For i = 1 To xcol.Count - 2
          ageval = Split(modMedReports.GetAgeValuefromgroup(xcol[i]), ";")
          res3 = conn.Exec("select COUNT(tblencounter.fldencounterval) as tot from tblencounter inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblencounter.fldvisit like &1 and " & coltime & ">=&2 and " & coltime & "<=&3 and tblencounter.flddisctype like &4 and tblencounter.fldcomp like &5 and " & agesql & ">=&6 and " & agesql & "<&7" & xstr, sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sDiscType, sComp, CLong(ageval[0]), CLong(ageval[1]))                                                          ''
          If res3!tot Then
            aTot = aTot + res3!tot
            .Add(modReportVar.GetLocaleNumberFormat(res3!tot, 0))
          Else
            .Add(modReportVar.GetLocaleNumberFormat(0, 0))
          Endif
        Next
      Else If sColumn = "Age Group (Gender)" Then
        For i = 1 To xcol.Count - 2
          genval = Split(xcol[i], ":")
          ageval = Split(modMedReports.GetAgeValuefromgroup(genval[0]), ";")
          res3 = conn.Exec("select COUNT(tblencounter.fldencounterval) as tot from tblencounter inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblencounter.fldvisit like &1 and " & coltime & ">=&2 and " & coltime & "<=&3 and tblencounter.flddisctype like &4 and tblencounter.fldcomp like &5 and " & agesql & ">=&6 and " & agesql & "<&7 and tblpatientinfo.fldptsex=&8" & xstr, sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sDiscType, sComp, CLong(ageval[0]), CLong(ageval[1]), genval[1])                                                          ''
          If res3!tot Then
            aTot = aTot + res3!tot
            .Add(modReportVar.GetLocaleNumberFormat(res3!tot, 0))
          Else
            .Add(modReportVar.GetLocaleNumberFormat(0, 0))
          Endif
        Next
      Endif

      .Add(modReportVar.GetLocaleNumberFormat(aTot, 0))
    End With
    $BillingReport.Add(asx)
    asx.Clear()

  Else

    Select sRow
      Case "Gender", "Surname", "District", "Municipality", "Ethnic Group", "Service Rank", "Service Unit", "Service Category"
        sql1 = Subst("select distinct(&1) as fld from tblpatientinfo", xval)
        res1 = conn.Exec(sql1 & "  where fldpatientval in(select fldpatientval from tblencounter where fldvisit like &1 and " & coltime & ">=&2 and " & coltime & "<=&3 and flddisctype like &4 and fldcomp like &5) ORDER BY " & xval & " ASC", sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sDiscType, sComp)
      Case Else
        sql1 = Subst("select distinct(&1) as fld from tblencounter", xval)
        res1 = conn.Exec(sql1 & " where fldvisit like &1 and " & coltime & ">=&2 and " & coltime & "<=&3 and flddisctype like &4 and fldcomp like &5" & modDataRepo.GetWhereStringRepo(sLocaType, sLocation) & " ORDER BY " & xval & " ASC", sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sDiscType, sComp)
    End Select
    If res1.Available Then

      For Each res1
        With asx
          .Add(res1!fld)
          xtot = 0

          If sColumn = "Age Group" Then
            For i = 1 To xcol.Count - 2
              ageval = Split(modMedReports.GetAgeValuefromgroup(xcol[i]), ";")
              res2 = conn.Exec("select COUNT(tblencounter.fldencounterval) as tot from tblencounter inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblencounter.fldvisit like &1 and " & coltime & ">=&2 and " & coltime & "<=&3 and tblencounter.flddisctype like &4 and tblencounter.fldcomp like &5 and " & agesql & ">=&6 and " & agesql & "<&7 and " & xval & "=&8" & xstr, sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sDiscType, sComp, CLong(ageval[0]), CLong(ageval[1]), res1!fld)                                                          ''
              If res2!tot Then
                xtot = xtot + res2!tot
                .Add(modReportVar.GetLocaleNumberFormat(res2!tot, 0))
              Else
                .Add(modReportVar.GetLocaleNumberFormat(0, 0))
              Endif
            Next
          Else If sColumn = "Age Group (Gender)" Then
            For i = 1 To xcol.Count - 2
              genval = Split(xcol[i], ":")
              ageval = Split(modMedReports.GetAgeValuefromgroup(genval[0]), ";")
              res2 = conn.Exec("select COUNT(tblencounter.fldencounterval) as tot from tblencounter inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblencounter.fldvisit like &1 and " & coltime & ">=&2 and " & coltime & "<=&3 and tblencounter.flddisctype like &4 and tblencounter.fldcomp like &5 and " & agesql & ">=&6 and " & agesql & "<&7 and " & xval & "=&8 and tblpatientinfo.fldptsex=&9" & xstr, sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sDiscType, sComp, CLong(ageval[0]), CLong(ageval[1]), res1!fld, genval[1])                                                          ''
              If res2!tot Then
                xtot = xtot + res2!tot
                .Add(modReportVar.GetLocaleNumberFormat(res2!tot, 0))
              Else
                .Add(modReportVar.GetLocaleNumberFormat(0, 0))
              Endif
            Next
          Endif

          .Add(modReportVar.GetLocaleNumberFormat(xtot, 0))
        End With
        $BillingReport.Add(asx)
        asx.Clear()
      Next

      With asx
        .Add("")
        aTot = 0

        If sColumn = "Age Group" Then
          For i = 1 To xcol.Count - 2
            ageval = Split(modMedReports.GetAgeValuefromgroup(xcol[i]), ";")
            res3 = conn.Exec("select COUNT(tblencounter.fldencounterval) as tot from tblencounter inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblencounter.fldvisit like &1 and " & coltime & ">=&2 and " & coltime & "<=&3 and tblencounter.flddisctype like &4 and tblencounter.fldcomp like &5 and " & agesql & ">=&6 and " & agesql & "<&7 and " & xval & " like &8" & xstr, sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sDiscType, sComp, CLong(ageval[0]), CLong(ageval[1]), "%")                                                          ''
            If res3!tot Then
              aTot = aTot + res3!tot
              .Add(modReportVar.GetLocaleNumberFormat(res3!tot, 0))
            Else
              .Add(modReportVar.GetLocaleNumberFormat(0, 0))
            Endif
          Next
        Else If sColumn = "Age Group (Gender)" Then
          For i = 1 To xcol.Count - 2
            genval = Split(xcol[i], ":")
            ageval = Split(modMedReports.GetAgeValuefromgroup(genval[0]), ";")
            res3 = conn.Exec("select COUNT(tblencounter.fldencounterval) as tot from tblencounter inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblencounter.fldvisit like &1 and " & coltime & ">=&2 and " & coltime & "<=&3 and tblencounter.flddisctype like &4 and tblencounter.fldcomp like &5 and " & agesql & ">=&6 and " & agesql & "<&7 and " & xval & " like &8 and tblpatientinfo.fldptsex=&9" & xstr, sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sDiscType, sComp, CLong(ageval[0]), CLong(ageval[1]), "%", genval[1])                                                          ''
            If res3!tot Then
              aTot = aTot + res3!tot
              .Add(modReportVar.GetLocaleNumberFormat(res3!tot, 0))
            Else
              .Add(modReportVar.GetLocaleNumberFormat(0, 0))
            Endif
          Next
        Endif

        .Add(modReportVar.GetLocaleNumberFormat(aTot, 0))
      End With
      $BillingReport.Add(asx)
      asx.Clear()

    Endif

  Endif
  Return $BillingReport.NewHTMLPath()

End

''---------------------------- consult -----------------------------
Private Function TotalSelectedPatientConsult(conn As Connection, dt1 As Date, dt2 As Date, sBillMode As String, sComp As String, sVisit As String, sDept As String, sLocaType As String, sLocation As String) As Integer

  Dim res4 As Result
  Dim coltime As String
  Dim xval As Integer
  Dim xstr As String

  xstr = modDataRepo.GetWhereStringRepo(sLocaType, sLocation)
  coltime = "fldconsulttime"
  res4 = conn.Exec("select COUNT(fldencounterval) as tot from tblconsult where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6)" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit)
  If res4!tot Then
    xval = res4!tot
  Else
    xval = 0
  Endif
  Return xval

End

Public Function SummaryConsultSelectedEncounter(conn As Connection, dt1 As Date, dt2 As Date, sRow As String, sColumn As String, sBillMode As String, sComp As String, sVisit As String, sDept As String, sLocaType As String, sLocation As String) As String

  Dim $BillingReport As CReportHTML
  Dim sql1 As String
  Dim asx As New String[0]
  Dim res1 As Result
  Dim xval As String
  Dim yval As String
  Dim xcol As String[]

  Dim res2 As Result
  Dim dtlst As Date[]
  Dim dt As Date
  Dim i As Integer
  Dim xtot As Float
  Dim res3 As Result
  Dim aTot As Integer

  Dim res As Result
  Dim sql As String
  Dim coltime As String
  Dim xdateform As String
  Dim xfirdate As Date
  Dim xlasdate As Date
  Dim chapdate As String
  Dim xstr As String

  xstr = modDataRepo.GetWhereStringRepo(sLocaType, sLocation)
  coltime = "fldconsulttime"
  xval = modMedReports.GetColumnEncounter(sRow)
  yval = modMedReports.GetColumnEncounter(sColumn)
  Select sColumn
    Case "Gender", "Surname", "District", "Municipality", "Service Rank", "Service Unit", "Service Category"
      sql = Subst("select distinct(&1) as fld from tblpatientinfo", yval)
      res = conn.Exec(sql & "  where fldpatientval in(select fldpatientval from tblencounter where fldvisit like &1 and fldencounterval in(select fldencounterval from tblconsult where " & coltime & ">=&2 and " & coltime & "<=&3 and fldbillingmode like &4 and fldcomp like &5)) ORDER BY " & yval & " ASC", sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sComp)
    Case "OPD Department", "OPD Consultant", "OPD Rate Plan", "OPD Outcome"
      sql = Subst("select distinct(&1) as fld from tblconsult", yval)
      res = conn.Exec(sql & " where fldencounterval in(select fldencounterval from tblencounter where fldvisit like &1) and " & coltime & ">=&2 and " & coltime & "<=&3 and fldbillingmode like &4 and fldcomp like &5" & xstr & " ORDER BY " & yval & " ASC", sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sComp)
    Case Else
      sql = Subst("select distinct(&1) as fld from tblencounter", yval)
      res = conn.Exec(sql & " where fldvisit like &1 and fldencounterval in(select fldencounterval from tblconsult where " & coltime & ">=&2 and " & coltime & "<=&3 and fldbillingmode like &4 and fldcomp like &5)" & xstr & " ORDER BY " & yval & " ASC", sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sComp)
  End Select
  xcol = New String[]
  If res.Available Then
    xcol.Add(UCase(sRow))
    For Each res
      xcol.Add(res!fld)
    Next
    xcol.Add("TOTAL")
  Endif

  $BillingReport = New CReportHTML(xcol, "", "")
  $BillingReport.UserData.Add("Dept: " & sDept & " Visit:" & sVisit & " Location:" & sComp & " Mode:" & sBillMode & " Date: " & modReportVar.GetDateTimeReport(dt1, gb.MediumDate) & " TO " & modReportVar.GetDateTimeReport(dt2, gb.MediumDate), "PARAM1")
  $BillingReport.UserData.Add("TOTAL COUNT: " & modReportVar.GetLocaleNumberFormat(TotalSelectedPatientConsult(conn, dt1, dt2, sBillMode, sComp, sVisit, sDept, sLocaType, sLocation), 0), "PARAM2")

  If sRow = "Year" Or If sRow = "Month" Or If sRow = "Date" Then
    xdateform = modSettings.ShowSettingFromFIle("HealthReport/RowDateFormat")

    If sRow = "Year" Then
      If modBasic.$DateFormat = "BS Date" Then
        dtlst = modDate.GetSelectDateBSArrayBetween(gb.Year, dt1, dt2)
      Else
        dtlst = modDate.GetSelectDateArrayBetween(gb.Year, dt1, dt2)
      Endif
    Else If sRow = "Month" Then
      If modBasic.$DateFormat = "BS Date" Then
        dtlst = modDate.GetSelectDateBSArrayBetween(gb.Month, dt1, dt2)
      Else
        dtlst = modDate.GetSelectDateArrayBetween(gb.Month, dt1, dt2)
      Endif
    Else
      dtlst = modDate.GetSelectDateArrayBetween(gb.Day, dt1, dt2)
    Endif
    For Each dt In dtlst
      If sRow = "Year" Then
        If modBasic.$DateFormat = "BS Date" Then
          chapdate = modDate.DateFormatViewBS(dt, "YearOnly")
          xfirdate = modDate.StartSqlYearBS(dt)
          xlasdate = modDate.EndSqlYearBS(dt)
        Else
          chapdate = Format(dt, "yyyy")
          xfirdate = modDate.StartSqlYear(dt)
          xlasdate = modDate.EndSqlYear(dt)
        Endif
      Else If sRow = "Month" Then
        If modBasic.$DateFormat = "BS Date" Then
          chapdate = modDate.DateFormatViewBS(dt, "YearMonth")
          xfirdate = modDate.StartSqlMonthBS(dt)
          xlasdate = modDate.EndSqlMonthBS(dt)
        Else
          chapdate = Format(dt, "mmm yyyy")
          xfirdate = modDate.StartSqlMonth(dt)
          xlasdate = modDate.EndSqlMonth(dt)
        Endif
      Else
        If xdateform = "Disable" Then
          chapdate = modReportVar.GetDateTimeReport(dt, gb.MediumDate)
        Else
          chapdate = modReportVar.GetDateTimeReport(dt, gb.MediumDate) & " [" & modDate.GetWeekDay(dt) & "]"
        Endif
        xfirdate = modDate.StartSqlDate(dt)
        xlasdate = modDate.EndSqlDate(dt)
      Endif

      With asx
        .Add(chapdate)
        xtot = 0
        For i = 1 To xcol.Count - 2
          Select sColumn
            Case "Gender", "Surname", "District", "Municipality", "Service Rank", "Service Unit", "Service Category"
              res2 = conn.Exec("select COUNT(fldencounterval) as tot from tblconsult where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6 and fldpatientval in(select fldpatientval from tblpatientinfo where " & yval & QSymbol(xcol[i]) & "&7))" & xstr, sDept, sComp, xfirdate, xlasdate, sBillMode, sVisit, xcol[i])
            Case "OPD Department", "OPD Consultant", "OPD Rate Plan", "OPD Outcome"
              res2 = conn.Exec("select COUNT(fldencounterval) as tot from tblconsult where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6) and " & yval & QSymbol(xcol[i]) & "&7" & xstr, sDept, sComp, xfirdate, xlasdate, sBillMode, sVisit, xcol[i])
            Case Else
              res2 = conn.Exec("select COUNT(fldencounterval) as tot from tblconsult where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6 and " & yval & QSymbol(xcol[i]) & "&7)" & xstr, sDept, sComp, xfirdate, xlasdate, sBillMode, sVisit, xcol[i])
          End Select
          If res2!tot Then
            xtot = xtot + res2!tot
            .Add(modReportVar.GetLocaleNumberFormat(res2!tot, 0))
          Else
            .Add(modReportVar.GetLocaleNumberFormat(0, 0))
          Endif
        Next
        .Add(modReportVar.GetLocaleNumberFormat(xtot, 0))
      End With
      $BillingReport.Add(asx)
      asx.Clear()
    Next

    With asx
      .Add("")
      aTot = 0
      For i = 1 To xcol.Count - 2
        Select sColumn
          Case "Gender", "Surname", "District", "Municipality", "Service Rank", "Service Unit", "Service Category"
            res3 = conn.Exec("select COUNT(fldencounterval) as tot from tblconsult where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6 and fldpatientval in(select fldpatientval from tblpatientinfo where " & yval & QSymbol(xcol[i]) & "&7))" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, xcol[i])
          Case "OPD Department", "OPD Consultant", "OPD Rate Plan", "OPD Outcome"
            res3 = conn.Exec("select COUNT(fldencounterval) as tot from tblconsult where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6) and " & yval & QSymbol(xcol[i]) & "&7" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, xcol[i])
          Case Else
            res3 = conn.Exec("select COUNT(fldencounterval) as tot from tblconsult where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6 and " & yval & QSymbol(xcol[i]) & "&7)" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, xcol[i])
        End Select
        If res3!tot Then
          aTot = aTot + res3!tot
          .Add(modReportVar.GetLocaleNumberFormat(res3!tot, 0))
        Else
          .Add(modReportVar.GetLocaleNumberFormat(0, 0))
        Endif
      Next
      .Add(modReportVar.GetLocaleNumberFormat(aTot, 0))
    End With
    $BillingReport.Add(asx)
    asx.Clear()

  Else

    Select sRow
      Case "Gender", "Surname", "District", "Municipality", "Ethnic Group", "Service Rank", "Service Unit", "Service Category"
        sql1 = Subst("select distinct(&1) as fld from tblpatientinfo", xval)
        res1 = conn.Exec(sql1 & "  where fldpatientval in(select fldpatientval from tblencounter where fldvisit like &1 and fldencounterval in(select fldencounterval from tblconsult where " & coltime & ">=&2 and " & coltime & "<=&3 and fldbillingmode like &4 and fldcomp like &5)) ORDER BY " & xval & " ASC", sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sComp)
      Case "OPD Department", "OPD Consultant", "OPD Rate Plan", "OPD Outcome"
        sql1 = Subst("select distinct(&1) as fld from tblconsult", xval)
        res1 = conn.Exec(sql1 & "  where fldencounterval in(select fldencounterval from tblencounter where fldvisit like &1) and " & coltime & ">=&2 and " & coltime & "<=&3 and fldbillingmode like &4 and fldcomp like &5" & xstr & " ORDER BY " & xval & " ASC", sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sComp)
      Case Else
        sql1 = Subst("select distinct(&1) as fld from tblencounter", xval)
        res1 = conn.Exec(sql1 & " where fldvisit like &1 and fldencounterval in(select fldencounterval from tblconsult where " & coltime & ">=&2 and " & coltime & "<=&3 and fldbillingmode like &4 and fldcomp like &5)" & xstr & " ORDER BY " & xval & " ASC", sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sComp)
    End Select
    If res1.Available Then

      For Each res1
        With asx
          .Add(res1!fld)

          xtot = 0
          For i = 1 To xcol.Count - 2
            Select sRow
              Case "Gender", "Surname", "District", "Municipality", "Ethnic Group", "Service Rank", "Service Unit", "Service Category"
                Select sColumn
                  Case "Gender", "Surname", "District", "Municipality", "Service Rank", "Service Unit", "Service Category"
                    res2 = conn.Exec("select COUNT(fldencounterval) as tot from tblconsult where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6 and fldpatientval in(select fldpatientval from tblpatientinfo where " & xval & QSymbol(res1!fld) & "&7 and " & yval & QSymbol(xcol[i]) & "&8))" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, res1!fld, xcol[i])
                  Case "OPD Department", "OPD Consultant", "OPD Rate Plan", "OPD Outcome"
                    res2 = conn.Exec("select COUNT(fldencounterval) as tot from tblconsult where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6 and fldpatientval in(select fldpatientval from tblpatientinfo where " & xval & QSymbol(res1!fld) & "&7)) and " & yval & QSymbol(xcol[i]) & "&8" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, res1!fld, xcol[i])
                  Case Else
                    res2 = conn.Exec("select COUNT(fldencounterval) as tot from tblconsult where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6 and fldpatientval in(select fldpatientval from tblpatientinfo where " & xval & QSymbol(res1!fld) & "&7) and " & yval & QSymbol(xcol[i]) & "&8)" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, res1!fld, xcol[i])
                End Select

              Case "OPD Department", "OPD Consultant", "OPD Rate Plan", "OPD Outcome"
                Select sColumn
                  Case "Gender", "Surname", "District", "Municipality", "Service Rank", "Service Unit", "Service Category"
                    res2 = conn.Exec("select COUNT(fldencounterval) as tot from tblconsult where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and " & xval & QSymbol(res1!fld) & "&7 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6 and fldpatientval in(select fldpatientval from tblpatientinfo where " & yval & QSymbol(xcol[i]) & "&8))" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, res1!fld, xcol[i])
                  Case "OPD Department", "OPD Consultant", "OPD Rate Plan", "OPD Outcome"
                    res2 = conn.Exec("select COUNT(fldencounterval) as tot from tblconsult where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and " & xval & QSymbol(res1!fld) & "&7 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6) and " & yval & QSymbol(xcol[i]) & "&8" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, res1!fld, xcol[i])
                  Case Else
                    res2 = conn.Exec("select COUNT(fldencounterval) as tot from tblconsult where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and " & xval & QSymbol(res1!fld) & "&7 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6 and " & yval & QSymbol(xcol[i]) & "&8)" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, res1!fld, xcol[i])
                End Select

              Case Else
                Select sColumn
                  Case "Gender", "Surname", "District", "Municipality", "Service Rank", "Service Unit", "Service Category"
                    res2 = conn.Exec("select COUNT(fldencounterval) as tot from tblconsult where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6 and " & xval & QSymbol(res1!fld) & "&7 and fldpatientval in(select fldpatientval from tblpatientinfo where " & yval & QSymbol(xcol[i]) & "&8))" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, res1!fld, xcol[i])
                  Case "OPD Department", "OPD Consultant", "OPD Rate Plan", "OPD Outcome"
                    res2 = conn.Exec("select COUNT(fldencounterval) as tot from tblconsult where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6 and " & xval & QSymbol(res1!fld) & "&7) and " & yval & QSymbol(xcol[i]) & "&8" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, res1!fld, xcol[i])
                  Case Else
                    res2 = conn.Exec("select COUNT(fldencounterval) as tot from tblconsult where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6 and " & xval & QSymbol(res1!fld) & "&7 and " & yval & QSymbol(xcol[i]) & "&8)" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, res1!fld, xcol[i])
                End Select
            End Select
            If res2!tot Then
              xtot = xtot + res2!tot
              .Add(modReportVar.GetLocaleNumberFormat(res2!tot, 0))
            Else
              .Add(modReportVar.GetLocaleNumberFormat(0, 0))
            Endif
          Next
          .Add(modReportVar.GetLocaleNumberFormat(xtot, 0))

        End With
        $BillingReport.Add(asx)
        asx.Clear()
      Next

      With asx
        .Add("")

        aTot = 0
        For i = 1 To xcol.Count - 2
          Select sRow
            Case "Gender", "Surname", "District", "Municipality", "Ethnic Group", "Service Rank", "Service Unit", "Service Category"
              Select sColumn
                Case "Gender", "Surname", "District", "Municipality", "Service Rank", "Service Unit", "Service Category"
                  res3 = conn.Exec("select COUNT(fldencounterval) as tot from tblconsult where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6 and fldpatientval in(select fldpatientval from tblpatientinfo where " & yval & QSymbol(xcol[i]) & "&7))" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, xcol[i])
                Case "OPD Department", "OPD Consultant", "OPD Rate Plan", "OPD Outcome"
                  res3 = conn.Exec("select COUNT(fldencounterval) as tot from tblconsult where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6) and " & yval & QSymbol(xcol[i]) & "&7" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, xcol[i])
                Case Else
                  res3 = conn.Exec("select COUNT(fldencounterval) as tot from tblconsult where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6 and " & yval & QSymbol(xcol[i]) & "&7)" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, xcol[i])
              End Select

            Case "OPD Department", "OPD Consultant", "OPD Rate Plan", "OPD Outcome"
              Select sColumn
                Case "Gender", "Surname", "District", "Municipality", "Service Rank", "Service Unit", "Service Category"
                  res3 = conn.Exec("select COUNT(fldencounterval) as tot from tblconsult where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6 and fldpatientval in(select fldpatientval from tblpatientinfo where " & yval & QSymbol(xcol[i]) & "&7))" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, xcol[i])
                Case "OPD Department", "OPD Consultant", "OPD Rate Plan", "OPD Outcome"
                  res3 = conn.Exec("select COUNT(fldencounterval) as tot from tblconsult where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6) and " & yval & QSymbol(xcol[i]) & "&7" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, xcol[i])
                Case Else
                  res3 = conn.Exec("select COUNT(fldencounterval) as tot from tblconsult where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6 and " & yval & QSymbol(xcol[i]) & "&7)" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, xcol[i])
              End Select

            Case Else
              Select sColumn
                Case "Gender", "Surname", "District", "Municipality", "Service Rank", "Service Unit", "Service Category"
                  res3 = conn.Exec("select COUNT(fldencounterval) as tot from tblconsult where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6 and fldpatientval in(select fldpatientval from tblpatientinfo where " & yval & QSymbol(xcol[i]) & "&7))" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, xcol[i])
                Case "OPD Department", "OPD Consultant", "OPD Rate Plan", "OPD Outcome"
                  res3 = conn.Exec("select COUNT(fldencounterval) as tot from tblconsult where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6) and " & yval & QSymbol(xcol[i]) & "&7" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, xcol[i])
                Case Else
                  res3 = conn.Exec("select COUNT(fldencounterval) as tot from tblconsult where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6 and " & yval & QSymbol(xcol[i]) & "&7)" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, xcol[i])
              End Select
          End Select
          If res3!tot Then
            aTot = aTot + res3!tot
            .Add(modReportVar.GetLocaleNumberFormat(res3!tot, 0))
          Else
            .Add(modReportVar.GetLocaleNumberFormat(0, 0))
          Endif
        Next
        .Add(modReportVar.GetLocaleNumberFormat(aTot, 0))

      End With
      $BillingReport.Add(asx)
      asx.Clear()

    Endif

  Endif
  Return $BillingReport.NewHTMLPath()

End

Public Function SummaryConsultSelectedAgeEncounter(conn As Connection, dt1 As Date, dt2 As Date, sRow As String, sColumn As String, sBillMode As String, sComp As String, sVisit As String, sDept As String, sLocaType As String, sLocation As String) As String

  Dim $BillingReport As CReportHTML
  Dim sql1 As String
  Dim asx As New String[0]
  Dim agegrp As String[]
  Dim agegendergrp As String[]
  Dim agesql As String
  Dim ageval As String[]
  Dim genval As String[]

  Dim res1 As Result
  Dim xval As String
  Dim xcol As String[]
  Dim res2 As Result
  Dim dtlst As Date[]
  Dim dt As Date
  Dim i As Integer
  Dim xtot As Float
  Dim res3 As Result
  Dim aTot As Integer

  Dim coltime As String
  Dim xdateform As String
  Dim xfirdate As Date
  Dim xlasdate As Date
  Dim chapdate As String
  Dim xstr As String

  xstr = modDataRepo.GetWhereStringRepo(sLocaType, sLocation, "tblconsult")
  coltime = "tblconsult.fldconsulttime"
  xval = modMedReports.GetColumnEncounter(sRow)
  agegrp = modMedReports.AgeGroupNameList()
  agegendergrp = modMedReports.AgeGroupGenderList()
  agesql = modMedReports.GetAgeStringByTable("tblencounter", conn)

  xcol = New String[]
  xcol.Add(UCase(sRow))
  If sColumn = "Age Group" Then
    xcol.Insert(agegrp)
  Else If sColumn = "Age Group (Gender)" Then
    xcol.Insert(agegendergrp)
  Endif
  xcol.Add("TOTAL")

  $BillingReport = New CReportHTML(xcol, "", "")
  $BillingReport.UserData.Add("Dept: " & sDept & " Visit:" & sVisit & " Location:" & sComp & " Mode:" & sBillMode & " Date: " & modReportVar.GetDateTimeReport(dt1, gb.MediumDate) & " TO " & modReportVar.GetDateTimeReport(dt2, gb.MediumDate), "PARAM1")
  $BillingReport.UserData.Add("TOTAL COUNT: " & modReportVar.GetLocaleNumberFormat(TotalSelectedPatientConsult(conn, dt1, dt2, sBillMode, sComp, sVisit, sDept, sLocaType, sLocation), 0), "PARAM2")

  If sRow = "Year" Or If sRow = "Month" Or If sRow = "Date" Then
    xdateform = modSettings.ShowSettingFromFIle("HealthReport/RowDateFormat")

    If sRow = "Year" Then
      If modBasic.$DateFormat = "BS Date" Then
        dtlst = modDate.GetSelectDateBSArrayBetween(gb.Year, dt1, dt2)
      Else
        dtlst = modDate.GetSelectDateArrayBetween(gb.Year, dt1, dt2)
      Endif
    Else If sRow = "Month" Then
      If modBasic.$DateFormat = "BS Date" Then
        dtlst = modDate.GetSelectDateBSArrayBetween(gb.Month, dt1, dt2)
      Else
        dtlst = modDate.GetSelectDateArrayBetween(gb.Month, dt1, dt2)
      Endif
    Else
      dtlst = modDate.GetSelectDateArrayBetween(gb.Day, dt1, dt2)
    Endif
    For Each dt In dtlst
      If sRow = "Year" Then
        If modBasic.$DateFormat = "BS Date" Then
          chapdate = modDate.DateFormatViewBS(dt, "YearOnly")
          xfirdate = modDate.StartSqlYearBS(dt)
          xlasdate = modDate.EndSqlYearBS(dt)
        Else
          chapdate = Format(dt, "yyyy")
          xfirdate = modDate.StartSqlYear(dt)
          xlasdate = modDate.EndSqlYear(dt)
        Endif
      Else If sRow = "Month" Then
        If modBasic.$DateFormat = "BS Date" Then
          chapdate = modDate.DateFormatViewBS(dt, "YearMonth")
          xfirdate = modDate.StartSqlMonthBS(dt)
          xlasdate = modDate.EndSqlMonthBS(dt)
        Else
          chapdate = Format(dt, "mmm yyyy")
          xfirdate = modDate.StartSqlMonth(dt)
          xlasdate = modDate.EndSqlMonth(dt)
        Endif
      Else
        If xdateform = "Disable" Then
          chapdate = modReportVar.GetDateTimeReport(dt, gb.MediumDate)
        Else
          chapdate = modReportVar.GetDateTimeReport(dt, gb.MediumDate) & " [" & modDate.GetWeekDay(dt) & "]"
        Endif
        xfirdate = modDate.StartSqlDate(dt)
        xlasdate = modDate.EndSqlDate(dt)
      Endif

      With asx
        .Add(chapdate)
        xtot = 0

        If sColumn = "Age Group" Then
          For i = 1 To xcol.Count - 2
            ageval = Split(modMedReports.GetAgeValuefromgroup(xcol[i]), ";")
            res2 = conn.Exec("select COUNT(tblconsult.fldencounterval) as tot from (tblconsult inner join tblencounter on tblconsult.fldencounterval=tblencounter.fldencounterval) inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblconsult.fldconsultname like &1 and tblencounter.fldvisit like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and tblconsult.fldbillingmode like &5 and tblconsult.fldcomp like &6 and " & agesql & ">=&7 and " & agesql & "<&8" & xstr, sDept, sVisit, xfirdate, xlasdate, sBillMode, sComp, CLong(ageval[0]), CLong(ageval[1]))                                                          ''
            If res2!tot Then
              xtot = xtot + res2!tot
              .Add(modReportVar.GetLocaleNumberFormat(res2!tot, 0))
            Else
              .Add(modReportVar.GetLocaleNumberFormat(0, 0))
            Endif
          Next
        Else If sColumn = "Age Group (Gender)" Then
          For i = 1 To xcol.Count - 2
            genval = Split(xcol[i], ":")
            ageval = Split(modMedReports.GetAgeValuefromgroup(genval[0]), ";")
            res2 = conn.Exec("select COUNT(tblconsult.fldencounterval) as tot from (tblconsult inner join tblencounter on tblconsult.fldencounterval=tblencounter.fldencounterval) inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblconsult.fldconsultname like &1 and tblencounter.fldvisit like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and tblconsult.fldbillingmode like &5 and tblconsult.fldcomp like &6 and " & agesql & ">=&7 and " & agesql & "<&8 and tblpatientinfo.fldptsex=&9" & xstr, sDept, sVisit, xfirdate, xlasdate, sBillMode, sComp, CLong(ageval[0]), CLong(ageval[1]), genval[1])                                                          ''
            If res2!tot Then
              xtot = xtot + res2!tot
              .Add(modReportVar.GetLocaleNumberFormat(res2!tot, 0))
            Else
              .Add(modReportVar.GetLocaleNumberFormat(0, 0))
            Endif
          Next
        Endif

        .Add(modReportVar.GetLocaleNumberFormat(xtot, 0))
      End With
      $BillingReport.Add(asx)
      asx.Clear()
    Next

    With asx
      .Add("")
      aTot = 0

      If sColumn = "Age Group" Then
        For i = 1 To xcol.Count - 2
          ageval = Split(modMedReports.GetAgeValuefromgroup(xcol[i]), ";")
          res3 = conn.Exec("select COUNT(tblconsult.fldencounterval) as tot from (tblconsult inner join tblencounter on tblconsult.fldencounterval=tblencounter.fldencounterval) inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblconsult.fldconsultname like &1 and tblencounter.fldvisit like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and tblconsult.fldbillingmode like &5 and tblconsult.fldcomp like &6 and " & agesql & ">=&7 and " & agesql & "<&8" & xstr, sDept, sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sComp, CLong(ageval[0]), CLong(ageval[1]))                                                          ''
          If res3!tot Then
            aTot = aTot + res3!tot
            .Add(modReportVar.GetLocaleNumberFormat(res3!tot, 0))
          Else
            .Add(modReportVar.GetLocaleNumberFormat(0, 0))
          Endif
        Next
      Else If sColumn = "Age Group (Gender)" Then
        For i = 1 To xcol.Count - 2
          genval = Split(xcol[i], ":")
          ageval = Split(modMedReports.GetAgeValuefromgroup(genval[0]), ";")
          res3 = conn.Exec("select COUNT(tblconsult.fldencounterval) as tot from (tblconsult inner join tblencounter on tblconsult.fldencounterval=tblencounter.fldencounterval) inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblconsult.fldconsultname like &1 and tblencounter.fldvisit like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and tblconsult.fldbillingmode like &5 and tblconsult.fldcomp like &6 and " & agesql & ">=&7 and " & agesql & "<&8 and tblpatientinfo.fldptsex=&9" & xstr, sDept, sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sComp, CLong(ageval[0]), CLong(ageval[1]), genval[1])                                                          ''
          If res3!tot Then
            aTot = aTot + res3!tot
            .Add(modReportVar.GetLocaleNumberFormat(res3!tot, 0))
          Else
            .Add(modReportVar.GetLocaleNumberFormat(0, 0))
          Endif
        Next
      Endif

      .Add(modReportVar.GetLocaleNumberFormat(aTot, 0))
    End With
    $BillingReport.Add(asx)
    asx.Clear()

  Else

    Select sRow
      Case "Gender", "Surname", "District", "Municipality", "Ethnic Group", "Service Rank", "Service Unit", "Service Category"
        sql1 = Subst("select distinct(&1) as fld from tblpatientinfo", xval)
        res1 = conn.Exec(sql1 & "  where fldpatientval in(select fldpatientval from tblencounter where fldvisit like &1 and fldencounterval in(select fldencounterval from tblconsult where " & coltime & ">=&2 and " & coltime & "<=&3 and fldbillingmode like &4 and fldcomp like &5)) ORDER BY " & xval & " ASC", sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sComp)
      Case Else
        sql1 = Subst("select distinct(&1) as fld from tblencounter", xval)
        res1 = conn.Exec(sql1 & " where fldvisit like &1 and fldencounterval in(select fldencounterval from tblconsult where " & coltime & ">=&2 and " & coltime & "<=&3 and fldbillingmode like &4 and fldcomp like &5)" & modDataRepo.GetWhereStringRepo(sLocaType, sLocation) & " ORDER BY " & xval & " ASC", sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sComp)
    End Select
    If res1.Available Then

      For Each res1
        With asx
          .Add(res1!fld)
          xtot = 0

          If sColumn = "Age Group" Then
            For i = 1 To xcol.Count - 2
              ageval = Split(modMedReports.GetAgeValuefromgroup(xcol[i]), ";")
              res2 = conn.Exec("select COUNT(tblconsult.fldencounterval) as tot from (tblconsult inner join tblencounter on tblconsult.fldencounterval=tblencounter.fldencounterval) inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblconsult.fldconsultname like &1 and tblencounter.fldvisit like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and tblconsult.fldbillingmode like &5 and tblconsult.fldcomp like &6 and " & agesql & ">=&7 and " & agesql & "<&8 and " & xval & "=&9" & xstr, sDept, sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sComp, CLong(ageval[0]), CLong(ageval[1]), res1!fld)                                                          ''
              If res2!tot Then
                xtot = xtot + res2!tot
                .Add(modReportVar.GetLocaleNumberFormat(res2!tot, 0))
              Else
                .Add(modReportVar.GetLocaleNumberFormat(0, 0))
              Endif
            Next
          Else If sColumn = "Age Group (Gender)" Then
            For i = 1 To xcol.Count - 2
              genval = Split(xcol[i], ":")
              ageval = Split(modMedReports.GetAgeValuefromgroup(genval[0]), ";")
              res2 = conn.Exec("select COUNT(tblconsult.fldencounterval) as tot from (tblconsult inner join tblencounter on tblconsult.fldencounterval=tblencounter.fldencounterval) inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblconsult.fldconsultname like &1 and tblencounter.fldvisit like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and tblconsult.fldbillingmode like &5 and tblconsult.fldcomp like &6 and " & agesql & ">=&7 and " & agesql & "<&8 and " & xval & "=&9 and tblpatientinfo.fldptsex=&{10}" & xstr, sDept, sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sComp, CLong(ageval[0]), CLong(ageval[1]), res1!fld, genval[1])                                                          ''
              If res2!tot Then
                xtot = xtot + res2!tot
                .Add(modReportVar.GetLocaleNumberFormat(res2!tot, 0))
              Else
                .Add(modReportVar.GetLocaleNumberFormat(0, 0))
              Endif
            Next
          Endif

          .Add(modReportVar.GetLocaleNumberFormat(xtot, 0))
        End With
        $BillingReport.Add(asx)
        asx.Clear()
      Next

      With asx
        .Add("")
        aTot = 0

        If sColumn = "Age Group" Then
          For i = 1 To xcol.Count - 2
            ageval = Split(modMedReports.GetAgeValuefromgroup(xcol[i]), ";")
            res3 = conn.Exec("select COUNT(tblconsult.fldencounterval) as tot from (tblconsult inner join tblencounter on tblconsult.fldencounterval=tblencounter.fldencounterval) inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblconsult.fldconsultname like &1 and tblencounter.fldvisit like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and tblconsult.fldbillingmode like &5 and tblconsult.fldcomp like &6 and " & agesql & ">=&7 and " & agesql & "<&8 and " & xval & " like &9" & xstr, sDept, sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sComp, CLong(ageval[0]), CLong(ageval[1]), "%")                                                          ''
            If res3!tot Then
              aTot = aTot + res3!tot
              .Add(modReportVar.GetLocaleNumberFormat(res3!tot, 0))
            Else
              .Add(modReportVar.GetLocaleNumberFormat(0, 0))
            Endif
          Next
        Else If sColumn = "Age Group (Gender)" Then
          For i = 1 To xcol.Count - 2
            genval = Split(xcol[i], ":")
            ageval = Split(modMedReports.GetAgeValuefromgroup(genval[0]), ";")
            res3 = conn.Exec("select COUNT(tblconsult.fldencounterval) as tot from (tblconsult inner join tblencounter on tblconsult.fldencounterval=tblencounter.fldencounterval) inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblconsult.fldconsultname like &1 and tblencounter.fldvisit like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and tblconsult.fldbillingmode like &5 and tblconsult.fldcomp like &6 and " & agesql & ">=&7 and " & agesql & "<&8 and " & xval & " like &9 and tblpatientinfo.fldptsex=&{10}" & xstr, sDept, sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sComp, CLong(ageval[0]), CLong(ageval[1]), "%", genval[1])                                                          ''
            If res3!tot Then
              aTot = aTot + res3!tot
              .Add(modReportVar.GetLocaleNumberFormat(res3!tot, 0))
            Else
              .Add(modReportVar.GetLocaleNumberFormat(0, 0))
            Endif
          Next
        Endif

        .Add(modReportVar.GetLocaleNumberFormat(aTot, 0))
      End With
      $BillingReport.Add(asx)
      asx.Clear()

    Endif

  Endif
  Return $BillingReport.NewHTMLPath()

End

''----------------------- OP visit ------------------------
Private Function TotalSelectedPatientOPVisit(conn As Connection, dt1 As Date, dt2 As Date, sBillMode As String, sComp As String, sVisit As String, sDept As String, sLocaType As String, sLocation As String) As Integer

  Dim res4 As Result
  Dim coltime As String
  Dim xval As Integer
  Dim xstr As String

  xstr = modDataRepo.GetWhereStringRepo(sLocaType, sLocation)
  coltime = "fldconsulttime"
  res4 = conn.Exec("select COUNT(fldencounterval) as tot from tblopvisit where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6)" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit)
  If res4!tot Then
    xval = res4!tot
  Else
    xval = 0
  Endif
  Return xval

End

Public Function SummaryOPVisitSelectedEncounter(conn As Connection, dt1 As Date, dt2 As Date, sRow As String, sColumn As String, sBillMode As String, sComp As String, sVisit As String, sDept As String, sLocaType As String, sLocation As String) As String

  Dim $BillingReport As CReportHTML
  Dim sql1 As String
  Dim asx As New String[0]
  Dim res1 As Result
  Dim xval As String
  Dim yval As String
  Dim xcol As String[]

  Dim res2 As Result
  Dim dtlst As Date[]
  Dim dt As Date
  Dim i As Integer
  Dim xtot As Float
  Dim res3 As Result
  Dim aTot As Integer

  Dim res As Result
  Dim sql As String
  Dim coltime As String
  Dim xdateform As String
  Dim xfirdate As Date
  Dim xlasdate As Date
  Dim chapdate As String
  Dim xstr As String

  xstr = modDataRepo.GetWhereStringRepo(sLocaType, sLocation)
  coltime = "fldconsulttime"
  xval = modMedReports.GetColumnEncounter(sRow)
  yval = modMedReports.GetColumnEncounter(sColumn)
  Select sColumn
    Case "Gender", "Surname", "District", "Municipality", "Service Rank", "Service Unit", "Service Category"
      sql = Subst("select distinct(&1) as fld from tblpatientinfo", yval)
      res = conn.Exec(sql & "  where fldpatientval in(select fldpatientval from tblencounter where fldvisit like &1 and fldencounterval in(select fldencounterval from tblopvisit where " & coltime & ">=&2 and " & coltime & "<=&3 and fldbillingmode like &4 and fldcomp like &5)) ORDER BY " & yval & " ASC", sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sComp)
    Case "Visit Department", "Visit Rate Plan", "Visit Outcome"
      sql = Subst("select distinct(&1) as fld from tblopvisit", yval)
      res = conn.Exec(sql & " where fldencounterval in(select fldencounterval from tblencounter where fldvisit like &1) and " & coltime & ">=&2 and " & coltime & "<=&3 and fldbillingmode like &4 and fldcomp like &5" & xstr & " ORDER BY " & yval & " ASC", sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sComp)
    Case Else
      sql = Subst("select distinct(&1) as fld from tblencounter", yval)
      res = conn.Exec(sql & " where fldvisit like &1 and fldencounterval in(select fldencounterval from tblopvisit where " & coltime & ">=&2 and " & coltime & "<=&3 and fldbillingmode like &4 and fldcomp like &5)" & xstr & " ORDER BY " & yval & " ASC", sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sComp)
  End Select
  xcol = New String[]
  If res.Available Then
    xcol.Add(UCase(sRow))
    For Each res
      xcol.Add(res!fld)
    Next
    xcol.Add("TOTAL")
  Endif

  $BillingReport = New CReportHTML(xcol, "", "")
  $BillingReport.UserData.Add("Dept: " & sDept & " Visit:" & sVisit & " Location:" & sComp & " Mode:" & sBillMode & " Date: " & modReportVar.GetDateTimeReport(dt1, gb.MediumDate) & " TO " & modReportVar.GetDateTimeReport(dt2, gb.MediumDate), "PARAM1")
  $BillingReport.UserData.Add("TOTAL COUNT: " & modReportVar.GetLocaleNumberFormat(TotalSelectedPatientOPVisit(conn, dt1, dt2, sBillMode, sComp, sVisit, sDept, sLocaType, sLocation), 0), "PARAM2")

  If sRow = "Year" Or If sRow = "Month" Or If sRow = "Date" Then
    xdateform = modSettings.ShowSettingFromFIle("HealthReport/RowDateFormat")

    If sRow = "Year" Then
      If modBasic.$DateFormat = "BS Date" Then
        dtlst = modDate.GetSelectDateBSArrayBetween(gb.Year, dt1, dt2)
      Else
        dtlst = modDate.GetSelectDateArrayBetween(gb.Year, dt1, dt2)
      Endif
    Else If sRow = "Month" Then
      If modBasic.$DateFormat = "BS Date" Then
        dtlst = modDate.GetSelectDateBSArrayBetween(gb.Month, dt1, dt2)
      Else
        dtlst = modDate.GetSelectDateArrayBetween(gb.Month, dt1, dt2)
      Endif
    Else
      dtlst = modDate.GetSelectDateArrayBetween(gb.Day, dt1, dt2)
    Endif
    For Each dt In dtlst
      If sRow = "Year" Then
        If modBasic.$DateFormat = "BS Date" Then
          chapdate = modDate.DateFormatViewBS(dt, "YearOnly")
          xfirdate = modDate.StartSqlYearBS(dt)
          xlasdate = modDate.EndSqlYearBS(dt)
        Else
          chapdate = Format(dt, "yyyy")
          xfirdate = modDate.StartSqlYear(dt)
          xlasdate = modDate.EndSqlYear(dt)
        Endif
      Else If sRow = "Month" Then
        If modBasic.$DateFormat = "BS Date" Then
          chapdate = modDate.DateFormatViewBS(dt, "YearMonth")
          xfirdate = modDate.StartSqlMonthBS(dt)
          xlasdate = modDate.EndSqlMonthBS(dt)
        Else
          chapdate = Format(dt, "mmm yyyy")
          xfirdate = modDate.StartSqlMonth(dt)
          xlasdate = modDate.EndSqlMonth(dt)
        Endif
      Else
        If xdateform = "Disable" Then
          chapdate = modReportVar.GetDateTimeReport(dt, gb.MediumDate)
        Else
          chapdate = modReportVar.GetDateTimeReport(dt, gb.MediumDate) & " [" & modDate.GetWeekDay(dt) & "]"
        Endif
        xfirdate = modDate.StartSqlDate(dt)
        xlasdate = modDate.EndSqlDate(dt)
      Endif

      With asx
        .Add(chapdate)
        xtot = 0
        For i = 1 To xcol.Count - 2
          Select sColumn
            Case "Gender", "Surname", "District", "Municipality", "Service Rank", "Service Unit", "Service Category"
              res2 = conn.Exec("select COUNT(fldencounterval) as tot from tblopvisit where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6 and fldpatientval in(select fldpatientval from tblpatientinfo where " & yval & QSymbol(xcol[i]) & "&7))" & xstr, sDept, sComp, xfirdate, xlasdate, sBillMode, sVisit, xcol[i])
            Case "Visit Department", "Visit Rate Plan", "Visit Outcome"
              res2 = conn.Exec("select COUNT(fldencounterval) as tot from tblopvisit where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6) and " & yval & QSymbol(xcol[i]) & "&7" & xstr, sDept, sComp, xfirdate, xlasdate, sBillMode, sVisit, xcol[i])
            Case Else
              res2 = conn.Exec("select COUNT(fldencounterval) as tot from tblopvisit where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6 and " & yval & QSymbol(xcol[i]) & "&7)" & xstr, sDept, sComp, xfirdate, xlasdate, sBillMode, sVisit, xcol[i])
          End Select
          If res2!tot Then
            xtot = xtot + res2!tot
            .Add(modReportVar.GetLocaleNumberFormat(res2!tot, 0))
          Else
            .Add(modReportVar.GetLocaleNumberFormat(0, 0))
          Endif
        Next
        .Add(modReportVar.GetLocaleNumberFormat(xtot, 0))
      End With
      $BillingReport.Add(asx)
      asx.Clear()
    Next

    With asx
      .Add("")
      aTot = 0
      For i = 1 To xcol.Count - 2
        Select sColumn
          Case "Gender", "Surname", "District", "Municipality", "Service Rank", "Service Unit", "Service Category"
            res3 = conn.Exec("select COUNT(fldencounterval) as tot from tblopvisit where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6 and fldpatientval in(select fldpatientval from tblpatientinfo where " & yval & QSymbol(xcol[i]) & "&7))" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, xcol[i])
          Case "Visit Department", "Visit Rate Plan", "Visit Outcome"
            res3 = conn.Exec("select COUNT(fldencounterval) as tot from tblopvisit where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6) and " & yval & QSymbol(xcol[i]) & "&7" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, xcol[i])
          Case Else
            res3 = conn.Exec("select COUNT(fldencounterval) as tot from tblopvisit where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6 and " & yval & QSymbol(xcol[i]) & "&7)" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, xcol[i])
        End Select
        If res3!tot Then
          aTot = aTot + res3!tot
          .Add(modReportVar.GetLocaleNumberFormat(res3!tot, 0))
        Else
          .Add(modReportVar.GetLocaleNumberFormat(0, 0))
        Endif
      Next
      .Add(modReportVar.GetLocaleNumberFormat(aTot, 0))
    End With
    $BillingReport.Add(asx)
    asx.Clear()

  Else

    Select sRow
      Case "Gender", "Surname", "District", "Municipality", "Ethnic Group", "Service Rank", "Service Unit", "Service Category"
        sql1 = Subst("select distinct(&1) as fld from tblpatientinfo", xval)
        res1 = conn.Exec(sql1 & "  where fldpatientval in(select fldpatientval from tblencounter where fldvisit like &1 and fldencounterval in(select fldencounterval from tblopvisit where " & coltime & ">=&2 and " & coltime & "<=&3 and fldbillingmode like &4 and fldcomp like &5)) ORDER BY " & xval & " ASC", sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sComp)
      Case "Visit Department", "Visit Rate Plan", "Visit Outcome"
        sql1 = Subst("select distinct(&1) as fld from tblopvisit", xval)
        res1 = conn.Exec(sql1 & "  where fldencounterval in(select fldencounterval from tblencounter where fldvisit like &1) and " & coltime & ">=&2 and " & coltime & "<=&3 and fldbillingmode like &4 and fldcomp like &5" & xstr & " ORDER BY " & xval & " ASC", sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sComp)
      Case Else
        sql1 = Subst("select distinct(&1) as fld from tblencounter", xval)
        res1 = conn.Exec(sql1 & " where fldvisit like &1 and fldencounterval in(select fldencounterval from tblopvisit where " & coltime & ">=&2 and " & coltime & "<=&3 and fldbillingmode like &4 and fldcomp like &5)" & xstr & " ORDER BY " & xval & " ASC", sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sComp)
    End Select
    If res1.Available Then

      For Each res1
        With asx
          .Add(res1!fld)

          xtot = 0
          For i = 1 To xcol.Count - 2
            Select sRow
              Case "Gender", "Surname", "District", "Municipality", "Ethnic Group", "Service Rank", "Service Unit", "Service Category"
                Select sColumn
                  Case "Gender", "Surname", "District", "Municipality", "Service Rank", "Service Unit", "Service Category"
                    res2 = conn.Exec("select COUNT(fldencounterval) as tot from tblopvisit where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6 and fldpatientval in(select fldpatientval from tblpatientinfo where " & xval & QSymbol(res1!fld) & "&7 and " & yval & QSymbol(xcol[i]) & "&8))" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, res1!fld, xcol[i])
                  Case "Visit Department", "Visit Rate Plan", "Visit Outcome"
                    res2 = conn.Exec("select COUNT(fldencounterval) as tot from tblopvisit where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6 and fldpatientval in(select fldpatientval from tblpatientinfo where " & xval & QSymbol(res1!fld) & "&7)) and " & yval & QSymbol(xcol[i]) & "&8" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, res1!fld, xcol[i])
                  Case Else
                    res2 = conn.Exec("select COUNT(fldencounterval) as tot from tblopvisit where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6 and fldpatientval in(select fldpatientval from tblpatientinfo where " & xval & QSymbol(res1!fld) & "&7) and " & yval & QSymbol(xcol[i]) & "&8)" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, res1!fld, xcol[i])
                End Select

              Case "Visit Department", "Visit Rate Plan", "Visit Outcome"
                Select sColumn
                  Case "Gender", "Surname", "District", "Municipality", "Service Rank", "Service Unit", "Service Category"
                    res2 = conn.Exec("select COUNT(fldencounterval) as tot from tblopvisit where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and " & xval & QSymbol(res1!fld) & "&7 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6 and fldpatientval in(select fldpatientval from tblpatientinfo where " & yval & QSymbol(xcol[i]) & "&8))" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, res1!fld, xcol[i])
                  Case "Visit Department", "Visit Rate Plan", "Visit Outcome"
                    res2 = conn.Exec("select COUNT(fldencounterval) as tot from tblopvisit where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and " & xval & QSymbol(res1!fld) & "&7 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6) and " & yval & QSymbol(xcol[i]) & "&8" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, res1!fld, xcol[i])
                  Case Else
                    res2 = conn.Exec("select COUNT(fldencounterval) as tot from tblopvisit where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and " & xval & QSymbol(res1!fld) & "&7 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6 and " & yval & QSymbol(xcol[i]) & "&8)" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, res1!fld, xcol[i])
                End Select

              Case Else
                Select sColumn
                  Case "Gender", "Surname", "District", "Municipality", "Service Rank", "Service Unit", "Service Category"
                    res2 = conn.Exec("select COUNT(fldencounterval) as tot from tblopvisit where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6 and " & xval & QSymbol(res1!fld) & "&7 and fldpatientval in(select fldpatientval from tblpatientinfo where " & yval & QSymbol(xcol[i]) & "&8))" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, res1!fld, xcol[i])
                  Case "Visit Department", "Visit Rate Plan", "Visit Outcome"
                    res2 = conn.Exec("select COUNT(fldencounterval) as tot from tblopvisit where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6 and " & xval & QSymbol(res1!fld) & "&7) and " & yval & QSymbol(xcol[i]) & "&8" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, res1!fld, xcol[i])
                  Case Else
                    res2 = conn.Exec("select COUNT(fldencounterval) as tot from tblopvisit where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6 and " & xval & QSymbol(res1!fld) & "&7 and " & yval & QSymbol(xcol[i]) & "&8)" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, res1!fld, xcol[i])
                End Select
            End Select
            If res2!tot Then
              xtot = xtot + res2!tot
              .Add(modReportVar.GetLocaleNumberFormat(res2!tot, 0))
            Else
              .Add(modReportVar.GetLocaleNumberFormat(0, 0))
            Endif
          Next
          .Add(modReportVar.GetLocaleNumberFormat(xtot, 0))

        End With
        $BillingReport.Add(asx)
        asx.Clear()
      Next

      With asx
        .Add("")

        aTot = 0
        For i = 1 To xcol.Count - 2
          Select sRow
            Case "Gender", "Surname", "District", "Municipality", "Ethnic Group", "Service Rank", "Service Unit", "Service Category"
              Select sColumn
                Case "Gender", "Surname", "District", "Municipality", "Service Rank", "Service Unit", "Service Category"
                  res3 = conn.Exec("select COUNT(fldencounterval) as tot from tblopvisit where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6 and fldpatientval in(select fldpatientval from tblpatientinfo where " & yval & QSymbol(xcol[i]) & "&7))" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, xcol[i])
                Case "Visit Department", "Visit Rate Plan", "Visit Outcome"
                  res3 = conn.Exec("select COUNT(fldencounterval) as tot from tblopvisit where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6) and " & yval & QSymbol(xcol[i]) & "&7" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, xcol[i])
                Case Else
                  res3 = conn.Exec("select COUNT(fldencounterval) as tot from tblopvisit where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6 and " & yval & QSymbol(xcol[i]) & "&7)" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, xcol[i])
              End Select

            Case "Visit Department", "Visit Rate Plan", "Visit Outcome"
              Select sColumn
                Case "Gender", "Surname", "District", "Municipality", "Service Rank", "Service Unit", "Service Category"
                  res3 = conn.Exec("select COUNT(fldencounterval) as tot from tblopvisit where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6 and fldpatientval in(select fldpatientval from tblpatientinfo where " & yval & QSymbol(xcol[i]) & "&7))" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, xcol[i])
                Case "Visit Department", "Visit Rate Plan", "Visit Outcome"
                  res3 = conn.Exec("select COUNT(fldencounterval) as tot from tblopvisit where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6) and " & yval & QSymbol(xcol[i]) & "&7" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, xcol[i])
                Case Else
                  res3 = conn.Exec("select COUNT(fldencounterval) as tot from tblopvisit where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6 and " & yval & QSymbol(xcol[i]) & "&7)" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, xcol[i])
              End Select

            Case Else
              Select sColumn
                Case "Gender", "Surname", "District", "Municipality", "Service Rank", "Service Unit", "Service Category"
                  res3 = conn.Exec("select COUNT(fldencounterval) as tot from tblopvisit where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6 and fldpatientval in(select fldpatientval from tblpatientinfo where " & yval & QSymbol(xcol[i]) & "&7))" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, xcol[i])
                Case "Visit Department", "Visit Rate Plan", "Visit Outcome"
                  res3 = conn.Exec("select COUNT(fldencounterval) as tot from tblopvisit where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6) and " & yval & QSymbol(xcol[i]) & "&7" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, xcol[i])
                Case Else
                  res3 = conn.Exec("select COUNT(fldencounterval) as tot from tblopvisit where fldconsultname like &1 and fldcomp like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6 and " & yval & QSymbol(xcol[i]) & "&7)" & xstr, sDept, sComp, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sVisit, xcol[i])
              End Select
          End Select
          If res3!tot Then
            aTot = aTot + res3!tot
            .Add(modReportVar.GetLocaleNumberFormat(res3!tot, 0))
          Else
            .Add(modReportVar.GetLocaleNumberFormat(0, 0))
          Endif
        Next
        .Add(modReportVar.GetLocaleNumberFormat(aTot, 0))

      End With
      $BillingReport.Add(asx)
      asx.Clear()

    Endif

  Endif
  Return $BillingReport.NewHTMLPath()

End

Public Function SummaryOPVisitSelectedAgeEncounter(conn As Connection, dt1 As Date, dt2 As Date, sRow As String, sColumn As String, sBillMode As String, sComp As String, sVisit As String, sDept As String, sLocaType As String, sLocation As String) As String

  Dim $BillingReport As CReportHTML
  Dim sql1 As String
  Dim asx As New String[0]
  Dim agegrp As String[]
  Dim agegendergrp As String[]
  Dim agesql As String
  Dim ageval As String[]
  Dim genval As String[]

  Dim res1 As Result
  Dim xval As String
  Dim xcol As String[]
  Dim res2 As Result
  Dim dtlst As Date[]
  Dim dt As Date
  Dim i As Integer
  Dim xtot As Float
  Dim res3 As Result
  Dim aTot As Integer

  Dim coltime As String
  Dim xdateform As String
  Dim xfirdate As Date
  Dim xlasdate As Date
  Dim chapdate As String
  Dim xstr As String

  xstr = modDataRepo.GetWhereStringRepo(sLocaType, sLocation, "tblopvisit")
  coltime = "tblopvisit.fldconsulttime"
  xval = modMedReports.GetColumnEncounter(sRow)
  agegrp = modMedReports.AgeGroupNameList()
  agegendergrp = modMedReports.AgeGroupGenderList()
  agesql = modMedReports.GetAgeStringByTable("tblencounter", conn)

  xcol = New String[]
  xcol.Add(UCase(sRow))
  If sColumn = "Age Group" Then
    xcol.Insert(agegrp)
  Else If sColumn = "Age Group (Gender)" Then
    xcol.Insert(agegendergrp)
  Endif
  xcol.Add("TOTAL")

  $BillingReport = New CReportHTML(xcol, "", "")
  $BillingReport.UserData.Add("Dept: " & sDept & " Visit:" & sVisit & " Location:" & sComp & " Mode:" & sBillMode & " Date: " & modReportVar.GetDateTimeReport(dt1, gb.MediumDate) & " TO " & modReportVar.GetDateTimeReport(dt2, gb.MediumDate), "PARAM1")
  $BillingReport.UserData.Add("TOTAL COUNT: " & modReportVar.GetLocaleNumberFormat(TotalSelectedPatientOPVisit(conn, dt1, dt2, sBillMode, sComp, sVisit, sDept, sLocaType, sLocation), 0), "PARAM2")

  If sRow = "Year" Or If sRow = "Month" Or If sRow = "Date" Then
    xdateform = modSettings.ShowSettingFromFIle("HealthReport/RowDateFormat")

    If sRow = "Year" Then
      If modBasic.$DateFormat = "BS Date" Then
        dtlst = modDate.GetSelectDateBSArrayBetween(gb.Year, dt1, dt2)
      Else
        dtlst = modDate.GetSelectDateArrayBetween(gb.Year, dt1, dt2)
      Endif
    Else If sRow = "Month" Then
      If modBasic.$DateFormat = "BS Date" Then
        dtlst = modDate.GetSelectDateBSArrayBetween(gb.Month, dt1, dt2)
      Else
        dtlst = modDate.GetSelectDateArrayBetween(gb.Month, dt1, dt2)
      Endif
    Else
      dtlst = modDate.GetSelectDateArrayBetween(gb.Day, dt1, dt2)
    Endif
    For Each dt In dtlst
      If sRow = "Year" Then
        If modBasic.$DateFormat = "BS Date" Then
          chapdate = modDate.DateFormatViewBS(dt, "YearOnly")
          xfirdate = modDate.StartSqlYearBS(dt)
          xlasdate = modDate.EndSqlYearBS(dt)
        Else
          chapdate = Format(dt, "yyyy")
          xfirdate = modDate.StartSqlYear(dt)
          xlasdate = modDate.EndSqlYear(dt)
        Endif
      Else If sRow = "Month" Then
        If modBasic.$DateFormat = "BS Date" Then
          chapdate = modDate.DateFormatViewBS(dt, "YearMonth")
          xfirdate = modDate.StartSqlMonthBS(dt)
          xlasdate = modDate.EndSqlMonthBS(dt)
        Else
          chapdate = Format(dt, "mmm yyyy")
          xfirdate = modDate.StartSqlMonth(dt)
          xlasdate = modDate.EndSqlMonth(dt)
        Endif
      Else
        If xdateform = "Disable" Then
          chapdate = modReportVar.GetDateTimeReport(dt, gb.MediumDate)
        Else
          chapdate = modReportVar.GetDateTimeReport(dt, gb.MediumDate) & " [" & modDate.GetWeekDay(dt) & "]"
        Endif
        xfirdate = modDate.StartSqlDate(dt)
        xlasdate = modDate.EndSqlDate(dt)
      Endif

      With asx
        .Add(chapdate)
        xtot = 0

        If sColumn = "Age Group" Then
          For i = 1 To xcol.Count - 2
            ageval = Split(modMedReports.GetAgeValuefromgroup(xcol[i]), ";")
            res2 = conn.Exec("select COUNT(tblopvisit.fldencounterval) as tot from (tblopvisit inner join tblencounter on tblopvisit.fldencounterval=tblencounter.fldencounterval) inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblopvisit.fldconsultname like &1 and tblencounter.fldvisit like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and tblopvisit.fldbillingmode like &5 and tblopvisit.fldcomp like &6 and " & agesql & ">=&7 and " & agesql & "<&8" & xstr, sDept, sVisit, xfirdate, xlasdate, sBillMode, sComp, CLong(ageval[0]), CLong(ageval[1]))                                                          ''
            If res2!tot Then
              xtot = xtot + res2!tot
              .Add(modReportVar.GetLocaleNumberFormat(res2!tot, 0))
            Else
              .Add(modReportVar.GetLocaleNumberFormat(0, 0))
            Endif
          Next
        Else If sColumn = "Age Group (Gender)" Then
          For i = 1 To xcol.Count - 2
            genval = Split(xcol[i], ":")
            ageval = Split(modMedReports.GetAgeValuefromgroup(genval[0]), ";")
            res2 = conn.Exec("select COUNT(tblopvisit.fldencounterval) as tot from (tblopvisit inner join tblencounter on tblopvisit.fldencounterval=tblencounter.fldencounterval) inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblopvisit.fldconsultname like &1 and tblencounter.fldvisit like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and tblopvisit.fldbillingmode like &5 and tblopvisit.fldcomp like &6 and " & agesql & ">=&7 and " & agesql & "<&8 and tblpatientinfo.fldptsex=&9" & xstr, sDept, sVisit, xfirdate, xlasdate, sBillMode, sComp, CLong(ageval[0]), CLong(ageval[1]), genval[1])                                                          ''
            If res2!tot Then
              xtot = xtot + res2!tot
              .Add(modReportVar.GetLocaleNumberFormat(res2!tot, 0))
            Else
              .Add(modReportVar.GetLocaleNumberFormat(0, 0))
            Endif
          Next
        Endif

        .Add(modReportVar.GetLocaleNumberFormat(xtot, 0))
      End With
      $BillingReport.Add(asx)
      asx.Clear()
    Next

    With asx
      .Add("")
      aTot = 0

      If sColumn = "Age Group" Then
        For i = 1 To xcol.Count - 2
          ageval = Split(modMedReports.GetAgeValuefromgroup(xcol[i]), ";")
          res3 = conn.Exec("select COUNT(tblopvisit.fldencounterval) as tot from (tblopvisit inner join tblencounter on tblopvisit.fldencounterval=tblencounter.fldencounterval) inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblopvisit.fldconsultname like &1 and tblencounter.fldvisit like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and tblopvisit.fldbillingmode like &5 and tblopvisit.fldcomp like &6 and " & agesql & ">=&7 and " & agesql & "<&8" & xstr, sDept, sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sComp, CLong(ageval[0]), CLong(ageval[1]))                                                          ''
          If res3!tot Then
            aTot = aTot + res3!tot
            .Add(modReportVar.GetLocaleNumberFormat(res3!tot, 0))
          Else
            .Add(modReportVar.GetLocaleNumberFormat(0, 0))
          Endif
        Next
      Else If sColumn = "Age Group (Gender)" Then
        For i = 1 To xcol.Count - 2
          genval = Split(xcol[i], ":")
          ageval = Split(modMedReports.GetAgeValuefromgroup(genval[0]), ";")
          res3 = conn.Exec("select COUNT(tblopvisit.fldencounterval) as tot from (tblopvisit inner join tblencounter on tblopvisit.fldencounterval=tblencounter.fldencounterval) inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblopvisit.fldconsultname like &1 and tblencounter.fldvisit like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and tblopvisit.fldbillingmode like &5 and tblopvisit.fldcomp like &6 and " & agesql & ">=&7 and " & agesql & "<&8 and tblpatientinfo.fldptsex=&9" & xstr, sDept, sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sComp, CLong(ageval[0]), CLong(ageval[1]), genval[1])                                                          ''
          If res3!tot Then
            aTot = aTot + res3!tot
            .Add(modReportVar.GetLocaleNumberFormat(res3!tot, 0))
          Else
            .Add(modReportVar.GetLocaleNumberFormat(0, 0))
          Endif
        Next
      Endif

      .Add(modReportVar.GetLocaleNumberFormat(aTot, 0))
    End With
    $BillingReport.Add(asx)
    asx.Clear()

  Else

    Select sRow
      Case "Gender", "Surname", "District", "Municipality", "Ethnic Group", "Service Rank", "Service Unit", "Service Category"
        sql1 = Subst("select distinct(&1) as fld from tblpatientinfo", xval)
        res1 = conn.Exec(sql1 & "  where fldpatientval in(select fldpatientval from tblencounter where fldvisit like &1 and fldencounterval in(select fldencounterval from tblopvisit where " & coltime & ">=&2 and " & coltime & "<=&3 and fldbillingmode like &4 and fldcomp like &5)) ORDER BY " & xval & " ASC", sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sComp)
      Case Else
        sql1 = Subst("select distinct(&1) as fld from tblencounter", xval)
        res1 = conn.Exec(sql1 & " where fldvisit like &1 and fldencounterval in(select fldencounterval from tblopvisit where " & coltime & ">=&2 and " & coltime & "<=&3 and fldbillingmode like &4 and fldcomp like &5)" & modDataRepo.GetWhereStringRepo(sLocaType, sLocation) & " ORDER BY " & xval & " ASC", sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sComp)
    End Select
    If res1.Available Then

      For Each res1
        With asx
          .Add(res1!fld)
          xtot = 0

          If sColumn = "Age Group" Then
            For i = 1 To xcol.Count - 2
              ageval = Split(modMedReports.GetAgeValuefromgroup(xcol[i]), ";")
              res2 = conn.Exec("select COUNT(tblopvisit.fldencounterval) as tot from (tblopvisit inner join tblencounter on tblopvisit.fldencounterval=tblencounter.fldencounterval) inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblopvisit.fldconsultname like &1 and tblencounter.fldvisit like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and tblopvisit.fldbillingmode like &5 and tblopvisit.fldcomp like &6 and " & agesql & ">=&7 and " & agesql & "<&8 and " & xval & "=&9" & xstr, sDept, sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sComp, CLong(ageval[0]), CLong(ageval[1]), res1!fld)                                                          ''
              If res2!tot Then
                xtot = xtot + res2!tot
                .Add(modReportVar.GetLocaleNumberFormat(res2!tot, 0))
              Else
                .Add(modReportVar.GetLocaleNumberFormat(0, 0))
              Endif
            Next
          Else If sColumn = "Age Group (Gender)" Then
            For i = 1 To xcol.Count - 2
              genval = Split(xcol[i], ":")
              ageval = Split(modMedReports.GetAgeValuefromgroup(genval[0]), ";")
              res2 = conn.Exec("select COUNT(tblopvisit.fldencounterval) as tot from (tblopvisit inner join tblencounter on tblopvisit.fldencounterval=tblencounter.fldencounterval) inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblopvisit.fldconsultname like &1 and tblencounter.fldvisit like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and tblopvisit.fldbillingmode like &5 and tblopvisit.fldcomp like &6 and " & agesql & ">=&7 and " & agesql & "<&8 and " & xval & "=&9 and tblpatientinfo.fldptsex=&{10}" & xstr, sDept, sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sComp, CLong(ageval[0]), CLong(ageval[1]), res1!fld, genval[1])                                                          ''
              If res2!tot Then
                xtot = xtot + res2!tot
                .Add(modReportVar.GetLocaleNumberFormat(res2!tot, 0))
              Else
                .Add(modReportVar.GetLocaleNumberFormat(0, 0))
              Endif
            Next
          Endif

          .Add(modReportVar.GetLocaleNumberFormat(xtot, 0))
        End With
        $BillingReport.Add(asx)
        asx.Clear()
      Next

      With asx
        .Add("")
        aTot = 0

        If sColumn = "Age Group" Then
          For i = 1 To xcol.Count - 2
            ageval = Split(modMedReports.GetAgeValuefromgroup(xcol[i]), ";")
            res3 = conn.Exec("select COUNT(tblopvisit.fldencounterval) as tot from (tblopvisit inner join tblencounter on tblopvisit.fldencounterval=tblencounter.fldencounterval) inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblopvisit.fldconsultname like &1 and tblencounter.fldvisit like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and tblopvisit.fldbillingmode like &5 and tblopvisit.fldcomp like &6 and " & agesql & ">=&7 and " & agesql & "<&8 and " & xval & " like &9" & xstr, sDept, sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sComp, CLong(ageval[0]), CLong(ageval[1]), "%")                                                          ''
            If res3!tot Then
              aTot = aTot + res3!tot
              .Add(modReportVar.GetLocaleNumberFormat(res3!tot, 0))
            Else
              .Add(modReportVar.GetLocaleNumberFormat(0, 0))
            Endif
          Next
        Else If sColumn = "Age Group (Gender)" Then
          For i = 1 To xcol.Count - 2
            genval = Split(xcol[i], ":")
            ageval = Split(modMedReports.GetAgeValuefromgroup(genval[0]), ";")
            res3 = conn.Exec("select COUNT(tblopvisit.fldencounterval) as tot from (tblopvisit inner join tblencounter on tblopvisit.fldencounterval=tblencounter.fldencounterval) inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval where tblopvisit.fldconsultname like &1 and tblencounter.fldvisit like &2 and " & coltime & ">=&3 and " & coltime & "<=&4 and tblopvisit.fldbillingmode like &5 and tblopvisit.fldcomp like &6 and " & agesql & ">=&7 and " & agesql & "<&8 and " & xval & " like &9 and tblpatientinfo.fldptsex=&{10}" & xstr, sDept, sVisit, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sBillMode, sComp, CLong(ageval[0]), CLong(ageval[1]), "%", genval[1])                                                          ''
            If res3!tot Then
              aTot = aTot + res3!tot
              .Add(modReportVar.GetLocaleNumberFormat(res3!tot, 0))
            Else
              .Add(modReportVar.GetLocaleNumberFormat(0, 0))
            Endif
          Next
        Endif

        .Add(modReportVar.GetLocaleNumberFormat(aTot, 0))
      End With
      $BillingReport.Add(asx)
      asx.Clear()

    Endif

  Endif
  Return $BillingReport.NewHTMLPath()

End
