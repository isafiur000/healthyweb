' Gambas class file

Private $xAuthString As String
Private $HeadString As String

Private $PatCode As String
Private $CreditMedAmt As Float
Private $CreditOPDAmt As Float
Private $ExpiryDate As Date
Private $PolicyNo As String
Private $PayValue As Float
Private $PayType As String
Private $EligibilityVar As Variant[]

Private $PatDistrict As String
Private $PatFSPoint As String
Private $PatImage As String

Private Sub SetAuthentication()

  If modBasic.$IMISQuote = "Yes" Then
    $xAuthString = "'" & modBasic.$IMISUser & ":" & modBasic.$IMISPass & "'"
  Else
    $xAuthString = modBasic.$IMISUser & ":" & modBasic.$IMISPass
  Endif
  $HeadString = "remote-user:" & modBasic.$IMISRemoUser

End

Public Sub _new(sPatcode As String)

  $PatCode = sPatcode
  ShowFinancialParams()
  SetAllVariables()

End

Private Function GetFinancialDetails(sPatCode As String) As Collection

  Dim acmd As String
  Dim xurl As String
  Dim xcont As String
  Dim xcolVar As Collection
  Dim xcoll As Collection
  Dim xpatout As String
  Dim xResColl As Collection
  Dim xhead As String

  SetAuthentication()
  xurl = modBasic.$IMISEligibleURL
  xcont = "Content-Type: application/json"

  xcolVar = New Collection
  xcolVar.Add("EligibilityRequest", "resourceType")
  xcoll = New Collection
  xcoll.Add("Patient/" & sPatCode, "reference")
  xcolVar.Add(xcoll, "patient")

  xhead = Space(1)
  If modBasic.$IMISCACert = "Disable" Then
    xhead = xhead & "-k" & Space(1)
  Endif
  If modBasic.$IMISAgent Then
    xhead = xhead & "-A " & modBasic.$IMISAgent & Space(1)
  Endif

  acmd = "curl" & xhead & "-u " & $xAuthString & " -H " & Quote(xcont) & " -H " & Quote($HeadString) & " -d '" & JSON.Encode(xcolVar) & "' -X POST " & xurl
  modBasic.DebugAPIString(Replace("Execute " & acmd, $xAuthString, "****"))
  Shell acmd To xpatout
  modBasic.DebugAPIString("Response: " & xpatout)

  If xpatout Then
    Try xResColl = JSON.Decode(xpatout)
    If xResColl Then
      Return xResColl
    Else
      Message.Warning("Error in getting data", "OK")
    Endif
  Else
    Message.Warning("No Response from server", "OK")
  Endif

End

Private Sub ShowFinancialParams()

  Dim xVarPat As Collection
  Dim xVarElig As Variant[]

  Dim aVar As Variant[]
  Dim Row As Integer
  Dim xamt As String
  Dim xdate As String
  Dim asx As String[]

  Dim xexColl As Collection

  Dim xexten As Variant[]
  Dim xcoll As Collection
  Dim xdistrict As String
  Dim xfirserv As String
  Dim ximage As String
  Dim xPath As String

  Dim xeligCol As Collection
  Dim aColl As Collection

  xVarPat = GetFinancialDetails($PatCode)
  If xVarPat Then
    xVarElig = xVarPat["insurance"]
    ''policy collections
    If xVarElig And If xVarElig.Count Then
      $EligibilityVar = New Variant[]
      For Each xeligCol In xVarElig
        aColl = New Collection

        ' xamt = xeligCol["benefitBalance"][0]["financial"][0]["allowedMoney"]["value"]
        ' If xamt Then
        '   aColl.Add(CFloat(xamt), "Credit Limit")
        ' Else
        '   aColl.Add(0, "Credit Limit")
        ' Endif
        aVar = xeligCol["benefitBalance"]
        For Row = 0 To aVar.Count - 1
          If aVar[Row]["category"]["text"] = "medical" Then
            xamt = aVar[Row]["financial"][0]["allowedMoney"]["value"]
            If xamt Then
              aColl.Add(CFloat(xamt), "Medical Credit Limit")
            Else
              aColl.Add(0, "Medical Credit Limit")
            Endif
          Else If aVar[Row]["category"]["text"] = "opd" Then
            xamt = aVar[Row]["financial"][0]["allowedMoney"]["value"]
            If xamt Then
              aColl.Add(CFloat(xamt), "OPD Credit Limit")
            Else
              aColl.Add(0, "OPD Credit Limit")
            Endif
          Endif
        Next

        xdate = xeligCol["contract"]["reference"]
        asx = Split(xdate, "/")
        If asx Then
          aColl.Add(asx[1], "Policy Name")
          aColl.Add(modDate.GetDateFromJSON(asx[2]), "Expiry Date")
        Else
          aColl.Add("", "Policy Name")
          aColl.Add("", "Expiry Date")
        Endif

        For Each xexColl In xeligCol["extension"]
          If xexColl["url"] = "https://hib.gov.np/fhir/FHIE+extension+Copayment" Then
            $PayValue = xexColl["valueDecimal"]
            $PayType = xexColl["valueString"]
            aColl.Add(CFloat(xexColl["valueDecimal"]), "Credit Value")
            aColl.Add(xexColl["valueString"], "Credit Type")
          Else
            aColl.Add(0, "Credit Value")
            aColl.Add("", "Credit Type")
          Endif
        Next
        $EligibilityVar.Add(aColl)
      Next
    Endif

    ''extra extensions
    xexten = xVarPat["extension"]
    If xexten And If xexten.Count Then
      For Each xcoll In xexten
        If xcoll["url"] = "https://hib.gov.np/fhir/FHIE+extension+Profile+District" Then
          xdistrict = xcoll["valueString"]
          If xdistrict Then
            $PatDistrict = xdistrict
          Endif
        Else If xcoll["url"] = "https://hib.gov.np/fhir/FHIE+extension+Profile+FSP" Then
          xfirserv = xcoll["valueString"]
          If xfirserv Then
            $PatFSPoint = xfirserv
          Endif
        Else If xcoll["url"] = "https://hib.gov.np/fhir/FHIE+extension+Profile+Photo+Url" Then
          ximage = xcoll["valueString"]
          If ximage Then
            If File.Ext(ximage) Then
              xPath = Temp() & "." & File.Ext(ximage)
            Else
              xPath = Temp()
            Endif
            modDevAll.GetWgetDownload(ximage, xPath)
            If Exist(xPath) Then
              $PatImage = xPath
            Endif
          Endif
        Endif
      Next
    Endif

  Else
    Message.Warning("Error in Decoding data", "OK")
  Endif

End

''Policy Collection
Public Function GetPatientPolicyData() As Variant[]

  Return $EligibilityVar

End

''extra extensions
Public Function GetPatientDistrict() As String

  Return $PatDistrict

End

Public Function GetPatientFirstService() As String

  Return $PatFSPoint

End

Public Function GetPatientImage() As String

  Return $PatImage

End

''get variables
Private Sub SetAllVariables()

  Dim aColl As Collection
  Dim xColl As Collection

  For Each aColl In $EligibilityVar
    If aColl["OPD Credit Limit"] >= 500 Or If aColl["Medical Credit Limit"] >= 500 Then
      If aColl["Expiry Date"] >= modDate.StartSqlDate(Now()) Then
        If aColl["Policy Name"] = "HIB-3500" Then
          xColl = aColl
          Break
        Endif
      Endif
    Endif
  Next

  If Not xcoll Then
    For Each aColl In $EligibilityVar
      If aColl["OPD Credit Limit"] >= 500 Or If aColl["Medical Credit Limit"] >= 500 Then
        If aColl["Expiry Date"] >= modDate.StartSqlDate(Now()) Then
          xcoll = aColl
          Break
        Endif
      Endif
    Next
  Endif

  If xcoll Then
    $PolicyNo = xcoll["Policy Name"]
    $ExpiryDate = xcoll["Expiry Date"]
    $CreditMedAmt = xcoll["Medical Credit Limit"]
    $CreditOPDAmt = xcoll["OPD Credit Limit"]
    $PayValue = xcoll["Credit Value"]
    $PayType = xcoll["Credit Type"]
  Endif

End

Public Function GetPolicyNo() As String

  Return $PolicyNo

End

Public Function GetexpiryDaye() As Date

  Return $ExpiryDate

End

Public Function GetAllowedMedAmt() As Float

  Return $CreditMedAmt

End

Public Function GetAllowedOPDAmt() As Float

  Return $CreditOPDAmt

End

Public Function GetCopayValue() As Float

  Return $PayValue

End

Public Function PatientPayType() As String

  Return $PayType

End
