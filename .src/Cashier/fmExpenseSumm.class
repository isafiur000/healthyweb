' Gambas class file

Private $encid As String

Public Sub _new(encid As String)

  $encid = encid
  ShowAccParams()

End

Private Sub ShowAccParams()

  Dim xtotCredit As Float
  Dim xtotCash As Float
  Dim xipdCredit As Float
  Dim xipdCash As Float
  Dim xoutCredit As Float
  Dim xoutCash As Float

  Dim xpayment As Float
  Dim xcurdepo As Float
  Dim xdeposit As Float

  Dim xdoa As Date
  Dim res1 As Result
  Dim res2 As Result

  xdoa = modPatient.GetAdmissionDate($encid)
  res1 = modDatabase.$myConn.Exec("select " & modNonMedical.CashCreditSQL() & " from tblpatbilling where fldencounterval=&1 and fldsave=&2", $encid, True)
  If res1.Available Then
    If res1["xcredit"] Then
      xtotCredit = res1["xcredit"]
    Else
      xtotCredit = 0
    Endif
    If res1["xcash"] Then
      xtotCash = res1["xcash"]
    Else
      xtotCash = 0
    Endif
  Else
    xtotCredit = 0
    xtotCash = 0
  Endif

  res2 = modDatabase.$myConn.Exec("select " & modNonMedical.CashCreditSQL() & " from tblpatbilling where fldencounterval=&1 and fldsave=&2 and fldtime>=&3", $encid, True, xdoa)
  If res2.Available Then
    If res2["xcredit"] Then
      xipdCredit = res2["xcredit"]
    Else
      xipdCredit = 0
    Endif
    If res2["xcash"] Then
      xipdCash = res2["xcash"]
    Else
      xipdCash = 0
    Endif
  Else
    xipdCredit = 0
    xipdCash = 0
  Endif

  xoutCredit = xtotCredit - xipdCredit
  xoutCash = xtotCash - xipdCash

  txtopdexpensecredit.Value = xoutCredit
  txtopdexpensecash.Value = xoutCash

  txtipdexpensecredit.Value = xipdCredit
  txtipdexpensecash.Value = xipdCash

  txttotalexpensecredit.Value = xtotCredit
  txttotalexpensecash.Value = xtotCash

  ''-------------------- Payments------------------------
  xdeposit = modNonMedical.GetPatientDeposit(modDatabase.$myConn, $encid)
  xpayment = modNonMedical.InvoicePaidAmountbyPatient(modDatabase.$myConn, $encid)
  xcurdepo = (xdeposit + xpayment) - xtotCash

  txtcurrdeposit.Value = xdeposit
  txtinvreceipt.Value = xpayment
  txtsurplusamt.Value = xcurdepo

  txtcharitylimit.Value = modNonMedical.GetPatCharityLimit($encid)
  txtcreditlimit.Value = modNonMedical.ShowCreditLimitEnc($encid)

End

Public Sub btnclose_Click()

  Me.Close()

End
