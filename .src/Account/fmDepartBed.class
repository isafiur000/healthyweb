' Gambas class file

Private $Depart As String
Private $rData As Result
Private $aMyFields As String[]

Private $CategLst As String[]

Public Sub _new(sDepart As String)

  $Depart = sDepart
  lbldepart.Text = $Depart
  cmboxygen.List = ["Present", "Absent"]
  cmbventilator.List = ["Present", "Absent"]
  cmbother.List = ["Present", "Absent"]
  cmbstatus.List = ["Active", "Inactive"]  ''"Maintenance","Day Use"
  cmbservice.List = modControlSub.GetDirectFillresult(modDatabase.$myConn.Exec("select flditem as col from tblipdservice"))
  $CategLst = modControlSub.GetDirectFillresult(modDatabase.$icdConn.Exec("select distinct(fldicdchpter) as col from tblicddisease"))
  SHowDepartBed()

End

Public Sub btnaddservice_Click()

  Dim hForm As FmAddVarTwo
  Dim xx As String[]

  xx = New String[]
  hForm = New FmAddVarTwo("flditem", "flddiagnosis", "tblipdservice", xx, $CategLst)
  hForm.ShowModal
  cmbservice.List = modControlSub.GetDirectFillresult(modDatabase.$myConn.Exec("select flditem as col from tblipdservice"))

End

' ' Public Sub Form_KeyRelease()
' '
' '   If Key.Code = Key.Esc Then
' '     Me.Close
' '   Else
' '     modGeneralmain.GoToNextControlTab()
' '   Endif
' '
' ' End
' '
' ' Public Sub cmboxygen_KeyRelease()
' '
' '   modFillContainer.AutoFillComboBox(cmboxygen)
' '   modFillContainer.RestrictComboToContent(cmboxygen)
' '
' ' End
' '
' ' Public Sub cmbventilator_KeyRelease()
' '
' '   modFillContainer.AutoFillComboBox(cmbventilator)
' '   modFillContainer.RestrictComboToContent(cmbventilator)
' '
' ' End

Private Sub SHowDepartBed()

  Dim sql As String

  sql = "select fldbed,fldstatus,fldoxyport,fldventilator,fldother,fldservice from tbldepartmentbed where flddept=&1"           ''
  $rData = modDatabase.$myConn.Exec(sql, $Depart)
  $aMyFields = New String[]
  modGridView.ReadSmallData(GridView1, $rData, $aMyFields)
  With GridView1
    .Columns[0].Width = CStr(125 * modBasic.$AppWidthRatio) & "px"
    .Columns[1].Width = CStr(100 * modBasic.$AppWidthRatio) & "px"
    .Columns[2].Width = CStr(100 * modBasic.$AppWidthRatio) & "px"
    .Columns[3].Width = CStr(100 * modBasic.$AppWidthRatio) & "px"
    .Columns[4].Width = CStr(100 * modBasic.$AppWidthRatio) & "px"
    .Columns[5].Width = CStr(100 * modBasic.$AppWidthRatio) & "px"

    .Columns[0].Text = "Bed No"
    .Columns[1].Text = "Status"
    .Columns[2].Text = "Oxygen"
    .Columns[3].Text = "Ventilator"
    .Columns[4].Text = "Other"
    .Columns[5].Text = "Service"
  End With

End

Public Sub GridView1_Data(Row As Integer, Column As Integer, Data As WebTableData)

  $rData.MoveTo(Row)
  modGridView.GridViewDecoration(Data, Row)
  Data.Text = $rData[$aMyFields[Column]]

End

Private Sub BlankAllControl()

  txtbedno.Text = ""
  cmbservice.Text = ""
  cmboxygen.Text = ""
  cmbventilator.Text = ""
  cmbother.Text = ""
  cmbstatus.Text = ""

End

Public Sub GridView1_Select()

  If GridView1.Selection.Count Then
    $rData.MoveTo(GridView1.Selection[0])
    txtbedno.Text = $rData["fldbed"]
    cmbstatus.Text = $rData["fldstatus"]
    cmboxygen.Text = $rData["fldoxyport"]
    cmbventilator.Text = $rData["fldventilator"]
    cmbother.Text = $rData["fldother"]
    cmbservice.Text = $rData["fldservice"]
  Endif

End

Public Sub btnadd_Click()

  Dim res As Result
  Dim xIntVal As String

  If txtbedno.Text Then
    res = modDatabase.$myConn.Create("tbldepartmentbed")
    res["fldbed"] = Trim(txtbedno.Text)
    res["flddept"] = $Depart
    res["fldservice"] = cmbservice.Text
    res["fldoxyport"] = Trim(cmboxygen.Text)
    res["fldventilator"] = Trim(cmbventilator.Text)
    res["fldother"] = Trim(cmbother.Text)
    res["fldstatus"] = cmbstatus.Text
    res["fldencounterval"] = ""
    res["fldaddservice"] = ""
    res["fldflag"] = False
    res["fldfreedate"] = ""
    res["xyz"] = False
    If MMain.$WebEntry = True Then
      xIntVal = modString.GetDateString(Now())
      res["fldid"] = CLong(xIntVal)
      res["fldrepoid"] = modMisc.GetWebIndexStr(xIntVal)
      res["fldrepodate"] = Now()
      res["fldrepomac"] = CGI["REMOTE_ADDR"] & ":" & CGI["REMOTE_PORT"]
      res["fldhospcode"] = modBasic.$HospCode
    Endif
    res.Update
    SHowDepartBed()
    BlankAllControl()
    Me.Exec(Subst("Toastify({text: '&1', duration: &2}).showToast()", "Information saved", modBasic.$BalloonDelay))
    txtbedno.SetFocus
  Endif

End

Public Sub btnedit_Click()

  Dim res As Result

  If txtbedno.Text Then
    res = modDatabase.$myConn.Edit("tbldepartmentbed", "fldbed=&1", Trim(txtbedno.Text))
    res["fldservice"] = cmbservice.Text
    res["fldoxyport"] = Trim(cmboxygen.Text)
    res["fldventilator"] = Trim(cmbventilator.Text)
    res["fldother"] = Trim(cmbother.Text)
    res["fldstatus"] = cmbstatus.Text
    res["xyz"] = False
    res.Update
    SHowDepartBed()
    Me.Exec(Subst("Toastify({text: '&1', duration: &2}).showToast()", "Information updated", modBasic.$BalloonDelay))
  Endif

End

Public Sub mnudelete_Click()

  If txtbedno.Text Then
    modDatabase.$myConn.Delete("tbldepartmentbed", "fldbed=&1", Trim(txtbedno.Text))
    SHowDepartBed()
    Me.Exec(Subst("Toastify({text: '&1', duration: &2}).showToast()", "Information deleted", modBasic.$BalloonDelay))
    BlankAllControl()
  Endif

End

Public Sub btnexport_Click()

  modCHTMLReport.ExportGridToHTML(GridView1, $Depart, modReportVar.GetDateTimeReport(Now(), gb.GeneralDate))

End

Public Sub btnclose_Click()

  Me.Close()

End
