' Gambas module file

Private Sub AddExtraInforGroupBothReport($con As Connection, dt1 As Date, dt2 As Date, sInvoiced As Boolean, sComp As String, sDept As String, sDisc As String, sBillType As String, $BillingReport As CReportHTML, extColumn As Integer, sLocaType As String, sLocation As String, $tblpatbilling As String, $tblpatbilldetail As String, sNo As Boolean)

  Dim asx As New String[0]
  Dim res4 As Result
  Dim yextra As String
  Dim i As Integer

  Dim xitm As Float
  Dim xtax As Float
  Dim xdsc As Float
  Dim xcrdt As Float
  Dim xcash As Float
  Dim RepoStr As String
  Dim subt As Integer

  RepoStr = modDataRepo.GetWhereStringRepo(sLocaType, sLocation, "t1")
  yextra = " and t1.flditemname NOT IN(select flditemname from tblreportgroup)"
  If sInvoiced = True Then
    res4 = $con.Exec("select " & modNonMedical.CashCreditBillSQL("t1") & " from " & $tblpatbilling & " AS t1 inner join " & $tblpatbilldetail & " AS t2 ON t1.fldbillno=t2.fldbillno where t2.fldtime>=&1 and t2.fldtime<=&2 and t2.fldcomp like &4 and t1.fldsave=&3 and t1.fldbillingmode like &5 and t1.flddisctype like &6 and t1.fldbilltype like &7" & yextra & RepoStr, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), True, sComp, sDept, sDisc, sBillType)
  Else
    res4 = $con.Exec("select " & modNonMedical.CashCreditBillSQL("t1") & " from " & $tblpatbilling & " AS t1 where t1.fldtime>=&1 and t1.fldtime<=&2 and t1.fldsave=&3 and t1.fldcomp like &4 and t1.fldbillingmode like &5 and t1.flddisctype like &6 and t1.fldbilltype like &7" & yextra & RepoStr, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), True, sComp, sDept, sDisc, sBillType)
  Endif
  If res4.Available Then
    xitm = 0
    xtax = 0
    xdsc = 0
    subt = 0
    xcrdt = 0
    xcash = 0
    If res4["duemt"] Then
      xitm = res4["duemt"]
    Endif
    If res4["disctot"] Then
      xdsc = res4["disctot"]
    Endif
    If res4["taxtot"] Then
      xtax = res4["taxtot"]
    Endif
    If res4["xcredit"] Then
      xcrdt = res4["xcredit"]
    Endif
    If res4["xcash"] Then
      xcash = res4["xcash"]
    Endif

    With asx
      If sNo = True Then
        .Add("")
      Endif
      .Add("***")
      If extColumn Then
        For i = 1 To extColumn
          .Add("***")
        Next
      Endif
      .Add("***")
      .Add("***")
      .Add("***")
      .Add("***")
      .Add("***")
    End With
    $BillingReport.Add(asx)
    asx.Clear()
    With asx
      If sNo = True Then
        .Add("")
      Endif
      .Add("NOT GROUPED")
      If extColumn Then
        For i = 1 To extColumn
          .Add("***")
        Next
      Endif
      .Add(modReportVar.GetLocaleNumberFormat(xitm, gb.Currency))
      .Add(modReportVar.GetLocaleNumberFormat(xdsc, gb.Currency))
      .Add(modReportVar.GetLocaleNumberFormat(xtax, gb.Currency))
      .Add(modReportVar.GetLocaleNumberFormat(xcrdt, gb.Currency))
      .Add(modReportVar.GetLocaleNumberFormat(xcash, gb.Currency))
    End With
    $BillingReport.Add(asx)
    asx.Clear()
  Endif

End

Public Function ServiceGroupSummaryReport($con As Connection, dt1 As Date, dt2 As Date, sInvoiced As Boolean, sComp As String, sDept As String, sDisc As String, sBillType As String, sLocaType As String, sLocation As String, $tblpatbilling As String, $tblpatbilldetail As String) As String

  Dim $BillingReport As CReportHTML
  Dim asx As New String[0]
  Dim lst As String[]
  Dim aitm As Float
  Dim adsc As Float
  Dim atax As Float
  Dim acrdt As Float
  Dim acash As Float
  Dim xx As String
  Dim res4 As Result

  Dim xcnt As Float
  Dim xitm As Float
  Dim xtax As Float
  Dim xdsc As Float
  Dim xcrdt As Float
  Dim xcash As Float
  Dim RepoStr As String

  RepoStr = modDataRepo.GetWhereStringRepo(sLocaType, sLocation, "t1")
  $BillingReport = New CReportHTML([("PARTICULARS"), ("COUNT"), ("GROSS"), ("DISCOUNT"), ("TAX"), ("CREDIT"), ("CASH")], "", "")
  $BillingReport.UserData.Add(" COMP: " & sComp & " RATE: " & sDept & " SCHEME: " & sDisc, "PARAM1")
  $BillingReport.UserData.Add("DATE: " & modReportVar.GetDateTimeReport(dt1, gb.MediumDate) & " TO " & modReportVar.GetDateTimeReport(dt2, gb.MediumDate), "PARAM2")
  lst = modNonMedical.GetGroupNameAccount()

  aitm = 0
  adsc = 0
  atax = 0
  acrdt = 0
  acash = 0
  For Each xx In lst
    If sInvoiced = True Then
      res4 = $con.Exec("select SUM(t1.flditemqty) as itemcnt," & modNonMedical.CashCreditBillSQL("t1") & " from " & $tblpatbilling & " AS t1 inner join " & $tblpatbilldetail & " AS t2 ON t1.fldbillno=t2.fldbillno where t1.flditemname in(select flditemname from tblreportgroup where fldgroup=&1) and t2.fldtime>=&2 and t2.fldtime<=&3 and t2.fldcomp like &5 and t1.fldsave=&4 and t1.fldbillingmode like &6 and t1.flddisctype like &7" & RepoStr, xx, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), True, sComp, sDept, sDisc)
    Else
      res4 = $con.Exec("select SUM(t1.flditemqty) as itemcnt," & modNonMedical.CashCreditBillSQL("t1") & " from " & $tblpatbilling & " AS t1 where t1.flditemname in(select flditemname from tblreportgroup where fldgroup=&1) and t1.fldtime>=&2 and t1.fldtime<=&3 and t1.fldsave=&4 and t1.fldcomp like &5 and t1.fldbillingmode like &6 and t1.flddisctype like &7" & RepoStr, xx, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), True, sComp, sDept, sDisc)
    Endif
    xcnt = 0
    xitm = 0
    xtax = 0
    xdsc = 0
    xcrdt = 0
    xcash = 0
    If res4.Available = True Then
      If res4["itemcnt"] Then
        xcnt = res4["itemcnt"]
      Endif
      If res4["duemt"] Then
        xitm = res4["duemt"]
      Endif
      If res4["disctot"] Then
        xdsc = res4["disctot"]
      Endif
      If res4["taxtot"] Then
        xtax = res4["taxtot"]
      Endif
      If res4["xcredit"] Then
        xcrdt = res4["xcredit"]
      Endif
      If res4["xcash"] Then
        xcash = res4["xcash"]
      Endif
    Endif

    If Not xitm Then
    Else
      aitm = aitm + xitm
      adsc = adsc + xdsc
      atax = atax + xtax
      acrdt = acrdt + xcrdt
      acash = acash + xcash
      With asx
        .Add(xx)
        .Add(modReportVar.GetLocaleNumberFormat(xcnt, -2))
        .Add(modReportVar.GetLocaleNumberFormat(xitm, gb.Currency))
        .Add(modReportVar.GetLocaleNumberFormat(xdsc, gb.Currency))
        .Add(modReportVar.GetLocaleNumberFormat(xtax, gb.Currency))
        .Add(modReportVar.GetLocaleNumberFormat(xcrdt, gb.Currency))
        .Add(modReportVar.GetLocaleNumberFormat(xcash, gb.Currency))
      End With
      $BillingReport.Add(asx)
      asx.Clear()
    Endif
  Next

  With asx
    .Add("<b>GRAND TOTAL</b>")
    .Add("")
    .Add(modReportVar.GetLocaleNumberFormat(aitm, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(adsc, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(atax, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(acrdt, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(acash, gb.Currency))
  End With
  $BillingReport.Add(asx)
  asx.Clear()

  AddExtraInforGroupBothReport($con, dt1, dt2, sInvoiced, sComp, sDept, sDisc, sBillType, $BillingReport, 1, sLocaType, sLocation, $tblpatbilling, $tblpatbilldetail, False)

  Return $BillingReport.NewHTMLPath()

End

Public Function ServiceGroupDetailReport($con As Connection, dt1 As Date, dt2 As Date, sInvoiced As Boolean, sComp As String, sDept As String, sDisc As String, sBillType As String, sLocaType As String, sLocation As String, $tblpatbilling As String, $tblpatbilldetail As String) As String

  Dim $BillingReport As CReportHTML
  Dim asx As New String[0]
  Dim lst As String[]
  Dim gitm As Float
  Dim gdsc As Float
  Dim gtax As Float
  Dim gcrdt As Float
  Dim gcash As Float

  Dim aitm As Float
  Dim adsc As Float
  Dim atax As Float
  Dim acrdt As Float
  Dim acash As Float
  Dim xx As String
  Dim res1 As Result

  Dim rte As Float
  Dim qty As Float
  Dim xitm As Float
  Dim xtax As Float
  Dim xdsc As Float
  Dim xcrdt As Float
  Dim xcash As Float
  Dim RepoStr As String
  Dim i As Integer

  RepoStr = modDataRepo.GetWhereStringRepo(sLocaType, sLocation, "t1")
  $BillingReport = New CReportHTML([("SNO"), ("PARTICULARS"), ("RATE"), ("QTY"), ("GROSS"), ("DISCOUNT"), ("TAX"), ("CREDIT"), ("CASH")], "", "")
  $BillingReport.UserData.Add("COMP: " & sComp & " RATE: " & sDept & " SCHEME: " & sDisc, "PARAM1")
  $BillingReport.UserData.Add("DATE: " & modReportVar.GetDateTimeReport(dt1, gb.MediumDate) & " TO " & modReportVar.GetDateTimeReport(dt2, gb.MediumDate), "PARAM2")
  lst = modNonMedical.GetGroupNameAccount()

  aitm = 0
  adsc = 0
  atax = 0
  acrdt = 0
  acash = 0
  For Each xx In lst
    $BillingReport.AddSection(xx, True)

    gitm = 0
    gdsc = 0
    gtax = 0
    gcrdt = 0
    gcash = 0
    i = 1
    If sInvoiced = True Then
      res1 = $con.Exec("select t1.flditemname as flditemname,avg(t1.flditemrate) as rate,SUM(t1.flditemqty) as qnty," & modNonMedical.CashCreditBillSQL("t1") & " from " & $tblpatbilling & " AS t1 inner join " & $tblpatbilldetail & " AS t2 ON t1.fldbillno=t2.fldbillno where t2.fldtime>=&1 and t2.fldtime<=&2 and t2.fldcomp like &5 and t1.flditemname in(select flditemname from tblreportgroup where fldgroup=&3) and t1.fldsave=&4 and t1.fldbillingmode like &6 and t1.flddisctype like &7" & RepoStr & " GROUP BY t1.flditemname", modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), xx, True, sComp, sDept, sDisc)
    Else
      res1 = $con.Exec("select t1.flditemname as flditemname,avg(t1.flditemrate) as rate,SUM(t1.flditemqty) as qnty," & modNonMedical.CashCreditBillSQL("t1") & " from " & $tblpatbilling & " AS t1 where t1.fldtime>=&1 and t1.fldtime<=&2 and t1.flditemname in(select flditemname from tblreportgroup where fldgroup=&3) and t1.fldsave=&4 and t1.fldcomp like &5 and t1.fldbillingmode like &6 and t1.flddisctype like &7" & RepoStr & " GROUP BY t1.flditemname", modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), xx, True, sComp, sDept, sDisc)
    Endif
    If res1.Available = True Then
      For Each res1
        rte = 0
        qty = 0
        xitm = 0
        xtax = 0
        xdsc = 0
        xcrdt = 0
        xcash = 0
        If res1["rate"] Then
          rte = res1["rate"]
        Endif
        If res1["qnty"] Then
          qty = res1["qnty"]
        Endif
        If res1["duemt"] Then
          xitm = res1["duemt"]
        Endif
        If res1["disctot"] Then
          xdsc = res1["disctot"]
        Endif
        If res1["taxtot"] Then
          xtax = res1["taxtot"]
        Endif
        If res1["xcredit"] Then
          xcrdt = res1["xcredit"]
        Endif
        If res1["xcash"] Then
          xcash = res1["xcash"]
        Endif

        If Not qty And If Not xitm Then
        Else
          gitm = gitm + xitm
          gdsc = gdsc + xdsc
          gtax = gtax + xtax
          gcrdt = gcrdt + xcrdt
          gcash = gcash + xcash
          With asx
            .Add(CStr(i))
            .Add(modString.HTMLBlankSpace(3) & res1["flditemname"])
            .Add(modReportVar.GetLocaleNumberFormat(rte, gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(qty, -2))
            .Add(modReportVar.GetLocaleNumberFormat(xitm, gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(xdsc, gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(xtax, gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(xcrdt, gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(xcash, gb.Currency))
          End With
          $BillingReport.Add(asx)
          asx.Clear()
          i = i + 1
        Endif
      Next
    Endif

    aitm = aitm + gitm
    adsc = adsc + gdsc
    atax = atax + gtax
    acrdt = acrdt + gcrdt
    acash = acash + gcash
    With asx
      .Add("")
      .Add("SUBTOTAL: " & xx)
      .Add("")
      .Add("")
      .Add(modReportVar.GetLocaleNumberFormat(gitm, gb.Currency))
      .Add(modReportVar.GetLocaleNumberFormat(gdsc, gb.Currency))
      .Add(modReportVar.GetLocaleNumberFormat(gtax, gb.Currency))
      .Add(modReportVar.GetLocaleNumberFormat(gcrdt, gb.Currency))
      .Add(modReportVar.GetLocaleNumberFormat(gcash, gb.Currency))
    End With
    $BillingReport.Add(asx)
    asx.Clear()
    With asx
      .Add("...")
      .Add("...")
      .Add("...")
      .Add("...")
      .Add("...")
      .Add("...")
      .Add("...")
      .Add("...")
      .Add("...")
    End With
    $BillingReport.Add(asx)
    asx.Clear()
  Next

  With asx
    .Add("")
    .Add("<b>GRAND TOTAL</b>")
    .Add("")
    .Add("")
    .Add(modReportVar.GetLocaleNumberFormat(aitm, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(adsc, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(atax, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(acrdt, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(acash, gb.Currency))
  End With
  $BillingReport.Add(asx)
  asx.Clear()

  AddExtraInforGroupBothReport($con, dt1, dt2, sInvoiced, sComp, sDept, sDisc, sBillType, $BillingReport, 2, sLocaType, sLocation, $tblpatbilling, $tblpatbilldetail, True)

  Return $BillingReport.NewHTMLPath()

End

Public Function ServiceGroupDateReport($con As Connection, dt1 As Date, dt2 As Date, sInvoiced As Boolean, sComp As String, sDept As String, sDisc As String, sBillType As String, sDtType As String, sLocaType As String, sLocation As String, $tblpatbilling As String, $tblpatbilldetail As String) As String

  Dim $BillingReport As CReportHTML
  Dim asx As New String[0]
  Dim lst As String[]
  Dim gitm As Float
  Dim gdsc As Float
  Dim gtax As Float
  Dim gcrdt As Float
  Dim gcash As Float

  Dim xx As String
  Dim res1 As Result

  Dim qty As Float
  Dim dt As Date
  Dim dtlst As Date[]

  Dim aitm As Float
  Dim adsc As Float
  Dim atax As Float
  Dim acrdt As Float
  Dim acash As Float

  Dim xitm As Float
  Dim xdsc As Float
  Dim xtax As Float
  Dim xcrdt As Float
  Dim xcash As Float

  Dim xfirdate As Date
  Dim xlasdate As Date
  Dim chapdate As String
  Dim yregist As String
  Dim RepoStr As String

  RepoStr = modDataRepo.GetWhereStringRepo(sLocaType, sLocation, "t1")
  $BillingReport = New CReportHTML([("PARTICULARS"), ("QTY"), ("GROSS"), ("DISCOUNT"), ("TAX"), ("CREDIT"), ("CASH")], "", "")
  $BillingReport.UserData.Add("COMP: " & sComp & " RATE: " & sDept & " SCHEME: " & sDisc, "PARAM1")
  $BillingReport.UserData.Add("DATE: " & modReportVar.GetDateTimeReport(dt1, gb.MediumDate) & " TO " & modReportVar.GetDateTimeReport(dt2, gb.MediumDate), "PARAM2")

  If sDtType = "Year" Then
    If modBasic.$DateFormat = "BS Date" Then
      dtlst = modDate.GetSelectDateBSArrayBetween(gb.Year, dt1, dt2)
    Else
      dtlst = modDate.GetSelectDateArrayBetween(gb.Year, dt1, dt2)
    Endif
  Else If sDtType = "Month" Then
    If modBasic.$DateFormat = "BS Date" Then
      dtlst = modDate.GetSelectDateBSArrayBetween(gb.Month, dt1, dt2)
    Else
      dtlst = modDate.GetSelectDateArrayBetween(gb.Month, dt1, dt2)
    Endif
  Else
    dtlst = modDate.GetSelectDateArrayBetween(gb.Day, dt1, dt2)
  Endif
  lst = modNonMedical.GetGroupNameAccount()

  xitm = 0
  xdsc = 0
  xtax = 0
  xcrdt = 0
  xcash = 0
  For Each dt In dtlst
    If sDtType = "Year" Then
      If modBasic.$DateFormat = "BS Date" Then
        chapdate = modDate.DateFormatViewBS(dt, "YearOnly")
        xfirdate = modDate.StartSqlYearBS(dt)
        xlasdate = modDate.EndSqlYearBS(dt)
      Else
        chapdate = Format(dt, "yyyy")
        xfirdate = modDate.StartSqlYear(dt)
        xlasdate = modDate.EndSqlYear(dt)
      Endif
    Else If sDtType = "Month" Then
      If modBasic.$DateFormat = "BS Date" Then
        chapdate = modDate.DateFormatViewBS(dt, "YearMonth")
        xfirdate = modDate.StartSqlMonthBS(dt)
        xlasdate = modDate.EndSqlMonthBS(dt)
      Else
        chapdate = Format(dt, "mmm yyyy")
        xfirdate = modDate.StartSqlMonth(dt)
        xlasdate = modDate.EndSqlMonth(dt)
      Endif
    Else
      chapdate = modReportVar.GetDateTimeReport(dt, gb.MediumDate)
      xfirdate = modDate.StartSqlDate(dt)
      xlasdate = modDate.EndSqlDate(dt)
    Endif
    xfirdate = modDate.StartSqlDate(Max(dt1, xfirdate))
    xlasdate = modDate.EndSqlDate(Min(dt2, xlasdate))
    $BillingReport.AddSection(chapdate)

    aitm = 0
    adsc = 0
    atax = 0
    acrdt = 0
    acash = 0
    For Each xx In lst
      If sDisc = "%" Then
        yregist = ""
      Else
        yregist = " and t1.flddisctype like &8"
      Endif
      If sInvoiced = True Then
        res1 = $con.Exec("select SUM(t1.flditemqty) as qnty," & modNonMedical.CashCreditBillSQL("t1") & " from " & $tblpatbilling & " AS t1 inner join " & $tblpatbilldetail & " AS t2 ON t1.fldbillno=t2.fldbillno where t1.flditemname like &1 and t2.fldtime>=&2 and t2.fldtime<=&3 and t2.fldcomp like &6 and t1.flditemname in(select flditemname from tblreportgroup where fldgroup=&4) and t1.fldsave=&5 and t1.fldbillingmode like &7" & yregist & RepoStr, "%", xfirdate, xlasdate, xx, True, sComp, sDept, sDisc)
      Else
        res1 = $con.Exec("select SUM(t1.flditemqty) as qnty," & modNonMedical.CashCreditBillSQL("t1") & " from " & $tblpatbilling & " AS t1 where t1.flditemname like &1 and t1.fldtime>=&2 and t1.fldtime<=&3 and t1.flditemname in(select flditemname from tblreportgroup where fldgroup=&4) and t1.fldsave=&5 and t1.fldcomp like &6 and t1.fldbillingmode like &7" & yregist & RepoStr, "%", xfirdate, xlasdate, xx, True, sComp, sDept, sDisc)
      Endif
      qty = 0
      gitm = 0
      gdsc = 0
      gtax = 0
      gcrdt = 0
      gcash = 0
      If res1.Available Then
        If res1["qnty"] Then
          qty = res1["qnty"]
        Endif
        If res1["duemt"] Then
          gitm = res1["duemt"]
        Endif
        If res1["disctot"] Then
          gdsc = res1["disctot"]
        Endif
        If res1["taxtot"] Then
          gtax = res1["taxtot"]
        Endif
        If res1["xcredit"] Then
          gcrdt = res1["xcredit"]
        Endif
        If res1["xcash"] Then
          gcash = res1["xcash"]
        Endif
        If Not qty And If Not gitm Then
        Else
          aitm = aitm + gitm
          adsc = adsc + gdsc
          atax = atax + gtax
          acrdt = acrdt + gcrdt
          acash = acash + gcash
          With asx
            .Add(modString.HTMLBlankSpace(5) & xx)
            .Add(modReportVar.GetLocaleNumberFormat(qty, -2))
            .Add(modReportVar.GetLocaleNumberFormat(gitm, gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(gdsc, gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(gtax, gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(gcrdt, gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(gcash, gb.Currency))
          End With
          $BillingReport.Add(asx)
          asx.Clear()
        Endif
      Endif
    Next ''group name

    xitm = xitm + aitm
    xdsc = xdsc + adsc
    xtax = xtax + atax
    xcrdt = xcrdt + acrdt
    xcash = xcash + acash
    With asx
      .Add("SUBTOTAL: " & chapdate)
      .Add("")
      .Add(modReportVar.GetLocaleNumberFormat(aitm, gb.Currency))
      .Add(modReportVar.GetLocaleNumberFormat(adsc, gb.Currency))
      .Add(modReportVar.GetLocaleNumberFormat(atax, gb.Currency))
      .Add(modReportVar.GetLocaleNumberFormat(acrdt, gb.Currency))
      .Add(modReportVar.GetLocaleNumberFormat(acash, gb.Currency))
    End With
    $BillingReport.Add(asx)
    asx.Clear()

    With asx
      .Add("")
      .Add("")
      .Add("")
      .Add("")
      .Add("")
      .Add("")
      .Add("")
    End With
    $BillingReport.Add(asx)
    asx.Clear()
  Next ''date

  With asx
    .Add("<b>GRAND TOTAL</b>")
    .Add("")
    .Add(modReportVar.GetLocaleNumberFormat(xitm, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(xdsc, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(xtax, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(xcrdt, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(xcash, gb.Currency))
  End With
  $BillingReport.Add(asx)
  asx.Clear()

  AddExtraInforGroupBothReport($con, dt1, dt2, sInvoiced, sComp, sDept, sDisc, sBillType, $BillingReport, 1, sLocaType, sLocation, $tblpatbilling, $tblpatbilldetail, False)

  Return $BillingReport.NewHTMLPath()

End

Public Function GetGroupSUmmaryReportFormat($con As Connection, dt1 As Date, dt2 As Date, sBillMode As String, sDisc As String, sComp As String, sInvoiced As Boolean, sBillType As String, sOption As String, sLocaType As String, sLocation As String, $tblpatbilling As String, $tblpatbilldetail As String) As String

  Dim $BillingReport As CReportHTML
  Dim asx As New String[0]
  Dim xfield As String
  Dim yregist As String
  Dim grpList As String[]
  Dim grpName As String
  Dim xList As String[]
  Dim xType As String
  Dim res As Result
  Dim res2 As Result

  Dim xsubt As Float
  Dim xdisc As Float
  Dim xtax As Float
  Dim xcrdt As Float
  Dim xcash As Float

  Dim asubt As Float
  Dim adisc As Float
  Dim atax As Float
  Dim acrdt As Float
  Dim acash As Float

  Dim psubt As Float
  Dim pdisc As Float
  Dim ptax As Float
  Dim pcrdt As Float
  Dim pcash As Float
  Dim RepoStr As String

  RepoStr = modDataRepo.GetWhereStringRepo(sLocaType, sLocation, "t1")
  $BillingReport = New CReportHTML([("PARTICULARS"), ("GROSS"), ("DISCOUNT"), ("TAX"), ("CREDIT"), ("CASH")], "", "")
  $BillingReport.UserData.Add("GROUP REPORT BY " & sOption & " COMP: " & sComp & " RATE: " & sBillMode & " SCHEME: " & sDisc, "PARAM1")
  $BillingReport.UserData.Add("DATE: " & modReportVar.GetDateTimeReport(dt1, gb.MediumDate) & " TO " & modReportVar.GetDateTimeReport(dt2, gb.MediumDate), "PARAM2")
  grpList = modNonMedical.GetGroupNameAccount()

  xfield = modRHTMLSummary.GetFieldServiceSummary(sOption)

  If sInvoiced = True Then
    res = $con.Exec(Subst("select distinct(t1.&1) as col from " & $tblpatbilling, xfield) & " AS t1 inner join " & $tblpatbilldetail & " AS t2 ON t1.fldbillno=t2.fldbillno where t2.fldtime>=&1 and t2.fldtime<=&2 and t2.fldcomp like &4 and t1.fldsave=&3 and t1.fldbillingmode like &5 and t1.flddisctype like &6 and t1.fldbilltype like &7" & RepoStr, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), True, sComp, sBillMode, sDisc, sBillType)
  Else
    res = $con.Exec(Subst("select distinct(t1.&1) as col from " & $tblpatbilling, xfield) & " AS t1 where t1.fldtime>=&1 and t1.fldtime<=&2 and t1.fldsave=&3 and t1.fldcomp like &4 and t1.fldbillingmode like &5 and t1.flddisctype like &6 and t1.fldbilltype like &7" & RepoStr, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), True, sComp, sBillMode, sDisc, sBillType)
  Endif
  xList = modControlSub.GetDirectFillresultNoNull(res)
  xList.Add("Null")

  psubt = 0
  pdisc = 0
  ptax = 0
  pcrdt = 0
  pcash = 0
  For Each xType In xList
    $BillingReport.AddChapter(xType)

    asubt = 0
    adisc = 0
    atax = 0
    acrdt = 0
    acash = 0
    For Each grpName In grpList

      If sDisc = "%" And If sBillType = "%" Then
        yregist = ""
      Else
        yregist = " and t1.flddisctype like &7 and t1.fldbilltype like &8"
      Endif
      If xType = "Null" Then
        If sInvoiced = True Then
          res2 = $con.Exec("select " & modNonMedical.CashCreditBillSQL("t1") & " from " & $tblpatbilling & " AS t1 inner join " & $tblpatbilldetail & " AS t2 ON t1.fldbillno=t2.fldbillno where t1.flditemname in(select flditemname from tblreportgroup where fldgroup=&1) and t2.fldtime>=&2 and t2.fldtime<=&3 and t2.fldcomp like &5 and t1.fldsave=&4 and t1.fldbillingmode like &6" & yregist & " and t1." & xfield & " IS NULL" & RepoStr, grpName, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), True, sComp, sBillMode, sDisc, sBillType)
        Else
          res2 = $con.Exec("select " & modNonMedical.CashCreditBillSQL("t1") & " from " & $tblpatbilling & " AS t1 where t1.flditemname in(select flditemname from tblreportgroup where fldgroup=&1) and t1.fldtime>=&2 and t1.fldtime<=&3 and t1.fldsave=&4 and t1.fldcomp like &5 and t1.fldbillingmode like &6" & yregist & " and t1." & xfield & " IS NULL" & RepoStr, grpName, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), True, sComp, sBillMode, sDisc, sBillType)
        Endif
      Else
        If sInvoiced = True Then
          res2 = $con.Exec("select " & modNonMedical.CashCreditBillSQL("t1") & " from " & $tblpatbilling & " AS t1 inner join " & $tblpatbilldetail & " AS t2 ON t1.fldbillno=t2.fldbillno where t1.flditemname in(select flditemname from tblreportgroup where fldgroup=&1) and t2.fldtime>=&2 and t2.fldtime<=&3 and t2.fldcomp like &5 and t1.fldsave=&4 and t1.fldbillingmode like &6" & yregist & " and t1." & xfield & "=&9" & RepoStr, grpName, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), True, sComp, sBillMode, sDisc, sBillType, xType)
        Else
          res2 = $con.Exec("select " & modNonMedical.CashCreditBillSQL("t1") & " from " & $tblpatbilling & " AS t1 where t1.flditemname in(select flditemname from tblreportgroup where fldgroup=&1) and t1.fldtime>=&2 and t1.fldtime<=&3 and t1.fldsave=&4 and t1.fldcomp like &5 and t1.fldbillingmode like &6" & yregist & " and t1." & xfield & "=&9" & RepoStr, grpName, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), True, sComp, sBillMode, sDisc, sBillType, xType)
        Endif
      Endif
      If res2.Available Then
        xsubt = 0
        xdisc = 0
        xtax = 0
        xcrdt = 0
        xcash = 0
        If res2["duemt"] Then
          xsubt = res2["duemt"]
        Endif
        If res2["disctot"] Then
          xdisc = res2["disctot"]
        Endif
        If res2["taxtot"] Then
          xtax = res2["taxtot"]
        Endif
        If res2["xcredit"] Then
          xcrdt = res2["xcredit"]
        Endif
        If res2["xcash"] Then
          xcash = res2["xcash"]
        Endif

        asubt = asubt + xsubt
        adisc = adisc + xdisc
        atax = atax + xtax
        acrdt = acrdt + xcrdt
        acash = acash + xcash
        If xsubt Then
          With asx
            .Add(grpName)
            .Add(modReportVar.GetLocaleNumberFormat(xsubt, gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(xdisc, gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(xtax, gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(xcrdt, gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(xcash, gb.Currency))
          End With
          $BillingReport.Add(asx)
          asx.Clear()
        Endif
      Endif
    Next

    psubt = psubt + asubt
    pdisc = pdisc + adisc
    ptax = ptax + atax
    pcrdt = pcrdt + acrdt
    pcash = pcash + acash
    With asx
      .Add("TOTAL: " & xType)
      .Add(modReportVar.GetLocaleNumberFormat(asubt, gb.Currency))
      .Add(modReportVar.GetLocaleNumberFormat(adisc, gb.Currency))
      .Add(modReportVar.GetLocaleNumberFormat(atax, gb.Currency))
      .Add(modReportVar.GetLocaleNumberFormat(acrdt, gb.Currency))
      .Add(modReportVar.GetLocaleNumberFormat(acash, gb.Currency))
    End With
    $BillingReport.Add(asx)
    asx.Clear()
    With asx
      .Add("***")
      .Add("***")
      .Add("***")
      .Add("***")
      .Add("***")
      .Add("***")
    End With
    $BillingReport.Add(asx)
    asx.Clear()
  Next

  With asx
    .Add("GRAND TOTAL")
    .Add(modReportVar.GetLocaleNumberFormat(psubt, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(pdisc, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(ptax, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(pcrdt, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(pcash, gb.Currency))
  End With
  $BillingReport.Add(asx)
  asx.Clear()

  AddExtraInforGroupBothReport($con, dt1, dt2, sInvoiced, sComp, sBillMode, sDisc, sBillType, $BillingReport, 0, sLocaType, sLocation, $tblpatbilling, $tblpatbilldetail, False)

  Return $BillingReport.NewHTMLPath()

End

''=================== GROUP SUMMARY =======================
Private Sub AddExtraInforGroupreport($con As Connection, dt1 As Date, dt2 As Date, sInvoiced As Boolean, sComp As String, sDept As String, sDisc As String, sBillType As String, $BillingReport As CReportHTML, extColumn As Integer, sLocaType As String, sLocation As String, $tblpatbilling As String, $tblpatbilldetail As String)

  Dim asx As New String[0]
  Dim res4 As Result
  Dim yextra As String
  Dim i As Integer

  Dim xitm As Float
  Dim subt As Float
  Dim xtax As Float
  Dim xdsc As Float
  Dim RepoStr As String

  RepoStr = modDataRepo.GetWhereStringRepo(sLocaType, sLocation)
  yextra = " and t1.flditemname NOT IN(select flditemname from tblreportgroup)"
  If sInvoiced = True Then
    res4 = $con.Exec("select SUM(t1.flditemrate*t1.flditemqty) as itemtot,SUM(t1.flddiscamt) as dsc,SUM(t1.fldtaxamt) as tax,SUM(t1.fldditemamt) as tot from " & $tblpatbilling & " AS t1 inner join " & $tblpatbilldetail & " AS t2 ON t1.fldbillno=t2.fldbillno where t2.fldtime>=&1 and t2.fldtime<=&2 and t2.fldcomp like &4 and t1.fldsave=&3 and t1.fldbillingmode like &5 and t1.flddisctype like &6 and t1.fldbilltype like &7" & yextra & RepoStr, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), True, sComp, sDept, sDisc, sBillType)
  Else
    res4 = $con.Exec("select SUM(t1.flditemrate*t1.flditemqty) as itemtot,SUM(t1.flddiscamt) as dsc,SUM(t1.fldtaxamt) as tax,SUM(t1.fldditemamt) as tot from " & $tblpatbilling & " AS t1 where t1.fldtime>=&1 and t1.fldtime<=&2 and t1.fldsave=&3 and t1.fldcomp like &4 and t1.fldbillingmode like &5 and t1.flddisctype like &6 and t1.fldbilltype like &7" & yextra & RepoStr, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), True, sComp, sDept, sDisc, sBillType)
  Endif
  If res4.Available Then
    xitm = 0
    xtax = 0
    xdsc = 0
    subt = 0
    If res4["itemtot"] Then
      xitm = res4["itemtot"]
    Endif
    If res4["dsc"] Then
      xdsc = res4["dsc"]
    Endif
    If res4["tax"] Then
      xtax = res4["tax"]
    Endif
    If res4["tot"] Then
      subt = res4["tot"]
    Endif

    With asx
      .Add("***")
      If extColumn Then
        For i = 1 To extColumn
          .Add("***")
        Next
      Endif
      .Add("***")
      .Add("***")
      .Add("***")
      .Add("***")
    End With
    $BillingReport.Add(asx)
    asx.Clear()
    With asx
      .Add("NOT GROUPED")
      If extColumn Then
        For i = 1 To extColumn
          .Add("***")
        Next
      Endif
      .Add(modReportVar.GetLocaleNumberFormat(xitm, gb.Currency))
      .Add(modReportVar.GetLocaleNumberFormat(xdsc, gb.Currency))
      .Add(modReportVar.GetLocaleNumberFormat(xtax, gb.Currency))
      .Add(modReportVar.GetLocaleNumberFormat(subt, gb.Currency))
    End With
    $BillingReport.Add(asx)
    asx.Clear()
  Endif

End

Public Function ServiceGroupSummaryCashCredit($con As Connection, dt1 As Date, dt2 As Date, sInvoiced As Boolean, sComp As String, sDept As String, sDisc As String, sLocaType As String, sLocation As String, $tblpatbilling As String, $tblpatbilldetail As String) As String

  Dim $BillingReport As CReportHTML
  Dim asx As New String[0]
  Dim lst As String[]
  Dim crdt As Float
  Dim cash As Float
  Dim dsc As Float
  Dim tax As Float
  Dim tot As Float
  Dim xx As String
  Dim res2 As Result
  Dim res3 As Result
  Dim res4 As Result

  Dim xcrdt As Float
  Dim xcash As Float
  Dim subt As Float
  Dim xtax As Float
  Dim xdsc As Float
  Dim xmode As String
  Dim RepoStr As String

  RepoStr = modDataRepo.GetWhereStringRepo(sLocaType, sLocation, "t1")
  $BillingReport = New CReportHTML([("PARTICULARS"), ("CREDIT"), ("CASH"), ("DISCOUNT"), ("TAX"), ("TOTAL")], "", "")
  $BillingReport.UserData.Add("COMP: " & sComp & " RATE: " & sDept & " SCHEME: " & sDisc, "PARAM1")
  $BillingReport.UserData.Add("DATE: " & modReportVar.GetDateTimeReport(dt1, gb.MediumDate) & " TO " & modReportVar.GetDateTimeReport(dt2, gb.MediumDate), "PARAM2")

  crdt = 0
  cash = 0
  dsc = 0
  tax = 0
  tot = 0
  lst = modNonMedical.GetGroupNameAccount()
  For Each xx In lst
    xmode = " and t1.fldbilltype=&8"
    If sInvoiced = True Then
      res2 = $con.Exec("select SUM(t1.flditemrate*t1.flditemqty) as itemtot from " & $tblpatbilling & " AS t1 inner join " & $tblpatbilldetail & " AS t2 ON t1.fldbillno=t2.fldbillno where t1.flditemname in(select flditemname from tblreportgroup where fldgroup=&1) and t2.fldtime>=&2 and t2.fldtime<=&3 and t2.fldcomp like &5 and t1.fldsave=&4 and t1.fldbillingmode like &6 and t1.flddisctype like &7" & xmode & RepoStr, xx, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), True, sComp, sDept, sDisc, "Credit")
    Else
      res2 = $con.Exec("select SUM(t1.flditemrate*t1.flditemqty) as itemtot from " & $tblpatbilling & " AS t1 where t1.flditemname in(select flditemname from tblreportgroup where fldgroup=&1) and t1.fldtime>=&2 and t1.fldtime<=&3 and t1.fldsave=&4 and t1.fldcomp like &5 and t1.fldbillingmode like &6 and t1.flddisctype like &7" & xmode & RepoStr, xx, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), True, sComp, sDept, sDisc, "Credit")
    Endif
    If sInvoiced = True Then
      res3 = $con.Exec("select SUM(t1.flditemrate*t1.flditemqty) as itemtot from " & $tblpatbilling & " AS t1 inner join " & $tblpatbilldetail & " AS t2 ON t1.fldbillno=t2.fldbillno where t1.flditemname in(select flditemname from tblreportgroup where fldgroup=&1) and t2.fldtime>=&2 and t2.fldtime<=&3 and t2.fldcomp like &5 and t1.fldsave=&4 and t1.fldbillingmode like &6 and t1.flddisctype like &7" & xmode & RepoStr, xx, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), True, sComp, sDept, sDisc, "Cash")
    Else
      res3 = $con.Exec("select SUM(t1.flditemrate*t1.flditemqty) as itemtot from " & $tblpatbilling & " AS t1 where t1.flditemname in(select flditemname from tblreportgroup where fldgroup=&1) and t1.fldtime>=&2 and t1.fldtime<=&3 and t1.fldsave=&4 and t1.fldcomp like &5 and t1.fldbillingmode like &6 and t1.flddisctype like &7" & xmode & RepoStr, xx, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), True, sComp, sDept, sDisc, "Cash")
    Endif
    If sInvoiced = True Then
      res4 = $con.Exec("select SUM(t1.flddiscamt) as dsc,SUM(t1.fldtaxamt) as tax,SUM(t1.fldditemamt) as tot from " & $tblpatbilling & " AS t1 inner join " & $tblpatbilldetail & " AS t2 ON t1.fldbillno=t2.fldbillno where t1.flditemname in(select flditemname from tblreportgroup where fldgroup=&1) and t2.fldtime>=&2 and t2.fldtime<=&3 and t2.fldcomp like &5 and t1.fldsave=&4 and t1.fldbillingmode like &6 and t1.flddisctype like &7" & RepoStr, xx, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), True, sComp, sDept, sDisc)
    Else
      res4 = $con.Exec("select SUM(t1.flddiscamt) as dsc,SUM(t1.fldtaxamt) as tax,SUM(t1.fldditemamt) as tot from " & $tblpatbilling & " AS t1 where t1.flditemname in(select flditemname from tblreportgroup where fldgroup=&1) and t1.fldtime>=&2 and t1.fldtime<=&3 and t1.fldsave=&4 and t1.fldcomp like &5 and t1.fldbillingmode like &6 and t1.flddisctype like &7" & RepoStr, xx, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), True, sComp, sDept, sDisc)
    Endif
    xcrdt = 0
    xcash = 0
    xtax = 0
    xdsc = 0
    subt = 0
    If res2.Available Then
      If res2["itemtot"] Then
        xcrdt = res2["itemtot"]
      Endif
    Endif
    If res3.Available Then
      If res3["itemtot"] Then
        xcash = res3["itemtot"]
      Endif
    Endif
    If res4.Available = True Then
      If res4["dsc"] Then
        xdsc = res4["dsc"]
      Endif
      If res4["tax"] Then
        xtax = res4["tax"]
      Endif
      If res4["tot"] Then
        subt = res4["tot"]
      Endif
    Endif

    If Not xcrdt And If Not xcash Then
    Else
      crdt = crdt + xcrdt
      cash = cash + xcash
      dsc = dsc + xdsc
      tax = tax + xtax
      tot = tot + subt
      With asx
        .Add(xx)
        .Add(modReportVar.GetLocaleNumberFormat(xcrdt, gb.Currency))
        .Add(modReportVar.GetLocaleNumberFormat(xcash, gb.Currency))
        .Add(modReportVar.GetLocaleNumberFormat(xdsc, gb.Currency))
        .Add(modReportVar.GetLocaleNumberFormat(xtax, gb.Currency))
        .Add(modReportVar.GetLocaleNumberFormat(subt, gb.Currency))
      End With
      $BillingReport.Add(asx)
      asx.Clear()
    Endif
  Next

  With asx
    .Add("<b>GRAND TOTAL</b>")
    .Add(modReportVar.GetLocaleNumberFormat(crdt, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(cash, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(dsc, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(tax, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(tot, gb.Currency))
  End With
  $BillingReport.Add(asx)
  asx.Clear()

  Return $BillingReport.NewHTMLPath()

End

Public Function ServiceGroupSingleReport($con As Connection, dt1 As Date, dt2 As Date, sInvoiced As Boolean, sDept As String, sComp As String, sDisc As String, sBillType As String, sGroup As String, sLocaType As String, sLocation As String, $tblpatbilling As String, $tblpatbilldetail As String) As String

  Dim $BillingReport As CReportHTML
  Dim asx As New String[0]
  Dim gitm As Float
  Dim gdsc As Float
  Dim gtax As Float
  Dim xtot As Float

  Dim xx As String
  Dim res1 As Result

  Dim rte As Float
  Dim qty As Float
  Dim xitm As Float
  Dim subt As Float
  Dim xtax As Float
  Dim xdsc As Float
  Dim RepoStr As String

  RepoStr = modDataRepo.GetWhereStringRepo(sLocaType, sLocation, "t1")
  $BillingReport = New CReportHTML([("PARTICULARS"), ("RATE"), ("QTY"), ("GROSS"), ("DISCOUNT"), ("TAX"), ("NET")], "", "")
  $BillingReport.UserData.Add("GROUP SUMMARY REPORT : " & sGroup & " COMP: " & sComp & " RATE: " & sDept & " SCHEME: " & sDisc, "PARAM1")
  $BillingReport.UserData.Add("DATE: " & modReportVar.GetDateTimeReport(dt1, gb.MediumDate) & " TO " & modReportVar.GetDateTimeReport(dt2, gb.MediumDate), "PARAM2")

  gitm = 0
  gdsc = 0
  gtax = 0
  xtot = 0
  If sInvoiced = True Then
    res1 = $con.Exec("select t1.flditemname as flditemname,avg(t1.flditemrate) as rate,SUM(t1.flditemqty) as qnty,SUM(t1.flditemrate*t1.flditemqty) as itemtot,SUM(t1.flddiscamt) as dsc,SUM(t1.fldtaxamt) as tax,SUM(t1.fldditemamt) as tot from " & $tblpatbilling & " AS t1 inner join " & $tblpatbilldetail & " AS t2 ON t1.fldbillno=t2.fldbillno where t2.fldtime>=&1 and t2.fldtime<=&2 and t2.fldcomp like &6 and t1.flditemname in(select flditemname from tblreportgroup where fldgroup=&3) and t1.fldsave=&4 and t1.fldbillingmode like &5 and t1.flddisctype like &7 and t1.fldbilltype like &8" & RepoStr & " GROUP BY t1.flditemname", modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sGroup, True, sDept, sComp, sDisc, sBillType)    '
  Else
    res1 = $con.Exec("select t1.flditemname as flditemname,avg(t1.flditemrate) as rate,SUM(t1.flditemqty) as qnty,SUM(t1.flditemrate*t1.flditemqty) as itemtot,SUM(t1.flddiscamt) as dsc,SUM(t1.fldtaxamt) as tax,SUM(t1.fldditemamt) as tot from " & $tblpatbilling & " AS t1 where t1.fldtime>=&1 and t1.fldtime<=&2 and t1.flditemname in(select flditemname from tblreportgroup where fldgroup=&3) and t1.fldsave=&4 and t1.fldbillingmode like &5 and t1.fldcomp like &6 and t1.flddisctype like &7 and t1.fldbilltype like &8" & RepoStr & " GROUP BY t1.flditemname", modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), sGroup, True, sDept, sComp, sDisc, sBillType)
  Endif

  If res1.Available = True Then
    For Each res1
      rte = 0
      qty = 0
      xitm = 0
      xtax = 0
      xdsc = 0
      subt = 0
      If res1["rate"] Then
        rte = res1["rate"]
      Endif
      If res1["qnty"] Then
        qty = res1["qnty"]
      Endif
      If res1["itemtot"] Then
        xitm = res1["itemtot"]
      Endif
      If res1["dsc"] Then
        xdsc = res1["dsc"]
      Endif
      If res1["tax"] Then
        xtax = res1["tax"]
      Endif
      If res1["tot"] Then
        subt = res1["tot"]
      Endif

      If Not qty And If Not xitm Then
      Else
        gitm = gitm + xitm
        gdsc = gdsc + xdsc
        gtax = gtax + xtax
        xtot = xtot + subt
        With asx
          .Add(res1["flditemname"])
          .Add(modReportVar.GetLocaleNumberFormat(rte, gb.Currency))
          .Add(modReportVar.GetLocaleNumberFormat(qty, -2))
          .Add(modReportVar.GetLocaleNumberFormat(xitm, gb.Currency))
          .Add(modReportVar.GetLocaleNumberFormat(xdsc, gb.Currency))
          .Add(modReportVar.GetLocaleNumberFormat(xtax, gb.Currency))
          .Add(modReportVar.GetLocaleNumberFormat(subt, gb.Currency))
        End With
        $BillingReport.Add(asx)
        asx.Clear()
      Endif
    Next
  Endif

  With asx
    .Add(xx)
    .Add("...")
    .Add("...")
    .Add(modReportVar.GetLocaleNumberFormat(gitm, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(gdsc, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(gtax, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(xtot, gb.Currency))
  End With
  $BillingReport.Add(asx)
  asx.Clear()

  Return $BillingReport.NewHTMLPath()

End

Public Function ServiceGroupDateReportSingle($con As Connection, dt1 As Date, dt2 As Date, sInvoiced As Boolean, sDept As String, sComp As String, sDisc As String, sItem As String, sBillType As String, sDtType As String, sLocaType As String, sLocation As String, $tblpatbilling As String, $tblpatbilldetail As String) As String

  Dim $BillingReport As CReportHTML
  Dim asx As New String[0]
  Dim gitm As Float
  Dim gdsc As Float
  Dim gtax As Float
  Dim xtot As Float

  Dim res As Result
  Dim res1 As Result

  Dim rte As Float
  Dim qty As Float
  Dim xitm As Float
  Dim subt As Float
  Dim xtax As Float
  Dim xdsc As Float

  Dim dt As Date
  Dim dtlst As Date[]

  Dim aitm As Float
  Dim adsc As Float
  Dim atax As Float
  Dim atot As Float

  Dim xfirdate As Date
  Dim xlasdate As Date
  Dim chapdate As String
  Dim yregist As String
  Dim RepoStr As String

  RepoStr = modDataRepo.GetWhereStringRepo(sLocaType, sLocation, "t1")
  $BillingReport = New CReportHTML([("PARTICULARS"), ("RATE"), ("QTY"), ("GROSS"), ("DISCOUNT"), ("TAX"), ("NET")], "", "")
  $BillingReport.UserData.Add("GROUP ITEM REPORT: " & sItem & " COMP: " & sComp & " RATE: " & sDept & " SCHEME: " & sDisc, "PARAM1")
  $BillingReport.UserData.Add("DATE: " & modReportVar.GetDateTimeReport(dt1, gb.MediumDate) & " TO " & modReportVar.GetDateTimeReport(dt2, gb.MediumDate), "PARAM2")

  If sDtType = "Year" Then
    If modBasic.$DateFormat = "BS Date" Then
      dtlst = modDate.GetSelectDateBSArrayBetween(gb.Year, dt1, dt2)
    Else
      dtlst = modDate.GetSelectDateArrayBetween(gb.Year, dt1, dt2)
    Endif
  Else If sDtType = "Month" Then
    If modBasic.$DateFormat = "BS Date" Then
      dtlst = modDate.GetSelectDateBSArrayBetween(gb.Month, dt1, dt2)
    Else
      dtlst = modDate.GetSelectDateArrayBetween(gb.Month, dt1, dt2)
    Endif
  Else
    dtlst = modDate.GetSelectDateArrayBetween(gb.Day, dt1, dt2)
  Endif

  aitm = 0
  adsc = 0
  atax = 0
  atot = 0
  For Each dt In dtlst
    If sDtType = "Year" Then
      If modBasic.$DateFormat = "BS Date" Then
        chapdate = modDate.DateFormatViewBS(dt, "YearOnly")
        xfirdate = modDate.StartSqlYearBS(dt)
        xlasdate = modDate.EndSqlYearBS(dt)
      Else
        chapdate = Format(dt, "yyyy")
        xfirdate = modDate.StartSqlYear(dt)
        xlasdate = modDate.EndSqlYear(dt)
      Endif
    Else If sDtType = "Month" Then
      If modBasic.$DateFormat = "BS Date" Then
        chapdate = modDate.DateFormatViewBS(dt, "YearMonth")
        xfirdate = modDate.StartSqlMonthBS(dt)
        xlasdate = modDate.EndSqlMonthBS(dt)
      Else
        chapdate = Format(dt, "mmm yyyy")
        xfirdate = modDate.StartSqlMonth(dt)
        xlasdate = modDate.EndSqlMonth(dt)
      Endif
    Else
      chapdate = modReportVar.GetDateTimeReport(dt, gb.MediumDate)
      xfirdate = modDate.StartSqlDate(dt)
      xlasdate = modDate.EndSqlDate(dt)
    Endif
    xfirdate = modDate.StartSqlDate(Max(dt1, xfirdate))
    xlasdate = modDate.EndSqlDate(Min(dt2, xlasdate))
    $BillingReport.AddSection(modString.HTMLBlankSpace(3) & chapdate, True)

    If sInvoiced = True Then
      res = $con.Exec("select distinct(t3.flditemname) from (tblreportgroup AS t3 inner join " & $tblpatbilling & " AS t1 on t3.flditemname=t1.flditemname) inner join " & $tblpatbilldetail & " AS t2 ON t1.fldbillno=t2.fldbillno where t3.fldgroup=&1 and t2.fldtime>=&2 and t2.fldtime<=&3 and t2.fldcomp like &6 and t1.fldsave=&4 and t1.fldbillingmode like &5 and t1.flddisctype like &7" & RepoStr & " ORDER BY t3.flditemname ASC", sItem, xfirdate, xlasdate, True, sDept, sComp, sDisc)
    Else
      res = $con.Exec("select distinct(t3.flditemname) from tblreportgroup AS t3 inner join " & $tblpatbilling & " AS t1 on t3.flditemname=t1.flditemname where t3.fldgroup=&1 and t1.fldtime>=&2 and t1.fldtime<=&3 and t1.fldsave=&4 and t1.fldbillingmode like &5 and t1.fldcomp like &6 and t1.flddisctype like &7" & RepoStr & " ORDER BY t3.flditemname ASC", sItem, xfirdate, xlasdate, True, sDept, sComp, sDisc)
    Endif

    gitm = 0
    gdsc = 0
    gtax = 0
    xtot = 0
    If res.Available Then
      For Each res

        If sDisc = "%" Then
          If sInvoiced = True Then
            res1 = $con.Exec("select avg(t1.flditemrate) as rate,SUM(t1.flditemqty) as qnty,SUM(t1.flditemrate*t1.flditemqty) as itemtot,SUM(t1.flddiscamt) as dsc,SUM(t1.fldtaxamt) as tax,SUM(t1.fldditemamt) as tot from " & $tblpatbilling & " AS t1 inner join " & $tblpatbilldetail & " AS t2 ON t1.fldbillno=t2.fldbillno where t1.flditemname=&1 and t2.fldtime>=&2 and t2.fldtime<=&3 and t2.fldcomp like &7 and t1.flditemname in(select flditemname from tblreportgroup where fldgroup=&4) and t1.fldsave=&5 and t1.fldbillingmode like &6" & RepoStr, res["flditemname"], xfirdate, xlasdate, sItem, True, sDept, sComp, sDisc)
          Else
            res1 = $con.Exec("select avg(t1.flditemrate) as rate,SUM(t1.flditemqty) as qnty,SUM(t1.flditemrate*t1.flditemqty) as itemtot,SUM(t1.flddiscamt) as dsc,SUM(t1.fldtaxamt) as tax,SUM(t1.fldditemamt) as tot from " & $tblpatbilling & " AS t1 where t1.flditemname=&1 and t1.fldtime>=&2 and t1.fldtime<=&3 and t1.flditemname in(select flditemname from tblreportgroup where fldgroup=&4) and t1.fldsave=&5 and t1.fldbillingmode like &6 and t1.fldcomp like &7" & RepoStr, res["flditemname"], xfirdate, xlasdate, sItem, True, sDept, sComp, sDisc)
          Endif
        Else
          If sInvoiced = True Then
            res1 = $con.Exec("select avg(t1.flditemrate) as rate,SUM(t1.flditemqty) as qnty,SUM(t1.flditemrate*t1.flditemqty) as itemtot,SUM(t1.flddiscamt) as dsc,SUM(t1.fldtaxamt) as tax,SUM(t1.fldditemamt) as tot from (" & $tblpatbilling & " AS t1 inner join " & $tblpatbilldetail & " AS t2 ON t1.fldbillno=t2.fldbillno) inner join tblencounter AS t3 ON t1.fldencounterval=t3.fldencounterval where t1.flditemname=&1 and t2.fldtime>=&2 and t2.fldtime<=&3 and t2.fldcomp like &7 and t1.flditemname in(select flditemname from tblreportgroup where fldgroup=&4) and t1.fldsave=&5 and t1.fldbillingmode like &6 and t3.flddisctype like &8" & RepoStr, res["flditemname"], xfirdate, xlasdate, sItem, True, sDept, sComp, sDisc)
          Else
            res1 = $con.Exec("select avg(t1.flditemrate) as rate,SUM(t1.flditemqty) as qnty,SUM(t1.flditemrate*t1.flditemqty) as itemtot,SUM(t1.flddiscamt) as dsc,SUM(t1.fldtaxamt) as tax,SUM(t1.fldditemamt) as tot from " & $tblpatbilling & " AS t1 inner join tblencounter AS t3 ON t1.fldencounterval=t3.fldencounterval where t1.flditemname=&1 and t1.fldtime>=&2 and t1.fldtime<=&3 and t1.flditemname in(select flditemname from tblreportgroup where fldgroup=&4) and t1.fldsave=&5 and t1.fldbillingmode like &6 and t1.fldcomp like &7 and t3.flddisctype like &8" & RepoStr, res["flditemname"], xfirdate, xlasdate, sItem, True, sDept, sComp, sDisc)
          Endif
        Endif
        rte = 0
        qty = 0
        xitm = 0
        xtax = 0
        xdsc = 0
        subt = 0
        If res1.Available = True Then
          If res1["rate"] Then
            rte = res1["rate"]
          Endif
          If res1["qnty"] Then
            qty = res1["qnty"]
          Endif
          If res1["itemtot"] Then
            xitm = res1["itemtot"]
          Endif
          If res1["dsc"] Then
            xdsc = res1["dsc"]
          Endif
          If res1["tax"] Then
            xtax = res1["tax"]
          Endif
          If res1["tot"] Then
            subt = res1["tot"]
          Endif
        Endif

        If Not qty And If Not xitm Then
        Else
          gitm = gitm + xitm
          gdsc = gdsc + xdsc
          gtax = gtax + xtax
          xtot = xtot + subt
          With asx
            .Add(modString.HTMLBlankSpace(5) & res["flditemname"])
            .Add(modReportVar.GetLocaleNumberFormat(rte, gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(qty, -2))
            .Add(modReportVar.GetLocaleNumberFormat(xitm, gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(xdsc, gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(xtax, gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(subt, gb.Currency))
          End With
          $BillingReport.Add(asx)
          asx.Clear()
        Endif

      Next  'item
    Endif

    aitm = aitm + gitm
    adsc = adsc + gdsc
    atax = atax + gtax
    atot = atot + xtot
    'date total
    With asx
      .Add(modString.HTMLBlankSpace(3) & chapdate)
      .Add("...")
      .Add("...")
      .Add(modReportVar.GetLocaleNumberFormat(gitm, gb.Currency))
      .Add(modReportVar.GetLocaleNumberFormat(gdsc, gb.Currency))
      .Add(modReportVar.GetLocaleNumberFormat(gtax, gb.Currency))
      .Add(modReportVar.GetLocaleNumberFormat(xtot, gb.Currency))
    End With
    $BillingReport.Add(asx)
    asx.Clear()
    With asx
      .Add("")
      .Add("")
      .Add("")
      .Add("")
      .Add("")
      .Add("")
      .Add("")
    End With
    $BillingReport.Add(asx)
    asx.Clear()
  Next ''date

  With asx
    .Add(sItem)
    .Add("...")
    .Add("...")
    .Add(modReportVar.GetLocaleNumberFormat(aitm, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(adsc, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(atax, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(atot, gb.Currency))
  End With
  $BillingReport.Add(asx)
  asx.Clear()

  Return $BillingReport.NewHTMLPath()

End

Public Function GetGroupSUmmaryEntryFormat($con As Connection, dt1 As Date, dt2 As Date, sBillMode As String, sDisc As String, sComp As String, sInvoiced As Boolean, sBillType As String, sLocaType As String, sLocation As String, $tblpatbilling As String, $tblpatbilldetail As String) As String

  Dim $BillingReport As CReportHTML
  Dim asx As New String[0]
  Dim xfield As String
  Dim yregist As String
  Dim grpList As String[]
  Dim grpName As String
  Dim xList As String[]
  Dim xType As String
  Dim res As Result
  Dim res2 As Result

  Dim xsubt As Float
  Dim xdisc As Float
  Dim xtax As Float
  Dim xtot As Float

  Dim asubt As Float
  Dim adisc As Float
  Dim atax As Float
  Dim atot As Float

  Dim psubt As Float
  Dim pdisc As Float
  Dim ptax As Float
  Dim ptot As Float
  Dim RepoStr As String

  RepoStr = modDataRepo.GetWhereStringRepo(sLocaType, sLocation, "t1")
  $BillingReport = New CReportHTML([("PARTICULARS"), ("GROSS"), ("DISCOUNT"), ("TAX"), ("NET")], "", "")
  $BillingReport.UserData.Add("GROUP REPORT BY Entry", "PARAM1")
  $BillingReport.UserData.Add("DATE: " & modReportVar.GetDateTimeReport(dt1, gb.MediumDate) & " TO " & modReportVar.GetDateTimeReport(dt2, gb.MediumDate) & " COMP: " & sComp & " Plan: " & sBillMode & " Disc: " & sDisc, "PARAM2")
  grpList = modNonMedical.GetGroupNameAccount()

  If sInvoiced = True Then
    res = $con.Exec("select distinct(t3.fldadmitlocat) as col from (tblencounter AS t3 inner join " & $tblpatbilling & " AS t1 ON t3.fldencounterval=t1.fldencounterval) inner join " & $tblpatbilldetail & " AS t2 ON t1.fldbillno=t2.fldbillno where t2.fldtime>=&1 and t2.fldtime<=&2 and t2.fldcomp like &4 and t1.fldsave=&3 and t1.fldbillingmode like &5 and t1.flddisctype like &6 and t1.fldbilltype like &7" & RepoStr, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), True, sComp, sBillMode, sDisc, sBillType)
  Else
    res = $con.Exec("select distinct(t3.fldadmitlocat) as col from tblencounter AS t3 inner join " & $tblpatbilling & " AS t1 ON t3.fldencounterval=t1.fldencounterval where t1.fldtime>=&1 and t1.fldtime<=&2 and t1.fldsave=&3 and t1.fldcomp like &4 and t1.fldbillingmode like &5 and t1.flddisctype like &6 and t1.fldbilltype like &7" & RepoStr, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), True, sComp, sBillMode, sDisc, sBillType)
  Endif
  xList = modControlSub.GetDirectFillresultNoNull(res)
  xList.Add("Null")

  psubt = 0
  pdisc = 0
  ptax = 0
  ptot = 0
  For Each xType In xList
    $BillingReport.AddChapter(xType)

    asubt = 0
    adisc = 0
    atax = 0
    atot = 0
    For Each grpName In grpList

      If sDisc = "%" And If sBillType = "%" Then
        yregist = ""
      Else
        yregist = " and t1.flddisctype like &7 and t1.fldbilltype like &8"
      Endif
      If xType = "Null" Then
        If sInvoiced = True Then
          res2 = $con.Exec("select SUM(t1.flditemrate*t1.flditemqty) as itemtot,SUM(t1.flddiscamt) as flddiscamt,SUM(t1.fldtaxamt) as fldtaxamt,SUM(t1.fldditemamt) as fldditemamt from (" & $tblpatbilling & " AS t1 inner join " & $tblpatbilldetail & " AS t2 ON t1.fldbillno=t2.fldbillno) inner join tblencounter AS t3 on t1.fldencounterval=t3.fldencounterval where t1.flditemname in(select flditemname from tblreportgroup where fldgroup=&1) and t2.fldtime>=&2 and t2.fldtime<=&3 and t2.fldcomp like &5 and t1.fldsave=&4 and t1.fldbillingmode like &6" & yregist & " and t3.fldadmitlocat IS NULL" & RepoStr, grpName, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), True, sComp, sBillMode, sDisc, sBillType)
        Else
          res2 = $con.Exec("select SUM(t1.flditemrate*t1.flditemqty) as itemtot,SUM(t1.flddiscamt) as flddiscamt,SUM(t1.fldtaxamt) as fldtaxamt,SUM(t1.fldditemamt) as fldditemamt from " & $tblpatbilling & " AS t1 inner join tblencounter AS t3 on t1.fldencounterval=t3.fldencounterval where t1.flditemname in(select flditemname from tblreportgroup where fldgroup=&1) and t1.fldtime>=&2 and t1.fldtime<=&3 and t1.fldsave=&4 and t1.fldcomp like &5 and t1.fldbillingmode like &6" & yregist & " and t3.fldadmitlocat IS NULL" & RepoStr, grpName, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), True, sComp, sBillMode, sDisc, sBillType)
        Endif
      Else
        If sInvoiced = True Then
          res2 = $con.Exec("select SUM(t1.flditemrate*t1.flditemqty) as itemtot,SUM(t1.flddiscamt) as flddiscamt,SUM(t1.fldtaxamt) as fldtaxamt,SUM(t1.fldditemamt) as fldditemamt from (" & $tblpatbilling & " AS t1 inner join " & $tblpatbilldetail & " AS t2 ON t1.fldbillno=t2.fldbillno) inner join tblencounter AS t3 on t1.fldencounterval=t3.fldencounterval where t1.flditemname in(select flditemname from tblreportgroup where fldgroup=&1) and t2.fldtime>=&2 and t2.fldtime<=&3 and t2.fldcomp like &5 and t1.fldsave=&4 and t1.fldbillingmode like &6" & yregist & " and t3.fldadmitlocat=&9" & RepoStr, grpName, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), True, sComp, sBillMode, sDisc, sBillType, xType)
        Else
          res2 = $con.Exec("select SUM(t1.flditemrate*t1.flditemqty) as itemtot,SUM(t1.flddiscamt) as flddiscamt,SUM(t1.fldtaxamt) as fldtaxamt,SUM(t1.fldditemamt) as fldditemamt from " & $tblpatbilling & " AS t1 inner join tblencounter AS t3 on t1.fldencounterval=t3.fldencounterval where t1.flditemname in(select flditemname from tblreportgroup where fldgroup=&1) and t1.fldtime>=&2 and t1.fldtime<=&3 and t1.fldsave=&4 and t1.fldcomp like &5 and t1.fldbillingmode like &6" & yregist & " and t3.fldadmitlocat=&9" & RepoStr, grpName, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), True, sComp, sBillMode, sDisc, sBillType, xType)
        Endif
      Endif
      If res2.Available Then
        xsubt = 0
        xdisc = 0
        xtax = 0
        xtot = 0
        If res2["itemtot"] Then
          xsubt = res2["itemtot"]
        Endif
        If res2["flddiscamt"] Then
          xdisc = res2["flddiscamt"]
        Endif
        If res2["fldtaxamt"] Then
          xtax = res2["fldtaxamt"]
        Endif
        If res2["fldditemamt"] Then
          xtot = res2["fldditemamt"]
        Endif

        asubt = asubt + xsubt
        adisc = adisc + xdisc
        atax = atax + xtax
        atot = atot + xtot
        If xsubt Then
          With asx
            .Add(grpName)
            .Add(modReportVar.GetLocaleNumberFormat(xsubt, gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(xdisc, gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(xtax, gb.Currency))
            .Add(modReportVar.GetLocaleNumberFormat(xtot, gb.Currency))
          End With
          $BillingReport.Add(asx)
          asx.Clear()
        Endif
      Endif
    Next

    psubt = psubt + asubt
    pdisc = pdisc + adisc
    ptax = ptax + atax
    ptot = ptot + atot
    With asx
      .Add("TOTAL: " & xType)
      .Add(modReportVar.GetLocaleNumberFormat(asubt, gb.Currency))
      .Add(modReportVar.GetLocaleNumberFormat(adisc, gb.Currency))
      .Add(modReportVar.GetLocaleNumberFormat(atax, gb.Currency))
      .Add(modReportVar.GetLocaleNumberFormat(atot, gb.Currency))
    End With
    $BillingReport.Add(asx)
    asx.Clear()
    With asx
      .Add("***")
      .Add("***")
      .Add("***")
      .Add("***")
      .Add("***")
    End With
    $BillingReport.Add(asx)
    asx.Clear()
  Next

  With asx
    .Add("GRAND TOTAL")
    .Add(modReportVar.GetLocaleNumberFormat(psubt, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(pdisc, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(ptax, gb.Currency))
    .Add(modReportVar.GetLocaleNumberFormat(ptot, gb.Currency))
  End With
  $BillingReport.Add(asx)
  asx.Clear()

  AddExtraInforGroupreport($con, dt1, dt2, sInvoiced, sComp, sBillMode, sDisc, sBillType, $BillingReport, 0, sLocaType, sLocation, $tblpatbilling, $tblpatbilldetail)

  Return $BillingReport.NewHTMLPath()

End
